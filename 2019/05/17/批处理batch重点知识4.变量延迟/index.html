<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>批处理batch重点知识4.变量延迟 &mdash; 个人博客</title><link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="/assets/css/components/collection.css"><link rel="stylesheet" href="/assets/css/components/repo-card.css"><link rel="stylesheet" href="/assets/css/sections/repo-list.css"><link rel="stylesheet" href="/assets/css/components/boxed-group.css"><link rel="stylesheet" href="/assets/css/globals/common.css"><link rel="stylesheet" href="/assets/css/globals/responsive.css"><link rel="stylesheet" href="/assets/css/posts/index.css"><link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/highlight/monokai.sublime.css"><link rel="canonical" href="/2019/05/17/%E6%89%B9%E5%A4%84%E7%90%86batch%E9%87%8D%E7%82%B9%E7%9F%A5%E8%AF%864.%E5%8F%98%E9%87%8F%E5%BB%B6%E8%BF%9F/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="/feed.xml"><link rel="shortcut icon" href="/favicon.ico"><meta property="og:title" content="批处理batch重点知识4.变量延迟"><meta name="keywords" content="windows, batch"><meta name="og:keywords" content="windows, batch"><meta name="description" content="引言本篇文章介绍批处理的变量延迟."><meta name="og:description" content="引言本篇文章介绍批处理的变量延迟."><meta property="og:url" content="/2019/05/17/%E6%89%B9%E5%A4%84%E7%90%86batch%E9%87%8D%E7%82%B9%E7%9F%A5%E8%AF%864.%E5%8F%98%E9%87%8F%E5%BB%B6%E8%BF%9F/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2019-05-17"> <script src="/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="/assets/js/jquery-ui.js"></script> <script src="/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="批处理batch重点知识4.变"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">批处理batch重点知识4.变量延迟</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2019/05/17 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#windows" title="windows">windows</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#batch" title="batch">batch</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 1551 字，约 5 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="引言">引言</h1><p>本篇文章介绍批处理的变量延迟.</p><h1 id="变量延迟">变量延迟</h1><p>批处理的执行过程是<strong>自上而下，逐条执行</strong>.“逐条”并不等同于“逐行”。这个“条”，是一条完整的语句的意思，并不是指“一行代码”。</p><p>在复合语句中，整个复合语句是一条完整的语句，而无论这个复合语句占用了多少行的位置。常见的复合语句有：<strong>for</strong>语句、<strong>if……else</strong>语句、用连接符 <strong>&amp;</strong>、 <strong>||</strong>和 <strong>&amp;&amp;</strong>连接的语句，用管道符号 <strong>|</strong>连接的语句，以及用 <strong>括号</strong>括起来由多条语句组合而成的 <strong>语句块</strong>；</p><p>在非复合语句中，如果该语句占据了一行的位置，则该行代码为一条完整的语句。</p><p>例如：</p><div class="language-batch highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@echo <span class="na">off</span>
<span class="kd">set</span> <span class="kd">num</span><span class="o">=</span><span class="m">0</span>
<span class="k">for</span> <span class="na">/f </span><span class="vm">%%i</span> <span class="k">in</span> <span class="o">(</span><span class="s1">'dir /a-d /b *.exe'</span><span class="o">)</span> <span class="k">do</span> <span class="o">(</span>
<span class="kd">set</span> <span class="na">/a </span><span class="kd">num</span><span class="o">+=</span><span class="m">1</span>
<span class="nb">echo</span> <span class="kd">num</span> 当前的值是 <span class="nv">%num%</span>
<span class="o">)</span>
<span class="nb">echo</span> 当前目录下共有 <span class="nv">%num%</span> 个exe文件
<span class="nb">dir</span> <span class="na">/a-d /b </span><span class="o">*</span>.txt<span class="o">|</span><span class="nb">findstr</span> <span class="s2">"test"</span><span class="o">&gt;</span><span class="kr">nul</span><span class="o">&amp;&amp;(</span>
<span class="nb">echo</span> 存在含有 <span class="kd">test</span> 字符串的文本本件
<span class="o">)</span> <span class="o">||</span> <span class="nb">echo</span> 不存在含有 <span class="kd">test</span> 字符串的文本文件
<span class="k">if</span> <span class="ow">exist</span> <span class="kd">test</span>.ini <span class="o">(</span>
<span class="nb">echo</span> 存在 <span class="kd">test</span>.ini 文件
<span class="o">)</span> <span class="k">else</span> <span class="nb">echo</span> 不存在 <span class="kd">test</span>.ini 文件
<span class="nb">pause</span>
</code></pre></div></div><p>上面的代码共有14行，语句只有7条，它们分别是：</p><ul><li>第1条：第1行的<strong>echo</strong>语句；</li><li>第2条：第2行的<strong>set</strong>语句；</li><li>第3条：第3、4、5、6行上的<strong>for</strong>复合语句；</li><li>第4条：第7行的<strong>echo</strong>语句；</li><li>第5条：第8、9、10行上用<strong>&amp;&amp;</strong>和<strong>||</strong>连接的复合语句；</li><li>第6条：第11、12、13行上的<strong>if……else</strong>复合语句；</li><li>第7条：第14行上的<strong>pause</strong>语句。</li></ul><p>在代码“逐条”执行的过程中，cmd.exe这个批处理解释器会对每条语句做一些预处理工作，这就是批处理中大名鼎鼎的<strong>预处理机制</strong>。</p><p>预处理的大致情形是这样的：</p><ul><li>首先，把一条完整的语句读入内存中（不管这条语句有多少行，它们都会被一起读入）</li><li>然后，识别出哪些部分是命令关键字，哪些是开关、哪些是参数，哪些是变量引用……如果代码语法有误，则给出错误提示或退出批处理环境；</li><li>如果顺利通过，接下来，就把该条语句中所有变量引用如<strong><code class="language-plaintext highlighter-rouge">%a%</code>替换</strong>成<code class="language-plaintext highlighter-rouge">a</code>代表的<strong>实际值</strong>。</li><li>当所有的预处理工作完成之后，批处理才会执行每条完整语句内部每个命令的原有功能。</li><li>也就是说，如果命令语句中含有变量引用，并且变量的值在命令的执行过程中被改变了，即使该条语句内部的其他地方也用到了这个变量，也不会用最新值去替换它们，因为语句在被预处理的时候，所有的变量引用都已经被替换成字符串常量了。</li></ul><p><strong><code class="language-plaintext highlighter-rouge">set num=0&amp;&amp;echo %num%</code></strong>是一条复合语句，它的含义是：把0赋予变量<strong><code class="language-plaintext highlighter-rouge">num</code></strong>，成功后，显示变量<code class="language-plaintext highlighter-rouge">num</code>的值。但实际上在语句正式执行前<strong><code class="language-plaintext highlighter-rouge">%num%</code></strong>就被预处理为空串了。</p><p>因此有了<strong>变量延迟扩展</strong>语句，让变量的扩展行为延迟一下，从而获取我们想要的值。</p><p>“变量延迟”是批处理中一个十分重要的机制，它因预处理机制而生，用于复合语句，大量使用于强大的<strong>for</strong>语句中。</p><p>一般说来，使用延迟变量扩展行为，可以有如下选择：</p><ol><li>在需要使用延迟变量扩展前使用 <strong><code class="language-plaintext highlighter-rouge">setlocal enabledelayedexpansion</code></strong> 语句,然后把变量引用的百分号改成感叹号,即<strong><code class="language-plaintext highlighter-rouge">%a%</code></strong>变成<strong><code class="language-plaintext highlighter-rouge">!a!</code></strong></li><li>使用<strong>call</strong>语句延迟变量扩展，需要在原命令前加上<strong>call</strong>命令，并把变量引用的单层百分号对改为双层,即<strong><code class="language-plaintext highlighter-rouge">echo %a%</code></strong>变成<strong><code class="language-plaintext highlighter-rouge">call echo %%a%%</code></strong>。</li></ol><p>因为<strong>call</strong>语句使用的是<strong>双层百分号对</strong>，容易使人犯迷糊，所以用得较少，常用的是使用<strong>setlocal enabledelayedexpansion</strong> 语句（set是设置的意思，local是本地的意思，enable是能够的意思，delayed是延迟的意思，expansion是扩展的意思，合起来就是：让变量成为局部变量，并延迟它的扩展行为）。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="" target="_blank">acteds</a></li><li>本文链接：<a href="/2019/05/17/%E6%89%B9%E5%A4%84%E7%90%86batch%E9%87%8D%E7%82%B9%E7%9F%A5%E8%AF%864.%E5%8F%98%E9%87%8F%E5%BB%B6%E8%BF%9F/" target="_blank">https://acteds.github.io/2019/05/17/%E6%89%B9%E5%A4%84%E7%90%86batch%E9%87%8D%E7%82%B9%E7%9F%A5%E8%AF%864.%E5%8F%98%E9%87%8F%E5%BB%B6%E8%BF%9F/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://beaudar.lipk.org/client.js" repo="mzlogin/blog-comments" issue-term="title" label="gitment" theme="github-light" comment-order="desc" input-position="top" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: '/assets/search_data.json?v=1714896936', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="acteds">acteds</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/acteds/acteds.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="/" title="首页" target="">首页</a></li><li> <a href="/categories/" title="分类" target="">分类</a></li><li> <a href="/wiki/" title="维基" target="">维基</a></li><li> <a href="/about/" title="关于" target="">关于</a></li><li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
