<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2025-02-08T01:52:32+08:00</updated><id>/feed.xml</id><title type="html">个人博客</title><subtitle></subtitle><author><name>acteds</name></author><entry><title type="html">form-data传输</title><link href="/2024/12/04/form-data%E4%BC%A0%E8%BE%93/" rel="alternate" type="text/html" title="form-data传输" /><published>2024-12-04T00:00:00+08:00</published><updated>2024-12-04T00:00:00+08:00</updated><id>/2024/12/04/form-data%E4%BC%A0%E8%BE%93</id><content type="html" xml:base="/2024/12/04/form-data%E4%BC%A0%E8%BE%93/"><![CDATA[<h1 id="引言">引言</h1>

<p><code class="language-plaintext highlighter-rouge">http</code>-<code class="language-plaintext highlighter-rouge">form-data</code>，传输方式的一些说明。</p>

<h1 id="http">http</h1>

<h2 id="form-data">form-data</h2>

<h3 id="基本概念"><strong>基本概念</strong></h3>
<p><code class="language-plaintext highlighter-rouge">form-data</code> 是一种用于通过 HTTP POST 请求传输数据的编码方式，通常用于上传文件和发送表单数据。它允许将数据按字段进行分组，每个字段可以包含文本或二进制数据（如文件）。这种编码方式将表单数据按键值对形式进行传输，每个字段与其他字段之间通过边界分隔。</p>

<ul>
  <li><strong>表单数据（Form Data）</strong>：即在 HTML 表单中通过 <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> 标签和其他表单元素传递的数据。</li>
  <li><strong><code class="language-plaintext highlighter-rouge">multipart/form-data</code></strong>：指定数据采用多部分表单数据格式，每部分可以是文本字段，也可以是文件。</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">form-data</code> 传输的组成</strong></p>

<ul>
  <li><strong>Content-Type</strong>: <code class="language-plaintext highlighter-rouge">multipart/form-data</code> 这意味着请求的数据是多部分的，通常用于文件上传。</li>
  <li><strong>边界（boundary）</strong>: 这是一种分隔符，用于标识不同的字段和数据部分。<code class="language-plaintext highlighter-rouge">boundary</code> 是一个字符串，通常由服务器自动生成。</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">form-data</code> 示例</strong></p>

<p><strong>表单数据传输</strong></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/upload"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"file"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"user1"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Upload"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>当表单提交时，浏览器会自动将数据转化为 <code class="language-plaintext highlighter-rouge">multipart/form-data</code> 格式并发送。</p>

<p><strong>Request Headers</strong></p>

<p>请求的头部包含如下信息：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /upload HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Length: 1234
</code></pre></div></div>

<p><strong>Request Body (Body Body)</strong></p>

<p>表单数据的主体部分会如下所示进行编码：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="username"

user1
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="example.txt"
Content-Type: text/plain

&lt;文件内容&gt;
------WebKitFormBoundary7MA4YWxkTrZu0gW--
</code></pre></div></div>

<p>这里每一部分的数据使用边界字符串 <code class="language-plaintext highlighter-rouge">------WebKitFormBoundary7MA4YWxkTrZu0gW</code> 分隔，文件和文本字段都可以在同一个请求体内传输。</p>

<h3 id="限制">限制</h3>
<p><code class="language-plaintext highlighter-rouge">multipart/form-data</code> 是一种用于通过 HTTP POST 请求上传文件和提交表单数据的编码方式。尽管它广泛用于文件上传和表单数据提交，但在某些情况下会遇到大小和数据类型的限制。</p>

<p><strong>大小限制</strong>
<code class="language-plaintext highlighter-rouge">multipart/form-data</code> 请求的最大传输大小通常受以下因素的限制：</p>

<p><strong>服务器配置</strong>
<strong>Spring Boot (Tomcat 默认)</strong>: Spring Boot 使用的嵌入式 Tomcat 服务器有默认的文件上传大小限制。通常是 2MB。</p>

<p>可以在 <code class="language-plaintext highlighter-rouge">application.properties</code> 或 <code class="language-plaintext highlighter-rouge">application.yml</code> 中修改该配置：</p>
<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.servlet.multipart.max-file-size</span><span class="p">=</span><span class="s">10MB   # 限制单个文件的大小</span>
<span class="py">spring.servlet.multipart.max-request-size</span><span class="p">=</span><span class="s">20MB # 限制整个请求的大小</span>
</code></pre></div></div>

<p>对于 <code class="language-plaintext highlighter-rouge">application.yml</code>，配置如下：</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
<span class="na">servlet</span><span class="pi">:</span>
  <span class="na">multipart</span><span class="pi">:</span>
    <span class="na">max-file-size</span><span class="pi">:</span> <span class="s">10MB</span>
    <span class="na">max-request-size</span><span class="pi">:</span> <span class="s">20MB</span>
</code></pre></div></div>

<p><strong>NGINX / 反向代理配置</strong>
如果你的应用通过 NGINX 作为反向代理访问，还需要配置 NGINX 的文件上传大小限制。默认情况下，NGINX 可能限制最大上传文件大小为 1MB。</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">client_max_body_size</span> <span class="mi">20M</span><span class="p">;</span>  <span class="c1"># 设置最大请求体大小为 20MB</span>
</code></pre></div></div>

<p><strong>Web服务器和应用服务器的其他限制</strong></p>
<ul>
  <li><strong>Apache</strong>、<strong>Tomcat</strong>、<strong>Jetty</strong> 等服务器也有类似的上传大小限制，通常可以通过相应的配置文件调整：
    <ul>
      <li>Tomcat 中 <code class="language-plaintext highlighter-rouge">server.xml</code> 中的 <code class="language-plaintext highlighter-rouge">maxPostSize</code> 设置。</li>
      <li>Apache 中的 <code class="language-plaintext highlighter-rouge">LimitRequestBody</code> 设置。</li>
    </ul>
  </li>
</ul>

<p><strong>数据类型限制</strong>
<code class="language-plaintext highlighter-rouge">multipart/form-data</code> 本身不限制数据类型，理论上可以传递任何类型的数据（包括文本、数字、二进制数据、文件等）。不过，某些数据类型可能会遇到处理上的限制。</p>

<p><strong>文本数据</strong></p>
<ul>
  <li>表单字段通常以 <code class="language-plaintext highlighter-rouge">key-value</code> 形式传输（如：<code class="language-plaintext highlighter-rouge">key=value</code>）。Spring 和其他框架会自动解析表单中的文本数据。</li>
  <li>对于长文本数据，<code class="language-plaintext highlighter-rouge">multipart/form-data</code> 没有特别的限制，只要不超过请求大小的限制即可。</li>
</ul>

<p><strong>文件数据</strong></p>
<ul>
  <li>文件内容通过 <code class="language-plaintext highlighter-rouge">Content-Type</code> 和 <code class="language-plaintext highlighter-rouge">Content-Disposition</code> 头传输，每个文件都会有文件名、类型、大小等元数据。</li>
  <li><strong>文件大小</strong>：如前所述，上传的文件大小会受到服务器配置的限制。</li>
  <li><strong>文件类型</strong>：文件的 <code class="language-plaintext highlighter-rouge">Content-Type</code>（MIME 类型）由浏览器自动生成，也可以在前端指定。例如，<code class="language-plaintext highlighter-rouge">image/jpeg</code>、<code class="language-plaintext highlighter-rouge">application/pdf</code>、<code class="language-plaintext highlighter-rouge">text/plain</code> 等。</li>
</ul>

<p><strong>大文件传输</strong></p>
<ul>
  <li>上传非常大的文件时，<code class="language-plaintext highlighter-rouge">multipart/form-data</code> 可能会出现性能问题，特别是当文件和其他表单字段一起上传时，处理可能会比较慢。</li>
  <li>大文件上传时，可以考虑使用分块上传（比如 HTML5 的 <code class="language-plaintext highlighter-rouge">FileReader</code> API 和服务器端的分块处理）。</li>
</ul>

<p><strong>编码和字符集限制</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">multipart/form-data</code> 默认使用 <strong><code class="language-plaintext highlighter-rouge">ISO-8859-1</code></strong> 编码方式，可能会在处理非拉丁字符集（如中文、阿拉伯文等）时遇到问题。为了正确处理字符集，可以在 <code class="language-plaintext highlighter-rouge">Content-Type</code> 中显式指定字符集：</li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">Content-Type: multipart/form-data; charset=UTF-8; boundary=---boundary-string
</span></code></pre></div></div>

<ul>
  <li>然而，<code class="language-plaintext highlighter-rouge">multipart/form-data</code> 本身并没有强制要求字符集设置为 <code class="language-plaintext highlighter-rouge">UTF-8</code>。对于表单文本字段的内容，推荐使用 UTF-8 编码来避免字符集不兼容问题。</li>
</ul>

<p><strong>特殊字符问题</strong>
在上传包含特殊字符（如 <code class="language-plaintext highlighter-rouge">&amp;</code>, <code class="language-plaintext highlighter-rouge">=</code>, <code class="language-plaintext highlighter-rouge">%</code>, <code class="language-plaintext highlighter-rouge">#</code> 等）或文件名中包含空格、中文字符时，需要进行 URL 编码或 Base64 编码，否则可能会导致请求失败。</p>

<p><strong>浏览器和客户端限制</strong>
不同浏览器或客户端对 <code class="language-plaintext highlighter-rouge">multipart/form-data</code> 可能有不同的支持和限制：</p>
<ul>
  <li>文件大小限制：浏览器通常会限制每个文件的最大上传大小。浏览器可能会阻止超过某个大小的文件上传。</li>
  <li>单个请求中的字段数：虽然没有硬性规定，但多数浏览器和服务器对单个请求中的字段数量有限制。</li>
</ul>

<h3 id="数组类型处理">数组类型处理</h3>

<p><code class="language-plaintext highlighter-rouge">multipart/form-data</code> 本身并不直接支持数组或列表类型，但可以通过特定方式传递数组或列表数据。实际上，可以通过以下两种常见方法来模拟数组或列表的传递：</p>

<p><strong>通过多个同名字段传递数组数据</strong></p>

<p>在 <code class="language-plaintext highlighter-rouge">multipart/form-data</code> 请求中，可以通过使用多个具有<strong>相同名字</strong>的字段来传递数组数据。Spring 会自动将这些字段映射到 <code class="language-plaintext highlighter-rouge">String[]</code> 或 <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code> 等集合类型。</p>

<p>在这种方式下，Spring 会自动将每个 <code class="language-plaintext highlighter-rouge">uniqueKey</code> 字段（如 <code class="language-plaintext highlighter-rouge">uniqueKey=key1&amp;uniqueKey=key2&amp;uniqueKey=key3</code>）解析为 <code class="language-plaintext highlighter-rouge">String[]</code> 类型，即 <code class="language-plaintext highlighter-rouge">["key1", "key2", "key3"]</code>。</p>

<p><strong>通过逗号分隔的字符串传递数组</strong></p>

<p>如果你希望将列表作为一个单独的字段传递，可以使用逗号分隔的字符串，并在后端将其转换为 <code class="language-plaintext highlighter-rouge">List</code> 或 <code class="language-plaintext highlighter-rouge">String[]</code>。</p>

<p>在这种方式下，<code class="language-plaintext highlighter-rouge">uniqueKey</code> 参数会作为一个字符串传递，包含逗号分隔的元素。你可以在后端使用 <code class="language-plaintext highlighter-rouge">split(",")</code> 方法将其转换为 <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code> 或 <code class="language-plaintext highlighter-rouge">String[]</code>。</p>

<p><strong>使用 JSON 格式传递数组</strong></p>

<p>另一种方法是通过 JSON 格式传递数组。为了实现这一点，你可以将整个数组或复杂的对象封装为 JSON 字符串，并在后端将其解析为 Java 对象。这种方法通常用于传递更复杂的数据结构。</p>

<p>在这种方法中，前端需要传递一个合法的 JSON 字符串，后端使用 <code class="language-plaintext highlighter-rouge">ObjectMapper</code> 来解析它为 <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code>。</p>

<p><strong>总结</strong></p>

<p>虽然 <code class="language-plaintext highlighter-rouge">multipart/form-data</code> 不直接支持数组类型，但可以通过以下方式来传递数组数据：</p>

<ol>
  <li>
    <p><strong>多个同名字段</strong>：通过在请求中传递多个具有相同名称的字段（例如，<code class="language-plaintext highlighter-rouge">uniqueKey=key1&amp;uniqueKey=key2&amp;uniqueKey=key3</code>）来模拟数组，Spring 会自动将其映射为 <code class="language-plaintext highlighter-rouge">String[]</code> 或 <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code>。</p>
  </li>
  <li>
    <p><strong>逗号分隔的字符串</strong>：通过传递一个逗号分隔的字符串（例如，<code class="language-plaintext highlighter-rouge">uniqueKey=key1,key2,key3</code>），在后端将其拆分为数组或列表。</p>
  </li>
  <li>
    <p><strong>JSON 格式</strong>：通过将数组封装为 JSON 字符串传递，并在后端解析为数组或列表（例如，<code class="language-plaintext highlighter-rouge">uniqueKey=["key1","key2","key3"]</code>）。</p>
  </li>
</ol>]]></content><author><name>acteds</name></author><category term="Java" /><category term="http" /><summary type="html"><![CDATA[Java笔记]]></summary></entry><entry><title type="html">并行流的相关问题</title><link href="/2024/12/03/%E5%B9%B6%E8%A1%8C%E6%B5%81%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/" rel="alternate" type="text/html" title="并行流的相关问题" /><published>2024-12-03T00:00:00+08:00</published><updated>2024-12-03T00:00:00+08:00</updated><id>/2024/12/03/%E5%B9%B6%E8%A1%8C%E6%B5%81%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98</id><content type="html" xml:base="/2024/12/03/%E5%B9%B6%E8%A1%8C%E6%B5%81%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/"><![CDATA[<h1 id="引言">引言</h1>

<p>并行流的相关问题，顺序问题，以及多线程问题。</p>

<h1 id="java">Java</h1>

<h2 id="stream流">Stream流</h2>

<h3 id="并行流">并行流</h3>

<h4 id="顺序">顺序</h4>

<p>并行流 (<code class="language-plaintext highlighter-rouge">parallelStream</code>) 并不保证元素的顺序。默认情况下，<code class="language-plaintext highlighter-rouge">parallelStream</code> 会分割任务并让多个线程并行处理数据，这样<strong>处理顺序</strong>是不可预测的，因此它无法保证结果的顺序。</p>

<p><strong>保证结果顺序：</strong></p>

<p><strong>使用顺序流</strong>：如果你不特别需要并行处理，可以改为使用顺序流（即使用 <code class="language-plaintext highlighter-rouge">stream()</code> 而不是 <code class="language-plaintext highlighter-rouge">parallelStream()</code>），这样可以确保顺序不变。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span> <span class="o">=</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(),</span> <span class="kc">false</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cell:</span><span class="o">:</span><span class="n">getStringCellValue</span><span class="o">)</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</code></pre></div></div>

<p><strong>使用 <code class="language-plaintext highlighter-rouge">collect</code> 时强制保序</strong>：如果你坚持使用并行流，并且仍然需要保持顺序，可以在收集结果时使用 <code class="language-plaintext highlighter-rouge">Collectors.toList()</code>，因为它会<strong>按顺序将流中的元素收集到列表</strong>中，即使是并行流：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span> <span class="o">=</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(),</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cell:</span><span class="o">:</span><span class="n">getStringCellValue</span><span class="o">)</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</code></pre></div></div>

<p>还可以显示的在流的末尾使用 <code class="language-plaintext highlighter-rouge">sorted()</code> 或 <code class="language-plaintext highlighter-rouge">forEachOrdered()</code> 来强制保持顺序。</p>

<hr />

<p>但是，<strong>即使你使用 <code class="language-plaintext highlighter-rouge">Collectors.toList()</code></strong>，并行流的<strong>内部执行顺序</strong>仍然不可预测，即：</p>

<p>并行流在执行时不会保证操作的顺序。流中的操作可能会被多个线程并行执行，这样即使是 <code class="language-plaintext highlighter-rouge">map</code> 或 <code class="language-plaintext highlighter-rouge">filter</code> 这些按顺序执行的操作，在并行流中也可能会导致结果的顺序发生改变。</p>

<p>为什么并行流与 <code class="language-plaintext highlighter-rouge">Collectors.toList()</code> 保持顺序？</p>

<p>流的合并方式： 当使用 <code class="language-plaintext highlighter-rouge">parallelStream</code> 时，数据会被分割成多个片段，每个线程处理其中的一部分。每个片段中的操作是顺序的，但它们之间的合并顺序不一定保持一致。</p>

<p><code class="language-plaintext highlighter-rouge">Collectors.toList()</code> 的行为：</p>

<p><code class="language-plaintext highlighter-rouge">Collectors.toList()</code> 是一个 无状态收集器，它只是将流中的元素收集到一个新的列表中。由于 <code class="language-plaintext highlighter-rouge">List</code> 是有顺序的容器，所以它会保持收集的顺序，即使是并行流。因为在 <code class="language-plaintext highlighter-rouge">parallelStream()</code> 的情况下，流会分割成多个子流，并行处理后最终合并，而合并时，<code class="language-plaintext highlighter-rouge">toList</code> 会保持各个子流处理后的顺序。</p>

<h4 id="多线程">多线程</h4>

<p>并行流（<code class="language-plaintext highlighter-rouge">parallelStream</code>）是 Java 8 引入的功能，它通过分割数据源来使用多个线程并行地处理数据，从而提高处理速度。但并行流的多线程使用也带来了一些潜在的问题，特别是在以下几种情况下：</p>

<p><strong>线程安全问题</strong></p>

<p>并行流使用多个线程同时操作同一数据，这可能会引发线程安全问题。例如，如果你在流的操作中修改共享的可变对象，或者在 <code class="language-plaintext highlighter-rouge">collect</code> 操作中使用了非线程安全的集合，就可能会出现并发修改的问题。</p>

<p>解决方案：</p>

<ul>
  <li>对于共享的资源，确保线程安全。可以使用 <code class="language-plaintext highlighter-rouge">ConcurrentHashMap</code>、<code class="language-plaintext highlighter-rouge">CopyOnWriteArrayList</code> 等线程安全的集合。</li>
  <li>使用 <code class="language-plaintext highlighter-rouge">synchronized</code> 或 <code class="language-plaintext highlighter-rouge">ThreadLocal</code> 来保证每个线程操作自己的副本。</li>
  <li>避免在流中直接修改外部共享的状态，特别是在 <code class="language-plaintext highlighter-rouge">forEach</code> 操作中。</li>
</ul>

<p><strong>状态不一致</strong></p>

<p>并行流中的一些操作可能会导致中间结果的不一致。例如，在并行流的某个操作中修改了共享状态，可能会造成中间状态在多个线程之间不一致，最终导致结果不正确。</p>

<p>解决方案：</p>
<ul>
  <li>避免修改流中的共享状态，尤其是不可变对象的状态。</li>
  <li>使用不可变对象和线程本地数据来避免状态不一致。</li>
  <li>对于需要修改状态的操作，确保该操作是原子性的。</li>
</ul>

<p><strong>线程池饱和</strong>
并行流会使用公共的 <code class="language-plaintext highlighter-rouge">ForkJoinPool</code> 来管理线程池。如果并行流的任务过多，线程池可能会耗尽，导致线程饱和，甚至阻塞其他任务。</p>

<p>解决方案：</p>

<ul>
  <li>可以通过设置系统属性 <code class="language-plaintext highlighter-rouge">java.util.concurrent.ForkJoinPool.common.parallelism</code> 来控制 <code class="language-plaintext highlighter-rouge">ForkJoinPool</code> 的线程池大小（默认为 <code class="language-plaintext highlighter-rouge">availableProcessors</code>）。</li>
  <li>对于非常重的任务，考虑使用自定义的线程池，而不是依赖默认的公共线程池。</li>
</ul>

<p><strong>示例代码：避免线程安全问题</strong></p>

<p>假设你在使用并行流时修改了共享的 <code class="language-plaintext highlighter-rouge">List</code>，这将导致线程安全问题：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">sharedList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>

<span class="c1">// 错误的并行流：会修改共享资源，造成线程安全问题</span>
<span class="n">data</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">sharedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  <span class="c1">// 不安全</span>

<span class="c1">// 正确的做法：使用线程安全的集合或避免共享资源</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">safeList</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span>
<span class="n">data</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">safeList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  <span class="c1">// 安全</span>
</code></pre></div></div>

<p>或者，避免在流操作中修改外部状态：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 错误的做法：修改外部共享状态</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">externalList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">data</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">externalList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  <span class="c1">// 可能不安全</span>

<span class="c1">// 正确的做法：使用局部变量或者线程局部变量</span>
<span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">localList</span> <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(</span><span class="nl">ArrayList:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
<span class="n">data</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">localList</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  <span class="c1">// 安全</span>
</code></pre></div></div>

<p>并行流在适当的场景下可以显著提升性能，但如果使用不当，会导致性能问题或线程安全问题。为了安全高效地使用并行流：</p>
<ul>
  <li>确保流中的操作是线程安全的。</li>
  <li>避免并行化不适合并行的任务。</li>
  <li>处理数据时，确保操作的顺序性（如果需要的话）。</li>
  <li>留意线程池资源限制和并行度的配置。</li>
</ul>

<p>使用并行流时要权衡其带来的好处与潜在的复杂性和开销。</p>

<h4 id="使用场景">使用场景</h4>

<p>如果数据量小，使用 <code class="language-plaintext highlighter-rouge">parallelStream()</code> 仍然会开启多个线程，但在这种情况下，开多线程的开销可能大于并行处理带来的性能提升。<code class="language-plaintext highlighter-rouge">parallelStream()</code> 并不会自动判断数据量大小并决定是否启用并行。</p>

<p>详细解释：</p>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">parallelStream()</code> 的工作原理</strong>： 
<code class="language-plaintext highlighter-rouge">parallelStream()</code> 会将数据分成多个片段，并在不同的线程中并行处理这些片段。具体来说，它使用了 <strong><code class="language-plaintext highlighter-rouge">ForkJoinPool</code></strong> 来管理线程池，默认情况下，会根据 CPU 核心数来决定线程池的大小。</p>
  </li>
  <li>
    <p><strong>线程开销</strong>： 
对于较小的数据量，线程的创建、上下文切换和管理等开销可能超过并行化处理所带来的性能提升。这是因为每个线程都有一定的启动成本，而如果数据量不够大，单线程的处理可能已经足够高效。</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">parallelStream()</code> 会开线程</strong>： 
即使数据量很小，调用 <code class="language-plaintext highlighter-rouge">parallelStream()</code> 依然会启动多个线程，具体线程数取决于 <strong><code class="language-plaintext highlighter-rouge">ForkJoinPool.commonPool()</code></strong> 的设置，默认情况下，它会根据机器的 <strong>CPU 核心数</strong> 来分配线程数。如果你的 CPU 核心数较多，<code class="language-plaintext highlighter-rouge">parallelStream()</code> 会使用多个线程来处理即使是小的数据集。</p>
  </li>
  <li>
    <p><strong>性能评估</strong>：</p>
    <ul>
      <li>对于小数据集，<strong>顺序流（<code class="language-plaintext highlighter-rouge">stream()</code>）</strong> 往往比并行流更高效，因为线程开销、任务划分和合并等都增加了额外的成本。</li>
      <li>如果你有大量的数据并行处理，并且<strong>数据量大于处理开销</strong>，<code class="language-plaintext highlighter-rouge">parallelStream()</code> 的并行化处理可能会带来明显的性能提升。</li>
    </ul>
  </li>
</ol>

<p>结论：</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">parallelStream()</code> 不会自动判断数据量的大小。</li>
  <li>即使数据量小，<code class="language-plaintext highlighter-rouge">parallelStream()</code> 仍会启动多个线程，但这可能会导致性能下降。</li>
  <li>如果数据量较小，推荐使用顺序流（<code class="language-plaintext highlighter-rouge">stream()</code>），这样可以避免不必要的线程开销。</li>
</ul>

<p>如果你的数据量较小，可以通过对比测试顺序流和并行流的性能，来决定是否使用并行流。</p>

<hr />

<p>“<strong>大</strong>”和“<strong>小</strong>”数据量是相对的，具体取决于多种因素，包括数据的复杂性、处理任务的复杂度、硬件环境、并行化的开销等。没有一个固定的阈值来判断数据量是“大”还是“小”，但可以根据以下几个维度来理解和评估：</p>

<p><strong>数据量的维度</strong></p>
<ul>
  <li><strong>条目数</strong>：指的是集合中元素的数量。比如，<code class="language-plaintext highlighter-rouge">List</code> 中有 1000 条数据，或者 10,000 条数据。</li>
  <li><strong>元素大小</strong>：每个数据项的大小。例如，每个数据项可能是一个简单的整数，或者包含多个字段和复杂的数据结构。</li>
</ul>

<p><strong>一般经验</strong>：</p>
<ul>
  <li>小数据量：通常为 1000 条以下的数据。</li>
  <li>中等数据量：大约 1000 到 100,000 条。</li>
  <li>大数据量：超过 100,000 条数据，尤其是需要做复杂计算时。</li>
</ul>

<p><strong>操作的复杂度</strong></p>
<ul>
  <li><strong>简单操作</strong>：例如对简单数据类型（如整数、字符串等）的求和、查找等操作。</li>
  <li>
    <p><strong>复杂操作</strong>：例如对每个数据项进行复杂的计算、条件筛选、合并、排序、分组等操作。</p>
  </li>
  <li><strong>小数据量</strong> 和 <strong>简单操作</strong>：并行流的开销不明显，可能没有必要使用 <code class="language-plaintext highlighter-rouge">parallelStream()</code>，使用顺序流更为高效。</li>
  <li><strong>小数据量</strong> 和 <strong>复杂操作</strong>：即使数据量小，复杂的操作可能使得并行化处理带来明显的性能提升。</li>
</ul>

<p><strong>硬件和环境的影响</strong></p>
<ul>
  <li><strong>CPU 核心数</strong>：计算机的核心数直接影响并行流的性能。如果只有 2 个核心，使用 4 个线程的并行流可能不会带来太多的性能提升，甚至可能因线程调度开销而影响性能。如果有 16 核或更多的 CPU，数据量更大时并行流的效果会更加明显。</li>
  <li><strong>内存和 I/O 操作</strong>：如果涉及到 I/O 操作（例如从数据库读取大量数据或进行网络请求），那么并行流的好处可能会受到系统 I/O 性能的限制。如果 CPU 处理时间是瓶颈，那么并行化会带来明显提升。</li>
</ul>

<p><strong>性能评估：</strong></p>
<ul>
  <li>对于 <strong>小数据量</strong> 和 <strong>简单操作</strong>，例如几百条数据的简单映射或过滤，顺序流通常更高效，因为创建和调度线程的开销可能超过并行处理的优势。</li>
  <li>对于 <strong>大数据量</strong> 或 <strong>复杂操作</strong>，如需要排序、大量计算或高复杂度的映射等，并行流能够有效利用多核 CPU 的并行处理能力，减少处理时间。</li>
</ul>

<p><strong>经验法则</strong></p>
<ul>
  <li><strong>小数据量</strong>：几百到几千条数据，建议使用 <strong>顺序流</strong>（<code class="language-plaintext highlighter-rouge">stream()</code>）。</li>
  <li><strong>中等数据量</strong>：几千到十几万条数据，使用 <strong>顺序流</strong> 和 <strong>并行流</strong> 性能相近，可以根据实际测试决定。</li>
  <li><strong>大数据量</strong>：超过十万条数据，特别是当数据量远大于 CPU 核心数时，使用 <strong>并行流</strong>（<code class="language-plaintext highlighter-rouge">parallelStream()</code>）通常能获得更好的性能。</li>
</ul>

<p><strong>具体建议：</strong></p>
<ul>
  <li><strong>实验</strong>：可以进行简单的性能测试，对比 <strong>顺序流</strong> 和 <strong>并行流</strong> 的执行时间，特别是在你的数据集和硬件环境下。对于小数据量，通常可以避免使用并行流。</li>
  <li><strong>监控和调优</strong>：在实际应用中，监控处理过程中的资源使用情况，如 CPU、内存等，并根据需要调整。</li>
</ul>

<p>总结：</p>
<ul>
  <li><strong>小数据量</strong>：通常指几百到几千条数据，顺序流更高效。</li>
  <li><strong>大数据量</strong>：通常指超过十万条数据，并且需要进行计算、排序等操作时，使用并行流能带来显著性能提升。</li>
  <li>数据量“多”还是“少”没有严格标准，主要是看操作的复杂性和系统的硬件资源。在处理小数据量时，避免使用 <code class="language-plaintext highlighter-rouge">parallelStream()</code> 会更高效。</li>
</ul>]]></content><author><name>acteds</name></author><category term="Java" /><summary type="html"><![CDATA[Java笔记]]></summary></entry><entry><title type="html">Excel导入导出</title><link href="/2024/11/18/Excel%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/" rel="alternate" type="text/html" title="Excel导入导出" /><published>2024-11-18T00:00:00+08:00</published><updated>2024-11-18T00:00:00+08:00</updated><id>/2024/11/18/Excel%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA</id><content type="html" xml:base="/2024/11/18/Excel%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/"><![CDATA[<h1 id="引言">引言</h1>

<p>Excel的导入导出、以及CSV文件的导出。</p>

<h1 id="java">Java</h1>

<h2 id="excel导入导出">Excel导入导出</h2>

<p>依赖添加：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="c">&lt;!-- Apache POI Core for Excel (xls) support --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.poi<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>poi<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.2.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

    <span class="c">&lt;!-- Apache POI OOXML for Excel 2007+ (xlsx) support --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.poi<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>poi-ooxml<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.2.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

    <span class="c">&lt;!-- Optional: Apache POI for handling Excel (xlsx) schemas --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.poi<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>poi-ooxml-schemas<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.2.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>

    <span class="c">&lt;!-- Optional: Apache POI Scratchpad for more advanced Excel functionalities --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.poi<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>poi-ooxml-scratchpad<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.2.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div>

<h3 id="导出">导出</h3>

<p>首先新建一个带异常抛出的<code class="language-plaintext highlighter-rouge">Consumer</code>接口。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 带异常抛出的Consumer
 * @author aotmd
 * @version 1.0
 * @date 2024/11/26 17:34
 */</span>
<span class="nd">@FunctionalInterface</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ConsumerWithException</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**
     * 对给定的参数执行此操作，并且可能会引发异常。
     *
     * @param t 输入参数
     * @throws Exception 如果在处理过程中发生任何错误
     */</span>
    <span class="kt">void</span> <span class="nf">accept</span><span class="o">(</span><span class="no">T</span> <span class="n">t</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>然后建立一个服务层：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExcelService</span> <span class="o">{}</span>
</code></pre></div></div>

<p>对于导出，可以直接使用<code class="language-plaintext highlighter-rouge">SXSSFWorkbook</code>类，它会动态管理存储在内存中的行，防止内存溢出。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** 在刷新之前保留在内存中的行数，请参见上文。 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">rowAccessWindowSize</span> <span class="o">=</span> <span class="no">DEFAULT_WINDOW_SIZE</span><span class="o">;</span>

<span class="cm">/**
* 设置写操作，在刷新之前保留在内存中的行数
* @param rowAccessWindowSize 在刷新之前保留在内存中的行数
*/</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRowAccessWindowSize</span><span class="o">(</span><span class="kt">int</span> <span class="n">rowAccessWindowSize</span><span class="o">)</span> <span class="o">{</span>
<span class="k">this</span><span class="o">.</span><span class="na">rowAccessWindowSize</span> <span class="o">=</span> <span class="n">rowAccessWindowSize</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
* 导出Excel
* @param os 输出流
* @param chineseTableHeader 中文表头
* @param callback 回调
*/</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportExcel</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">os</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">chineseTableHeader</span><span class="o">,</span> <span class="nc">ConsumerWithException</span><span class="o">&lt;</span><span class="nc">Sheet</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/*设置页码*/</span>
<span class="c1">// 创建Excel工作簿</span>
<span class="k">try</span> <span class="o">(</span><span class="nc">SXSSFWorkbook</span> <span class="n">wb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SXSSFWorkbook</span><span class="o">(</span><span class="n">rowAccessWindowSize</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">Sheet</span> <span class="n">sheet</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="na">createSheet</span><span class="o">(</span><span class="s">"Sheet1"</span><span class="o">);</span>
    <span class="c1">// 设置每列的宽度</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chineseTableHeader</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">sheet</span><span class="o">.</span><span class="na">setColumnWidth</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="mi">5000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 创建一个CellStyle对象，用于设置加粗样式</span>
    <span class="nc">CellStyle</span> <span class="n">headerCellStyle</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="na">createCellStyle</span><span class="o">();</span>
    <span class="nc">Font</span> <span class="n">headerFont</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="na">createFont</span><span class="o">();</span>
    <span class="n">headerFont</span><span class="o">.</span><span class="na">setBold</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  <span class="c1">// 设置加粗</span>
    <span class="n">headerCellStyle</span><span class="o">.</span><span class="na">setFont</span><span class="o">(</span><span class="n">headerFont</span><span class="o">);</span>  <span class="c1">// 将加粗字体应用到样式中</span>

    <span class="c1">// 写入表头</span>
    <span class="nc">Row</span> <span class="n">headerRow</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">createRow</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">colIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">chineseTableHeader</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">headerRow</span><span class="o">.</span><span class="na">createCell</span><span class="o">(</span><span class="n">colIndex</span><span class="o">++);</span>
        <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="n">cell</span><span class="o">.</span><span class="na">setCellStyle</span><span class="o">(</span><span class="n">headerCellStyle</span><span class="o">);</span>  <span class="c1">// 应用加粗样式</span>
    <span class="o">}</span>
    <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">sheet</span><span class="o">);</span>
    <span class="n">wb</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">os</span><span class="o">);</span>
    <span class="n">os</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="n">os</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导出数据抛出异常"</span><span class="o">,</span><span class="n">e</span><span class="o">);</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"导出数据抛出异常"</span><span class="o">,</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这个方法会自动填充表头，并设置加粗样式，然后执行回调方法。</p>

<p>还可以添加一个写入数据行的方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 写入数据行到Excel
 *
 * @param sheet       excel对象
 * @param data        数据
 * @param fieldHeader 属性key
 * @param rowIndex    第几行
 */</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">writeDataRowsToExcel</span><span class="o">(</span><span class="nc">Sheet</span> <span class="n">sheet</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">data</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fieldHeader</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rowIndex</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">colIndex</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">line</span> <span class="o">:</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Row</span> <span class="n">dataRow</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">createRow</span><span class="o">(</span><span class="n">rowIndex</span><span class="o">++);</span>
        <span class="n">colIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">titleKey</span> <span class="o">:</span> <span class="n">fieldHeader</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">dataRow</span><span class="o">.</span><span class="na">createCell</span><span class="o">(</span><span class="n">colIndex</span><span class="o">++);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">line</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">titleKey</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">titleKey</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">List</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;)</span> <span class="n">o</span><span class="o">;</span>
                <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
                <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">String</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">o</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Integer</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span> <span class="n">o</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Double</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">((</span><span class="nc">Double</span><span class="o">)</span> <span class="n">o</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">rowIndex</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">excelService</span><span class="o">.</span><span class="na">setRowAccessWindowSize</span><span class="o">(</span><span class="no">NUM_PER_PAGE</span><span class="o">);</span>
<span class="n">excelService</span><span class="o">.</span><span class="na">exportExcel</span><span class="o">(</span><span class="n">outputStream</span><span class="o">,</span> <span class="n">tableHeader</span><span class="o">,</span> <span class="o">(</span><span class="n">sheet</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="c1">// 写入数据行，从第1行开始</span>
    <span class="kt">int</span> <span class="n">rowIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="cm">/*获取数据*/</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="o">...;</span>
    <span class="n">rowIndex</span> <span class="o">=</span> <span class="n">excelService</span><span class="o">.</span><span class="na">writeDataRowsToExcel</span><span class="o">(</span><span class="n">sheet</span><span class="o">,</span> <span class="n">rowsData</span><span class="o">,</span> <span class="n">keys</span><span class="o">,</span> <span class="n">rowIndex</span><span class="o">);</span>
<span class="o">});</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">rowIndex</code>是下一个空行的索引，如果是分段写入，就需要这个值，如果需要通过这个值获取总行数，注意最后减一。</p>

<h3 id="导入">导入</h3>

<p>添加依赖：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--大xlsx文件导入--&gt;</span>
<span class="c">&lt;!-- https://mvnrepository.com/artifact/com.github.pjfanning/excel-streaming-reader --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.github.pjfanning<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>excel-streaming-reader<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.3.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>添加方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 导入Excel
 * @param is 输入流
 * @param callback 回调
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">importExcel</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">is</span><span class="o">,</span> <span class="nc">BiConsumer</span><span class="o">&lt;</span><span class="nc">Sheet</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 使用StreamingReader包装后，就只能使用流来操作行了，不能指定获取指定行了</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">Workbook</span> <span class="n">workbook</span> <span class="o">=</span> <span class="nc">StreamingReader</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">rowCacheSize</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>    <span class="c1">// 设置内存中保持的行数，默认是10</span>
            <span class="o">.</span><span class="na">bufferSize</span><span class="o">(</span><span class="mi">4096</span><span class="o">)</span><span class="c1">// 设置读取 InputStream 时的缓冲区大小（字节）</span>
            <span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">is</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">Sheet</span> <span class="n">sheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="na">getSheetAt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">sheet</span><span class="o">.</span><span class="na">getLastRowNum</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导入的数据查过10000行"</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"导入的数据查过10000行"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">rowIterator</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="c1">// 获取数据的表头,第一行</span>
        <span class="nc">Row</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rowIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span> <span class="o">=</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(),</span> <span class="kc">false</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cell:</span><span class="o">:</span><span class="n">getStringCellValue</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

        <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">sheet</span><span class="o">,</span> <span class="n">tableHeader</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导入时发生异常：{}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"导入时发生异常：{}"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">.rowCacheSize(100)</code> 这里也可以抽出来做为配置项。</p>

<p>执行回调方法会传入两个参数，一个是对象，一个是读取到的表头，注意这里迭代器已经消耗完第一行了。</p>

<p>还可以加一个读每行数据的方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 获取原值
 *
 * @param cell 单元格
 * @return
 */</span>
<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getValue</span><span class="o">(</span><span class="nc">Cell</span> <span class="n">cell</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 单元格类型</span>
    <span class="nc">CellType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getCellType</span><span class="o">();</span>
    <span class="c1">// 值</span>
    <span class="nc">Object</span> <span class="n">value</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">NUMERIC</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 字符串或数字类型</span>
        <span class="kt">double</span> <span class="n">numericCellValue</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getNumericCellValue</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">numericCellValue</span> <span class="o">==</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">numericCellValue</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">numericCellValue</span><span class="o">;</span><span class="c1">// 转为整数</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">numericCellValue</span><span class="o">;</span> <span class="c1">//保持为浮动数</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getStringCellValue</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用示例：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">excelService</span><span class="o">.</span><span class="na">importExcel</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="o">(</span><span class="n">sheet</span><span class="o">,</span> <span class="n">chineseTableHeader</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="c1">// 得到实际表头</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span> <span class="o">=</span> <span class="n">getTableHeader</span><span class="o">(</span><span class="n">chineseTableHeader</span><span class="o">,</span> <span class="n">importMetadata</span><span class="o">.</span><span class="na">tableColumn</span><span class="o">);</span>
    <span class="c1">// 获得需要写入的数据的索引</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">index</span> <span class="o">=</span> <span class="n">getIndex</span><span class="o">(</span><span class="n">tableHeader</span><span class="o">);</span>
    <span class="c1">// 存储插入到原表的数据</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">insertOriginal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// 获取迭代器</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Row</span> <span class="n">row</span> <span class="o">:</span> <span class="n">sheet</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 跳过excel空行</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(),</span> <span class="kc">true</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="nl">Cell:</span><span class="o">:</span><span class="n">getCellType</span><span class="o">).</span><span class="na">allMatch</span><span class="o">(</span><span class="n">cellType</span> <span class="o">-&gt;</span> <span class="n">cellType</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">BLANK</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 原数据</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">insertOriginalMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">index</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span><span class="o">-&gt;{</span>
                <span class="c1">// 单元格值</span>
                <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">getCell</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="c1">// 键</span>
                <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">tableHeader</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">cell</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">insertOriginalMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">excelService</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">cell</span><span class="o">);</span>
                <span class="n">excelDataMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
            <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"数据类型错误："</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 插入原表的数据</span>
        <span class="n">insertOriginal</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">insertOriginal</span><span class="o">);</span>
        <span class="c1">// 如果要插入明细表的数据达到500条则开始插入操作。</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">insertUploadDetail</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">500</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">insertOriginal</span><span class="o">(...);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 将剩余的数据插入</span>
    <span class="n">insertOriginal</span><span class="o">(...);</span>
<span class="o">});</span>
</code></pre></div></div>

<p>导入还可能需要校验数据的合法性，以及数组类型，或者上传明细记录等业务处理，不一一展示。</p>

<p>注意并行流导致的共享变量写入问题，可能导致数据丢失。</p>

<h3 id="文本读取时变为浮点数">文本读取时变为浮点数</h3>

<p>在 Excel 文件中，尤其是对于大型数字（如手机号码、身份证号码等），有时它们会被自动识别为数值类型（<code class="language-plaintext highlighter-rouge">NUMERIC</code>），但实际上你需要将它们作为文本来处理。因为 Excel 会将大数字（如 <code class="language-plaintext highlighter-rouge">18844344316</code>）转换为 <code class="language-plaintext highlighter-rouge">double</code>，可能会失去精度，或者会自动以科学计数法（如 <code class="language-plaintext highlighter-rouge">1.8844344316E10</code>）显示。</p>

<p>为了确保读取正确的文本，可以尝试以下几种方法来获取单元格中的值：</p>

<p><strong>检查单元格是否为文本类型</strong></p>

<p>如果数据在 Excel 中是文本格式（即没有被误识别为数值），你可以直接读取为字符串。对于 <code class="language-plaintext highlighter-rouge">NUMERIC</code> 类型的单元格，你需要检查其值是否为 <code class="language-plaintext highlighter-rouge">double</code>，然后转回为字符串。</p>

<p><strong>强制将 <code class="language-plaintext highlighter-rouge">NUMERIC</code> 类型转为字符串</strong></p>

<p>如果遇到的是 <code class="language-plaintext highlighter-rouge">NUMERIC</code> 类型的单元格，并且该单元格的内容应该是一个大数字（如电话号码），可以使用以下方法将其读取为字符串，而不是 <code class="language-plaintext highlighter-rouge">double</code>：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.poi.ss.usermodel.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.text.DecimalFormat</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExcelReader</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 假设 cell 是当前单元格</span>
        <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="o">...;</span>

        <span class="c1">// 获取单元格类型</span>
        <span class="nc">CellType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getCellType</span><span class="o">();</span>

        <span class="c1">// 值</span>
        <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果是字符串类型</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getStringCellValue</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">NUMERIC</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果是数字类型，处理为字符串</span>
            <span class="kt">double</span> <span class="n">numericValue</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getNumericCellValue</span><span class="o">();</span>

            <span class="c1">// 使用 DecimalFormat 强制转换为字符串，不进行科学计数法</span>
            <span class="nc">DecimalFormat</span> <span class="n">df</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DecimalFormat</span><span class="o">(</span><span class="s">"0"</span><span class="o">);</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">numericValue</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"单元格的值: "</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>使用 <code class="language-plaintext highlighter-rouge">DataFormatter</code> 来处理</strong></p>

<p><code class="language-plaintext highlighter-rouge">DataFormatter</code> 是 Apache POI 提供的一个工具，它可以根据单元格的实际显示格式来读取数据。这对于处理数值格式化问题特别有用，尤其是在数据被自动转换为数值类型时。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.poi.ss.usermodel.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.poi.ss.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExcelReader</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 假设 cell 是当前单元格</span>
        <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="o">...;</span>

        <span class="c1">// 使用 DataFormatter 获取值</span>
        <span class="nc">DataFormatter</span> <span class="n">dataFormatter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataFormatter</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">cellValue</span> <span class="o">=</span> <span class="n">dataFormatter</span><span class="o">.</span><span class="na">formatCellValue</span><span class="o">(</span><span class="n">cell</span><span class="o">);</span>

        <span class="c1">// 输出读取的单元格值</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"单元格的值: "</span> <span class="o">+</span> <span class="n">cellValue</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>设置 Excel 中的单元格格式</strong></p>

<p>如果你控制 Excel 文件的创建，确保该列的格式设置为文本格式。这可以避免 Excel 自动将大数字识别为 <code class="language-plaintext highlighter-rouge">double</code>。</p>

<p>在 Apache POI 中，可以设置单元格格式为文本：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CellStyle</span> <span class="n">cellStyle</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="na">createCellStyle</span><span class="o">();</span>
<span class="nc">DataFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="na">createDataFormat</span><span class="o">();</span>
<span class="n">cellStyle</span><span class="o">.</span><span class="na">setDataFormat</span><span class="o">(</span><span class="n">format</span><span class="o">.</span><span class="na">getFormat</span><span class="o">(</span><span class="s">"@"</span><span class="o">));</span> <span class="c1">// "@" 表示文本格式</span>
<span class="n">cell</span><span class="o">.</span><span class="na">setCellStyle</span><span class="o">(</span><span class="n">cellStyle</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>强制读取为字符串</strong></p>

<p>如果你确定单元格中的数据应该是文本（如电话号码），即使 Excel 将其处理为数值类型，你也可以通过 <code class="language-plaintext highlighter-rouge">getStringCellValue</code> 强制将其作为字符串读取。为了确保数字不被科学计数法转换，你可以先将 <code class="language-plaintext highlighter-rouge">NUMERIC</code> 类型转换为字符串。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">NUMERIC</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">cellText</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">cell</span><span class="o">.</span><span class="na">getNumericCellValue</span><span class="o">());</span>
    <span class="c1">// 如果 cellText 显示为科学计数法，可以通过 String.format 转换成标准格式</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%.0f"</span><span class="o">,</span> <span class="n">cell</span><span class="o">.</span><span class="na">getNumericCellValue</span><span class="o">());</span>
<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getStringCellValue</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>读取前将单元格设置为文本类型读取</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cell</span><span class="o">.</span><span class="na">setCellType</span><span class="o">(</span><span class="nc">CellType</span><span class="o">.</span><span class="na">STRING</span><span class="o">);</span> 
</code></pre></div></div>

<p>总结：</p>

<ol>
  <li><strong>对于数字类型（<code class="language-plaintext highlighter-rouge">NUMERIC</code>），使用 <code class="language-plaintext highlighter-rouge">DecimalFormat</code></strong> 来确保数值以文本形式显示，避免科学计数法。</li>
  <li><strong>使用 <code class="language-plaintext highlighter-rouge">DataFormatter</code></strong>，它能够智能处理数值与文本类型，并确保读取时按照实际显示格式处理。</li>
  <li><strong>强制读取为文本</strong>，特别是对于像电话号码、身份证号等数据，不应将其当作数字类型处理，避免出现精度丢失或科学计数法的情况。</li>
</ol>

<h3 id="完整代码">完整代码</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.ilw.formflowprovider.center.service.other</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.github.pjfanning.xlsx.StreamingReader</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.poi.ss.usermodel.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.poi.xssf.streaming.SXSSFWorkbook</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.BiConsumer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.StreamSupport</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">poi</span><span class="o">.</span><span class="na">xssf</span><span class="o">.</span><span class="na">streaming</span><span class="o">.</span><span class="na">SXSSFWorkbook</span><span class="o">.</span><span class="na">DEFAULT_WINDOW_SIZE</span><span class="o">;</span>

<span class="cm">/**
 * Excel导出服务层
 * @author aotmd
 * @version 1.0
 * @date 2024/11/20 11:05
 */</span>
<span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExcelService</span> <span class="o">{</span>
    <span class="cm">/** 在刷新之前保留在内存中的行数，请参见上文。 */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">rowAccessWindowSize</span> <span class="o">=</span> <span class="no">DEFAULT_WINDOW_SIZE</span><span class="o">;</span>

    <span class="cm">/**
     * 设置写操作，在刷新之前保留在内存中的行数
     * @param rowAccessWindowSize 在刷新之前保留在内存中的行数
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRowAccessWindowSize</span><span class="o">(</span><span class="kt">int</span> <span class="n">rowAccessWindowSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rowAccessWindowSize</span> <span class="o">=</span> <span class="n">rowAccessWindowSize</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 导出Excel
     * @param os 输出流
     * @param chineseTableHeader 中文表头
     * @param callback 回调
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportExcel</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">os</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">chineseTableHeader</span><span class="o">,</span> <span class="nc">ConsumerWithException</span><span class="o">&lt;</span><span class="nc">Sheet</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/*设置页码*/</span>
        <span class="c1">// 创建Excel工作簿</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">SXSSFWorkbook</span> <span class="n">wb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SXSSFWorkbook</span><span class="o">(</span><span class="n">rowAccessWindowSize</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Sheet</span> <span class="n">sheet</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="na">createSheet</span><span class="o">(</span><span class="s">"Sheet1"</span><span class="o">);</span>
            <span class="c1">// 设置每列的宽度</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chineseTableHeader</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">sheet</span><span class="o">.</span><span class="na">setColumnWidth</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="mi">5000</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// 创建一个CellStyle对象，用于设置加粗样式</span>
            <span class="nc">CellStyle</span> <span class="n">headerCellStyle</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="na">createCellStyle</span><span class="o">();</span>
            <span class="nc">Font</span> <span class="n">headerFont</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="na">createFont</span><span class="o">();</span>
            <span class="n">headerFont</span><span class="o">.</span><span class="na">setBold</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  <span class="c1">// 设置加粗</span>
            <span class="n">headerCellStyle</span><span class="o">.</span><span class="na">setFont</span><span class="o">(</span><span class="n">headerFont</span><span class="o">);</span>  <span class="c1">// 将加粗字体应用到样式中</span>

            <span class="c1">// 写入表头</span>
            <span class="nc">Row</span> <span class="n">headerRow</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">createRow</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">colIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">key</span> <span class="o">:</span> <span class="n">chineseTableHeader</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">headerRow</span><span class="o">.</span><span class="na">createCell</span><span class="o">(</span><span class="n">colIndex</span><span class="o">++);</span>
                <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                <span class="n">cell</span><span class="o">.</span><span class="na">setCellStyle</span><span class="o">(</span><span class="n">headerCellStyle</span><span class="o">);</span>  <span class="c1">// 应用加粗样式</span>
            <span class="o">}</span>
            <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">sheet</span><span class="o">);</span>
            <span class="n">wb</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">os</span><span class="o">);</span>
            <span class="n">os</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="n">os</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导出数据抛出异常"</span><span class="o">,</span><span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"导出数据抛出异常"</span><span class="o">,</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 导入Excel
     * @param is 输入流
     * @param callback 回调
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">importExcel</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">is</span><span class="o">,</span> <span class="nc">BiConsumer</span><span class="o">&lt;</span><span class="nc">Sheet</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 使用StreamingReader包装后，就只能使用流来操作行了，不能指定获取指定行了</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Workbook</span> <span class="n">workbook</span> <span class="o">=</span> <span class="nc">StreamingReader</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">rowCacheSize</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>    <span class="c1">// 设置内存中保持的行数，默认是10</span>
                <span class="o">.</span><span class="na">bufferSize</span><span class="o">(</span><span class="mi">4096</span><span class="o">)</span><span class="c1">// 设置读取 InputStream 时的缓冲区大小（字节）</span>
                <span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="n">is</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Sheet</span> <span class="n">sheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="na">getSheetAt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">sheet</span><span class="o">.</span><span class="na">getLastRowNum</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导入的数据查过10000行"</span><span class="o">);</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"导入的数据查过10000行"</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">rowIterator</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
            <span class="c1">// 获取数据的表头,第一行</span>
            <span class="nc">Row</span> <span class="n">r</span> <span class="o">=</span> <span class="n">rowIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span> <span class="o">=</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(),</span> <span class="kc">false</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cell:</span><span class="o">:</span><span class="n">getStringCellValue</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

            <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">sheet</span><span class="o">,</span> <span class="n">tableHeader</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导入时发生异常：{}"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"导入时发生异常：{}"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 写入数据行到Excel
     *
     * @param sheet       excel对象
     * @param data        数据
     * @param fieldHeader 属性key
     * @param rowIndex    第几行,注意最后返回的是新行
     */</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">writeDataRowsToExcel</span><span class="o">(</span><span class="nc">Sheet</span> <span class="n">sheet</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">data</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fieldHeader</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rowIndex</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">colIndex</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">line</span> <span class="o">:</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Row</span> <span class="n">dataRow</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="na">createRow</span><span class="o">(</span><span class="n">rowIndex</span><span class="o">++);</span>
            <span class="n">colIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">titleKey</span> <span class="o">:</span> <span class="n">fieldHeader</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">dataRow</span><span class="o">.</span><span class="na">createCell</span><span class="o">(</span><span class="n">colIndex</span><span class="o">++);</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">line</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">titleKey</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="nc">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">titleKey</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">List</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;)</span> <span class="n">o</span><span class="o">;</span>
                    <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
                    <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">String</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">o</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Integer</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span> <span class="n">o</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Double</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">((</span><span class="nc">Double</span><span class="o">)</span> <span class="n">o</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">rowIndex</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 获取原值
     *
     * @param cell 单元格
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getValue</span><span class="o">(</span><span class="nc">Cell</span> <span class="n">cell</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 单元格类型</span>
        <span class="nc">CellType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getCellType</span><span class="o">();</span>
        <span class="c1">// 值</span>
        <span class="nc">Object</span> <span class="n">value</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">NUMERIC</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 字符串或数字类型</span>
            <span class="kt">double</span> <span class="n">numericCellValue</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getNumericCellValue</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">numericCellValue</span> <span class="o">==</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">numericCellValue</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">value</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">numericCellValue</span><span class="o">;</span><span class="c1">// 转为整数</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">numericCellValue</span><span class="o">;</span> <span class="c1">//保持为浮动数</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">CellType</span><span class="o">.</span><span class="na">STRING</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="na">getStringCellValue</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="csv导入导出">CSV导入导出</h2>

<h3 id="导出-1">导出</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CsvService</span> <span class="o">{</span>

    <span class="cm">/**
     * 导出CSV
     * @param tableHeader 表头
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportCsv</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">os</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span><span class="o">,</span> <span class="nc">ConsumerWithException</span><span class="o">&lt;</span><span class="nc">BufferedWriter</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 写入BOM头，通知Excel使用UTF-8编码</span>
        <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xEF</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xBB</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xBF</span> <span class="o">});</span>
        <span class="c1">// 将BufferedWriter包裹在BufferedOutputStream中</span>
        <span class="c1">// 写入 CSV 文件</span>
        <span class="c1">// 32KB缓冲区</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">os</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">),</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 写入表头</span>
            <span class="nc">String</span> <span class="n">headerLine</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="n">tableHeader</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">headerLine</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>  <span class="c1">// 换行</span>
            <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span><span class="c1">//执行逻辑</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>  <span class="c1">// 确保所有数据都写入到响应流</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导出CSV数据抛出异常"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 写入CSV的数据（带转义处理）
     * @param writer 输出流
     * @param data 数据（数组）
     * @param fieldHeader 字段名
     * @throws IOException
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeCsvData</span><span class="o">(</span><span class="nc">BufferedWriter</span> <span class="n">writer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">data</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fieldHeader</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">rowData</span> <span class="o">:</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">StringBuilder</span> <span class="n">line</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">field</span> <span class="o">:</span> <span class="n">fieldHeader</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">rowData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">line</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\"\""</span><span class="o">);</span>  <span class="c1">// 对空值进行转义处理</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">valueStr</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">List</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;)</span> <span class="n">value</span><span class="o">;</span>
                        <span class="n">valueStr</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
                    <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                        <span class="n">valueStr</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="c1">// 对字段值进行转义处理</span>
                    <span class="n">valueStr</span> <span class="o">=</span> <span class="n">escapeCsvValue</span><span class="o">(</span><span class="n">valueStr</span><span class="o">);</span>
                    <span class="n">line</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\""</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">valueStr</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\""</span><span class="o">);</span>  <span class="c1">// 用双引号包裹数据</span>
                <span class="o">}</span>
                <span class="n">line</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>  <span class="c1">// 每个字段后面加上逗号</span>
            <span class="o">}</span>
            <span class="c1">// 移除行尾的逗号</span>
            <span class="n">line</span><span class="o">.</span><span class="na">deleteCharAt</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>  <span class="c1">// 换行</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 转义CSV中的特殊字符
     * @param value 字段值
     * @return 转义后的字符串
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">escapeCsvValue</span><span class="o">(</span><span class="nc">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 替换双引号为两个双引号</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"\""</span><span class="o">,</span> <span class="s">"\"\""</span><span class="o">);</span>
        <span class="c1">// 去除可能的换行符和回车符</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"\n"</span><span class="o">,</span> <span class="s">" "</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">"\r"</span><span class="o">,</span> <span class="s">" "</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>注意设置BOM头，强制指定编码。使用Apipost接口调试时，会自动忽略掉BOM头，不用担心，改用浏览器调试就有正常的BOM头。</p>

<p>使用示例：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csvService</span><span class="o">.</span><span class="na">exportCsv</span><span class="o">(</span><span class="n">outputStream</span><span class="o">,</span> <span class="n">tableHeader</span><span class="o">,</span> <span class="o">(</span><span class="n">writer</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">data0</span><span class="o">;</span>
    <span class="c1">// 分页获取数据并追加写入CSV文件</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">maxPage</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="o">...</span>
        <span class="n">csvService</span><span class="o">.</span><span class="na">writeCsvData</span><span class="o">(</span><span class="n">writer</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="n">keys</span><span class="o">);</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<h3 id="导入-1">导入</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**导入每批次处理1000条数据*/</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>

<span class="cm">/**
 * 设置导入每次处理数量
 * @param batchSize 处理数量
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBatchSize</span><span class="o">(</span><span class="kt">int</span> <span class="n">batchSize</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">batchSize</span> <span class="o">=</span> <span class="n">batchSize</span><span class="o">;</span>
<span class="o">}</span>
<span class="cm">/**
 * 导入CSV数据
 * @param inputStream 输入流
 * @param callback 处理每行数据的回调函数
 * @throws IOException
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">importCsv</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">,</span> <span class="nc">ConsumerWithException</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">(</span><span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">inputStream</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)))</span> <span class="o">{</span>
        <span class="c1">// 跳过BOM头</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">mark</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">()</span> <span class="o">!=</span> <span class="mh">0xEF</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// 读取表头</span>
        <span class="nc">String</span> <span class="n">headerLine</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fileHeader</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">headerLine</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">));</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">dataList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
        <span class="c1">// 每批次处理1000条数据</span>
        <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="c1">// 逐行读取并处理CSV数据</span>
        <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">rowData</span> <span class="o">=</span> <span class="n">parseCsvRow</span><span class="o">(</span><span class="n">line</span><span class="o">,</span> <span class="n">fileHeader</span><span class="o">);</span>
            <span class="n">dataList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rowData</span><span class="o">);</span>

            <span class="c1">// 每处理完一个批次数据，调用回调函数</span>
            <span class="k">if</span> <span class="o">(++</span><span class="n">count</span> <span class="o">%</span> <span class="n">batchSize</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">dataList</span><span class="o">));</span>
                <span class="n">dataList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span> <span class="c1">// 清空当前批次数据</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// 处理剩余的不足一批的数据</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">dataList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">dataList</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导入CSV数据抛出异常"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"导入CSV文件时出现错误"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * 解析CSV每行数据并映射为Map
 * @param line CSV中的一行数据
 * @param tableHeader 表头
 * @return 行数据的Map
 */</span>
<span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">parseCsvRow</span><span class="o">(</span><span class="nc">String</span> <span class="n">line</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">rowData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tableHeader</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">tableHeader</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>

        <span class="c1">// 处理转义字符</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">unescapeCsvValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="n">rowData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">rowData</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * 转义CSV中的特殊字符（例如，双引号、换行符等）
 * @param value 字段值
 * @return 还原转义后的字符串
 */</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="nf">unescapeCsvValue</span><span class="o">(</span><span class="nc">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 去除双引号</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"\""</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"\""</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 替换双引号为一个双引号</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"\"\""</span><span class="o">,</span> <span class="s">"\""</span><span class="o">);</span>
    <span class="c1">// 去除换行符和回车符</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">" "</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">" "</span><span class="o">,</span> <span class="s">"\r"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用示例：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csvService</span><span class="o">.</span><span class="na">importCsv</span><span class="o">(</span><span class="n">csvInputStream</span><span class="o">,</span> <span class="n">tableHeader</span><span class="o">,</span> <span class="n">dataList</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="c1">// 这里处理导入的数据，比如保存到数据库</span>
    <span class="n">dataList</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">row</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"导入的数据："</span> <span class="o">+</span> <span class="n">row</span><span class="o">);</span>
    <span class="o">});</span>
<span class="o">});</span>
</code></pre></div></div>

<h3 id="完整代码-1">完整代码</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.ilw.formflowprovider.center.service.other</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="cm">/**
 * CSV导出服务层
 * @author aotmd
 * @version 1.0
 * @date 2024/11/20 10:49
 */</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CsvService</span> <span class="o">{</span>
    <span class="cm">/**导入每批次处理1000条数据*/</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>

    <span class="cm">/**
     * 设置导入每次处理数量
     * @param batchSize 处理数量
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBatchSize</span><span class="o">(</span><span class="kt">int</span> <span class="n">batchSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">batchSize</span> <span class="o">=</span> <span class="n">batchSize</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 导出CSV
     * @param tableHeader 表头
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exportCsv</span><span class="o">(</span><span class="nc">OutputStream</span> <span class="n">os</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span><span class="o">,</span> <span class="nc">ConsumerWithException</span><span class="o">&lt;</span><span class="nc">BufferedWriter</span><span class="o">&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 写入BOM头，通知Excel使用UTF-8编码</span>
        <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="k">new</span> <span class="kt">byte</span><span class="o">[]</span> <span class="o">{</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xEF</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xBB</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mh">0xBF</span> <span class="o">});</span>
        <span class="c1">// 将BufferedWriter包裹在BufferedOutputStream中</span>
        <span class="c1">// 写入 CSV 文件</span>
        <span class="c1">// 32KB缓冲区</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">os</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">),</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 写入表头</span>
            <span class="nc">String</span> <span class="n">headerLine</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="n">tableHeader</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">headerLine</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>  <span class="c1">// 换行</span>
            <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span><span class="c1">//执行逻辑</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>  <span class="c1">// 确保所有数据都写入到响应流</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导出CSV数据抛出异常"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 写入CSV的数据（带转义处理）
     * @param writer 输出流
     * @param data 数据（数组）
     * @param fieldHeader 字段名
     * @throws IOException
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeCsvData</span><span class="o">(</span><span class="nc">BufferedWriter</span> <span class="n">writer</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">data</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fieldHeader</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">rowData</span> <span class="o">:</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">StringBuilder</span> <span class="n">line</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">field</span> <span class="o">:</span> <span class="n">fieldHeader</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">rowData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">line</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\"\""</span><span class="o">);</span>  <span class="c1">// 对空值进行转义处理</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">valueStr</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">List</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;)</span> <span class="n">value</span><span class="o">;</span>
                        <span class="n">valueStr</span> <span class="o">=</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="n">list</span><span class="o">);</span>
                    <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                        <span class="n">valueStr</span><span class="o">=</span><span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="c1">// 对字段值进行转义处理</span>
                    <span class="n">valueStr</span> <span class="o">=</span> <span class="n">escapeCsvValue</span><span class="o">(</span><span class="n">valueStr</span><span class="o">);</span>
                    <span class="n">line</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\""</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">valueStr</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\""</span><span class="o">);</span>  <span class="c1">// 用双引号包裹数据</span>
                <span class="o">}</span>
                <span class="n">line</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>  <span class="c1">// 每个字段后面加上逗号</span>
            <span class="o">}</span>
            <span class="c1">// 移除行尾的逗号</span>
            <span class="n">line</span><span class="o">.</span><span class="na">deleteCharAt</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>  <span class="c1">// 换行</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 转义CSV中的特殊字符
     * @param value 字段值
     * @return 转义后的字符串
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">escapeCsvValue</span><span class="o">(</span><span class="nc">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 替换双引号为两个双引号</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"\""</span><span class="o">,</span> <span class="s">"\"\""</span><span class="o">);</span>
        <span class="c1">// 去除可能的换行符和回车符</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"\n"</span><span class="o">,</span> <span class="s">" "</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">"\r"</span><span class="o">,</span> <span class="s">" "</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 导入CSV数据
     * @param inputStream 输入流
     * @param callback 处理每行数据的回调函数
     * @throws IOException
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">importCsv</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">,</span> <span class="nc">ConsumerWithException</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;&gt;</span> <span class="n">callback</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">inputStream</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)))</span> <span class="o">{</span>
            <span class="c1">// 跳过BOM头</span>
            <span class="n">reader</span><span class="o">.</span><span class="na">mark</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">()</span> <span class="o">!=</span> <span class="mh">0xEF</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">reader</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">// 读取表头</span>
            <span class="nc">String</span> <span class="n">headerLine</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fileHeader</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">headerLine</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">));</span>

            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">dataList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="nc">String</span> <span class="n">line</span><span class="o">;</span>
            <span class="c1">// 每批次处理1000条数据</span>
            <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

            <span class="c1">// 逐行读取并处理CSV数据</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">rowData</span> <span class="o">=</span> <span class="n">parseCsvRow</span><span class="o">(</span><span class="n">line</span><span class="o">,</span> <span class="n">fileHeader</span><span class="o">);</span>
                <span class="n">dataList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rowData</span><span class="o">);</span>

                <span class="c1">// 每处理完一个批次数据，调用回调函数</span>
                <span class="k">if</span> <span class="o">(++</span><span class="n">count</span> <span class="o">%</span> <span class="n">batchSize</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">dataList</span><span class="o">));</span>
                    <span class="n">dataList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span> <span class="c1">// 清空当前批次数据</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="c1">// 处理剩余的不足一批的数据</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">dataList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">callback</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">dataList</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"导入CSV数据抛出异常"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"导入CSV文件时出现错误"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 解析CSV每行数据并映射为Map
     * @param line CSV中的一行数据
     * @param tableHeader 表头
     * @return 行数据的Map
     */</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">parseCsvRow</span><span class="o">(</span><span class="nc">String</span> <span class="n">line</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">rowData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tableHeader</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">tableHeader</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>

            <span class="c1">// 处理转义字符</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unescapeCsvValue</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
            <span class="n">rowData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">rowData</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 转义CSV中的特殊字符（例如，双引号、换行符等）
     * @param value 字段值
     * @return 还原转义后的字符串
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">unescapeCsvValue</span><span class="o">(</span><span class="nc">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 去除双引号</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"\""</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">"\""</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">value</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 替换双引号为一个双引号</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"\"\""</span><span class="o">,</span> <span class="s">"\""</span><span class="o">);</span>
        <span class="c1">// 去除换行符和回车符</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">" "</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="s">" "</span><span class="o">,</span> <span class="s">"\r"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>]]></content><author><name>acteds</name></author><category term="Java" /><summary type="html"><![CDATA[Java笔记]]></summary></entry><entry><title type="html">本地环境正常，k8s上中文乱码解决方法</title><link href="/2024/11/15/%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83%E6%AD%A3%E5%B8%B8-k8s%E4%B8%8A%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" rel="alternate" type="text/html" title="本地环境正常，k8s上中文乱码解决方法" /><published>2024-11-15T00:00:00+08:00</published><updated>2024-11-15T00:00:00+08:00</updated><id>/2024/11/15/%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83%E6%AD%A3%E5%B8%B8%EF%BC%8Ck8s%E4%B8%8A%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95</id><content type="html" xml:base="/2024/11/15/%E6%9C%AC%E5%9C%B0%E7%8E%AF%E5%A2%83%E6%AD%A3%E5%B8%B8-k8s%E4%B8%8A%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"><![CDATA[<h1 id="引言">引言</h1>

<p>本地环境正常，docker容器正常，k8s上中文乱码。</p>

<h1 id="k8s上中文乱码">k8s上中文乱码</h1>

<p>具体问题为：在本地调试Post方法，对于同一接口，<code class="language-plaintext highlighter-rouge">@RequestBody</code>传递中文参数正常，<code class="language-plaintext highlighter-rouge">@RequestParam</code>传递中文参数正常。打包为docker镜像也正常，部署到k8s则出现问题，对于同一接口，<code class="language-plaintext highlighter-rouge">@RequestBody</code>传递中文参数正常，<code class="language-plaintext highlighter-rouge">@RequestParam</code>传递中文参数乱码。</p>

<p>可能原因：某个节点环境不正常。</p>

<p><code class="language-plaintext highlighter-rouge">dockerfile</code>文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CMD java <span class="nv">$J_ARG</span> <span class="nt">-Dfile</span>.encoding<span class="o">=</span>UTF8
</code></pre></div></div>

<p>这里编码应该为<code class="language-plaintext highlighter-rouge">UTF-8</code>。</p>

<p>修改配置文件也可以：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">http</span><span class="pi">:</span>
    <span class="na">encoding</span><span class="pi">:</span>
      <span class="na">charset</span><span class="pi">:</span> <span class="s">UTF-8</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">force</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>]]></content><author><name>acteds</name></author><category term="Java" /><summary type="html"><![CDATA[Java笔记]]></summary></entry><entry><title type="html">多级Map连续设值</title><link href="/2024/11/07/%E5%B5%8C%E5%A5%97Map%E7%9A%84%E5%B9%B3%E9%93%BA%E4%BA%8E%E5%8F%8D%E5%90%91%E6%93%8D%E4%BD%9C/" rel="alternate" type="text/html" title="多级Map连续设值" /><published>2024-11-07T00:00:00+08:00</published><updated>2024-11-07T00:00:00+08:00</updated><id>/2024/11/07/%E5%B5%8C%E5%A5%97Map%E7%9A%84%E5%B9%B3%E9%93%BA%E4%BA%8E%E5%8F%8D%E5%90%91%E6%93%8D%E4%BD%9C</id><content type="html" xml:base="/2024/11/07/%E5%B5%8C%E5%A5%97Map%E7%9A%84%E5%B9%B3%E9%93%BA%E4%BA%8E%E5%8F%8D%E5%90%91%E6%93%8D%E4%BD%9C/"><![CDATA[<h1 id="引言">引言</h1>
<p>将多级Map平铺和反向操作的方法。</p>

<h1 id="map">Map</h1>

<h2 id="flattenmap-方法"><code class="language-plaintext highlighter-rouge">flattenMap</code> 方法</h2>

<p><strong><code class="language-plaintext highlighter-rouge">flattenMap</code></strong>：将一个嵌套的 <code class="language-plaintext highlighter-rouge">Map</code> 转换为平铺的 <code class="language-plaintext highlighter-rouge">Map</code>，每一层的键用 <code class="language-plaintext highlighter-rouge">.</code> 连接，扁平化嵌套结构。</p>

<p><strong>方法定义</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">flattenMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">nestedMap</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>参数</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">nestedMap</code></strong> (<code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>)：一个嵌套的 <code class="language-plaintext highlighter-rouge">Map</code>，其键值可能为更深层次的 <code class="language-plaintext highlighter-rouge">Map</code> 或基本数据类型。</p>

<p><strong>返回值</strong></p>

<p>返回一个平铺的 <code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>，其中嵌套的结构被展开，键名通过 <code class="language-plaintext highlighter-rouge">.</code> 分隔符表示路径。</p>

<p><strong>功能</strong></p>

<p>该方法将嵌套的 <code class="language-plaintext highlighter-rouge">Map</code> 转换为平铺的 <code class="language-plaintext highlighter-rouge">Map</code>，将嵌套对象的键名通过 <code class="language-plaintext highlighter-rouge">.</code> 符号进行连接，生成扁平化的键值对。</p>

<p>例如，<code class="language-plaintext highlighter-rouge">data.testobj.name</code> 嵌套Map会被平铺为 <code class="language-plaintext highlighter-rouge">data.testobj.name</code> 键。</p>

<p><strong>示例</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">nestedMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">testobj</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">testobj</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
<span class="n">testobj</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"3"</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">data</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"count"</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">data</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"testobj"</span><span class="o">,</span> <span class="n">testobj</span><span class="o">);</span>

<span class="n">nestedMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"data"</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
<span class="n">nestedMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"_id"</span><span class="o">,</span> <span class="s">"67089190f180b00a00476c67"</span><span class="o">);</span>
<span class="n">nestedMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"collectionName"</span><span class="o">,</span> <span class="s">"co_common_test1"</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">flatMap</span> <span class="o">=</span> <span class="n">flattenMap</span><span class="o">(</span><span class="n">nestedMap</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>输出</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
    <span class="s">"data.count"</span><span class="o">:</span> <span class="mi">6</span><span class="o">,</span>
    <span class="s">"data.testobj.age"</span><span class="o">:</span> <span class="mi">5</span><span class="o">,</span>
    <span class="s">"data.testobj.name"</span><span class="o">:</span> <span class="s">"3"</span><span class="o">,</span>
    <span class="s">"_id"</span><span class="o">:</span> <span class="s">"67089190f180b00a00476c67"</span><span class="o">,</span>
    <span class="s">"collectionName"</span><span class="o">:</span> <span class="s">"co_common_test1"</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>注意事项</strong></p>

<p>该方法将嵌套的 <code class="language-plaintext highlighter-rouge">Map</code> 结构递归展开，每一层的键名通过 <code class="language-plaintext highlighter-rouge">.</code> 符号进行连接，形成一个平铺的结构。</p>

<p>如果 <code class="language-plaintext highlighter-rouge">nestedMap</code> 中的某个值是非 <code class="language-plaintext highlighter-rouge">Map</code> 类型，则会将该值作为扁平化后的结果。</p>

<h2 id="unflattenmap-方法"><code class="language-plaintext highlighter-rouge">unflattenMap</code> 方法</h2>

<p><strong><code class="language-plaintext highlighter-rouge">unflattenMap</code></strong>：将一个平铺的 <code class="language-plaintext highlighter-rouge">Map</code>（带点的键）转换为嵌套的 <code class="language-plaintext highlighter-rouge">Map</code> 结构，逐级展开。</p>

<p><strong>方法定义</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">unflattenMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">flatMap</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>参数</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">flatMap</code></strong> (<code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>)：一个平铺的 <code class="language-plaintext highlighter-rouge">Map</code>，其键名使用 <code class="language-plaintext highlighter-rouge">.</code> 作为分隔符（例如 <code class="language-plaintext highlighter-rouge">data.count</code>, <code class="language-plaintext highlighter-rouge">data.testobj.name</code>），表示嵌套的结构。</p>

<p><strong>返回值</strong></p>

<p>返回一个嵌套的 <code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>，其中键对应的路径会被还原为嵌套的对象结构。</p>

<p><strong>功能</strong></p>

<p>该方法将一个平铺的 <code class="language-plaintext highlighter-rouge">Map</code> 转换为嵌套的 <code class="language-plaintext highlighter-rouge">Map</code>。平铺的 <code class="language-plaintext highlighter-rouge">Map</code> 中的键名是通过 <code class="language-plaintext highlighter-rouge">.</code> 分隔符表示的路径。该方法会根据路径拆分并逐层构建嵌套的 <code class="language-plaintext highlighter-rouge">Map</code> 结构。</p>

<p>例如，<code class="language-plaintext highlighter-rouge">data.testobj.name</code> 会被展开为 <code class="language-plaintext highlighter-rouge">Map</code> 结构：<code class="language-plaintext highlighter-rouge">data -&gt; testobj -&gt; name</code>。</p>

<p><strong>示例</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">flatMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">flatMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"data.count"</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span>
<span class="n">flatMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"data.testobj.age"</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
<span class="n">flatMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"_id"</span><span class="o">,</span> <span class="s">"67089190f180b00a00476c67"</span><span class="o">);</span>
<span class="n">flatMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"collectionName"</span><span class="o">,</span> <span class="s">"co_common_test1"</span><span class="o">);</span>
<span class="n">flatMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"data.testobj.name"</span><span class="o">,</span> <span class="s">"3"</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">nestedMap</span> <span class="o">=</span> <span class="n">unflattenMap</span><span class="o">(</span><span class="n">flatMap</span><span class="o">);</span>
</code></pre></div></div>
<p><strong>输出</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
    <span class="s">"data"</span><span class="o">:</span> <span class="o">{</span>
        <span class="s">"count"</span><span class="o">:</span> <span class="mi">6</span><span class="o">,</span>
        <span class="s">"testobj"</span><span class="o">:</span> <span class="o">{</span>
            <span class="s">"age"</span><span class="o">:</span> <span class="mi">5</span><span class="o">,</span>
            <span class="s">"name"</span><span class="o">:</span> <span class="s">"3"</span>
        <span class="o">}</span>
    <span class="o">},</span>
    <span class="s">"_id"</span><span class="o">:</span> <span class="s">"67089190f180b00a00476c67"</span><span class="o">,</span>
    <span class="s">"collectionName"</span><span class="o">:</span> <span class="s">"co_common_test1"</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>注意事项</strong></p>

<p>该方法假设所有带点路径的键都需要进行解包，逐级生成嵌套 <code class="language-plaintext highlighter-rouge">Map</code>。</p>

<p>如果 <code class="language-plaintext highlighter-rouge">flatMap</code> 中某个路径已经存在嵌套结构，则该路径的值将被复写为新的值。</p>

<p>这两个方法可以方便地在平铺和嵌套 <code class="language-plaintext highlighter-rouge">Map</code> 之间转换，使得对复杂结构的数据操作更加简便。</p>]]></content><author><name>acteds</name></author><category term="Java" /><summary type="html"><![CDATA[Java笔记]]></summary></entry><entry><title type="html">多级Map连续设值</title><link href="/2024/11/06/%E5%A4%9A%E7%BA%A7Map%E8%BF%9E%E7%BB%AD%E8%AE%BE%E5%80%BC/" rel="alternate" type="text/html" title="多级Map连续设值" /><published>2024-11-06T00:00:00+08:00</published><updated>2024-11-06T00:00:00+08:00</updated><id>/2024/11/06/%E5%A4%9A%E7%BA%A7Map%E8%BF%9E%E7%BB%AD%E8%AE%BE%E5%80%BC</id><content type="html" xml:base="/2024/11/06/%E5%A4%9A%E7%BA%A7Map%E8%BF%9E%E7%BB%AD%E8%AE%BE%E5%80%BC/"><![CDATA[<h1 id="引言">引言</h1>
<p>一个简单的，连续设置Map值的方法。</p>

<h1 id="map">Map</h1>

<h2 id="多级map连续设值">多级Map连续设值</h2>

<p>方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/**
 * 通过路径连续设置值，分隔符为.号
 * @param map 键值对
 * @param path 路径
 * @param value 设置的值
 * @param &lt;T&gt; 值类型
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">setValueByPath</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">,</span> <span class="nc">String</span> <span class="n">path</span><span class="o">,</span> <span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">path</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"路径不能为空"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">String</span><span class="o">[]</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\."</span><span class="o">);</span>
    <span class="nc">Object</span> <span class="n">current</span> <span class="o">=</span> <span class="n">map</span><span class="o">;</span>

    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">keys</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">currentMap</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">current</span><span class="o">;</span>
            <span class="c1">// 如果当前Map中没有该key，创建一个新的Map</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">currentMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">currentMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;());</span>
            <span class="o">}</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">currentMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"路径中的某个节点不是Map类型，路径: "</span> <span class="o">+</span> <span class="n">path</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 最后一个key，设置值</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">currentMap</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">current</span><span class="o">;</span>
        <span class="n">currentMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">keys</span><span class="o">[</span><span class="n">keys</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">],</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"设置值时出错，路径指向的目标不是Map类型，路径: "</span> <span class="o">+</span> <span class="n">path</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

<span class="c1">// 测试路径设置</span>
<span class="n">setValueByPath</span><span class="o">(</span><span class="n">map</span><span class="o">,</span> <span class="s">"data.count"</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
<span class="n">setValueByPath</span><span class="o">(</span><span class="n">map</span><span class="o">,</span> <span class="s">"data.count.details.value"</span><span class="o">,</span> <span class="mi">200</span><span class="o">);</span>

<span class="c1">// 打印结果</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
</code></pre></div></div>]]></content><author><name>acteds</name></author><category term="Java" /><summary type="html"><![CDATA[Java笔记]]></summary></entry><entry><title type="html">MongoDB分组聚合解析器</title><link href="/2024/11/04/MongoDB%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88%E8%A7%A3%E6%9E%90%E5%99%A8/" rel="alternate" type="text/html" title="MongoDB分组聚合解析器" /><published>2024-11-04T00:00:00+08:00</published><updated>2024-11-04T00:00:00+08:00</updated><id>/2024/11/04/MongoDB%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88%E8%A7%A3%E6%9E%90%E5%99%A8</id><content type="html" xml:base="/2024/11/04/MongoDB%E5%88%86%E7%BB%84%E8%81%9A%E5%90%88%E8%A7%A3%E6%9E%90%E5%99%A8/"><![CDATA[<h1 id="引言">引言</h1>
<p>一个对MongoDB分组聚合操作的简单封装类。</p>

<h1 id="mongodb">MongoDB</h1>

<h2 id="mongodb分组聚合解析器">MongoDB分组聚合解析器</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 分组聚合解析器
 * @author aotmd
 * @version 1.1
 * @date 2024/10/30 10:34
 */</span>
<span class="kd">private</span> <span class="kd">class</span> <span class="nc">GroupAggregationGenerator</span><span class="o">{</span>
    <span class="cm">/**字段转换后加的后缀*/</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TO_DECIMAL</span> <span class="o">=</span> <span class="s">"ToDecimal"</span><span class="o">;</span>
    <span class="cm">/**实际主键名称*/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PRIMARY_KEY</span> <span class="o">=</span> <span class="s">"_id"</span><span class="o">;</span>

    <span class="cm">/**
     * 生成分组聚合操作
     * @param groupBy 分组字段
     * @param aggregations 聚合设置
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AggregationOperation</span><span class="o">&gt;</span> <span class="nf">buildAggregationOperations</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">groupBy</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CommonFormParam</span><span class="o">.</span><span class="na">AggregationField</span><span class="o">&gt;</span> <span class="n">aggregations</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 判断是否为空,分组字段和聚合字段都为空，则直接返回</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">aggregations</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">aggregations</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">groupBy</span><span class="o">==</span><span class="kc">null</span> <span class="o">||</span> <span class="n">groupBy</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="o">}</span>
        <span class="c1">// 分组字段空串检测</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">groupBy</span><span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"分组字段为空"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">aggregations</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"聚合设置为空"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">boolean</span> <span class="n">b</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">groupBy</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">anyMatch</span><span class="o">(</span><span class="nl">StringUtil:</span><span class="o">:</span><span class="n">isBlank</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">b</span><span class="o">){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"分组字段出现空串"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 字段检测</span>
        <span class="n">aggregations</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nc">CommonFormParam</span><span class="o">.</span><span class="na">AggregationField</span><span class="o">::</span><span class="n">fieldChecks</span><span class="o">);</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AggregationOperation</span><span class="o">&gt;</span> <span class="n">operations</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="c1">// 处理类型转换，使用投影操作进行转换</span>
        <span class="c1">// 不重复转换</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">processedFields</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="nc">ProjectionOperation</span> <span class="n">project</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">CommonFormParam</span><span class="o">.</span><span class="na">AggregationField</span> <span class="n">agg</span> <span class="o">:</span> <span class="n">aggregations</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 处理类型转换，如果需要转换为Decimal</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">processedFields</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">getField</span><span class="o">())){</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">isConvertToDecimal</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">project</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">and</span><span class="o">(</span>
                            <span class="nc">ConvertOperators</span><span class="o">.</span><span class="na">Convert</span><span class="o">.</span><span class="na">convertValueOf</span><span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">getField</span><span class="o">())</span>
                                    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">"decimal"</span><span class="o">)</span>
                                    <span class="o">.</span><span class="na">onErrorReturn</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                                    <span class="o">.</span><span class="na">onNullReturn</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
                    <span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">getField</span><span class="o">()</span> <span class="o">+</span> <span class="no">TO_DECIMAL</span><span class="o">);</span>
                    <span class="n">processedFields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">getField</span><span class="o">());</span>
                <span class="o">}</span>
                <span class="c1">// 将原列也保留</span>
                <span class="n">project</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">getField</span><span class="o">()).</span><span class="na">as</span><span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">getField</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">groupBy</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 将分组字段也保留</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// 有转换才加入</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">processedFields</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">operations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">project</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 分组操作</span>
        <span class="nc">GroupOperation</span> <span class="n">group</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">groupBy</span><span class="o">);</span>

        <span class="c1">// 添加聚合操作</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">CommonFormParam</span><span class="o">.</span><span class="na">AggregationField</span> <span class="n">agg</span> <span class="o">:</span> <span class="n">aggregations</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">field</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="na">getField</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">isConvertToDecimal</span><span class="o">()){</span>
                <span class="n">field</span> <span class="o">+=</span> <span class="no">TO_DECIMAL</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">String</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="na">getAlias</span><span class="o">();</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">agg</span><span class="o">.</span><span class="na">getType</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">case</span> <span class="s">"sum"</span><span class="o">:</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="n">field</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="n">alias</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="s">"avg"</span><span class="o">:</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="na">avg</span><span class="o">(</span><span class="n">field</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="n">alias</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="s">"count"</span><span class="o">:</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="na">count</span><span class="o">().</span><span class="na">as</span><span class="o">(</span><span class="n">alias</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="s">"max"</span><span class="o">:</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">field</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="n">alias</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="s">"min"</span><span class="o">:</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">field</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="n">alias</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"不支持的聚合类型： "</span> <span class="o">+</span> <span class="n">agg</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">operations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">group</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">operations</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 聚合结果处理方法，将聚合结果处理为符合人类直觉的方式。
     * @param result 聚合结果
     * @param groupBy 分组依据
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">aggregateResultProcessing</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">,</span><span class="nc">String</span><span class="o">[]</span> <span class="n">groupBy</span><span class="o">){</span>
        <span class="n">result</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">map</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// mango特色：如果没有分组字段，则返回数据多出一个字段_id=null,</span>
            <span class="c1">// 如果有一个分组字段，比如sex，则_id=sex字段的值，比如_id="男"，_id="女"</span>
            <span class="c1">// 如果有两个以上的分组，比如age、sex，则就正常了，就是age=age的值，sex=sex的值。</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">groupBy</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span>
                <span class="n">map</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="no">PRIMARY_KEY</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">groupBy</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">1</span><span class="o">){</span>
                <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">groupBy</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                <span class="c1">// 如果是主键，则不处理</span>
                <span class="k">if</span> <span class="o">(</span><span class="no">PRIMARY_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">s</span><span class="o">)){</span><span class="k">return</span><span class="o">;}</span>
                <span class="c1">// 去掉前缀</span>
                <span class="nc">String</span> <span class="n">s0</span><span class="o">=</span><span class="n">removeKeyPrefix</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">s0</span><span class="o">,</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">PRIMARY_KEY</span><span class="o">));</span>
                <span class="n">map</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="no">PRIMARY_KEY</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 环绕方法，先生成分组聚合操作，然后执行后function得到结果，然后人性化处理结果。
     * @param groupBy 分组依据
     * @param aggregations 聚合设置
     * @param function 执行方法
     * @return 处理后的结果
     */</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="nf">wrappingMethod</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">groupBy</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CommonFormParam</span><span class="o">.</span><span class="na">AggregationField</span><span class="o">&gt;</span> <span class="n">aggregations</span><span class="o">,</span><span class="nc">Function</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">AggregationOperation</span><span class="o">&gt;,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;&gt;</span> <span class="n">function</span><span class="o">){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AggregationOperation</span><span class="o">&gt;</span> <span class="n">aggregationOperationList</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">buildAggregationOperations</span><span class="o">(</span><span class="n">groupBy</span><span class="o">,</span> <span class="n">aggregations</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">apply</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">aggregationOperationList</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">aggregateResultProcessing</span><span class="o">(</span><span class="n">apply</span><span class="o">,</span><span class="n">groupBy</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">apply</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>入参：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**聚合设置*/</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AggregationField</span> <span class="o">{</span>
    <span class="cm">/**要聚合的字段*/</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">field</span><span class="o">;</span>
    <span class="cm">/**聚合类型（如 sum, avg 等）*/</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">type</span><span class="o">;</span>
    <span class="cm">/**聚合结果列的别名*/</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">alias</span><span class="o">;</span>
    <span class="cm">/**可选，默认为否，是否在聚合前需要进行 decimal 转换*/</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">convertToDecimal</span><span class="o">=</span><span class="kc">false</span><span class="o">;</span>

    <span class="cm">/**
     * 字段校验
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fieldChecks</span><span class="o">(){</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">field</span><span class="o">)||</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">type</span><span class="o">)||</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">alias</span><span class="o">)){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"聚合字段设置不全，必须包含字段：field、type、alias"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GroupAggregationGenerator</span> <span class="n">groupAggregationGenerator</span><span class="o">=</span> <span class="k">new</span> <span class="nc">GroupAggregationGenerator</span><span class="o">();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">maps</span> <span class="o">=</span> <span class="n">groupAggregationGenerator</span><span class="o">.</span><span class="na">wrappingMethod</span><span class="o">(</span><span class="n">groupBy</span><span class="o">,</span> <span class="n">aggregations</span><span class="o">,</span> <span class="n">aggregationOperationList</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AggregationOperation</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">=</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">criteria</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Aggregation</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">criteria</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">list</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">aggregationOperationList</span><span class="o">);</span>
    <span class="c1">// 创建聚合对象</span>
    <span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>

    <span class="c1">// 执行聚合查询</span>
    <span class="nc">AggregationResults</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">aggregation</span><span class="o">,</span> <span class="n">collectionName</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// 获取并输出投影结果</span>
    <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="na">getMappedResults</span><span class="o">();</span>
<span class="o">});</span>
</code></pre></div></div>

<p>其中，mongoTemplate还能封装一下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * mongo服务层
 * @author aotmd
 * @version 1.0
 * @date 2024/10/22 14:07
 */</span>
<span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MongoService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">MongoTemplate</span> <span class="n">mongoTemplate</span><span class="o">;</span>

    <span class="cm">/**
     * 高级查询，泛型方法
     *
     * @param &lt;T&gt;                  泛型
     * @param collectionName       表名
     * @param valueType            返回值Class
     * @param criteria             查询条件
     * @param aggregationOperationList 集合参数，聚合用
     * @return List
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">aggregate</span><span class="o">(</span><span class="nc">String</span> <span class="n">collectionName</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">valueType</span><span class="o">,</span> <span class="nc">Criteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AggregationOperation</span><span class="o">&gt;</span>  <span class="n">aggregationOperationList</span><span class="o">){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">AggregationOperation</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">=</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">criteria</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Aggregation</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">criteria</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">list</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">aggregationOperationList</span><span class="o">);</span>
        <span class="c1">// 创建聚合对象</span>
        <span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>

        <span class="c1">// 执行聚合查询</span>
        <span class="nc">AggregationResults</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">aggregation</span><span class="o">,</span> <span class="n">collectionName</span><span class="o">,</span> <span class="n">valueType</span><span class="o">);</span>

        <span class="c1">// 获取并输出投影结果</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="na">getMappedResults</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 高级查询，泛型方法
     *
     * @param &lt;T&gt;                  泛型
     * @param collectionName       表名
     * @param valueType            返回值Class
     * @param criteria             查询条件
     * @param aggregationOperation 可变参数，聚合用
     * @return List
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">aggregate</span><span class="o">(</span><span class="nc">String</span> <span class="n">collectionName</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">valueType</span><span class="o">,</span> <span class="nc">Criteria</span> <span class="n">criteria</span><span class="o">,</span> <span class="nc">AggregationOperation</span> <span class="o">...</span> <span class="n">aggregationOperation</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">collectionName</span><span class="o">,</span> <span class="n">valueType</span><span class="o">,</span> <span class="n">criteria</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">aggregationOperation</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>简化为：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GroupAggregationGenerator</span> <span class="n">groupAggregationGenerator</span><span class="o">=</span> <span class="k">new</span> <span class="nc">GroupAggregationGenerator</span><span class="o">();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">maps</span> <span class="o">=</span> <span class="n">groupAggregationGenerator</span><span class="o">.</span><span class="na">wrappingMethod</span><span class="o">(</span><span class="n">groupBy</span><span class="o">,</span> <span class="n">aggregations</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">mongoService</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">collectionName</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">criteria</span><span class="o">,</span> <span class="n">a</span><span class="o">));</span>
</code></pre></div></div>

<p>特别注意：</p>

<p><strong><code class="language-plaintext highlighter-rouge">Decimal128</code> 最多只能表示 34 位有效数字（整数部分与小数部分合计）。如果超出这个范围，会导致精度丢失或舍入错误。</strong></p>

<p>对于聚合结果<code class="language-plaintext highlighter-rouge">Decimal128</code>类型，一般来说都是通过转换为字符串返回，此时可以对数值进行判断，如果超过了34位数字，<code class="language-plaintext highlighter-rouge">Decimal128</code>类型的值会变为科学计数法，实际上会从最后一位开始舍去，若已经舍去到整数位了，那么直接填0，形成类似：<code class="language-plaintext highlighter-rouge">12345678901234567890123456789012340000000000000000</code>，这样的数值。</p>

<p>应对方法为：可以在结果出来后，进行转换与精度判断：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 转换</span>
<span class="n">systemFormData</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span>
    <span class="n">item</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">//! Decimal128 最多只能表示 34 位有效数字。如果超出这个范围，可能会导致精度丢失或舍入错误。</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">Decimal128</span><span class="o">){</span>
            <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">convertDecimal128ToString</span><span class="o">((</span><span class="nc">Decimal128</span><span class="o">)</span> <span class="n">value</span><span class="o">);</span>
            <span class="n">item</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">})</span>
<span class="o">);</span>
</code></pre></div></div>

<p>方法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Decimal128转换为字符串
 * @param decimal128 待转换数据
 * @return
 */</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="nf">convertDecimal128ToString</span><span class="o">(</span><span class="nc">Decimal128</span> <span class="n">decimal128</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isDecimal128Overflow</span><span class="o">(</span><span class="n">decimal128</span><span class="o">)){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Decimal128精度丢失"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">decimal128</span><span class="o">.</span><span class="na">bigDecimalValue</span><span class="o">().</span><span class="na">toPlainString</span><span class="o">();</span>
<span class="o">}</span>
<span class="cm">/**
 * decimal128溢出判断
 * @param decimal128 mongo数据类型
 * @return
 */</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isDecimal128Overflow</span><span class="o">(</span><span class="nc">Decimal128</span> <span class="n">decimal128</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">BigDecimal</span> <span class="n">bigDecimalValue</span> <span class="o">=</span> <span class="n">decimal128</span><span class="o">.</span><span class="na">bigDecimalValue</span><span class="o">();</span>

    <span class="c1">// 定义 Decimal128 的范围</span>
    <span class="nc">BigDecimal</span> <span class="n">lowerBound</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"-1.0E+34"</span><span class="o">);</span>
    <span class="nc">BigDecimal</span> <span class="n">upperBound</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">"1.0E+34"</span><span class="o">);</span>
    <span class="c1">// 判断是否溢出</span>
    <span class="k">return</span> <span class="n">bigDecimalValue</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">lowerBound</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bigDecimalValue</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">upperBound</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="分组和聚合设置文档">分组和聚合设置文档</h3>

<p><strong><code class="language-plaintext highlighter-rouge">groupBy</code></strong></p>

<ul>
  <li><strong>类型</strong>: 数组 (<code class="language-plaintext highlighter-rouge">Array</code>)</li>
  <li><strong>描述</strong>: 分组依据，可以为空数组 (<code class="language-plaintext highlighter-rouge">[]</code>) 表示不进行分组，也可以包含多个字段名进行多字段分组。
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"groupBy"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"job"</span><span class="p">]</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">按照岗位进行分组</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">aggregations</code></strong></p>

<ul>
  <li>
    <p><strong>类型</strong>: 数组 (<code class="language-plaintext highlighter-rouge">Array</code>)</p>
  </li>
  <li>
    <p><strong>描述</strong>: 聚合设置，可以为空数组 (<code class="language-plaintext highlighter-rouge">[]</code>) 表示不进行任何聚合。每个聚合对象包含聚合字段、聚合类型和别名等信息。</p>
  </li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"aggregations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salary"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">聚合字段列名</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sum"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">聚合类型：sum、avg、min、max、count</span><span class="w">
      </span><span class="nl">"alias"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salarySum"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">聚合结果列名</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salary"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"avg"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"alias"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salaryAvg"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"convertToDecimal"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">表示需要进行</span><span class="w"> </span><span class="err">decimal</span><span class="w"> </span><span class="err">转换，返回结果也为</span><span class="w"> </span><span class="err">Decimal</span><span class="w"> </span><span class="err">类型，因此为字符串</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salary"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"count"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"alias"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salaryCount"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">聚合结果列名</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salary"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"max"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"alias"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salaryMax"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">聚合结果列名</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salary"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"min"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"alias"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salaryMin"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">聚合结果列名</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p><strong>聚合对象字段说明</strong></p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">field</code></strong>:
    <ul>
      <li><strong>类型</strong>: 字符串 (<code class="language-plaintext highlighter-rouge">String</code>)</li>
      <li><strong>描述</strong>: 需要进行聚合的字段名。</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">type</code></strong>:
    <ul>
      <li><strong>类型</strong>: 字符串 (<code class="language-plaintext highlighter-rouge">String</code>)</li>
      <li><strong>描述</strong>: 指定聚合操作的类型，可以是以下之一：
        <ul>
          <li><code class="language-plaintext highlighter-rouge">sum</code>：计算字段值的总和。</li>
          <li><code class="language-plaintext highlighter-rouge">avg</code>：计算字段值的平均值。</li>
          <li><code class="language-plaintext highlighter-rouge">min</code>：获取字段值的最小值。</li>
          <li><code class="language-plaintext highlighter-rouge">max</code>：获取字段值的最大值。</li>
          <li><code class="language-plaintext highlighter-rouge">count</code>：计算字段的数量。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">alias</code></strong>:
    <ul>
      <li><strong>类型</strong>: 字符串 (<code class="language-plaintext highlighter-rouge">String</code>)</li>
      <li><strong>描述</strong>: 聚合结果的别名，用于在结果集中引用聚合值。</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">convertToDecimal</code></strong> (可选):
    <ul>
      <li><strong>类型</strong>: 布尔 (<code class="language-plaintext highlighter-rouge">Boolean</code>)</li>
      <li><strong>描述</strong>: 指定是否需要将聚合结果转换为 Decimal 类型。设置为 <code class="language-plaintext highlighter-rouge">true</code> 时，返回的结果将为 Decimal 类型，以字符串形式表示。</li>
    </ul>
  </li>
</ul>

<p>在执行聚合查询时，可以根据 <code class="language-plaintext highlighter-rouge">groupBy</code> 和 <code class="language-plaintext highlighter-rouge">aggregations</code> 字段的配置进行数据分组和聚合，生成所需的统计结果。此配置允许灵活处理多种聚合需求，适应不同的业务场景。</p>]]></content><author><name>acteds</name></author><category term="Java" /><category term="MongoDB" /><summary type="html"><![CDATA[Java笔记]]></summary></entry><entry><title type="html">MongoDB排序解析方法</title><link href="/2024/11/04/MongoDB%E6%8E%92%E5%BA%8F%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95/" rel="alternate" type="text/html" title="MongoDB排序解析方法" /><published>2024-11-04T00:00:00+08:00</published><updated>2024-11-04T00:00:00+08:00</updated><id>/2024/11/04/MongoDB%E6%8E%92%E5%BA%8F%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95</id><content type="html" xml:base="/2024/11/04/MongoDB%E6%8E%92%E5%BA%8F%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95/"><![CDATA[<h1 id="引言">引言</h1>
<p>一个对MongoDB排序操作的简单封装方法。</p>

<h1 id="mongodb">MongoDB</h1>

<h2 id="mongodb排序方法解析方法">MongoDB排序方法解析方法</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 排序设置解析并应用
 * @param query 条件构建对象
 * @param sortFields 排序设置
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">applySorting</span><span class="o">(</span><span class="nc">Query</span> <span class="n">query</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">CommonFormParam</span><span class="o">.</span><span class="na">SortField</span><span class="o">&gt;</span> <span class="n">sortFields</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 检查排序字段并构建排序对象</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sortFields</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sortFields</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">seenFields</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">CommonFormParam</span><span class="o">.</span><span class="na">SortField</span> <span class="n">sortField</span> <span class="o">:</span> <span class="n">sortFields</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 验证排序字段</span>
            <span class="n">sortField</span><span class="o">.</span><span class="na">sortChecks</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">fieldName</span> <span class="o">=</span> <span class="n">sortField</span><span class="o">.</span><span class="na">getField</span><span class="o">();</span>

            <span class="c1">// 检查重复字段</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">seenFields</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">fieldName</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"重复的排序字段: "</span> <span class="o">+</span> <span class="n">removeKeyPrefix</span><span class="o">(</span><span class="n">fieldName</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">seenFields</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fieldName</span><span class="o">);</span>

            <span class="c1">// 根据排序类型添加排序条件</span>
            <span class="n">orders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sortField</span><span class="o">.</span><span class="na">isSortType</span><span class="o">()</span> <span class="o">?</span>
                    <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="n">fieldName</span><span class="o">)</span> <span class="o">:</span>
                    <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="n">fieldName</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">// 应用排序到查询中</span>
        <span class="n">query</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="n">orders</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>入参：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 排序设置
 */</span>
<span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SortField</span> <span class="o">{</span>
    <span class="cm">/**排序字段*/</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">field</span><span class="o">;</span>
    <span class="cm">/**true 为顺序，false为倒序,默认顺序*/</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">sortType</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sortChecks</span><span class="o">(){</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">field</span><span class="o">)){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"排序字段设置不全，必须包含字段：field"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>字段详细说明</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">field</code></strong> (String)：表示需要排序的字段名称。</p>

<p>示例：<code class="language-plaintext highlighter-rouge">"status"</code>、<code class="language-plaintext highlighter-rouge">"salary"</code>。</p>

<p><strong><code class="language-plaintext highlighter-rouge">sortType</code></strong> (Boolean)：指定排序方式。</p>

<p><code class="language-plaintext highlighter-rouge">true</code> 表示升序排序（从小到大）。</p>

<p><code class="language-plaintext highlighter-rouge">false</code> 表示降序排序（从大到小）。</p>

<p>示例：<code class="language-plaintext highlighter-rouge">true</code> 表示按照 <code class="language-plaintext highlighter-rouge">field</code> 升序排序，<code class="language-plaintext highlighter-rouge">false</code> 表示降序排序。</p>

<p><strong>排序逻辑</strong></p>

<ul>
  <li><strong>主要排序关键字</strong>：<code class="language-plaintext highlighter-rouge">sortFields</code> 数组的第一个对象表示主要排序关键字，MongoDB 将首先根据这个字段对结果进行排序。</li>
  <li><strong>次要排序关键字</strong>：如果主要排序关键字存在相同值，MongoDB 将继续根据下一个对象中的字段进行排序。</li>
  <li>
    <p><strong>示例排序顺序</strong>：给定以下示例设置：</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"sortFields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"status"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"sortType"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"salary"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"sortType"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div>    </div>

    <p>结果集将首先按 <code class="language-plaintext highlighter-rouge">status</code> 字段升序排列，对于具有相同 <code class="language-plaintext highlighter-rouge">status</code> 值的记录，将按 <code class="language-plaintext highlighter-rouge">salary</code> 字段降序排列。</p>
  </li>
</ul>]]></content><author><name>acteds</name></author><category term="Java" /><category term="MongoDB" /><summary type="html"><![CDATA[Java笔记]]></summary></entry><entry><title type="html">ADB相关知识</title><link href="/2024/10/31/ADB%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/" rel="alternate" type="text/html" title="ADB相关知识" /><published>2024-10-31T00:00:00+08:00</published><updated>2024-10-31T00:00:00+08:00</updated><id>/2024/10/31/ADB%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86</id><content type="html" xml:base="/2024/10/31/ADB%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/"><![CDATA[<h1 id="引言">引言</h1>
<p>ADB（Android Debug Bridge）是一个命令行工具，用于与 Android 设备进行交互和管理。它是 Android SDK 的一部分，主要用于开发和调试 Android 应用程序。</p>

<h1 id="adb">ADB</h1>

<p>ADB 提供了一个通用的命令接口，可以通过 USB 或 Wi-Fi 连接 Android 设备，允许开发者执行多种操作，包括：</p>

<ol>
  <li><strong>安装和卸载应用</strong>：可以通过命令行在设备上安装或卸载 APK 文件。</li>
  <li><strong>设备管理</strong>：能够列出已连接的设备，检查设备状态，重启设备等。</li>
  <li><strong>调试应用</strong>：开发者可以通过 ADB 向 Android 设备发送调试命令，查看日志（使用 <code class="language-plaintext highlighter-rouge">logcat</code>），捕获屏幕截图等。</li>
  <li><strong>文件传输</strong>：可以通过 ADB 在电脑和 Android 设备之间传输文件。</li>
  <li><strong>运行 shell 命令</strong>：可以直接在设备上执行 shell 命令，以进行更深入的管理。</li>
</ol>

<p>ADB 的基本使用示例：</p>

<p><strong>列出连接的设备</strong>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb devices
</code></pre></div></div>

<p><strong>安装应用</strong>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb <span class="nb">install </span>path/to/app.apk
</code></pre></div></div>

<p><strong>卸载应用</strong>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb uninstall package.name
</code></pre></div></div>

<p><strong>查看设备日志</strong>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb logcat
</code></pre></div></div>

<p><strong>进入设备的 shell</strong>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb shell
</code></pre></div></div>

<p><strong>工作原理：</strong></p>

<p>ADB 通过 TCP/IP 协议与 Android 设备通信。它通常在本地机器和 Android 设备之间建立一个客户端-服务器架构，其中 ADB 服务器在主机上运行，而 ADB 客户端在命令行中运行，Android 设备则充当服务器端。</p>

<h2 id="adb服务器">ADB服务器</h2>

<p>ADB 服务器（ADB Server）是 Android Debug Bridge（ADB）中的一个关键组件，用于管理与 Android 设备之间的通信。它作为一个后台进程在主机上运行，负责协调 ADB 客户端和连接的 Android 设备。以下是 ADB 服务器的主要功能和特点：</p>

<ol>
  <li>
    <p><strong>设备管理</strong>：ADB 服务器维护已连接设备的状态信息，包括设备 ID、状态（如在线或离线）等。当通过 ADB 客户端发出命令时，ADB 服务器会判断当前连接的设备并执行相应操作。</p>
  </li>
  <li>
    <p><strong>命令转发</strong>：当开发者在命令行中使用 ADB 命令时，这些命令首先被发送到 ADB 服务器。ADB 服务器会将这些命令转发到相应的 Android 设备，并将结果返回给客户端。</p>
  </li>
  <li>
    <p><strong>多设备支持</strong>：<strong>ADB 服务器允许同时与多个 Android 设备进行通信</strong>。开发者可以通过不同的设备 ID 来区分不同的设备。</p>
  </li>
  <li>
    <p><strong>简化连接</strong>：ADB 服务器管理与设备之间的 TCP/IP 连接，简化了开发者的连接流程。当开发者首次连接设备时，ADB 服务器会自动启动并进行设备发现。</p>
  </li>
</ol>

<p><strong>工作原理</strong></p>

<ul>
  <li><strong>启动过程</strong>：当运行任何 ADB 命令时，ADB 客户端会首先检查 ADB 服务器是否在运行。如果未运行，ADB 客户端会启动 ADB 服务器。</li>
  <li><strong>端口</strong>：默认情况下，ADB 服务器在 5037 端口上监听请求。可以通过 <code class="language-plaintext highlighter-rouge">adb -P &lt;port&gt;</code> 命令指定其他端口。</li>
  <li><strong>连接方式</strong>：ADB 可以通过 USB 连接设备，也可以通过 Wi-Fi 连接。当设备通过 USB 连接时，ADB 服务器会在设备上启用调试模式，以便进行操作。</li>
</ul>

<p><strong>常见命令</strong></p>

<p><strong>启动 ADB 服务器</strong>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb start-server
</code></pre></div></div>

<p><strong>停止 ADB 服务器</strong>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb kill-server
</code></pre></div></div>

<p><strong>查看已连接设备</strong>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adb devices
</code></pre></div></div>

<p>ADB 服务器是开发和调试 Android 应用不可或缺的组件，它通过提供统一的接口简化了与设备的交互，帮助开发者高效地进行应用测试和管理。</p>

<p><strong>重要事项</strong></p>

<ol>
  <li><strong>单一端口</strong>：同一时间内，ADB 服务器只能绑定到一个端口。如果尝试在<strong>同一端口</strong>上启动多个 ADB 实例，将导致冲突并出现错误。</li>
  <li><strong>更改端口</strong>：如果你需要在多个实例之间切换，可以使用不同的端口。例如，你可以使用 <code class="language-plaintext highlighter-rouge">adb -L tcp:12345 fork-server server --reply-fd 688</code> 启动另一个 ADB 实例在端口 12345 上运行。</li>
  <li><strong>服务器状态</strong>：如果需要重新启动 ADB 服务器，建议先停止现有的 ADB 实例，以避免端口占用冲突。可以使用 <code class="language-plaintext highlighter-rouge">adb kill-server</code> 命令来停止当前的 ADB 服务器。</li>
</ol>

<p><strong>一个安卓设备只能与一个 ADB 服务器建立连接。</strong>即使在不同的端口上启动多个 ADB 服务器，它们仍然无法同时连接到同一个设备。以下是一些相关细节：</p>

<p><strong>原因</strong></p>

<ol>
  <li><strong>端口和通信</strong>：ADB 服务器通过 TCP/IP 协议与安卓设备通信，通常使用端口 5037。每个设备在同一时间只能被一个 ADB 服务器控制。</li>
  <li><strong>设备状态</strong>：当一个 ADB 服务器连接到设备时，该设备的状态会被标记为 “device”。其他尝试连接的 ADB 服务器将收到设备 “offline” 或 “unauthorized” 的状态，因为设备已经与现有的 ADB 服务器建立了连接。</li>
</ol>

<p><strong>解决方案</strong></p>

<ul>
  <li><strong>ADB 代理</strong>：如果需要在多个环境中使用 ADB，可以考虑使用 ADB 代理来转发命令，但这会增加复杂性。</li>
  <li><strong>连接管理</strong>：确保在启动新的 ADB 服务器之前，先通过 <code class="language-plaintext highlighter-rouge">adb kill-server</code> 停止当前的 ADB 服务器连接，确保只有一个 ADB 实例在与设备通信。</li>
</ul>

<p>每次只允许一个 ADB 服务器与安卓设备建立连接，尝试同时连接多个 ADB 服务器将会导致连接冲突，无法正常工作。</p>]]></content><author><name>acteds</name></author><category term="Android" /><summary type="html"><![CDATA[安卓笔记]]></summary></entry><entry><title type="html">Map过滤器</title><link href="/2024/10/28/Map%E8%BF%87%E6%BB%A4%E5%99%A8/" rel="alternate" type="text/html" title="Map过滤器" /><published>2024-10-28T00:00:00+08:00</published><updated>2024-10-28T00:00:00+08:00</updated><id>/2024/10/28/Map%E8%BF%87%E6%BB%A4%E5%99%A8</id><content type="html" xml:base="/2024/10/28/Map%E8%BF%87%E6%BB%A4%E5%99%A8/"><![CDATA[<h1 id="引言">引言</h1>
<p>一个过滤Map键的类，包括包含字段和排除字段，类似于<code class="language-plaintext highlighter-rouge">mongoTemplate</code>的字段过滤。</p>

<h1 id="map">Map</h1>

<h2 id="map过滤器">Map过滤器</h2>

<p>过滤器：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 结果过滤器
 * @author aotmd
 * @version 1.0
 * @date 2024/10/25 15:34
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FieldFilter</span> <span class="o">{</span>
    <span class="cm">/**实际主键名称*/</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PRIMARY_KEY</span> <span class="o">=</span> <span class="s">"_id"</span><span class="o">;</span>

    <span class="cm">/**
     * 过滤单条数据的指定字段。
     *
     * @param originalData 原始数据
     * @param include      要包含的字段数组
     * @param exclude      要排除的字段数组
     * @return 过滤后的数据
     */</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">filterFields</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">originalData</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">include</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">exclude</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果没有原始数据则直接返回</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">originalData</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">originalData</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">originalData</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 如果include和exclude都没有，则直接返回</span>
        <span class="k">if</span><span class="o">((</span><span class="n">include</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">include</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">exclude</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">exclude</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)){</span>
            <span class="k">return</span> <span class="n">originalData</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 校验 include 和 exclude 的逻辑，一般不能同时存在</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">include</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">include</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">exclude</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">exclude</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 仅允许 exclude 中包含 "_id"</span>
            <span class="k">if</span> <span class="o">(!(</span><span class="n">exclude</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="no">PRIMARY_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">exclude</span><span class="o">[</span><span class="mi">0</span><span class="o">])))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"不能同时使用 include 和 exclude(排除_id例外)。"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">filteredData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="c1">// 处理 include 逻辑</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">include</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">include</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 默认添加_id字段</span>
            <span class="n">filteredData</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="no">PRIMARY_KEY</span><span class="o">,</span><span class="n">originalData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">PRIMARY_KEY</span><span class="o">));</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">field</span> <span class="o">:</span> <span class="n">include</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">addNestedFieldToMap</span><span class="o">(</span><span class="n">filteredData</span><span class="o">,</span> <span class="n">originalData</span><span class="o">,</span> <span class="n">field</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\."</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 如果没有指定 include，则将原始数据全部复制到过滤后的数据中</span>
            <span class="n">filteredData</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">originalData</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// 处理 exclude 逻辑</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">exclude</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">exclude</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">field</span> <span class="o">:</span> <span class="n">exclude</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">removeNestedFieldFromMap</span><span class="o">(</span><span class="n">filteredData</span><span class="o">,</span> <span class="n">field</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\."</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">filteredData</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 过滤多条记录的指定字段。
     *
     * @param dataList  原始数据列表
     * @param include    要包含的字段数组
     * @param exclude    要排除的字段数组
     * @return 过滤后的数据列表
     */</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="nf">filterFieldsForMultipleRecords</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">dataList</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">include</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">exclude</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dataList</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">data</span> <span class="o">-&gt;</span> <span class="n">filterFields</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">include</span><span class="o">,</span> <span class="n">exclude</span><span class="o">))</span> <span class="c1">// 对每条记录应用过滤</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 递归添加嵌套字段到目标 Map 中。
     *
     * @param targetMap  目标 Map
     * @param sourceMap  源 Map
     * @param fieldPath  字段路径数组
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addNestedFieldToMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">targetMap</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">sourceMap</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">fieldPath</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fieldPath</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span><span class="k">return</span><span class="o">;}</span>

        <span class="nc">String</span> <span class="n">currentKey</span> <span class="o">=</span> <span class="n">fieldPath</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="nc">Object</span> <span class="n">currentLevel</span> <span class="o">=</span> <span class="n">sourceMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currentKey</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentLevel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果当前字段为 null，抛出异常</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"字段不存在: "</span> <span class="o">+</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"."</span><span class="o">,</span> <span class="n">fieldPath</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="c1">// 如果当前级别是 Map 且字段路径还有后续级别，则递归处理</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentLevel</span> <span class="k">instanceof</span> <span class="nc">Map</span> <span class="o">&amp;&amp;</span> <span class="n">fieldPath</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">nestedMap</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">currentLevel</span><span class="o">;</span>
            <span class="n">targetMap</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">currentKey</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;());</span>
            <span class="n">addNestedFieldToMap</span><span class="o">((</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">targetMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currentKey</span><span class="o">),</span> <span class="n">nestedMap</span><span class="o">,</span> <span class="n">sliceArray</span><span class="o">(</span><span class="n">fieldPath</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 为最深层</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fieldPath</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 如果没有嵌套，则直接添加当前字段</span>
                <span class="n">targetMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">currentKey</span><span class="o">,</span> <span class="n">currentLevel</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"字段不存在: "</span> <span class="o">+</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"."</span><span class="o">,</span> <span class="n">fieldPath</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 递归移除嵌套字段。
     *
     * @param targetMap  目标 Map
     * @param fieldPath  字段路径数组
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">removeNestedFieldFromMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">targetMap</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">fieldPath</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fieldPath</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">)</span> <span class="o">{</span><span class="k">return</span><span class="o">;}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">targetMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">fieldPath</span><span class="o">[</span><span class="mi">0</span><span class="o">])){</span>
            <span class="c1">// 如果当前字段为 null，抛出异常</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"字段不存在: "</span> <span class="o">+</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"."</span><span class="o">,</span> <span class="n">fieldPath</span><span class="o">));</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="n">currentKey</span> <span class="o">=</span> <span class="n">fieldPath</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fieldPath</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">targetMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">currentKey</span><span class="o">);</span> <span class="c1">// 移除指定字段</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">nestedObject</span> <span class="o">=</span> <span class="n">targetMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currentKey</span><span class="o">);</span>
            <span class="c1">// 如果当前对象是 Map，则递归移除</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nestedObject</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">removeNestedFieldFromMap</span><span class="o">((</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">nestedObject</span><span class="o">,</span> <span class="n">sliceArray</span><span class="o">(</span><span class="n">fieldPath</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
                <span class="c1">// 如果嵌套 Map 为空，则移除外层字段</span>
                <span class="k">if</span> <span class="o">(((</span><span class="nc">Map</span><span class="o">&lt;?,</span> <span class="o">?&gt;)</span> <span class="n">nestedObject</span><span class="o">).</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">targetMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">currentKey</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"字段不存在: "</span> <span class="o">+</span> <span class="nc">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"."</span><span class="o">,</span> <span class="n">fieldPath</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 工具方法 - 提取字段数组的一部分。
     *
     * @param array 源数组
     * @param start 开始索引
     * @return 新数组
     */</span>
    <span class="kd">private</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">sliceArray</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">array</span><span class="o">,</span> <span class="kt">int</span> <span class="n">start</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">array</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">start</span><span class="o">];</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">array</span><span class="o">,</span> <span class="n">start</span><span class="o">,</span> <span class="n">result</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>用法：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FieldFilter</span> <span class="n">fieldFilter</span><span class="o">=</span><span class="k">new</span> <span class="nc">FieldFilter</span><span class="o">();</span>
<span class="nc">Map</span> <span class="n">map</span><span class="o">=...;</span>
<span class="nc">String</span> <span class="o">[]</span> <span class="n">include</span><span class="o">={</span><span class="s">"name"</span><span class="o">,</span><span class="s">"age"</span><span class="o">};</span>
<span class="nc">String</span> <span class="o">[]</span> <span class="n">exclude</span><span class="o">={};</span>
<span class="nc">Map</span> <span class="n">result</span><span class="o">=</span><span class="n">fieldFilter</span><span class="o">.</span><span class="na">filterFields</span><span class="o">(</span><span class="n">map</span><span class="o">,</span> <span class="n">include</span><span class="o">,</span> <span class="n">exclude</span><span class="o">);</span>
</code></pre></div></div>

<p>注意，主要用来处理MongoDB的数据，因此中间添加了<code class="language-plaintext highlighter-rouge">_id</code>字段，与MongoDB的字段包含排查保持一致，若需他用，请删除<code class="language-plaintext highlighter-rouge">filteredData.put(PRIMARY_KEY,originalData.get(PRIMARY_KEY));</code>。</p>]]></content><author><name>acteds</name></author><category term="Java" /><summary type="html"><![CDATA[Java笔记]]></summary></entry></feed>