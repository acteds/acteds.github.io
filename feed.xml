<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.10.0">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2025-04-18T20:04:10+08:00</updated><id>/feed.xml</id><title type="html">ä¸ªäººåšå®¢</title><subtitle></subtitle><author><name>acteds</name></author><entry><title type="html">è·å–æŒ‡å®šç±»çš„æ‰€æœ‰å­—æ®µ</title><link href="/2025/04/03/%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E7%B1%BB%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%97%E6%AE%B5/" rel="alternate" type="text/html" title="è·å–æŒ‡å®šç±»çš„æ‰€æœ‰å­—æ®µ" /><published>2025-04-03T00:00:00+08:00</published><updated>2025-04-03T00:00:00+08:00</updated><id>/2025/04/03/%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E7%B1%BB%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%97%E6%AE%B5</id><content type="html" xml:base="/2025/04/03/%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E7%B1%BB%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%97%E6%AE%B5/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p>ä¸ºäº†å¯¹ESè¿›è¡Œå…¨æ–‡å…¨å­—æ®µæœç´¢ï¼Œäºæ˜¯å°±æœ‰äº†è·å–æŒ‡å®šç±»çš„å…¨éƒ¨å­—æ®µçš„éœ€æ±‚ï¼Œåˆå› ä¸ºè¯¥ç±»æ¶‰åŠç»§æ‰¿ï¼ŒæŒæœ‰å…¶ä»–ç±»ï¼Œæ³›å‹ï¼Œå› æ­¤æœ‰äº†å†™è¿™ä¸ªå·¥å…·ç±»çš„æƒ³æ³•ã€‚</p>

<h1 id="java">Java</h1>

<h2 id="è·å–æŒ‡å®šç±»çš„æ‰€æœ‰å­—æ®µ">è·å–æŒ‡å®šç±»çš„æ‰€æœ‰å­—æ®µ</h2>

<p>è¦è·å–æŒ‡å®šç±»çš„æ‰€æœ‰å­—æ®µï¼Œä½¿ç”¨åå°„å³å¯ã€‚ä½†æ˜¯ç”±äºç±»å¯èƒ½æ¶‰åŠç»§æ‰¿ã€åµŒå¥—å¼•ç”¨ä»¥åŠæ³›å‹ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">B&lt;T&gt;</code>ï¼‰ï¼Œç›´æ¥åå°„ä¼šæ¯”è¾ƒç¹çä¸”æ€§èƒ½ä¸é«˜ã€‚</p>

<p>å› æ­¤è®¾è®¡æ€è·¯å¦‚ä¸‹ï¼š</p>

<ul>
  <li><strong>åå°„è·å–å­—æ®µï¼š</strong> åˆ©ç”¨ <code class="language-plaintext highlighter-rouge">Class.getDeclaredFields()</code> é€’å½’è·å–å½“å‰ç±»ä»¥åŠçˆ¶ç±»çš„å­—æ®µã€‚</li>
  <li><strong>æ³›å‹æ˜ å°„å¤„ç†ï¼š</strong> å¯¹äºæ³›å‹å­—æ®µï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">ParameterizedType</code> è§£ææ³›å‹å‚æ•°ï¼Œæ„å»ºæ³›å‹æ˜ å°„å…³ç³»ï¼Œå°†æ³›å‹å˜é‡è½¬æ¢ä¸ºå…·ä½“ç±»å‹ï¼Œå†é€’å½’è§£æå…¶å­—æ®µã€‚</li>
  <li><strong>é€’å½’è§£æåµŒå¥—å­—æ®µï¼š</strong> å¯¹äºæŒæœ‰å…¶ä»–è‡ªå®šä¹‰å¯¹è±¡çš„å­—æ®µï¼Œä¹Ÿé€’å½’è·å–å…¶å­—æ®µï¼Œå¹¶ä»¥â€œçˆ¶å­—æ®µ.å­å­—æ®µâ€çš„å½¢å¼è¿”å›ã€‚</li>
  <li><strong>ç¼“å­˜æœºåˆ¶ï¼š</strong> ç”±äºåå°„æ€§èƒ½è¾ƒå·®ï¼ŒåŠ å…¥ç¼“å­˜æœºåˆ¶ä¿å­˜å·²è§£æç»“æœï¼Œä¸‹æ¬¡ä½¿ç”¨æ—¶ç›´æ¥è¿”å›ï¼Œæé«˜æ•ˆç‡ã€‚</li>
</ul>

<p>è¿™ç§è®¾è®¡æ—¢æ»¡è¶³äº†éœ€æ±‚ï¼Œåˆè€ƒè™‘åˆ°äº†å¤æ‚ç±»å‹ï¼ˆç»§æ‰¿ã€æ³›å‹ã€åµŒå¥—å¯¹è±¡ï¼‰çš„æƒ…å†µï¼Œå¹¶é€šè¿‡ç¼“å­˜ä¼˜åŒ–äº†æ€§èƒ½ã€‚</p>

<p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.aotmd</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.math.BigDecimal</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.LocalDate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="o">;</span>

<span class="cm">/**
 * å·¥å…·ç±»ï¼šç”¨äºè·å–æŒ‡å®šç±»çš„æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ç»§æ‰¿ã€è‡ªæŒæœ‰ç±»ã€æ³›å‹ç­‰ï¼‰
 * ä¸»è¦ç”¨äºESçš„å…¨æ–‡å…¨å­—æ®µæœç´¢
 * 
 * æ”¯æŒå­—æ®µç±»å‹è¿‡æ»¤ï¼ˆå­—ç¬¦ä¸²ã€æ•°å€¼ã€å¸ƒå°”å€¼ã€æ—¥æœŸç±»å‹ï¼‰
 * ä½¿ç”¨ç¼“å­˜æé«˜æ€§èƒ½
 * 
 * @author aotmd
 * @version 1.0
 * @date 2025/4/3 20:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FieldUtil</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_DEPTH</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span> <span class="c1">// é¿å…æ— é™é€’å½’ï¼Œæœ€å¤§é€’å½’æ·±åº¦</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="no">EXCLUDE_PACKAGES</span> <span class="o">=</span> <span class="o">{</span><span class="s">"java."</span><span class="o">,</span> <span class="s">"javax."</span><span class="o">,</span> <span class="s">"com.fasterxml.jackson."</span><span class="o">};</span>
    
    <span class="c1">// ä½¿ç”¨å¹¶å‘Mapç¼“å­˜è§£æç»“æœï¼Œæé«˜æ€§èƒ½</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">cacheFields</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
    
    <span class="cm">/**
     * è·å–æŒ‡å®šç±»çš„æ‰€æœ‰å­—ç¬¦ä¸²ç±»å‹å­—æ®µ
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getStringFields</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getFieldsByType</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="s">"String"</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * è·å–æŒ‡å®šç±»çš„æ‰€æœ‰æ•°å€¼ç±»å‹å­—æ®µ
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getNumberFields</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getFieldsByType</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
                <span class="kt">byte</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">short</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">float</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="kt">double</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                <span class="nc">Byte</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Short</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Float</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Double</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">class</span>
        <span class="o">),</span> <span class="s">"Number"</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * è·å–æŒ‡å®šç±»çš„æ‰€æœ‰å¸ƒå°”ç±»å‹å­—æ®µ
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getBooleanFields</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getFieldsByType</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="kt">boolean</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="s">"Boolean"</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * è·å–æŒ‡å®šç±»çš„æ‰€æœ‰æ—¥æœŸç±»å‹å­—æ®µ
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getDateFields</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getFieldsByType</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="nc">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">LocalDate</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Date</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="s">"Date"</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * æŒ‰æŒ‡å®šç±»å‹è·å–å­—æ®µï¼ˆæ”¯æŒç¼“å­˜ï¼‰
     * @param clazz ç›®æ ‡ç±»
     * @param targetTypes éœ€è¦åŒ¹é…çš„ç±»å‹é›†åˆ
     * @param typeKey ç”¨äºç¼“å­˜çš„keyå‰ç¼€
     * @return ç¬¦åˆç±»å‹çš„å­—æ®µé›†åˆ
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getFieldsByType</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">targetTypes</span><span class="o">,</span> <span class="nc">String</span> <span class="n">typeKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">cacheKey</span> <span class="o">=</span> <span class="s">"%s-%s"</span><span class="o">.</span><span class="na">formatted</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">typeKey</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">cacheFields</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">cacheKey</span><span class="o">,</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fieldNames</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
            <span class="n">getFieldsRecursive</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">fieldNames</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;(),</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(),</span> <span class="n">targetTypes</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">fieldNames</span><span class="o">;</span>
        <span class="o">});</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * é€’å½’è·å–ç±»åŠå…¶çˆ¶ç±»ã€æ³›å‹æŒæœ‰ç±»çš„å­—æ®µ
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">getFieldsRecursive</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">fieldNames</span><span class="o">,</span> <span class="nc">String</span> <span class="n">prefix</span><span class="o">,</span>
                                           <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">TypeVariable</span><span class="o">&lt;?&gt;,</span> <span class="nc">Type</span><span class="o">&gt;</span> <span class="n">genericMap</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">visited</span><span class="o">,</span>
                                           <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">targetTypes</span><span class="o">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">clazz</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">||</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="no">MAX_DEPTH</span> <span class="o">||</span> <span class="n">isExcluded</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">visited</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span> <span class="c1">// é˜²æ­¢é‡å¤è§£æåŒä¸€ä¸ªç±»</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// è§£ææ³›å‹çˆ¶ç±»ï¼Œå¹¶å»ºç«‹æ³›å‹æ˜ å°„å…³ç³»</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getGenericSuperclass</span><span class="o">()</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span> <span class="n">parameterizedType</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Type</span><span class="o">[]</span> <span class="n">actualTypes</span> <span class="o">=</span> <span class="n">parameterizedType</span><span class="o">.</span><span class="na">getActualTypeArguments</span><span class="o">();</span>
            <span class="nc">TypeVariable</span><span class="o">&lt;?&gt;[]</span> <span class="n">typeVariables</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">getTypeParameters</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">typeVariables</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">genericMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">typeVariables</span><span class="o">[</span><span class="n">i</span><span class="o">],</span> <span class="n">actualTypes</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// è§£æå­—æ®µ</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="n">field</span> <span class="o">:</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredFields</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isStatic</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">())</span> <span class="o">||</span> <span class="nc">Modifier</span><span class="o">.</span><span class="na">isTransient</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()))</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span> <span class="c1">// è·³è¿‡é™æ€å­—æ®µå’Œç¬æ€å­—æ®µ</span>
            <span class="o">}</span>

            <span class="nc">Type</span> <span class="n">fieldType</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">getGenericType</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">fieldName</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="n">field</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">:</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">field</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">targetTypes</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">fieldNames</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fieldName</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">fieldType</span> <span class="k">instanceof</span> <span class="nc">TypeVariable</span><span class="o">&lt;?&gt;</span> <span class="n">typeVar</span> <span class="o">&amp;&amp;</span> <span class="n">genericMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">typeVar</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// æ³›å‹å­—æ®µè§£æ</span>
                <span class="nc">Type</span> <span class="n">actualType</span> <span class="o">=</span> <span class="n">genericMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">typeVar</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">actualType</span> <span class="k">instanceof</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">actualClass</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">getFieldsRecursive</span><span class="o">(</span><span class="n">actualClass</span><span class="o">,</span> <span class="n">fieldNames</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">genericMap</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(),</span> <span class="n">targetTypes</span><span class="o">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">fieldType</span> <span class="k">instanceof</span> <span class="nc">ParameterizedType</span> <span class="n">parameterizedFieldType</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å¤„ç†æ³›å‹å‚æ•°ç±»å‹</span>
                <span class="nc">Type</span> <span class="n">rawType</span> <span class="o">=</span> <span class="n">parameterizedFieldType</span><span class="o">.</span><span class="na">getRawType</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">rawType</span> <span class="k">instanceof</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">rawClass</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">getFieldsRecursive</span><span class="o">(</span><span class="n">rawClass</span><span class="o">,</span> <span class="n">fieldNames</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">genericMap</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(),</span> <span class="n">targetTypes</span><span class="o">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">isPrimitive</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isExcluded</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">()))</span> <span class="o">{</span>
                <span class="c1">// é€’å½’è§£æéåŸºæœ¬ç±»å‹</span>
                <span class="n">getFieldsRecursive</span><span class="o">(</span><span class="n">field</span><span class="o">.</span><span class="na">getType</span><span class="o">(),</span> <span class="n">fieldNames</span><span class="o">,</span> <span class="n">fieldName</span><span class="o">,</span> <span class="n">genericMap</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(),</span> <span class="n">targetTypes</span><span class="o">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="c1">// é€’å½’å¤„ç†çˆ¶ç±»å­—æ®µ</span>
        <span class="n">getFieldsRecursive</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">(),</span> <span class="n">fieldNames</span><span class="o">,</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">genericMap</span><span class="o">,</span> <span class="n">visited</span><span class="o">,</span> <span class="n">targetTypes</span><span class="o">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * åˆ¤æ–­æ˜¯å¦å±äºæ’é™¤çš„åŒ…ï¼ˆä¾‹å¦‚JDKç±»ã€Jacksonç±»ç­‰ï¼‰
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isExcluded</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">prefix</span> <span class="o">:</span> <span class="no">EXCLUDE_PACKAGES</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">className</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">prefix</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span><span class="nc">Boolean</span> <span class="n">active</span><span class="o">;</span><span class="nc">LocalDate</span> <span class="n">birthDate</span><span class="o">;}</span>
    <span class="kd">class</span> <span class="nc">B</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span> <span class="no">T</span> <span class="n">t1</span><span class="o">,</span> <span class="n">t2</span><span class="o">;</span><span class="nc">String</span> <span class="n">age</span><span class="o">;</span><span class="nc">Double</span> <span class="n">score</span><span class="o">;</span><span class="nc">Boolean</span> <span class="n">isMember</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">class</span> <span class="nc">C</span> <span class="kd">extends</span> <span class="no">B</span><span class="o">&lt;</span><span class="no">A</span><span class="o">&gt;</span> <span class="o">{</span> <span class="nc">String</span> <span class="n">age2</span><span class="o">;</span><span class="nc">BigDecimal</span> <span class="n">salary</span><span class="o">;</span><span class="nc">LocalDateTime</span> <span class="n">lastLogin</span><span class="o">;}</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"String å­—æ®µï¼š%s%n"</span><span class="o">,</span> <span class="n">getStringFields</span><span class="o">(</span><span class="no">C</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>  <span class="c1">// é¢„æœŸï¼š[age, t1.name, t2.name, age2]</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"æ•°å­—å­—æ®µï¼š%s%n"</span><span class="o">,</span> <span class="n">getNumberFields</span><span class="o">(</span><span class="no">C</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>  <span class="c1">// é¢„æœŸï¼š[score, salary, t1.id, t2.id]</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"å¸ƒå°”å­—æ®µï¼š%s%n"</span><span class="o">,</span> <span class="n">getBooleanFields</span><span class="o">(</span><span class="no">C</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>  <span class="c1">// é¢„æœŸï¼š[isMember, t1.active, t2.active]</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"æ—¥æœŸå­—æ®µï¼š%s%n"</span><span class="o">,</span> <span class="n">getDateFields</span><span class="o">(</span><span class="no">C</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>  <span class="c1">// é¢„æœŸï¼š[lastLogin, t1.birthDate, t2.birthDate]</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>æ‰§è¡Œæ€è·¯ï¼š</strong></p>

<p><strong>é€’å½’è§£æç±»çš„å­—æ®µ</strong></p>

<p>åˆ©ç”¨åå°„è·å–ç›®æ ‡ç±»ï¼ˆåŒ…æ‹¬å…¶çˆ¶ç±»ï¼‰çš„æ‰€æœ‰å­—æ®µï¼Œå¯¹äºæ¯ä¸ªå­—æ®µï¼š</p>

<ul>
  <li>å¦‚æœå­—æ®µç±»å‹ä¸ç›®æ ‡ç±»å‹ï¼ˆä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">String</code>ã€<code class="language-plaintext highlighter-rouge">Number</code>ã€<code class="language-plaintext highlighter-rouge">Boolean</code>ã€<code class="language-plaintext highlighter-rouge">Date</code>ï¼‰åŒ¹é…ï¼Œåˆ™å°†å­—æ®µåç§°ï¼ˆæ”¯æŒåµŒå¥—å½¢å¼ï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">t1.name</code>ï¼‰åŠ å…¥ç»“æœé›†åˆã€‚</li>
  <li>å¦‚æœå­—æ®µæ˜¯æ³›å‹ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">B&lt;T&gt;</code> ä¸­çš„ <code class="language-plaintext highlighter-rouge">T</code>ï¼‰ï¼Œåˆ™é€šè¿‡æ³›å‹æ˜ å°„å…³ç³»ï¼ˆç”± <code class="language-plaintext highlighter-rouge">ParameterizedType</code> è§£æå¾—åˆ°ï¼‰ç¡®å®š <code class="language-plaintext highlighter-rouge">T</code> çš„å…·ä½“ç±»å‹ï¼Œç„¶åé€’å½’è§£æè¯¥ç±»å‹çš„å­—æ®µã€‚</li>
  <li>å¦‚æœå­—æ®µä¸ºå‚æ•°åŒ–ç±»å‹ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code>ï¼‰ï¼Œåˆ™æå–å…¶åŸå§‹ç±»å‹ï¼Œå¹¶ç»§ç»­é€’å½’ã€‚</li>
  <li>å¯¹äºéåŸºæœ¬ç±»å‹ä¸”ä¸å±äºç³»ç»ŸåŒ…ï¼ˆä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">java.</code> æˆ– <code class="language-plaintext highlighter-rouge">Jackson</code> ç›¸å…³çš„ç±»ï¼‰ï¼Œä¹Ÿé€’å½’è§£æï¼Œè·å–å…¶å†…éƒ¨ç¬¦åˆè¦æ±‚çš„å­—æ®µã€‚</li>
</ul>

<p><strong>é˜²æ­¢æ— é™é€’å½’å’Œé‡å¤è§£æ</strong></p>

<p>é€šè¿‡é™åˆ¶æœ€å¤§é€’å½’æ·±åº¦ï¼ˆ<code class="language-plaintext highlighter-rouge">MAX_DEPTH</code>ï¼‰å’Œä½¿ç”¨ visited é›†åˆé¿å…åŒä¸€ä¸ªç±»å¤šæ¬¡è§£æï¼Œé˜²æ­¢å‡ºç°æ­»å¾ªç¯ã€‚</p>

<p><strong>ç¼“å­˜ä¼˜åŒ–</strong></p>

<p>ç”±äºåå°„æ“ä½œæ€§èƒ½è¾ƒä½ï¼Œæ‰€ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">ConcurrentHashMap</code> ç¼“å­˜è§£æè¿‡çš„å­—æ®µï¼Œä½¿ç”¨â€œç±»å-å­—æ®µç±»å‹â€ä½œä¸ºç¼“å­˜é”®ï¼Œä¸‹æ¬¡å†è¯·æ±‚ç›¸åŒç±»å‹å­—æ®µæ—¶ç›´æ¥è¿”å›ç¼“å­˜ç»“æœã€‚</p>]]></content><author><name>acteds</name></author><category term="Java" /><summary type="html"><![CDATA[Javaç¬”è®°]]></summary></entry><entry><title type="html">æ­£ç¡®æˆªæ–­å­—ç¬¦ä¸²</title><link href="/2025/03/13/%E6%AD%A3%E7%A1%AE%E6%88%AA%E6%96%AD%E5%AD%97%E7%AC%A6%E4%B8%B2/" rel="alternate" type="text/html" title="æ­£ç¡®æˆªæ–­å­—ç¬¦ä¸²" /><published>2025-03-13T00:00:00+08:00</published><updated>2025-03-13T00:00:00+08:00</updated><id>/2025/03/13/%E6%AD%A3%E7%A1%AE%E6%88%AA%E6%96%AD%E5%AD%97%E7%AC%A6%E4%B8%B2</id><content type="html" xml:base="/2025/03/13/%E6%AD%A3%E7%A1%AE%E6%88%AA%E6%96%AD%E5%AD%97%E7%AC%A6%E4%B8%B2/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p>åœ¨JavaScriptä¸­æˆªå–å­—ç¬¦ä¸²æ—¶ï¼Œç¢°åˆ°ç‰¹æ®Šç¼–ç çš„å­—ç¬¦ï¼Œæˆªæ–­å¯èƒ½å‡ºç°ä¹±ç ã€‚åˆ†è¯æ–¹æ³•ã€‚</p>

<h1 id="javascript">JavaScript</h1>

<h2 id="å­—ç¬¦ä¸²æˆªæ–­">å­—ç¬¦ä¸²æˆªæ–­</h2>

<p>åœ¨ JavaScript ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">slice()</code> æˆ– <code class="language-plaintext highlighter-rouge">substring()</code> æ¥æˆªå–å­—ç¬¦ä¸²çš„å‰ 10 ä¸ªå­—ç¬¦ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å­—ç¬¦ä¸²ï¼Œç”¨äºæ¼”ç¤ºæˆªæ–­</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span> <span class="c1">// æˆªå–å‰10ä¸ªå­—ç¬¦</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">truncatedStr</span><span class="p">);</span>
</code></pre></div></div>

<p>å¦‚æœå¸Œæœ›ç¡®ä¿æˆªæ–­ä¸ä¼šæ‹†åˆ† UTF-16 ä»£ç†å¯¹ï¼ˆå¦‚æŸäº› emojiï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Array.from()</code> å¤„ç†ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å­—ç¬¦ä¸²ğŸ˜Šï¼Œç”¨äºæ¼”ç¤ºæˆªæ–­</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">truncatedStr</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™æ ·å¯ä»¥ç¡®ä¿ä¸ä¼šæˆªæ–­åŠä¸ª emoji æˆ–ç‰¹æ®Šå­—ç¬¦ã€‚</p>

<h3 id="emoji-æˆªæ–­çš„åŸç†">Emoji æˆªæ–­çš„åŸç†</h3>

<p>åœ¨ JavaScript ä¸­ï¼Œå­—ç¬¦ä¸²åŸºäº UTF-16 ç¼–ç ï¼Œè€Œ emoji å¯èƒ½ç”±å¤šä¸ª UTF-16 ç å…ƒï¼ˆcode unitï¼‰ç»„æˆï¼Œå¯¼è‡´æ™®é€šçš„ <code class="language-plaintext highlighter-rouge">slice()</code> æˆ– <code class="language-plaintext highlighter-rouge">substring()</code> å¯èƒ½ä¼šæˆªæ–­ä¸€ä¸ª emojiï¼Œå¯¼è‡´æ˜¾ç¤ºå¼‚å¸¸ã€‚</p>

<p>UTF-16 ä»£ç†å¯¹</p>

<ul>
  <li>å¤§éƒ¨åˆ†æ™®é€šå­—ç¬¦ï¼ˆå¦‚è‹±æ–‡å­—æ¯ã€æ±‰å­—ï¼‰åœ¨ UTF-16 ä¸­å  1 ä¸ªç å…ƒï¼ˆ16 ä½ï¼‰ã€‚</li>
  <li>æŸäº›ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ emojiã€æŸäº›ç½•è§æ±‰å­—ï¼‰æ˜¯ä»£ç†å¯¹ï¼ˆSurrogate Pairï¼‰ï¼Œéœ€è¦ 2 ä¸ªç å…ƒï¼ˆ32 ä½ï¼‰è¡¨ç¤ºã€‚</li>
</ul>

<p>ç¤ºä¾‹ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// 14ï¼ˆé•¿åº¦ä¸ç­‰äºå­—ç¬¦æ•°ï¼‰</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span> <span class="c1">// "Hello ï¿½"</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„ä»£ç é”™è¯¯åœ°æˆªæ–­äº† <code class="language-plaintext highlighter-rouge">ğŸ˜Š</code>ï¼Œå¯¼è‡´è¾“å‡ºä¹±ç  <code class="language-plaintext highlighter-rouge">ï¿½</code>ã€‚</p>

<hr />

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Array.from()</code> å¤„ç† emoji</p>

<p><code class="language-plaintext highlighter-rouge">Array.from(str)</code> èƒ½æ­£ç¡®è§£æå­—ç¬¦ï¼ŒåŒ…æ‹¬ä»£ç†å¯¹ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">truncatedStr</span><span class="p">);</span> <span class="c1">// "Hello ğŸ˜Š"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Array.from(str)</code> èƒ½å°†å­—ç¬¦ä¸²æ‹†åˆ†æˆæ­£ç¡®çš„ Unicode ç ç‚¹ï¼Œä¸ä¼šé”™è¯¯åœ°æ‹†å¼€ emojiã€‚</p>

<p>ä¹Ÿå¯ä»¥ç”¨ <strong>æ‰©å±•è¿ç®—ç¬¦ <code class="language-plaintext highlighter-rouge">...</code></strong> æ¥æ­£ç¡®æ‹†åˆ†å­—ç¬¦ä¸²ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">str</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">truncatedStr</span><span class="p">);</span> <span class="c1">// "Hello ğŸ˜Š"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">[...str]</code> çš„ä½œç”¨å’Œ <code class="language-plaintext highlighter-rouge">Array.from(str)</code> ä¸€æ ·ï¼Œéƒ½ä¼šæŒ‰<strong>å®Œæ•´çš„ Unicode ç ç‚¹</strong>æ‹†åˆ†å­—ç¬¦ä¸²ã€‚</p>

<hr />

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Intl.Segmenter</code>ï¼ˆæ›´é«˜çº§çš„åˆ†è¯æ–¹å¼ï¼‰</p>

<p>å¦‚æœè¦ç¡®ä¿æŒ‰ç…§å¯è§†å­—ç¬¦ï¼ˆgraphemeï¼‰æ‹†åˆ†ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Intl.Segmenter</code>ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">segmenter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Intl</span><span class="p">.</span><span class="nx">Segmenter</span><span class="p">(</span><span class="dl">'</span><span class="s1">en</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">granularity</span><span class="p">:</span> <span class="dl">'</span><span class="s1">grapheme</span><span class="dl">'</span> <span class="p">});</span>
<span class="kd">let</span> <span class="nx">segments</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">segmenter</span><span class="p">.</span><span class="nx">segment</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">)].</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">segment</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">truncatedStr</span><span class="p">);</span> <span class="c1">// "Hello ğŸ˜Š"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Intl.Segmenter</code> èƒ½è¯†åˆ«å¤æ‚çš„ç»„åˆå­—ç¬¦ï¼Œå¦‚å¸¦å˜éŸ³ç¬¦çš„å­—æ¯ã€è”åˆ emoji ç­‰ã€‚</p>

<p>å¦‚æœä½ éœ€è¦<strong>æŒ‰å•è¯</strong>æˆ–<strong>æŒ‰å¥å­</strong>æˆªæ–­ï¼Œè€Œä¸ä»…ä»…æ˜¯æŒ‰å­—ç¬¦æ•°æˆªæ–­ï¼š</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">segmenter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Intl</span><span class="p">.</span><span class="nx">Segmenter</span><span class="p">(</span><span class="dl">'</span><span class="s1">en</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">granularity</span><span class="p">:</span> <span class="dl">'</span><span class="s1">word</span><span class="dl">'</span> <span class="p">});</span>
<span class="kd">let</span> <span class="nx">segments</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">segmenter</span><span class="p">.</span><span class="nx">segment</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">)].</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">segment</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">);</span> <span class="c1">// å–å‰ 2 ä¸ªå•è¯</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">truncatedStr</span><span class="p">);</span> <span class="c1">// "Hello ğŸ˜Š"</span>
</code></pre></div></div>
<p>è¿™å¯ä»¥ç¡®ä¿<strong>ä¸æŠŠä¸€ä¸ªå®Œæ•´çš„å•è¯æˆ– emoji ç»„åˆæ‹†å¼€</strong>ï¼Œæ¯”å¦‚ <code class="language-plaintext highlighter-rouge">"ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"</code> è¿™ç§å®¶æ— emojiï¼Œå®ƒå…¶å®ç”±å¤šä¸ª Unicode ç ç‚¹ç»„æˆã€‚</p>

<hr />

<p><strong>Node.js çš„ <code class="language-plaintext highlighter-rouge">Buffer</code> å¤„ç†æ–¹å¼</strong></p>

<p>å¦‚æœä½ çš„ JavaScript ä»£ç è·‘åœ¨ Node.js ä¸Šï¼Œä¹Ÿå¯ä»¥ç”¨ <code class="language-plaintext highlighter-rouge">Buffer</code> å¤„ç†ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="dl">'</span><span class="s1">utf-8</span><span class="dl">'</span><span class="p">);</span> 
<span class="kd">let</span> <span class="nx">truncatedBuf</span> <span class="o">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">truncatedBuf</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span> 
</code></pre></div></div>
<p>ä½† <code class="language-plaintext highlighter-rouge">Buffer</code> å¤„ç†çš„æ˜¯<strong>å­—èŠ‚ï¼ˆbyteï¼‰ï¼Œè€Œä¸æ˜¯å­—ç¬¦ï¼ˆcharï¼‰</strong>ï¼Œå¯èƒ½ä»ç„¶ä¼šæˆªæ–­ emojiï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸å¤ªæ¨èã€‚</p>

<hr />

<p><strong>æ€»ç»“</strong></p>

<table>
  <thead>
    <tr>
      <th>æ–¹å¼</th>
      <th>æ˜¯å¦æ¨è</th>
      <th>é€‚ç”¨åœºæ™¯</th>
      <th>å…¼å®¹æ€§</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">slice(0, 10)</code></td>
      <td>âŒ å¯èƒ½æˆªæ–­ emoji</td>
      <td>ä»…é€‚ç”¨äºæ–°ç‰ˆ Chrome</td>
      <td>Chrome 117+</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Array.from(str).slice(0, 10).join('')</code></td>
      <td>âœ… æ¨è</td>
      <td>å¤„ç† emojiï¼Œä¿è¯è·¨æµè§ˆå™¨å…¼å®¹</td>
      <td>å…¼å®¹æ‰€æœ‰ç°ä»£æµè§ˆå™¨</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[...str].slice(0, 10).join('')</code></td>
      <td>âœ… æ¨è</td>
      <td>å’Œ <code class="language-plaintext highlighter-rouge">Array.from()</code> ç±»ä¼¼ï¼Œè¯­æ³•æ›´ç®€æ´</td>
      <td>å…¼å®¹æ‰€æœ‰ç°ä»£æµè§ˆå™¨</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Intl.Segmenter</code></td>
      <td>âœ… é«˜çº§æ¨è</td>
      <td>éœ€è¦æŒ‰<strong>å•è¯</strong>æˆ–<strong>å¥å­</strong>æˆªå–</td>
      <td>ç°ä»£æµè§ˆå™¨ï¼ˆä¸å…¼å®¹ Node.jsï¼‰</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Buffer.from(str, 'utf-8')</code></td>
      <td>âš ï¸ æ…ç”¨</td>
      <td>Node.js å¤„ç†å­—ç¬¦ä¸²</td>
      <td>å¯èƒ½ä»ä¼šæˆªæ–­ emoji</td>
    </tr>
  </tbody>
</table>

<p>å¦‚æœä»£ç éœ€è¦<strong>å…¼å®¹æ‰€æœ‰æµè§ˆå™¨å’Œç¯å¢ƒ</strong>ï¼Œæœ€ä½³é€‰æ‹©æ˜¯ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">str</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
</code></pre></div></div>
<p>å¦‚æœéœ€è¦æ›´æ™ºèƒ½çš„<strong>æŒ‰å•è¯æˆ–å¥å­</strong>æˆªå–ï¼Œå»ºè®®ï¼š</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">segmenter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Intl</span><span class="p">.</span><span class="nx">Segmenter</span><span class="p">(</span><span class="dl">'</span><span class="s1">en</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">granularity</span><span class="p">:</span> <span class="dl">'</span><span class="s1">word</span><span class="dl">'</span> <span class="p">});</span>
<span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">segmenter</span><span class="p">.</span><span class="nx">segment</span><span class="p">(</span><span class="nx">str</span><span class="p">)].</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span> <span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">segment</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
</code></pre></div></div>
<p>å¦‚æœåªåœ¨<strong>æ–°ç‰ˆ Chrome</strong> è¿è¡Œï¼Œ<code class="language-plaintext highlighter-rouge">slice()</code> ä¹Ÿå¯ä»¥ç”¨äº†ï¼Œä½†<strong>å…¶ä»–æµè§ˆå™¨ï¼ˆå¦‚ Safariï¼‰å¯èƒ½ä»æœ‰é—®é¢˜</strong>ã€‚</p>

<h3 id="chrome-æ–°ç‰ˆ-vs-æ—§ç‰ˆè¡Œä¸º">Chrome æ–°ç‰ˆ vs æ—§ç‰ˆè¡Œä¸º</h3>

<p>æ—§ç‰ˆ Chromeï¼ˆæˆ–è¾ƒè€çš„ JavaScript è¿è¡Œç¯å¢ƒï¼‰</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
<span class="c1">// æ—§ç‰ˆå¯èƒ½è¾“å‡ºï¼š"Hello ï¿½"</span>
</code></pre></div></div>

<p>æ—§ç‰ˆçš„é—®é¢˜ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ğŸ˜Š</code> ç”±ä¸¤ä¸ª UTF-16 ç å…ƒ <code class="language-plaintext highlighter-rouge">\uD83D\uDE0A</code> ç»„æˆï¼Œ<code class="language-plaintext highlighter-rouge">slice(0, 8)</code> å¯èƒ½åªæˆªå–äº†ä¸€åŠï¼Œå¯¼è‡´ <code class="language-plaintext highlighter-rouge">ï¿½</code> ä¹±ç ã€‚</li>
</ul>

<p>æ–°ç‰ˆ Chrome</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
<span class="c1">// æ–°ç‰ˆå¯èƒ½æ­£ç¡®è¾“å‡ºï¼š"Hello ğŸ˜Š"</span>
</code></pre></div></div>

<p>æ–°ç‰ˆçš„ä¼˜åŒ–ï¼š</p>

<ul>
  <li>Chrome æ”¹è¿›äº† <code class="language-plaintext highlighter-rouge">slice()</code>ï¼Œè®©å®ƒèƒ½è‡ªåŠ¨è¯†åˆ«å®Œæ•´çš„ Unicode å­—ç¬¦ï¼Œé¿å…äº†æˆªæ–­ä»£ç†å¯¹çš„é—®é¢˜ã€‚</li>
  <li>è¿™æ„å‘³ç€ï¼Œåœ¨æ–°ç‰ˆ Chromeï¼ˆV8 å¼•æ“ï¼‰é‡Œï¼Œ<code class="language-plaintext highlighter-rouge">slice()</code> å’Œ <code class="language-plaintext highlighter-rouge">substring()</code> å¤§æ¦‚ç‡å·²ç»ä¸ä¼šæˆªæ–­ emojiã€‚</li>
</ul>

<p>è¦æ³¨æ„ï¼Œè¿™ç§ä¼˜åŒ–æ˜¯<strong>V8 å¼•æ“çš„ç‰¹æ€§ï¼Œä¸æ˜¯ ECMAScript è¯­è¨€æ ‡å‡†çš„ä¸€éƒ¨åˆ†</strong>ï¼Œå…¶ä»– JavaScript å¼•æ“ï¼ˆå¦‚ Safari çš„ JavaScriptCoreï¼‰å¯èƒ½ä»ç„¶ä¼šæœ‰é—®é¢˜ã€‚</p>

<p>å°½ç®¡æ–°ç‰ˆ V8 ä¼˜åŒ–äº† <code class="language-plaintext highlighter-rouge">slice()</code>ï¼Œä½†åœ¨ä¸åŒçš„æµè§ˆå™¨ã€Node.js ç‰ˆæœ¬æˆ–æ—§ç‰ˆ JavaScript å¼•æ“ï¼ˆå¦‚ Safariã€è€ç‰ˆæœ¬ Edgeï¼‰ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">slice()</code> å¯èƒ½ä»ç„¶ä¼šæˆªæ–­ emojiã€‚å› æ­¤ï¼Œæœ€ä¿é™©çš„æ–¹æ³•ä»ç„¶æ˜¯ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Hello ğŸ˜Š World</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">truncatedStr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">truncatedStr</span><span class="p">);</span> <span class="c1">// "Hello ğŸ˜Š"</span>
</code></pre></div></div>

<p>å¦‚æœåªåœ¨ç°ä»£ Chrome è¿è¡Œï¼Œå¯ä»¥æ”¾å¿ƒç”¨ <code class="language-plaintext highlighter-rouge">slice()</code>ï¼Œä½†å¦‚æœä»£ç éœ€è¦å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨æˆ– Node.js è¿è¡Œç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Array.from()</code> æ¥ç¡®ä¿ç¨³å®šæ€§ã€‚</p>]]></content><author><name>acteds</name></author><category term="Chrome" /><category term="JavaScript" /><summary type="html"><![CDATA[æ­£ç¡®æˆªæ–­å­—ç¬¦ä¸²]]></summary></entry><entry><title type="html">Chromeé€šè¿‡ä¹¦ç­¾è¿è¡Œjsä»£ç çš„å‘</title><link href="/2025/03/07/Chrome%E9%80%9A%E8%BF%87%E4%B9%A6%E7%AD%BE%E8%BF%90%E8%A1%8Cjs%E4%BB%A3%E7%A0%81%E7%9A%84%E5%9D%91/" rel="alternate" type="text/html" title="Chromeé€šè¿‡ä¹¦ç­¾è¿è¡Œjsä»£ç çš„å‘" /><published>2025-03-07T00:00:00+08:00</published><updated>2025-03-07T00:00:00+08:00</updated><id>/2025/03/07/Chrome%E9%80%9A%E8%BF%87%E4%B9%A6%E7%AD%BE%E8%BF%90%E8%A1%8Cjs%E4%BB%A3%E7%A0%81%E7%9A%84%E5%9D%91</id><content type="html" xml:base="/2025/03/07/Chrome%E9%80%9A%E8%BF%87%E4%B9%A6%E7%AD%BE%E8%BF%90%E8%A1%8Cjs%E4%BB%A3%E7%A0%81%E7%9A%84%E5%9D%91/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p>æˆ‘æƒ³å†™ä¸€ä¸ªä¸‹è½½CRXæ–‡ä»¶çš„JavaScriptä»£ç å¹¶å°è£…åˆ°ä¹¦ç­¾è¿è¡Œï¼Œä½†åœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°åœ¨ä¹¦ç­¾ä¸­è¿è¡Œçš„JavaScriptä»£ç ä¸åœ¨æ§åˆ¶å°è¿è¡Œçš„JavaScripté€»è¾‘ä¸ä¸€è‡´ã€‚</p>

<h1 id="chrome">Chrome</h1>

<p>ä¸€ä¸ªç®€å•çš„demoï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">javascript</span><span class="p">:(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="kd">let</span> <span class="nx">a</span><span class="o">=</span><span class="dl">"</span><span class="s2">%26installsource%3Dondemand%26uc</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">addStyle</span><span class="p">(</span><span class="dl">'</span><span class="s1">.masked1 {    padding: 5px 5px;    font-size: 14px;    color: snow;    position: fixed;    border-radius: 4px;    right: 5px;    top: 5%;    z-index: 999999;    text-align: center;    text-decoration: none;    display: inline-block;    margin: 4px 2px;    -webkit-transition-duration: 0.4s;    transition-duration: 0.4s;    cursor: pointer;    background-color: #4CAF50;    border: 2px solid #4CAF50;    padding: 0px;    font-size: 12px;    opacity: 0.8;    right: -40px;}.masked1:hover {    background-color: white;    color: black;    font-size: 14px;    padding: 5px 10px;    -webkit-transition: 0.5s;    opacity: 1;    margin: -3px 2px;    right: 5px;}</span><span class="dl">'</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">a1</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">button</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">a1</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">masked1</span><span class="dl">"</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">a1</span><span class="p">);</span>
    <span class="nx">a1</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">æµ‹è¯•æ˜¾ç¤º</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">a1</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">a</span><span class="p">)));</span>
    <span class="p">};</span>
    <span class="kd">function</span> <span class="nx">addStyle</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">styleElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">style</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">styleElement</span><span class="p">[</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">text/css</span><span class="dl">'</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">head</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">styleElement</span><span class="p">);</span>
        <span class="nx">styleElement</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">rules</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">})()</span>
</code></pre></div></div>

<p>å°†è¿™æ®µä»£ç æ·»åŠ åˆ°ä¹¦ç­¾ä¸­ï¼Œå¹¶ç‚¹å‡»åä¼šå‡ºç°ä¸€ä¸ªæŒ‰é’®ï¼Œç„¶åæ‰“å¼€æ§åˆ¶å°ï¼Œç‚¹å‡»åˆšåˆšå‡ºç°çš„æŒ‰é’®ï¼Œåˆ™æ§åˆ¶å°ä¼šæ‰“å°å‡ºä¸¤è¡Œæ–‡æœ¬ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&amp;installsource=ondemand&amp;uc
%26installsource%3Dondemand%26uc
</code></pre></div></div>

<p>æ­¤æ—¶ï¼Œå‘ç°<code class="language-plaintext highlighter-rouge">%26</code>å’Œ<code class="language-plaintext highlighter-rouge">%3D</code>è¢«ç¼–ç å›å»äº†ã€‚</p>

<p>è€ŒåŒæ ·çš„ä»£ç ï¼Œç›´æ¥è¿è¡Œåœ¨æ§åˆ¶å°ï¼Œç„¶åç‚¹å‡»å‡ºç°çš„æŒ‰é’®ï¼Œåˆ™æ§åˆ¶å°æ‰“å°çš„ä¸¤è¡Œæ–‡æœ¬ä¸ºï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%26installsource%3Dondemand%26uc
%26installsource%3Dondemand%26uc
</code></pre></div></div>

<p>å› æ­¤ï¼Œæƒ³åœ¨ä¹¦ç­¾ä¸­è¿è¡ŒJavaScriptä»£ç åˆ™éœ€è¦ç‰¹åˆ«æ³¨æ„ç¼–ç é—®é¢˜ã€‚è¦ä¿æŒ<code class="language-plaintext highlighter-rouge">a</code>ä¸è¢«è½¬ä¹‰éœ€è¦é€šè¿‡<code class="language-plaintext highlighter-rouge">encodeURIComponent(decodeURIComponent(a)</code>æ¥å¤„ç†ã€‚</p>

<p>åœ¨ä¹¦ç­¾è¿è¡Œç¯å¢ƒä¸­ï¼ŒJavaScriptä»£ç ä¼šè‡ªåŠ¨å¯¹æŸäº›å­—ç¬¦è¿›è¡Œè§£ç ï¼Œå› æ­¤éœ€è¦ç‰¹åˆ«æ³¨æ„ç¼–ç å’Œè§£ç çš„ä¸€è‡´æ€§ã€‚</p>

<p>å¦å¤–ï¼Œæœ€å¥½åœ¨æœ«å°¾åŠ ä¸Šåˆ†å·åˆ†éš”ä»£ç ï¼Œå¦åˆ™ä»£ç å‹ç¼©ä¸ºä¸€è¡Œæ”¾å…¥ä¹¦ç­¾åå¯èƒ½å‡ºç°è¯­æ³•é”™è¯¯ã€‚ä¸”å¦‚æœåœ¨ä¹¦ç­¾æ‰§è¡Œçš„ä»£ç æ‰§è¡Œå‡ºé”™ï¼Œä¸ä¼šæ˜¾ç¤ºåœ¨æ§åˆ¶å°ä¸Šã€‚</p>

<p>é™„ä¸Šä¸€ä¸ªä¸‹è½½æ‰©å±•å•†åº—çš„æ‰©å±•ç¨‹åºæ–‡ä»¶çš„JavaScriptä»£ç ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">javascript</span><span class="p">:</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">chrome.google.com</span><span class="dl">"</span><span class="p">)</span> <span class="o">||</span> <span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="dl">"</span><span class="s2">chromewebstore.google.com</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">ExtID</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">detail/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
        <span class="kd">let</span> <span class="nx">appname</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">detail/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
        <span class="kd">let</span> <span class="nx">p1</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://clients2.google.com/service/update2/crx?response=redirect&amp;nacl_arch=&amp;prodversion=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">Chrome/</span><span class="dl">"</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;acceptformat=crx2,crx3&amp;x=id</span><span class="dl">"</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">p2</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">%3D</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">ExtID</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">%26installsource%3Dondemand%26uc</span><span class="dl">"</span><span class="p">;</span>
        <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">p1</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">p2</span><span class="p">));</span>
        <span class="kd">let</span> <span class="nx">downloadInnerText</span> <span class="o">=</span> <span class="dl">'</span><span class="s1"> ä¸‹è½½CRXæ–‡ä»¶</span><span class="dl">'</span><span class="p">;</span>
        <span class="nx">addStyle</span><span class="p">(</span><span class="dl">'</span><span class="s1">.masked1 {    padding: 5px 5px;    font-size: 14px;    color: snow;    position: fixed;    border-radius: 4px;    right: 5px;    top: 5%;    z-index: 999999;    text-align: center;    text-decoration: none;    display: inline-block;    margin: 4px 2px;    -webkit-transition-duration: 0.4s;    transition-duration: 0.4s;    cursor: pointer;    background-color: #4CAF50;    border: 2px solid #4CAF50;    padding: 0px;    font-size: 12px;    opacity: 0.8;    right: -40px;}.masked1:hover {    background-color: white;    color: black;    font-size: 14px;    padding: 5px 10px;    -webkit-transition: 0.5s;    opacity: 1;    margin: -3px 2px;    right: 5px;}</span><span class="dl">'</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">a1</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">button</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">a1</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">masked1</span><span class="dl">"</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">a1</span><span class="p">);</span>
        <span class="nx">a1</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">downloadInnerText</span><span class="p">;</span>
        <span class="nx">a1</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">);</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">;</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="nx">appname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">.crx</span><span class="dl">"</span><span class="p">;</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
            <span class="nx">a</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">revokeObjectURL</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">addStyle</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">styleElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">style</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">styleElement</span><span class="p">[</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">text/css</span><span class="dl">'</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">head</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">styleElement</span><span class="p">);</span>
        <span class="nx">styleElement</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">rules</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">})()</span>
</code></pre></div></div>

<p>è™½ç„¶è¯´Chromeä¼šæç¤ºï¼šæ— æ³•ä»è¯¥ç½‘ç«™æ·»åŠ åº”ç”¨ã€æ‰©å±•ç¨‹åºå’Œç”¨æˆ·è„šæœ¬ï¼Œä½†å®é™…ä¸ŠCRXæ–‡ä»¶å·²ç»ä¸‹è½½åˆ°æœ¬åœ°äº†ã€‚è‹¥æ²¡æœ‰å‘ç°ä¸‹è½½çš„æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯è¢«Chromeæ‹¦æˆªäº†ï¼Œå¯ä»¥åœ¨Chromeçš„ä¸‹è½½ç®¡ç†é‡Œæ”¾è¡Œã€‚</p>

<p>æ›´ç®€æ´çš„ç‰ˆæœ¬ï¼š</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">javascript</span><span class="p">:</span> <span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">let</span> <span class="nx">ExtID</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span> <span class="dl">'</span><span class="s1">detail/</span><span class="dl">'</span> <span class="p">)[</span> <span class="mi">1</span> <span class="p">].</span><span class="nx">split</span><span class="p">(</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span> <span class="p">)[</span> <span class="mi">1</span> <span class="p">];</span>
	<span class="kd">let</span> <span class="nx">appname</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span> <span class="dl">'</span><span class="s1">detail/</span><span class="dl">'</span> <span class="p">)[</span> <span class="mi">1</span> <span class="p">].</span><span class="nx">split</span><span class="p">(</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">];</span>
	<span class="kd">let</span> <span class="nx">p1</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://clients2.google.com/service/update2/crx?response=redirect&amp;nacl_arch=&amp;prodversion=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span> <span class="dl">"</span><span class="s2">Chrome/</span><span class="dl">"</span> <span class="p">)[</span> <span class="mi">1</span> <span class="p">].</span><span class="nx">split</span><span class="p">(</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="p">)[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&amp;acceptformat=crx2,crx3&amp;x=id</span><span class="dl">"</span><span class="p">;</span>
	<span class="kd">let</span> <span class="nx">p2</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">%3D</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">ExtID</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">%26installsource%3Dondemand%26uc</span><span class="dl">"</span><span class="p">;</span>
	<span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">p1</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span> <span class="nb">decodeURIComponent</span><span class="p">(</span> <span class="nx">p2</span> <span class="p">)</span> <span class="p">);</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
<span class="p">}</span> <span class="p">)()</span>
</code></pre></div></div>

<p>å®é™…ä¸Šä¹Ÿå¯ä»¥é€šè¿‡æ’ä»¶ä¸‹è½½CRXï¼š<a href="https://chromewebstore.google.com/detail/get-crx/dijpllakibenlejkbajahncialkbdkjc">Get CRX</a>ã€‚</p>]]></content><author><name>acteds</name></author><category term="Chrome" /><summary type="html"><![CDATA[Chromeé€šè¿‡ä¹¦ç­¾è¿è¡Œjsä»£ç çš„å‘]]></summary></entry><entry><title type="html">æ‰‹æœºå»ºç«™</title><link href="/2024/12/27/%E6%89%8B%E6%9C%BA%E5%BB%BA%E7%AB%99/" rel="alternate" type="text/html" title="æ‰‹æœºå»ºç«™" /><published>2024-12-27T00:00:00+08:00</published><updated>2024-12-27T00:00:00+08:00</updated><id>/2024/12/27/%E6%89%8B%E6%9C%BA%E5%BB%BA%E7%AB%99</id><content type="html" xml:base="/2024/12/27/%E6%89%8B%E6%9C%BA%E5%BB%BA%E7%AB%99/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p>æ‰‹æœºå»ºç«™çš„æ–¹æ³•ã€‚</p>

<h1 id="android">Android</h1>

<h2 id="æ‰‹æœºå»ºç«™">æ‰‹æœºå»ºç«™</h2>

<p>ä¸‹è½½<a href="https://github.com/termux/termux-app">termux</a>ã€‚</p>

<p>æ‰“å¼€Termuxåï¼Œ è¾“å…¥</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt update
</code></pre></div></div>

<p>ç¡®ä¿æ‰‹æœºæ›´æ–°å¥½æºã€‚ç„¶åè¾“å…¥</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt <span class="nb">install </span>apache2
</code></pre></div></div>

<p>ä¹‹åå†è¯¢é—®ä¸­å›ç­”yå³å¯å®‰è£…ã€‚</p>

<p>å®‰è£…å¥½ä¹‹å Termuxçš„å‘½ä»¤è¡Œä¼šå˜æˆ$, å¦‚ä¸‹</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Setting up apache2 <span class="o">(</span>2.4.41-3<span class="o">)</span> ...
<span class="err">$</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ—¶å€™ä½ åªåœ¨$åéœ€è¦è¾“å…¥apachectl</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>apachectl
</code></pre></div></div>

<p>å³å¯è¿è¡Œapache</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»–ä¼šå¼¹å‡º</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AH00558: httpd: Could not reliably determine the server<span class="s1">'s fully qualified domain name, using l127.0.0.1. 
Set the '</span>ServerName<span class="s1">' directive globally to suppress this message
</span></code></pre></div></div>

<p>è¿™ä¸ªé—®é¢˜æš‚æ—¶ä¸ç”¨ç†ä»–</p>

<p>æ‰‹æœºé€šè¿‡<code class="language-plaintext highlighter-rouge">127.0.0.1:8080</code>è®¿é—®ï¼Œç”µè„‘é€šè¿‡è·¯ç”±å™¨ä¸­æ‰‹æœºçš„IPåœ°å€è®¿é—®ï¼Œä¾‹å¦‚<code class="language-plaintext highlighter-rouge">192.168.2.200:8080</code>åªè¦å‡ºç°<code class="language-plaintext highlighter-rouge">It Works</code>å³å¯è¯æ˜ç½‘é¡µæœåŠ¡å™¨å·¥ä½œã€‚</p>

<p>ç½‘é¡µæœåŠ¡å™¨ä½ç½®</p>

<p>è¾“å…¥</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ..
<span class="nv">$ </span><span class="nb">ls</span>
</code></pre></div></div>

<p>ä¹‹åä¼šå‡ºç°è“è‰²å­—ä½“</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>home usr
</code></pre></div></div>

<p>ç„¶åè¾“å…¥</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>usr/share/apache2
<span class="nv">$ </span><span class="nb">ls</span>
</code></pre></div></div>

<p>å¯ä»¥ä»è¿™é‡Œçœ‹å‡ºè“è‰²å­—ä½“çš„æ–‡ä»¶å¤¹æ˜¯</p>

<p><code class="language-plaintext highlighter-rouge">default-site</code> è€Œè¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢ï¼Œä¹Ÿè¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶å¤¹æ˜¯å«<code class="language-plaintext highlighter-rouge">htdocs</code>ï¼Œè¿›å…¥åˆ°<code class="language-plaintext highlighter-rouge">htdocs</code>æ–‡ä»¶å¤¹ä¹‹åï¼Œå³å¯å‘ç°<code class="language-plaintext highlighter-rouge">index.html</code>ï¼Œå®é™…å®Œæ•´åœ°å€ï¼š<code class="language-plaintext highlighter-rouge">/data/data/com.termux/files/usr/share/apache2/default-site/htdocs/</code></p>

<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯å½“Termuxè¢«å…³é—­åï¼Œapachectlä¹Ÿä¼šè¢«å…³é—­ã€‚</p>

<h2 id="ä¿®æ”¹ä½ç½®">ä¿®æ”¹ä½ç½®</h2>

<p>ä¿®æ”¹æ–‡ä»¶å¤¹æ˜ å°„ä½ç½®é€šå¸¸æ˜¯æŒ‡æ›´æ”¹WebæœåŠ¡å™¨é…ç½®ï¼Œä½¿å¾—URLè·¯å¾„æŒ‡å‘æœåŠ¡å™¨ä¸Šçš„ä¸åŒæ–‡ä»¶ç³»ç»Ÿä½ç½®ã€‚å¯¹äºApache HTTP Serverï¼Œè¿™å¯ä»¥é€šè¿‡ç¼–è¾‘å…¶é…ç½®æ–‡ä»¶æ¥å®ç°ã€‚ä»¥ä¸‹æ˜¯é’ˆå¯¹Apacheçš„æ­¥éª¤æŒ‡å—ï¼Œç”¨äºä¿®æ”¹æ–‡ä»¶å¤¹æ˜ å°„ä½ç½®ã€‚<strong>æ³¨æ„sdcardä½ç½®æ— æ³•ä¿®æ”¹æƒé™ã€‚</strong></p>

<p><strong>ç¡®å®šé…ç½®æ–‡ä»¶ä½ç½®</strong></p>

<p>Apacheçš„é…ç½®æ–‡ä»¶é€šå¸¸ä½äº<code class="language-plaintext highlighter-rouge">/etc/apache2/</code>ç›®å½•ä¸‹ï¼ˆå¯¹äºDebian/Ubuntuç³»ç»Ÿï¼‰æˆ–<code class="language-plaintext highlighter-rouge">/etc/httpd/</code>ï¼ˆå¯¹äºRed Hat/CentOSç³»ç»Ÿï¼‰ã€‚ä¸»é…ç½®æ–‡ä»¶é€šå¸¸æ˜¯<code class="language-plaintext highlighter-rouge">apache2.conf</code>æˆ–<code class="language-plaintext highlighter-rouge">httpd.conf</code>ï¼Œè€Œç«™ç‚¹ç‰¹å®šçš„é…ç½®åˆ™å¯èƒ½åœ¨<code class="language-plaintext highlighter-rouge">/etc/apache2/sites-available/</code>ä¸‹çš„ç‹¬ç«‹æ–‡ä»¶ä¸­ã€‚</p>

<p><strong>ä¿®æ”¹<code class="language-plaintext highlighter-rouge">DocumentRoot</code>å’Œ&lt;<code class="language-plaintext highlighter-rouge">Directory</code>&gt;æŒ‡ä»¤</strong></p>

<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶ä½äº<code class="language-plaintext highlighter-rouge">$PREFIX/etc/apache2/httpd.conf</code>ï¼ˆå…¶ä¸­<code class="language-plaintext highlighter-rouge">$PREFIX</code>æ˜¯Termuxçš„å‰ç¼€è·¯å¾„ï¼Œé»˜è®¤ä¸º<code class="language-plaintext highlighter-rouge">/data/data/com.termux/files/usr</code>ï¼‰ã€‚</p>

<p>ä¾‹å¦‚ï¼Œè¦æ›´æ”¹é»˜è®¤çš„æ–‡æ¡£æ ¹ç›®å½•ï¼Œéœ€è¦ç¼–è¾‘<code class="language-plaintext highlighter-rouge">httpd.conf</code>å¹¶æ›´æ–°<code class="language-plaintext highlighter-rouge">DocumentRoot</code>å’Œå¯¹åº”çš„<code class="language-plaintext highlighter-rouge">&lt;Directory&gt;</code>å—ï¼š</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DocumentRoot</span> "/data/data/com.termux/files/home/mywebroot"

<span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> "/data/data/com.termux/files/home/mywebroot"</span><span class="p">&gt;
</span>    <span class="nc">Options</span> <span class="ss">Indexes</span> <span class="ss">FollowSymLinks</span>
    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> granted
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p><strong>ä½¿ç”¨åˆ«åï¼ˆAliasï¼‰å’Œè„šæœ¬åˆ«åï¼ˆScriptAliasï¼‰</strong></p>

<p>å¦‚æœæƒ³å°†ä¸€ä¸ªç‰¹å®šçš„URLè·¯å¾„æ˜ å°„åˆ°ä¸€ä¸ªä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿä½ç½®è€Œä¸æ”¹å˜æ•´ä¸ªç½‘ç«™çš„æ ¹ç›®å½•ï¼Œå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Alias</code>æˆ–<code class="language-plaintext highlighter-rouge">ScriptAlias</code>æŒ‡ä»¤ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Alias</span> /images/ "/srv/images/"

<span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> "/srv/images"</span><span class="p">&gt;
</span>    <span class="nc">Options</span> <span class="ss">Indexes</span> <span class="ss">MultiViews</span>
    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> granted
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p>ä¸Šé¢çš„ä¾‹å­ä¼šå°†æ‰€æœ‰å¯¹<code class="language-plaintext highlighter-rouge">/images/</code>è·¯å¾„çš„è¯·æ±‚é‡å®šå‘åˆ°æœåŠ¡å™¨ä¸Šçš„<code class="language-plaintext highlighter-rouge">/srv/images/</code>ç›®å½•ã€‚</p>

<p><strong>ä½¿ç”¨ç¬¦å·é“¾æ¥ï¼ˆSymlinkï¼‰</strong></p>

<p>å¦ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè¿™å…è®¸ä½ ä¿æŒå½“å‰çš„é…ç½®ä¸å˜ï¼ŒåŒæ—¶è®©Apacheè®¿é—®å…¶ä»–ä½ç½®çš„æ–‡ä»¶ã€‚ä½ å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå·¥å…·å¦‚<code class="language-plaintext highlighter-rouge">ln -s</code>åˆ›å»ºç¬¦å·é“¾æ¥ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ln</span> <span class="nt">-s</span> /path/to/new/location /path/to/existing/location
</code></pre></div></div>

<hr />

<p><strong>åº”ç”¨æ›´æ”¹</strong></p>

<p>å®Œæˆä¸Šè¿°æ›´æ”¹åï¼Œè®°å¾—æµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apachectl configtest
<span class="c"># æˆ–è€…</span>
<span class="nb">sudo </span>apache2ctl configtest
</code></pre></div></div>

<p>å¦‚æœæµ‹è¯•ç»“æœæ˜¾ç¤ºé…ç½®æ­£ç¡®ï¼Œé‚£ä¹ˆä½ å¯ä»¥é‡æ–°å¯åŠ¨ApacheæœåŠ¡ä»¥åº”ç”¨æ›´æ”¹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apachectl restart
<span class="c"># æˆ–è€…</span>
<span class="nb">sudo </span>service apache2 restart
</code></pre></div></div>

<p>æ³¨æ„äº‹é¡¹</p>

<ul>
  <li>åœ¨è¿›è¡Œä»»ä½•æ›´æ”¹ä¹‹å‰ï¼Œè¯·ç¡®ä¿å¤‡ä»½äº†ç°æœ‰çš„é…ç½®æ–‡ä»¶ã€‚</li>
  <li>ä¿®æ”¹é…ç½®æ–‡ä»¶éœ€è¦rootæƒé™æˆ–sudoæƒé™ã€‚</li>
  <li>å¦‚æœä½ çš„Apacheé…ç½®åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼Œè¯·ç¡®ä¿ä½ åœ¨æ­£ç¡®çš„æ–‡ä»¶ä¸­è¿›è¡Œäº†æ›´æ”¹ã€‚</li>
  <li>å¯¹äºå¤æ‚çš„ç½‘ç«™ç»“æ„æˆ–å¤§é‡å­ç›®å½•ï¼Œè€ƒè™‘ä½¿ç”¨<code class="language-plaintext highlighter-rouge">.htaccess</code>æ–‡ä»¶æ¥å±€éƒ¨è¦†ç›–é…ç½®ï¼Œä½†è¯·æ³¨æ„æ€§èƒ½å½±å“ã€‚</li>
  <li>ä¿®æ”¹å®Œé…ç½®ååŠ¡å¿…æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ï¼Œå¹¶é‡å¯ApacheæœåŠ¡ä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚</li>
</ul>

<h2 id="å¤–éƒ¨å­˜å‚¨æƒé™é—®é¢˜">å¤–éƒ¨å­˜å‚¨æƒé™é—®é¢˜</h2>

<p>å¦‚æœä½ å¸Œæœ›å°†Apache2çš„Webç›®å½•è®¾ç½®ä¸ºå­˜å‚¨åœ¨<code class="language-plaintext highlighter-rouge">sdcard</code>ï¼ˆå¤–éƒ¨å­˜å‚¨ï¼‰ä¸Šçš„æ–‡ä»¶å¤¹ï¼Œé‚£ä¹ˆä½ éœ€è¦ç‰¹åˆ«æ³¨æ„æƒé™å’Œè·¯å¾„çš„é—®é¢˜ã€‚åœ¨Androidè®¾å¤‡ä¸Šï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºå¯¹<code class="language-plaintext highlighter-rouge">sdcard</code>çš„è®¿é—®æƒé™å¯èƒ½å—åˆ°é™åˆ¶ã€‚</p>

<p>ä»¥ä¸‹æ˜¯é…ç½®æ­¥éª¤å’Œæ³¨æ„äº‹é¡¹ï¼š</p>

<p><strong>ç¡®ä¿Termuxæœ‰é€‚å½“çš„æƒé™</strong></p>

<p>é¦–å…ˆï¼Œç¡®ä¿Termuxåº”ç”¨æœ¬èº«æœ‰æƒé™è®¿é—®ä½ çš„<code class="language-plaintext highlighter-rouge">sdcard</code>ã€‚ä½ å¯ä»¥é€šè¿‡Termuxçš„è®¾ç½®æˆ–Androidç³»ç»Ÿçš„åº”ç”¨æƒé™ç®¡ç†æ¥æˆäºˆè¿™äº›æƒé™ã€‚</p>

<ul>
  <li>æ‰“å¼€Androidçš„â€œè®¾ç½®â€ã€‚</li>
  <li>å¯»æ‰¾â€œåº”ç”¨ç¨‹åºâ€æˆ–â€œåº”ç”¨ç®¡ç†â€ã€‚</li>
  <li>æ‰¾åˆ°å¹¶é€‰æ‹©Termuxã€‚</li>
  <li>ç¡®è®¤å·²æˆäºˆå­˜å‚¨æƒé™ã€‚</li>
</ul>

<p>æ­¤å¤–ï¼Œåœ¨Termuxä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥å®‰è£…å¿…è¦çš„åŒ…ï¼Œå¹¶å¯ç”¨å¯¹<code class="language-plaintext highlighter-rouge">sdcard</code>çš„è®¿é—®ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pkg <span class="nb">install </span>termux-api
termux-setup-storage
</code></pre></div></div>

<p>è¿™å°†åœ¨Termuxä¸­åˆ›å»ºä¸€ä¸ªæŒ‡å‘<code class="language-plaintext highlighter-rouge">sdcard</code>çš„ç¬¦å·é“¾æ¥ï¼Œé€šå¸¸ä½äº<code class="language-plaintext highlighter-rouge">~/storage/</code>ä¸‹ã€‚</p>

<p><strong>è®¾ç½®æ­£ç¡®çš„<code class="language-plaintext highlighter-rouge">DocumentRoot</code>è·¯å¾„</strong></p>

<p>æ¥ä¸‹æ¥ï¼Œç¼–è¾‘Apache2çš„é…ç½®æ–‡ä»¶ä»¥æ­£ç¡®åœ°æŒ‡å‘<code class="language-plaintext highlighter-rouge">sdcard</code>ä¸Šçš„ç›®å½•ã€‚å‡è®¾ä½ æƒ³å°†Webæ ¹ç›®å½•è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">sdcard</code>ä¸‹çš„<code class="language-plaintext highlighter-rouge">www</code>æ–‡ä»¶å¤¹ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹è·¯å¾„ï¼š</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DocumentRoot</span> "/data/data/com.termux/files/home/storage/shared/www"

<span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> "/data/data/com.termux/files/home/storage/shared/www"</span><span class="p">&gt;
</span>    <span class="nc">Options</span> <span class="ss">Indexes</span> <span class="ss">FollowSymLinks</span>
    <span class="nc">AllowOverride</span> <span class="ss">None</span>
    <span class="nc">Require</span> <span class="ss">all</span> granted
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p>è¯·æ³¨æ„ï¼Œ<code class="language-plaintext highlighter-rouge">/data/data/com.termux/files/home/storage/shared/</code>æ˜¯Termuxåˆ›å»ºçš„é»˜è®¤ç¬¦å·é“¾æ¥ä½ç½®ï¼ŒæŒ‡å‘<code class="language-plaintext highlighter-rouge">sdcard</code>ã€‚å¦‚æœä½ çš„è·¯å¾„ä¸åŒï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ã€‚</p>

<p><strong>æ£€æŸ¥å¹¶è®¾ç½®æ–‡ä»¶å’Œç›®å½•æƒé™</strong></p>

<p>ç¡®ä¿<code class="language-plaintext highlighter-rouge">sdcard</code>ä¸Šçš„æ–‡ä»¶å’Œç›®å½•å…·æœ‰é€‚å½“çš„æƒé™ã€‚ä½ å¯èƒ½éœ€è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">chmod</code>å’Œ<code class="language-plaintext highlighter-rouge">chown</code>å‘½ä»¤æ¥ç¡®ä¿Apacheå¯ä»¥è¯»å–è¿™äº›æ–‡ä»¶ã€‚ç„¶è€Œï¼Œç”±äº<code class="language-plaintext highlighter-rouge">sdcard</code>ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿé€šå¸¸æ˜¯FAT32æˆ–exFATï¼Œå®ƒä»¬ä¸æ”¯æŒLinuxé£æ ¼çš„æƒé™è®¾ç½®ã€‚å› æ­¤ï¼Œç¡®ä¿Apacheè¿è¡Œæ—¶ä½¿ç”¨çš„ç”¨æˆ·æœ‰æƒè®¿é—®<code class="language-plaintext highlighter-rouge">sdcard</code>ã€‚</p>

<p><strong>é…ç½®SELinuxï¼ˆå¦‚æœé€‚ç”¨ï¼‰</strong></p>

<p>æŸäº›Androidç‰ˆæœ¬å¯èƒ½ä¼šå¯ç”¨SELinuxï¼Œå®ƒä¼šè¿›ä¸€æ­¥é™åˆ¶æ–‡ä»¶è®¿é—®ã€‚å¦‚æœä½ é‡åˆ°æƒé™é—®é¢˜ï¼Œå³ä½¿çœ‹èµ·æ¥æ‰€æœ‰æƒé™éƒ½å·²ç»æ­£ç¡®è®¾ç½®ï¼Œä½ å¯èƒ½éœ€è¦è°ƒæ•´SELinuxç­–ç•¥æˆ–æš‚æ—¶å°†å…¶è®¾ç½®ä¸ºå®½å®¹æ¨¡å¼ï¼ˆpermissiveï¼‰ã€‚ä¸è¿‡ï¼Œæ”¹å˜SELinuxé…ç½®éœ€è¦rootæƒé™ï¼Œè€Œä¸”è¿™ä¸æ˜¯æ¨èçš„åšæ³•ï¼Œå› ä¸ºå®ƒä¼šå½±å“æ•´ä¸ªç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p>

<p><strong>æµ‹è¯•é…ç½®å¹¶é‡å¯Apache</strong></p>

<p>å®Œæˆä¸Šè¿°æ›´æ”¹åï¼Œæµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼Œå¹¶é‡å¯ApacheæœåŠ¡ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl configtest
apachectl restart
</code></pre></div></div>

<p><strong>æ£€æŸ¥Apacheé”™è¯¯æ—¥å¿—</strong></p>

<p>å¦‚æœä»ç„¶é‡åˆ°é—®é¢˜ï¼Œæ£€æŸ¥Apacheçš„é”™è¯¯æ—¥å¿—å¯ä»¥å¸®åŠ©è¯Šæ–­é—®é¢˜ã€‚é”™è¯¯æ—¥å¿—é€šå¸¸ä½äºï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> /data/data/com.termux/files/usr/var/log/apache2/error_log
</code></pre></div></div>

<p>æ³¨æ„äº‹é¡¹</p>

<ul>
  <li><strong>æ€§èƒ½å’Œå®‰å…¨</strong>ï¼šå°†Webæ ¹ç›®å½•è®¾ç½®åœ¨<code class="language-plaintext highlighter-rouge">sdcard</code>ä¸Šå¯èƒ½å½±å“æ€§èƒ½ï¼Œå› ä¸ºå¤–éƒ¨å­˜å‚¨é€šå¸¸æ¯”å†…éƒ¨å­˜å‚¨æ…¢ã€‚æ­¤å¤–ï¼Œä»å®‰å…¨è§’åº¦æ¥çœ‹ï¼Œå°†Webå†…å®¹æ”¾åœ¨å¤–éƒ¨å­˜å‚¨ä¸Šä¹Ÿå­˜åœ¨é£é™©ï¼Œå°¤å…¶æ˜¯å½“è®¾å¤‡ä¸¢å¤±æˆ–è¢«ç›—æ—¶ã€‚</li>
  <li><strong>æŒä¹…æ€§</strong>ï¼šä¸€äº›Androidè®¾å¤‡åœ¨é‡æ–°å¯åŠ¨åå¯èƒ½ä¼šæ”¹å˜<code class="language-plaintext highlighter-rouge">sdcard</code>çš„æŒ‚è½½ç‚¹æˆ–æ’¤é”€ä¹‹å‰æˆäºˆçš„æƒé™ã€‚å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µï¼Œå¯èƒ½éœ€è¦æ¯æ¬¡å¯åŠ¨åé‡æ–°è®¾ç½®æƒé™æˆ–ä½¿ç”¨è„šæœ¬è‡ªåŠ¨åŒ–è¿™ä¸€è¿‡ç¨‹ã€‚</li>
</ul>

<hr />

<p>åœ¨Androidè®¾å¤‡ä¸Šï¼Œ<code class="language-plaintext highlighter-rouge">sdcard</code>ï¼ˆå¤–éƒ¨å­˜å‚¨ï¼‰çš„ä½ç½®é€šå¸¸ä½¿ç”¨FAT32æˆ–exFATæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä»¬ä¸æ”¯æŒLinuxé£æ ¼çš„æƒé™è®¾ç½®ã€‚è¿™æ„å‘³ç€ä½ ä¸èƒ½ç›´æ¥ä¿®æ”¹è¿™äº›ä½ç½®ä¸Šçš„æ–‡ä»¶å’Œç›®å½•æƒé™ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸æ„å‘³ç€ä½ æ— æ³•è®©Apacheè®¿é—®è¿™äº›æ–‡ä»¶ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹æ³•æ¥è§£å†³é—®é¢˜ï¼š</p>

<p><strong>ä½¿ç”¨ç¬¦å·é“¾æ¥</strong></p>

<p>åˆ›å»ºä¸€ä¸ªæŒ‡å‘<code class="language-plaintext highlighter-rouge">sdcard</code>ä¸Šçš„æ–‡ä»¶å¤¹çš„ç¬¦å·é“¾æ¥åˆ°Termuxçš„å†…éƒ¨å­˜å‚¨ä¸­ï¼Œè¿™æ ·ä½ å¯ä»¥åœ¨å†…éƒ¨å­˜å‚¨ä¸­è®¾ç½®Apacheçš„<code class="language-plaintext highlighter-rouge">DocumentRoot</code>ã€‚ç”±äºApacheè¿è¡Œæ—¶ä½¿ç”¨çš„ç”¨æˆ·é€šå¸¸å¯¹å†…éƒ¨å­˜å‚¨æœ‰é€‚å½“çš„æƒé™ï¼Œè¿™å¯ä»¥ç»•è¿‡æƒé™é—®é¢˜ã€‚</p>

<p>åˆ›å»ºç¬¦å·é“¾æ¥æ­¥éª¤ï¼š</p>

<p><strong>ç¡®ä¿å·²æˆäºˆTermuxå­˜å‚¨æƒé™</strong>ï¼š</p>

<p>è¿è¡Œ<code class="language-plaintext highlighter-rouge">termux-setup-storage</code>ä»¥åˆ›å»ºå¿…è¦çš„ç¬¦å·é“¾æ¥ã€‚</p>

<p><strong>åˆ›å»ºç¬¦å·é“¾æ¥</strong>ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">ln</span> <span class="nt">-s</span> /storage/emulated/0/acteds.github.io-built ~/www
</code></pre></div></div>

<p><strong>é…ç½®Apacheä½¿ç”¨æ–°çš„è·¯å¾„</strong>ï¼š</p>

<p>ä¿®æ”¹ä½ çš„Apacheé…ç½®æ–‡ä»¶ï¼Œå°†<code class="language-plaintext highlighter-rouge">DocumentRoot</code>è®¾ç½®ä¸ºè¿™ä¸ªæ–°çš„ç¬¦å·é“¾æ¥è·¯å¾„ï¼š</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DocumentRoot</span> "/data/data/com.termux/files/home/www"

<span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> "/data/data/com.termux/files/home/www"</span><span class="p">&gt;
</span>  <span class="nc">Options</span> <span class="ss">Indexes</span> <span class="ss">FollowSymLinks</span>
  <span class="nc">AllowOverride</span> <span class="ss">None</span>
  <span class="nc">Require</span> <span class="ss">all</span> granted
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span></code></pre></div></div>

<p><strong>ä¿®æ”¹SELinuxç­–ç•¥ï¼ˆå¦‚æœé€‚ç”¨ï¼‰</strong></p>

<p>å¦‚æœä½ çš„è®¾å¤‡å¯ç”¨äº†SELinuxï¼Œå®ƒå¯èƒ½ä¼šè¿›ä¸€æ­¥é™åˆ¶å¯¹<code class="language-plaintext highlighter-rouge">sdcard</code>çš„è®¿é—®ã€‚è™½ç„¶ä¿®æ”¹SELinuxç­–ç•¥éœ€è¦rootæƒé™ï¼Œå¹¶ä¸”å¯èƒ½å½±å“ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œä½†ä½ å¯ä»¥å°è¯•ä¸´æ—¶å°†SELinuxè®¾ç½®ä¸ºå®½å®¹æ¨¡å¼ï¼ˆpermissiveï¼‰ï¼Œçœ‹çœ‹æ˜¯å¦è§£å†³äº†é—®é¢˜ã€‚è¿™ä¸æ˜¯æ¨èçš„åšæ³•ï¼Œä½†å®ƒå¯ä»¥å¸®åŠ©è¯Šæ–­é—®é¢˜ã€‚</p>

<p><strong>ä½¿ç”¨å†…éƒ¨å­˜å‚¨</strong></p>

<p>æœ€ç®€å•çš„æ–¹æ³•å¯èƒ½æ˜¯å°†ä½ çš„Webå†…å®¹æ”¾ç½®åœ¨Termuxçš„å†…éƒ¨å­˜å‚¨ä¸­ï¼Œè€Œä¸æ˜¯<code class="language-plaintext highlighter-rouge">sdcard</code>ã€‚å†…éƒ¨å­˜å‚¨é»˜è®¤å…·æœ‰æ›´å®½æ¾çš„æƒé™ï¼Œæ›´å®¹æ˜“é…ç½®ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥å°†ç½‘ç«™æ–‡ä»¶æ”¾åœ¨<code class="language-plaintext highlighter-rouge">~/www</code>ç›®å½•ä¸‹ï¼Œå¹¶æŒ‰ç…§ä¸Šè¿°æ–¹å¼é…ç½®Apacheã€‚</p>

<p><strong>ç¡®è®¤Apacheè¿è¡Œç”¨æˆ·</strong></p>

<p>ç¡®ä¿ApacheæœåŠ¡æ˜¯ä»¥èƒ½å¤Ÿè®¿é—®<code class="language-plaintext highlighter-rouge">sdcard</code>çš„ç”¨æˆ·èº«ä»½è¿è¡Œã€‚ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯æ¥ç¡®è®¤è¿™ä¸€ç‚¹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps aux | <span class="nb">grep </span>httpd
</code></pre></div></div>

<p>ç¡®ä¿è¯¥è¿›ç¨‹ç”±æ‹¥æœ‰è¶³å¤Ÿæƒé™çš„ç”¨æˆ·è¿è¡Œï¼Œé€šå¸¸æ˜¯å¯åŠ¨Termuxçš„ç”¨æˆ·ã€‚</p>

<p><strong>æ€»ç»“</strong></p>

<p>é‰´äº<code class="language-plaintext highlighter-rouge">sdcard</code>ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒLinuxæƒé™è®¾ç½®ï¼Œæœ€å¯é çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†ç½‘ç«™æ–‡ä»¶ç§»åŠ¨åˆ°Termuxçš„å†…éƒ¨å­˜å‚¨ä¸­ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªæŒ‡å‘<code class="language-plaintext highlighter-rouge">sdcard</code>ä¸Šæ–‡ä»¶å¤¹çš„ç¬¦å·é“¾æ¥ã€‚è¿™ä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥æœ‰æ•ˆåœ°ç»•è¿‡æƒé™é™åˆ¶ï¼Œå¹¶å…è®¸Apacheæ­£å¸¸è®¿é—®ä½ çš„ç½‘ç«™æ–‡ä»¶ã€‚</p>

<h2 id="apache2å¸¸ç”¨å‘½ä»¤">apache2å¸¸ç”¨å‘½ä»¤</h2>

<p>åœ¨Termuxç¯å¢ƒä¸­ä½¿ç”¨Apache HTTP Serverï¼ˆ<code class="language-plaintext highlighter-rouge">apache2</code>ï¼‰æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">apachectl</code>å·¥å…·æ¥ç®¡ç†æœåŠ¡å™¨ã€‚Termuxæ˜¯ä¸€ä¸ªAndroidç»ˆç«¯æ¨¡æ‹Ÿå™¨å’ŒLinuxç¯å¢ƒåº”ç”¨ï¼Œå®ƒå…è®¸ä½ åœ¨æ²¡æœ‰rootæƒé™çš„æƒ…å†µä¸‹è¿è¡Œä¸€ä¸ªLinuxç¯å¢ƒã€‚ä»¥ä¸‹æ˜¯ä¸€äº›åœ¨Termuxä¸­ç®¡ç†<code class="language-plaintext highlighter-rouge">apache2</code>æœåŠ¡çš„å¸¸ç”¨å‘½ä»¤ï¼š</p>

<p>å¯åŠ¨ã€åœæ­¢å’Œé‡å¯Apache</p>

<p><strong>å¯åŠ¨Apache</strong>ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl start
</code></pre></div></div>

<p><strong>åœæ­¢Apache</strong>ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl stop
</code></pre></div></div>

<p><strong>é‡å¯Apache</strong>ï¼ˆè¿™ä¼šå…ˆåœæ­¢å†å¯åŠ¨æœåŠ¡ï¼‰ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl restart
</code></pre></div></div>

<p><strong>é‡è½½é…ç½®æ–‡ä»¶è€Œä¸ä¸­æ–­å½“å‰è¿æ¥</strong>ï¼ˆå½“ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ä½†ä¸æƒ³å®Œå…¨é‡å¯æœåŠ¡æ—¶ä½¿ç”¨ï¼‰ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl graceful
</code></pre></div></div>

<p>æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•</p>

<p><strong>æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯</strong>ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl configtest
</code></pre></div></div>

<p>æŸ¥çœ‹çŠ¶æ€</p>

<p><strong>æŸ¥çœ‹Apacheçš„çŠ¶æ€</strong>ï¼ˆæ˜¯å¦æ­£åœ¨è¿è¡Œç­‰ä¿¡æ¯ï¼‰ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl status
</code></pre></div></div>
<p>æ³¨æ„ï¼šä¸ºäº†ä½¿<code class="language-plaintext highlighter-rouge">status</code>å‘½ä»¤å·¥ä½œï¼Œä½ å¯èƒ½éœ€è¦å®‰è£…é¢å¤–çš„è½¯ä»¶åŒ…ï¼Œå¦‚<code class="language-plaintext highlighter-rouge">procps</code>ï¼Œå¹¶ä¸”ç¡®ä¿<code class="language-plaintext highlighter-rouge">mod_status</code>æ¨¡å—å·²ç»å¯ç”¨ã€‚</p>

<p>å¯ç”¨æˆ–ç¦ç”¨æ¨¡å—</p>

<p><strong>å¯ç”¨æ¨¡å—</strong>ï¼ˆä¾‹å¦‚<code class="language-plaintext highlighter-rouge">rewrite</code>æ¨¡å—ï¼‰ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a2enmod rewrite
</code></pre></div></div>

<p><strong>ç¦ç”¨æ¨¡å—</strong>ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a2dismod rewrite
</code></pre></div></div>

<p>å¯ç”¨æˆ–ç¦ç”¨ç«™ç‚¹</p>

<p><strong>å¯ç”¨ç«™ç‚¹é…ç½®</strong>ï¼ˆå‡è®¾ç«™ç‚¹åä¸º<code class="language-plaintext highlighter-rouge">example.com</code>ï¼‰ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a2ensite example.com
</code></pre></div></div>

<p><strong>ç¦ç”¨ç«™ç‚¹é…ç½®</strong>ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a2dissite example.com
</code></pre></div></div>

<p>åº”ç”¨æ›´æ”¹</p>

<p>å®Œæˆé…ç½®æ–‡ä»¶ç¼–è¾‘åï¼Œè®°å¾—æµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯ï¼Œå¹¶é‡å¯Apacheä»¥åº”ç”¨æ›´æ”¹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apachectl configtest
apachectl restart
</code></pre></div></div>

<p>æ³¨æ„äº‹é¡¹</p>

<ul>
  <li>åœ¨è¿›è¡Œä»»ä½•æ›´æ”¹ä¹‹å‰ï¼Œè¯·å¤‡ä»½ç°æœ‰çš„é…ç½®æ–‡ä»¶ã€‚</li>
  <li>ä¿®æ”¹é…ç½®æ–‡ä»¶å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œåœ¨Termuxä¸­å¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">pkg install proot-distro</code>æ¥å®‰è£…ä¸€ä¸ªæ›´å®Œæ•´çš„Linuxå‘è¡Œç‰ˆï¼Œä»è€Œè·å¾—æ›´å¥½çš„æƒé™æ§åˆ¶ã€‚</li>
</ul>]]></content><author><name>acteds</name></author><category term="Android" /><summary type="html"><![CDATA[å®‰å“ç¬”è®°]]></summary></entry><entry><title type="html">SecureRandom</title><link href="/2024/12/24/SecureRandom/" rel="alternate" type="text/html" title="SecureRandom" /><published>2024-12-24T00:00:00+08:00</published><updated>2024-12-24T00:00:00+08:00</updated><id>/2024/12/24/SecureRandom</id><content type="html" xml:base="/2024/12/24/SecureRandom/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p><code class="language-plaintext highlighter-rouge">SecureRandom</code>éšæœºæ•°çš„å‘ï¼Œjava8ç‰ˆæœ¬ä¸java17ç‰ˆæœ¬çš„è¯¥ç±»åº•å±‚åŸç†ä¸åŒã€‚</p>

<h1 id="securerandom">SecureRandom</h1>

<h2 id="é—®é¢˜å¤ç°">é—®é¢˜å¤ç°</h2>

<p>åœºæ™¯ï¼šéœ€è¦å¯¹å­˜å…¥æ•°æ®åº“çš„æ•æ„Ÿæ•°æ®è¿›è¡Œéå¯¹ç§°åŠ å¯†ï¼Œå¯¹äºä¸æ¶‰åŠåŠ å¯†æ•°æ®çš„æŸ¥è¯¢ï¼Œæ— æ‰€è°“éšæœºæ•°æ˜¯å¦å›ºå®šï¼Œä½†å¯¹äºæ¶‰åŠåŠ å¯†æ•°æ®çš„æŸ¥è¯¢ï¼Œå°±éœ€è¦å›ºå®šéšæœºæ•°äº†ã€‚å› æ­¤æœ‰å¦‚ä¸‹æ–¹æ³•ç”¨æ¥åŠ å¯†ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * SM2åŠ å¯†
     *
     * @param data      å¾…åŠ å¯†æ•°æ®
     * @return åŠ å¯†åçš„æ•°æ®
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">sm2Encrypt</span><span class="o">(</span> <span class="nc">String</span> <span class="n">data</span><span class="o">){</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">isNotNull</span><span class="o">(</span><span class="n">data</span><span class="o">)){</span>
                <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">//ä½¿ç”¨å›ºå®šéšæœºæ•°</span>
            <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span><span class="o">();</span>
            <span class="n">random</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="nc">ECPublicKeyParameters</span> <span class="n">publicKeyParam</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ECPublicKeyParameters</span><span class="o">)</span> <span class="nc">PublicKeyFactory</span><span class="o">.</span><span class="na">createKey</span><span class="o">(</span><span class="n">getPublicKey</span><span class="o">().</span><span class="na">getEncoded</span><span class="o">());</span>
            <span class="nc">CipherParameters</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ParametersWithRandom</span><span class="o">(</span><span class="n">publicKeyParam</span><span class="o">,</span> <span class="n">random</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">encrypt</span> <span class="o">=</span> <span class="n">iniSmUtil</span><span class="o">().</span><span class="na">encrypt</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span><span class="n">parameters</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">base64String</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">encodeBase64String</span><span class="o">(</span><span class="n">encrypt</span><span class="o">);</span>
            <span class="c1">//è½¬16è¿›åˆ¶åè¿”å›</span>
            <span class="k">return</span> <span class="nc">HexUtil</span><span class="o">.</span><span class="na">encodeHexStr</span><span class="o">(</span><span class="n">base64String</span><span class="o">,</span> <span class="nc">CharsetUtil</span><span class="o">.</span><span class="na">CHARSET_UTF_8</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"SM2æ•°æ®åŠ å¯†å¼‚å¸¸:"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span><span class="o">();</span>
<span class="n">random</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</code></pre></div></div>

<p>å°±æ˜¯å›ºå®šéšæœºæ•°ã€‚æµ‹è¯•åœ¨Java8ä¸­ç›¸åŒç§å­æ˜¯å¦è¿”å›ç›¸åŒçš„éšæœºæ•°ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨å›ºå®šéšæœºæ•°</span>
<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span><span class="o">();</span>
    <span class="n">random</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
<span class="o">}</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">set</span><span class="o">);</span><span class="c1">//[-1765061395]</span>
</code></pre></div></div>

<p><strong>ç›¸åŒ</strong>ï¼Œåœ¨Java17ä¸­ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span><span class="o">();</span>
    <span class="n">random</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
<span class="o">}</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">set</span><span class="o">.</span><span class="na">size</span><span class="o">());</span><span class="c1">//10000</span>
</code></pre></div></div>

<p><strong>ä¸ç›¸åŒ</strong>ã€‚å®é™…ä¸Šæ˜¯<code class="language-plaintext highlighter-rouge">SecureRandom</code>çš„åº•å±‚éšæœºæ•°ç®—æ³•å‘ç”Ÿäº†å˜åŒ–ã€‚</p>

<h2 id="åŸºæœ¬ç”¨æ³•">åŸºæœ¬ç”¨æ³•</h2>

<p><code class="language-plaintext highlighter-rouge">SecureRandom</code> æ˜¯ä¸€ä¸ªæä¾›åŠ å¯†å¼ºéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆRNGï¼‰çš„ç±»ï¼Œç”¨äºç”Ÿæˆç¬¦åˆåŠ å¯†è¦æ±‚çš„éšæœºæ•°ã€‚</p>

<p><strong>åŠ å¯†å¼ºéšæœºæ•°</strong>ï¼š</p>
<ul>
  <li>åŠ å¯†å¼ºéšæœºæ•°æ˜¯æŒ‡ç¬¦åˆç»Ÿè®¡éšæœºæ•°ç”Ÿæˆå™¨æµ‹è¯•è¦æ±‚çš„éšæœºæ•°ï¼Œæ»¡è¶³ FIPS 140-2 å’Œ RFC 4086 çš„è¦æ±‚ï¼Œå¿…é¡»ç”Ÿæˆä¸å¯é¢„æµ‹çš„è¾“å‡ºã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">SecureRandom</code> å¿…é¡»ç”Ÿæˆéç¡®å®šæ€§è¾“å‡ºï¼Œå³æ¯æ¬¡ç”Ÿæˆçš„ç»“æœåº”è¯¥æ˜¯éšæœºä¸”éš¾ä»¥é¢„æµ‹çš„ã€‚</li>
</ul>

<p><strong>ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆPRNGï¼‰ä¸çœŸéšæœºæ•°</strong>ï¼š</p>
<ul>
  <li>å¤§å¤šæ•° <code class="language-plaintext highlighter-rouge">SecureRandom</code> çš„å®ç°æ˜¯åŸºäºä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼ˆPRNGï¼‰ï¼Œå³ä½¿ç”¨ç¡®å®šæ€§çš„ç®—æ³•ä»éšæœºç§å­ç”Ÿæˆä¼ªéšæœºæ•°åºåˆ—ã€‚</li>
  <li>ä¹Ÿæœ‰ä¸€äº›å®ç°é€šè¿‡ç¡¬ä»¶æˆ–ç¯å¢ƒå™ªå£°ç­‰ç‰©ç†æ–¹å¼ç”ŸæˆçœŸéšæœºæ•°ã€‚</li>
  <li>è¿˜æœ‰ä¸€äº›å®ç°ä¼šç»“åˆè¿™ä¸¤ç§æŠ€æœ¯ã€‚</li>
</ul>

<p><strong>è·å– <code class="language-plaintext highlighter-rouge">SecureRandom</code> å®ä¾‹</strong>ï¼š</p>

<p>å¯ä»¥é€šè¿‡æ— å‚æ„é€ å‡½æ•°æˆ– <code class="language-plaintext highlighter-rouge">getInstance</code> æ–¹æ³•è·å– <code class="language-plaintext highlighter-rouge">SecureRandom</code> å®ä¾‹ï¼Œå¹¶æŒ‡å®šå…·ä½“çš„éšæœºæ•°ç”Ÿæˆç®—æ³•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SecureRandom</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span><span class="o">();</span> <span class="c1">// é»˜è®¤</span>
<span class="nc">SecureRandom</span> <span class="n">r2</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"NativePRNG"</span><span class="o">);</span> <span class="c1">// ä½¿ç”¨ç‰¹å®šç®—æ³•</span>
<span class="nc">SecureRandom</span> <span class="n">r3</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"DRBG"</span><span class="o">,</span> <span class="nc">DrbgParameters</span><span class="o">.</span><span class="na">instantiation</span><span class="o">(</span><span class="mi">128</span><span class="o">,</span> <span class="no">RESEED_ONLY</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span> <span class="c1">// ä½¿ç”¨ DRBG ç®—æ³•</span>
</code></pre></div></div>

<p><strong>ç”Ÿæˆéšæœºå­—èŠ‚</strong>ï¼š</p>

<p>å¸¸ç”¨çš„æ–¹æ³•æ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">nextBytes(byte[] bytes)</code> ç”Ÿæˆéšæœºå­—èŠ‚æ•°ç»„ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span><span class="o">();</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">20</span><span class="o">];</span>
<span class="n">random</span><span class="o">.</span><span class="na">nextBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>ç”Ÿæˆç§å­</strong>ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">generateSeed</code> æ–¹æ³•å¯ä»¥ç”¨æ¥ç”Ÿæˆä¸€å®šæ•°é‡çš„ç§å­å­—èŠ‚ï¼Œé€šå¸¸ç”¨äºç»™å…¶ä»–éšæœºæ•°ç”Ÿæˆå™¨æä¾›ç§å­ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">byte</span><span class="o">[]</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">generateSeed</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>è‡ªæˆ‘æ’­ç§</strong>ï¼š</p>
<ul>
  <li>æ–°åˆ›å»ºçš„ PRNG <code class="language-plaintext highlighter-rouge">SecureRandom</code> å¯¹è±¡ä¸ä¼šè‡ªåŠ¨æ’­ç§ï¼Œé™¤éæ˜¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">SecureRandom(byte[])</code> æ„é€ å‡½æ•°åˆ›å»ºçš„ã€‚</li>
  <li>å¦‚æœæ²¡æœ‰æ˜¾å¼è°ƒç”¨ <code class="language-plaintext highlighter-rouge">setSeed</code>ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">nextBytes</code> æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä»å®ç°ç‰¹å®šçš„ç†µæºæ’­ç§è‡ªå·±ã€‚</li>
</ul>

<p><strong>é‡æ’­ç§</strong>ï¼š</p>
<ul>
  <li>å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">reseed</code> æˆ– <code class="language-plaintext highlighter-rouge">setSeed</code> æ–¹æ³•å¯¹ <code class="language-plaintext highlighter-rouge">SecureRandom</code> è¿›è¡Œé‡æ’­ç§ã€‚<code class="language-plaintext highlighter-rouge">reseed</code> æ–¹æ³•ä¼šä»ç†µæºè¯»å–è¾“å…¥è¿›è¡Œé‡æ’­ç§ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">setSeed</code> æ–¹æ³•åˆ™éœ€è¦æ˜¾å¼æä¾›ç§å­ã€‚</li>
  <li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶éæ‰€æœ‰å®ç°éƒ½æ”¯æŒ <code class="language-plaintext highlighter-rouge">reseed</code>ã€‚</li>
</ul>

<p><strong>æ”¯æŒçš„å®ç°å’Œçº¿ç¨‹å®‰å…¨æ€§</strong>ï¼š</p>
<ul>
  <li>ä¸€äº› <code class="language-plaintext highlighter-rouge">SecureRandom</code> å®ç°å¯èƒ½ä¼šæ¥å— <code class="language-plaintext highlighter-rouge">SecureRandomParameters</code> å‚æ•°æ¥è¿›ä¸€æ­¥æ§åˆ¶æ–¹æ³•è¡Œä¸ºã€‚</li>
  <li>æ ¹æ®å®ç°çš„ä¸åŒï¼Œ<code class="language-plaintext highlighter-rouge">generateSeed</code>ã€<code class="language-plaintext highlighter-rouge">reseed</code> å’Œ <code class="language-plaintext highlighter-rouge">nextBytes</code> æ–¹æ³•å¯èƒ½ä¼šé˜»å¡ï¼Œå°¤å…¶æ˜¯å½“ç†µæºæ˜¯ <code class="language-plaintext highlighter-rouge">/dev/random</code>ï¼ˆåœ¨ç±» Unix æ“ä½œç³»ç»Ÿä¸Šï¼‰æ—¶ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">SecureRandom</code> å¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨å¤šä¸ªå¹¶å‘çº¿ç¨‹ä¸­ä½¿ç”¨ã€‚</li>
</ul>

<p><strong>çº¿ç¨‹å®‰å…¨</strong>ï¼š</p>
<ul>
  <li>å¦‚æœ <code class="language-plaintext highlighter-rouge">SecureRandom</code> æœåŠ¡æä¾›è€…æ”¯æŒçº¿ç¨‹å®‰å…¨ï¼Œåˆ™ä¼šåœ¨æœåŠ¡æä¾›è€…æ³¨å†Œæ—¶è®¾ç½®â€œThreadSafeâ€å±æ€§ä¸ºâ€œtrueâ€ã€‚</li>
  <li>å¦‚æœæ²¡æœ‰å£°æ˜çº¿ç¨‹å®‰å…¨ï¼Œ<code class="language-plaintext highlighter-rouge">SecureRandom</code> ä¼šé€šè¿‡åŒæ­¥æ¥ç¡®ä¿ä»¥ä¸‹æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ï¼š</li>
  <li><code class="language-plaintext highlighter-rouge">engineSetSeed(byte[])</code></li>
  <li><code class="language-plaintext highlighter-rouge">engineNextBytes(byte[])</code></li>
  <li><code class="language-plaintext highlighter-rouge">engineGenerateSeed(int)</code></li>
  <li><code class="language-plaintext highlighter-rouge">engineReseed(SecureRandomParameters)</code></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">SecureRandom</code> æ˜¯ Java æä¾›çš„ä¸€ä¸ªåŠ å¯†å¼ºåº¦çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œå®ƒå¯ä»¥ç”Ÿæˆé€‚ç”¨äºåŠ å¯†ã€å¯†ç å­¦å’Œå…¶ä»–å®‰å…¨åº”ç”¨çš„éšæœºæ•°ã€‚è¯¥ç±»æ”¯æŒå¤šç§éšæœºæ•°ç”Ÿæˆç®—æ³•ï¼ŒåŒ…æ‹¬ä¼ªéšæœºæ•°ç”Ÿæˆç®—æ³•å’ŒçœŸéšæœºæ•°ç”Ÿæˆç®—æ³•ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡ä¸åŒçš„æ–¹å¼è·å– <code class="language-plaintext highlighter-rouge">SecureRandom</code> å®ä¾‹ï¼Œå¹¶ç”Ÿæˆéšæœºå­—èŠ‚æˆ–ç§å­ã€‚<code class="language-plaintext highlighter-rouge">SecureRandom</code> å¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p>

<h2 id="æ•°å­—ç”Ÿæˆç®—æ³•">æ•°å­—ç”Ÿæˆç®—æ³•</h2>

<p>SecureRandom æœ‰å¦‚ä¸‹æ•°å­—ç”Ÿæˆç®—æ³•ï¼š<a href="https://docs.oracle.com/en/java/javase/17/docs/specs/security/standard-names.html#securerandom-number-generation-algorithms">Java Security Standard Algorithm Names</a></p>

<table>
  <thead>
    <tr>
      <th>ç®—æ³•åç§°</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>NativePRNG</strong></td>
      <td>ä»åº•å±‚æ“ä½œç³»ç»Ÿè·å–éšæœºæ•°ã€‚æ²¡æœ‰å¯¹ç”Ÿæˆè¿™äº›æ•°å­—çš„é˜»å¡æ€§è´¨åšå‡ºä»»ä½•å£°æ˜ã€‚</td>
    </tr>
    <tr>
      <td><strong>NativePRNGBlocking</strong></td>
      <td>ä»åº•å±‚æ“ä½œç³»ç»Ÿè·å–éšæœºæ•°ï¼Œå¿…è¦æ—¶ä¼šé˜»å¡ã€‚ä¾‹å¦‚ï¼Œç±» UNIX ç³»ç»Ÿä¸­çš„ <code class="language-plaintext highlighter-rouge">/dev/random</code>ã€‚</td>
    </tr>
    <tr>
      <td><strong>NativePRNGNonBlocking</strong></td>
      <td>ä»åº•å±‚æ“ä½œç³»ç»Ÿè·å–éšæœºæ•°ï¼Œä¸ä¼šé˜»å¡ï¼Œé¿å…åº”ç”¨ç¨‹åºè¿‡åº¦åœé¡¿ã€‚ä¾‹å¦‚ï¼Œç±» UNIX ç³»ç»Ÿä¸­çš„ <code class="language-plaintext highlighter-rouge">/dev/urandom</code>ã€‚</td>
    </tr>
    <tr>
      <td><strong>PKCS11</strong></td>
      <td>ä»åº•å±‚å·²å®‰è£…å¹¶é…ç½®çš„ PKCS #11 åº“è·å–éšæœºæ•°ã€‚</td>
    </tr>
    <tr>
      <td><strong>DRBG</strong></td>
      <td>ä½¿ç”¨ NIST SP 800-90Ar1 ä¸­å®šä¹‰çš„ DRBG æœºåˆ¶çš„ç®—æ³•ã€‚</td>
    </tr>
    <tr>
      <td><strong>SHA1PRNG</strong></td>
      <td>ä½¿ç”¨ SUN æä¾›çš„ä¼ªéšæœºæ•°ç”Ÿæˆï¼ˆPRNGï¼‰ç®—æ³•ã€‚è¯¥ç®—æ³•ä½¿ç”¨ SHA-1 ä½œä¸º PRNG çš„åŸºç¡€ã€‚é€šè¿‡å¯¹ä¸€ä¸ªçœŸå®éšæœºç§å­å€¼å’Œä¸€ä¸ª 64 ä½è®¡æ•°å™¨è¿›è¡Œ SHA-1 å“ˆå¸Œè®¡ç®—ï¼Œæ¯æ¬¡æ“ä½œæ—¶è®¡æ•°å™¨é€’å¢ 1ã€‚ ä» 160 ä½çš„ SHA-1 è¾“å‡ºä¸­ï¼Œä»…ä½¿ç”¨ 64 ä½ã€‚</td>
    </tr>
    <tr>
      <td><strong>Windows-PRNG</strong></td>
      <td>ä»åº•å±‚ Windows æ“ä½œç³»ç»Ÿè·å–éšæœºæ•°ã€‚</td>
    </tr>
  </tbody>
</table>

<p>è¿™äº›ç®—æ³•å„è‡ªå…·æœ‰ä¸åŒçš„å®ç°æ–¹å¼å’Œç”¨é€”ï¼Œå¯ä»¥æ ¹æ®å®‰å…¨éœ€æ±‚å’Œå¹³å°ç‰¹æ€§é€‰æ‹©åˆé€‚çš„ç®—æ³•ã€‚</p>

<p>é€šè¿‡ <code class="language-plaintext highlighter-rouge">new SecureRandom()</code> åˆ›å»ºçš„ <code class="language-plaintext highlighter-rouge">SecureRandom</code> å®ä¾‹ä½¿ç”¨çš„ç®—æ³•æ˜¯ <strong>å¹³å°é»˜è®¤çš„ä¼ªéšæœºæ•°ç”Ÿæˆç®—æ³•</strong>ã€‚è¯¥ç®—æ³•é€šå¸¸ä¾èµ–äºæ“ä½œç³»ç»Ÿæä¾›çš„éšæœºæ•°ç”Ÿæˆæœºåˆ¶ï¼Œä½†å…·ä½“ç®—æ³•çš„é€‰æ‹©ä¼šæ ¹æ®æ“ä½œç³»ç»Ÿå’Œ Java å®ç°çš„ä¸åŒè€Œæœ‰æ‰€å˜åŒ–ã€‚</p>

<p>å¸¸è§çš„å®ç°å’Œç®—æ³•ï¼š</p>
<ol>
  <li><strong>Unix-like æ“ä½œç³»ç»Ÿï¼ˆLinuxã€macOSç­‰ï¼‰</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">SecureRandom</code> é»˜è®¤ä¼šä½¿ç”¨åŸºäº <code class="language-plaintext highlighter-rouge">/dev/urandom</code> æˆ– <code class="language-plaintext highlighter-rouge">/dev/random</code> çš„éšæœºæ•°ç”Ÿæˆå™¨ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">/dev/urandom</code>ï¼šéé˜»å¡çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œå®ƒä¼šä¸æ–­ä½¿ç”¨ç³»ç»Ÿç†µæ± ä¸­çš„æ•°æ®ç”Ÿæˆéšæœºæ•°ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">/dev/random</code>ï¼šé˜»å¡çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œåªæœ‰å½“ç³»ç»Ÿç†µæ± ä¸­çš„æ•°æ®è¶³å¤Ÿæ—¶æ‰èƒ½ç”Ÿæˆéšæœºæ•°ã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong>Windows æ“ä½œç³»ç»Ÿ</strong>ï¼š<code class="language-plaintext highlighter-rouge">SecureRandom</code> é»˜è®¤ä¼šä½¿ç”¨ <strong>Windows-PRNG</strong>ï¼ˆåŸºäº Windows æ“ä½œç³»ç»Ÿçš„éšæœºæ•°ç”Ÿæˆå™¨ï¼‰ã€‚</p>
  </li>
  <li><strong>å…¶ä»–å¹³å°</strong>ï¼šåœ¨ä¸€äº›å¹³å°ä¸Šï¼Œ<code class="language-plaintext highlighter-rouge">SecureRandom</code> å¯èƒ½ä¼šä½¿ç”¨ç±»ä¼¼ <strong>NativePRNG</strong> çš„ä¼ªéšæœºæ•°ç”Ÿæˆç®—æ³•ã€‚</li>
</ol>

<p>å®ç°åŸç†ï¼š</p>
<ul>
  <li><strong>NativePRNG</strong>ï¼šä¸€ç§ä¼ªéšæœºæ•°ç”Ÿæˆç®—æ³•ï¼Œé€šå¸¸ä¼šä¾èµ–äºæ“ä½œç³»ç»Ÿæä¾›çš„åº•å±‚ç†µæºã€‚åœ¨ Unix-like ç³»ç»Ÿä¸­ï¼Œå®ƒé€šè¿‡ <code class="language-plaintext highlighter-rouge">dev/urandom</code> æä¾›ä¸€ä¸ªå¿«é€Ÿçš„ã€éé˜»å¡çš„éšæœºæ•°ç”Ÿæˆæ–¹å¼ã€‚</li>
  <li><strong>DRBGï¼ˆDeterministic Random Bit Generatorï¼‰</strong>ï¼šå¦‚æœå¹³å°ä¸æä¾›è¶³å¤Ÿçš„ç†µæºï¼Œæˆ–è€…è¦æ±‚æ›´å¼ºçš„åŠ å¯†æ€§è´¨ï¼Œ<code class="language-plaintext highlighter-rouge">SecureRandom</code> ä¼šä½¿ç”¨ DRBG ç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäºç¡®å®šæ€§ç®—æ³•çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ã€‚å¸¸ç”¨äºæ»¡è¶³æ›´ä¸¥æ ¼çš„å®‰å…¨éœ€æ±‚ã€‚</li>
</ul>

<p>é€šè¿‡ <code class="language-plaintext highlighter-rouge">new SecureRandom()</code> åˆ›å»ºçš„ <code class="language-plaintext highlighter-rouge">SecureRandom</code> å®ä¾‹ä½¿ç”¨çš„æ˜¯å¹³å°é»˜è®¤çš„ç®—æ³•ï¼Œå®ƒé€šå¸¸ä¾èµ–äºæ“ä½œç³»ç»Ÿæä¾›çš„ç†µæºã€‚åœ¨ç±» Unix æ“ä½œç³»ç»Ÿä¸­ï¼Œå®ƒé€šå¸¸åŸºäº <code class="language-plaintext highlighter-rouge">/dev/urandom</code>ï¼Œè€Œåœ¨ Windows æ“ä½œç³»ç»Ÿä¸­ï¼Œå®ƒä¼šä½¿ç”¨ Windows æä¾›çš„ <code class="language-plaintext highlighter-rouge">Windows-PRNG</code> ç®—æ³•ã€‚å…·ä½“ä½¿ç”¨å“ªç§ç®—æ³•ï¼Œå¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">SecureRandom.getInstance()</code> æ–¹æ³•æ˜¾å¼æŒ‡å®šã€‚</p>

<p>ä¸‹é¢æ˜¯å‡ ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºäº†å¦‚ä½•é€‰æ‹©ä¸åŒçš„éšæœºæ•°ç”Ÿæˆç®—æ³•å¹¶è¾“å‡ºå…¶ç”Ÿæˆçš„éšæœºæ•°ã€‚</p>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">NativePRNG</code> ç®—æ³•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureRandomExample</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// ä½¿ç”¨ NativePRNG ç®—æ³•</span>
        <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"NativePRNG"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"NativePRNG Random Number: "</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>é¢„æœŸç»“æœï¼š</strong></p>

<p>è¾“å‡ºçš„éšæœºæ•°å°†æ¥è‡ªåº•å±‚æ“ä½œç³»ç»Ÿçš„éšæœºæ•°æºï¼Œæ²¡æœ‰å¯¹é˜»å¡æ€§è´¨åšä»»ä½•å£°æ˜ã€‚ä¸åŒæ“ä½œç³»ç»Ÿçš„è¡Œä¸ºå¯èƒ½ä¸åŒã€‚</p>

<hr />

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">NativePRNGBlocking</code> ç®—æ³•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureRandomExample</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// ä½¿ç”¨ NativePRNGBlocking ç®—æ³•</span>
        <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"NativePRNGBlocking"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"NativePRNGBlocking Random Number: "</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>é¢„æœŸç»“æœï¼š</strong></p>

<p>è¯¥ç®—æ³•ä¼šä»åº•å±‚æ“ä½œç³»ç»Ÿçš„ <code class="language-plaintext highlighter-rouge">blocking</code> éšæœºæ•°æºè·å–éšæœºæ•°ã€‚åœ¨ Linux ç³»ç»Ÿä¸Šï¼Œé€šå¸¸ä¼šä» <code class="language-plaintext highlighter-rouge">/dev/random</code> è·å–ï¼Œå¯èƒ½ä¼šåœ¨ç³»ç»Ÿç¼ºå°‘è¶³å¤Ÿçš„ç†µæ—¶å¯¼è‡´é˜»å¡ã€‚</p>

<hr />

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">NativePRNGNonBlocking</code> ç®—æ³•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureRandomExample</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// ä½¿ç”¨ NativePRNGNonBlocking ç®—æ³•</span>
        <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"NativePRNGNonBlocking"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"NativePRNGNonBlocking Random Number: "</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>é¢„æœŸç»“æœï¼š</strong></p>

<p>è¯¥ç®—æ³•å°†ä»éé˜»å¡çš„éšæœºæ•°æºè·å–éšæœºæ•°ï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">/dev/urandom</code>ï¼Œå³ä½¿ç³»ç»Ÿç¼ºä¹ç†µï¼Œä¹Ÿä¸ä¼šé˜»å¡ï¼Œèƒ½ä¿è¯æ›´å¿«çš„å“åº”æ—¶é—´ã€‚</p>

<hr />

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PKCS11</code> ç®—æ³•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureRandomExample</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// ä½¿ç”¨ PKCS11 ç®—æ³•ï¼ˆéœ€è¦é…ç½®å¹¶ä¸”æ”¯æŒ PKCS11 æä¾›è€…ï¼‰</span>
        <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"PKCS11"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"PKCS11 Random Number: "</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>é¢„æœŸç»“æœï¼š</strong></p>

<p>è¯¥ç®—æ³•å°†ä½¿ç”¨å·²å®‰è£…çš„ PKCS#11 åŠ å¯†æ¨¡å—æä¾›çš„éšæœºæ•°ç”Ÿæˆå™¨ã€‚å¦‚æœæ²¡æœ‰å®‰è£…æ”¯æŒçš„ç¡¬ä»¶åŠ å¯†æ¨¡å—æˆ–é…ç½®æ­£ç¡®çš„ PKCS#11 æä¾›è€…ï¼Œå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>

<hr />

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DRBG</code> ç®—æ³•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.bouncycastle.crypto.prng.DrbgParameters</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureRandomExample</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// ä½¿ç”¨ DRBG ç®—æ³•</span>
       <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"DRBG"</span><span class="o">,</span> <span class="nc">DrbgParameters</span><span class="o">.</span><span class="na">instantiation</span><span class="o">(</span><span class="mi">128</span><span class="o">,</span> <span class="nc">DrbgParameters</span><span class="o">.</span><span class="na">Capability</span><span class="o">.</span><span class="na">RESEED_ONLY</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"DRBG Random Number: "</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>é¢„æœŸç»“æœï¼š</strong></p>

<p>è¯¥ç®—æ³•ä½¿ç”¨ DRBGï¼ˆDeterministic Random Bit Generatorï¼‰æœºåˆ¶ï¼Œé€šå¸¸åŸºäºå“ˆå¸Œå‡½æ•°æˆ–åŠ å¯†ç®—æ³•ï¼ˆä¾‹å¦‚ SHA-256ï¼‰ç”Ÿæˆéšæœºæ•°ã€‚éœ€è¦åˆé€‚çš„å‚æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚æ­¤ç®—æ³•é€šå¸¸æä¾›é«˜å®‰å…¨æ€§ï¼Œå¹¶ä¸”èƒ½å¤Ÿç”Ÿæˆé«˜è´¨é‡çš„éšæœºæ•°ã€‚</p>

<p><strong>â€œDRBGâ€</strong></p>

<p>è¿™é‡ŒæŒ‡å®šäº†ä½¿ç”¨çš„ç®—æ³•ä¸º <strong>DRBG</strong>ï¼ˆDeterministic Random Bit Generatorï¼‰ã€‚å®ƒæ˜¯åŸºäºç‰¹å®šæ ‡å‡†ï¼ˆå¦‚ NIST SP 800-90Aï¼‰å®šä¹‰çš„ä¼ªéšæœºæ•°ç”Ÿæˆç®—æ³•ã€‚DRBG ä¸»è¦é€šè¿‡ä¸€ä¸ªç¡®å®šæ€§ç®—æ³•ï¼ˆé€šå¸¸æ˜¯åŸºäºå“ˆå¸Œå‡½æ•°æˆ–è€…åŠ å¯†ç®—æ³•ï¼‰æ¥ç”Ÿæˆä¼ªéšæœºæ•°åºåˆ—ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ä¸€å®šçš„ç§å­è¾“å…¥å’Œç³»ç»Ÿç†µæ¥æºè¿›è¡Œåˆå§‹åŒ–ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">DrbgParameters.instantiation(int securityStrength, DrbgParameters.Capability capability, byte[] personalizationString)</code></strong></p>

<p>(DRBG å‚æ•°å®ä¾‹åŒ–)è¿™ä¸ªæ–¹æ³•ç”¨äºæŒ‡å®š DRBG çš„ç”Ÿæˆæ–¹å¼ï¼Œé€šå¸¸åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªé‡è¦å‚æ•°ï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">securityStrength</code></strong> (å®‰å…¨å¼ºåº¦)</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">securityStrength</code> æ˜¯ DRBG ç®—æ³•çš„å®‰å…¨å¼ºåº¦ï¼Œä»¥ä½ä¸ºå•ä½ã€‚ä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">128</code> è¡¨ç¤º DRBG çš„è¾“å‡ºåº”è¯¥å…·æœ‰ 128 ä½çš„å®‰å…¨å¼ºåº¦ï¼Œé€šå¸¸æ˜¯ä¸ºäº†ä¿è¯éšæœºæ•°ç”Ÿæˆçš„å¼ºåº¦å’Œè´¨é‡ã€‚è¿™æ„å‘³ç€ç”Ÿæˆçš„éšæœºæ•°åœ¨ç®—æ³•å±‚é¢ä¸Šåº”è¯¥è‡³å°‘æä¾› 128 ä½çš„å®‰å…¨ä¿éšœã€‚</li>
  <li>ä¸€èˆ¬æ¥è¯´ï¼Œå®‰å…¨å¼ºåº¦æ˜¯åŸºäºé¢„æœŸçš„ç”¨é€”æ¥é€‰æ‹©çš„ã€‚å¦‚æœä½ éœ€è¦æ›´é«˜çš„å®‰å…¨æ€§ï¼Œå¯ä»¥é€‰æ‹©æ›´é«˜çš„å®‰å…¨å¼ºåº¦ï¼ˆæ¯”å¦‚ 256 ä½ï¼‰ã€‚ä¾‹å¦‚ï¼š</li>
  <li>128ï¼šé€‚ç”¨äºä¸€èˆ¬çš„åŠ å¯†æ“ä½œå’Œå®‰å…¨åº”ç”¨ã€‚</li>
  <li>256ï¼šé€‚ç”¨äºé«˜å®‰å…¨æ€§çš„è¦æ±‚ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">capability</code></strong> (èƒ½åŠ›)</p>

<p><strong><code class="language-plaintext highlighter-rouge">PR_AND_RESEED</code></strong>:</p>

<ul>
  <li>è¿™ä¸ªå€¼è¡¨ç¤ºæ‰€è¯·æ±‚çš„ <code class="language-plaintext highlighter-rouge">DRBG</code> å®ä¾‹ <strong>åŒæ—¶æ”¯æŒé¢„æµ‹æŠ—æ€§</strong> å’Œ <strong>é‡ç§å­åŠŸèƒ½</strong>ã€‚</li>
  <li><strong>é¢„æµ‹æŠ—æ€§ï¼ˆPrediction Resistanceï¼‰</strong>ï¼šç¡®ä¿é€šè¿‡æŸäº›é€”å¾„é¢„æµ‹éšæœºæ•°ç”Ÿæˆå™¨çš„è¾“å‡ºå˜å¾—æå…¶å›°éš¾ï¼Œå¢åŠ å®‰å…¨æ€§ã€‚å¯¹äºåŠ å¯†åº”ç”¨ï¼Œé€šå¸¸éœ€è¦é¢„æµ‹æŠ—æ€§æ¥é˜²æ­¢æ”»å‡»è€…é€šè¿‡æŸäº›æ–¹å¼æ¨æµ‹åç»­ç”Ÿæˆçš„éšæœºæ•°ã€‚</li>
  <li><strong>é‡ç§å­ï¼ˆReseedï¼‰</strong>ï¼šDRBG éœ€è¦å®šæœŸé‡æ–°å¼•å…¥ç†µæºï¼ˆä¾‹å¦‚ï¼Œæ–°çš„éšæœºè¾“å…¥ï¼‰ï¼Œä»¥ä¿æŒç”Ÿæˆçš„éšæœºæ•°çš„è´¨é‡ã€‚é‡ç§å­æ˜¯ä¸ºäº†é¿å…é•¿æœŸä½¿ç”¨åŒä¸€ç§å­äº§ç”Ÿçš„éšæœºæ•°åºåˆ—è¶‹å‘äºå¯é¢„æµ‹ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">RESEED_ONLY</code></strong>:</p>
<ul>
  <li>è¿™ä¸ªå€¼è¡¨ç¤ºæ‰€è¯·æ±‚çš„ <code class="language-plaintext highlighter-rouge">DRBG</code> å®ä¾‹ <strong>ä»…æ”¯æŒé‡ç§å­åŠŸèƒ½</strong>ï¼Œè€Œ <strong>ä¸æ”¯æŒé¢„æµ‹æŠ—æ€§</strong>ã€‚</li>
  <li>è¿™ç§èƒ½åŠ›é€‚ç”¨äºéœ€è¦å®šæœŸåˆ·æ–°æˆ–æ›´æ–°ç§å­çš„åœºæ™¯ï¼Œä½†ä¸è¦æ±‚å…·å¤‡å¼ºå¤§çš„æŠ—é¢„æµ‹æ€§ã€‚åœ¨ä¸€äº›ä¸é‚£ä¹ˆæ•æ„Ÿçš„åº”ç”¨ä¸­ï¼Œå¯èƒ½åªéœ€è¦é‡ç§å­æ¥ä¿è¯éšæœºæ•°çš„è´¨é‡ï¼Œè€Œä¸ä¸€å®šè¦æ±‚å…·æœ‰é¢„æµ‹æŠ—æ€§ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">NONE</code></strong>:</p>
<ul>
  <li>è¿™ä¸ªå€¼è¡¨ç¤ºæ‰€è¯·æ±‚çš„ <code class="language-plaintext highlighter-rouge">DRBG</code> å®ä¾‹ <strong>æ—¢ä¸æ”¯æŒé¢„æµ‹æŠ—æ€§ï¼Œä¹Ÿä¸æ”¯æŒé‡ç§å­åŠŸèƒ½</strong>ã€‚</li>
  <li>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä»…éœ€è¦ç”Ÿæˆä¸€æ¬¡æ€§çš„éšæœºæ•°ï¼Œè€Œä¸éœ€è¦è¿›è¡Œä»»ä½•åç»­çš„é‡ç§å­æˆ–æŠ—é¢„æµ‹æ€§ä¿æŠ¤ã€‚ä¾‹å¦‚ï¼Œä¸€äº›ç®€å•çš„éšæœºæ•°ç”Ÿæˆåº”ç”¨å¯èƒ½ä¸è¦æ±‚å…·æœ‰ç‰¹åˆ«é«˜çš„å®‰å…¨æ ‡å‡†ã€‚</li>
</ul>

<p>ä¸åŒçš„è¯·æ±‚èƒ½åŠ›ä¸å¯èƒ½çš„å®é™…èƒ½åŠ›ä¹‹é—´çš„å…³ç³»ï¼š</p>
<ul>
  <li>è¯·æ±‚ <strong>NONE</strong> èƒ½åŠ›æ—¶ï¼Œå®é™…è¿”å›çš„èƒ½åŠ›å¯èƒ½æ˜¯ <code class="language-plaintext highlighter-rouge">NONE</code>ã€<code class="language-plaintext highlighter-rouge">RESEED_ONLY</code> æˆ– <code class="language-plaintext highlighter-rouge">PR_AND_RESEED</code>ã€‚</li>
  <li>è¯·æ±‚ <strong>RESEED_ONLY</strong> æ—¶ï¼Œå®é™…è¿”å›çš„èƒ½åŠ›å¯èƒ½æ˜¯ <code class="language-plaintext highlighter-rouge">RESEED_ONLY</code> æˆ– <code class="language-plaintext highlighter-rouge">PR_AND_RESEED</code>ã€‚</li>
  <li>è¯·æ±‚ <strong>PR_AND_RESEED</strong> æ—¶ï¼Œå®é™…è¿”å›çš„èƒ½åŠ›ä¸€å®šæ˜¯ <code class="language-plaintext highlighter-rouge">PR_AND_RESEED</code>ã€‚</li>
</ul>

<p>æ€»ç»“ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">PR_AND_RESEED</code>ï¼šæ”¯æŒé‡ç§å­å’Œé¢„æµ‹æŠ—æ€§ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">RESEED_ONLY</code>ï¼šä»…æ”¯æŒé‡ç§å­ï¼Œä¸æ”¯æŒé¢„æµ‹æŠ—æ€§ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">NONE</code>ï¼šæ—¢ä¸æ”¯æŒé¢„æµ‹æŠ—æ€§ï¼Œä¹Ÿä¸æ”¯æŒé‡ç§å­ã€‚</li>
</ul>

<p>è¿™ç§èƒ½åŠ›æ§åˆ¶æœºåˆ¶æä¾›äº†çµæ´»æ€§ï¼Œå…è®¸å¼€å‘è€…æ ¹æ®å®é™…å®‰å…¨éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„ <code class="language-plaintext highlighter-rouge">DRBG</code> é…ç½®ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">personalizationString</code></strong> (ä¸ªæ€§åŒ–å­—ç¬¦ä¸²)</p>
<ul>
  <li>è¿™ä¸ªå‚æ•°ç”¨äºåˆå§‹åŒ– DRBG æ—¶çš„ä¸ªæ€§åŒ–å­—ç¬¦ä¸²ï¼Œé€šå¸¸æ˜¯é¢å¤–çš„è¾“å…¥æ•°æ®ï¼Œç”¨äºå¢å¼ºç”Ÿæˆéšæœºæ•°çš„å¤šæ ·æ€§å’Œä¸å¯é¢„æµ‹æ€§ã€‚ä¼ å…¥ <code class="language-plaintext highlighter-rouge">null</code> è¡¨ç¤ºæ²¡æœ‰ä½¿ç”¨ä¸ªæ€§åŒ–å­—ç¬¦ä¸²ã€‚</li>
  <li>ä¸ªæ€§åŒ–å­—ç¬¦ä¸²æœ‰åŠ©äºåœ¨ç‰¹å®šä¸Šä¸‹æ–‡ä¸­åˆå§‹åŒ– DRBGï¼Œç¡®ä¿åœ¨ä¸åŒåœºæ™¯ä¸­ç”Ÿæˆçš„éšæœºæ•°æ˜¯ä¸åŒçš„ã€‚</li>
  <li>å¦‚æœä½ å¸Œæœ›åœ¨åˆå§‹åŒ–æ—¶æ ¹æ®ç‰¹å®šçš„ä¸Šä¸‹æ–‡æˆ–ç¯å¢ƒï¼ˆå¦‚è®¾å¤‡IDã€æ—¶é—´æˆ³ç­‰ï¼‰æ¥ç”Ÿæˆä¸åŒçš„éšæœºæ•°ç§å­ï¼Œå¯ä»¥ä½¿ç”¨ä¸ªæ€§åŒ–å­—ç¬¦ä¸²ã€‚</li>
</ul>

<p><strong>æ•´ä½“æ•ˆæœ</strong></p>

<p>ç»¼åˆæ¥çœ‹ï¼Œè¿™è¡Œä»£ç é€šè¿‡ <code class="language-plaintext highlighter-rouge">DrbgParameters.instantiation(128, DrbgParameters.Capability.RESEED_ONLY, null)</code> æ¥åˆ›å»ºä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DRBG</code> å®ä¾‹ï¼Œå®ƒæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
  <li><strong>128 ä½å®‰å…¨å¼ºåº¦</strong>ï¼Œç”Ÿæˆçš„éšæœºæ•°åºåˆ—å…·æœ‰è¾ƒé«˜çš„å®‰å…¨æ€§ã€‚</li>
  <li><strong>RESEED_ONLY</strong> èƒ½åŠ›ï¼Œæ„å‘³ç€è¯¥å®ä¾‹ä¸ç›´æ¥ç”Ÿæˆéšæœºæ•°ï¼Œè€Œæ˜¯åœ¨éœ€è¦æ—¶æ‰§è¡Œé‡ç§å­æ“ä½œã€‚</li>
  <li><strong>æ²¡æœ‰ä¸ªæ€§åŒ–å­—ç¬¦ä¸²</strong>ï¼Œå³ DRBG ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„ç†µæºï¼Œè€Œä¸æ˜¯ç‰¹å®šä¸Šä¸‹æ–‡çš„æ•°æ®ã€‚</li>
</ul>

<p>è¿™ç§é…ç½®é€šå¸¸é€‚ç”¨äºéœ€è¦å®‰å…¨éšæœºæ•°ç”Ÿæˆã€å®šæœŸé‡ç§å­çš„åœºæ™¯ï¼Œå°¤å…¶æ˜¯åœ¨è¦æ±‚è¾ƒé«˜å®‰å…¨æ€§çš„åŠ å¯†åº”ç”¨ä¸­ã€‚</p>

<hr />

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">SHA1PRNG</code> ç®—æ³•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureRandomExample</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// ä½¿ç”¨ SHA1PRNG ç®—æ³•</span>
        <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"SHA1PRNG"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"SHA1PRNG Random Number: "</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>é¢„æœŸç»“æœï¼š</strong></p>

<p>SHA1PRNG æ˜¯ä¸€ä¸ªåŸºäº SHA-1 å“ˆå¸Œçš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ã€‚å…¶ç”Ÿæˆçš„éšæœºæ•°ä¼šå—åˆ°åˆå§‹ç§å­å’Œè®¡æ•°å™¨çš„å½±å“ï¼Œç”Ÿæˆçš„éšæœºæ•°ç›¸å¯¹è¾ƒä¸ºå¯é¢„æµ‹ï¼Œä½†å¯¹äºå¤§å¤šæ•°éå®‰å…¨åº”ç”¨åœºæ™¯æ˜¯è¶³å¤Ÿçš„ã€‚</p>

<hr />

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Windows-PRNG</code> ç®—æ³•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.security.SecureRandom</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecureRandomExample</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// ä½¿ç”¨ Windows-PRNG ç®—æ³•</span>
        <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"Windows-PRNG"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Windows-PRNG Random Number: "</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>é¢„æœŸç»“æœï¼š</strong></p>

<p>è¯¥ç®—æ³•å°†ä» Windows æ“ä½œç³»ç»Ÿçš„éšæœºæ•°æºï¼ˆä¾‹å¦‚é€šè¿‡ Windows Cryptographic APIï¼‰ç”Ÿæˆéšæœºæ•°ã€‚</p>

<hr />

<p>æ€»ç»“</p>

<ol>
  <li><strong>NativePRNG</strong> å’Œ <strong>Windows-PRNG</strong> ä¼šä¾èµ–æ“ä½œç³»ç»Ÿçš„åŸç”Ÿéšæœºæ•°ç”Ÿæˆæœºåˆ¶ï¼Œé€šå¸¸æ¯”è¾ƒå¿«ï¼Œä½†å¯èƒ½ä¸å¤ªé€‚åˆé«˜å®‰å…¨æ€§éœ€æ±‚ã€‚</li>
  <li><strong>NativePRNGBlocking</strong> ä¼šé˜»å¡ç›´åˆ°è¶³å¤Ÿçš„éšæœºæ•°å¯ç”¨ï¼Œé€‚åˆç”¨äºé«˜å®‰å…¨æ€§çš„ç¯å¢ƒï¼Œä½†å¯èƒ½ä¼šå»¶è¿Ÿã€‚</li>
  <li><strong>NativePRNGNonBlocking</strong> é€‚ç”¨äºä¸å¸Œæœ›é˜»å¡çš„ç¯å¢ƒï¼Œä¼šä¼˜å…ˆä½¿ç”¨ <code class="language-plaintext highlighter-rouge">/dev/urandom</code>ã€‚</li>
  <li><strong>PKCS11</strong> å’Œ <strong>DRBG</strong> æä¾›ç¡¬ä»¶åŠ é€Ÿå’Œæ›´é«˜çš„å®‰å…¨æ€§ï¼Œä½†ä¾èµ–äºç›¸åº”çš„ç¡¬ä»¶å’Œé…ç½®ã€‚</li>
  <li><strong>SHA1PRNG</strong> æ˜¯åŸºäº SHA-1 çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ï¼Œé€‚ç”¨äºä¸€èˆ¬ç”¨é€”ï¼Œä½†ä¸é€‚åˆé«˜å®‰å…¨æ€§çš„è¦æ±‚ã€‚</li>
</ol>

<p>æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç®—æ³•ã€‚</p>

<h2 id="è§£å†³">è§£å†³</h2>

<p>åœ¨Java8ä¸­ç›¸åŒç§å­æ˜¯å¦è¿”å›ç›¸åŒçš„éšæœºæ•°ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨å›ºå®šéšæœºæ•°</span>
<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span><span class="o">();</span>
    <span class="n">random</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
<span class="o">}</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">set</span><span class="o">);</span><span class="c1">//[-1765061395]</span>
</code></pre></div></div>

<p>åœ¨Java17ä¸­ï¼ŒæŒ‡å®š<code class="language-plaintext highlighter-rouge">SHA1PRNG</code>éšæœºæ•°ç”Ÿæˆå™¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨å›ºå®šéšæœºæ•°</span>
<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"SHA1PRNG"</span><span class="o">);</span>
    <span class="n">random</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
<span class="o">}</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">set</span><span class="o">);</span><span class="c1">//[-1765061395]</span>
</code></pre></div></div>

<p>è¿›ä¸€æ­¥æµ‹è¯•ï¼š</p>

<p>java17ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">SecureRandom</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"SHA1PRNG"</span><span class="o">);</span>
        <span class="n">random</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">set</span><span class="o">);</span><span class="c1">//[1171630791, -70273684, -1765061395, -786090109, 1560068868, 1762545591, 1861147253, -551574285, 1891309446, -1389656251]</span>
</code></pre></div></div>

<p>java8ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">SecureRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecureRandom</span><span class="o">();</span>
        <span class="n">random</span><span class="o">.</span><span class="na">setSeed</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
        <span class="n">set</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">set</span><span class="o">);</span><span class="c1">//[1171630791, -70273684, -1765061395, -786090109, 1560068868, 1762545591, 1861147253, -551574285, 1891309446, -1389656251]</span>
</code></pre></div></div>

<p>å¯ä»¥çœ‹å‡ºç»“æœä¸€è‡´ï¼Œå®é™…ä¸Šåªè¦ä¿è¯æŒ‡å®šç§å­è¿”å›å›ºå®šçš„éšæœºæ•°åºåˆ—å³å¯ã€‚</p>

<p>ç„¶åå°†ä¹‹å‰çš„æ•°æ®é‡æ–°æŒ‡å®šç®—æ³•åŠ å¯†å³å¯ã€‚</p>]]></content><author><name>acteds</name></author><category term="Java" /><category term="IDEA" /><summary type="html"><![CDATA[Javaç¬”è®°]]></summary></entry><entry><title type="html">Droolsè§„åˆ™å¼•æ“</title><link href="/2024/12/21/Drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/" rel="alternate" type="text/html" title="Droolsè§„åˆ™å¼•æ“" /><published>2024-12-21T00:00:00+08:00</published><updated>2024-12-21T00:00:00+08:00</updated><id>/2024/12/21/Drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E</id><content type="html" xml:base="/2024/12/21/Drools%E8%A7%84%E5%88%99%E5%BC%95%E6%93%8E/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p>Droolsè§„åˆ™å¼•æ“ï¼Œè¯´æ˜</p>

<h1 id="drools">Drools</h1>

<h2 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</h2>

<p>å¼•å…¥ä¾èµ–ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.drools<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>drools-compiler<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>7.14.0.Final<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>æœåŠ¡å±‚ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">io.swagger.annotations.ApiOperation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.lang.StringUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.drools.core.definitions.InternalKnowledgePackage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.drools.core.impl.KnowledgeBaseImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.api.KieBaseConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.api.KieServices</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.api.io.ResourceType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.api.runtime.KieSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.internal.builder.KnowledgeBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.internal.builder.KnowledgeBuilderFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.internal.io.ResourceFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.internal.utils.KieHelper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>

<span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@ApiOperation</span><span class="o">(</span><span class="s">"è§„åˆ™å¼•æ“"</span><span class="o">)</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KnowledgeContext</span> <span class="o">{</span>

    <span class="cm">/**
     * è§„åˆ™ä¸Šä¸‹æ–‡
     */</span>
    <span class="kd">private</span> <span class="nc">KnowledgeBaseImpl</span> <span class="n">knowledgeBase</span><span class="o">;</span>

    <span class="cm">/**
     * è§„åˆ™å†…å®¹
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">rule</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">KnowledgeContext</span><span class="o">(</span><span class="nc">String</span> <span class="n">rule</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">knowledgeBase</span> <span class="o">=</span> <span class="n">buildImpl</span><span class="o">();</span>
        <span class="c1">//æ„å»ºæäº¤æ•°æ®è§„åˆ™</span>
        <span class="k">if</span> <span class="o">(!</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">rule</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">KnowledgeBuilder</span> <span class="n">paramsKb</span> <span class="o">=</span> <span class="nc">KnowledgeBuilderFactory</span><span class="o">.</span><span class="na">newKnowledgeBuilder</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">paramsKb</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ResourceFactory</span><span class="o">.</span><span class="na">newByteArrayResource</span><span class="o">(</span><span class="n">rule</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)),</span> <span class="nc">ResourceType</span><span class="o">.</span><span class="na">DRL</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">paramsKb</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"å‚æ•°çš„è§„åˆ™æ–‡ä»¶:{}é”™è¯¯ï¼š{}"</span><span class="o">,</span> <span class="n">rule</span><span class="o">,</span> <span class="n">paramsKb</span><span class="o">.</span><span class="na">getErrors</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"è§„åˆ™æ–‡ä»¶é”™è¯¯ï¼š"</span> <span class="o">+</span> <span class="n">paramsKb</span><span class="o">.</span><span class="na">getErrors</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"æ„å»ºè§„åˆ™:{}æ—¶å‡ºç°å¼‚å¸¸,å¼‚å¸¸ä¸º:{}"</span><span class="o">,</span> <span class="n">rule</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">this</span><span class="o">.</span><span class="na">knowledgeBase</span><span class="o">.</span><span class="na">addPackages</span><span class="o">(</span><span class="n">paramsKb</span><span class="o">.</span><span class="na">getKnowledgePackages</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rule</span> <span class="o">=</span> <span class="n">rule</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="nc">KnowledgeBaseImpl</span> <span class="nf">buildImpl</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">KieBaseConfiguration</span> <span class="n">kbConfig</span> <span class="o">=</span> <span class="nc">KieServices</span><span class="o">.</span><span class="na">Factory</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">newKieBaseConfiguration</span><span class="o">();</span>
        <span class="nc">KnowledgeBaseImpl</span> <span class="n">impl</span> <span class="o">=</span> <span class="o">(</span><span class="nc">KnowledgeBaseImpl</span><span class="o">)</span> <span class="k">new</span> <span class="nc">KieHelper</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="n">kbConfig</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">impl</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">KieSession</span> <span class="nf">getSession</span><span class="o">(</span><span class="nc">RuleTypeEnum</span> <span class="n">ruleTypeEnum</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">knowledgeBase</span><span class="o">.</span><span class="na">newKieSession</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æ›´æ–°è§„åˆ™,åˆ é™¤åŸæœ‰çš„æ‰€æœ‰è§„åˆ™,é‡æ–°åŠ è½½æ–°è§„åˆ™
     *
     * @return
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateRule</span><span class="o">(</span><span class="nc">String</span> <span class="n">rule</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">KnowledgeBuilder</span> <span class="n">kb</span> <span class="o">=</span> <span class="nc">KnowledgeBuilderFactory</span><span class="o">.</span><span class="na">newKnowledgeBuilder</span><span class="o">();</span>
        <span class="n">kb</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ResourceFactory</span><span class="o">.</span><span class="na">newByteArrayResource</span><span class="o">(</span><span class="n">rule</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)),</span> <span class="nc">ResourceType</span><span class="o">.</span><span class="na">DRL</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">kb</span><span class="o">.</span><span class="na">hasErrors</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"è§„åˆ™æ–‡ä»¶:{} é”™è¯¯ï¼š{}"</span><span class="o">,</span> <span class="n">rule</span><span class="o">,</span> <span class="n">kb</span><span class="o">.</span><span class="na">getErrors</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"è§„åˆ™æ–‡ä»¶é”™è¯¯ï¼š"</span> <span class="o">+</span> <span class="n">kb</span><span class="o">.</span><span class="na">getErrors</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>

        <span class="o">}</span>
        <span class="nc">KnowledgeBaseImpl</span> <span class="n">knowledgeBase</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getKnowledgeBase</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rule</span> <span class="o">=</span> <span class="n">rule</span><span class="o">;</span>
        <span class="c1">//æ¸…é™¤åŸè§„åˆ™</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">InternalKnowledgePackage</span> <span class="n">internalKnowledgePackage</span> <span class="o">:</span> <span class="n">knowledgeBase</span><span class="o">.</span><span class="na">getPackages</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">knowledgeBase</span><span class="o">.</span><span class="na">removeKiePackage</span><span class="o">(</span><span class="n">internalKnowledgePackage</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">knowledgeBase</span><span class="o">.</span><span class="na">addPackages</span><span class="o">(</span><span class="n">kb</span><span class="o">.</span><span class="na">getKnowledgePackages</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clean</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">knowledgeBase</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">InternalKnowledgePackage</span> <span class="n">aPackage</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">knowledgeBase</span><span class="o">.</span><span class="na">getPackages</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">knowledgeBase</span><span class="o">.</span><span class="na">removeKiePackage</span><span class="o">(</span><span class="n">aPackage</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">this</span><span class="o">.</span><span class="na">knowledgeBase</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rule</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è°ƒç”¨è§„åˆ™ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.ilw.formflowprovider</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.ilw.formflowprovider.center.kie.KnowledgeContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ilw.formflowprovider.center.kie.RuleTypeEnum</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.kie.api.runtime.KieSession</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>


<span class="cm">/**
 * @author aotmd
 * @version 1.0
 * @date 2024/12/21 9:32
 */</span>
<span class="c1">//@SpringBootTest(classes = FormflowproviderApplication.class)</span>
<span class="c1">//@RunWith(SpringRunner.class)</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DroolsTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">startTestDroolsRule</span><span class="o">(</span><span class="s">"drl/è§„åˆ™å¼•æ“ä»£ç èµ‹å€¼æ“ä½œå®ä¾‹.drl"</span><span class="o">,</span><span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;());</span>
    <span class="o">}</span>

    <span class="cm">/**
     * å¯åŠ¨è§„åˆ™å¼•æ“è§„åˆ™ä»£ç 
     * @param ruleFilePath è§„åˆ™æ–‡ä»¶è·¯å¾„
     * @param param å…¥å‚
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">startTestDroolsRule</span><span class="o">(</span><span class="nc">String</span> <span class="n">ruleFilePath</span><span class="o">,</span><span class="nc">Object</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è¯»å–è§„åˆ™æ–‡ä»¶å†…å®¹</span>
        <span class="nc">String</span> <span class="n">ruleContent</span> <span class="o">=</span> <span class="n">readRuleFile</span><span class="o">(</span><span class="n">ruleFilePath</span><span class="o">);</span>

        <span class="c1">// åˆ›å»º KnowledgeContext å®ä¾‹ï¼Œå¹¶ä¼ å…¥è§„åˆ™å†…å®¹</span>
        <span class="nc">KnowledgeContext</span> <span class="n">knowledgeContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KnowledgeContext</span><span class="o">(</span><span class="n">ruleContent</span><span class="o">);</span>

        <span class="c1">// è·å– KieSession</span>
        <span class="nc">KieSession</span> <span class="n">kieSession</span> <span class="o">=</span> <span class="n">knowledgeContext</span><span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="nc">RuleTypeEnum</span><span class="o">.</span><span class="na">CUSTOM</span><span class="o">);</span>
        <span class="c1">// å…¥å‚</span>
        <span class="n">kieSession</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>
        <span class="c1">// æ‰§è¡Œ Drools è§„åˆ™</span>
        <span class="n">kieSession</span><span class="o">.</span><span class="na">fireAllRules</span><span class="o">();</span>
        <span class="c1">// æ¸…ç†ä¼šè¯</span>
        <span class="n">kieSession</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * è¯»å–è§„åˆ™æ–‡ä»¶å†…å®¹
     * @param filePath è§„åˆ™æ–‡ä»¶è·¯å¾„
     * @return è§„åˆ™æ–‡ä»¶å†…å®¹çš„å­—ç¬¦ä¸²
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">readRuleFile</span><span class="o">(</span><span class="nc">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ä½¿ç”¨ ClassLoader ä»ç±»è·¯å¾„ä¸­åŠ è½½æ–‡ä»¶</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="nc">DroolsTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">filePath</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">inputStream</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"æ— æ³•æ‰¾åˆ°æ–‡ä»¶: "</span> <span class="o">+</span> <span class="n">filePath</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="c1">// ä¼ ç»Ÿæ–¹æ³•ï¼šä½¿ç”¨ ByteArrayOutputStream è¯»å– InputStream çš„å†…å®¹</span>
            <span class="nc">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">length</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">length</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">length</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span> <span class="c1">// è¿”å›è§„åˆ™æ–‡ä»¶çš„å†…å®¹</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"æ— æ³•è¯»å–è§„åˆ™æ–‡ä»¶ï¼š"</span> <span class="o">+</span> <span class="n">filePath</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">drl/è§„åˆ™å¼•æ“ä»£ç èµ‹å€¼æ“ä½œå®ä¾‹.drl</code>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.jiean.schemasystem</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span>

<span class="n">function</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span><span class="kt">int</span> <span class="n">b</span><span class="o">){</span>
    <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">rule</span> <span class="s">"start-process"</span>
   <span class="n">when</span>
        <span class="n">$map</span><span class="o">:</span><span class="nc">HashMap</span><span class="o">()</span>
   <span class="n">then</span>
   		<span class="nc">Integer</span> <span class="n">a</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">10</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">100</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">100</span><span class="o">+</span><span class="n">i</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="n">end</span>
</code></pre></div></div>

<p>æ§åˆ¶å°ï¼š</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>10
100
200
</code></pre></div></div>

<h2 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h2>

<p>åœ¨è§„åˆ™å¼•æ“ä»£ç ä¸­ï¼Œä¸æ”¯æŒé™æ€å­—æ®µå¯¼å…¥ï¼Œå³ç±»ä¼¼ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">aotmd</span><span class="o">.</span><span class="na">constant</span><span class="o">.</span><span class="na">StatusEnum</span><span class="o">.</span><span class="na">FAILURE</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">aotmd</span><span class="o">.</span><span class="na">constant</span><span class="o">.</span><span class="na">StatusEnum</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">;</span>
</code></pre></div></div>

<p>æ‰€ä»¥åªèƒ½å…ˆå¯¼å…¥ç±»ï¼Œç„¶åé€šè¿‡ç±»åè®¿é—®é™æ€å­—æ®µã€‚</p>

<p>æ”¯æŒé™æ€æ–¹æ³•å¯¼å…¥ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">ilw</span><span class="o">.</span><span class="na">formflowprovider</span><span class="o">.</span><span class="na">center</span><span class="o">.</span><span class="na">utils</span><span class="o">.</span><span class="na">SpringBeanUtil</span><span class="o">.</span><span class="na">getBean</span><span class="o">;</span>
</code></pre></div></div>

<p>åœ¨èµ‹å€¼æ—¶ï¼ŒIDEä¼šæç¤º<code class="language-plaintext highlighter-rouge">ä½œç”¨åŸŸä¸­å·²å®šä¹‰å˜é‡</code>ï¼Œå¿½ç•¥å³å¯ï¼Œä¸ä¼šå‡ºé”™ã€‚</p>]]></content><author><name>acteds</name></author><category term="Java" /><category term="IDEA" /><summary type="html"><![CDATA[Javaç¬”è®°]]></summary></entry><entry><title type="html">IDEAçš„é…ç½®</title><link href="/2024/12/20/IDEA%E7%9A%84%E9%85%8D%E7%BD%AE/" rel="alternate" type="text/html" title="IDEAçš„é…ç½®" /><published>2024-12-20T00:00:00+08:00</published><updated>2024-12-20T00:00:00+08:00</updated><id>/2024/12/20/IDEA%E7%9A%84%E9%85%8D%E7%BD%AE</id><content type="html" xml:base="/2024/12/20/IDEA%E7%9A%84%E9%85%8D%E7%BD%AE/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p>IDEAçš„å¸¸ç”¨é…ç½®</p>

<h1 id="idea">IDEA</h1>

<h2 id="çƒ­æ›´æ–°">çƒ­æ›´æ–°</h2>

<p>é¼ æ ‡ç§»åŠ¨åˆ°<code class="language-plaintext highlighter-rouge">è¿è¡Œ</code>æŒ‰é’®æ‰€åœ¨<code class="language-plaintext highlighter-rouge">å·¥å…·æ </code>-å³é”®-<code class="language-plaintext highlighter-rouge">è‡ªå®šä¹‰å·¥å…·æ ..</code>-è¿›å…¥åˆ°<code class="language-plaintext highlighter-rouge">è‡ªå®šä¹‰å¯¼èˆªæ å·¥å…·æ </code>å¯¹è¯æ¡†ã€‚</p>

<p>é€‰æ‹©<code class="language-plaintext highlighter-rouge">å¯¼èˆªå·¥å…·æ </code>-<code class="language-plaintext highlighter-rouge">å·¥å…·æ è¿è¡Œæ“ä½œ</code>-<code class="language-plaintext highlighter-rouge">è¿è¡Œ/è°ƒè¯•</code>-ç‚¹å‡»<code class="language-plaintext highlighter-rouge">æ·»åŠ æ“ä½œ</code>æŒ‰é’®-è¿›å…¥åˆ°<code class="language-plaintext highlighter-rouge">æ·»åŠ æ“ä½œ</code>å¯¹è¯æ¡†ã€‚</p>

<p>æŸ¥è¯¢ <code class="language-plaintext highlighter-rouge">ç¼–è¯‘å¹¶é‡æ–°åŠ è½½æ–‡ä»¶</code> ï¼Œç„¶åé€‰æ‹©ï¼Œå¹¶ç¡®è®¤æ·»åŠ è¯¥åŠŸèƒ½æŒ‰é’®ã€‚ï¼ˆè‹¥æ‰¾ä¸åˆ°ï¼Œåˆ™æ‰‹åŠ¨å®šä½ï¼š<code class="language-plaintext highlighter-rouge">è°ƒè¯•å™¨æ“ä½œ</code>-<code class="language-plaintext highlighter-rouge">ç¼–è¯‘å¹¶é‡æ–°åŠ è½½æ–‡ä»¶</code>ï¼‰ã€‚</p>

<p>æŸ¥è¯¢<code class="language-plaintext highlighter-rouge">æ›´æ–°æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åº</code>ï¼Œç„¶åé€‰æ‹©ï¼Œå¹¶ç¡®è®¤æ·»åŠ è¯¥åŠŸèƒ½æŒ‰é’®ã€‚ï¼ˆè‹¥æ‰¾ä¸åˆ°ï¼Œåˆ™æ‰‹åŠ¨å®šä½ï¼š<code class="language-plaintext highlighter-rouge">ä¸»èœå•</code>-<code class="language-plaintext highlighter-rouge">è¿è¡Œ</code>-<code class="language-plaintext highlighter-rouge">è°ƒè¯•å™¨æ“ä½œ</code>-<code class="language-plaintext highlighter-rouge">æ›´æ–°æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åº</code>ï¼‰ã€‚</p>

<p>æŸ¥è¯¢<code class="language-plaintext highlighter-rouge">é‡æ–°åŠ è½½å·²æ›´æ”¹çš„ç±»</code>ï¼Œç„¶åé€‰æ‹©ï¼Œå¹¶ç¡®è®¤æ·»åŠ è¯¥åŠŸèƒ½æŒ‰é’®ã€‚ï¼ˆè‹¥æ‰¾ä¸åˆ°ï¼Œåˆ™æ‰‹åŠ¨å®šä½ï¼š<code class="language-plaintext highlighter-rouge">ä¸»èœå•</code>-<code class="language-plaintext highlighter-rouge">è¿è¡Œ</code>-<code class="language-plaintext highlighter-rouge">è°ƒè¯•å™¨æ“ä½œ</code>-<code class="language-plaintext highlighter-rouge">é‡æ–°åŠ è½½å·²æ›´æ”¹çš„ç±»</code>ï¼‰ã€‚</p>

<p>æŸ¥è¯¢<code class="language-plaintext highlighter-rouge">é‡æ–°åŠ è½½å·²æ›´æ”¹çš„ç±»</code>ï¼Œç„¶åé€‰æ‹©ï¼Œå¹¶ç¡®è®¤æ·»åŠ è¯¥åŠŸèƒ½æŒ‰é’®ã€‚ï¼ˆè‹¥æ‰¾ä¸åˆ°ï¼Œåˆ™æ‰‹åŠ¨å®šä½ï¼š<code class="language-plaintext highlighter-rouge">ä¸»èœå•</code>-<code class="language-plaintext highlighter-rouge">è¿è¡Œ</code>-<code class="language-plaintext highlighter-rouge">è°ƒè¯•å™¨æ“ä½œ</code>-<code class="language-plaintext highlighter-rouge">é‡æ–°åŠ è½½å·²æ›´æ”¹çš„ç±»</code>ï¼‰ã€‚</p>

<h2 id="è°ƒè¯•å™¨">è°ƒè¯•å™¨</h2>

<p>è°ƒè¯•å™¨æ²¡æœ‰å¼ºåˆ¶æ­¥å…¥ç­‰æ“ä½œã€‚</p>

<p>æ‰“å¼€è°ƒè¯•å™¨çª—å£ï¼Œé¼ æ ‡ç§»åŠ¨åˆ°è°ƒè¯•å™¨ç›¸å…³æŒ‰é’®æ‰€åœ¨<code class="language-plaintext highlighter-rouge">å·¥å…·æ </code>-å³é”®-<code class="language-plaintext highlighter-rouge">è‡ªå®šä¹‰å·¥å…·æ ..</code>-è¿›å…¥åˆ°<code class="language-plaintext highlighter-rouge">è‡ªå®šä¹‰ è°ƒè¯•å·¥å…·çª—å£é¡¶éƒ¨å·¥å…·æ </code>å¯¹è¯æ¡†ã€‚</p>

<p>ç‚¹å‡»<code class="language-plaintext highlighter-rouge">æ·»åŠ æ“ä½œ</code>æŒ‰é’®-è¿›å…¥åˆ°<code class="language-plaintext highlighter-rouge">æ·»åŠ æ“ä½œ</code>å¯¹è¯æ¡†ã€‚</p>

<p>å®šä½åˆ°<code class="language-plaintext highlighter-rouge">ä¸»èœå•</code>-<code class="language-plaintext highlighter-rouge">è¿è¡Œ</code>-<code class="language-plaintext highlighter-rouge">è°ƒè¯•å™¨æ“ä½œ</code>ï¼Œå¯ä»¥çœ‹åˆ°ç›¸å…³åŠŸèƒ½æŒ‰é’®ã€‚</p>]]></content><author><name>acteds</name></author><category term="Java" /><category term="IDEA" /><summary type="html"><![CDATA[Javaç¬”è®°]]></summary></entry><entry><title type="html">Elasticsearch</title><link href="/2024/12/05/elasticsearch/" rel="alternate" type="text/html" title="Elasticsearch" /><published>2024-12-05T00:00:00+08:00</published><updated>2024-12-05T00:00:00+08:00</updated><id>/2024/12/05/elasticsearch</id><content type="html" xml:base="/2024/12/05/elasticsearch/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p>elasticsearchçš„æ“ä½œæ–¹æ³•ã€‚</p>

<h1 id="elasticsearch">Elasticsearch</h1>

<h2 id="ç®€ä»‹">ç®€ä»‹</h2>

<p>Elasticsearchï¼ˆç®€ç§° ESï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†å¸ƒå¼æœç´¢å¼•æ“ï¼ŒåŸºäº Apache Lucene æ„å»ºï¼Œèƒ½å¤Ÿå­˜å‚¨ã€æœç´¢ã€åˆ†æå¤§é‡æ•°æ®ã€‚å®ƒå¹¿æ³›åº”ç”¨äºæ—¥å¿—åˆ†æã€å…¨æ–‡æœç´¢ã€å®æ—¶æ•°æ®åˆ†æç­‰åœºæ™¯ã€‚å’Œ MongoDB ç±»ä¼¼ï¼ŒElasticsearch ä¹Ÿæ˜¯ä¸€ä¸ª NoSQL æ•°æ®åº“ï¼Œä½†å®ƒä¸»è¦ç”¨äºé«˜æ•ˆçš„æœç´¢å’Œåˆ†æã€‚</p>

<p>Elasticsearch ä¸­çš„æ ¸å¿ƒæ¦‚å¿µåŒ…æ‹¬ï¼š</p>

<ul>
  <li><strong>Indexï¼ˆç´¢å¼•ï¼‰</strong>ï¼šç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­çš„æ•°æ®åº“ã€‚å®ƒæ˜¯ Elasticsearch ä¸­çš„æ•°æ®å­˜å‚¨å•ä½ã€‚</li>
  <li><strong>Documentï¼ˆæ–‡æ¡£ï¼‰</strong>ï¼šç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­çš„ä¸€è¡Œæ•°æ®ã€‚ä¸€ä¸ªæ–‡æ¡£åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µï¼Œæ¯ä¸ªå­—æ®µæœ‰ä¸åŒçš„æ•°æ®ç±»å‹ã€‚</li>
  <li><strong>Fieldï¼ˆå­—æ®µï¼‰</strong>ï¼šç±»ä¼¼äºå…³ç³»æ•°æ®åº“ä¸­çš„åˆ—ã€‚å­—æ®µåŒ…å«å®é™…çš„æ•°æ®ï¼Œæ”¯æŒä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå¦‚æ–‡æœ¬ã€æ•°å­—ã€æ—¥æœŸç­‰ã€‚</li>
  <li><strong>Shardï¼ˆåˆ†ç‰‡ï¼‰</strong>ï¼šElasticsearch å°†ç´¢å¼•æ•°æ®åˆ†æˆå¤šä¸ªåˆ†ç‰‡ï¼Œä»¥ä¾¿åˆ†å¸ƒå¼å­˜å‚¨ã€‚</li>
  <li><strong>Clusterï¼ˆé›†ç¾¤ï¼‰</strong>ï¼šç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼ŒElasticsearch é›†ç¾¤å¯ä»¥æ¨ªå‘æ‰©å±•ä»¥å¤„ç†å¤§è§„æ¨¡çš„æ•°æ®ã€‚</li>
</ul>

<p>ä¸ MongoDB å¯¹æ¯”</p>

<ul>
  <li><strong>æ•°æ®æ¨¡å‹</strong>ï¼š
    <ul>
      <li><strong>MongoDB</strong>ï¼šæ–‡æ¡£å­˜å‚¨ï¼Œçµæ´»çš„ JSON æ ¼å¼æ•°æ®ï¼Œé€‚ç”¨äºå¤šå˜çš„æ•°æ®ç»“æ„ã€‚</li>
      <li><strong>Elasticsearch</strong>ï¼šä¹Ÿä½¿ç”¨ JSON æ ¼å¼ï¼Œä½†ä¸»è¦ç”¨äºé«˜æ•ˆçš„æ–‡æœ¬æœç´¢å’Œåˆ†æï¼Œæ”¯æŒå…¨æ–‡ç´¢å¼•ã€å€’æ’ç´¢å¼•ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>æŸ¥è¯¢</strong>ï¼š
    <ul>
      <li><strong>MongoDB</strong>ï¼šé€šè¿‡ MongoDB çš„æŸ¥è¯¢è¯­è¨€è¿›è¡Œæ•°æ®æŸ¥è¯¢ï¼Œæ”¯æŒå¤šç§æ¡ä»¶å’Œèšåˆæ“ä½œã€‚</li>
      <li><strong>Elasticsearch</strong>ï¼šé€šè¿‡ Elasticsearch çš„æŸ¥è¯¢ DSLï¼ˆæŸ¥è¯¢è¯­è¨€ï¼‰è¿›è¡Œå¤æ‚çš„å…¨æ–‡æœç´¢ã€èšåˆåˆ†æå’Œè¿‡æ»¤æ“ä½œï¼Œå°¤å…¶æ“…é•¿é«˜æ•ˆçš„æ–‡æœ¬æœç´¢ã€‚</li>
    </ul>
  </li>
  <li><strong>æ€§èƒ½</strong>ï¼š
    <ul>
      <li><strong>MongoDB</strong>ï¼šé€‚ç”¨äºå¤§è§„æ¨¡çš„æ•°æ®å­˜å‚¨å’Œå¤„ç†ï¼Œæ”¯æŒé«˜å¹¶å‘è¯»å†™æ“ä½œã€‚</li>
      <li><strong>Elasticsearch</strong>ï¼šä¸“æ³¨äºé«˜æ•ˆçš„æœç´¢å’Œåˆ†æï¼Œå¯ä»¥å¿«é€Ÿå¤„ç†å¤§é‡çš„æ–‡æœ¬æ•°æ®å¹¶æä¾›å®æ—¶æœç´¢åŠŸèƒ½ã€‚</li>
    </ul>
  </li>
</ul>

<p>Elasticsearch éå¸¸é€‚åˆéœ€è¦é«˜æ•ˆæœç´¢å’Œåˆ†æçš„åœºæ™¯ï¼Œé€šå¸¸ä¸ MongoDB é…åˆä½¿ç”¨ï¼ŒMongoDB ç”¨äºå­˜å‚¨ç»“æ„åŒ–æ•°æ®ï¼ŒElasticsearch ç”¨äºå¤„ç†å’Œåˆ†ææ—¥å¿—ã€æ–‡æœ¬ç­‰éç»“æ„åŒ–æ•°æ®ã€‚</p>

<hr />

<p>åœ¨ Elasticsearchï¼ˆESï¼‰ã€MongoDB å’Œ MySQL ä¹‹é—´ï¼Œæœ‰ä¸€äº›é‡è¦çš„ç±»æ¯”å…³ç³»ï¼Œå®ƒä»¬éƒ½å±äºæ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œä½†å®ƒä»¬çš„ç»“æ„å’ŒåŠŸèƒ½æœ‰æ‰€ä¸åŒã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„ä¸»è¦ç»„ä»¶å’Œæ¦‚å¿µçš„å¯¹æ¯”ï¼š</p>

<p><strong>Elasticsearch ä¸ MongoDB/MySQL å¯¹æ¯”</strong></p>

<table>
  <thead>
    <tr>
      <th><strong>Elasticsearch</strong></th>
      <th><strong>MongoDB</strong></th>
      <th><strong>MySQL</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Index</strong></td>
      <td><strong>Collection</strong></td>
      <td><strong>Table</strong></td>
    </tr>
    <tr>
      <td><strong>Document</strong></td>
      <td><strong>Document</strong></td>
      <td><strong>Row</strong></td>
    </tr>
    <tr>
      <td><strong>Field</strong></td>
      <td><strong>Field</strong></td>
      <td><strong>Column</strong></td>
    </tr>
    <tr>
      <td><strong>Shard</strong></td>
      <td>No Direct Equivalent</td>
      <td>No Direct Equivalent</td>
    </tr>
    <tr>
      <td><strong>Cluster</strong></td>
      <td>No Direct Equivalent</td>
      <td>No Direct Equivalent</td>
    </tr>
  </tbody>
</table>

<p><strong>ç´¢å¼•ï¼ˆIndexï¼‰</strong></p>

<ul>
  <li><strong>Elasticsearch</strong>:
    <ul>
      <li>ä¸€ä¸ª <strong>ç´¢å¼•ï¼ˆIndexï¼‰</strong> æ˜¯ Elasticsearch ç”¨æ¥å­˜å‚¨å’Œç»„ç»‡æ–‡æ¡£çš„å•ä½ã€‚æ¯ä¸ªç´¢å¼•åŒ…å«å¤šä¸ªæ–‡æ¡£ï¼Œç±»ä¼¼äºæ•°æ®åº“çš„è¡¨ã€‚ç´¢å¼•é€šå¸¸ç”¨äºå¯¹æ•°æ®è¿›è¡Œåˆ†åŒºå’Œå­˜å‚¨ã€‚</li>
      <li><strong>ä½œç”¨</strong>ï¼šç±»ä¼¼äºæ•°æ®åº“ä¸­çš„â€œè¡¨â€ï¼Œå®ƒå®šä¹‰äº†å­˜å‚¨æ•°æ®çš„ç»“æ„ã€æ˜ å°„è§„åˆ™ï¼ˆæ•°æ®ç±»å‹ç­‰ï¼‰å’Œåˆ†ç‰‡ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>MongoDB</strong>:
    <ul>
      <li><strong>é›†åˆï¼ˆCollectionï¼‰</strong>ï¼šMongoDB ä¸­çš„é›†åˆç±»ä¼¼äº Elasticsearch çš„ç´¢å¼•ã€‚é›†åˆæ˜¯ MongoDB å­˜å‚¨æ–‡æ¡£ï¼ˆæ•°æ®ï¼‰çš„å®¹å™¨ã€‚æ¯ä¸ªé›†åˆåŒ…å«å¤šä¸ªæ–‡æ¡£ï¼Œæ–‡æ¡£ç±»ä¼¼äºä¸€è¡Œæ•°æ®ã€‚</li>
    </ul>
  </li>
  <li><strong>MySQL</strong>:
    <ul>
      <li><strong>è¡¨ï¼ˆTableï¼‰</strong>ï¼šåœ¨ MySQL ä¸­ï¼Œè¡¨æ˜¯æ•°æ®çš„å­˜å‚¨å•ä½ã€‚æ¯ä¸ªè¡¨ç”±å¤šè¡Œæ•°æ®ç»„æˆï¼Œæ¯ä¸€è¡ŒåŒ…å«å¤šä¸ªåˆ—ã€‚è¡¨ä¸­çš„æ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªè®°å½•ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>æ–‡æ¡£ï¼ˆDocumentï¼‰</strong></p>

<ul>
  <li><strong>Elasticsearch</strong>:
    <ul>
      <li><strong>æ–‡æ¡£ï¼ˆDocumentï¼‰</strong> æ˜¯ Elasticsearch å­˜å‚¨çš„åŸºæœ¬æ•°æ®å•ä½ï¼Œç±»ä¼¼äº MongoDB ä¸­çš„æ–‡æ¡£æˆ–è€… MySQL ä¸­çš„è¡Œã€‚æ¯ä¸ªæ–‡æ¡£éƒ½æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼Œè¡¨ç¤ºä¸€ä¸ªå®Œæ•´çš„è®°å½•ã€‚ä¸€ä¸ªæ–‡æ¡£åŒ…å«å¤šä¸ªå­—æ®µï¼ˆç±»ä¼¼äºåˆ—ï¼‰ã€‚</li>
    </ul>
  </li>
  <li><strong>MongoDB</strong>:
    <ul>
      <li><strong>æ–‡æ¡£ï¼ˆDocumentï¼‰</strong>ï¼šMongoDB ä¸­çš„æ–‡æ¡£æ˜¯åŸºæœ¬çš„æ•°æ®å•å…ƒï¼Œå®ƒä»¬æ˜¯ä»¥ BSON æ ¼å¼ï¼ˆç±»ä¼¼äº JSONï¼‰å­˜å‚¨çš„ã€‚æ¯ä¸ªæ–‡æ¡£å¯ä»¥åŒ…å«å¤šä¸ªå­—æ®µï¼ˆç±»ä¼¼äºè¡¨çš„åˆ—ï¼‰ï¼Œè€Œä¸”å­—æ®µç±»å‹æ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å­˜å‚¨ä¸åŒçš„ç»“æ„ã€‚</li>
    </ul>
  </li>
  <li><strong>MySQL</strong>:
    <ul>
      <li><strong>è¡Œï¼ˆRowï¼‰</strong>ï¼šMySQL ä¸­çš„æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªè®°å½•ã€‚è¡Œä¸­çš„æ¯ä¸€åˆ—å¯¹åº”è¡¨çš„å­—æ®µã€‚ä¸ Elasticsearch çš„æ–‡æ¡£ç±»ä¼¼ï¼ŒMySQL çš„ä¸€è¡Œä»£è¡¨äº†ä¸€ä¸ªå®Œæ•´çš„æ•°æ®è®°å½•ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>å­—æ®µï¼ˆFieldï¼‰</strong></p>

<ul>
  <li><strong>Elasticsearch</strong>:
    <ul>
      <li><strong>å­—æ®µï¼ˆFieldï¼‰</strong> æ˜¯æ–‡æ¡£ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå­˜å‚¨ç‰¹å®šçš„å€¼æˆ–å±æ€§ã€‚æ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸€ä¸ªæ•°æ®ç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•´æ•°ã€æ—¥æœŸç­‰ï¼‰ï¼Œå¹¶ä¸”æ”¯æŒä¸åŒçš„æœç´¢ã€æ’åºå’Œèšåˆæ“ä½œã€‚</li>
    </ul>
  </li>
  <li><strong>MongoDB</strong>:
    <ul>
      <li><strong>å­—æ®µï¼ˆFieldï¼‰</strong>ï¼šæ¯ä¸ª MongoDB æ–‡æ¡£ç”±å¤šä¸ªå­—æ®µç»„æˆï¼Œå­—æ®µæ˜¯æ•°æ®çš„åŸºæœ¬å•å…ƒã€‚å­—æ®µå¯ä»¥æ˜¯ç®€å•çš„æ•°å€¼æˆ–å¤æ‚çš„åµŒå¥—ç»“æ„ã€‚å­—æ®µç±»ä¼¼äºæ•°æ®åº“è¡¨ä¸­çš„åˆ—ã€‚</li>
    </ul>
  </li>
  <li><strong>MySQL</strong>:
    <ul>
      <li><strong>åˆ—ï¼ˆColumnï¼‰</strong>ï¼šMySQL ä¸­çš„åˆ—è¡¨ç¤ºè¡¨çš„å­—æ®µã€‚æ¯ä¸ªåˆ—æœ‰å›ºå®šçš„æ•°æ®ç±»å‹å’Œçº¦æŸï¼ˆå¦‚ NOT NULLã€UNIQUE ç­‰ï¼‰ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>åˆ†ç‰‡ï¼ˆShardï¼‰</strong></p>

<ul>
  <li><strong>Elasticsearch</strong>:
    <ul>
      <li><strong>åˆ†ç‰‡ï¼ˆShardï¼‰</strong> æ˜¯ Elasticsearch ä¸­ç”¨äºåˆ†å¸ƒå¼å­˜å‚¨å’Œå¤„ç†çš„å•ä½ã€‚æ¯ä¸ªç´¢å¼•å¯ä»¥åˆ†ä¸ºå¤šä¸ªåˆ†ç‰‡ï¼Œåˆ†ç‰‡å¯ä»¥å­˜å‚¨åœ¨é›†ç¾¤ä¸­çš„ä¸åŒèŠ‚ç‚¹ä¸Šï¼Œä»è€Œæé«˜å¯æ‰©å±•æ€§å’Œå¹¶å‘å¤„ç†èƒ½åŠ›ã€‚</li>
    </ul>
  </li>
  <li><strong>MongoDB &amp; MySQL</strong>:
    <ul>
      <li>MongoDB å’Œ MySQL éƒ½æ²¡æœ‰ç›´æ¥ç±»ä¼¼äºåˆ†ç‰‡çš„æ¦‚å¿µï¼ˆå°½ç®¡ MongoDB æ”¯æŒåˆ†ç‰‡ï¼‰ã€‚ä½†æ˜¯ï¼ŒMongoDB çš„é›†åˆå’Œ MySQL çš„è¡¨ä¹Ÿå¯ä»¥åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šåˆ†å¸ƒå’Œå­˜å‚¨æ•°æ®ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦æ°´å¹³æ‰©å±•çš„åœºæ™¯ä¸­ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>é›†ç¾¤ï¼ˆClusterï¼‰</strong></p>

<ul>
  <li><strong>Elasticsearch</strong>:
    <ul>
      <li><strong>é›†ç¾¤ï¼ˆClusterï¼‰</strong> æ˜¯ Elasticsearch ä¸­ç”±å¤šä¸ªèŠ‚ç‚¹ç»„æˆçš„ä¸€ä¸ªé›†åˆã€‚é›†ç¾¤ä¸­çš„èŠ‚ç‚¹å…±äº«æ•°æ®ï¼Œå¹¶å…±åŒå®Œæˆæ•°æ®çš„åˆ†ç‰‡å’Œå¤åˆ¶ä»»åŠ¡ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§å’Œæ‰©å±•æ€§ã€‚</li>
    </ul>
  </li>
  <li><strong>MongoDB &amp; MySQL</strong>:
    <ul>
      <li>MongoDB å’Œ MySQL éƒ½æœ‰æ”¯æŒåˆ†å¸ƒå¼æ¶æ„çš„åŠŸèƒ½ï¼ŒMongoDB ä½¿ç”¨ <strong>å‰¯æœ¬é›†ï¼ˆReplica Setï¼‰</strong> å’Œ <strong>åˆ†ç‰‡ï¼ˆShardingï¼‰</strong> æœºåˆ¶æ¥å®ç°æ•°æ®çš„é«˜å¯ç”¨æ€§å’Œæ¨ªå‘æ‰©å±•ã€‚è€Œ MySQL å¯ä»¥é€šè¿‡ <strong>ä¸»ä»å¤åˆ¶ï¼ˆMaster-Slave Replicationï¼‰</strong> æˆ– <strong>åˆ†åŒºè¡¨ï¼ˆPartitioningï¼‰</strong> æ¥å®ç°ç±»ä¼¼çš„åŠŸèƒ½ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>æ€»ç»“</strong></p>

<ul>
  <li>Elasticsearch æ›´ä¾§é‡äº<strong>å…¨æ–‡æœç´¢</strong>å’Œ<strong>å¤§æ•°æ®åˆ†æ</strong>ï¼Œå¹¶ä¸”ä½¿ç”¨ <strong>ç´¢å¼•ï¼ˆIndexï¼‰</strong> æ¥ç®¡ç†æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼Œå®ƒéå¸¸é€‚åˆç”¨äºå¿«é€ŸæŸ¥è¯¢å’Œåˆ†æå¤§é‡çš„éç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚æ—¥å¿—ã€æ–‡æœ¬ç­‰ï¼‰ã€‚</li>
  <li>MongoDB å’Œ MySQL åˆ™æ˜¯ä¼ ç»Ÿçš„æ•°æ®åº“ï¼ŒMongoDB æ˜¯ä¸€ä¸ªæ–‡æ¡£å‹æ•°æ®åº“ï¼ŒMySQL æ˜¯ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ã€‚MongoDB ä½¿ç”¨<strong>é›†åˆï¼ˆCollectionï¼‰</strong>å­˜å‚¨æ–‡æ¡£æ•°æ®ï¼ŒMySQL ä½¿ç”¨<strong>è¡¨ï¼ˆTableï¼‰</strong>å­˜å‚¨æ•°æ®ã€‚</li>
</ul>

<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>

<p>å‡è®¾ä½ æœ‰ä¸€ä¸ªç”¨æˆ·ä¿¡æ¯çš„è¡¨ï¼Œå­˜å‚¨åœ¨ MySQL ä¸­ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<ul>
  <li><strong>è¡¨</strong>ï¼š<code class="language-plaintext highlighter-rouge">users</code>
    <ul>
      <li><strong>å­—æ®µ</strong>ï¼š<code class="language-plaintext highlighter-rouge">user_id</code>ï¼ˆä¸»é”®ï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">name</code>ï¼Œ<code class="language-plaintext highlighter-rouge">email</code>ï¼Œ<code class="language-plaintext highlighter-rouge">created_at</code></li>
    </ul>
  </li>
</ul>

<p>åœ¨ Elasticsearch ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <strong>ç´¢å¼•ï¼ˆIndexï¼‰</strong> æ¥å­˜å‚¨ç±»ä¼¼çš„æ–‡æ¡£æ•°æ®ï¼Œç»“æ„å¦‚ä¸‹ï¼š</p>
<ul>
  <li><strong>ç´¢å¼•</strong>ï¼š<code class="language-plaintext highlighter-rouge">users</code>
    <ul>
      <li><strong>æ–‡æ¡£</strong>ï¼šæ¯ä¸ªæ–‡æ¡£ä»£è¡¨ä¸€ä¸ªç”¨æˆ·ï¼ŒåŒ…å«ç±»ä¼¼å­—æ®µï¼š<code class="language-plaintext highlighter-rouge">user_id</code>ï¼Œ<code class="language-plaintext highlighter-rouge">name</code>ï¼Œ<code class="language-plaintext highlighter-rouge">email</code>ï¼Œ<code class="language-plaintext highlighter-rouge">created_at</code>ã€‚</li>
    </ul>
  </li>
</ul>

<p>å¯¹äº MongoDBï¼Œä½ çš„ <strong>é›†åˆï¼ˆCollectionï¼‰</strong> ä¹Ÿå¯ä»¥å­˜å‚¨è¿™äº›æ•°æ®ï¼Œæ¯ä¸ª <strong>æ–‡æ¡£ï¼ˆDocumentï¼‰</strong> ä¹ŸåŒ…å«è¿™äº›å­—æ®µã€‚</p>

<h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h2>

<p>å¼•å…¥ä¾èµ–ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>co.elastic.clients<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>elasticsearch-java<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>8.10.4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.12.3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>é…ç½®ESå±æ€§ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">custom</span><span class="pi">:</span>
  <span class="na">elasticsearch</span><span class="pi">:</span>
    <span class="c1"># ES æœåŠ¡ç«¯çš„ç”¨æˆ·åï¼Œé»˜è®¤å€¼æ˜¯ "elastic"ã€‚è¿™æ˜¯è¿æ¥åˆ° Elasticsearch çš„è®¤è¯å‡­è¯ã€‚</span>
    <span class="na">UserName</span><span class="pi">:</span> <span class="s">${ES_USERNAME:elastic}</span>

    <span class="c1"># ES æœåŠ¡ç«¯çš„å¯†ç ï¼Œé»˜è®¤å€¼æ˜¯ "*"ã€‚è¿™æ˜¯è¿æ¥åˆ° Elasticsearch çš„è®¤è¯å‡­è¯ã€‚</span>
    <span class="na">Password</span><span class="pi">:</span> <span class="s">${ES_PASSWORD:*}</span>

    <span class="c1"># Elasticsearch æœåŠ¡ç«¯åœ°å€ï¼Œé»˜è®¤å€¼æ˜¯ "*:9200"ã€‚å¯ä»¥æŒ‡å®šå¤šä¸ªåœ°å€ï¼Œä»¥é€—å·åˆ†éš”ï¼Œå¦‚æœæ˜¯é›†ç¾¤æ¨¡å¼ï¼Œé…ç½®å¤šä¸ªèŠ‚ç‚¹åœ°å€ä»¥ä¿è¯é«˜å¯ç”¨ã€‚</span>
    <span class="na">address</span><span class="pi">:</span> <span class="s">${ES_ADDR:*:9200}</span>

    <span class="c1"># ç½‘ç»œé“¾æ¥åè®®ï¼Œé»˜è®¤ä¸º "http"ã€‚å¯ä»¥é€‰æ‹© "http" æˆ– "https"ã€‚</span>
    <span class="na">schema</span><span class="pi">:</span> <span class="s">${ES_SCHEMA:http}</span>

    <span class="c1"># è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚æ­¤é…ç½®å†³å®šäº†å®¢æˆ·ç«¯è¿æ¥åˆ° Elasticsearch æœåŠ¡å™¨æ—¶çš„æœ€å¤§ç­‰å¾…æ—¶é—´ã€‚é»˜è®¤ 6000 æ¯«ç§’ï¼Œå³ 6 ç§’ã€‚</span>
    <span class="na">connectTimeout</span><span class="pi">:</span> <span class="m">6000</span>

    <span class="c1"># Socket è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚è¿™ä¸ªé…ç½®ç”¨äºè§„å®šè¿æ¥å»ºç«‹åï¼Œæ¥æ”¶æ•°æ®æ—¶çš„è¶…æ—¶é™åˆ¶ï¼Œé»˜è®¤ 6000 æ¯«ç§’ã€‚</span>
    <span class="na">socketTimeout</span><span class="pi">:</span> <span class="m">6000</span>

    <span class="c1"># æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤ 100ã€‚è®¾ç½®è¿æ¥æ± ä¸­æ‰€æœ‰è¿æ¥çš„æœ€å¤§æ•°é‡ã€‚å¦‚æœè¿æ¥æ•°è¾¾åˆ°æœ€å¤§å€¼ï¼Œå…¶ä»–è¯·æ±‚ä¼šç­‰å¾…ï¼Œç›´åˆ°æœ‰è¿æ¥å¯ç”¨ã€‚</span>
    <span class="na">maxConnectNum</span><span class="pi">:</span> <span class="m">100</span>

    <span class="c1"># æ¯ä¸ªè·¯ç”±ï¼ˆæ¯ä¸ª Elasticsearch é›†ç¾¤èŠ‚ç‚¹ï¼‰å…è®¸çš„æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤ 100ã€‚è¿™ä¸ªé…ç½®ç”¨äºæ§åˆ¶ä¸é›†ç¾¤å†…å•ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°ã€‚</span>
    <span class="na">maxConnectPerRoute</span><span class="pi">:</span> <span class="m">100</span>
</code></pre></div></div>

<p>é…ç½®è¿æ¥æ—¶æ•ˆï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.DefaultConnectionKeepAliveStrategy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.protocol.HttpContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="c1">// è‡ªå®šä¹‰ KeepAlive æ—¶é™ç­–ç•¥</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomConnectionKeepAliveStrategy</span> <span class="kd">extends</span> <span class="nc">DefaultConnectionKeepAliveStrategy</span> <span class="o">{</span>

    <span class="c1">// åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œç¡®ä¿æ•´ä¸ªåº”ç”¨ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">CustomConnectionKeepAliveStrategy</span> <span class="no">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CustomConnectionKeepAliveStrategy</span><span class="o">();</span>

    <span class="c1">// ç§æœ‰æ„é€ æ–¹æ³•ï¼Œç¡®ä¿ç±»çš„å®ä¾‹åªé€šè¿‡ä¸Šè¿°é™æ€æˆå‘˜è®¿é—®</span>
    <span class="kd">private</span> <span class="nf">CustomConnectionKeepAliveStrategy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æœ€å¤§ KeepAlive çš„æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
     * &lt;p&gt;
     * è¿™é‡Œé»˜è®¤ä¸º 10 åˆ†é’Ÿï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè®¾ç½®ã€‚è¯¥å€¼ç”¨äºæ§åˆ¶ HTTP è¿æ¥ä¿æŒçš„æœ€é•¿æ—¶é—´ã€‚
     * å¦‚æœå®¢æˆ·ç«¯æœºå™¨çš„ TCP è¿æ¥æ•°å¤„äº TIME_WAIT çŠ¶æ€è¿‡å¤šï¼Œé€‚å½“å¢åŠ æ­¤å€¼å¯ä»¥é¿å…é¢‘ç¹å…³é—­è¿æ¥ã€‚
     * &lt;/p&gt;
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">MAX_KEEP_ALIVE_MINUTES</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

    <span class="cm">/**
     * é‡å†™çˆ¶ç±»çš„ `getKeepAliveDuration` æ–¹æ³•
     * &lt;p&gt;
     * è¯¥æ–¹æ³•å†³å®šäº† HTTP è¿æ¥ä¿æŒçš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ã€‚å¦‚æœçˆ¶ç±»è¿”å›è´Ÿå€¼ï¼ˆè¡¨ç¤ºæ— é™æœŸä¿æŒè¿æ¥ï¼‰ï¼Œ
     * å°†å…¶æ›¿æ¢ä¸ºè‡ªå®šä¹‰çš„æœ€å¤§ä¿æŒæ—¶é•¿ï¼ˆ10 åˆ†é’Ÿï¼‰ã€‚
     * &lt;/p&gt;
     *
     * @param response HTTP å“åº”å¯¹è±¡
     * @param context HTTP ä¸Šä¸‹æ–‡
     * @return è¿æ¥ä¿æŒçš„æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getKeepAliveDuration</span><span class="o">(</span><span class="nc">HttpResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">HttpContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// è°ƒç”¨çˆ¶ç±»çš„å®ç°ï¼Œè·å–é»˜è®¤çš„ Keep-Alive æ—¶é•¿</span>
        <span class="kt">long</span> <span class="n">keepAliveDuration</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getKeepAliveDuration</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>

        <span class="c1">// å¦‚æœçˆ¶ç±»è¿”å›çš„æ˜¯è´Ÿå€¼ï¼ˆè¡¨ç¤ºè¿æ¥åº”è¯¥æ— é™æœŸä¿æŒï¼‰</span>
        <span class="c1">// åˆ™å°†å…¶æ›¿æ¢ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„æœ€å¤§ä¿æŒæ—¶é•¿ï¼ˆ10 åˆ†é’Ÿï¼‰</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">keepAliveDuration</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="no">MAX_KEEP_ALIVE_MINUTES</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// è¿”å›çˆ¶ç±»è·å–çš„æ—¶é•¿</span>
        <span class="k">return</span> <span class="n">keepAliveDuration</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>åˆ›å»ºESè¿æ¥ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">co.elastic.clients.elasticsearch.ElasticsearchClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">co.elastic.clients.json.jackson.JacksonJsonpMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">co.elastic.clients.transport.ElasticsearchTransport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">co.elastic.clients.transport.rest_client.RestClientTransport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.HttpHost</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.auth.AuthScope</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.auth.UsernamePasswordCredentials</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.client.CredentialsProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.http.impl.client.BasicCredentialsProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.client.RestClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.client.RestClientBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * é…ç½®ç±»ï¼Œç”¨äºåˆå§‹åŒ–ä¸ Elasticsearch é›†ç¾¤çš„è¿æ¥é…ç½®ã€‚
 * &lt;p&gt;
 * è¯¥ç±»é€šè¿‡ Spring é…ç½®æœºåˆ¶ï¼Œè¯»å–å¤–éƒ¨é…ç½®æ–‡ä»¶ä¸­çš„ç›¸å…³è®¾ç½®ï¼Œåˆ›å»ºå¹¶é…ç½®ä¸€ä¸ª {@link ElasticsearchClient} å®ä¾‹ã€‚
 * å®ƒè‡ªå®šä¹‰äº†è¿æ¥è¶…æ—¶ã€è®¤è¯ä¿¡æ¯ã€æœ€å¤§è¿æ¥æ•°ç­‰ï¼Œå¹¶é…ç½®äº†è¿æ¥æ± ç®¡ç†ä¸è¿æ¥ä¿æ´»ç­–ç•¥ã€‚
 * &lt;/p&gt;
 */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticSearchConfig</span> <span class="o">{</span>

    <span class="cm">/** åè®®ï¼Œä¾‹å¦‚ "http" æˆ– "https" */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.elasticsearch.schema:http}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">schema</span><span class="o">;</span>

    <span class="cm">/** Elasticsearch é›†ç¾¤åœ°å€ï¼Œå¤šä¸ªåœ°å€ç”¨é€—å·åˆ†éš” */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.elasticsearch.address}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>

    <span class="cm">/** è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.elasticsearch.connectTimeout}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">connectTimeout</span><span class="o">;</span>

    <span class="cm">/** Socket è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.elasticsearch.socketTimeout}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">socketTimeout</span><span class="o">;</span>

    <span class="cm">/** æœ€å¤§è¿æ¥æ•° */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.elasticsearch.maxConnectNum}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxConnectNum</span><span class="o">;</span>

    <span class="cm">/** æœ€å¤§è·¯ç”±è¿æ¥æ•°ï¼Œæ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•° */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.elasticsearch.maxConnectPerRoute}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxConnectPerRoute</span><span class="o">;</span>

    <span class="cm">/** Elasticsearch ç”¨æˆ·åï¼Œç”¨äº Basic Authentication */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.elasticsearch.UserName}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">;</span>

    <span class="cm">/** Elasticsearch å¯†ç ï¼Œç”¨äº Basic Authentication */</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${custom.elasticsearch.Password}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>

    <span class="cm">/**
     * åˆ›å»ºå¹¶é…ç½®ä¸€ä¸ª {@link ElasticsearchTransport} å®ä¾‹ã€‚
     * &lt;p&gt;
     * æœ¬æ–¹æ³•é€šè¿‡ Spring æ³¨è§£ {@link Bean} æ¥å®šä¹‰ä¸€ä¸ª Beanï¼Œä¾› Spring ç®¡ç†ã€‚
     * å®ƒé…ç½®äº† Elasticsearch é›†ç¾¤çš„è¿æ¥ä¿¡æ¯ï¼ŒåŒ…æ‹¬åè®®ã€åœ°å€ã€è®¤è¯ä¿¡æ¯ã€è¿æ¥æ± å’Œè¶…æ—¶è®¾ç½®ã€‚
     * &lt;/p&gt;
     *
     * @return é…ç½®å¥½çš„ {@link ElasticsearchTransport} å®ä¾‹
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ElasticsearchTransport</span> <span class="nf">getElasticsearchTransport</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// å°†å¤šä¸ª Elasticsearch é›†ç¾¤åœ°å€æ‹†åˆ†ä¸º HttpHost æ•°ç»„</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">hostList</span> <span class="o">=</span> <span class="n">address</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
        <span class="nc">HttpHost</span><span class="o">[]</span> <span class="n">httpHost</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">hostList</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">addr</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">host</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">":"</span><span class="o">)[</span><span class="mi">0</span><span class="o">];</span>  <span class="c1">// æå–ä¸»æœºéƒ¨åˆ†</span>
            <span class="nc">String</span> <span class="n">port</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">":"</span><span class="o">)[</span><span class="mi">1</span><span class="o">];</span>  <span class="c1">// æå–ç«¯å£éƒ¨åˆ†</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">HttpHost</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">port</span><span class="o">),</span> <span class="n">schema</span><span class="o">);</span> <span class="c1">// æ„å»º HttpHost å¯¹è±¡</span>
        <span class="o">}).</span><span class="na">toArray</span><span class="o">(</span><span class="nc">HttpHost</span><span class="o">[]::</span><span class="k">new</span><span class="o">);</span>

        <span class="c1">// è®¾ç½® Basic Authentication è®¤è¯</span>
        <span class="kd">final</span> <span class="nc">CredentialsProvider</span> <span class="n">credentialsProvider</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BasicCredentialsProvider</span><span class="o">();</span>
        <span class="n">credentialsProvider</span><span class="o">.</span><span class="na">setCredentials</span><span class="o">(</span><span class="nc">AuthScope</span><span class="o">.</span><span class="na">ANY</span><span class="o">,</span> <span class="k">new</span> <span class="nc">UsernamePasswordCredentials</span><span class="o">(</span><span class="n">userName</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span>

        <span class="c1">// åˆ›å»º RestClient æ„å»ºå™¨ï¼Œé…ç½®è¿æ¥è¶…æ—¶å’Œ Socket è¶…æ—¶</span>
        <span class="nc">RestClientBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="nc">RestClient</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">httpHost</span><span class="o">).</span><span class="na">setRequestConfigCallback</span><span class="o">(</span><span class="n">requestConfigBuilder</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// é…ç½®è¿æ¥å’Œ Socket è¶…æ—¶</span>
            <span class="n">requestConfigBuilder</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="n">connectTimeout</span><span class="o">);</span>
            <span class="n">requestConfigBuilder</span><span class="o">.</span><span class="na">setSocketTimeout</span><span class="o">(</span><span class="n">socketTimeout</span><span class="o">);</span>
            <span class="n">requestConfigBuilder</span><span class="o">.</span><span class="na">setConnectionRequestTimeout</span><span class="o">(</span><span class="n">socketTimeout</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">requestConfigBuilder</span><span class="o">;</span>
        <span class="o">}).</span><span class="na">setHttpClientConfigCallback</span><span class="o">(</span><span class="n">httpClientBuilder</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// ç¦ç”¨è®¤è¯ç¼“å­˜ï¼Œè®¾ç½®æœ€å¤§è¿æ¥æ•°å’Œè¿æ¥ä¿æ´»ç­–ç•¥</span>
            <span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">disableAuthCaching</span><span class="o">();</span>  <span class="c1">// ç¦ç”¨è®¤è¯ç¼“å­˜</span>
            <span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">setKeepAliveStrategy</span><span class="o">(</span><span class="nc">CustomConnectionKeepAliveStrategy</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>  <span class="c1">// è®¾ç½®ä¿æ´»ç­–ç•¥</span>
            <span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">setMaxConnTotal</span><span class="o">(</span><span class="n">maxConnectNum</span><span class="o">);</span>  <span class="c1">// è®¾ç½®æœ€å¤§è¿æ¥æ•°</span>
            <span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">setMaxConnPerRoute</span><span class="o">(</span><span class="n">maxConnectPerRoute</span><span class="o">);</span>  <span class="c1">// è®¾ç½®æ¯ä¸ªè·¯ç”±çš„æœ€å¤§è¿æ¥æ•°</span>
            <span class="c1">// æ˜¾å¼è°ƒç”¨æ–¹æ³•æ¥æ·»åŠ æ‹¦æˆªå™¨</span>
            <span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">addInterceptorFirst</span><span class="o">((</span><span class="nc">HttpRequestInterceptor</span><span class="o">)</span> <span class="k">new</span> <span class="nc">RequestLogger</span><span class="o">());</span>  <span class="c1">// æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨</span>
            <span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">addInterceptorLast</span><span class="o">((</span><span class="nc">HttpResponseInterceptor</span><span class="o">)</span> <span class="k">new</span> <span class="nc">RequestLogger</span><span class="o">());</span> <span class="c1">// æ·»åŠ å“åº”æ‹¦æˆªå™¨</span>
            <span class="c1">// è®¾ç½®è®¤è¯ä¿¡æ¯</span>
            <span class="k">return</span> <span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">setDefaultCredentialsProvider</span><span class="o">(</span><span class="n">credentialsProvider</span><span class="o">);</span>
        <span class="o">});</span>

        <span class="c1">// æ„å»º RestClient å®ä¾‹</span>
        <span class="nc">RestClient</span> <span class="n">restClient</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="c1">// åˆ›å»º ElasticsearchTransport</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">RestClientTransport</span><span class="o">(</span><span class="n">restClient</span><span class="o">,</span> <span class="k">new</span> <span class="nc">JacksonJsonpMapper</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="cm">/**
     * åˆ›å»ºä¸€ä¸ª {@link ElasticsearchClient} å®ä¾‹ã€‚
     * @param transport å®ç° Elasticsearch ç‰¹æ€§çš„ä¼ è¾“å±‚
     * @return
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ElasticsearchClient</span> <span class="nf">docqaElasticsearchClient</span><span class="o">(</span><span class="nc">ElasticsearchTransport</span> <span class="n">transport</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ElasticsearchClient</span><span class="o">(</span><span class="n">transport</span><span class="o">);</span>  <span class="c1">// è¿”å›é…ç½®å¥½çš„ ElasticsearchClient å®ä¾‹</span>
    <span class="o">}</span>
    <span class="cm">/**
     * åˆ›å»ºä¸€ä¸ª {@link ElasticsearchAsyncClient} å®ä¾‹ã€‚
     * @param transport å®ç° Elasticsearch ç‰¹æ€§çš„ä¼ è¾“å±‚
     * @return
     */</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ElasticsearchAsyncClient</span> <span class="nf">docqaElasticsearchAsyncClient</span><span class="o">(</span><span class="nc">ElasticsearchTransport</span> <span class="n">transport</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ElasticsearchAsyncClient</span><span class="o">(</span><span class="n">transport</span><span class="o">);</span>  <span class="c1">// è¿”å›é…ç½®å¥½çš„ ElasticsearchClient å®ä¾‹</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">RestClient</code>è¿™ä¸ªç±»ä¸»è¦æ˜¯ç”¨ä½œäºä¸æœåŠ¡ç«¯IPä»¥åŠç«¯å£çš„é…ç½®ï¼Œåœ¨å…¶çš„<code class="language-plaintext highlighter-rouge">builder()</code>æ–¹æ³•å¯ä»¥è®¾ç½®ç™»é™†æƒé™çš„è´¦å·å¯†ç ã€è¿æ¥æ—¶é•¿ç­‰ç­‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">RestClientTransport</code></strong> æ˜¯<code class="language-plaintext highlighter-rouge">Jackson</code>æ˜ å°„å™¨åˆ›å»ºä¼ è¾“ã€‚å»ºç«‹å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¹‹é—´çš„è¿æ¥ä¼ è¾“æ•°æ®ã€‚è¿™æ˜¯åœ¨åˆ›å»º<code class="language-plaintext highlighter-rouge">ElasticsearchClient</code>éœ€è¦çš„å‚æ•°ï¼Œè€Œåˆ›å»º<code class="language-plaintext highlighter-rouge">RestClientTransport</code>å°±éœ€è¦ä¸Šé¢åˆ›å»ºçš„<code class="language-plaintext highlighter-rouge">RestClient</code>ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">ElasticsearchClient</code></strong> æ˜¯ Elasticsearch é«˜çº§å®¢æˆ·ç«¯ï¼ŒåŸºäº <code class="language-plaintext highlighter-rouge">RestClientTransport</code> æ„å»ºï¼Œå®ƒæä¾›äº†æ›´ä¸ºä¾¿æ·çš„ APIï¼Œå¸®åŠ©å¼€å‘è€…é€šè¿‡ Java ä»£ç ä¸ Elasticsearch è¿›è¡Œäº¤äº’ã€‚æä¾›æ›´åŠ æŠ½è±¡å’Œå°è£…çš„æ¥å£ï¼Œå…è®¸æ‰§è¡Œå„ç§ Elasticsearch æ“ä½œï¼ˆå¦‚ç´¢å¼•ã€æœç´¢ã€åˆ é™¤ç­‰ï¼‰ã€‚åŸºäº <code class="language-plaintext highlighter-rouge">RestClientTransport</code>ï¼Œå®ƒå°†åº•å±‚çš„ HTTP è¯·æ±‚è½¬æ¢ä¸ºæ›´é«˜å±‚çš„ Elasticsearch æ“ä½œã€‚æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥æ“ä½œã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">ElasticsearchAsyncClient</code></strong> æ˜¯ <code class="language-plaintext highlighter-rouge">ElasticsearchClient</code> çš„å¼‚æ­¥ç‰ˆæœ¬ï¼Œå®ƒç”¨äºæ‰§è¡Œå¼‚æ­¥çš„ Elasticsearch æ“ä½œï¼Œæ”¯æŒéé˜»å¡ I/O æ“ä½œã€‚</li>
  <li>æä¾›ä¸ <code class="language-plaintext highlighter-rouge">ElasticsearchClient</code> ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ‰€æœ‰è¯·æ±‚å’Œå“åº”æ“ä½œéƒ½ä¸é˜»å¡çº¿ç¨‹ã€‚é€‚ç”¨äºéœ€è¦é«˜ååé‡æˆ–å¹¶å‘è¯·æ±‚çš„åœºæ™¯ï¼Œé¿å…äº†çº¿ç¨‹çš„é˜»å¡ã€‚å¼‚æ­¥æ“ä½œé€šå¸¸ä¼šè¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">CompletableFuture</code> å¯¹è±¡ï¼Œå…è®¸è°ƒç”¨è€…åœ¨æ“ä½œå®Œæˆæ—¶è·å–ç»“æœã€‚</li>
</ul>

<h2 id="æ‰“å¼€æ—¥å¿—">æ‰“å¼€æ—¥å¿—</h2>

<p>æ–°å»ºä¸€ä¸ªæ—¥å¿—æ‰“å°ç±»ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="kd">class</span> <span class="nc">RequestLogger</span> <span class="kd">implements</span> <span class="nc">HttpRequestInterceptor</span><span class="o">,</span> <span class="nc">HttpResponseInterceptor</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">HttpRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Log request details</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"è¯·æ±‚ URI: "</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestLine</span><span class="o">().</span><span class="na">getUri</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"è¯·æ±‚æ–¹æ³•ï¼š "</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestLine</span><span class="o">().</span><span class="na">getMethod</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"è¯·æ±‚æ ‡å¤´ï¼š"</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getAllHeaders</span><span class="o">()));</span>

        <span class="c1">// è·å–è¯·æ±‚ä½“å†…å®¹</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">request</span> <span class="k">instanceof</span> <span class="nc">HttpEntityEnclosingRequest</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">HttpEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="o">((</span><span class="nc">HttpEntityEnclosingRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">).</span><span class="na">getEntity</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">entity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ç¼“å­˜è¯·æ±‚ä½“å†…å®¹</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">entityContent</span> <span class="o">=</span> <span class="n">entityToBytes</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">entityContent</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">entityContent</span><span class="o">);</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"è¯·æ±‚ä½“ï¼š"</span> <span class="o">+</span> <span class="n">body</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">HttpResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">HttpContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// Log response details</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"å“åº”çŠ¶æ€ï¼š "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatusLine</span><span class="o">());</span>
        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"å“åº”æ ‡å¤´ï¼š "</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getAllHeaders</span><span class="o">()));</span>
        <span class="c1">// è·å–å“åº”ä½“å†…å®¹</span>
        <span class="nc">HttpEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getEntity</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">entity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ç¼“å­˜å“åº”ä½“å†…å®¹</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">entityContent</span> <span class="o">=</span> <span class="n">entityToBytes</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">entityContent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">entityContent</span><span class="o">);</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"å“åº”ä½“ï¼š"</span> <span class="o">+</span> <span class="n">body</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/**
     * å°† HttpEntity å†…å®¹è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
     * @param entity HttpEntity
     * @return å­—èŠ‚æ•°ç»„
     */</span>
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">entityToBytes</span><span class="o">(</span><span class="nc">HttpEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">entity</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">InputStream</span> <span class="n">content</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
             <span class="nc">ByteArrayOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">())</span> <span class="o">{</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">bytesRead</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">bytesRead</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytesRead</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// å¤„ç†å¼‚å¸¸ï¼Œè¿”å›nullæˆ–è€…å…¶ä»–é»˜è®¤å€¼</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>æ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">RestClientBuilder</code>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ˜¾å¼è°ƒç”¨æ–¹æ³•æ¥æ·»åŠ æ‹¦æˆªå™¨</span>
<span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">addInterceptorFirst</span><span class="o">((</span><span class="nc">HttpRequestInterceptor</span><span class="o">)</span> <span class="k">new</span> <span class="nc">RequestLogger</span><span class="o">());</span>  <span class="c1">// æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨</span>
<span class="n">httpClientBuilder</span><span class="o">.</span><span class="na">addInterceptorLast</span><span class="o">((</span><span class="nc">HttpResponseInterceptor</span><span class="o">)</span> <span class="k">new</span> <span class="nc">RequestLogger</span><span class="o">());</span> <span class="c1">// æ·»åŠ å“åº”æ‹¦æˆªå™¨</span>
</code></pre></div></div>

<p>æ‰“å¼€è°ƒè¯•æ—¥å¿—ï¼š</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">logging</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span>
    <span class="na">org.elasticsearch.client</span><span class="pi">:</span> <span class="s">DEBUG</span>
    <span class="na">com.*.config.RequestLogger</span><span class="pi">:</span> <span class="s">DEBUG</span>
</code></pre></div></div>

<p>å…¶ä¸­ <code class="language-plaintext highlighter-rouge">com.*.config.RequestLogger</code>æ˜¯æ—¥å¿—æ‰“å°ç±»çš„ç±»åã€‚</p>

<h2 id="ä½¿ç”¨">ä½¿ç”¨</h2>

<h3 id="æ’å…¥">æ’å…¥</h3>

<p>é€šè¿‡ HTTP è¯·æ±‚æ’å…¥æ•°æ®ï¼š</p>

<p>è¦é€šè¿‡ HTTP å‘ Elasticsearch æ’å…¥æ•°æ®ï¼Œé€šå¸¸ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PUT</code> æˆ– <code class="language-plaintext highlighter-rouge">POST</code> è¯·æ±‚ã€‚ä»¥ä¸‹æ˜¯é€šè¿‡ HTTP è¯·æ±‚æ’å…¥æ•°æ®çš„æ­¥éª¤å’Œç¤ºä¾‹ã€‚</p>

<p><strong>æ’å…¥æ•°æ®çš„ HTTP è¯·æ±‚æ–¹å¼</strong></p>

<ul>
  <li><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">POST</code> è¯·æ±‚</strong>ï¼šå¦‚æœä¸æŒ‡å®šæ–‡æ¡£ IDï¼ŒElasticsearch ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª IDã€‚</li>
  <li><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PUT</code> è¯·æ±‚</strong>ï¼šå¦‚æœæŒ‡å®šæ–‡æ¡£ IDï¼ŒElasticsearch ä¼šä½¿ç”¨è¯¥ ID æ’å…¥æ•°æ®ã€‚å¦‚æœæ–‡æ¡£å·²å­˜åœ¨ï¼Œåˆ™ä¼šæ›´æ–°è¯¥æ–‡æ¡£ã€‚</li>
</ul>

<p><strong>HTTP è¯·æ±‚çš„åŸºæœ¬æ ¼å¼</strong></p>

<ul>
  <li><strong>è¯·æ±‚ URL</strong>ï¼š
    <ul>
      <li>æ ¼å¼ï¼š<code class="language-plaintext highlighter-rouge">http://&lt;hostname&gt;:&lt;port&gt;/&lt;index&gt;/_doc/&lt;document_id&gt;</code></li>
      <li>ç¤ºä¾‹ï¼š<code class="language-plaintext highlighter-rouge">http://localhost:9200/products/_doc/1</code></li>
    </ul>
  </li>
  <li>
    <p><strong>è¯·æ±‚å¤´</strong>ï¼š<code class="language-plaintext highlighter-rouge">Content-Type: application/json</code>ï¼šæŒ‡å®šè¯·æ±‚ä½“çš„æ ¼å¼ä¸º JSONã€‚</p>
  </li>
  <li><strong>è¯·æ±‚ä½“</strong>ï¼šä»¥ JSON æ ¼å¼æä¾›æ–‡æ¡£çš„å†…å®¹ã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹ï¼šé€šè¿‡ HTTP æ’å…¥æ•°æ®</strong></p>

<p>å‡è®¾ä½ è¦å‘ <code class="language-plaintext highlighter-rouge">products</code> ç´¢å¼•æ’å…¥ä¸€ä¸ªæ–‡æ¡£ï¼Œæ–‡æ¡£çš„å†…å®¹åŒ…æ‹¬ SKUã€äº§å“åç§°å’Œä»·æ ¼ã€‚</p>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">POST</code> æ’å…¥æ•°æ®ï¼ˆè‡ªåŠ¨ç”Ÿæˆ IDï¼‰</strong></p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST http://localhost:9200/products/_doc
Content-Type: application/json

{
  "sku": "bk-1",
  "name": "City bike",
  "price": 123.0
}
</span></code></pre></div></div>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PUT</code> æ’å…¥æ•°æ®ï¼ˆæŒ‡å®š IDï¼‰</strong></p>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT http://localhost:9200/products/_doc/bk-1
Content-Type: application/json

{
  "sku": "bk-1",
  "name": "City bike",
  "price": 123.0
}
</span></code></pre></div></div>

<p>åœ¨è¿™ä¸¤ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">products</code> æ˜¯ç›®æ ‡ç´¢å¼•ï¼Œ<code class="language-plaintext highlighter-rouge">_doc</code> æ˜¯æ–‡æ¡£ç±»å‹ï¼Œ<code class="language-plaintext highlighter-rouge">bk-1</code> æ˜¯æ–‡æ¡£çš„ IDï¼ˆåœ¨ç¬¬äºŒä¸ªç¤ºä¾‹ä¸­æŒ‡å®šï¼‰ï¼Œæ–‡æ¡£çš„å†…å®¹æ˜¯ JSON æ ¼å¼ã€‚</p>

<hr />

<p>é€šè¿‡Javaæ’å…¥æ•°æ®ï¼š</p>

<p>æ„å»ºè¯·æ±‚æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Fluent DSLï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">record</span> <span class="nf">Product</span><span class="o">(</span><span class="nc">String</span> <span class="n">sku</span><span class="o">,</span> <span class="nc">String</span> <span class="n">cityBike</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v</span><span class="o">)</span> <span class="o">{}</span>
<span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>

<span class="nc">IndexResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>           <span class="c1">// è®¾ç½®ç´¢å¼•åä¸º "products"</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>           <span class="c1">// è®¾ç½®æ–‡æ¡£çš„ ID ä¸º `product.sku()`ï¼ˆå³ "bk-1"ï¼‰ï¼Œå¯é€‰</span>
        <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">)</span>           <span class="c1">// è®¾ç½®æ–‡æ¡£å†…å®¹ä¸º `product` å¯¹è±¡</span>
<span class="o">);</span>
<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Indexed with version "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">version</span><span class="o">());</span>
</code></pre></div></div>

<p>è¿˜å¯ä»¥å°†ä½¿ç”¨ DSL åˆ›å»ºçš„å¯¹è±¡åˆ†é…ç»™å˜é‡ã€‚Java API Client ç±»æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨ DSL è¯­æ³•åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚<code class="language-plaintext highlighter-rouge">of()</code>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">IndexRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>
        <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">)</span>
<span class="o">);</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</code></pre></div></div>

<p>ä½¿ç”¨ç»å…¸æ„å»ºå™¨ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">build</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;&gt;()</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"product"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>
        <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">build</span><span class="o">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">esClient.index(...)</code> æ˜¯ç”¨æ¥æ‰§è¡Œæ–‡æ¡£ç´¢å¼•æ“ä½œçš„ä»£ç ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">.index("products")</code>ï¼šæŒ‡å®šå°†æ•°æ®ç´¢å¼•åˆ°åä¸º <code class="language-plaintext highlighter-rouge">"products"</code> çš„ç´¢å¼•ä¸­ã€‚ç´¢å¼•æ˜¯ Elasticsearch ä¸­æ•°æ®çš„å­˜å‚¨å•å…ƒï¼Œç›¸å½“äºæ•°æ®åº“ä¸­çš„è¡¨ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">.id(product.sku())</code>ï¼šæŒ‡å®šè¯¥æ–‡æ¡£çš„ IDï¼Œé€šå¸¸ç”¨äºå”¯ä¸€æ ‡è¯†æ¯ä¸ªæ–‡æ¡£ã€‚è¿™é‡Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">product.sku()</code> æ¥è®¾ç½® IDï¼Œè¿™æ„å‘³ç€æ–‡æ¡£çš„ ID æ˜¯å•†å“çš„ SKUï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">"bk-1"</code>ï¼‰ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">.document(product)</code>ï¼šæŒ‡å®šå°†è¦å­˜å‚¨çš„æ–‡æ¡£å†…å®¹ã€‚<code class="language-plaintext highlighter-rouge">product</code> å¯¹è±¡è¢«ç›´æ¥ä¼ é€’ç»™ <code class="language-plaintext highlighter-rouge">document()</code> æ–¹æ³•ï¼ŒElasticsearch ä¼šè‡ªåŠ¨å°†å…¶è½¬åŒ–ä¸ºé€‚å½“çš„ JSON æ ¼å¼å­˜å‚¨ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">IndexResponse</code> æ˜¯ Elasticsearch è¿”å›çš„å“åº”å¯¹è±¡ï¼ŒåŒ…å«æœ‰å…³æ–‡æ¡£ç´¢å¼•æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">response.version()</code>ï¼šè·å–ç´¢å¼•æ“ä½œçš„ç‰ˆæœ¬å·ã€‚æ¯å½“æ–‡æ¡£è¢«åˆ›å»ºæˆ–æ›´æ–°æ—¶ï¼ŒElasticsearch ä¼šä¸ºè¯¥æ–‡æ¡£åˆ†é…ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œç”¨äºè¿½è¸ªæ–‡æ¡£çš„å˜æ›´ã€‚è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">version</code> æ˜¯ç´¢å¼•çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥ç”¨äºæ§åˆ¶å¹¶å‘å’Œç‰ˆæœ¬ç®¡ç†ã€‚</p>

<p>ä½¿ç”¨å¼‚æ­¥å®¢æˆ·ç«¯ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">IndexResponse</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">esAsyncClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">finalProduct2</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>
        <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">finalProduct2</span><span class="o">)</span>
<span class="o">);</span>
<span class="n">future</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">response1</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"ç´¢å¼•å¤±è´¥"</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ä½¿ç”¨ version ç¼–åˆ¶ç´¢å¼• "</span> <span class="o">+</span> <span class="n">response1</span><span class="o">.</span><span class="na">version</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<p>å®Œæ•´ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">co.elastic.clients.elasticsearch.ElasticsearchAsyncClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">co.elastic.clients.elasticsearch.ElasticsearchClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">co.elastic.clients.elasticsearch.core.IndexRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">co.elastic.clients.elasticsearch.core.IndexResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CompletableFuture</span><span class="o">;</span>

<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="o">*</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">class</span> <span class="err">*</span><span class="nc">ApplicationTests</span> <span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">ElasticsearchClient</span> <span class="n">esClient</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="nc">ElasticsearchAsyncClient</span> <span class="n">esAsyncClient</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">record</span> <span class="nf">Product</span><span class="o">(</span><span class="nc">String</span> <span class="n">sku</span><span class="o">,</span> <span class="nc">String</span> <span class="n">cityBike</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v</span><span class="o">)</span> <span class="o">{}</span>
        <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>
        <span class="c1">// * ä½¿ç”¨ Fluent DSL</span>
        <span class="nc">Product</span> <span class="n">finalProduct1</span> <span class="o">=</span> <span class="n">product</span><span class="o">;</span>
        <span class="nc">IndexResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span>
                <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>           <span class="c1">// è®¾ç½®ç´¢å¼•åä¸º "products"</span>
                <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">finalProduct1</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>           <span class="c1">// è®¾ç½®æ–‡æ¡£çš„ ID ä¸º `product.sku()`ï¼ˆå³ "bk-1"ï¼‰</span>
                <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">finalProduct1</span><span class="o">)</span>           <span class="c1">// è®¾ç½®æ–‡æ¡£å†…å®¹ä¸º `product` å¯¹è±¡</span>
        <span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ä½¿ç”¨ version ç¼–åˆ¶ç´¢å¼• "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">version</span><span class="o">());</span>

        <span class="c1">// * ä½¿ç”¨ DSL åˆ›å»ºçš„å¯¹è±¡åˆ†é…ç»™å˜é‡</span>
        <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-2"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="mf">124.0</span><span class="o">);</span>
        <span class="nc">Product</span> <span class="n">finalProduct</span> <span class="o">=</span> <span class="n">product</span><span class="o">;</span>
        <span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">IndexRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span>
                <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">finalProduct</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>
                <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">finalProduct</span><span class="o">)</span>
        <span class="o">);</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ä½¿ç”¨ version ç¼–åˆ¶ç´¢å¼• "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">version</span><span class="o">());</span>

        <span class="c1">// * ä½¿ç”¨ç»å…¸æ„å»ºå™¨</span>
        <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-3"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="mf">125.0</span><span class="o">);</span>
        <span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">build</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;&gt;()</span>
                <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>
                <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">build</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ä½¿ç”¨ version ç¼–åˆ¶ç´¢å¼• "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">version</span><span class="o">());</span>

        <span class="c1">// * ä½¿ç”¨å¼‚æ­¥å®¢æˆ·ç«¯</span>
        <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-4"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="mf">126.0</span><span class="o">);</span>
        <span class="nc">Product</span> <span class="n">finalProduct2</span> <span class="o">=</span> <span class="n">product</span><span class="o">;</span>
        <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">IndexResponse</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">esAsyncClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span>
                <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">finalProduct2</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>
                <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">finalProduct2</span><span class="o">)</span>
        <span class="o">);</span>
        <span class="n">future</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">response1</span><span class="o">,</span> <span class="n">exception</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"ç´¢å¼•å¤±è´¥"</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ä½¿ç”¨ version ç¼–åˆ¶ç´¢å¼• "</span> <span class="o">+</span> <span class="n">response1</span><span class="o">.</span><span class="na">version</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">withJson</code></strong></p>

<p>åœ¨ä½¿ç”¨ Elasticsearch è¿›è¡Œåº”ç”¨ç¨‹åºå¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªå¸¸è§çš„å·¥ä½œæµç¨‹æ˜¯ä½¿ç”¨ Kibana å¼€å‘äººå‘˜æ§åˆ¶å°ä»¥äº¤äº’æ–¹å¼å‡†å¤‡å’Œæµ‹è¯•æŸ¥è¯¢ã€èšåˆã€ç´¢å¼•æ˜ å°„å’Œå…¶ä»–å¤æ‚çš„ API è°ƒç”¨ã€‚è¿™å°†ç”Ÿæˆæ‚¨å¯èƒ½å¸Œæœ›åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„æœ‰æ•ˆ JSON ä»£ç æ®µã€‚</p>

<p>ç”±äºå°†è¿™äº› JSON ä»£ç ç‰‡æ®µè½¬æ¢ä¸º Java ä»£ç å¯èƒ½éå¸¸è€—æ—¶ä¸”å®¹æ˜“å‡ºé”™ï¼Œå› æ­¤ Java API å®¢æˆ·ç«¯ä¸­çš„å¤§å¤šæ•°æ•°æ®ç±»éƒ½å¯ä»¥ä» JSON æ–‡æœ¬åŠ è½½ï¼šå¯¹è±¡ç”Ÿæˆå™¨å…·æœ‰ä»åŸå§‹ JSON å¡«å……ç”Ÿæˆå™¨çš„æ–¹æ³•ã€‚è¿™è¿˜å…è®¸æ‚¨å°†åŠ¨æ€åŠ è½½çš„ JSON ä¸å¯¹è±¡çš„ç¼–ç¨‹æ„é€ ç›¸ç»“åˆã€‚``</p>

<p>åœ¨åå°ï¼Œè¿™äº›æ–¹æ³•è°ƒç”¨å¯¹è±¡çš„ååºåˆ—åŒ–å™¨ã€‚å› æ­¤ï¼ŒJSON æ–‡æœ¬çš„ç»“æ„å’Œå€¼ç±»å‹å¿…é¡»æ­£ç¡®é€‚ç”¨äºç›®æ ‡æ•°æ®ç»“æ„ã€‚ä½¿ç”¨å¯ä¿æŒ Java API Client çš„å¼ºç±»å‹ä¿è¯ã€‚</p>

<p><strong>ä»èµ„æºæ–‡ä»¶åŠ è½½ç´¢å¼•å®šä¹‰</strong></p>

<p>è€ƒè™‘ä¸€ä¸ªåŒ…å«ç´¢å¼•å®šä¹‰çš„èµ„æºæ–‡ä»¶ï¼š<code class="language-plaintext highlighter-rouge">some-index.json</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"mappings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"field1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>å¯ä»¥æ ¹æ®è¯¥å®šä¹‰åˆ›å»ºç´¢å¼•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span>
    <span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"some-index.json"</span><span class="o">);</span> 

<span class="nc">CreateIndexRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="nc">CreateIndexRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"some-index"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withJson</span><span class="o">(</span><span class="n">input</span><span class="o">)</span> 
<span class="o">);</span>

<span class="kt">boolean</span> <span class="n">created</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">indices</span><span class="o">().</span><span class="na">create</span><span class="o">(</span><span class="n">req</span><span class="o">).</span><span class="na">acknowledged</span><span class="o">();</span>
</code></pre></div></div>

<p>æ‰“å¼€ JSON èµ„æºæ–‡ä»¶çš„è¾“å…¥æµã€‚ä½¿ç”¨èµ„æºæ–‡ä»¶å†…å®¹å¡«å……ç´¢å¼•åˆ›å»ºè¯·æ±‚ã€‚</p>

<p><strong>ä» JSON æ–‡ä»¶æ‘„å–æ–‡æ¡£</strong></p>

<p>åŒæ ·ï¼Œå¯ä»¥ä»æ•°æ®æ–‡ä»¶ä¸­è¯»å–è¦å­˜å‚¨åœ¨ Elasticsearch ä¸­çš„æ–‡æ¡£ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">FileReader</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">dataDir</span><span class="o">,</span> <span class="s">"document-1.json"</span><span class="o">));</span>

<span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">JsonData</span><span class="o">&gt;</span> <span class="n">req</span><span class="o">;</span> 

<span class="n">req</span> <span class="o">=</span> <span class="nc">IndexRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"some-index"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withJson</span><span class="o">(</span><span class="n">file</span><span class="o">)</span>
<span class="o">);</span>

<span class="n">client</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
</code></pre></div></div>

<p>å½“ä½ åœ¨ <code class="language-plaintext highlighter-rouge">IndexRequest</code> ä¸­ä½¿ç”¨æ³›å‹ï¼ˆæ¯”å¦‚ <code class="language-plaintext highlighter-rouge">JsonData</code>ï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">withJson()</code> æ–¹æ³•ä¼šä½¿ç”¨è¿™ä¸ªç±»å‹æ¥å¤„ç†æ•°æ®ï¼Œç¡®ä¿æ–‡ä»¶å†…å®¹ç¬¦åˆè¿™ä¸ªæ•°æ®ç±»å‹çš„æ ¼å¼ï¼Œå¹¶æœ€ç»ˆè¢«ç´¢å¼•åˆ° Elasticsearch ä¸­ã€‚</p>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">withPipeline</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">withPipeline(String pipeline)</code> æ˜¯ <code class="language-plaintext highlighter-rouge">IndexRequest</code> ç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒç”¨äºæŒ‡å®šåœ¨å°†æ–‡æ¡£ç´¢å¼•åˆ° Elasticsearch ä¹‹å‰åº”ç”¨çš„ <strong>ç®¡é“ï¼ˆPipelineï¼‰</strong>ã€‚</p>

<p>Elasticsearch çš„ <strong>ç®¡é“</strong> æ˜¯ä¸€ä¸ªå¤„ç†æ•°æ®çš„åŠŸèƒ½ï¼Œå®ƒå¯ä»¥åœ¨æ•°æ®è¢«ç´¢å¼•å‰å¯¹æ–‡æ¡£è¿›è¡Œè½¬æ¢ã€å¤„ç†æˆ–è€…æ¸…æ´—ç­‰æ“ä½œã€‚é€šè¿‡ç®¡é“ï¼Œç”¨æˆ·å¯ä»¥å¯¹æ–‡æ¡£è¿›è¡Œæ›´å¤æ‚çš„æ“ä½œï¼Œä¾‹å¦‚ï¼š</p>

<ul>
  <li><strong>æ•°æ®æ ¼å¼è½¬æ¢</strong>ï¼šå¯¹æ–‡æ¡£çš„å­—æ®µè¿›è¡Œé‡å‘½åæˆ–æ”¹å˜æ ¼å¼ã€‚</li>
  <li><strong>æ•°æ®å¢å¼º</strong>ï¼šæ ¹æ®å¤–éƒ¨æ•°æ®æ¥æºæ¥ä¿®æ”¹æ–‡æ¡£å†…å®¹ã€‚</li>
  <li><strong>éªŒè¯å’Œæ¸…æ´—</strong>ï¼šç¡®ä¿æ–‡æ¡£æ•°æ®ç¬¦åˆæŸäº›æ ‡å‡†æˆ–è€…æ ¼å¼ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">withPipeline</code> æ–¹æ³•çš„ä½œç”¨</strong></p>

<p>è¯¥æ–¹æ³•å°†æŒ‡å®šçš„ç®¡é“åç§°ï¼ˆç®¡é“IDï¼‰<strong>ä¸å½“å‰çš„ç´¢å¼•è¯·æ±‚å…³è”</strong>ã€‚è¿™ä¸ªç®¡é“å°†åœ¨æ–‡æ¡£è¢«ç´¢å¼•ä¹‹å‰è¢«è°ƒç”¨ï¼Œå¯¹æ–‡æ¡£è¿›è¡Œå¤„ç†ã€‚</p>

<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">&lt;&gt;();</span>
<span class="n">request</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>  <span class="c1">// è®¾ç½®ç´¢å¼•</span>
       <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"product-123"</span><span class="o">)</span>    <span class="c1">// è®¾ç½®æ–‡æ¡£ ID</span>
       <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City Bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">))</span>  <span class="c1">// è®¾ç½®æ–‡æ¡£å†…å®¹</span>
       <span class="o">.</span><span class="na">withPipeline</span><span class="o">(</span><span class="s">"my-pipeline"</span><span class="o">);</span>  <span class="c1">// è®¾ç½®ç®¡é“ï¼Œä½¿ç”¨ "my-pipeline"</span>
</code></pre></div></div>

<p>åœ¨Elasticsearch 8.x ç‰ˆæœ¬ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">withPipeline</code> æ”¹ä¸ºäº† <code class="language-plaintext highlighter-rouge">pipeline</code> æ–¹æ³•ã€‚</p>

<hr />

<p><strong>æ’å…¥è¯¦è§£</strong></p>

<p>æ“ä½œï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>           <span class="c1">// è®¾ç½®ç´¢å¼•åä¸º "products"</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">finalProduct1</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>           <span class="c1">// è®¾ç½®æ–‡æ¡£çš„ ID ä¸º product.sku()ï¼ˆå³ "bk-1"ï¼‰</span>
        <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">finalProduct1</span><span class="o">)</span>           <span class="c1">// è®¾ç½®æ–‡æ¡£å†…å®¹ä¸º product å¯¹è±¡</span>
<span class="o">);</span>
</code></pre></div></div>

<p>æ¶‰åŠåˆ°ä»¥ä¸‹ç±»ï¼š</p>

<p><strong>IndexRequest</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">i -&gt; i.index(...)</code>ï¼‰</p>

<p><code class="language-plaintext highlighter-rouge">IndexRequest</code>æ˜¯ä¸€ä¸ªå°è£… Elasticsearch ç´¢å¼•è¯·æ±‚çš„ç±»ï¼ŒåŒ…å«äº†ç›®æ ‡ç´¢å¼•åã€æ–‡æ¡£ ID å’Œæ–‡æ¡£å†…å®¹ç­‰ä¿¡æ¯ã€‚å®ƒæ˜¯ <code class="language-plaintext highlighter-rouge">index()</code> æ–¹æ³•çš„å‚æ•°ã€‚</p>

<p><strong>IndexResponse</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">response</code>ï¼‰</p>

<p><code class="language-plaintext highlighter-rouge">IndexResponse</code> æ˜¯ Elasticsearch ç´¢å¼•æ“ä½œçš„å“åº”ç±»ã€‚å®ƒåŒ…å«æœ‰å…³ç´¢å¼•æ“ä½œçš„ä¿¡æ¯ï¼Œä¾‹å¦‚æ–‡æ¡£çš„ç‰ˆæœ¬å·ã€æˆåŠŸä¸å¦ã€æ˜¯å¦è¿›è¡Œäº†åˆ·æ–°ç­‰ã€‚</p>

<h4 id="indexrequest"><code class="language-plaintext highlighter-rouge">IndexRequest</code></h4>

<p><code class="language-plaintext highlighter-rouge">IndexRequest&lt;TDocument&gt;</code> æ˜¯ Elasticsearch å®¢æˆ·ç«¯åº“ä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒç”¨äºå‘æŒ‡å®šçš„ Elasticsearch ç´¢å¼•ä¸­ <strong>åˆ›å»º</strong> æˆ– <strong>æ›´æ–°</strong> æ–‡æ¡£ã€‚è¿™ä¸ªç±»æ˜¯ Elasticsearch ä¸­çš„ç´¢å¼•æ“ä½œè¯·æ±‚ï¼ˆ<code class="language-plaintext highlighter-rouge">index</code> APIï¼‰çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œç”¨äºè¡¨ç¤ºå‘ Elasticsearch ç´¢å¼•ä¸­æ’å…¥æˆ–æ›´æ–°æ–‡æ¡£çš„è¯·æ±‚ã€‚</p>

<p><strong>ä¸»è¦åŠŸèƒ½</strong></p>

<ul>
  <li><strong>åˆ›å»ºæ–‡æ¡£</strong>ï¼šå¦‚æœæŒ‡å®šçš„æ–‡æ¡£ ID åœ¨ç´¢å¼•ä¸­ä¸å­˜åœ¨ï¼ŒElasticsearch ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡æ¡£ã€‚</li>
  <li><strong>æ›´æ–°æ–‡æ¡£</strong>ï¼šå¦‚æœæŒ‡å®šçš„æ–‡æ¡£ ID å·²ç»å­˜åœ¨ï¼ŒElasticsearch ä¼šæ›´æ–°è¯¥æ–‡æ¡£çš„æ•°æ®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ–‡æ¡£å·²ç»å­˜åœ¨ï¼Œ<code class="language-plaintext highlighter-rouge">index</code> è¯·æ±‚ä¼šè¦†ç›–åŸæœ‰æ–‡æ¡£ï¼Œä½†ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›é€‰é¡¹æ¥æ§åˆ¶æ›´æ–°æ–¹å¼ã€‚</li>
  <li><strong>é€‰æ‹©ç´¢å¼•</strong>ï¼šå¯ä»¥é€‰æ‹©ç›®æ ‡ç´¢å¼•ï¼ˆ<code class="language-plaintext highlighter-rouge">index</code>ï¼‰ï¼ŒæŒ‡å®šæ–‡æ¡£çš„ IDï¼ˆ<code class="language-plaintext highlighter-rouge">id</code>ï¼‰ï¼Œä»¥åŠæ–‡æ¡£çš„å†…å®¹ï¼ˆ<code class="language-plaintext highlighter-rouge">document</code>ï¼‰ã€‚</li>
  <li><strong>æ”¯æŒ JSON åºåˆ—åŒ–å’Œååºåˆ—åŒ–</strong>ï¼šæ–‡æ¡£çš„å†…å®¹é€šå¸¸æ˜¯ä¸€ä¸ª POJO å¯¹è±¡ï¼ŒElasticsearch ä¼šè‡ªåŠ¨å°† POJO å¯¹è±¡åºåˆ—åŒ–ä¸º JSON æ ¼å¼ï¼Œå¹¶å‘é€åˆ°æœåŠ¡å™¨ç«¯ã€‚</li>
</ul>

<p>ä»¥ä¸‹æ˜¯ <code class="language-plaintext highlighter-rouge">IndexRequest&lt;TDocument&gt;</code> ç±»çš„å¸¸ç”¨æ–¹æ³•ï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">index(String index)</code></strong>: è®¾ç½®æ–‡æ¡£çš„ç›®æ ‡ç´¢å¼•ï¼ˆæŒ‡å®šæ–‡æ¡£å­˜å‚¨çš„ç´¢å¼•åï¼‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">&lt;&gt;();</span>
<span class="n">request</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">);</span>  <span class="c1">// å°†æ–‡æ¡£æ’å…¥åˆ° "products" ç´¢å¼•ä¸­</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">id(String id)</code></strong>: è®¾ç½®æ–‡æ¡£çš„ IDã€‚Elasticsearch ä½¿ç”¨æ–‡æ¡£çš„ ID æ¥å”¯ä¸€æ ‡è¯†æ–‡æ¡£ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span><span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"product-1"</span><span class="o">);</span>  <span class="c1">// è®¾ç½®æ–‡æ¡£ ID ä¸º "product-1"</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">document(TDocument document)</code></strong>: è®¾ç½®æ–‡æ¡£çš„å†…å®¹ã€‚è¿™ä¸ªå†…å®¹é€šå¸¸æ˜¯ä¸€ä¸ª POJO å¯¹è±¡ï¼ˆæ¯”å¦‚ <code class="language-plaintext highlighter-rouge">Product</code>ï¼‰ï¼Œè¯¥å¯¹è±¡å°†è¢«è‡ªåŠ¨è½¬æ¢ä¸º JSON æ ¼å¼ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>  <span class="c1">// å°† Product å¯¹è±¡ä½œä¸ºæ–‡æ¡£å†…å®¹</span>
</code></pre></div></div>

<p><strong>å‚æ•°</strong>: <code class="language-plaintext highlighter-rouge">TDocument document</code> â€” æ–‡æ¡£å†…å®¹ï¼Œå¯ä»¥æ˜¯ä»»ä½• POJO ç±»å‹æˆ– JSON æ•°æ®ï¼ˆéœ€è¦é€šè¿‡ <code class="language-plaintext highlighter-rouge">JsonpSerializable</code> åºåˆ—åŒ–ï¼‰ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">opType(IndexRequest.OpType opType)</code></strong>: è®¾ç½®æ“ä½œç±»å‹ã€‚æ“ä½œç±»å‹å†³å®šäº†æ–‡æ¡£æ’å…¥çš„æ–¹å¼ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">OpType.CREATE</code>: å¦‚æœæ–‡æ¡£å·²å­˜åœ¨ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">OpType.INDEX</code>: é»˜è®¤å€¼ï¼Œæ–‡æ¡£å­˜åœ¨æ—¶ä¼šè¢«è¦†ç›–ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span><span class="o">.</span><span class="na">opType</span><span class="o">(</span><span class="nc">OpType</span><span class="o">.</span><span class="na">CREATE</span><span class="o">);</span>  <span class="c1">// å¦‚æœæ–‡æ¡£å­˜åœ¨ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">routing(String routing)</code></strong></p>

<p>ä¸ºæ–‡æ¡£æŒ‡å®šä¸€ä¸ªè·¯ç”±å€¼ã€‚è·¯ç”±ç”¨äºä¼˜åŒ–æ–‡æ¡£åœ¨ Elasticsearch é›†ç¾¤ä¸­çš„åˆ†å¸ƒã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span><span class="o">.</span><span class="na">routing</span><span class="o">(</span><span class="s">"user-123"</span><span class="o">);</span>  <span class="c1">// ä¸ºæ–‡æ¡£æŒ‡å®šä¸€ä¸ªè·¯ç”±å€¼ "user-123"</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">version(Long version)</code></strong>: è®¾ç½®æ–‡æ¡£çš„ç‰ˆæœ¬å·ã€‚ç‰ˆæœ¬æ§åˆ¶ç”¨äºä¹è§‚å¹¶å‘æ§åˆ¶ï¼Œå¯ä»¥ç¡®ä¿æ–‡æ¡£ä¸ä¼šåœ¨å…¶ä»–è¿›ç¨‹æ›´æ–°æ—¶å‘ç”Ÿå†²çªã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span><span class="o">.</span><span class="na">version</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>  <span class="c1">// è®¾ç½®ç‰ˆæœ¬å·ä¸º 1</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">versionType(String versionType)</code></strong>ï¼šè®¾ç½®ç‰ˆæœ¬ç±»å‹ã€‚å¸¸è§çš„ç‰ˆæœ¬ç±»å‹åŒ…æ‹¬ <code class="language-plaintext highlighter-rouge">internal</code> å’Œ <code class="language-plaintext highlighter-rouge">external</code>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span><span class="o">.</span><span class="na">versionType</span><span class="o">(</span><span class="s">"external"</span><span class="o">);</span>  <span class="c1">// è®¾ç½®ç‰ˆæœ¬ç±»å‹ä¸º "external"</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">VersionType.Internal</code>ï¼ˆé»˜è®¤ï¼‰: Elasticsearch å†…éƒ¨çš„ç‰ˆæœ¬æ§åˆ¶,æ–‡æ¡£çš„ç‰ˆæœ¬å·ç”± Elasticsearch è‡ªåŠ¨ç”Ÿæˆã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">VersionType.External </code>: ä½¿ç”¨å¤–éƒ¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚åœ¨ç´¢å¼•æ–‡æ¡£æ—¶ï¼Œæ–‡æ¡£çš„ç‰ˆæœ¬ç”±ç”¨æˆ·æä¾›ï¼Œè€Œä¸æ˜¯ç”± Elasticsearch è‡ªåŠ¨ç®¡ç†ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">VersionType.ExternalGte</code>: è¯¥ç‰ˆæœ¬ç±»å‹è¡¨ç¤ºä»…åœ¨å¤–éƒ¨ç‰ˆæœ¬å·å¤§äºæˆ–ç­‰äºå½“å‰æ–‡æ¡£çš„ç‰ˆæœ¬æ—¶ï¼Œæ‰å…è®¸æ‰§è¡Œæ›´æ–°æ“ä½œã€‚å®ƒå…è®¸æ›´æ–°æ“ä½œåœ¨ç¡®ä¿ä¸ä¼šè¦†ç›–æ›´é«˜ç‰ˆæœ¬çš„æ•°æ®çš„æƒ…å†µä¸‹æ‰§è¡Œã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">VersionType.Force</code>ï¼šè¯¥ç±»å‹ä¼šå¼ºåˆ¶æ‰§è¡Œæ“ä½œï¼Œå¿½ç•¥ç‰ˆæœ¬æ§åˆ¶ã€‚å³ä½¿æ–‡æ¡£ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œå®ƒä¹Ÿä¼šæ‰§è¡Œç´¢å¼•æˆ–æ›´æ–°æ“ä½œã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">refresh(Refresh refresh)</code></strong>: è®¾ç½®æ˜¯å¦åˆ·æ–°ç´¢å¼•ï¼Œä»¥ä¾¿å¯ä»¥ç«‹å³æœç´¢è¯¥æ–‡æ¡£ã€‚å¸¸ç”¨çš„é€‰é¡¹æœ‰ <code class="language-plaintext highlighter-rouge">Refresh.TRUE</code>, <code class="language-plaintext highlighter-rouge">Refresh.FALSE</code>, <code class="language-plaintext highlighter-rouge">Refresh.WaitFor</code>ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Refresh.True</code> :åœ¨æ‰§è¡Œå®Œå†™æ“ä½œåç«‹å³åˆ·æ–°ç´¢å¼•ï¼Œä½¿å¾—æ–‡æ¡£ç«‹å³å¯ç”¨äºæœç´¢ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Refresh.False</code>(é»˜è®¤å€¼):ä¸è¿›è¡Œåˆ·æ–°ï¼Œæ–‡æ¡£ä¸ä¼šç«‹å³å¯¹æŸ¥è¯¢å¯è§ã€‚ç´¢å¼•å°†ä¸ä¼šç«‹å³åˆ·æ–°ï¼Œè€Œæ˜¯ç­‰å¾…é»˜è®¤çš„åˆ·æ–°å‘¨æœŸã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Refresh.WaitFor</code>:æ‰§è¡Œå†™æ“ä½œåï¼Œç­‰å¾…ä¸€å®šæ¡ä»¶ä¸‹çš„åˆ·æ–°ï¼Œç›´åˆ°ç´¢å¼•è¢«åˆ·æ–°ï¼ˆé€šå¸¸æ˜¯é€šè¿‡å¼‚æ­¥åˆ·æ–°æœºåˆ¶ï¼‰ã€‚è¿™æ„å‘³ç€è¯·æ±‚å°†ç­‰å¾…ç›´åˆ°æ–‡æ¡£å¯æœç´¢ï¼ˆä½†ä¸ä¼šç«‹å³åˆ·æ–°ï¼‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="nc">Refresh</span><span class="o">.</span><span class="na">TRUE</span><span class="o">);</span>  <span class="c1">// ç´¢å¼•æ“ä½œåç«‹å³åˆ·æ–°ç´¢å¼•</span>
</code></pre></div></div>

<p>Elasticsearch é»˜è®¤æ¯ 1 ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ç´¢å¼•ã€‚å½“ç´¢å¼•ä¸­çš„æ–‡æ¡£è¢«å†™å…¥åï¼Œè¿™äº›æ–‡æ¡£ä¼šæš‚æ—¶ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç›´åˆ° Elasticsearch è‡ªåŠ¨åˆ·æ–°ç´¢å¼•ã€‚è¿™ä¸€é»˜è®¤è¡Œä¸ºæœ‰åŠ©äºå‡å°‘è¿‡åº¦åˆ·æ–°å¯¼è‡´çš„æ€§èƒ½å¼€é”€ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">withJson(JsonData json)</code></strong>ï¼šé€šè¿‡ JSON æ•°æ®å°†æ–‡æ¡£å†…å®¹ä¼ é€’ç»™ç´¢å¼•è¯·æ±‚ã€‚é€‚ç”¨äºä¸ä½¿ç”¨ POJO ç±»å‹çš„æƒ…å†µã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">JsonData</span> <span class="n">jsonData</span> <span class="o">=</span> <span class="nc">JsonData</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"{\"sku\": \"bk-1\", \"cityBike\": \"City bike\", \"v\": 123.0}"</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">withJson</span><span class="o">(</span><span class="n">jsonData</span><span class="o">);</span>  <span class="c1">// å°† JSON æ•°æ®ä½œä¸ºæ–‡æ¡£ä¼ é€’</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">withPipeline(String pipeline)</code></strong>: è®¾ç½®ä¸€ä¸ªç®¡é“ï¼Œç®¡é“ç”¨äºåœ¨æ–‡æ¡£è¢«ç´¢å¼•ä¹‹å‰å¯¹æ–‡æ¡£è¿›è¡Œå¤„ç†ï¼ˆä¾‹å¦‚å¯¹æ•°æ®è¿›è¡Œè½¬æ¢ï¼‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span><span class="o">.</span><span class="na">withPipeline</span><span class="o">(</span><span class="s">"my-pipeline"</span><span class="o">);</span>  <span class="c1">// ä½¿ç”¨ç®¡é“ "my-pipeline"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">IndexRequest&lt;TDocument&gt;</code> æ˜¯ç”¨äºå‘ Elasticsearch ç´¢å¼•ä¸­åˆ›å»ºæˆ–æ›´æ–°æ–‡æ¡£çš„æ ¸å¿ƒè¯·æ±‚ç±»ã€‚å®ƒåŒ…å«äº†æ–‡æ¡£çš„ç›®æ ‡ç´¢å¼•ã€æ–‡æ¡£ IDã€æ–‡æ¡£å†…å®¹ä»¥åŠå…¶ä»–ç´¢å¼•è¯·æ±‚çš„ç›¸å…³å‚æ•°ã€‚å¸¸ç”¨æ–¹æ³•åŒ…æ‹¬è®¾ç½®ç´¢å¼•åã€æ–‡æ¡£ IDã€æ–‡æ¡£å†…å®¹ã€æ“ä½œç±»å‹ï¼ˆåˆ›å»ºæˆ–æ›´æ–°ï¼‰ç­‰ã€‚</p>

<h4 id="indexresponse"><code class="language-plaintext highlighter-rouge">IndexResponse</code></h4>

<p>åœ¨ Elasticsearch Java å®¢æˆ·ç«¯ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">IndexResponse</code> æ˜¯ç”¨äºè¡¨ç¤ºæ–‡æ¡£ç´¢å¼•æ“ä½œå“åº”çš„å¯¹è±¡ã€‚å®ƒæä¾›äº†è®¸å¤šæ–¹æ³•å’Œå­—æ®µï¼Œç”¨äºè·å–å…³äºç´¢å¼•æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ <code class="language-plaintext highlighter-rouge">IndexResponse</code> çš„å¸¸ç”¨æ–¹æ³•å’Œå­—æ®µçš„è¯¦ç»†è¯´æ˜ï¼š</p>

<p><strong>å¸¸ç”¨å­—æ®µ</strong></p>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">index</code></strong>ï¼šè¡¨ç¤ºç´¢å¼•æ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•åã€‚ç¤ºä¾‹å€¼ï¼š<code class="language-plaintext highlighter-rouge">"products"</code></p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">id</code></strong>ï¼šè¡¨ç¤ºæ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆIDï¼‰ã€‚ç¤ºä¾‹å€¼ï¼š<code class="language-plaintext highlighter-rouge">"bk-1"</code></p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">version</code></strong>ï¼šæ–‡æ¡£çš„ç‰ˆæœ¬å·ï¼ˆä¸€ä¸ªé€’å¢å€¼ï¼Œè¡¨ç¤ºæ–‡æ¡£çš„ä¿®æ”¹æ¬¡æ•°ï¼‰ã€‚ç¤ºä¾‹å€¼ï¼š<code class="language-plaintext highlighter-rouge">1</code></p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">seqNo</code></strong>ï¼šè¡¨ç¤ºæ–‡æ¡£çš„åºåˆ—å·ï¼Œç”¨äºå†…éƒ¨ç‰ˆæœ¬æ§åˆ¶ã€‚ç¤ºä¾‹å€¼ï¼š<code class="language-plaintext highlighter-rouge">0</code></p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">primaryTerm</code></strong>ï¼šè¡¨ç¤ºæ–‡æ¡£çš„ä¸»åˆ†ç‰‡çš„ä¸»è¦ç‰ˆæœ¬å·ã€‚ç¤ºä¾‹å€¼ï¼š<code class="language-plaintext highlighter-rouge">1</code></p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">result</code></strong>æ“ä½œç»“æœï¼Œè¡¨ç¤ºæ–‡æ¡£çš„æ“ä½œçŠ¶æ€ï¼Œå¸¸è§çš„å€¼åŒ…æ‹¬ï¼š</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">"created"</code>: æ–‡æ¡£è¢«æˆåŠŸåˆ›å»ºã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">"updated"</code>: æ–‡æ¡£è¢«æˆåŠŸæ›´æ–°ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">"deleted"</code>: æ–‡æ¡£è¢«æˆåŠŸåˆ é™¤</li>
      <li><code class="language-plaintext highlighter-rouge">"not_found"</code>: åœ¨æ‰§è¡Œæ“ä½œæ—¶ï¼Œæ–‡æ¡£ä¸å­˜åœ¨ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">"noop"</code>: æ²¡æœ‰æ“ä½œï¼ˆä¾‹å¦‚åœ¨æŸäº›æ¡ä»¶ä¸‹æ²¡æœ‰å¯¹æ–‡æ¡£è¿›è¡Œæ›´æ”¹ï¼‰ã€‚</li>
    </ul>
  </li>
</ol>

<p>è¦è·å–è¿™äº›å€¼ï¼Œå¯ä»¥é€šè¿‡åŒåæ–¹æ³•è·å–ã€‚</p>

<hr />

<h4 id="index"><code class="language-plaintext highlighter-rouge">index()</code></h4>

<p><code class="language-plaintext highlighter-rouge">esClient.index()</code> æ–¹æ³•æ˜¯ Elasticsearch å®¢æˆ·ç«¯ä¸­ç”¨äºæ‰§è¡Œæ–‡æ¡£ç´¢å¼•æ“ä½œçš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€ã€‚å®ƒå…è®¸ä½ å°†æ–‡æ¡£ç´¢å¼•åˆ°æŒ‡å®šçš„ Elasticsearch ç´¢å¼•ä¸­ã€‚</p>

<p><strong>åŸºæœ¬çš„ <code class="language-plaintext highlighter-rouge">index()</code> æ–¹æ³•</strong></p>

<p><strong>å‚æ•°ï¼š</strong></p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">IndexRequest indexRequest</code></strong>ï¼šåŒ…å«ç´¢å¼•æ“ä½œæ‰€éœ€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ç´¢å¼•åã€æ–‡æ¡£ IDã€æ–‡æ¡£æ•°æ®ç­‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">RequestOptions</code></strong>ï¼šè¯·æ±‚çš„é€‰é¡¹ï¼Œå¦‚è¶…æ—¶ã€è®¤è¯ã€å¤´ä¿¡æ¯ç­‰ï¼ˆé€šå¸¸ä¸º <code class="language-plaintext highlighter-rouge">RequestOptions.DEFAULT</code>ï¼‰ã€‚</li>
</ul>

<p><strong>è¿”å›ï¼š</strong> <strong><code class="language-plaintext highlighter-rouge">IndexResponse</code></strong>ï¼šè¿”å›çš„å“åº”å¯¹è±¡ï¼ŒåŒ…å«å…³äºç´¢å¼•æ“ä½œçš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚æ–‡æ¡£ IDã€ç‰ˆæœ¬å·ç­‰ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexRequest</span> <span class="n">indexRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"sku"</span><span class="o">,</span> <span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"name"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="s">"price"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>

<span class="nc">IndexResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">indexRequest</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Document indexed with id: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</code></pre></div></div>

<hr />

<p><strong>å¼‚æ­¥ <code class="language-plaintext highlighter-rouge">index()</code> æ–¹æ³•ï¼ˆå¸¦ <code class="language-plaintext highlighter-rouge">ActionListener</code>ï¼‰</strong></p>

<p>Elasticsearch å®¢æˆ·ç«¯ä¹Ÿæ”¯æŒå¼‚æ­¥æ‰§è¡Œç´¢å¼•æ“ä½œï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">ActionListener</code> æ¥å¤„ç†å¼‚æ­¥å“åº”ã€‚</p>

<p><strong>å‚æ•°ï¼š</strong></p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">IndexRequest indexRequest</code></strong>ï¼šè¯·æ±‚å¯¹è±¡ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">RequestOptions</code></strong>ï¼šè¯·æ±‚çš„é…ç½®é€‰é¡¹ï¼ˆå¯é€‰ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">ActionListener&lt;IndexResponse&gt;</code></strong>ï¼šå›è°ƒï¼Œç”¨äºå¤„ç†å¼‚æ­¥å“åº”ã€‚</li>
</ul>

<p><strong>è¿”å›ï¼š</strong> å¼‚æ­¥æ“ä½œï¼Œä¸ç›´æ¥è¿”å› <code class="language-plaintext highlighter-rouge">IndexResponse</code>ï¼Œè€Œæ˜¯é€šè¿‡å›è°ƒè¿›è¡Œé€šçŸ¥ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexRequest</span> <span class="n">indexRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"sku"</span><span class="o">,</span> <span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"name"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="s">"price"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>

<span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">indexRequest</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ActionListener</span><span class="o">&lt;</span><span class="nc">IndexResponse</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="o">(</span><span class="nc">IndexResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Document indexed with id: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">index()</code> æ–¹æ³•ï¼ˆElasticsearchClient 8.xï¼‰</strong></p>

<p>åœ¨ Elasticsearch 8.x ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">index()</code> æ–¹æ³•çš„æ¥å£è¿›è¡Œäº†ä¼˜åŒ–ï¼Œé€šå¸¸é‡‡ç”¨æ³›å‹å’Œ <code class="language-plaintext highlighter-rouge">IndexRequest</code> æ„å»ºè¯·æ±‚ï¼Œå¹¶è¿”å›ç›¸åº”çš„å“åº”ç±»å‹ã€‚</p>

<p><strong>å‚æ•°ï¼š</strong></p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">IndexRequest indexRequest</code></strong>ï¼šè¯·æ±‚å¯¹è±¡ï¼ŒåŒ…å«ç´¢å¼•åç§°ã€æ–‡æ¡£ ID å’Œæ–‡æ¡£å†…å®¹ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">Class&lt;T&gt;</code></strong>ï¼šæŒ‡å®šè¦ç´¢å¼•çš„æ–‡æ¡£ç±»å‹ï¼ˆé€šå¸¸æ˜¯è‡ªå®šä¹‰çš„ Java ç±»ï¼‰ã€‚</li>
</ul>

<p><strong>è¿”å›ï¼š</strong></p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">IndexResponse</code></strong>ï¼šè¿”å›çš„å“åº”å¯¹è±¡ï¼ŒåŒ…å«ç´¢å¼•æ“ä½œçš„ç»“æœã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexRequest</span> <span class="n">indexRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"sku"</span><span class="o">,</span> <span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"name"</span><span class="o">,</span> <span class="s">"City bike"</span><span class="o">,</span> <span class="s">"price"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>

<span class="nc">IndexResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">indexRequest</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Document indexed with id: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
</code></pre></div></div>

<hr />

<p><strong>æ€»ç»“ï¼š</strong></p>

<p><code class="language-plaintext highlighter-rouge">esClient.index()</code> æ–¹æ³•æä¾›äº†å¤šç§ä½¿ç”¨æ–¹å¼ï¼Œä¸»è¦å˜ä½“å’Œå¸¸ç”¨å‚æ•°å¦‚ä¸‹ï¼š</p>
<ul>
  <li><strong>åŒæ­¥ <code class="language-plaintext highlighter-rouge">index()</code> æ–¹æ³•</strong>ï¼šé€šè¿‡ <code class="language-plaintext highlighter-rouge">IndexRequest</code> æäº¤ç´¢å¼•è¯·æ±‚ï¼Œè¿”å› <code class="language-plaintext highlighter-rouge">IndexResponse</code>ã€‚</li>
  <li><strong>å¼‚æ­¥ <code class="language-plaintext highlighter-rouge">index()</code> æ–¹æ³•</strong>ï¼šé€šè¿‡ <code class="language-plaintext highlighter-rouge">ActionListener</code> å¤„ç†å¼‚æ­¥ç´¢å¼•æ“ä½œã€‚</li>
</ul>

<h3 id="è·å–">è·å–</h3>

<p>é€šè¿‡ HTTP è¯·æ±‚æ‰§è¡Œ Elasticsearch çš„ <code class="language-plaintext highlighter-rouge">GET</code> æ“ä½œï¼Œå¯ä»¥ç›´æ¥å‘ Elasticsearch çš„ REST API å‘èµ·è¯·æ±‚ã€‚</p>

<p><strong>HTTP GET è¯·æ±‚ URLï¼š</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET http://&lt;Elasticsearch-host&gt;:&lt;port&gt;/&lt;index&gt;/_doc/&lt;id&gt;
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">&lt;Elasticsearch-host&gt;</code>: Elasticsearch çš„ä¸»æœºåæˆ– IP åœ°å€ï¼ˆä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">localhost</code> æˆ– <code class="language-plaintext highlighter-rouge">10.80.21.121</code>ï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;port&gt;</code>: Elasticsearch çš„ç«¯å£å·ï¼Œé»˜è®¤æ˜¯ <code class="language-plaintext highlighter-rouge">9200</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;index&gt;</code>: ç›®æ ‡ç´¢å¼•çš„åç§°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">&lt;id&gt;</code>: æ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆIDï¼‰ã€‚</li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET http://localhost:9200/products/_doc/bk-1
</span></code></pre></div></div>

<p><strong>å“åº”ç¤ºä¾‹ï¼ˆJSONï¼‰ï¼š</strong></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bk-1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"products"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"cityBike"</span><span class="p">:</span><span class="w"> </span><span class="s2">" City bike "</span><span class="p">,</span><span class="w">
    </span><span class="nl">"sku"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bk-1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"v"</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">found: true</code></strong> è¡¨ç¤ºæ‰¾åˆ°äº†æ–‡æ¡£ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">_source</code></strong> åŒ…å«æ–‡æ¡£çš„å®é™…æ•°æ®ã€‚</li>
</ul>

<p>å¦‚æœæŒ‡å®šçš„æ–‡æ¡£ ID ä¸å­˜åœ¨ï¼Œè¿”å›å¦‚ä¸‹ JSONï¼š</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"products"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"_doc"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bk-999"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"found"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<p>ä½¿ç”¨Javaä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetRequest</span> <span class="n">getRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span> <span class="c1">// æŒ‡å®šç´¢å¼•åç§°</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>        <span class="c1">// æŒ‡å®šæ–‡æ¡£ ID</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="nc">GetResponse</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">getResponse</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">getRequest</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="k">if</span> <span class="o">(</span><span class="n">getResponse</span><span class="o">.</span><span class="na">found</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">getResponse</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Document found: "</span> <span class="o">+</span> <span class="n">product</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Document not found."</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Elasticsearch çš„ <code class="language-plaintext highlighter-rouge">get</code> æ–¹æ³•æ˜¯ç”¨æ¥<strong>è·å–å•æ¡æ•°æ®</strong>çš„ï¼Œå¹¶ä¸”éœ€è¦æŒ‡å®š <strong>ç´¢å¼•</strong> å’Œ <strong>æ–‡æ¡£ ID</strong>ã€‚</p>

<hr />

<p><strong>è·å–è¯¦è§£</strong></p>

<p>åœ¨ Java ä¸­ï¼Œä½¿ç”¨ Elasticsearch è·å–å•æ¡æ•°æ®ï¼ˆ<code class="language-plaintext highlighter-rouge">get</code>ï¼‰æ—¶ï¼Œä¸»è¦æ¶‰åŠï¼š</p>

<p><code class="language-plaintext highlighter-rouge">GetRequest</code> æ˜¯æ„å»ºè·å–å•æ¡æ•°æ®è¯·æ±‚çš„ç±»ã€‚å®ƒå°è£…äº†è·å–æ–‡æ¡£æ‰€éœ€çš„æ‰€æœ‰å‚æ•°ï¼Œå¦‚ç´¢å¼•åç§°ã€æ–‡æ¡£ ID ä»¥åŠå¯èƒ½çš„è·¯ç”±å€¼ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">GetResponse</code> æ˜¯ Elasticsearch å“åº”ç±»ï¼ŒåŒ…å«äº†ä» Elasticsearch è·å–çš„å•æ¡æ–‡æ¡£çš„ç»“æœï¼ŒåŒ…æ‹¬æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_source</code> æ•°æ®ã€ç´¢å¼•åç§°ã€æ–‡æ¡£ ID ç­‰ã€‚</p>

<h4 id="getrequest"><code class="language-plaintext highlighter-rouge">GetRequest</code></h4>

<p><code class="language-plaintext highlighter-rouge">GetRequest</code> æ˜¯ Elasticsearch å®¢æˆ·ç«¯ä¸­ç”¨äºè·å–å•ä¸ªæ–‡æ¡£çš„è¯·æ±‚ç±»ã€‚</p>

<p><strong>å­—æ®µ</strong></p>

<table>
  <thead>
    <tr>
      <th>å­—æ®µåç§°</th>
      <th>ç±»å‹</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">index</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>æ–‡æ¡£æ‰€å±çš„ç´¢å¼•åç§°ï¼Œå¿…é¡»è®¾ç½®ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">id</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>è¦æ£€ç´¢çš„æ–‡æ¡£ IDï¼Œå¿…é¡»è®¾ç½®ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">routing</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>è·¯ç”±å€¼ï¼Œç”¨äºæŒ‡å‘ç‰¹å®šåˆ†ç‰‡ï¼ˆå¯é€‰ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">preference</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>æ£€ç´¢é¦–é€‰é¡¹ï¼Œç”¨äºæ§åˆ¶èŠ‚ç‚¹é—´æŸ¥è¯¢çš„è·¯ç”±é€»è¾‘ï¼ˆå¯é€‰ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">realtime</code></td>
      <td><code class="language-plaintext highlighter-rouge">Boolean</code></td>
      <td>æ˜¯å¦å®æ—¶æ£€ç´¢ï¼ˆé»˜è®¤ä¸º <code class="language-plaintext highlighter-rouge">true</code>ï¼Œéå®æ—¶å¯èƒ½æŸ¥è¯¢åˆ°æ—§ç‰ˆæœ¬æ–‡æ¡£ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">refresh</code></td>
      <td><code class="language-plaintext highlighter-rouge">Boolean</code></td>
      <td>åœ¨æ£€ç´¢å‰æ˜¯å¦å¼ºåˆ¶åˆ·æ–°ç´¢å¼•ï¼ˆé»˜è®¤ä¸º <code class="language-plaintext highlighter-rouge">false</code>ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">storedFields</code></td>
      <td><code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code></td>
      <td>è¿”å›æŒ‡å®šçš„å­˜å‚¨å­—æ®µï¼Œè€Œä¸æ˜¯è¿”å›æ•´ä¸ªæ–‡æ¡£ï¼ˆå¯é€‰ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fetchSource</code></td>
      <td><code class="language-plaintext highlighter-rouge">Boolean</code></td>
      <td>æ˜¯å¦æ£€ç´¢ <code class="language-plaintext highlighter-rouge">_source</code> å­—æ®µçš„æ•°æ®ï¼ˆé»˜è®¤ä¸º <code class="language-plaintext highlighter-rouge">true</code>ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fetchSourceIncludes</code></td>
      <td><code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code></td>
      <td>è®¾ç½®éœ€è¦åŒ…å«åœ¨ <code class="language-plaintext highlighter-rouge">_source</code> ä¸­çš„å­—æ®µï¼ˆå¯é€‰ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fetchSourceExcludes</code></td>
      <td><code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code></td>
      <td>è®¾ç½®éœ€è¦ä» <code class="language-plaintext highlighter-rouge">_source</code> ä¸­æ’é™¤çš„å­—æ®µï¼ˆå¯é€‰ï¼‰ã€‚</td>
    </tr>
  </tbody>
</table>

<p><strong>æ–¹æ³•</strong></p>

<p><strong>å­—æ®µè®¾ç½®æ–¹æ³•</strong></p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">index(String index)</code></td>
      <td>è®¾ç½®ç›®æ ‡ç´¢å¼•åç§°ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">id(String id)</code></td>
      <td>è®¾ç½®è¦æ£€ç´¢çš„æ–‡æ¡£ IDã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">routing(String routing)</code></td>
      <td>è®¾ç½®è·¯ç”±å€¼ï¼Œå½±å“åˆ†ç‰‡å®šä½ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">preference(String pref)</code></td>
      <td>è®¾ç½®æ£€ç´¢çš„é¦–é€‰é¡¹ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">_primary</code>ã€<code class="language-plaintext highlighter-rouge">_primary_first</code> ç­‰ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">realtime(boolean rt)</code></td>
      <td>è®¾ç½®æ˜¯å¦å®æ—¶æ£€ç´¢ï¼ˆé»˜è®¤ä¸º <code class="language-plaintext highlighter-rouge">true</code>ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">refresh(boolean refresh)</code></td>
      <td>è®¾ç½®åœ¨æ£€ç´¢å‰æ˜¯å¦åˆ·æ–°ç´¢å¼•ï¼ˆ<code class="language-plaintext highlighter-rouge">true</code> ä¸ºåˆ·æ–°ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">storedFields(List&lt;String&gt; fields)</code></td>
      <td>è®¾ç½®éœ€è¦è¿”å›çš„å­˜å‚¨å­—æ®µï¼ˆä¸è¿”å› <code class="language-plaintext highlighter-rouge">_source</code>ï¼Œåªè¿”å›å­˜å‚¨å­—æ®µå†…å®¹ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fetchSource(boolean fetch)</code></td>
      <td>æ˜¯å¦æ£€ç´¢ <code class="language-plaintext highlighter-rouge">_source</code> å­—æ®µã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fetchSourceIncludes(List&lt;String&gt; includes)</code></td>
      <td>è®¾ç½® <code class="language-plaintext highlighter-rouge">_source</code> ä¸­è¦åŒ…å«çš„å­—æ®µï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fetchSourceExcludes(List&lt;String&gt; excludes)</code></td>
      <td>è®¾ç½® <code class="language-plaintext highlighter-rouge">_source</code> ä¸­è¦æ’é™¤çš„å­—æ®µï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰ã€‚</td>
    </tr>
  </tbody>
</table>

<p><strong>æ„é€ ä¸è¾…åŠ©æ–¹æ³•</strong>
| æ–¹æ³•         | æè¿°                                                   |
| â€”â€”â€”â€” | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” |
| <code class="language-plaintext highlighter-rouge">build()</code>    | æ„å»º <code class="language-plaintext highlighter-rouge">GetRequest</code> å¯¹è±¡ï¼Œå°†è®¾ç½®çš„æ‰€æœ‰å‚æ•°å°è£…åˆ°è¯·æ±‚ä¸­ã€‚ |
| <code class="language-plaintext highlighter-rouge">toString()</code> | è¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œä¸»è¦ç”¨äºè°ƒè¯•å’Œæ—¥å¿—è®°å½•ã€‚         |</p>

<hr />

<p><strong>ç¤ºä¾‹ä»£ç </strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>          <span class="c1">// æŒ‡å®šç´¢å¼•</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>                 <span class="c1">// æŒ‡å®šæ–‡æ¡£ ID</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p><strong>è®¾ç½®æ›´å¤šå‚æ•°ï¼š</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">routing</span><span class="o">(</span><span class="s">"customRouting"</span><span class="o">)</span>         <span class="c1">// æŒ‡å®šè·¯ç”±å€¼</span>
    <span class="o">.</span><span class="na">preference</span><span class="o">(</span><span class="s">"_primary_first"</span><span class="o">)</span>     <span class="c1">// ä¼˜å…ˆä½¿ç”¨ä¸»åˆ†ç‰‡</span>
    <span class="o">.</span><span class="na">realtime</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>                  <span class="c1">// è®¾ç½®éå®æ—¶æ¨¡å¼</span>
    <span class="o">.</span><span class="na">fetchSourceIncludes</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"price"</span><span class="o">))</span> <span class="c1">// ä»…æ£€ç´¢æŒ‡å®šå­—æ®µ</span>
    <span class="o">.</span><span class="na">fetchSourceExcludes</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"internalField"</span><span class="o">))</span> <span class="c1">// æ’é™¤æŸäº›å­—æ®µ</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<hr />

<p><strong>ç”¨é€”ä¸è¯´æ˜</strong></p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">index</code> å’Œ <code class="language-plaintext highlighter-rouge">id</code> æ˜¯å¿…å¡«å­—æ®µ</strong>ï¼Œç”¨äºå®šä½ç›®æ ‡æ–‡æ¡£ã€‚</li>
  <li>æä¾›äº†çµæ´»çš„é€‰é¡¹æ¥ç²¾ç¡®æ§åˆ¶è¿”å›çš„æ•°æ®ï¼ˆå¦‚è¿‡æ»¤å­—æ®µã€ä½¿ç”¨å­˜å‚¨å­—æ®µç­‰ï¼‰ã€‚</li>
  <li>é€šå¸¸ä¸ <code class="language-plaintext highlighter-rouge">GetResponse</code> ä¸€èµ·ä½¿ç”¨ï¼Œç”¨äºè§£æå’Œå¤„ç†è¿”å›çš„æ–‡æ¡£æ•°æ®ã€‚</li>
</ul>

<h4 id="getresponse"><code class="language-plaintext highlighter-rouge">GetResponse</code></h4>

<p><code class="language-plaintext highlighter-rouge">GetResponse</code> æ˜¯ Elasticsearch å®¢æˆ·ç«¯ä¸­ï¼Œç”¨äºå°è£…å•æ¡æ–‡æ¡£æ£€ç´¢ç»“æœçš„å“åº”ç±»ã€‚</p>

<p><strong>å­—æ®µ</strong></p>

<table>
  <thead>
    <tr>
      <th>å­—æ®µåç§°</th>
      <th>ç±»å‹</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">index</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>æ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•åç§°ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">id</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>æ£€ç´¢åˆ°çš„æ–‡æ¡£ IDã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">version</code></td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
      <td>æ–‡æ¡£çš„ç‰ˆæœ¬å·ï¼ˆä»…åœ¨ç‰ˆæœ¬æ§åˆ¶å¯ç”¨æ—¶æœ‰æ•ˆï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">source</code></td>
      <td><code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code> æˆ– <code class="language-plaintext highlighter-rouge">Object</code></td>
      <td>è¿”å›çš„æ–‡æ¡£ <code class="language-plaintext highlighter-rouge">_source</code> æ•°æ®ï¼Œé€šå¸¸æ˜¯åŸå§‹æ–‡æ¡£å†…å®¹ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">found</code></td>
      <td><code class="language-plaintext highlighter-rouge">Boolean</code></td>
      <td>æ˜¯å¦æˆåŠŸæ‰¾åˆ°æ–‡æ¡£ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">primaryTerm</code></td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
      <td>ä¸»åˆ†ç‰‡çš„æœ¯è¯­å·ï¼ˆå¯é€‰ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">seqNo</code></td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
      <td>æ–‡æ¡£çš„åºåˆ—å·ï¼ˆå¯é€‰ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">routing</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>æ–‡æ¡£çš„è·¯ç”±å€¼ï¼ˆå¯é€‰ï¼‰ã€‚</td>
    </tr>
  </tbody>
</table>

<p><strong>æ–¹æ³•</strong></p>

<p><strong>åŸºæœ¬å­—æ®µè·å–æ–¹æ³•</strong></p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>è¿”å›å€¼ç±»å‹</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">index()</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>è·å–æ–‡æ¡£çš„ç´¢å¼•åç§°ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">id()</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>è·å–æ–‡æ¡£çš„ IDã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">version()</code></td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
      <td>è·å–æ–‡æ¡£çš„ç‰ˆæœ¬å·ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">source()</code></td>
      <td><code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code> æˆ– <code class="language-plaintext highlighter-rouge">Object</code></td>
      <td>è·å–æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_source</code> æ•°æ®ï¼Œé€šå¸¸æ˜¯åŸå§‹ JSON æ–‡æ¡£ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">found()</code></td>
      <td><code class="language-plaintext highlighter-rouge">Boolean</code></td>
      <td>æ£€æŸ¥æ˜¯å¦æˆåŠŸæ‰¾åˆ°æ–‡æ¡£ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">primaryTerm()</code></td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
      <td>è·å–ä¸»åˆ†ç‰‡çš„æœ¯è¯­å·ï¼ˆä»…å½“è¿”å›æ—¶æœ‰æ•ˆï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">seqNo()</code></td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
      <td>è·å–æ–‡æ¡£çš„åºåˆ—å·ï¼ˆä»…å½“è¿”å›æ—¶æœ‰æ•ˆï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">routing()</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>è·å–æ–‡æ¡£çš„è·¯ç”±å€¼ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚</td>
    </tr>
  </tbody>
</table>

<p><strong>è¾…åŠ©æ–¹æ³•</strong>
| æ–¹æ³•                 | è¿”å›å€¼ç±»å‹ | æè¿°                                       |
| â€”â€”â€”â€”â€”â€”â€“ | â€”â€”â€”- | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” |
| <code class="language-plaintext highlighter-rouge">toString()</code>         | <code class="language-plaintext highlighter-rouge">String</code>   | è¿”å›å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œæ–¹ä¾¿è°ƒè¯•æˆ–æ—¥å¿—è®°å½•ã€‚ |
| <code class="language-plaintext highlighter-rouge">equals(Object obj)</code> | <code class="language-plaintext highlighter-rouge">boolean</code>  | æ¯”è¾ƒä¸¤ä¸ªå“åº”å¯¹è±¡æ˜¯å¦ç›¸åŒã€‚                 |
| <code class="language-plaintext highlighter-rouge">hashCode()</code>         | <code class="language-plaintext highlighter-rouge">int</code>      | è¿”å›å¯¹è±¡çš„å“ˆå¸Œå€¼ï¼Œç”¨äºé›†åˆæ“ä½œç­‰åœºæ™¯ã€‚     |</p>

<hr />

<p><strong>ç¤ºä¾‹ä»£ç </strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetResponse</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">g</span> <span class="o">-&gt;</span> <span class="n">g</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">),</span> 
    <span class="nc">Product</span><span class="o">.</span><span class="na">class</span>
<span class="o">);</span>

<span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">found</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Document found:"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Index: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">index</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ID: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">id</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Source: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">source</span><span class="o">());</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Document not found!"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>è·å–ä¸»åˆ†ç‰‡ä¿¡æ¯ï¼š</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">found</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Primary Term: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">primaryTerm</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Sequence Number: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">seqNo</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>é€šè¿‡ <code class="language-plaintext highlighter-rouge">_source</code> è½¬ä¸ºå¯¹è±¡ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>  <span class="c1">// å¦‚æœä½¿ç”¨æ³›å‹ï¼Œç›´æ¥è¿”å›ååºåˆ—åŒ–çš„å¯¹è±¡ã€‚</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Product: "</span> <span class="o">+</span> <span class="n">product</span><span class="o">);</span>
</code></pre></div></div>

<hr />

<p><strong>æ³¨æ„äº‹é¡¹</strong></p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">found</code> å­—æ®µï¼š</strong>å¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼Œåˆ™ <code class="language-plaintext highlighter-rouge">found</code> ä¸º <code class="language-plaintext highlighter-rouge">false</code>ï¼Œä¸” <code class="language-plaintext highlighter-rouge">source</code> ç­‰å­—æ®µè¿”å› <code class="language-plaintext highlighter-rouge">null</code>ã€‚</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">source</code> çš„æ³›å‹æ”¯æŒï¼š</strong>å¦‚æœåœ¨è¯·æ±‚ä¸­ä½¿ç”¨äº†æ³›å‹ç±»ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">Product.class</code>ï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">source()</code> æ–¹æ³•ä¼šè¿”å›ååºåˆ—åŒ–åçš„å¯¹è±¡ã€‚</p>
  </li>
  <li>
    <p><strong>è·¯ç”±å’Œç‰ˆæœ¬æ§åˆ¶ï¼š</strong>å¦‚æœæ–‡æ¡£å¯ç”¨äº†è‡ªå®šä¹‰è·¯ç”±æˆ–ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">routing()</code> å’Œ <code class="language-plaintext highlighter-rouge">version()</code> è·å–è¿™äº›ä¿¡æ¯ã€‚</p>
  </li>
  <li>
    <p><strong>ä¸ <code class="language-plaintext highlighter-rouge">GetRequest</code> é…åˆä½¿ç”¨ï¼š</strong><code class="language-plaintext highlighter-rouge">GetResponse</code> é€šå¸¸ä¸ <code class="language-plaintext highlighter-rouge">GetRequest</code> ä¸€èµ·ä½¿ç”¨ï¼Œç”¨äºè§£æè¿”å›çš„å•æ¡æ–‡æ¡£æ•°æ®ã€‚</p>
  </li>
</ul>

<h4 id="get"><code class="language-plaintext highlighter-rouge">get()</code></h4>

<p><code class="language-plaintext highlighter-rouge">esClient.get()</code> æ˜¯ Elasticsearch å®¢æˆ·ç«¯ä¸­ç”¨äºè·å–å•æ¡æ–‡æ¡£æ•°æ®çš„æ–¹æ³•ã€‚åœ¨ä¸åŒç‰ˆæœ¬çš„ Elasticsearch å®¢æˆ·ç«¯ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">get()</code> æ–¹æ³•çš„å‚æ•°å¯èƒ½æœ‰æ‰€ä¸åŒã€‚ä»¥ä¸‹æ˜¯ <code class="language-plaintext highlighter-rouge">esClient.get()</code> æ–¹æ³•çš„å¸¸ç”¨å˜ä½“å’Œå‚æ•°ï¼ŒåŸºäº Elasticsearch 7.x å’Œ 8.x å®¢æˆ·ç«¯ã€‚</p>

<p><strong>åŸºæœ¬çš„ <code class="language-plaintext highlighter-rouge">get()</code> æ–¹æ³•</strong></p>

<p><strong>å‚æ•°ï¼š</strong><code class="language-plaintext highlighter-rouge">GetRequest getRequest</code>ï¼šè¿™æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">GetRequest</code> å¯¹è±¡ï¼ŒåŒ…å«äº†éœ€è¦çš„ç´¢å¼•ã€æ–‡æ¡£ ID å’Œå…¶ä»–å¯é€‰å‚æ•°ï¼ˆå¦‚è·¯ç”±å€¼ï¼‰ã€‚</p>

<p><strong>è¿”å›ï¼š</strong><code class="language-plaintext highlighter-rouge">GetResponse</code>ï¼šåŒ…å«äº†æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_source</code> æ•°æ®ã€æ–‡æ¡£ IDã€ç´¢å¼•åç­‰ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetRequest</span> <span class="n">getRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetRequest</span><span class="o">(</span><span class="s">"products"</span><span class="o">,</span> <span class="s">"bk-1"</span><span class="o">);</span>
<span class="nc">GetResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">getRequest</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">found</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Product: "</span> <span class="o">+</span> <span class="n">product</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">get()</code> æ–¹æ³•çš„å¼‚æ­¥å˜ä½“</strong></p>

<p>Elasticsearch å®¢æˆ·ç«¯ä¹Ÿæ”¯æŒå¼‚æ­¥è·å–æ–‡æ¡£æ•°æ®çš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">ActionListener</code> æ¥å¤„ç†å¼‚æ­¥å“åº”ã€‚</p>

<p><strong>å‚æ•°ï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">GetRequest getRequest</code>ï¼šè¯·æ±‚å¯¹è±¡ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">ActionListener&lt;GetResponse&gt;</code>ï¼šç”¨äºå¤„ç†å¼‚æ­¥å“åº”çš„å›è°ƒã€‚</li>
</ul>

<p><strong>è¿”å›ï¼š</strong> å¼‚æ­¥æ“ä½œï¼Œä¸ä¼šç›´æ¥è¿”å› <code class="language-plaintext highlighter-rouge">GetResponse</code>ï¼Œè€Œæ˜¯é€šè¿‡å›è°ƒé€šçŸ¥å“åº”ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetRequest</span> <span class="n">getRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetRequest</span><span class="o">(</span><span class="s">"products"</span><span class="o">,</span> <span class="s">"bk-1"</span><span class="o">);</span>
<span class="n">esClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">getRequest</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ActionListener</span><span class="o">&lt;</span><span class="nc">GetResponse</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onResponse</span><span class="o">(</span><span class="nc">GetResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">found</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Product: "</span> <span class="o">+</span> <span class="n">product</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onFailure</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">get()</code> æ–¹æ³•ï¼ˆElasticsearchClient 8.xï¼‰</strong></p>

<p>åœ¨ Elasticsearch 8.x ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">get()</code> æ–¹æ³•çš„æ¥å£å‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œ<code class="language-plaintext highlighter-rouge">ElasticsearchClient</code> å¼•å…¥äº†æ–°çš„ API æ¥è¿›è¡Œæ•°æ®çš„è·å–ã€‚ç›¸æ¯”äº 7.x å®¢æˆ·ç«¯ï¼Œ8.x å®¢æˆ·ç«¯çš„ <code class="language-plaintext highlighter-rouge">get()</code> æ–¹æ³•ä¸å†ç›´æ¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">RequestOptions</code>ï¼Œè€Œæ˜¯ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">GetRequest</code> å¯¹è±¡å’Œæ³›å‹æ¥æŒ‡å®šè¿”å›ç±»å‹ã€‚</p>

<p><strong>å‚æ•°ï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">GetRequest getRequest</code>ï¼šè¯·æ±‚å¯¹è±¡ï¼ŒåŒ…å«ç´¢å¼•ã€æ–‡æ¡£ ID å’Œå¯é€‰çš„è·¯ç”±ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">Class&lt;T&gt;</code>ï¼šæŒ‡å®šè¿”å›ç±»å‹ï¼Œé€šå¸¸æ˜¯ä» Elasticsearch è·å–çš„æ•°æ®æ¨¡å‹ç±»ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">Product.class</code>ï¼‰ã€‚</li>
</ul>

<p><strong>è¿”å›ï¼š</strong><code class="language-plaintext highlighter-rouge">GetResponse&lt;T&gt;</code>ï¼šè¿”å›æŒ‡å®šç±»å‹çš„æ•°æ®ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetRequest</span> <span class="n">getRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetRequest</span><span class="o">(</span><span class="s">"products"</span><span class="o">,</span> <span class="s">"bk-1"</span><span class="o">);</span>
<span class="nc">GetResponse</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">getRequest</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">found</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Product: "</span> <span class="o">+</span> <span class="n">product</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">get()</code> æ–¹æ³•çš„å…¶ä»–å˜ä½“</strong></p>

<p><strong>å¸¸ç”¨å‚æ•°ï¼š</strong></p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">index(String index)</code></strong>ï¼šæŒ‡å®šè¦æŸ¥è¯¢çš„ç´¢å¼•ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">id(String id)</code></strong>ï¼šæŒ‡å®šè¦æŸ¥è¯¢æ–‡æ¡£çš„ IDã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">routing(String routing)</code></strong>ï¼šæŒ‡å®šæ–‡æ¡£çš„è·¯ç”±å€¼ï¼ˆå¯é€‰ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">preference(String preference)</code></strong>ï¼šæŒ‡å®šæŸ¥è¯¢çš„ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰ã€‚</li>
</ul>

<p>è¿™äº›å‚æ•°é€šå¸¸é€šè¿‡ <code class="language-plaintext highlighter-rouge">GetRequest</code> å¯¹è±¡æ¥ä¼ é€’ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetRequest</span> <span class="n">getRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetRequest</span><span class="o">(</span><span class="s">"products"</span><span class="o">,</span> <span class="s">"bk-1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">routing</span><span class="o">(</span><span class="s">"user1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">preference</span><span class="o">(</span><span class="s">"replica"</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>æ€»ç»“</strong></p>

<p><code class="language-plaintext highlighter-rouge">esClient.get()</code> æ–¹æ³•çš„å¸¸ç”¨å˜ä½“å’Œå‚æ•°ï¼š</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">GetRequest getRequest</code></strong>ï¼šè¿™æ˜¯å¿…é¡»æä¾›çš„ï¼ŒåŒ…å«ç´¢å¼•åç§°ã€æ–‡æ¡£ ID ä»¥åŠå…¶ä»–å¯é€‰å‚æ•°ï¼ˆå¦‚è·¯ç”±å’Œä¼˜å…ˆçº§ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">RequestOptions</code></strong>ï¼šåœ¨ 7.x ç‰ˆæœ¬ä¸­ï¼Œå¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">RequestOptions</code> è®¾ç½®è¯·æ±‚çš„é…ç½®ï¼ˆå¦‚è¶…æ—¶ã€è®¤è¯ç­‰ï¼‰ã€‚åœ¨ 8.x ä¸­å·²ä¸å†æ˜¾å¼ä½¿ç”¨ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">ActionListener&lt;GetResponse&gt;</code></strong>ï¼šç”¨äºå¼‚æ­¥æ“ä½œï¼Œæä¾›å›è°ƒæœºåˆ¶æ¥å¤„ç†å“åº”æˆ–å¤±è´¥ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">Product.class</code> æˆ–å…¶ä»–è‡ªå®šä¹‰ç±»</strong>ï¼šæŒ‡å®šè¿”å›æ•°æ®çš„ç±»å‹ï¼ŒElasticsearch ä¼šå°† <code class="language-plaintext highlighter-rouge">_source</code> æ•°æ®ååºåˆ—åŒ–ä¸ºè¯¥ç±»å‹ã€‚</li>
</ul>

<h3 id="æ›´æ–°">æ›´æ–°</h3>

<p>é€šè¿‡ HTTP æ›´æ–° Elasticsearch ä¸­çš„æ•°æ®ï¼Œé€šå¸¸ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PUT</code> æˆ– <code class="language-plaintext highlighter-rouge">POST</code> è¯·æ±‚ã€‚æ›´æ–°æ“ä½œä¼šä¾èµ–äºä½ æ˜¯å¦æŒ‡å®šæ–‡æ¡£çš„ IDã€‚ä»¥ä¸‹æ˜¯é€šè¿‡ HTTP è¯·æ±‚æ›´æ–°æ•°æ®çš„æ­¥éª¤å’Œç¤ºä¾‹ã€‚</p>

<p><strong>æ›´æ–°æ•°æ®çš„ HTTP è¯·æ±‚æ–¹å¼</strong></p>

<ul>
  <li><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PUT</code> è¯·æ±‚</strong>ï¼šå¦‚æœæ–‡æ¡£å·²å­˜åœ¨ï¼Œå®ƒä¼šè¢«æ›´æ–°ã€‚å¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºæ–°æ–‡æ¡£ã€‚</li>
  <li><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">POST</code> è¯·æ±‚</strong>ï¼šé€‚ç”¨äºéƒ¨åˆ†æ›´æ–°ï¼ˆæ–‡æ¡£éƒ¨åˆ†å­—æ®µæ›´æ–°ï¼‰ï¼Œå³ä½¿ç”¨ Elasticsearch çš„æ›´æ–° APIã€‚</li>
</ul>

<p><strong>HTTP è¯·æ±‚çš„åŸºæœ¬æ ¼å¼</strong></p>

<ul>
  <li><strong>è¯·æ±‚ URL</strong>ï¼š
    <ul>
      <li>æ ¼å¼ï¼š<code class="language-plaintext highlighter-rouge">http://&lt;hostname&gt;:&lt;port&gt;/&lt;index&gt;/_doc/&lt;document_id&gt;</code></li>
      <li>ç¤ºä¾‹ï¼š<code class="language-plaintext highlighter-rouge">http://localhost:9200/products/_doc/1</code></li>
    </ul>
  </li>
  <li>
    <p><strong>è¯·æ±‚å¤´</strong>ï¼š<code class="language-plaintext highlighter-rouge">Content-Type: application/json</code>ï¼šæŒ‡å®šè¯·æ±‚ä½“çš„æ ¼å¼ä¸º JSONã€‚</p>
  </li>
  <li><strong>è¯·æ±‚ä½“</strong>ï¼š
    <ul>
      <li>åœ¨ <code class="language-plaintext highlighter-rouge">PUT</code> è¯·æ±‚ä¸­ï¼Œå¯ä»¥æä¾›å®Œæ•´çš„æ–‡æ¡£å†…å®¹ï¼Œæ›´æ–°æ–‡æ¡£ã€‚</li>
      <li>åœ¨ <code class="language-plaintext highlighter-rouge">POST</code> è¯·æ±‚ä¸­ï¼Œé€šå¸¸åªæä¾›éœ€è¦æ›´æ–°çš„å­—æ®µï¼ŒElasticsearch ä¼šå¯¹æ–‡æ¡£è¿›è¡Œéƒ¨åˆ†æ›´æ–°ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>ç¤ºä¾‹ï¼šé€šè¿‡ HTTP æ›´æ–°æ•°æ®</strong></p>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PUT</code> æ›´æ–°æ•°æ®ï¼ˆå®Œæ•´æ›¿æ¢æ–‡æ¡£ï¼‰</strong></p>

<p><code class="language-plaintext highlighter-rouge">PUT</code> è¯·æ±‚å°†å®Œå…¨æ›¿æ¢æŒ‡å®š ID çš„æ–‡æ¡£ã€‚å¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºæ–°æ–‡æ¡£ã€‚</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT http://localhost:9200/products/_doc/bk-1
Content-Type: application/json

{
  "sku": "bk-1",
  "name": "Mountain bike",
  "price": 150.0
}
</span></code></pre></div></div>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">POST</code> æ›´æ–°æ•°æ®ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰</strong></p>

<p><code class="language-plaintext highlighter-rouge">POST</code> è¯·æ±‚é€‚ç”¨äºéƒ¨åˆ†æ›´æ–°ï¼Œåªæœ‰æä¾›çš„å­—æ®µä¼šè¢«æ›´æ–°ï¼Œå…¶ä»–å­—æ®µä¿æŒä¸å˜ã€‚</p>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">POST http://localhost:9200/products/_doc/bk-1/_update
Content-Type: application/json

{
  "doc": {
    "price": 150.0
  }
}
</span></code></pre></div></div>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">_update</code> è·¯å¾„æŒ‡ç¤ºéƒ¨åˆ†æ›´æ–°æ“ä½œï¼Œ<code class="language-plaintext highlighter-rouge">doc</code> å­—æ®µåŒ…å«è¦æ›´æ–°çš„å†…å®¹ã€‚</p>

<p><strong>æ›´æ–°æ•°æ®çš„å“åº”</strong></p>

<p>æ— è®ºæ˜¯ <code class="language-plaintext highlighter-rouge">PUT</code> è¿˜æ˜¯ <code class="language-plaintext highlighter-rouge">POST</code> è¯·æ±‚ï¼ŒElasticsearch éƒ½ä¼šè¿”å›ä¸€ä¸ª JSON å“åº”ï¼Œè¡¨ç¤ºæ›´æ–°æ“ä½œçš„ç»“æœã€‚ä»¥ä¸‹æ˜¯å“åº”çš„ä¸€ä¸ªç¤ºä¾‹ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"products"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"_doc"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bk-1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_version"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"result"</span><span class="p">:</span><span class="w"> </span><span class="s2">"updated"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
    </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
    </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"_seq_no"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_primary_term"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">_index</code></strong>ï¼šæ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">_id</code></strong>ï¼šæ–‡æ¡£çš„ IDã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">_version</code></strong>ï¼šæ–‡æ¡£çš„ç‰ˆæœ¬ï¼Œæ›´æ–°æ—¶ä¼šå¢åŠ ç‰ˆæœ¬å·ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">result</code></strong>ï¼šæ“ä½œç»“æœï¼Œ<code class="language-plaintext highlighter-rouge">updated</code> è¡¨ç¤ºæ–‡æ¡£å·²æ›´æ–°ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">_shards</code></strong>ï¼šæœ‰å…³åˆ†ç‰‡çš„ä¿¡æ¯ï¼Œè¡¨ç¤ºæ“ä½œæ‰§è¡ŒæˆåŠŸçš„åˆ†ç‰‡æ•°ç­‰ã€‚</li>
</ul>

<p><strong>é”™è¯¯å¤„ç†</strong></p>

<p>å¦‚æœæ›´æ–°æ“ä½œå‡ºç°é”™è¯¯ï¼ŒElasticsearch ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
  <li><strong>400 Bad Request</strong>ï¼šè¯·æ±‚æ ¼å¼é”™è¯¯ï¼Œé€šå¸¸æ˜¯å› ä¸º JSON æ ¼å¼ä¸æ­£ç¡®ã€‚</li>
  <li><strong>404 Not Found</strong>ï¼šç›®æ ‡ç´¢å¼•æˆ–æ–‡æ¡£ ID ä¸å­˜åœ¨ã€‚</li>
  <li><strong>409 Conflict</strong>ï¼šå°è¯•æ›´æ–°ä¸å­˜åœ¨çš„æ–‡æ¡£ã€‚</li>
</ul>

<hr />

<p><strong>æ€»ç»“</strong></p>

<p>é€šè¿‡ HTTP æ›´æ–°æ•°æ®çš„åŸºæœ¬æ­¥éª¤æ˜¯ï¼š</p>
<ol>
  <li>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PUT</code> æˆ– <code class="language-plaintext highlighter-rouge">POST</code> è¯·æ±‚ï¼Œ<code class="language-plaintext highlighter-rouge">PUT</code> ç”¨äºå®Œæ•´æ›¿æ¢æ–‡æ¡£ï¼Œ<code class="language-plaintext highlighter-rouge">POST</code> ç”¨äºéƒ¨åˆ†æ›´æ–°æ–‡æ¡£ã€‚</li>
  <li>è®¾ç½®æ­£ç¡®çš„ URL å’Œè¯·æ±‚å¤´ã€‚</li>
  <li>æä¾›è¦æ›´æ–°çš„æ–‡æ¡£å†…å®¹ï¼ˆå®Œæ•´æˆ–éƒ¨åˆ†å­—æ®µï¼‰ã€‚</li>
  <li>å‘é€è¯·æ±‚å¹¶å¤„ç†å“åº”ã€‚</li>
</ol>

<hr />

<p>é€šè¿‡Javaæ›´æ–°æ•°æ®ï¼š</p>

<p><strong>éƒ¨åˆ†æ›´æ–°æ–‡æ¡£ï¼ˆä½¿ç”¨ <code class="language-plaintext highlighter-rouge">update</code>ï¼‰</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateRequest</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">updateRequest</span> <span class="o">=</span> <span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">index</span><span class="o">)</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
        <span class="o">.</span><span class="na">doc</span><span class="o">(</span><span class="nc">JsonData</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">jsonString</span><span class="o">))</span>
<span class="o">);</span>
<span class="nc">UpdateResponse</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">updateResponse</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">updateRequest</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updateResponse</span><span class="o">.</span><span class="na">result</span><span class="o">());</span>
</code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">UpdateRequest.of()</code></strong>ï¼šä½¿ç”¨ <code class="language-plaintext highlighter-rouge">of()</code> æ–¹æ³•æ„å»ºæ›´æ–°è¯·æ±‚ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">JsonData.of()</code></strong>ï¼šå°† JSON å­—ç¬¦ä¸²è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">JsonData</code> ç±»å‹ï¼Œè¿™æ˜¯ <code class="language-plaintext highlighter-rouge">co.elastic.clients</code> ä¸­ç”¨äºä¼ è¾“ JSON æ•°æ®çš„ç±»å‹ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">updateResponse.result()</code></strong>ï¼šè¿”å›æ“ä½œç»“æœï¼ŒæŒ‡ç¤ºæ›´æ–°æ˜¯å¦æˆåŠŸã€‚</li>
</ul>

<p><strong>å®Œæ•´æ›¿æ¢æ–‡æ¡£ï¼ˆä½¿ç”¨ <code class="language-plaintext highlighter-rouge">index</code>ï¼‰</strong>ï¼Œè¯¦è§£æ’å…¥ã€‚</p>

<p>æ›´æ–°æ“ä½œå¯èƒ½ä¼šå¤±è´¥ï¼Œå› æ­¤éœ€è¦è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚å¸¸è§çš„å¼‚å¸¸æœ‰ï¼š</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">VersionConflictEngineException</code></strong>ï¼šç‰ˆæœ¬å†²çªå¼‚å¸¸ï¼Œé€šå¸¸å‘ç”Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">ElasticsearchException</code></strong>ï¼šå…¶ä»–ä¸ Elasticsearch ç›¸å…³çš„å¼‚å¸¸ã€‚</li>
</ul>

<hr />

<p><strong>æ›´æ–°è¯¦è§£</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">co.elastic.clients.elasticsearch.core.UpdateRequest&lt;TDocument, TPartial&gt;</code></strong></p>

<ul>
  <li>ç”¨äºæ„å»ºæ›´æ–°è¯·æ±‚ã€‚</li>
  <li>æ”¯æŒæ›´æ–°æ•´ä¸ªæ–‡æ¡£æˆ–éƒ¨åˆ†å­—æ®µã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">co.elastic.clients.elasticsearch.core.UpdateResponse&lt;TDocument&gt;</code></strong></p>

<ul>
  <li>ç”¨äºå¤„ç†æ›´æ–°æ“ä½œçš„å“åº”ã€‚</li>
  <li>åŒ…å«ç»“æœçŠ¶æ€å’Œæ–‡æ¡£å…ƒæ•°æ®ã€‚</li>
</ul>

<p>åŒ <code class="language-plaintext highlighter-rouge">index</code>ï¼Œ<code class="language-plaintext highlighter-rouge">UpdateRequest</code>ä¹Ÿæœ‰åŒæ ·çš„å‡ ç§æ„å»ºæ–¹å¼ï¼š</p>

<p>æ–¹å¼2ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">=</span><span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"cityBike"</span><span class="o">,</span><span class="s">"æµ‹è¯•ä¿®æ”¹"</span><span class="o">);</span>
<span class="nc">UpdateRequest</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">updateRequest</span> <span class="o">=</span> <span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">doc</span><span class="o">(</span><span class="n">map</span><span class="o">)</span>
<span class="o">);</span>
<span class="nc">UpdateResponse</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">updateResponse</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">updateRequest</span><span class="o">,</span><span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<p>æ–¹å¼3ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateResponse</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">updateResponse</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">doc</span><span class="o">(</span><span class="n">map</span><span class="o">),</span><span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<h4 id="updaterequest"><strong><code class="language-plaintext highlighter-rouge">UpdateRequest</code></strong></h4>

<p><code class="language-plaintext highlighter-rouge">UpdateRequest</code> æ˜¯ç”¨äºæ„å»º Elasticsearch æ›´æ–°è¯·æ±‚çš„æ ¸å¿ƒç±»ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥æŒ‡å®šç´¢å¼•ã€æ–‡æ¡£ IDã€æ›´æ–°å†…å®¹ï¼ˆéƒ¨åˆ†æ›´æ–°æˆ–è„šæœ¬æ›´æ–°ï¼‰ç­‰å‚æ•°ã€‚</p>

<p><strong>å­—æ®µ</strong></p>

<p>ä»¥ä¸‹æ˜¯ <code class="language-plaintext highlighter-rouge">UpdateRequest</code> çš„å¸¸ç”¨å­—æ®µï¼š</p>

<table>
  <thead>
    <tr>
      <th>å­—æ®µåç§°</th>
      <th>ç±»å‹</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">index</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>è¦æ›´æ–°çš„ç´¢å¼•åç§°ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">id</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>è¦æ›´æ–°çš„æ–‡æ¡£ IDã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">routing</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
      <td>å¯é€‰çš„è·¯ç”±å€¼ï¼Œç”¨äºåˆ†ç‰‡åˆ†å‘ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ifSeqNo</code></td>
      <td><code class="language-plaintext highlighter-rouge">Long</code></td>
      <td>åºåˆ—å·ï¼Œç¡®ä¿åªåœ¨ç‰¹å®šç‰ˆæœ¬æ—¶æ›´æ–°ï¼ˆä¹è§‚é”ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ifPrimaryTerm</code></td>
      <td><code class="language-plaintext highlighter-rouge">Long</code></td>
      <td>ä¸»åˆ†ç‰‡ç‰ˆæœ¬å·ï¼Œä¸ <code class="language-plaintext highlighter-rouge">ifSeqNo</code> ç»“åˆä½¿ç”¨ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">doc</code></td>
      <td><code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code> æˆ– <code class="language-plaintext highlighter-rouge">JsonData</code>ï¼Œæˆ–<code class="language-plaintext highlighter-rouge">T</code></td>
      <td>è¦æ›´æ–°çš„éƒ¨åˆ†æ–‡æ¡£å†…å®¹ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">upsert</code></td>
      <td><code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code> æˆ– <code class="language-plaintext highlighter-rouge">JsonData</code>ï¼Œæˆ–<code class="language-plaintext highlighter-rouge">T</code></td>
      <td>å¦‚æœæ–‡æ¡£ä¸å­˜åœ¨æ—¶æ’å…¥çš„å†…å®¹ã€‚</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">script</code></strong></td>
      <td><code class="language-plaintext highlighter-rouge">Script</code></td>
      <td>ç”¨äºåŠ¨æ€æ›´æ–°æ–‡æ¡£çš„è„šæœ¬ã€‚</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">docAsUpsert</code></strong></td>
      <td><code class="language-plaintext highlighter-rouge">boolean</code></td>
      <td>æ˜¯å¦å°†éƒ¨åˆ†æ–‡æ¡£ä½œä¸ºæ’å…¥å†…å®¹ï¼ˆå¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fetchSource</code></td>
      <td><code class="language-plaintext highlighter-rouge">FetchSourceContext</code></td>
      <td>æ˜¯å¦è¿”å›æ›´æ–°åçš„æ–‡æ¡£ä»¥åŠå“ªäº›å­—æ®µéœ€è¦è¿”å›ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">retryOnConflict</code></td>
      <td><code class="language-plaintext highlighter-rouge">Integer</code></td>
      <td>æ›´æ–°å†²çªé‡è¯•çš„æ¬¡æ•°ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">refresh</code></td>
      <td><code class="language-plaintext highlighter-rouge">RefreshPolicy</code></td>
      <td>æ›´æ–°æ“ä½œåæ˜¯å¦åˆ·æ–°ç´¢å¼•ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">timeout</code></td>
      <td><code class="language-plaintext highlighter-rouge">TimeValue</code></td>
      <td>ç­‰å¾…ä¸»åˆ†ç‰‡å“åº”çš„è¶…æ—¶æ—¶é—´ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<p><strong>æ–¹æ³•</strong></p>

<p><strong>åŸºç¡€è®¾ç½®æ–¹æ³•</strong></p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>è¿”å›ç±»å‹</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">index(String index)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®ç›®æ ‡ç´¢å¼•åç§°ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">id(String id)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®æ–‡æ¡£ IDã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">routing(String routing)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®è·¯ç”±ä¿¡æ¯ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ifSeqNo(long seqNo)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®åºåˆ—å·ï¼ˆç”¨äºä¹è§‚å¹¶å‘æ§åˆ¶ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ifPrimaryTerm(long term)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®ä¸»åˆ†ç‰‡ç‰ˆæœ¬å·ã€‚</td>
    </tr>
  </tbody>
</table>

<p><strong>å†…å®¹è®¾ç½®æ–¹æ³•</strong></p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>è¿”å›ç±»å‹</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">doc(Object doc)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®éƒ¨åˆ†æ›´æ–°çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯ Map æˆ– POJOã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">upsert(Object upsert)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®æ’å…¥æ–‡æ¡£ï¼ˆå¦‚æœæ–‡æ¡£ä¸å­˜åœ¨æ—¶ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><strong><code class="language-plaintext highlighter-rouge">script(Script script)</code></strong></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®æ›´æ–°è„šæœ¬ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">docAsUpsert(boolean docAsUpsert)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>æ˜¯å¦å°†éƒ¨åˆ†æ–‡æ¡£ä½œä¸ºæ’å…¥å†…å®¹ï¼ˆå¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼‰ã€‚</td>
    </tr>
  </tbody>
</table>

<p><strong>æ§åˆ¶å‚æ•°æ–¹æ³•</strong></p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>è¿”å›ç±»å‹</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">retryOnConflict(int retries)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®æ›´æ–°å†²çªçš„é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ 0ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">refresh(RefreshPolicy policy)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®åˆ·æ–°ç­–ç•¥ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">timeout(TimeValue timeout)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®ç­‰å¾…ä¸»åˆ†ç‰‡å“åº”çš„è¶…æ—¶æ—¶é—´ã€‚</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">scriptedUpsert(Boolean value)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®ä¸º true ä»¥æ‰§è¡Œè„šæœ¬ï¼Œæ— è®ºæ–‡æ¡£æ˜¯å¦å­˜åœ¨</td>
    </tr>
  </tbody>
</table>

<p><strong>Fetch Source æ–¹æ³•</strong></p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>è¿”å›ç±»å‹</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">source(SourceConfig fetch)</code></td>
      <td><code class="language-plaintext highlighter-rouge">UpdateRequest</code></td>
      <td>è®¾ç½®è¿”å›çš„å­—æ®µèŒƒå›´ï¼ˆå…·ä½“å­—æ®µæˆ–æ’é™¤å­—æ®µï¼‰</td>
    </tr>
  </tbody>
</table>

<p><strong>éƒ¨åˆ†å­—æ®µæ›´æ–°</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Product</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;&gt;();</span>
<span class="nc">UpdateRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="n">builder</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">doc</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span> <span class="s">"stock"</span><span class="o">,</span> <span class="mi">50</span><span class="o">))</span> <span class="c1">// æ›´æ–°éƒ¨åˆ†å­—æ®µ</span>
    <span class="o">.</span><span class="na">docAsUpsert</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>                      <span class="c1">// å¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼Œæ’å…¥æ–°æ–‡æ¡£</span>
    <span class="o">.</span><span class="na">retryOnConflict</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>                     <span class="c1">// æ›´æ–°å†²çªé‡è¯•æ¬¡æ•°</span>
    <span class="o">.</span><span class="na">fetchSource</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>                      <span class="c1">// è¿”å›æ›´æ–°åçš„æºæ–‡æ¡£</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p><strong>è„šæœ¬æ›´æ–°</strong></p>

<p>é€šè¿‡è„šæœ¬åŠ¨æ€æ›´æ–°å­—æ®µçš„å€¼ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Script</span> <span class="n">script</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Script</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"ctx._source.price += params.increment"</span><span class="o">)</span> <span class="c1">// ä½¿ç”¨ Painless è„šæœ¬</span>
    <span class="o">.</span><span class="na">params</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"increment"</span><span class="o">,</span> <span class="mi">20</span><span class="o">))</span>                <span class="c1">// è®¾ç½®å‚æ•°</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Product</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;&gt;();</span>
<span class="nc">UpdateRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="n">builder</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">script</span><span class="o">(</span><span class="n">script</span><span class="o">)</span>
    <span class="o">.</span><span class="na">timeout</span><span class="o">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">time</span><span class="o">(</span><span class="s">"2s"</span><span class="o">))</span> <span class="c1">// è®¾ç½®è¶…æ—¶æ—¶é—´</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p><strong>è®¾ç½® <code class="language-plaintext highlighter-rouge">upsert</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">upsert</code> çš„åŠŸèƒ½åœ¨ Fluent DSL ä¸­ä¹Ÿæ”¯æŒï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Product</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;&gt;();</span>
<span class="nc">UpdateRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="n">builder</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">doc</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">200</span><span class="o">))</span>               <span class="c1">// å¦‚æœæ–‡æ¡£å­˜åœ¨ï¼Œæ›´æ–° "price" å­—æ®µçš„å€¼ä¸º 200</span>
    <span class="o">.</span><span class="na">upsert</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">200</span><span class="o">,</span> <span class="s">"stock"</span><span class="o">,</span> <span class="mi">100</span><span class="o">))</span> <span class="c1">// å¦‚æœæ–‡æ¡£ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å« "price" å’Œ "stock" çš„æ–°æ–‡æ¡£</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p><strong>æ§åˆ¶åˆ·æ–°ç­–ç•¥</strong></p>

<p>è®¾ç½®åˆ·æ–°ç­–ç•¥ï¼Œä»¥ç¡®ä¿æ›´æ–°åç«‹å³å¯¹æŸ¥è¯¢å¯è§ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Product</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;&gt;();</span>
<span class="nc">UpdateRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">,</span> <span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="n">builder</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">doc</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"status"</span><span class="o">,</span> <span class="s">"updated"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="nc">Refresh</span><span class="o">.</span><span class="na">True</span><span class="o">)</span> <span class="c1">// è®¾ç½®åˆ·æ–°ç­–ç•¥ä¸ºç«‹å³åˆ·æ–°</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<h4 id="updateresponse"><code class="language-plaintext highlighter-rouge">UpdateResponse</code></h4>

<p><code class="language-plaintext highlighter-rouge">UpdateResponse</code> æ˜¯ä¸€ä¸ªé‡è¦çš„ç±»ï¼Œç”¨äºè¡¨ç¤º <code class="language-plaintext highlighter-rouge">UpdateRequest</code> çš„å“åº”ã€‚å®ƒåŒ…å«äº†å…³äºæ›´æ–°æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚æ›´æ–°çŠ¶æ€ã€æ–‡æ¡£å…ƒæ•°æ®ç­‰ã€‚</p>

<table>
  <thead>
    <tr>
      <th>æ–¹æ³•</th>
      <th>æè¿°</th>
      <th>è¿”å›ç±»å‹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">id()</code></td>
      <td>è·å–æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_id</code></td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">index()</code></td>
      <td>è·å–æ–‡æ¡£çš„ç´¢å¼•åç§°</td>
      <td><code class="language-plaintext highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">version()</code></td>
      <td>è·å–æ–‡æ¡£ç‰ˆæœ¬å·</td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">result()</code></td>
      <td>è·å–æ›´æ–°æ“ä½œçš„ç»“æœ</td>
      <td><code class="language-plaintext highlighter-rouge">Result</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">shards()</code></td>
      <td>è·å–åˆ†ç‰‡ç»Ÿè®¡ä¿¡æ¯</td>
      <td><code class="language-plaintext highlighter-rouge">ShardStatistics</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">seqNo()</code></td>
      <td>è·å–æ“ä½œçš„åºåˆ—å·</td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">primaryTerm()</code></td>
      <td>è·å–æ“ä½œçš„ä¸»åˆ†ç‰‡ä»»æœŸå·</td>
      <td><code class="language-plaintext highlighter-rouge">long</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">get()</code></td>
      <td>è·å–æ–‡æ¡£çš„å½“å‰çŠ¶æ€ï¼ˆéœ€å¯ç”¨ <code class="language-plaintext highlighter-rouge">source</code>ï¼‰</td>
      <td><code class="language-plaintext highlighter-rouge">@Nullable GetResult</code></td>
    </tr>
  </tbody>
</table>

<p><strong><code class="language-plaintext highlighter-rouge">result</code> (Result)</strong>ï¼šè¡¨ç¤ºæ›´æ–°æ“ä½œçš„ç»“æœçŠ¶æ€ï¼Œæšä¸¾ç±»å‹ <code class="language-plaintext highlighter-rouge">Result</code>ï¼Œå¯èƒ½çš„å€¼æœ‰ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Created</code>ï¼šæ–‡æ¡£æ˜¯æ–°åˆ›å»ºçš„ï¼ˆé€šè¿‡ <code class="language-plaintext highlighter-rouge">upsert</code>ï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">Updated</code>ï¼šæ–‡æ¡£å·²è¢«æˆåŠŸæ›´æ–°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">Deleted</code>ï¼šæ–‡æ¡£è¢«åˆ é™¤ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">NoOp</code>ï¼šæœªæ‰§è¡Œä»»ä½•æ“ä½œã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">NotFound</code>ï¼šæœªæ‰¾åˆ°æ–‡æ¡£ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">get</code> (<code class="language-plaintext highlighter-rouge">GetResult</code>)</strong>ï¼šå¦‚æœæ›´æ–°æ“ä½œåŒ…å« <code class="language-plaintext highlighter-rouge">fetchSource(true)</code>ï¼Œä¼šè¿”å› <code class="language-plaintext highlighter-rouge">GetResult</code> å¯¹è±¡ï¼Œæä¾›å…³äºæ–‡æ¡£å½“å‰çŠ¶æ€çš„è¯¦ç»†ä¿¡æ¯ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">source</span><span class="o">();</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Updated source: "</span> <span class="o">+</span> <span class="n">source</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="update"><code class="language-plaintext highlighter-rouge">update()</code></h4>

<p><code class="language-plaintext highlighter-rouge">update</code> API å…è®¸ä½ å¯¹å·²å­˜åœ¨çš„æ–‡æ¡£è¿›è¡Œéƒ¨åˆ†æ›´æ–°ï¼Œè€Œæ— éœ€æ›¿æ¢æ•´ä¸ªæ–‡æ¡£ã€‚</p>

<p>åœ¨ <strong>Elasticsearch 8.x Java Client</strong> ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">update()</code> æ–¹æ³•æœ‰å¤šä¸ªå˜ä½“ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„æ„é€ æ–¹å¼æ¥æ‰§è¡Œæ–‡æ¡£æ›´æ–°æ“ä½œã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">update()</code> æ–¹æ³•çš„åŸºæœ¬å˜ä½“</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">,</span> <span class="nc">TPartialDocument</span><span class="o">&gt;</span> <span class="nc">UpdateResponse</span><span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">&gt;</span> <span class="nf">update</span><span class="o">(</span>
        <span class="nc">UpdateRequest</span><span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">,</span> <span class="nc">TPartialDocument</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">&gt;</span> <span class="n">tDocumentClass</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ElasticsearchException</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>åŠŸèƒ½</strong>ï¼šæ­¤æ–¹æ³•æ¥å—ä¸€ä¸ª <strong><code class="language-plaintext highlighter-rouge">UpdateRequest</code></strong> å¯¹è±¡å’Œç›®æ ‡æ–‡æ¡£çš„ <strong><code class="language-plaintext highlighter-rouge">Class</code></strong> ç±»å‹ï¼ˆç”¨äºæŒ‡å®šè¿”å›çš„æ–‡æ¡£ç±»å‹ï¼‰ï¼Œç„¶åæ‰§è¡Œæ›´æ–°æ“ä½œã€‚</p>

<p><strong>å‚æ•°</strong>ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">UpdateRequest&lt;TDocument, TPartialDocument&gt; request</code>ï¼šåŒ…å«æ›´æ–°æ“ä½œè¯¦ç»†ä¿¡æ¯çš„è¯·æ±‚å¯¹è±¡ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">Class&lt;TDocument&gt; tDocumentClass</code>ï¼šè¿”å›ç»“æœæ–‡æ¡£çš„ç±»å‹ï¼Œé€šå¸¸æ˜¯ä½ çš„å®ä½“ç±»ã€‚</li>
</ul>

<p>æ­¤æ–¹æ³•ç›´æ¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">transport.performRequest()</code> æ‰§è¡Œè¯·æ±‚ï¼Œæ‰§è¡Œä¸€ä¸ªåŒæ­¥çš„æ–‡æ¡£æ›´æ–°æ“ä½œã€‚</p>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">update()</code> æ–¹æ³•çš„æ„å»ºå™¨å˜ä½“</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">,</span> <span class="nc">TPartialDocument</span><span class="o">&gt;</span> <span class="nc">UpdateResponse</span><span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">&gt;</span> <span class="nf">update</span><span class="o">(</span>
        <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">,</span> <span class="nc">TPartialDocument</span><span class="o">&gt;,</span> <span class="nc">ObjectBuilder</span><span class="o">&lt;</span><span class="nc">UpdateRequest</span><span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">,</span> <span class="nc">TPartialDocument</span><span class="o">&gt;&gt;&gt;</span> <span class="n">fn</span><span class="o">,</span>
        <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">&gt;</span> <span class="n">tDocumentClass</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ElasticsearchException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">update</span><span class="o">(</span><span class="n">fn</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="k">new</span> <span class="nc">UpdateRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">TDocument</span><span class="o">,</span> <span class="nc">TPartialDocument</span><span class="o">&gt;()).</span><span class="na">build</span><span class="o">(),</span> <span class="n">tDocumentClass</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>åŠŸèƒ½</strong>ï¼šæ­¤å˜ä½“ä½¿ç”¨äº†æ„å»ºå™¨æ¨¡å¼ã€‚é€šè¿‡ä¸€ä¸ªå‡½æ•° <code class="language-plaintext highlighter-rouge">fn</code>ï¼Œä½ å¯ä»¥é…ç½®ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">UpdateRequest</code> å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ <code class="language-plaintext highlighter-rouge">update()</code> æ‰§è¡Œè¯·æ±‚ã€‚</p>

<p><strong>å‚æ•°</strong>ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">fn</code>ï¼šä¸€ä¸ªæ¥å— <code class="language-plaintext highlighter-rouge">UpdateRequest.Builder</code> çš„å‡½æ•°ï¼Œæ„é€ ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">UpdateRequest</code> å¯¹è±¡ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">Class&lt;TDocument&gt; tDocumentClass</code>ï¼šè¿”å›ç»“æœæ–‡æ¡£çš„ç±»å‹ã€‚</li>
</ul>

<p>æ­¤æ–¹æ³•çš„ä¼˜åŠ¿æ˜¯å¯ä»¥é€šè¿‡ Lambda è¡¨è¾¾å¼å¿«é€Ÿæ„å»ºè¯·æ±‚å¯¹è±¡ï¼Œé¿å…æ˜¾å¼åœ°åˆ›å»ºè¯·æ±‚å¯¹è±¡ã€‚</p>

<p><strong>ç¤ºä¾‹</strong>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateResponse</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">update</span><span class="o">(</span>
    <span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">).</span><span class="na">script</span><span class="o">(</span><span class="n">script</span><span class="o">).</span><span class="na">refresh</span><span class="o">(</span><span class="nc">Refresh</span><span class="o">.</span><span class="na">True</span><span class="o">),</span> 
    <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">updateByQuery()</code> æ–¹æ³•å˜ä½“</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">UpdateByQueryResponse</span> <span class="nf">updateByQuery</span><span class="o">(</span><span class="nc">UpdateByQueryRequest</span> <span class="n">request</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ElasticsearchException</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><strong>åŠŸèƒ½</strong>
æ‰§è¡Œä¸€ä¸ªæ›´æ–°æŸ¥è¯¢æ“ä½œï¼Œæ›´æ–°ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰æ–‡æ¡£ï¼Œè€Œä¸ç›´æ¥æ”¹å˜æºæ–‡æ¡£çš„å†…å®¹ï¼ˆå¦‚åº”ç”¨æ˜ å°„æ›´æ”¹ï¼‰ã€‚é€šå¸¸ç”¨äºæ‰¹é‡æ›´æ–°ã€‚
<strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">UpdateByQueryRequest request</code>ï¼šåŒ…å«æ›´æ–°æŸ¥è¯¢æ“ä½œçš„è¯·æ±‚å¯¹è±¡ã€‚</li>
</ul>

<p>è¯¥æ–¹æ³•æ‰§è¡Œä¸€ä¸ªåŒæ­¥çš„æ›´æ–°æ“ä½œï¼Œæ›´æ–°ç´¢å¼•ä¸­çš„å¤šä¸ªæ–‡æ¡£ã€‚</p>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">updateByQuery()</code> æ–¹æ³•çš„æ„å»ºå™¨å˜ä½“</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="nc">UpdateByQueryResponse</span> <span class="nf">updateByQuery</span><span class="o">(</span>
        <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">UpdateByQueryRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="nc">ObjectBuilder</span><span class="o">&lt;</span><span class="nc">UpdateByQueryRequest</span><span class="o">&gt;&gt;</span> <span class="n">fn</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ElasticsearchException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">updateByQuery</span><span class="o">(</span><span class="n">fn</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="k">new</span> <span class="nc">UpdateByQueryRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">()).</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>åŠŸèƒ½</strong>ï¼šè¯¥å˜ä½“å…è®¸ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼é…ç½®ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">UpdateByQueryRequest</code> å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œæ›´æ–°æŸ¥è¯¢æ“ä½œã€‚
<strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">fn</code>ï¼šä¸€ä¸ªæ¥å— <code class="language-plaintext highlighter-rouge">UpdateByQueryRequest.Builder</code> çš„å‡½æ•°ï¼Œæ„é€  <code class="language-plaintext highlighter-rouge">UpdateByQueryRequest</code> å¯¹è±¡ã€‚</p>

<p>é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œä½ å¯ä»¥æ›´çµæ´»åœ°æ„å»ºè¯·æ±‚å‚æ•°ï¼Œé€‚ç”¨äºå¤æ‚çš„æŸ¥è¯¢å’Œæ‰¹é‡æ›´æ–°æ“ä½œã€‚</p>

<p><strong>ç¤ºä¾‹</strong>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateByQueryResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">updateByQuery</span><span class="o">(</span>
    <span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">matchAll</span><span class="o">()).</span><span class="na">script</span><span class="o">(</span><span class="n">script</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">updateByQueryRethrottle()</code> æ–¹æ³•</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">UpdateByQueryRethrottleResponse</span> <span class="nf">updateByQueryRethrottle</span><span class="o">(</span><span class="nc">UpdateByQueryRethrottleRequest</span> <span class="n">request</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ElasticsearchException</span> <span class="o">{</span>
    <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>åŠŸèƒ½</strong>ï¼šç”¨äºæ›´æ”¹ <code class="language-plaintext highlighter-rouge">UpdateByQuery</code> æ“ä½œçš„è¯·æ±‚é¢‘ç‡ï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰ã€‚å¦‚æœä½ æƒ³æ§åˆ¶æŸ¥è¯¢æ“ä½œçš„é€Ÿç‡ï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚
<strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">UpdateByQueryRethrottleRequest request</code>ï¼šè¯·æ±‚å¯¹è±¡ï¼ŒæŒ‡å®šéœ€è¦æ›´æ”¹é€Ÿç‡çš„ <code class="language-plaintext highlighter-rouge">UpdateByQuery</code> æ“ä½œã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">updateByQueryRethrottle()</code> æ–¹æ³•çš„æ„å»ºå™¨å˜ä½“</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="nc">UpdateByQueryRethrottleResponse</span> <span class="nf">updateByQueryRethrottle</span><span class="o">(</span>
        <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">UpdateByQueryRethrottleRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="nc">ObjectBuilder</span><span class="o">&lt;</span><span class="nc">UpdateByQueryRethrottleRequest</span><span class="o">&gt;&gt;</span> <span class="n">fn</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ElasticsearchException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">updateByQueryRethrottle</span><span class="o">(</span><span class="n">fn</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="k">new</span> <span class="nc">UpdateByQueryRethrottleRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">()).</span><span class="na">build</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>åŠŸèƒ½</strong>ï¼šè¯¥å˜ä½“ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼æ„é€ ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">UpdateByQueryRethrottleRequest</code> å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œé‡æ–°è°ƒæ•´è¯·æ±‚é¢‘ç‡çš„æ“ä½œã€‚</p>

<p>æ€»ç»“</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">update()</code></strong>ï¼šç”¨äºå•ä¸ªæ–‡æ¡£çš„æ›´æ–°æ“ä½œï¼Œæ”¯æŒ <code class="language-plaintext highlighter-rouge">script</code>ã€<code class="language-plaintext highlighter-rouge">doc</code> ç­‰å­—æ®µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">updateByQuery()</code></strong>ï¼šç”¨äºæ ¹æ®æŸ¥è¯¢æ¡ä»¶æ‰¹é‡æ›´æ–°å¤šä¸ªæ–‡æ¡£ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">updateByQueryRethrottle()</code></strong>ï¼šç”¨äºæ§åˆ¶ <code class="language-plaintext highlighter-rouge">update_by_query</code> æ“ä½œçš„é€Ÿç‡ã€‚</li>
</ul>

<p>æ‰€æœ‰è¿™äº›æ–¹æ³•çš„å˜ä½“éƒ½å¯ä»¥é€šè¿‡æ„å»ºå™¨æ¨¡å¼æˆ–å‡½æ•°å¼ç¼–ç¨‹æ¥é…ç½®è¯·æ±‚ï¼Œæä¾›äº†çµæ´»çš„ API ä½¿å¾—ä½ å¯ä»¥æ ¹æ®éœ€æ±‚æ„é€ æ›´æ–°æ“ä½œã€‚</p>

<h4 id="sourceconfig"><code class="language-plaintext highlighter-rouge">SourceConfig</code></h4>

<p><code class="language-plaintext highlighter-rouge">SourceConfig</code> æ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰å¦‚ä½•è·å–æ–‡æ¡£ <code class="language-plaintext highlighter-rouge">_source</code> æ•°æ®çš„ç±»ã€‚å®ƒæœ‰ä¸¤ç§ä¸»è¦çš„é…ç½®æ–¹å¼ï¼š<code class="language-plaintext highlighter-rouge">Filter</code> å’Œ <code class="language-plaintext highlighter-rouge">Fetch</code>ï¼Œè¿™ä¸¤ç§æ–¹å¼å¯ä»¥å†³å®šæ˜¯å®Œå…¨æ£€ç´¢ <code class="language-plaintext highlighter-rouge">_source</code>ï¼Œè¿˜æ˜¯æ ¹æ®è¿‡æ»¤æ¡ä»¶æ¥è·å– <code class="language-plaintext highlighter-rouge">_source</code>ã€‚</p>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">filter</code> ç±»å‹çš„ <code class="language-plaintext highlighter-rouge">SourceConfig</code></strong>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SourceConfig</span> <span class="n">sourceConfig</span> <span class="o">=</span> <span class="nc">SourceConfig</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
  <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span>
      <span class="n">f</span><span class="o">-&gt;</span><span class="n">f</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">excludes</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span>
  <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">fetch</code> ç±»å‹çš„ <code class="language-plaintext highlighter-rouge">SourceConfig</code></strong>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SourceConfig</span> <span class="n">sourceConfig</span> <span class="o">=</span> <span class="nc">SourceConfig</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
    <span class="o">.</span><span class="na">fetch</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<p><strong>æ€»ç»“</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">SourceConfig</code> ç”¨äºæ§åˆ¶å¦‚ä½•æ£€ç´¢æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_source</code> æ•°æ®ã€‚</li>
  <li>å®ƒæ”¯æŒä¸¤ç§ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Filter</code>ï¼ˆé€šè¿‡è¿‡æ»¤å­—æ®µæ¥æ£€ç´¢ï¼‰å’Œ <code class="language-plaintext highlighter-rouge">Fetch</code>ï¼ˆå®Œå…¨æ£€ç´¢ <code class="language-plaintext highlighter-rouge">_source</code> æ•°æ®ï¼‰ã€‚</li>
  <li>é€šè¿‡ <code class="language-plaintext highlighter-rouge">Builder</code> æ¨¡å¼ï¼Œæ‚¨å¯ä»¥æ–¹ä¾¿åœ°æ„å»º <code class="language-plaintext highlighter-rouge">SourceConfig</code> å®ä¾‹ï¼Œå¹¶åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å®ƒã€‚</li>
</ul>

<h4 id="sourcefilter"><code class="language-plaintext highlighter-rouge">SourceFilter</code></h4>

<p><code class="language-plaintext highlighter-rouge">SourceFilter.Builder</code> æ˜¯ç”¨äºæ„å»º <code class="language-plaintext highlighter-rouge">SourceFilter</code> å®ä¾‹çš„ç±»ã€‚å®ƒå…è®¸æ‚¨åŠ¨æ€åœ°è®¾ç½®å“ªäº›å­—æ®µåº”è¯¥è¢«åŒ…å«æˆ–æ’é™¤åœ¨ <code class="language-plaintext highlighter-rouge">_source</code> å­—æ®µä¸­ï¼Œå¹¶ä¸”æä¾›äº†å¤šç§æ–¹æ³•æ¥æ·»åŠ åŒ…å«æˆ–æ’é™¤çš„å­—æ®µã€‚</p>

<p><strong>å…³é”®å­—æ®µï¼š</strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">includes</code>: è¿™ä¸ªå­—æ®µä¿å­˜äº†éœ€è¦åŒ…å«åœ¨ <code class="language-plaintext highlighter-rouge">_source</code> ä¸­çš„å­—æ®µååˆ—è¡¨ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">excludes</code>: è¿™ä¸ªå­—æ®µä¿å­˜äº†éœ€è¦æ’é™¤åœ¨ <code class="language-plaintext highlighter-rouge">_source</code> ä¸­çš„å­—æ®µååˆ—è¡¨ã€‚</li>
</ul>

<p><strong>å…³é”®æ–¹æ³•ï¼š</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">excludes(List&lt;String&gt; list)</code></strong></p>
<ul>
  <li>è¿™ä¸ªæ–¹æ³•å…è®¸æ‚¨å°†ä¸€ä¸ªå­—æ®µåˆ—è¡¨æ·»åŠ åˆ°æ’é™¤åˆ—è¡¨ <code class="language-plaintext highlighter-rouge">excludes</code> ä¸­ã€‚</li>
  <li><strong>å‚æ•°</strong>ï¼šä¸€ä¸ªåŒ…å«å­—æ®µåçš„ <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code>ã€‚</li>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">Builder</code> å¯¹è±¡ï¼Œå…è®¸é“¾å¼è°ƒç”¨ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">builder</span><span class="o">.</span><span class="na">excludes</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"field1"</span><span class="o">,</span> <span class="s">"field2"</span><span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">excludes(String value, String... values)</code></strong></p>
<ul>
  <li>è¿™ä¸ªæ–¹æ³•å…è®¸æ‚¨å°†ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µåæ·»åŠ åˆ°æ’é™¤åˆ—è¡¨ <code class="language-plaintext highlighter-rouge">excludes</code> ä¸­ã€‚</li>
  <li><strong>å‚æ•°</strong>ï¼šä¸€ä¸ªå­—æ®µåæˆ–å¤šä¸ªå­—æ®µåä½œä¸ºå‚æ•°ã€‚</li>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">Builder</code> å¯¹è±¡ï¼Œå…è®¸é“¾å¼è°ƒç”¨ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">excludes</span><span class="o">(</span><span class="s">"field1"</span><span class="o">,</span> <span class="s">"field2"</span><span class="o">,</span> <span class="s">"field3"</span><span class="o">);</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">includes(List&lt;String&gt; list)</code></strong></p>
<ul>
  <li>è¿™ä¸ªæ–¹æ³•å…è®¸æ‚¨å°†ä¸€ä¸ªå­—æ®µåˆ—è¡¨æ·»åŠ åˆ°åŒ…å«åˆ—è¡¨ <code class="language-plaintext highlighter-rouge">includes</code> ä¸­ã€‚</li>
  <li><strong>å‚æ•°</strong>ï¼šä¸€ä¸ªåŒ…å«å­—æ®µåçš„ <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code>ã€‚</li>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">Builder</code> å¯¹è±¡ï¼Œå…è®¸é“¾å¼è°ƒç”¨ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"field1"</span><span class="o">,</span> <span class="s">"field2"</span><span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">includes(String value, String... values)</code></strong></p>
<ul>
  <li>è¿™ä¸ªæ–¹æ³•å…è®¸æ‚¨å°†ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µåæ·»åŠ åˆ°åŒ…å«åˆ—è¡¨ <code class="language-plaintext highlighter-rouge">includes</code> ä¸­ã€‚</li>
  <li><strong>å‚æ•°</strong>ï¼šä¸€ä¸ªå­—æ®µåæˆ–å¤šä¸ªå­—æ®µåä½œä¸ºå‚æ•°ã€‚</li>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">Builder</code> å¯¹è±¡ï¼Œå…è®¸é“¾å¼è°ƒç”¨ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="s">"field1"</span><span class="o">,</span> <span class="s">"field2"</span><span class="o">,</span> <span class="s">"field3"</span><span class="o">);</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">self()</code></strong>ï¼šè¿™ä¸ªæ–¹æ³•æ˜¯ç»§æ‰¿è‡ª <code class="language-plaintext highlighter-rouge">WithJsonObjectBuilderBase</code> çš„ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œå®ƒè¿”å›å½“å‰çš„ <code class="language-plaintext highlighter-rouge">Builder</code> å®ä¾‹ã€‚ç”¨äºæ”¯æŒé“¾å¼è°ƒç”¨ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">build()</code></strong>ï¼šæ„å»ºå¹¶è¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">SourceFilter</code> å¯¹è±¡ã€‚å¦‚æœä¸€äº›å¿…è¦å­—æ®µä¸º <code class="language-plaintext highlighter-rouge">null</code>ï¼Œåˆ™ä¼šæŠ›å‡º <code class="language-plaintext highlighter-rouge">NullPointerException</code>ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SourceFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p>ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">SourceFilter.Builder</code> æ¥åˆ›å»ºä¸€ä¸ª <code class="language-plaintext highlighter-rouge">SourceFilter</code> å®ä¾‹çš„ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SourceFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SourceFilter</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="s">"field1"</span><span class="o">,</span> <span class="s">"field2"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">excludes</span><span class="o">(</span><span class="s">"field3"</span><span class="o">,</span> <span class="s">"field4"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p>æ›´ç®€æ´çš„æ–¹å¼ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SourceConfig</span> <span class="n">sourceConfig</span> <span class="o">=</span> <span class="nc">SourceConfig</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">f</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">excludes</span><span class="o">(</span><span class="s">"age"</span><span class="o">)));</span>
</code></pre></div></div>

<h4 id="script"><code class="language-plaintext highlighter-rouge">Script</code></h4>

<p><code class="language-plaintext highlighter-rouge">Script</code> ç±»ç”¨äºè¡¨ç¤º Elasticsearch ä¸­çš„è„šæœ¬ï¼Œæ”¯æŒä¸¤ç§ä¸»è¦çš„è„šæœ¬ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Inline</code> å’Œ <code class="language-plaintext highlighter-rouge">Stored</code>ã€‚å®ƒæ˜¯ä¸€ä¸ªæ ‡ç­¾è”åˆç±»ï¼ˆ<code class="language-plaintext highlighter-rouge">TaggedUnion</code>ï¼‰ï¼Œæ„å‘³ç€å®ƒå¯ä»¥åœ¨ä¸åŒç±»å‹çš„å˜ä½“ä¹‹é—´åˆ‡æ¢ã€‚</p>

<p><strong>å­—æ®µ</strong>:</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">_kind</code></strong>ï¼šè¡¨ç¤ºå½“å‰è„šæœ¬çš„ç±»å‹ï¼Œå¯èƒ½çš„å€¼ä¸º <code class="language-plaintext highlighter-rouge">Inline</code> æˆ– <code class="language-plaintext highlighter-rouge">Stored</code>ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">_value</code></strong>ï¼šå­˜å‚¨å½“å‰è„šæœ¬çš„å®é™…å†…å®¹ã€‚å…·ä½“å†…å®¹æ ¹æ® <code class="language-plaintext highlighter-rouge">_kind</code> çš„å€¼è€Œå®šã€‚å¦‚æœ <code class="language-plaintext highlighter-rouge">_kind</code> æ˜¯ <code class="language-plaintext highlighter-rouge">Inline</code>ï¼Œåˆ™ <code class="language-plaintext highlighter-rouge">value</code> æ˜¯ <code class="language-plaintext highlighter-rouge">InlineScript</code> ç±»å‹ï¼›å¦‚æœ <code class="language-plaintext highlighter-rouge">_kind</code> æ˜¯ <code class="language-plaintext highlighter-rouge">Stored</code>ï¼Œåˆ™ <code class="language-plaintext highlighter-rouge">value</code> æ˜¯ <code class="language-plaintext highlighter-rouge">StoredScriptId</code> ç±»å‹ã€‚</li>
</ul>

<p><strong>æ–¹æ³•</strong>:</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">_kind()</code></strong>: è¿”å›è„šæœ¬çš„ç±»å‹ï¼ˆ<code class="language-plaintext highlighter-rouge">Inline</code> æˆ– <code class="language-plaintext highlighter-rouge">Stored</code>ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">_get()</code></strong>: è·å–è„šæœ¬çš„å®é™…å†…å®¹ï¼ˆ<code class="language-plaintext highlighter-rouge">InlineScript</code> æˆ– <code class="language-plaintext highlighter-rouge">StoredScriptId</code>ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">isInline()</code></strong>: åˆ¤æ–­å½“å‰è„šæœ¬æ˜¯å¦ä¸º <code class="language-plaintext highlighter-rouge">Inline</code> ç±»å‹ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">inline()</code></strong>: è·å– <code class="language-plaintext highlighter-rouge">Inline</code> ç±»å‹çš„è„šæœ¬å†…å®¹ã€‚è‹¥å½“å‰è„šæœ¬ä¸æ˜¯ <code class="language-plaintext highlighter-rouge">Inline</code> ç±»å‹ï¼Œå°†æŠ›å‡ºå¼‚å¸¸ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">isStored()</code></strong>: åˆ¤æ–­å½“å‰è„šæœ¬æ˜¯å¦ä¸º <code class="language-plaintext highlighter-rouge">Stored</code> ç±»å‹ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">stored()</code></strong>: è·å– <code class="language-plaintext highlighter-rouge">Stored</code> ç±»å‹çš„è„šæœ¬å†…å®¹ã€‚è‹¥å½“å‰è„šæœ¬ä¸æ˜¯ <code class="language-plaintext highlighter-rouge">Stored</code> ç±»å‹ï¼Œå°†æŠ›å‡ºå¼‚å¸¸ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">serialize()</code></strong>: å°†è„šæœ¬å¯¹è±¡åºåˆ—åŒ–ä¸º JSON æ ¼å¼ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">toString()</code></strong>: è¿”å›è„šæœ¬çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œé€šå¸¸ä¸º JSON æ ¼å¼ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">Builder</code> ç±»</strong>:</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">inline(InlineScript v)</code></strong>: è®¾ç½®è„šæœ¬ä¸º <code class="language-plaintext highlighter-rouge">Inline</code> ç±»å‹ï¼Œå¹¶ä¼ å…¥ <code class="language-plaintext highlighter-rouge">InlineScript</code> å¯¹è±¡ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">inline(Function&lt;InlineScript.Builder, ObjectBuilder&lt;InlineScript&gt;&gt; fn)</code></strong>: ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼åˆ›å»º <code class="language-plaintext highlighter-rouge">InlineScript</code> å¯¹è±¡ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">stored(StoredScriptId v)</code></strong>: è®¾ç½®è„šæœ¬ä¸º <code class="language-plaintext highlighter-rouge">Stored</code> ç±»å‹ï¼Œå¹¶ä¼ å…¥ <code class="language-plaintext highlighter-rouge">StoredScriptId</code> å¯¹è±¡ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">stored(Function&lt;StoredScriptId.Builder, ObjectBuilder&lt;StoredScriptId&gt;&gt; fn)</code></strong>: ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼åˆ›å»º <code class="language-plaintext highlighter-rouge">StoredScriptId</code> å¯¹è±¡ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">build()</code></strong>: æ„å»º <code class="language-plaintext highlighter-rouge">Script</code> å¯¹è±¡ã€‚</li>
</ul>

<p><strong>å¢é‡æ›´æ–°ç¤ºä¾‹</strong>:
å‡è®¾ä½ éœ€è¦å¢é‡æ›´æ–°ä¸€ä¸ª Elasticsearch æ–‡æ¡£æ—¶ä½¿ç”¨è„šæœ¬ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•æ„å»ºä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Script</code> å¯¹è±¡ï¼Œæ‰§è¡Œå¢é‡æ›´æ–°çš„ç¤ºä¾‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å‡è®¾æœ‰ä¸€ä¸ªå­—æ®µ "v"ï¼Œæˆ‘ä»¬è¦å°†å®ƒçš„å€¼å¢åŠ  1ã€‚</span>
<span class="nc">Script</span> <span class="n">script</span> <span class="o">=</span> <span class="nc">Script</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
        <span class="o">.</span><span class="na">inline</span><span class="o">(</span><span class="n">inlineScriptBuilder</span> <span class="o">-&gt;</span> <span class="n">inlineScriptBuilder</span>
                <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"ctx._source.v += params.increment"</span><span class="o">)</span> <span class="c1">// inline è„šæœ¬</span>
                <span class="o">.</span><span class="na">params</span><span class="o">(</span><span class="s">"increment"</span><span class="o">,</span>  <span class="nc">JsonData</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="c1">// ä¼ é€’å‚æ•°</span>
        <span class="o">)</span>
<span class="o">);</span>
<span class="nc">UpdateResponse</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">updateResponse2</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span>
                <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">script</span><span class="o">(</span><span class="n">script</span><span class="o">)</span>
                <span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="nc">Refresh</span><span class="o">.</span><span class="na">True</span><span class="o">)</span>
        <span class="o">,</span><span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updateResponse2</span><span class="o">.</span><span class="na">result</span><span class="o">());</span>
</code></pre></div></div>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">Inline</code> è„šæœ¬æ¥å¢é‡æ›´æ–° <code class="language-plaintext highlighter-rouge">counter</code> å­—æ®µï¼Œè„šæœ¬å†…å®¹æ˜¯ <code class="language-plaintext highlighter-rouge">ctx._source.v += params.increment</code>ï¼Œå®ƒè¡¨ç¤ºå°† <code class="language-plaintext highlighter-rouge">counter</code> å­—æ®µçš„å€¼å¢åŠ  <code class="language-plaintext highlighter-rouge">increment</code> å‚æ•°çš„å€¼ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">params</code></strong>: å¢é‡æ›´æ–°éœ€è¦ä¼ é€’å‚æ•°ã€‚åœ¨è„šæœ¬ä¸­é€šè¿‡ <code class="language-plaintext highlighter-rouge">params.increment</code> å¼•ç”¨äº†è¿™ä¸ªå‚æ•°ï¼Œå¹¶åœ¨æ„å»ºè„šæœ¬æ—¶ä¼ é€’äº†å®é™…å€¼ <code class="language-plaintext highlighter-rouge">1</code>ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">UpdateRequest</code></strong>: æ„å»ºäº†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">UpdateRequest</code> å¯¹è±¡ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Script</code> æ‰§è¡Œå¢é‡æ›´æ–°ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Script</code> ç±»ç”¨äºå°è£… Elasticsearch çš„è„šæœ¬æ“ä½œï¼Œæ”¯æŒ <code class="language-plaintext highlighter-rouge">Inline</code> å’Œ <code class="language-plaintext highlighter-rouge">Stored</code> ä¸¤ç§ç±»å‹çš„è„šæœ¬ã€‚é€šè¿‡æ„å»ºå™¨æ¨¡å¼ï¼Œå¯ä»¥åŠ¨æ€åœ°è®¾ç½®è„šæœ¬å†…å®¹å¹¶æ‰§è¡Œæ“ä½œã€‚åœ¨å¢é‡æ›´æ–°åœºæ™¯ä¸­ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">InlineScript</code> ç±»å‹çš„è„šæœ¬ç»“åˆä¼ é€’å‚æ•°çš„æ–¹å¼å®ç°å­—æ®µå€¼çš„å¢é‡æ›´æ–°ã€‚</p>

<p>åœ¨ Java ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">Script</code> ç±»ç”¨äºä¸ Elasticsearch ä¸­çš„è„šæœ¬äº¤äº’ï¼Œå…è®¸ä½ åœ¨æŸ¥è¯¢ã€èšåˆã€æ›´æ–°ç­‰æ“ä½œä¸­ä½¿ç”¨è‡ªå®šä¹‰çš„è„šæœ¬ã€‚<code class="language-plaintext highlighter-rouge">Script</code> ç±»æ”¯æŒå¤šç§è„šæœ¬è¯­è¨€ï¼Œå…¶ä¸­ <code class="language-plaintext highlighter-rouge">Painless</code> æ˜¯é»˜è®¤å’Œæ¨èçš„è„šæœ¬è¯­è¨€ã€‚ä¸‹é¢ç®€è¦ä»‹ç»å¸¸ç”¨çš„è„šæœ¬è¯­æ³•åŠå…¶ç‰¹æ®Šå˜é‡ï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">params</code>ã€<code class="language-plaintext highlighter-rouge">ctx._source</code> ç­‰ã€‚</p>

<p><strong>è„šæœ¬ç±»å‹ï¼ˆScriptTypeï¼‰</strong></p>

<p><code class="language-plaintext highlighter-rouge">Script</code> ç±»æ”¯æŒä¸¤ç§ç±»å‹çš„è„šæœ¬ï¼š</p>
<ul>
  <li><strong>INLINE</strong>ï¼šç›´æ¥åœ¨æŸ¥è¯¢æˆ–æ“ä½œä¸­å†…è”å®šä¹‰è„šæœ¬ä»£ç ã€‚</li>
  <li><strong>STORED</strong>ï¼šä»å·²å­˜å‚¨çš„è„šæœ¬ä¸­åŠ è½½è„šæœ¬ï¼ˆé€šå¸¸æ˜¯é¢„å…ˆå®šä¹‰å¹¶å­˜å‚¨åœ¨ Elasticsearch ä¸­çš„è„šæœ¬ï¼‰ã€‚</li>
</ul>

<p><strong>ç‰¹æ®Šå˜é‡</strong></p>

<p>åœ¨ Painless è„šæœ¬ä¸­ï¼Œæœ‰å‡ ä¸ªå…³é”®çš„ç‰¹æ®Šå˜é‡ç”¨äºè®¿é—®æ–‡æ¡£æ•°æ®ã€æŸ¥è¯¢å‚æ•°ç­‰å†…å®¹ã€‚å¸¸è§çš„ç‰¹æ®Šå˜é‡æœ‰ <code class="language-plaintext highlighter-rouge">doc</code>ã€<code class="language-plaintext highlighter-rouge">params</code> å’Œ <code class="language-plaintext highlighter-rouge">ctx</code>ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">doc</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">doc</code> æ˜¯ä¸€ä¸ªç”¨äºè®¿é—®æ–‡æ¡£å­—æ®µçš„ç‰¹æ®Šå˜é‡ã€‚å®ƒå…è®¸åœ¨è„šæœ¬ä¸­è®¿é—®æ–‡æ¡£ä¸­çš„å­—æ®µå€¼ï¼Œé€šå¸¸ç”¨äºè·å–æ•°å€¼ã€æ—¥æœŸæˆ–æ–‡æœ¬å­—æ®µçš„å†…å®¹ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">doc['field_name'].value</code>ï¼šè·å–å­—æ®µçš„å€¼ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">doc['field_name'].size()</code>ï¼šè·å–å­—æ®µçš„æ•°ç»„å¤§å°ã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-painless">return doc['price'].value * 1.2;
</code></pre>
<p>è¿™ä¸ªè„šæœ¬è¿”å›å­—æ®µ <code class="language-plaintext highlighter-rouge">price</code> çš„å€¼ä¹˜ä»¥ 1.2ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">params</code></strong>
<code class="language-plaintext highlighter-rouge">params</code> æ˜¯ä¸€ä¸ªç”¨äºä¼ é€’è„šæœ¬å‚æ•°çš„ç‰¹æ®Šå˜é‡ã€‚å®ƒå…è®¸å°†å¤–éƒ¨å‚æ•°ä¼ é€’ç»™è„šæœ¬ï¼Œä»è€Œä½¿è„šæœ¬æ›´åŠ çµæ´»å’ŒåŠ¨æ€ã€‚<code class="language-plaintext highlighter-rouge">params</code> æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>ï¼Œå…¶ä¸­å¯ä»¥å­˜å‚¨å¤šä¸ªé”®å€¼å¯¹ã€‚</p>

<ul>
  <li>é€šè¿‡ <code class="language-plaintext highlighter-rouge">params['param_name']</code> è®¿é—®ä¼ å…¥çš„å‚æ•°ã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å‡è®¾æœ‰ä¸€ä¸ªå­—æ®µ "v"ï¼Œæˆ‘ä»¬è¦å°†å®ƒçš„å€¼å¢åŠ  1ã€‚</span>
<span class="nc">Script</span> <span class="n">script</span> <span class="o">=</span> <span class="nc">Script</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
        <span class="o">.</span><span class="na">inline</span><span class="o">(</span><span class="n">inlineScriptBuilder</span> <span class="o">-&gt;</span> <span class="n">inlineScriptBuilder</span>
                <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"ctx._source.v += params.increment"</span><span class="o">)</span> <span class="c1">// inline è„šæœ¬</span>
                <span class="o">.</span><span class="na">params</span><span class="o">(</span><span class="s">"increment"</span><span class="o">,</span>  <span class="nc">JsonData</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="c1">// ä¼ é€’å‚æ•°</span>
        <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>
<p>è¿™é‡Œå°†å‚æ•° <code class="language-plaintext highlighter-rouge">1</code> ä¼ é€’ç»™è„šæœ¬ï¼Œåœ¨è„šæœ¬ä¸­é€šè¿‡ <code class="language-plaintext highlighter-rouge">params.increment</code> ä½¿ç”¨è¯¥å€¼ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">ctx._source</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">ctx._source</code> æ˜¯ç”¨äºåœ¨æ›´æ–°è„šæœ¬ä¸­è®¿é—®å’Œä¿®æ”¹æ–‡æ¡£æºçš„ç‰¹æ®Šå˜é‡ã€‚å®ƒä»£è¡¨å½“å‰æ–‡æ¡£çš„å®Œæ•´æºå†…å®¹ï¼ˆå³ <code class="language-plaintext highlighter-rouge">_source</code> å­—æ®µï¼‰ï¼Œå¹¶å…è®¸è„šæœ¬åœ¨æ›´æ–°æ—¶ä¿®æ”¹æ–‡æ¡£çš„æ•°æ®ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ctx._source['field_name']</code>ï¼šè·å–æˆ–ä¿®æ”¹æ–‡æ¡£å­—æ®µçš„å€¼ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">ctx._source.remove('field_name')</code>ï¼šä»æ–‡æ¡£ä¸­åˆ é™¤å­—æ®µã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å‡è®¾æœ‰ä¸€ä¸ªå­—æ®µ "v"ï¼Œæˆ‘ä»¬è¦å°†å®ƒçš„å€¼å¢åŠ  1ã€‚</span>
<span class="nc">Script</span> <span class="n">script</span> <span class="o">=</span> <span class="nc">Script</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
        <span class="o">.</span><span class="na">inline</span><span class="o">(</span><span class="n">inlineScriptBuilder</span> <span class="o">-&gt;</span> <span class="n">inlineScriptBuilder</span>
                <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"ctx._source.v += params.increment"</span><span class="o">)</span> <span class="c1">// inline è„šæœ¬</span>
                <span class="o">.</span><span class="na">params</span><span class="o">(</span><span class="s">"increment"</span><span class="o">,</span>  <span class="nc">JsonData</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="c1">// ä¼ é€’å‚æ•°</span>
        <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>
<p>è¿™ä¸ªè„šæœ¬å°†æ–‡æ¡£å­—æ®µ <code class="language-plaintext highlighter-rouge">v</code> çš„å€¼å¢åŠ  <code class="language-plaintext highlighter-rouge">1</code>ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">_score</code></strong>
<code class="language-plaintext highlighter-rouge">_score</code> æ˜¯ä¸€ä¸ªåœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ç”¨äºè·å–å½“å‰æ–‡æ¡£çš„è¯„åˆ†çš„ç‰¹æ®Šå˜é‡ã€‚å®ƒå¯ä»¥åœ¨è‡ªå®šä¹‰è¯„åˆ†è„šæœ¬ä¸­ä½¿ç”¨ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-painless">return _score * 2;  // å°†æ–‡æ¡£è¯„åˆ†åŠ å€
</code></pre>

<p><strong><code class="language-plaintext highlighter-rouge">_id</code></strong>
<code class="language-plaintext highlighter-rouge">_id</code> ç”¨äºè®¿é—®æ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre><code class="language-painless">return _id;  // è¿”å›æ–‡æ¡£çš„ID
</code></pre>

<p><strong>å¸¸è§è„šæœ¬è¯­æ³•</strong></p>

<p><strong>æ•°å­¦è¿ç®—</strong></p>

<p>æ”¯æŒå¸¸è§çš„æ•°å­¦è¿ç®—ï¼Œå¦‚åŠ æ³•ã€å‡æ³•ã€ä¹˜æ³•ã€é™¤æ³•ã€å–ä½™ç­‰ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre><code class="language-painless">return doc['price'].value * params.factor + params.offset;
</code></pre>

<p><strong>æ¡ä»¶è¯­å¥</strong></p>

<p>å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">if</code>ã€<code class="language-plaintext highlighter-rouge">else</code> è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre><code class="language-painless">if (doc['age'].value &gt; 30) {
    return 'Adult';
} else {
    return 'Youth';
}
</code></pre>

<p><strong>å­—ç¬¦ä¸²æ“ä½œ</strong>
æ”¯æŒå­—ç¬¦ä¸²æ‹¼æ¥ã€æˆªå–ã€æ›¿æ¢ç­‰æ“ä½œã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre><code class="language-painless">return doc['name'].value + ' - ' + doc['category'].value;
</code></pre>

<p><strong>æ•°ç»„æ“ä½œ</strong></p>

<p>æ”¯æŒæ“ä½œæ•°ç»„æˆ–åˆ—è¡¨ï¼Œå¦‚è·å–ç‰¹å®šç´¢å¼•çš„å€¼ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre><code class="language-painless">return params.myList[0];  // è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
</code></pre>

<p><strong>æ›´æ–°è„šæœ¬</strong>
åœ¨æ–‡æ¡£æ›´æ–°æ“ä½œä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">Script</code> ç±»é€šå¸¸ä¸ <code class="language-plaintext highlighter-rouge">ctx._source</code> ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¾¿åœ¨æ–‡æ¡£æ›´æ–°æ—¶ä¿®æ”¹å…¶å­—æ®µå€¼ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å‡è®¾æœ‰ä¸€ä¸ªå­—æ®µ "v"ï¼Œæˆ‘ä»¬è¦å°†å®ƒçš„å€¼å¢åŠ  1ã€‚</span>
<span class="nc">Script</span> <span class="n">script</span> <span class="o">=</span> <span class="nc">Script</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
        <span class="o">.</span><span class="na">inline</span><span class="o">(</span><span class="n">inlineScriptBuilder</span> <span class="o">-&gt;</span> <span class="n">inlineScriptBuilder</span>
                <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"ctx._source.v += params.increment"</span><span class="o">)</span> <span class="c1">// inline è„šæœ¬</span>
                <span class="o">.</span><span class="na">params</span><span class="o">(</span><span class="s">"increment"</span><span class="o">,</span>  <span class="nc">JsonData</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="c1">// ä¼ é€’å‚æ•°</span>
        <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>
<p>è¯¥è„šæœ¬å°†æ–‡æ¡£å­—æ®µ <code class="language-plaintext highlighter-rouge">v</code> çš„å€¼å¢åŠ  <code class="language-plaintext highlighter-rouge">1</code>ã€‚</p>

<p><strong>è„šæœ¬è¯„åˆ†</strong>
åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨è„šæœ¬è¿›è¡Œè¯„åˆ†æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">_score</code> å’Œå…¶ä»–æ–‡æ¡£å­—æ®µå¯ä»¥ä¸€èµ·å‚ä¸è¯„åˆ†è®¡ç®—ã€‚</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre><code class="language-painless">Math.log(doc['views'].value + 1) + _score
</code></pre>
<p>è¿™ä¸ªè„šæœ¬è®¡ç®—è¯„åˆ†æ—¶ç»“åˆäº† <code class="language-plaintext highlighter-rouge">views</code> å­—æ®µçš„å¯¹æ•°å€¼å’ŒåŸå§‹è¯„åˆ†ã€‚</p>

<p>æ€»ç»“
åœ¨ Elasticsearch ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">Script</code> ç±»é€šè¿‡ Painless è„šæœ¬è¯­è¨€å…è®¸åœ¨æŸ¥è¯¢ã€èšåˆã€æ›´æ–°ç­‰åœºæ™¯ä¸­æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚å¸¸ç”¨çš„ç‰¹æ®Šå˜é‡åŒ…æ‹¬ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">doc</code>ï¼šè®¿é—®æ–‡æ¡£å­—æ®µã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">params</code>ï¼šä¼ é€’å¤–éƒ¨å‚æ•°ç»™è„šæœ¬ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">ctx._source</code>ï¼šè®¿é—®å¹¶ä¿®æ”¹æ–‡æ¡£çš„æºå†…å®¹ï¼ˆç”¨äºæ›´æ–°æ“ä½œï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">_score</code>ï¼šè®¿é—®å½“å‰æ–‡æ¡£çš„è¯„åˆ†ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">_id</code>ï¼šè®¿é—®æ–‡æ¡£çš„ IDã€‚</li>
</ul>

<p>é€šè¿‡çµæ´»ä½¿ç”¨è¿™äº›å˜é‡å’Œ Painless è„šæœ¬è¯­æ³•ï¼Œå¯ä»¥å®ç°å¤æ‚çš„æ•°æ®å¤„ç†å’ŒæŸ¥è¯¢é€»è¾‘ã€‚</p>

<h3 id="æ¡ä»¶æ›´æ–°">æ¡ä»¶æ›´æ–°</h3>

<h4 id="updatebyquery"><code class="language-plaintext highlighter-rouge">updateByQuery</code></h4>

<p>åœ¨ Elasticsearch ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">updateByQuery</code> æ˜¯ä¸€ç§é€šè¿‡æŸ¥è¯¢æ›´æ–°å¤šä¸ªæ–‡æ¡£çš„æ–¹æ³•ã€‚ä¸ä¼ ç»Ÿçš„å•ä¸ªæ–‡æ¡£æ›´æ–° (<code class="language-plaintext highlighter-rouge">update</code>) ä¸åŒï¼Œ<code class="language-plaintext highlighter-rouge">updateByQuery</code> å…è®¸ä½ å¯¹ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„æ‰€æœ‰æ–‡æ¡£åº”ç”¨ä¸€ä¸ªæ›´æ–°è„šæœ¬ã€‚</p>

<p>ç¤ºä¾‹ä»£ç è§£æ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateByQueryResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">updateByQuery</span><span class="o">(</span>
    <span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
          <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">matchAll</span><span class="o">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">m</span><span class="o">))</span>
          <span class="o">.</span><span class="na">script</span><span class="o">(</span><span class="n">script</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼š</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">index("products")</code></strong>: æŒ‡å®šæ“ä½œçš„ç´¢å¼•ä¸º <code class="language-plaintext highlighter-rouge">"products"</code>ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">query(q -&gt; q.matchAll(m-&gt;m))</code></strong>: æŸ¥è¯¢æ¡ä»¶ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">matchAll</code>ï¼Œå³åŒ¹é…æ‰€æœ‰æ–‡æ¡£ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">script(script)</code></strong>: æ‰§è¡Œè„šæœ¬æ¥æ›´æ–°åŒ¹é…çš„æ–‡æ¡£ï¼Œ<code class="language-plaintext highlighter-rouge">script</code> æ˜¯ä¸€ä¸ªæ›´æ–°è„šæœ¬ï¼Œå®ƒå°†åº”ç”¨äºæ‰€æœ‰åŒ¹é…çš„æ–‡æ¡£ã€‚</li>
</ol>

<p>ä»£ç åŠŸèƒ½</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">updateByQuery</code></strong>: è¿™ä¸ªæ–¹æ³•æ‰§è¡Œä¸€ä¸ªåŸºäºæŸ¥è¯¢çš„æ‰¹é‡æ›´æ–°æ“ä½œï¼Œå…è®¸ä½ ä½¿ç”¨ä¸€ä¸ªæŸ¥è¯¢æ¡ä»¶ï¼ˆæ¯”å¦‚ <code class="language-plaintext highlighter-rouge">matchAll</code> æˆ–å…¶ä»–å¤æ‚æŸ¥è¯¢ï¼‰æ¥é€‰æ‹©æ–‡æ¡£ï¼Œç„¶åé€šè¿‡è„šæœ¬å¯¹è¿™äº›æ–‡æ¡£è¿›è¡Œæ›´æ–°ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">script</code></strong>: æ›´æ–°æ“ä½œé€šè¿‡è„šæœ¬å®Œæˆï¼Œè„šæœ¬å¯ä»¥è®¿é—®æ–‡æ¡£çš„å­—æ®µå¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">painless</code> è„šæœ¬æ¥å¢åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤å­—æ®µã€‚</li>
</ul>

<p>å…¸å‹çš„ <code class="language-plaintext highlighter-rouge">script</code> æ›´æ–°ç¤ºä¾‹</p>

<p>å‡è®¾ä½ å¸Œæœ›æ›´æ–°æ‰€æœ‰ <code class="language-plaintext highlighter-rouge">v</code> å­—æ®µç­‰äº 123 çš„äº§å“ï¼Œå°†å®ƒä»¬çš„ <code class="language-plaintext highlighter-rouge">v</code> å­—æ®µæ›´æ–°ä¸º 50ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateByQueryResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">updateByQuery</span><span class="o">(</span>
        <span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">matchAll</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">))</span>  <span class="c1">// ä½¿ç”¨ matchAll æ„å»ºæŸ¥è¯¢æ¡ä»¶  // æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£</span>
                <span class="o">.</span><span class="na">script</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="na">inline</span><span class="o">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"if (ctx._source.v == 123) { ctx._source.v = 50 }"</span><span class="o">)))</span>
<span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
</code></pre></div></div>

<p>å‚æ•°è¯´æ˜</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">index("products")</code></strong>: æŒ‡å®šäº†ç›®æ ‡ç´¢å¼• <code class="language-plaintext highlighter-rouge">"products"</code>ï¼Œæ›´æ–°æ“ä½œå°†åœ¨è¿™ä¸ªç´¢å¼•çš„æ–‡æ¡£ä¸Šæ‰§è¡Œã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">query(q -&gt; q.matchAll(m-&gt;m))</code></strong>: <code class="language-plaintext highlighter-rouge">matchAll</code> æŸ¥è¯¢åŒ¹é…æ‰€æœ‰æ–‡æ¡£ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æ›´å¤æ‚çš„æŸ¥è¯¢ï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">match</code>ã€<code class="language-plaintext highlighter-rouge">term</code> ç­‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">script(script)</code></strong>: è¿™æ˜¯æ›´æ–°çš„æ ¸å¿ƒï¼Œé€šè¿‡ä¸€ä¸ªè„šæœ¬å¯¹æ–‡æ¡£è¿›è¡Œä¿®æ”¹ã€‚åœ¨è¿™é‡Œï¼Œ<code class="language-plaintext highlighter-rouge">painless</code> è„šæœ¬ä¼šæ£€æŸ¥æ¯ä¸ªæ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">v</code> å­—æ®µï¼Œå¦‚æœå…¶å€¼ç­‰äº 123ï¼Œåˆ™å°† <code class="language-plaintext highlighter-rouge">v</code> å­—æ®µè®¾ç½®ä¸º 50ã€‚</li>
</ol>

<p>æ›´å¤æ‚çš„æŸ¥è¯¢ä¸è„šæœ¬</p>

<p>å¯ä»¥æ ¹æ®éœ€è¦æ„é€ æ›´å¤æ‚çš„æŸ¥è¯¢å’Œè„šæœ¬ã€‚ä¾‹å¦‚ï¼ŒæŸ¥è¯¢æ‰€æœ‰ <code class="language-plaintext highlighter-rouge">status</code> ä¸º <code class="language-plaintext highlighter-rouge">inactive</code> ä¸” <code class="language-plaintext highlighter-rouge">last_updated</code> è¶…è¿‡ 30 å¤©çš„æ–‡æ¡£ï¼Œå¹¶å°†å®ƒä»¬çš„ <code class="language-plaintext highlighter-rouge">active</code> å­—æ®µè®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">false</code>ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">UpdateByQueryResponse</span> <span class="n">response2</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">updateByQuery</span><span class="o">(</span>
    <span class="n">u</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
                <span class="o">.</span><span class="na">must</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">term</span><span class="o">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"status"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"inactive"</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"last_updated"</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="nc">JsonData</span><span class="o">.</span><span class="na">fromJson</span><span class="o">(</span><span class="s">"now-30d/d"</span><span class="o">))))))</span>
        <span class="o">.</span><span class="na">script</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span><span class="o">.</span><span class="na">inline</span><span class="o">(</span>
                <span class="n">i</span><span class="o">-&gt;</span><span class="n">i</span><span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"if (ctx._source.status == 'inactive' &amp;&amp; (new Date().getTime() - ctx._source.last_updated) &gt; 2592000000L) { ctx._source.active = false }"</span><span class="o">)))</span>
<span class="o">);</span>
</code></pre></div></div>

<p>ä¸»è¦æ–¹æ³•è¯´æ˜</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">index</code></strong>: æŒ‡å®šæ“ä½œçš„ç´¢å¼•ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">query</code></strong>: è®¾ç½®æ›´æ–°æ“ä½œçš„æŸ¥è¯¢æ¡ä»¶ã€‚æŒ‡å®šå“ªäº›æ–‡æ¡£éœ€è¦æ›´æ–°ï¼Œå¯ä»¥æ˜¯ <code class="language-plaintext highlighter-rouge">matchAll</code>ã€<code class="language-plaintext highlighter-rouge">term</code> æˆ–å…¶ä»–æŸ¥è¯¢ç±»å‹ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">script</code></strong>: è®¾ç½®æ‰§è¡Œçš„è„šæœ¬ï¼Œè„šæœ¬å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">ctx._source</code> æ¥è®¿é—®æ–‡æ¡£å­—æ®µå¹¶è¿›è¡Œæ›´æ–°ã€‚</li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">refresh</code></strong>ï¼ˆå¯é€‰ï¼‰: æ˜¯å¦åœ¨æ›´æ–°ååˆ·æ–°ç´¢å¼•ï¼Œé€šå¸¸ç”¨äºç¡®ä¿æ–‡æ¡£ç«‹å³å¯è§ã€‚</p>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">updateByQuery</code></strong>ï¼šå…è®¸ä½ é€šè¿‡æŸ¥è¯¢æ¡ä»¶æ‰¹é‡æ›´æ–°æ–‡æ¡£ã€‚é€‚ç”¨äºéœ€è¦æ‰¹é‡ä¿®æ”¹æ–‡æ¡£çš„åœºæ™¯ã€‚</li>
</ul>

<p>è¿™ç§æ–¹æ³•éå¸¸é€‚åˆç”¨äºéœ€è¦æ¡ä»¶æ›´æ–°çš„æ‰¹é‡æ“ä½œï¼Œèƒ½å¤Ÿé«˜æ•ˆåœ°æ›´æ–°å¤§é‡æ–‡æ¡£ã€‚</p>

<h3 id="åˆ é™¤">åˆ é™¤</h3>

<p>åœ¨ Java ä¸­ï¼Œä½¿ç”¨ Elasticsearch è¿›è¡Œæ•°æ®åˆ é™¤ï¼ˆ<code class="language-plaintext highlighter-rouge">delete</code>ï¼‰ä¸»è¦æ¶‰åŠä»¥ä¸‹å‡ ä¸ªç±»å’Œæ¥å£ï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">DeleteRequest</code> ç±»</strong>ï¼šæ˜¯åˆ é™¤æ“ä½œçš„æ ¸å¿ƒç±»ï¼Œè¡¨ç¤ºåˆ é™¤æ–‡æ¡£çš„è¯·æ±‚ã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥è®¾ç½®åˆ é™¤æ“ä½œçš„ç›®æ ‡ç´¢å¼•å’Œæ–‡æ¡£ IDã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">DeleteResponse</code> ç±»</strong>ï¼šæ˜¯ <code class="language-plaintext highlighter-rouge">delete</code> è¯·æ±‚è¿”å›çš„å“åº”ç±»ã€‚å®ƒåŒ…å«åˆ é™¤æ“ä½œçš„ç»“æœï¼Œæ¯”å¦‚æ˜¯å¦æˆåŠŸã€åˆ é™¤çš„æ–‡æ¡£ä¿¡æ¯ç­‰ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">DeleteByQueryRequest</code> ç±»</strong>ï¼šå¦‚æœä½ æƒ³åŸºäºæŸ¥è¯¢æ¡ä»¶åˆ é™¤å¤šä¸ªæ–‡æ¡£ï¼Œè€Œä¸ä»…ä»…æ˜¯å•ä¸ªæ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DeleteByQueryRequest</code> ç±»ã€‚è¿™ä¸ªç±»æ”¯æŒé€šè¿‡æŸ¥è¯¢æ¡ä»¶åˆ é™¤ç¬¦åˆæ¡ä»¶çš„å¤šä¸ªæ–‡æ¡£ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">DeleteByQueryResponse</code> ç±»</strong>ï¼šä¸ <code class="language-plaintext highlighter-rouge">DeleteByQueryRequest</code> é…å¥—çš„å“åº”ç±»ï¼Œç”¨äºè¿”å› <code class="language-plaintext highlighter-rouge">delete_by_query</code> æ“ä½œçš„ç»“æœã€‚å®ƒåŒ…å«åˆ é™¤çš„æ–‡æ¡£æ•°é‡ç­‰ä¿¡æ¯ã€‚</p>

<h4 id="deleterequest"><code class="language-plaintext highlighter-rouge">DeleteRequest</code></h4>

<p><code class="language-plaintext highlighter-rouge">DeleteRequest</code> æ˜¯ Elasticsearch ä¸­ç”¨äºæ‰§è¡Œæ–‡æ¡£åˆ é™¤æ“ä½œçš„è¯·æ±‚ç±»ï¼Œå®ƒä¸»è¦ç”¨äºæŒ‡å®šè¦åˆ é™¤çš„æ–‡æ¡£çš„ç´¢å¼•ã€æ–‡æ¡£ ID ä»¥åŠä¸€äº›å…¶ä»–çš„å‚æ•°ã€‚</p>

<p><strong>å­—æ®µï¼š</strong>
<code class="language-plaintext highlighter-rouge">DeleteRequest</code> çš„å­—æ®µä¸»è¦ç”¨äºæŒ‡å®šè¦åˆ é™¤çš„æ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•å’Œæ–‡æ¡£ IDã€‚å¸¸ç”¨çš„å­—æ®µå¦‚ä¸‹ï¼š</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">index</code></strong> (<code class="language-plaintext highlighter-rouge">String</code>): è¦åˆ é™¤æ–‡æ¡£çš„ç´¢å¼•åç§°ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">id</code></strong> (<code class="language-plaintext highlighter-rouge">String</code>): è¦åˆ é™¤æ–‡æ¡£çš„ IDã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">version</code></strong> (<code class="language-plaintext highlighter-rouge">long</code>): æ–‡æ¡£çš„ç‰ˆæœ¬å·ï¼Œç”¨äºä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆå¯é€‰ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">versionType</code></strong> (<code class="language-plaintext highlighter-rouge">VersionType</code>): ç‰ˆæœ¬ç±»å‹ï¼Œé»˜è®¤æ˜¯ <code class="language-plaintext highlighter-rouge">VersionType.INTERNAL</code>ï¼Œå¯ä»¥æŒ‡å®šå…¶ä»–ç±»å‹ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">VersionType.EXTERNAL</code>ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">routing</code></strong> (<code class="language-plaintext highlighter-rouge">String</code>): æŒ‡å®šè·¯ç”±å€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šæ ¹æ®æ–‡æ¡£ ID è¿›è¡Œè·¯ç”±ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">parent</code></strong> (<code class="language-plaintext highlighter-rouge">String</code>): è®¾ç½®çˆ¶æ–‡æ¡£çš„ IDï¼ˆå¯¹äºçˆ¶å­æ–‡æ¡£å…³ç³»æœ‰ç”¨ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">timeout</code></strong> (<code class="language-plaintext highlighter-rouge">TimeValue</code>): è®¾ç½®è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">refresh</code></strong> (<code class="language-plaintext highlighter-rouge">Boolean</code>): æ˜¯å¦åˆ·æ–°ç´¢å¼•ä»¥ä¾¿ç«‹å³å¯è§ï¼ˆä¾‹å¦‚ï¼š<code class="language-plaintext highlighter-rouge">true</code> æˆ– <code class="language-plaintext highlighter-rouge">false</code>ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">waitForActiveShards</code></strong> (<code class="language-plaintext highlighter-rouge">String</code>): æŒ‡å®šåœ¨åˆ é™¤è¯·æ±‚è¿”å›å‰ç­‰å¾…å¤šå°‘ä¸ªæ´»åŠ¨åˆ†ç‰‡ï¼ˆä¾‹å¦‚ï¼š<code class="language-plaintext highlighter-rouge">1</code>ï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">routing</code></strong> (<code class="language-plaintext highlighter-rouge">String</code>): ç”¨äºè·¯ç”±çš„å€¼ã€‚</li>
</ul>

<hr />

<p><strong>å¸¸ç”¨æ–¹æ³•ï¼š</strong></p>

<p><strong>è®¾ç½®ç´¢å¼•å’Œæ–‡æ¡£ IDï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest index(String index)</code>  ï¼šè®¾ç½®åˆ é™¤æ“ä½œçš„ç´¢å¼•åç§°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest id(String id)</code>  ï¼šè®¾ç½®è¦åˆ é™¤æ–‡æ¡£çš„ IDã€‚</li>
</ul>

<p><strong>è®¾ç½®ç‰ˆæœ¬æ§åˆ¶ï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest version(long version)</code> ï¼šè®¾ç½®æ–‡æ¡£çš„ç‰ˆæœ¬å·ï¼Œé€‚ç”¨äºä¹è§‚é”æ§åˆ¶ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest versionType(VersionType versionType)</code> ï¼šè®¾ç½®ç‰ˆæœ¬ç±»å‹ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">VersionType.INTERNAL</code> æˆ– <code class="language-plaintext highlighter-rouge">VersionType.EXTERNAL</code>ï¼‰ã€‚</li>
</ul>

<p><strong>è®¾ç½®è·¯ç”±ï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest routing(String routing)</code>  ï¼šè®¾ç½®è·¯ç”±å€¼ï¼ŒæŒ‡å®šæ–‡æ¡£çš„è·¯ç”±ç­–ç•¥ã€‚</li>
</ul>

<p><strong>è®¾ç½®çˆ¶æ–‡æ¡£ï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest parent(String parent)</code>  ï¼šè®¾ç½®çˆ¶æ–‡æ¡£çš„ IDï¼ˆç”¨äºçˆ¶å­æ–‡æ¡£å…³ç³»ï¼‰ã€‚</li>
</ul>

<p><strong>è®¾ç½®è¶…æ—¶ï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest timeout(TimeValue timeout)</code> ï¼šè®¾ç½®è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest timeout(String timeout)</code>  ï¼šè®¾ç½®è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œå­—ç¬¦ä¸²å½¢å¼ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">"30s"</code>ï¼‰ã€‚</li>
</ul>

<p><strong>è®¾ç½®åˆ·æ–°é€‰é¡¹ï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest setRefreshPolicy(WriteRequest.RefreshPolicy refreshPolicy)</code> ï¼šè®¾ç½®åˆ·æ–°ç­–ç•¥ï¼ˆä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">WriteRequest.RefreshPolicy.IMMEDIATE</code>ï¼‰ã€‚</li>
</ul>

<p><strong>è®¾ç½®ç­‰å¾…æ´»åŠ¨åˆ†ç‰‡ï¼š</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest waitForActiveShards(String waitForActiveShards)</code>ï¼šè®¾ç½®åœ¨è¿”å›ä¹‹å‰ç­‰å¾…å¤šå°‘ä¸ªæ´»åŠ¨åˆ†ç‰‡ã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DeleteResponse</span> <span class="n">deleteResponse</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">d</span> <span class="o">-&gt;</span> <span class="n">d</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">));</span>
<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">deleteResponse</span><span class="o">.</span><span class="na">version</span><span class="o">()));</span>
</code></pre></div></div>

<h4 id="deleteresponse"><code class="language-plaintext highlighter-rouge">DeleteResponse</code></h4>

<p><code class="language-plaintext highlighter-rouge">DeleteResponse</code> æ˜¯ Elasticsearch åˆ é™¤è¯·æ±‚çš„å“åº”å¯¹è±¡ã€‚å®ƒç”¨äºè¿”å›åˆ é™¤æ“ä½œçš„ç»“æœï¼ŒåŒ…æ‹¬æ–‡æ¡£åˆ é™¤çš„çŠ¶æ€ã€ç‰ˆæœ¬å·ã€ç´¢å¼•åç§°ç­‰ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯ <code class="language-plaintext highlighter-rouge">DeleteResponse</code> ç±»çš„å­—æ®µå’Œå¸¸ç”¨æ–¹æ³•ï¼š</p>

<p><strong>å­—æ®µï¼š</strong></p>

<p><code class="language-plaintext highlighter-rouge">DeleteResponse</code> çš„å­—æ®µä¸»è¦ç”¨äºè¿”å›åˆ é™¤æ“ä½œçš„ç›¸å…³ä¿¡æ¯ã€‚å¸¸ç”¨çš„å­—æ®µå¦‚ä¸‹ï¼š</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">result</code></strong> (<code class="language-plaintext highlighter-rouge">DocWriteResponse.Result</code>): åˆ é™¤æ“ä½œçš„ç»“æœã€‚å¯èƒ½çš„å€¼åŒ…æ‹¬ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DELETED</code>: åˆ é™¤æˆåŠŸã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">NOT_FOUND</code>: åˆ é™¤çš„æ–‡æ¡£ä¸å­˜åœ¨ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">VERSION_CONFLICT</code>: ç‰ˆæœ¬å†²çªã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">FAILURE</code>: å¤±è´¥ã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">id</code></strong> (<code class="language-plaintext highlighter-rouge">String</code>): è¢«åˆ é™¤æ–‡æ¡£çš„ IDã€‚</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">index</code></strong> (<code class="language-plaintext highlighter-rouge">String</code>): è¢«åˆ é™¤æ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•åç§°ã€‚</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">version</code></strong> (<code class="language-plaintext highlighter-rouge">long</code>): è¢«åˆ é™¤æ–‡æ¡£çš„ç‰ˆæœ¬å·ã€‚</p>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">shardInfo</code></strong> (<code class="language-plaintext highlighter-rouge">ShardInfo</code>): æ‰§è¡Œåˆ é™¤æ“ä½œçš„åˆ†ç‰‡ä¿¡æ¯ï¼ŒåŒ…å«äº†è¯·æ±‚å¤„ç†çš„åˆ†ç‰‡æ•°é‡ã€å¤±è´¥çš„åˆ†ç‰‡æ•°é‡ç­‰ä¿¡æ¯ã€‚</li>
</ul>

<p><strong>å¸¸ç”¨æ–¹æ³•ï¼š</strong></p>

<p><strong>è·å–åˆ é™¤ç»“æœï¼š</strong>ï¼Œ<strong><code class="language-plaintext highlighter-rouge">result()</code></strong> ï¼Œè·å–åˆ é™¤æ“ä½œçš„ç»“æœï¼Œè¿”å›å€¼ä¸º <code class="language-plaintext highlighter-rouge">Result</code> ç±»å‹ï¼Œå¯èƒ½çš„ç»“æœåŒ…æ‹¬ï¼š</p>

<p><strong>è·å–æ–‡æ¡£ IDï¼š</strong>ï¼Œ<strong><code class="language-plaintext highlighter-rouge">id()</code></strong>ï¼Œè·å–å·²åˆ é™¤æ–‡æ¡£çš„ IDã€‚</p>

<p><strong>è·å–ç´¢å¼•åç§°ï¼š</strong>ï¼Œ<strong><code class="language-plaintext highlighter-rouge">index()</code></strong>ï¼Œè·å–å·²åˆ é™¤æ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•åç§°ã€‚</p>

<p><strong>è·å–æ–‡æ¡£ç‰ˆæœ¬å·ï¼š</strong>ï¼Œ<strong><code class="language-plaintext highlighter-rouge">version()</code></strong> ï¼Œ è·å–å·²åˆ é™¤æ–‡æ¡£çš„ç‰ˆæœ¬å·ã€‚</p>

<p><strong>è·å–åˆ†ç‰‡ä¿¡æ¯ï¼š</strong>ï¼Œ<strong><code class="language-plaintext highlighter-rouge">shards()</code></strong> ï¼Œè·å–æ‰§è¡Œåˆ é™¤æ“ä½œçš„åˆ†ç‰‡ä¿¡æ¯ï¼Œè¿”å› <code class="language-plaintext highlighter-rouge">ShardInfo</code> å¯¹è±¡ï¼ŒåŒ…å«æœ‰å…³åˆ†ç‰‡çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æˆåŠŸå¤„ç†çš„åˆ†ç‰‡æ•°é‡ã€å¤±è´¥çš„åˆ†ç‰‡æ•°é‡ç­‰ã€‚</p>

<p><strong>è·å–æ“ä½œæ‰§è¡Œçš„åˆ†ç‰‡æ•°é‡ï¼š</strong>ï¼Œ<strong><code class="language-plaintext highlighter-rouge">shards().total()</code></strong>  ï¼Œè·å–æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œå‚ä¸å¤„ç†çš„æ€»åˆ†ç‰‡æ•°é‡ã€‚</p>

<p><strong>è·å–å¤±è´¥çš„åˆ†ç‰‡æ•°é‡ï¼š</strong>ï¼Œ<strong><code class="language-plaintext highlighter-rouge">shards().failed()</code></strong>  ï¼Œè·å–åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œå¤±è´¥çš„åˆ†ç‰‡æ•°é‡ã€‚</p>

<p><strong>è·å–å¤±è´¥çš„åˆ†ç‰‡ä¿¡æ¯ï¼š</strong>ï¼Œ<strong><code class="language-plaintext highlighter-rouge">shards().failures()</code></strong>  ï¼Œè·å–å¤±è´¥çš„åˆ†ç‰‡çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">List&lt;ShardFailure&gt;</code>ï¼ŒåŒ…å«å¤±è´¥çš„åŸå› å’Œå…¶ä»–ä¿¡æ¯ã€‚</p>

<p><strong>ç¤ºä¾‹ä»£ç ï¼š</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DeleteResponse</span> <span class="n">deleteResponse</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">d</span> <span class="o">-&gt;</span> <span class="n">d</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">));</span>
<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">deleteResponse</span><span class="o">.</span><span class="na">version</span><span class="o">()));</span>


<span class="c1">// è·å–åˆ é™¤æ“ä½œçš„ç»“æœ</span>
<span class="nc">Result</span> <span class="n">result1</span> <span class="o">=</span> <span class="n">deleteResponse</span><span class="o">.</span><span class="na">result</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Delete result: "</span> <span class="o">+</span> <span class="n">result1</span><span class="o">);</span>

<span class="c1">// è·å–è¢«åˆ é™¤æ–‡æ¡£çš„ ID</span>
<span class="nc">String</span> <span class="n">docId</span> <span class="o">=</span> <span class="n">deleteResponse</span><span class="o">.</span><span class="na">id</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Deleted document ID: "</span> <span class="o">+</span> <span class="n">docId</span><span class="o">);</span>

<span class="c1">// è·å–æ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•åç§°</span>
<span class="nc">String</span> <span class="n">index</span> <span class="o">=</span> <span class="n">deleteResponse</span><span class="o">.</span><span class="na">index</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Document index: "</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>

<span class="c1">// è·å–æ–‡æ¡£çš„ç‰ˆæœ¬å·</span>
<span class="kt">long</span> <span class="n">version</span> <span class="o">=</span> <span class="n">deleteResponse</span><span class="o">.</span><span class="na">version</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Deleted document version: "</span> <span class="o">+</span> <span class="n">version</span><span class="o">);</span>

<span class="c1">// è·å–åˆ†ç‰‡ä¿¡æ¯</span>
<span class="nc">ShardStatistics</span> <span class="n">shards</span> <span class="o">=</span> <span class="n">deleteResponse</span><span class="o">.</span><span class="na">shards</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Shard info: "</span> <span class="o">+</span> <span class="n">shards</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total shards: "</span> <span class="o">+</span> <span class="n">shards</span><span class="o">.</span><span class="na">total</span><span class="o">());</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Failed shards: "</span> <span class="o">+</span> <span class="n">shards</span><span class="o">.</span><span class="na">failed</span><span class="o">());</span>

<span class="c1">// å¦‚æœæœ‰å¤±è´¥çš„åˆ†ç‰‡ï¼Œå¯ä»¥æŸ¥çœ‹å¤±è´¥çš„å…·ä½“ä¿¡æ¯</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">ShardFailure</span><span class="o">&gt;</span> <span class="n">failures1</span> <span class="o">=</span> <span class="n">shards</span><span class="o">.</span><span class="na">failures</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">ShardFailure</span> <span class="n">failure</span> <span class="o">:</span> <span class="n">failures1</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Failure reason: "</span> <span class="o">+</span> <span class="n">failure</span><span class="o">.</span><span class="na">reason</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="delete"><code class="language-plaintext highlighter-rouge">delete()</code></h4>

<p>åœ¨ Elasticsearch ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">esClient.delete</code> æ–¹æ³•ç”¨äºåˆ é™¤æ–‡æ¡£ã€‚è¯¥æ–¹æ³•æœ‰å‡ ä¸ªå¸¸è§çš„å˜ä½“å’Œå‚æ•°ï¼Œä¸‹é¢åˆ—å‡ºäº†è¿™äº›å˜ä½“åŠå…¶ç›¸å…³è¯´æ˜ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">delete(DeleteRequest request)</code></strong> æ–¹æ³•ï¼š</p>

<p><strong>åŠŸèƒ½</strong>ï¼šæ ¹æ®ä¼ å…¥çš„ <code class="language-plaintext highlighter-rouge">DeleteRequest</code> å¯¹è±¡æ¥åˆ é™¤æ–‡æ¡£ã€‚
<strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">DeleteRequest request</code></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest</code> æ˜¯ä¸€ä¸ªåŒ…å«åˆ é™¤æ–‡æ¡£æ‰€éœ€ä¿¡æ¯çš„å¯¹è±¡ã€‚</li>
  <li>å®ƒé€šå¸¸éœ€è¦æŒ‡å®šä»¥ä¸‹å†…å®¹ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">index</code>ï¼šè¦åˆ é™¤æ–‡æ¡£çš„ç´¢å¼•åç§°ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">id</code>ï¼šè¦åˆ é™¤æ–‡æ¡£çš„ IDã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">routing</code>ï¼šæŒ‡å®šæ–‡æ¡£çš„è·¯ç”±ï¼ˆå¯é€‰ï¼‰ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">version</code>ï¼šæŒ‡å®šæ–‡æ¡£çš„ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼Œç”¨äºç‰ˆæœ¬æ§åˆ¶ï¼Œé¿å…åˆ é™¤ä¸åŒç‰ˆæœ¬çš„æ–‡æ¡£ï¼‰ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">versionType</code>ï¼šç‰ˆæœ¬æ§åˆ¶çš„ç±»å‹ï¼ˆå¯é€‰ï¼‰ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>è¿”å›å€¼</strong>ï¼šè¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DeleteResponse</code> å¯¹è±¡ï¼ŒåŒ…å«åˆ é™¤æ“ä½œçš„ç»“æœã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DeleteRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DeleteRequest</span><span class="o">(</span><span class="s">"index_name"</span><span class="o">,</span> <span class="s">"doc_id"</span><span class="o">);</span>
<span class="nc">DeleteResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">delete(Function&lt;DeleteRequest.Builder, ObjectBuilder&lt;DeleteRequest&gt;&gt; fn)</code></strong> æ–¹æ³•ï¼š</p>

<p><strong>åŠŸèƒ½</strong>ï¼šä½¿ç”¨ä¸€ä¸ªå‡½æ•°å¼ç¼–ç¨‹é£æ ¼çš„æ„å»ºå™¨æ¥åˆ›å»º <code class="language-plaintext highlighter-rouge">DeleteRequest</code> å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œåˆ é™¤æ“ä½œã€‚
<strong>å‚æ•°</strong>ï¼šä¸€ä¸ªå‡½æ•° <code class="language-plaintext highlighter-rouge">fn</code>ï¼Œè¯¥å‡½æ•°å°†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DeleteRequest.Builder</code> è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">DeleteRequest</code> å¯¹è±¡ã€‚</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DeleteRequest.Builder</code> æ˜¯ç”¨äºæ„å»º <code class="language-plaintext highlighter-rouge">DeleteRequest</code> å¯¹è±¡çš„æ„å»ºå™¨ã€‚</li>
</ul>

<p><strong>è¿”å›å€¼</strong>ï¼šè¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">DeleteResponse</code> å¯¹è±¡ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DeleteResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"index_name"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"doc_id"</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">DeleteRequest</code> ç±»çš„å¸¸ç”¨å­—æ®µå’Œæ–¹æ³•ï¼š</strong></p>

<p><code class="language-plaintext highlighter-rouge">DeleteRequest</code> æ˜¯ä¸€ä¸ªç”¨äºè¡¨ç¤ºåˆ é™¤æ–‡æ¡£è¯·æ±‚çš„ç±»ï¼Œå¸¸ç”¨å­—æ®µå’Œæ–¹æ³•åŒ…æ‹¬ï¼š</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">index</code></strong>ï¼šæ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•åç§°ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">id</code></strong>ï¼šè¦åˆ é™¤æ–‡æ¡£çš„ IDã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">routing</code></strong>ï¼šè·¯ç”±ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºæŒ‡å®šæ–‡æ¡£çš„è·¯ç”±ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">version</code></strong>ï¼šæ–‡æ¡£çš„ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰ï¼Œç”¨äºç‰ˆæœ¬æ§åˆ¶ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">versionType</code></strong>ï¼šç‰ˆæœ¬æ§åˆ¶ç±»å‹ï¼ˆå¯é€‰ï¼‰ï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">internal</code> æˆ– <code class="language-plaintext highlighter-rouge">external</code>ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">timeout</code></strong>ï¼šæ“ä½œè¶…æ—¶ï¼ˆå¯é€‰ï¼‰ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DeleteRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DeleteRequest</span><span class="o">(</span><span class="s">"index_name"</span><span class="o">,</span> <span class="s">"doc_id"</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">routing</span><span class="o">(</span><span class="s">"routing_value"</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">version</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="n">request</span><span class="o">.</span><span class="na">versionType</span><span class="o">(</span><span class="nc">VersionType</span><span class="o">.</span><span class="na">INTERNAL</span><span class="o">);</span>
<span class="nc">DeleteResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">DeleteResponse</code> ç±»çš„å¸¸ç”¨å­—æ®µå’Œæ–¹æ³•ï¼š</strong></p>

<p><code class="language-plaintext highlighter-rouge">DeleteResponse</code> æ˜¯åˆ é™¤æ“ä½œçš„å“åº”å¯¹è±¡ï¼Œå¸¸ç”¨å­—æ®µå’Œæ–¹æ³•åŒ…æ‹¬ï¼š</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">getResult()</code></strong>ï¼šè·å–åˆ é™¤æ“ä½œçš„ç»“æœï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">DELETED</code> æˆ– <code class="language-plaintext highlighter-rouge">NOT_FOUND</code>ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">getId()</code></strong>ï¼šè·å–åˆ é™¤æ–‡æ¡£çš„ IDã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">getIndex()</code></strong>ï¼šè·å–åˆ é™¤æ–‡æ¡£çš„ç´¢å¼•åç§°ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">getVersion()</code></strong>ï¼šè·å–åˆ é™¤æ–‡æ¡£çš„ç‰ˆæœ¬å·ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">getShardInfo()</code></strong>ï¼šè·å–ä¸åˆ é™¤æ“ä½œç›¸å…³çš„åˆ†ç‰‡ä¿¡æ¯ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">DeleteResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getResult</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span> <span class="c1">// è·å–åˆ é™¤ç»“æœ</span>
<span class="nc">String</span> <span class="n">docId</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span> <span class="c1">// è·å–æ–‡æ¡£ ID</span>
</code></pre></div></div>

<p>æ€»ç»“ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">esClient.delete</code> æ–¹æ³•æœ‰ä¸¤ç§ä¸»è¦çš„è°ƒç”¨æ–¹å¼ï¼š</p>
<ol>
  <li><strong>ç›´æ¥ä¼ é€’ <code class="language-plaintext highlighter-rouge">DeleteRequest</code> å¯¹è±¡</strong>ï¼šé€‚ç”¨äºå·²ç»åˆ›å»ºå¥½çš„åˆ é™¤è¯·æ±‚å¯¹è±¡ã€‚</li>
  <li><strong>ä½¿ç”¨æ„å»ºå™¨æ¨¡å¼</strong>ï¼šé€šè¿‡ä¸€ä¸ªå‡½æ•°æ¥æ„å»º <code class="language-plaintext highlighter-rouge">DeleteRequest</code> å¯¹è±¡ã€‚</li>
</ol>

<p>é€šè¿‡è¿™ä¸¤ç§æ–¹å¼ï¼Œä½ å¯ä»¥çµæ´»åœ°åˆ é™¤æ–‡æ¡£å¹¶è·å–åˆ é™¤æ“ä½œçš„å“åº”ç»“æœã€‚å¦‚æœéœ€è¦ï¼Œåˆ é™¤è¯·æ±‚å¯ä»¥åŒ…å«è·¯ç”±ã€ç‰ˆæœ¬æ§åˆ¶ã€è¶…æ—¶ç­‰å…¶ä»–å‚æ•°ï¼Œå“åº”åˆ™åŒ…å«åˆ é™¤çš„ç»“æœã€æ–‡æ¡£ IDã€ç´¢å¼•åå’Œç‰ˆæœ¬å·ç­‰ä¿¡æ¯ã€‚</p>

<h3 id="æ¡ä»¶åˆ é™¤">æ¡ä»¶åˆ é™¤</h3>

<p>ç±»ä¼¼æ¡ä»¶æ›´æ–°ã€‚</p>

<h3 id="æŸ¥è¯¢">æŸ¥è¯¢</h3>

<p>ä½¿ç”¨ Elasticsearch å®¢æˆ·ç«¯å‘é€ HTTP Postè¯·æ±‚ <code class="language-plaintext highlighter-rouge">/products/_search</code> æŸ¥è¯¢æ•°æ®ï¼Œå¾—åˆ°ç±»ä¼¼å¦‚ä¸‹ç»“æœï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bk-1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"products"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"cityBike"</span><span class="p">:</span><span class="w"> </span><span class="s2">"City bike"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"sku"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bk-1"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"v"</span><span class="p">:</span><span class="w"> </span><span class="mi">123</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"relation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eq"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™ä¸ª JSON å“åº”æ˜¯æ¥è‡ª Elasticsearch æœç´¢è¯·æ±‚çš„ç»“æœã€‚å®ƒåŒ…å«äº†æœ‰å…³æŸ¥è¯¢æ‰§è¡Œæƒ…å†µä»¥åŠè¿”å›çš„æ–‡æ¡£çš„è¯¦ç»†ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯å„ä¸ªå­—æ®µçš„è§£é‡Šï¼š</p>

<p><code class="language-plaintext highlighter-rouge">_shards</code> éƒ¨åˆ†æè¿°äº† Elasticsearch æ‰§è¡Œæœç´¢è¯·æ±‚æ—¶çš„åˆ†ç‰‡ï¼ˆshardï¼‰çŠ¶æ€ã€‚Elasticsearch å°†æ•°æ®å­˜å‚¨åœ¨å¤šä¸ªåˆ†ç‰‡ä¸­ï¼Œå› æ­¤æ­¤éƒ¨åˆ†æä¾›äº†è¯·æ±‚åœ¨åˆ†ç‰‡ä¸Šæ‰§è¡Œçš„ç»“æœã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">failed</code>ï¼šè¡¨ç¤ºæŸ¥è¯¢è¿‡ç¨‹ä¸­å¤±è´¥çš„åˆ†ç‰‡æ•°é‡ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ 0ï¼Œè¡¨ç¤ºæ²¡æœ‰å¤±è´¥çš„åˆ†ç‰‡ï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">skipped</code>ï¼šè¡¨ç¤ºè·³è¿‡çš„åˆ†ç‰‡æ•°é‡ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ 0ï¼Œè¡¨ç¤ºæ²¡æœ‰è·³è¿‡åˆ†ç‰‡ï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">successful</code>ï¼šè¡¨ç¤ºæˆåŠŸæ‰§è¡ŒæŸ¥è¯¢çš„åˆ†ç‰‡æ•°é‡ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ 1ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªåˆ†ç‰‡æˆåŠŸæ‰§è¡Œï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">total</code>ï¼šè¡¨ç¤ºæ€»å…±çš„åˆ†ç‰‡æ•°é‡ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯ 1ï¼Œè¡¨ç¤ºåªæœ‰ä¸€ä¸ªåˆ†ç‰‡ï¼‰ã€‚</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">hits</code>éƒ¨åˆ†åŒ…å«äº†æŸ¥è¯¢çš„åŒ¹é…ç»“æœï¼ŒåŒ…æ‹¬æ¯ä¸ªåŒ¹é…æ–‡æ¡£çš„ä¿¡æ¯ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">hits</code>: ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«äº†æ‰€æœ‰ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„æ–‡æ¡£ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ–‡æ¡£ç¬¦åˆæ¡ä»¶ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">max_score</code>: è¡¨ç¤ºæŸ¥è¯¢ç»“æœä¸­æœ€é«˜çš„è¯„åˆ†ï¼ˆ<code class="language-plaintext highlighter-rouge">_score</code>ï¼‰ï¼Œç”¨æ¥è¡¡é‡æ–‡æ¡£ä¸æŸ¥è¯¢æ¡ä»¶çš„åŒ¹é…åº¦ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">max_score</code> æ˜¯ 1ï¼Œè¡¨ç¤ºè¯„åˆ†æœ€é«˜çš„æ–‡æ¡£çš„å¾—åˆ†ä¸º 1ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">total</code>: è¿™æ˜¯ç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„æ–‡æ¡£æ€»æ•°ã€‚<code class="language-plaintext highlighter-rouge">relation: "eq"</code> è¡¨ç¤ºæŸ¥è¯¢ç»“æœæ˜¯â€œç­‰äºâ€çš„å…³ç³»ï¼Œ<code class="language-plaintext highlighter-rouge">value: 1</code> è¡¨ç¤ºæŸ¥è¯¢è¿”å›äº† 1 ä¸ªç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£ã€‚</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">_id</code>, <code class="language-plaintext highlighter-rouge">_index</code>, <code class="language-plaintext highlighter-rouge">_score</code>, <code class="language-plaintext highlighter-rouge">_source</code>,è¿™äº›å­—æ®µæè¿°äº†æ¯ä¸ªæ–‡æ¡£çš„å…·ä½“ä¿¡æ¯ã€‚</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_id</code>: è¯¥å­—æ®µè¡¨ç¤ºæ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_id</code> æ˜¯ <code class="language-plaintext highlighter-rouge">"bk-1"</code>ã€‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_index</code>: è¯¥å­—æ®µè¡¨ç¤ºæ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ–‡æ¡£å­˜å‚¨åœ¨ <code class="language-plaintext highlighter-rouge">"products"</code> ç´¢å¼•ä¸­ã€‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_score</code>: è¿™æ˜¯æ–‡æ¡£çš„ç›¸å…³æ€§è¯„åˆ†ï¼ˆåœ¨ Elasticsearch ä¸­é€šå¸¸ç”¨äºè¡¡é‡æ–‡æ¡£ä¸æŸ¥è¯¢æ¡ä»¶çš„åŒ¹é…åº¦ï¼‰ã€‚æ­¤å€¼åœ¨è¿™é‡Œä¸º <code class="language-plaintext highlighter-rouge">1</code>ï¼Œè¡¨ç¤ºè¯¥æ–‡æ¡£å®Œå…¨åŒ¹é…æŸ¥è¯¢ã€‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">_source</code>: è¿™æ˜¯å®é™…å­˜å‚¨åœ¨ Elasticsearch ä¸­çš„æ–‡æ¡£å†…å®¹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ–‡æ¡£çš„å†…å®¹å¦‚ä¸‹ï¼š</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">"cityBike": "City bike"</code>ï¼šè¡¨ç¤ºè¯¥æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">cityBike</code> å­—æ®µå€¼ä¸º <code class="language-plaintext highlighter-rouge">"City bike"</code>ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">"sku": "bk-1"</code>ï¼šè¡¨ç¤ºè¯¥æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">sku</code> å­—æ®µå€¼ä¸º <code class="language-plaintext highlighter-rouge">"bk-1"</code>ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">"v": 123</code>ï¼šè¡¨ç¤ºè¯¥æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">v</code> å­—æ®µå€¼ä¸º <code class="language-plaintext highlighter-rouge">123</code>ã€‚</li>
    </ul>
  </li>
</ul>

<p><code class="language-plaintext highlighter-rouge">timed_out</code>,è¡¨ç¤ºæŸ¥è¯¢æ˜¯å¦è¶…æ—¶ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå®ƒæ˜¯ <code class="language-plaintext highlighter-rouge">false</code>ï¼Œæ„å‘³ç€æŸ¥è¯¢æ²¡æœ‰è¶…æ—¶ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">took</code>,è¡¨ç¤ºæŸ¥è¯¢èŠ±è´¹çš„æ—¶é—´ï¼ˆå•ä½æ˜¯æ¯«ç§’ï¼‰ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">took</code> æ˜¯ <code class="language-plaintext highlighter-rouge">2</code>ï¼Œè¡¨ç¤ºæŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´ä¸º 2 æ¯«ç§’ã€‚</p>

<p>è¿™ä¸ª JSON å“åº”çš„ç»“æ„åæ˜ äº†ä¸€ä¸ª Elasticsearch æŸ¥è¯¢çš„ç»“æœï¼ŒåŒ…å«äº†ä»¥ä¸‹ä¸»è¦éƒ¨åˆ†ï¼š</p>

<ul>
  <li><strong>åˆ†ç‰‡æ‰§è¡ŒçŠ¶æ€</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">_shards</code>ï¼‰ï¼šæŸ¥è¯¢æ‰§è¡Œçš„æˆåŠŸå’Œå¤±è´¥æƒ…å†µã€‚</li>
  <li><strong>æŸ¥è¯¢ç»“æœ</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">hits</code>ï¼‰ï¼šåŒ¹é…æŸ¥è¯¢æ¡ä»¶çš„æ–‡æ¡£ã€‚</li>
  <li><strong>æŸ¥è¯¢æ€§èƒ½</strong>ï¼šå¦‚æŸ¥è¯¢æ—¶é—´å’Œæ˜¯å¦è¶…æ—¶ã€‚</li>
</ul>

<p>åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼ŒæŸ¥è¯¢æˆåŠŸè¿”å›äº†ä¸€ä¸ªæ–‡æ¡£ï¼Œæ–‡æ¡£çš„å†…å®¹åŒ…æ‹¬å­—æ®µ <code class="language-plaintext highlighter-rouge">cityBike</code>, <code class="language-plaintext highlighter-rouge">sku</code>, å’Œ <code class="language-plaintext highlighter-rouge">v</code>ï¼Œå¹¶ä¸”æŸ¥è¯¢æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ï¼ˆ2 æ¯«ç§’ï¼‰ã€‚</p>

<hr />

<p>åœ¨ Elasticsearch ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">Search</code> æŸ¥è¯¢è¿”å›çš„æ–‡æ¡£æ•°é‡æ˜¯ 10 æ¡ã€‚è¿™æ˜¯ Elasticsearch çš„åˆ†é¡µæœºåˆ¶ï¼ˆ<code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code>ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚è¦è¿”å›æ›´å¤šçš„æ•°æ®ï¼Œä½ éœ€è¦æ˜¾å¼åœ°è®¾ç½®æŸ¥è¯¢çš„ <code class="language-plaintext highlighter-rouge">size</code> å‚æ•°ã€‚</p>

<p>Javaä»£ç å®ä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SearchResponse</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
                <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"v"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="mi">50</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
                <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
        <span class="nc">Map</span><span class="o">.</span><span class="na">class</span>
<span class="o">);</span>
<span class="nc">HitsMetadata</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">hits</span><span class="o">();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="na">hits</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">Hit:</span><span class="o">:</span><span class="n">source</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>
<span class="n">collect</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç æ¼”ç¤ºäº†å¦‚ä½•åœ¨ Elasticsearch ä¸­æ‰§è¡Œä¸€ä¸ªç®€å•çš„æœç´¢æŸ¥è¯¢ï¼Œè·å–ç»“æœå¹¶å¤„ç†ã€‚ä¸‹é¢æ˜¯å¯¹æ¯ä¸ªéƒ¨åˆ†çš„è¯¦ç»†è§£é‡Šï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">SearchResponse&lt;Map&gt; response = esClient.search(...)</code></strong>ï¼š
è¿™æ˜¯ä¸€ä¸ªç”¨äºæ‰§è¡Œæœç´¢æŸ¥è¯¢çš„è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">SearchResponse</code> å¯¹è±¡ï¼Œå…¶ä¸­ <code class="language-plaintext highlighter-rouge">Map</code> æ˜¯æŸ¥è¯¢ç»“æœçš„ç±»å‹ã€‚é€šè¿‡è¿™æ®µä»£ç ï¼Œåº”ç”¨å°†æŸ¥è¯¢ Elasticsearch ç´¢å¼•å¹¶è·å–åŒ¹é…çš„ç»“æœã€‚</p>

<p>å‚æ•°è§£é‡Šï¼š</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">builder -&gt; builder.index("products")</code></strong>ï¼šæŒ‡å®šæŸ¥è¯¢çš„ç›®æ ‡ç´¢å¼•ä¸º <code class="language-plaintext highlighter-rouge">products</code>ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">.query(q -&gt; q.match(m -&gt; m.field("v").query(50)))</code></strong>ï¼š
    <ul>
      <li>è¿™é‡Œä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢æ¥æŸ¥æ‰¾å­—æ®µ <code class="language-plaintext highlighter-rouge">v</code> çš„å€¼ä¸º <code class="language-plaintext highlighter-rouge">50</code> çš„æ–‡æ¡£ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">field("v")</code> æŒ‡å®šå­—æ®µåä¸º <code class="language-plaintext highlighter-rouge">v</code>ï¼Œ<code class="language-plaintext highlighter-rouge">query(50)</code> è¡¨ç¤ºæŸ¥è¯¢å€¼ä¸º <code class="language-plaintext highlighter-rouge">50</code> çš„æ–‡æ¡£ã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">.size(10)</code></strong>ï¼šé™åˆ¶æŸ¥è¯¢ç»“æœè¿”å›çš„æ–‡æ¡£æ•°ç›®ä¸º 10ã€‚</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">.from(0)</code></strong>ï¼šæŒ‡å®šæŸ¥è¯¢ç»“æœçš„èµ·å§‹ä½ç½®ä¸º <code class="language-plaintext highlighter-rouge">0</code>ï¼ˆå³ä»ç¬¬ä¸€ä¸ªæ–‡æ¡£å¼€å§‹è¿”å›ï¼‰ã€‚é€šå¸¸ç”¨äºåˆ†é¡µæŸ¥è¯¢ã€‚</p>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">Map.class</code></strong>ï¼šæŒ‡å®šè¿”å›çš„ç»“æœç±»å‹ä¸º <code class="language-plaintext highlighter-rouge">Map</code>ã€‚<code class="language-plaintext highlighter-rouge">Map</code> è¡¨ç¤ºä¸€ä¸ªæ— ç±»å‹çº¦æŸçš„é”®å€¼å¯¹é›†åˆï¼ˆé€šå¸¸ä¸º <code class="language-plaintext highlighter-rouge">String</code> å¯¹åº”å­—æ®µåç§°ï¼Œ<code class="language-plaintext highlighter-rouge">Object</code> å¯¹åº”å­—æ®µå€¼ï¼‰ï¼Œè¿™é‡Œæ¯ä¸ªæ–‡æ¡£çš„å†…å®¹å°†ä½œä¸º <code class="language-plaintext highlighter-rouge">Map</code> å¯¹è±¡è¿”å›ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">HitsMetadata&lt;Map&gt; hits = response.hits();</code></strong>ï¼š</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">response.hits()</code></strong>ï¼šä» <code class="language-plaintext highlighter-rouge">SearchResponse</code> å¯¹è±¡ä¸­æå–å‡º <code class="language-plaintext highlighter-rouge">HitsMetadata</code>ï¼Œå…¶ä¸­åŒ…å«äº†æŸ¥è¯¢è¿”å›çš„æ‰€æœ‰æ–‡æ¡£çš„è¯¦ç»†ä¿¡æ¯ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">HitsMetadata&lt;Map&gt;</code></strong>ï¼š<code class="language-plaintext highlighter-rouge">HitsMetadata</code> æ˜¯ä¸€ä¸ªåŒ…å«äº†å¤šæ¡åŒ¹é…æ–‡æ¡£çš„å…ƒæ•°æ®çš„ç±»ï¼Œ<code class="language-plaintext highlighter-rouge">Map</code> ç±»å‹çš„ <code class="language-plaintext highlighter-rouge">hits</code> è¡¨ç¤ºæ¯ä¸ªæ–‡æ¡£çš„å†…å®¹éƒ½å°†è¢«å½“ä½œ <code class="language-plaintext highlighter-rouge">Map</code> å¯¹è±¡æ¥å¤„ç†ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">List&lt;Map&gt; collect = hits.hits().stream().map(Hit::source).toList();</code></strong>ï¼š</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">hits.hits()</code></strong>ï¼šè·å–åŒ…å«æŸ¥è¯¢ç»“æœæ–‡æ¡£çš„åˆ—è¡¨ï¼ˆæ¯ä¸ªæ–‡æ¡£ç”¨ <code class="language-plaintext highlighter-rouge">Hit</code> å¯¹è±¡è¡¨ç¤ºï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">.stream()</code></strong>ï¼šå°† <code class="language-plaintext highlighter-rouge">hits.hits()</code> è½¬æ¢ä¸ºæµï¼ˆstreamï¼‰ä»¥ä¾¿è¿›è¡Œè¿›ä¸€æ­¥çš„æ“ä½œã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">.map(Hit::source)</code></strong>ï¼š<code class="language-plaintext highlighter-rouge">Hit::source</code> æ˜¯ä¸€ä¸ªæ–¹æ³•å¼•ç”¨ï¼Œè¡¨ç¤ºä»æ¯ä¸ª <code class="language-plaintext highlighter-rouge">Hit</code> å¯¹è±¡ä¸­æå–æ–‡æ¡£å†…å®¹ï¼ˆå³æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_source</code> éƒ¨åˆ†ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Map</code> å¯¹è±¡ï¼ŒåŒ…å«äº†æ–‡æ¡£çš„å­—æ®µå’Œå€¼ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">.toList()</code></strong>ï¼šå°†æµä¸­çš„æ‰€æœ‰ <code class="language-plaintext highlighter-rouge">Map</code> å¯¹è±¡æ”¶é›†åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ï¼Œæœ€ç»ˆå¾—åˆ°åŒ…å«æ‰€æœ‰æŸ¥è¯¢ç»“æœæ–‡æ¡£å†…å®¹çš„åˆ—è¡¨ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">collect.forEach(System.out::println);</code></strong>ï¼š</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">forEach(System.out::println)</code></strong>ï¼šå¯¹ <code class="language-plaintext highlighter-rouge">collect</code> åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼ˆå³æ¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">Map</code> å¯¹è±¡ï¼‰æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">println</code> è¾“å‡ºæ“ä½œï¼Œé€ä¸ªæ‰“å°å‡ºæŸ¥è¯¢ç»“æœæ–‡æ¡£çš„å†…å®¹ã€‚</li>
</ul>

<p>è¿™æ®µä»£ç æ‰§è¡Œäº†ä¸€ä¸ªæŸ¥è¯¢ï¼ŒæŸ¥æ‰¾ç´¢å¼• <code class="language-plaintext highlighter-rouge">products</code> ä¸­å­—æ®µ <code class="language-plaintext highlighter-rouge">v</code> çš„å€¼ä¸º <code class="language-plaintext highlighter-rouge">50</code> çš„æ–‡æ¡£ã€‚è¿”å›çš„æ¯ä¸ªæ–‡æ¡£çš„å†…å®¹è¢«å½“ä½œ <code class="language-plaintext highlighter-rouge">Map</code> å¯¹è±¡å¤„ç†ï¼Œå¹¶ä¸”å°†æŸ¥è¯¢ç»“æœä¸­çš„æ¯ä¸ªæ–‡æ¡£å†…å®¹æ‰“å°å‡ºæ¥ã€‚è¿™ä¸ªä»£ç çš„æ ¸å¿ƒæµç¨‹åŒ…æ‹¬ï¼š</p>
<ol>
  <li>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">esClient.search</code> æ‰§è¡ŒæŸ¥è¯¢ã€‚</li>
  <li>æå–æŸ¥è¯¢ç»“æœä¸­çš„æ–‡æ¡£ã€‚</li>
  <li>å°†æ¯ä¸ªæ–‡æ¡£å†…å®¹æå–ä¸º <code class="language-plaintext highlighter-rouge">Map</code> å¹¶æ”¶é›†åˆ°ä¸€ä¸ªåˆ—è¡¨ä¸­ã€‚</li>
  <li>å°†ç»“æœåˆ—è¡¨æ‰“å°å‡ºæ¥ã€‚</li>
</ol>

<p>æ‰§è¡Œè¯¥æŸ¥è¯¢åï¼Œæ§åˆ¶å°å°†æ‰“å°å‡ºæ»¡è¶³æ¡ä»¶ï¼ˆ<code class="language-plaintext highlighter-rouge">v = 50</code>ï¼‰çš„æ–‡æ¡£å†…å®¹ã€‚</p>

<h4 id="searchrequest"><code class="language-plaintext highlighter-rouge">SearchRequest</code></h4>

<p><code class="language-plaintext highlighter-rouge">SearchRequest</code> æ˜¯ Elasticsearch Java å®¢æˆ·ç«¯ä¸­ç”¨äºæ„å»ºå’Œæ‰§è¡Œæœç´¢æŸ¥è¯¢çš„è¯·æ±‚å¯¹è±¡ã€‚ä»¥ä¸‹æ˜¯ <code class="language-plaintext highlighter-rouge">SearchRequest</code> ç±»ä¸­çš„ä¸»è¦å­—æ®µå’Œæ–¹æ³•ï¼š</p>

<p><strong>ä¸»è¦å­—æ®µï¼š</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">index</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">String[]</code>ï¼ŒæŒ‡å®šæœç´¢çš„ç´¢å¼•åç§°ã€‚å¦‚æœå¤šä¸ªç´¢å¼•éœ€è¦æŸ¥è¯¢ï¼Œå¯ä»¥ä¼ é€’ç´¢å¼•æ•°ç»„ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">types</code></strong>ï¼ˆå·²åºŸå¼ƒï¼Œå»ºè®®ä¸å†ä½¿ç”¨ï¼‰ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">String[]</code>ï¼ŒæŒ‡å®šæŸ¥è¯¢çš„ç±»å‹ã€‚åœ¨ Elasticsearch 7.x ä¹‹åï¼Œç±»å‹å·²ç»è¢«å¼ƒç”¨ï¼Œé€šå¸¸ä¸å†ä½¿ç”¨ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">query</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Query</code>ï¼ŒæŒ‡å®šæœç´¢æŸ¥è¯¢çš„ä¸»ä½“ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæŸ¥è¯¢ DSLï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">match</code>ã€<code class="language-plaintext highlighter-rouge">term</code> ç­‰ï¼‰ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">size</code></strong>ï¼š ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">int</code>ï¼Œé»˜è®¤å€¼ï¼š<code class="language-plaintext highlighter-rouge">10</code>ï¼ŒæŒ‡å®šè¦è¿”å›çš„æœ€å¤§ç»“æœæ•°ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">from</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">int</code>ï¼Œ é»˜è®¤å€¼ï¼š<code class="language-plaintext highlighter-rouge">0</code>ï¼ŒæŒ‡å®šæŸ¥è¯¢ç»“æœçš„èµ·å§‹åç§»é‡ï¼Œé€šå¸¸ç”¨äºåˆ†é¡µã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">sort</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">SortBuilder[]</code>ï¼ŒæŒ‡å®šç»“æœæ’åºæ–¹å¼ï¼Œå¯ä»¥æ ¹æ®å­—æ®µæˆ–è‡ªå®šä¹‰æ’åºè¿›è¡Œæ’åºã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">source</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">SourceBuilder</code>ï¼Œæ§åˆ¶ <code class="language-plaintext highlighter-rouge">_source</code> å­—æ®µçš„è¾“å‡ºï¼Œå…è®¸é…ç½®å­—æ®µç­›é€‰ï¼ˆåŒ…æ‹¬ <code class="language-plaintext highlighter-rouge">includes</code> å’Œ <code class="language-plaintext highlighter-rouge">excludes</code>ï¼‰ç­‰ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">trackTotalHits</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">boolean</code>ï¼Œé»˜è®¤å€¼ï¼š<code class="language-plaintext highlighter-rouge">true</code>ï¼ŒæŒ‡å®šæ˜¯å¦åœ¨è¿”å›çš„ç»“æœä¸­åŒ…å«æ€»å‘½ä¸­æ•°ã€‚è®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">false</code> å¯ä»¥æé«˜æ€§èƒ½ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">aggregations</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">AggregationBuilder</code>ï¼Œç”¨äºæŒ‡å®šèšåˆæŸ¥è¯¢ï¼Œå…è®¸æ‰§è¡Œå¦‚ <code class="language-plaintext highlighter-rouge">terms</code>ã€<code class="language-plaintext highlighter-rouge">range</code> ç­‰èšåˆæ“ä½œã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">highlight</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">HighlightBuilder</code>ï¼Œç”¨äºæŒ‡å®šé«˜äº®æ˜¾ç¤ºçš„å­—æ®µã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">suggest</code></strong>ï¼šç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">SuggestBuilder</code>ï¼ŒæŒ‡å®šæœç´¢å»ºè®®ï¼ˆsuggestï¼‰æ“ä½œã€‚</p>

<p><strong>ä¸»è¦æ–¹æ³•ï¼š</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">index(String... index)</code></strong>ï¼šè®¾ç½®è¦æŸ¥è¯¢çš„ç´¢å¼•åç§°ã€‚å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªç´¢å¼•åç§°ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">query(QueryBuilder query)</code></strong>ï¼šè®¾ç½®æŸ¥è¯¢æ¡ä»¶ï¼Œ<code class="language-plaintext highlighter-rouge">query</code> æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">QueryBuilder</code> å¯¹è±¡ï¼Œå¯ä»¥æ˜¯å„ç§ç±»å‹çš„æŸ¥è¯¢ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">match</code>ã€<code class="language-plaintext highlighter-rouge">term</code>ï¼‰ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">size(int size)</code></strong>ï¼šè®¾ç½®è¿”å›çš„æœ€å¤§æ–‡æ¡£æ•°ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">from(int from)</code></strong>ï¼šè®¾ç½®æŸ¥è¯¢ç»“æœçš„åç§»é‡ï¼Œç”¨äºåˆ†é¡µã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">sort(SortBuilder... sort)</code></strong>ï¼šè®¾ç½®æŸ¥è¯¢ç»“æœçš„æ’åºè§„åˆ™ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">trackTotalHits(boolean trackTotalHits)</code></strong>ï¼šè®¾ç½®æ˜¯å¦è·Ÿè¸ªæ€»å‘½ä¸­æ•°ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">source(SourceBuilder source)</code></strong>ï¼šè®¾ç½® <code class="language-plaintext highlighter-rouge">_source</code> å­—æ®µçš„ç­›é€‰æ¡ä»¶ï¼Œæ§åˆ¶è¿”å›çš„å­—æ®µå†…å®¹ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">aggregations(Map&lt;String, AggregationBuilder&gt; aggregations)</code></strong>ï¼šè®¾ç½®èšåˆæ“ä½œã€‚å¯ä»¥é€šè¿‡é”®å€¼å¯¹å½¢å¼æŒ‡å®šå¤šä¸ªèšåˆæ“ä½œã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">highlight(HighlightBuilder highlight)</code></strong>ï¼šè®¾ç½®é«˜äº®æ˜¾ç¤ºçš„å­—æ®µã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">suggest(SuggestBuilder suggest)</code></strong>ï¼šè®¾ç½®æŸ¥è¯¢å»ºè®®ï¼Œä¸»è¦ç”¨äºæ‹¼å†™å»ºè®®æˆ–æœç´¢å»ºè®®ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">explain(boolean explain)</code></strong>ï¼šè®¾ç½®æ˜¯å¦è¿”å›æŸ¥è¯¢çš„è¯¦ç»†è¯„åˆ†è§£é‡Šã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">profile(boolean profile)</code></strong>ï¼šè®¾ç½®æ˜¯å¦å¯ç”¨æ€§èƒ½åˆ†æï¼Œä»¥å¸®åŠ©ç†è§£æŸ¥è¯¢æ‰§è¡Œçš„è¯¦ç»†æƒ…å†µã€‚</p>

<p><code class="language-plaintext highlighter-rouge">SearchRequest</code> æ˜¯æ„å»ºå’Œæ‰§è¡Œ Elasticsearch æŸ¥è¯¢çš„æ ¸å¿ƒå¯¹è±¡ï¼Œå®ƒå…è®¸è®¾ç½®æŸ¥è¯¢çš„ç´¢å¼•ã€æŸ¥è¯¢æ¡ä»¶ã€åˆ†é¡µå‚æ•°ã€æ’åºã€èšåˆç­‰ã€‚é€šè¿‡å¯¹ <code class="language-plaintext highlighter-rouge">SearchSourceBuilder</code> è¿›è¡Œæ„é€ ï¼Œèƒ½å¤Ÿè¿›ä¸€æ­¥æŒ‡å®šæŸ¥è¯¢çš„ç»†èŠ‚ã€‚</p>

<hr />

<h4 id="searchresponse"><code class="language-plaintext highlighter-rouge">SearchResponse</code></h4>

<p>åœ¨ Elasticsearch 8.x ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">SearchResponse</code> ç±»æ˜¯ä¸€ä¸ªå°è£…äº†æœç´¢ç»“æœçš„å¯¹è±¡ï¼ŒåŒ…å«äº†æœç´¢æŸ¥è¯¢çš„å“åº”ä¿¡æ¯ã€‚å®ƒç»§æ‰¿è‡ª <code class="language-plaintext highlighter-rouge">BaseResponse</code> ç±»ï¼Œå¹¶æä¾›äº†å¤šä¸ªå­—æ®µå’Œæ–¹æ³•æ¥å¤„ç†æœç´¢ç»“æœã€‚</p>

<p>ä¸»è¦å­—æ®µï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">hits</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">SearchHits</code>ï¼Œè¡¨ç¤ºæœç´¢åˆ°çš„æ‰€æœ‰å‘½ä¸­çš„æ–‡æ¡£ã€‚é€šè¿‡è¿™ä¸ªå­—æ®µå¯ä»¥è®¿é—®æ‰€æœ‰åŒ¹é…çš„æ–‡æ¡£ï¼Œä»¥åŠå®ƒä»¬çš„å¾—åˆ†ã€æ’åºç­‰ä¿¡æ¯ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">aggregations</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Aggregations</code>ï¼ŒåŒ…å«èšåˆç»“æœã€‚èšåˆæ˜¯ Elasticsearch æä¾›çš„ä¸€ç§å¼ºå¤§åŠŸèƒ½ï¼Œç”¨äºå¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ã€æ±‚å’Œã€å¹³å‡ç­‰æ“ä½œã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">suggest</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Map&lt;String, List&lt;Suggest.Suggestion&lt;T&gt;&gt;&gt;</code>ï¼ŒåŒ…å«æœç´¢å»ºè®®ï¼ˆå¦‚æœæŸ¥è¯¢ä½¿ç”¨äº†å»ºè®®åŠŸèƒ½ï¼‰ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">scrollId</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">String</code>ï¼Œåœ¨ä½¿ç”¨æ»šåŠ¨æŸ¥è¯¢æ—¶ï¼Œè¿”å›ä¸€ä¸ª scrollIdï¼Œç”¨äºè·å–æ¥ä¸‹æ¥çš„ç»“æœã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">took</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">long</code>ï¼Œè¡¨ç¤ºæ‰§è¡ŒæŸ¥è¯¢æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">timedOut</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">boolean</code>ï¼Œè¡¨ç¤ºæœç´¢æ˜¯å¦è¶…æ—¶ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">shards</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Shards</code>ï¼ŒåŒ…å«æœç´¢è¿‡ç¨‹ä¸­æ¶‰åŠçš„æ‰€æœ‰åˆ†ç‰‡çš„ä¿¡æ¯ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">total</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">long</code>ï¼Œè¡¨ç¤ºæŸ¥è¯¢åŒ¹é…çš„æ–‡æ¡£æ€»æ•°ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">failedShards</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">List&lt;FailedShard&gt;</code>ï¼Œè¡¨ç¤ºæŸ¥è¯¢è¿‡ç¨‹ä¸­å¤±è´¥çš„åˆ†ç‰‡ä¿¡æ¯ã€‚</p>

<p>ä¸»è¦æ–¹æ³•ï¼šä¸å­—æ®µåŒåã€‚</p>

<p>è¿™äº›å­—æ®µå’Œæ–¹æ³•æä¾›äº†å¯¹ Elasticsearch æœç´¢å“åº”çš„å…¨é¢è®¿é—®ï¼Œèƒ½å¤Ÿè®©ä½ è·å–æŸ¥è¯¢ç»“æœã€èšåˆç»“æœã€å»ºè®®ã€æ‰§è¡Œæ—¶é—´ç­‰é‡è¦ä¿¡æ¯ã€‚</p>

<hr />

<h4 id="hitsmetadata"><code class="language-plaintext highlighter-rouge">HitsMetadata</code></h4>

<p>åœ¨ Elasticsearch 8.x ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">HitsMetadata</code> æ˜¯ä¸€ä¸ªç”¨æ¥è¡¨ç¤ºæœç´¢ç»“æœå…ƒæ•°æ®çš„ç±»ï¼Œä¸»è¦ç”¨äºå°è£…æœç´¢å‘½ä¸­çš„å…ƒä¿¡æ¯ï¼Œå¦‚æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_id</code>ã€å¾—åˆ†ï¼ˆscoreï¼‰ã€æ’åºç­‰ã€‚å®ƒæ˜¯ <code class="language-plaintext highlighter-rouge">SearchHits</code> ä¸­ <code class="language-plaintext highlighter-rouge">Hits</code> æ•°ç»„ä¸­å•ä¸ªå‘½ä¸­çš„å…ƒæ•°æ®ã€‚</p>

<p>ä¸»è¦å­—æ®µï¼š
<strong><code class="language-plaintext highlighter-rouge">_id</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">String</code>ï¼Œæ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå³ <code class="language-plaintext highlighter-rouge">_id</code> å­—æ®µã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">_index</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">String</code>ï¼Œæ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•åç§°ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">_score</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Float</code>ï¼Œæ–‡æ¡£çš„å¾—åˆ†ï¼Œè¡¨ç¤ºè¯¥æ–‡æ¡£ä¸æŸ¥è¯¢æ¡ä»¶çš„åŒ¹é…åº¦ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">_source</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>ï¼Œæ–‡æ¡£çš„åŸå§‹æ•°æ®ï¼ˆå³ <code class="language-plaintext highlighter-rouge">_source</code> å­—æ®µï¼‰ï¼Œå®ƒæ˜¯å­˜å‚¨åœ¨ Elasticsearch ä¸­çš„å®é™…å†…å®¹ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">_routing</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">String</code>ï¼Œè·¯ç”±ä¿¡æ¯ï¼Œç”¨äºç¡®å®šæ–‡æ¡£æ‰€åœ¨çš„åˆ†ç‰‡ï¼ˆå¦‚æœå¯ç”¨äº†è·¯ç”±ï¼‰ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">_version</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Long</code>ï¼Œæ–‡æ¡£çš„ç‰ˆæœ¬å·ï¼Œé€‚ç”¨äºå¯ç”¨äº†ç‰ˆæœ¬æ§åˆ¶çš„ç´¢å¼•ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">fields</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Map&lt;String, List&lt;Object&gt;&gt;</code>ï¼Œå­˜å‚¨æŸ¥è¯¢æ—¶è¯·æ±‚çš„å­—æ®µå€¼ã€‚å¦‚æœåœ¨æŸ¥è¯¢ä¸­æŒ‡å®šäº†è¿”å›ç‰¹å®šå­—æ®µï¼Œé‚£ä¹ˆè¿™äº›å­—æ®µå°†åŒ…å«åœ¨ <code class="language-plaintext highlighter-rouge">fields</code> ä¸­ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">highlight</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Map&lt;String, List&lt;String&gt;&gt;</code>ï¼Œé«˜äº®æ˜¾ç¤ºçš„å­—æ®µï¼Œå¦‚æœæŸ¥è¯¢ä¸­ä½¿ç”¨äº†é«˜äº®åŠŸèƒ½ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">sort</code></strong>ï¼Œç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">List&lt;Object&gt;</code>ï¼Œæ–‡æ¡£çš„æ’åºå€¼ã€‚å¦‚æœæŸ¥è¯¢ä½¿ç”¨äº†æ’åºåŠŸèƒ½ï¼Œ<code class="language-plaintext highlighter-rouge">sort</code> å­—æ®µä¸­å°†åŒ…å«æ’åºåçš„ç»“æœã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">hits</code></strong>,ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">List&lt;Hit&lt;T&gt;&gt;</code>,ç”¨äºåµŒå¥—æŸ¥è¯¢çš„å†…åµŒå‘½ä¸­ç»“æœï¼ˆä¾‹å¦‚ï¼Œnested æŸ¥è¯¢æˆ–å­æŸ¥è¯¢çš„ç»“æœï¼‰ã€‚å¦‚æœæŸ¥è¯¢åŒ…å«åµŒå¥—æˆ–å­æŸ¥è¯¢ï¼Œ<code class="language-plaintext highlighter-rouge">hits</code> å°†åŒ…å«è¿™äº›ç»“æœã€‚</p>

<p>ä¸»è¦æ–¹æ³•ï¼šä¸å­—æ®µåŒåã€‚</p>

<p><code class="language-plaintext highlighter-rouge">HitsMetadata</code> ç±»æ˜¯ç”¨äºå°è£… Elasticsearch æŸ¥è¯¢ç»“æœä¸­çš„å•ä¸ªå‘½ä¸­æ–‡æ¡£çš„å…ƒæ•°æ®ã€‚å®ƒæä¾›äº†æ–‡æ¡£çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚ IDã€ç´¢å¼•ã€å¾—åˆ†ç­‰ï¼Œå¹¶æ”¯æŒè·å–é«˜äº®ã€æ’åºã€å­—æ®µç­‰é™„åŠ ä¿¡æ¯ã€‚é€šè¿‡è¿™äº›å­—æ®µå’Œæ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ–¹ä¾¿åœ°å¤„ç†å’Œè®¿é—®æŸ¥è¯¢ç»“æœä¸­çš„å„ç§æ•°æ®ã€‚</p>

<h4 id="hit"><code class="language-plaintext highlighter-rouge">Hit</code></h4>

<p>è¿™æ˜¯ä¸€ä¸ª Elasticsearch æŸ¥è¯¢è¿”å›ç»“æœçš„è¡¨ç¤ºç±»ï¼Œé€šå¸¸ç”¨äºå­˜å‚¨ä» Elasticsearch ä¸­æŸ¥è¯¢åˆ°çš„å•ä¸ªæ–‡æ¡£çš„ä¿¡æ¯ã€‚è¯¥ç±»å¯ä»¥åŒ…å«å¤šä¸ªå­—æ®µï¼ŒåŒ…æ‹¬æ–‡æ¡£ IDã€ç´¢å¼•ã€å¾—åˆ†ã€å­—æ®µå†…å®¹ã€å†…åµŒæŸ¥è¯¢ç»“æœã€æ’åºä¿¡æ¯ç­‰ã€‚</p>

<p>ä¸»è¦å­—æ®µè§£é‡Šï¼š</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">index</code></strong>: è¿”å›æ–‡æ¡£æ‰€åœ¨çš„ç´¢å¼•åç§°ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">id</code></strong>: è¿”å›æ–‡æ¡£çš„ IDã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">score</code></strong>: æŸ¥è¯¢å¾—åˆ†ï¼Œé€šå¸¸æ˜¯ç›¸å…³æ€§è¯„åˆ†ï¼Œè¡¨ç¤ºæ–‡æ¡£ä¸æŸ¥è¯¢çš„åŒ¹é…åº¦ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">explanation</code></strong>: æŸ¥è¯¢è§£é‡Šï¼ŒåŒ…å«å¦‚ä½•è®¡ç®—å¾—åˆ†çš„ä¿¡æ¯ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">fields</code></strong>: æ–‡æ¡£çš„å­—æ®µæ•°æ®ï¼Œè¿™äº›å­—æ®µæ˜¯é¢å¤–çš„è‡ªå®šä¹‰å­—æ®µï¼ˆé€šå¸¸æ˜¯ <code class="language-plaintext highlighter-rouge">_source</code> ä¹‹å¤–çš„å­—æ®µï¼‰ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">highlight</code></strong>: é«˜äº®æ˜¾ç¤ºçš„å­—æ®µï¼Œç”¨äºæ ‡æ˜æŸ¥è¯¢ä¸­åŒ¹é…çš„éƒ¨åˆ†ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">innerHits</code></strong>: å†…åµŒæŸ¥è¯¢çš„ç»“æœï¼Œç”¨äºæŸ¥è¯¢åŒ…å«å­æ–‡æ¡£çš„æƒ…å†µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">matchedQueries</code></strong>: åŒ¹é…åˆ°çš„æŸ¥è¯¢æ¡ä»¶ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">nested</code></strong>: å¦‚æœæ–‡æ¡£æ˜¯åµŒå¥—ç±»å‹ï¼ŒåŒ…å«åµŒå¥—æ–‡æ¡£çš„ä¿¡æ¯ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">ignored</code></strong>: è¢«å¿½ç•¥çš„å­—æ®µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">ignoredFieldValues</code></strong>: è¢«å¿½ç•¥å­—æ®µçš„å…·ä½“å€¼ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">shard</code></strong>: è¯¥æ–‡æ¡£æ‰€åœ¨çš„åˆ†ç‰‡ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">node</code></strong>: å­˜å‚¨è¯¥æ–‡æ¡£çš„ Elasticsearch èŠ‚ç‚¹ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">routing</code></strong>: è·¯ç”±ä¿¡æ¯ï¼Œå¸®åŠ©ç¡®å®šæ–‡æ¡£æ‰€åœ¨çš„åˆ†ç‰‡ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">source</code></strong>: æ–‡æ¡£çš„æºæ•°æ®ï¼Œé€šå¸¸æ˜¯åŸå§‹çš„ JSON æ•°æ®ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">seqNo</code></strong>: æ–‡æ¡£çš„åºåˆ—å·ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">primaryTerm</code></strong>: æ–‡æ¡£çš„ä¸»ç‰ˆæœ¬å·ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">version</code></strong>: æ–‡æ¡£çš„ç‰ˆæœ¬å·ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">sort</code></strong>: æ’åºä¿¡æ¯ï¼Œè®°å½•æ–‡æ¡£çš„æ’åºå­—æ®µã€‚</li>
</ul>

<p>å¦‚æœä½ éœ€è¦æŸ¥è¯¢æŸäº›æ–‡æ¡£å¹¶è·å–å®ƒä»¬çš„ç»“æœï¼Œä½ å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Hit</code> ç±»æ¥è¡¨ç¤ºè¿™äº›æ–‡æ¡£ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SearchRequest</span> <span class="n">searchRequest</span> <span class="o">=</span> <span class="nc">SearchRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
        <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"elasticsearch"</span><span class="o">))</span>  <span class="c1">// æŸ¥è¯¢æ¡ä»¶ï¼šåŒ¹é… 'title' å­—æ®µ</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">priceSort</span><span class="o">,</span> <span class="n">publishDateSort</span><span class="o">,</span> <span class="n">nameSort</span><span class="o">)</span>
<span class="o">);</span>

<span class="c1">// å‡è®¾è¿”å›çš„ç»“æœæ˜¯ Hit å¯¹è±¡</span>
<span class="nc">Hit</span><span class="o">&lt;</span><span class="nc">MyDocument</span><span class="o">&gt;</span> <span class="n">hit</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">hits</span><span class="o">().</span><span class="na">hits</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="nc">MyDocument</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">source</span><span class="o">();</span> <span class="c1">// è·å–æ–‡æ¡£æºæ•°æ®</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Hit&lt;TDocument&gt;</code> ç±»è¡¨ç¤º Elasticsearch æŸ¥è¯¢è¿”å›çš„å•ä¸ªæ–‡æ¡£ï¼Œå¹¶åŒ…å«äº†ä¸°å¯Œçš„å…ƒæ•°æ®ï¼Œå¦‚æ–‡æ¡£å¾—åˆ†ã€æ’åºä¿¡æ¯ã€å†…åµŒæŸ¥è¯¢ç»“æœç­‰ã€‚å®ƒå¯ä»¥æ ¹æ®ä¸åŒçš„æŸ¥è¯¢éœ€æ±‚å’Œæ–‡æ¡£ç±»å‹çµæ´»é…ç½®ï¼Œå¹¶æä¾›äº†åºåˆ—åŒ–å’Œè½¬æ¢ä¸º JSON çš„åŠŸèƒ½ã€‚</p>

<h4 id="sourcefilter-1"><code class="language-plaintext highlighter-rouge">SourceFilter</code></h4>

<p><strong><code class="language-plaintext highlighter-rouge">SourceFilter</code> ç±»çš„å¸¸ç”¨å­—æ®µä¸æ–¹æ³•</strong>ï¼š</p>

<p>ç”¨äºæŒ‡å®šå“ªäº›å­—æ®µåŒ…å«æˆ–æ’é™¤åœ¨è¿”å›ç»“æœä¸­ã€‚</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">includes(String... fields)</code></strong>ï¼šæŒ‡å®šè¦è¿”å›çš„å­—æ®µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">excludes(String... fields)</code></strong>ï¼šæŒ‡å®šä¸è¿”å›çš„å­—æ®µã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SearchResponse</span><span class="o">&lt;</span><span class="nc">MyDocument</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"price"</span><span class="o">).</span><span class="na">excludes</span><span class="o">(</span><span class="s">"description"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"category"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"electronics"</span><span class="o">))),</span>
    <span class="nc">MyDocument</span><span class="o">.</span><span class="na">class</span>
<span class="o">);</span>
</code></pre></div></div>

<p>åŒæ›´æ–°çš„<code class="language-plaintext highlighter-rouge">SourceFilter</code>ã€‚</p>

<h4 id="ç‰¹æ®Šå­—æ®µ">ç‰¹æ®Šå­—æ®µ</h4>

<p>åœ¨ Elasticsearch ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">keyword</code> æ˜¯ä¸€ç§ç‰¹æ®Šçš„å­—æ®µç±»å‹ï¼Œå®ƒé€šå¸¸ç”¨äºä¸åˆ†è¯ï¼ˆå³ä¸è¢«åˆ†å‰²æˆå¤šä¸ªè¯é¡¹ï¼‰çš„å­—æ®µã€‚é™¤äº† <code class="language-plaintext highlighter-rouge">keyword</code> ç±»å‹ï¼ŒElasticsearch è¿˜æ”¯æŒå…¶ä»–ä¸€äº›ç‰¹æ®Šçš„å­—æ®µæ ‡è¯†ç¬¦ï¼ˆå­—æ®µç±»å‹ï¼‰ï¼Œè¿™äº›æ ‡è¯†ç¬¦åœ¨åˆ›å»ºæ˜ å°„æ—¶å¯ä»¥æŒ‡å®šã€‚ä»¥ä¸‹æ˜¯å¸¸è§çš„ä¸€äº›ç‰¹æ®Šå­—æ®µç±»å‹ï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">keyword</code></strong>ï¼Œæ ‡è¯†éœ€è¦ç²¾ç¡®åŒ¹é…çš„å­—æ®µï¼Œé€šå¸¸ç”¨äº IDã€æ ‡ç­¾ã€é‚®ç®±ã€åŸŸåç­‰å­—æ®µã€‚å­—æ®µçš„å†…å®¹ä¸ä¼šè¢«åˆ†è¯ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥ç´¢å¼•ã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">tagInfoList.tagList.keyword</code></li>
  <li>ä¾‹å¦‚ï¼š<code class="language-plaintext highlighter-rouge">"tagList": ["tag1", "tag2", "tag3"]</code></li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">text</code></strong>ï¼Œæ ‡è¯†éœ€è¦è¢«åˆ†è¯çš„å­—æ®µï¼Œé€šå¸¸ç”¨äºéœ€è¦è¿›è¡Œå…¨æ–‡æœç´¢çš„å­—æ®µã€‚ä¾‹å¦‚ï¼Œæ–‡ç« çš„å†…å®¹ã€è¯„è®ºã€æè¿°ç­‰å­—æ®µé€šå¸¸ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">text</code> ç±»å‹ã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">title</code>, <code class="language-plaintext highlighter-rouge">description</code></li>
  <li>Elasticsearch ä¼šå¯¹ <code class="language-plaintext highlighter-rouge">text</code> ç±»å‹çš„å­—æ®µè¿›è¡Œåˆ†è¯å¤„ç†ï¼Œæ”¯æŒå…¨æ–‡æœç´¢ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">date</code></strong>ï¼Œè¡¨ç¤ºæ—¥æœŸæ—¶é—´æ•°æ®ã€‚é€šå¸¸ç”¨äºè¡¨ç¤ºæ—¶é—´æˆ³ã€äº‹ä»¶æ—¥æœŸç­‰ã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">createdDate</code>, <code class="language-plaintext highlighter-rouge">publishDate</code></li>
  <li>æ”¯æŒå¤šç§æ ¼å¼ï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">yyyy-MM-dd</code>, <code class="language-plaintext highlighter-rouge">yyyy-MM-dd HH:mm:ss</code> ç­‰ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">long</code>, <code class="language-plaintext highlighter-rouge">integer</code>, <code class="language-plaintext highlighter-rouge">short</code>, <code class="language-plaintext highlighter-rouge">byte</code>, <code class="language-plaintext highlighter-rouge">double</code>, <code class="language-plaintext highlighter-rouge">float</code></strong>,è¿™äº›æ˜¯æ•°å€¼ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºæ•´æ•°å’Œæµ®ç‚¹æ•°ã€‚ä¸åŒçš„ç±»å‹æœ‰ä¸åŒçš„å­˜å‚¨èŒƒå›´ã€‚
<strong>ç”¨æ³•</strong>ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">price</code> (æµ®åŠ¨æ•°å€¼)</li>
  <li><code class="language-plaintext highlighter-rouge">quantity</code> (æ•´æ•°)</li>
  <li><code class="language-plaintext highlighter-rouge">timestamp</code> (é•¿æ•´å‹æ—¶é—´æˆ³)</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">boolean</code></strong>ï¼Œè¡¨ç¤ºå¸ƒå°”å€¼ï¼Œé€šå¸¸æ˜¯ <code class="language-plaintext highlighter-rouge">true</code> æˆ– <code class="language-plaintext highlighter-rouge">false</code>ã€‚
<strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">isActive</code>, <code class="language-plaintext highlighter-rouge">isAvailable</code></p>

<p><strong><code class="language-plaintext highlighter-rouge">object</code></strong>ï¼Œè¡¨ç¤ºåµŒå¥—å¯¹è±¡ã€‚<code class="language-plaintext highlighter-rouge">object</code> å­—æ®µå¯ä»¥åŒ…å«å¤æ‚çš„ç»“æ„ï¼Œç±»ä¼¼ JSON å¯¹è±¡ã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">address</code>, <code class="language-plaintext highlighter-rouge">userInfo</code></li>
  <li>åµŒå¥—å¯¹è±¡å¯ä»¥åŒ…å«å…¶ä»–å­—æ®µç±»å‹ï¼Œå¯ä»¥æ˜¯ <code class="language-plaintext highlighter-rouge">text</code>, <code class="language-plaintext highlighter-rouge">keyword</code>, <code class="language-plaintext highlighter-rouge">integer</code> ç­‰ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">nested</code></strong></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">nested</code> ç±»å‹æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ <code class="language-plaintext highlighter-rouge">object</code> ç±»å‹ï¼Œç”¨äºå¤„ç†æ•°ç»„ä¸­çš„å¯¹è±¡ã€‚å®ƒä¸ºæ•°ç»„ä¸­çš„æ¯ä¸ªå¯¹è±¡åˆ†é…ä¸€ä¸ªå•ç‹¬çš„æ–‡æ¡£ï¼Œå¯ä»¥åœ¨æŸ¥è¯¢æ—¶è¿›è¡ŒåµŒå¥—æŸ¥è¯¢ã€‚</li>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">comments</code> ï¼ˆè¯„è®ºåˆ—è¡¨ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">nested</code> ç±»å‹ä¸ <code class="language-plaintext highlighter-rouge">object</code> ç±»å‹ç±»ä¼¼ï¼Œä½†å®ƒä¸ºæ¯ä¸ªå­æ–‡æ¡£åˆ›å»ºäº†ä¸€ä¸ªç‹¬ç«‹çš„æŸ¥è¯¢ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">nested</code> æŸ¥è¯¢è¿›è¡Œé«˜æ•ˆæŸ¥è¯¢ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">geo_point</code></strong>ï¼Œè¡¨ç¤ºåœ°ç†ä½ç½®æ•°æ®ï¼Œé€šå¸¸ç”¨äºå­˜å‚¨ç»çº¬åº¦ã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">location</code> æˆ– <code class="language-plaintext highlighter-rouge">coordinates</code></li>
  <li>å¯ä»¥å­˜å‚¨å¦‚ç»çº¬åº¦åæ ‡ï¼ˆ<code class="language-plaintext highlighter-rouge">latitude</code>, <code class="language-plaintext highlighter-rouge">longitude</code>ï¼‰å’Œç”¨äºåœ°ç†ä½ç½®æœç´¢ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">ip</code></strong>ï¼Œè¡¨ç¤º IP åœ°å€å­—æ®µã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">ipAddress</code>, <code class="language-plaintext highlighter-rouge">clientIp</code></li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">binary</code></strong>ï¼Œå­˜å‚¨äºŒè¿›åˆ¶æ•°æ®ï¼Œå¦‚å›¾åƒã€è§†é¢‘ç­‰ã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">image</code>, <code class="language-plaintext highlighter-rouge">fileData</code></li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">scaled_float</code></strong>ï¼Œå­˜å‚¨æµ®åŠ¨æ•°å€¼ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªç¼©æ”¾å› å­æ¥é¿å…å­˜å‚¨è¿‡å¤§çš„æ•°å­—ã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">discount_rate</code> ï¼ˆå­˜å‚¨å¸¦ç¼©æ”¾æ¯”ä¾‹çš„æµ®åŠ¨æ•°å€¼ï¼‰</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">token_count</code></strong>ï¼Œè®¡ç®—æ–‡æœ¬å­—æ®µçš„è¯é¡¹æ•°é‡ï¼Œå¯ä»¥ç”¨äºæŸäº›æŸ¥è¯¢åˆ†ææˆ–ç»Ÿè®¡ã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">wordCount</code>ï¼ˆå­˜å‚¨ä¸€ä¸ªå­—æ®µä¸­çš„è¯é¡¹æ•°ï¼‰</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">alias</code></strong>ç”¨äºåˆ›å»ºå­—æ®µåˆ«åï¼Œå®ƒä¸ä¼šå­˜å‚¨æ•°æ®ï¼Œè€Œåªæ˜¯å°†æŸ¥è¯¢æ˜ å°„åˆ°å®é™…çš„å­—æ®µã€‚</p>

<ul>
  <li><strong>ç”¨æ³•</strong>ï¼š<code class="language-plaintext highlighter-rouge">current_email</code> å¯ä»¥ä½œä¸º <code class="language-plaintext highlighter-rouge">email</code> å­—æ®µçš„åˆ«åã€‚</li>
</ul>

<p>åœ¨æŸ¥è¯¢ä¸­ï¼Œä½ å¯ä»¥æŒ‡å®šå­—æ®µç±»å‹æ¥è¿›è¡Œä¸åŒçš„æ“ä½œï¼Œä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">keyword</code> å­—æ®µç”¨äºç²¾ç¡®åŒ¹é…ï¼Œ<code class="language-plaintext highlighter-rouge">text</code> å­—æ®µç”¨äºå…¨æ–‡æœç´¢ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">nested</code> å­—æ®µåˆ™ç”¨äºå¤„ç†åµŒå¥—çš„å¯¹è±¡æ•°ç»„ç­‰ã€‚ä¸åŒçš„å­—æ®µç±»å‹é€‚ç”¨äºä¸åŒçš„åœºæ™¯ï¼Œå› æ­¤äº†è§£å®ƒä»¬çš„åŒºåˆ«å’Œç”¨é€”å¯¹äºè®¾è®¡é«˜æ•ˆçš„æŸ¥è¯¢éå¸¸é‡è¦ã€‚</p>

<p>å¦‚æœåœ¨ Elasticsearch ä¸­ä¸è®¾ç½®å­—æ®µç±»å‹ï¼ŒElasticsearch ä¼šå°è¯•æ ¹æ®æ•°æ®çš„å†…å®¹è‡ªåŠ¨æ¨æ–­å­—æ®µçš„ç±»å‹ï¼Œç§°ä¸º <strong>åŠ¨æ€æ˜ å°„</strong>ï¼ˆDynamic Mappingï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticsearch ä¼šä½¿ç”¨ä»¥ä¸‹è§„åˆ™æ¥æ¨æ–­å­—æ®µç±»å‹ï¼š</p>

<p><strong>è‡ªåŠ¨ç±»å‹æ¨æ–­ï¼ˆDynamic Mappingï¼‰</strong></p>

<ul>
  <li><strong>å­—ç¬¦ä¸²å­—æ®µï¼ˆ<code class="language-plaintext highlighter-rouge">text</code> æˆ– <code class="language-plaintext highlighter-rouge">keyword</code>ï¼‰</strong>ï¼š
    <ul>
      <li>å¦‚æœå­—æ®µå€¼æ˜¯ <strong>æ–‡æœ¬</strong> ç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²ï¼‰ï¼ŒElasticsearch é»˜è®¤å°†å…¶æ˜ å°„ä¸º <code class="language-plaintext highlighter-rouge">text</code> ç±»å‹ï¼Œé€‚ç”¨äºéœ€è¦åˆ†è¯çš„å­—æ®µã€‚å¦‚æœ Elasticsearch æ£€æµ‹åˆ°è¯¥å­—æ®µåŒ…å« URL æˆ–ç”µå­é‚®ä»¶ç­‰å¸¸è§æ ‡è¯†ç¬¦ï¼Œå®ƒå¯èƒ½ä¼šå°†å…¶æ˜ å°„ä¸º <code class="language-plaintext highlighter-rouge">keyword</code> ç±»å‹ã€‚</li>
    </ul>
  </li>
  <li><strong>æ•°å­—å­—æ®µï¼ˆ<code class="language-plaintext highlighter-rouge">long</code>, <code class="language-plaintext highlighter-rouge">integer</code>, <code class="language-plaintext highlighter-rouge">float</code>, <code class="language-plaintext highlighter-rouge">double</code>, ç­‰ï¼‰</strong>ï¼š
    <ul>
      <li>å¦‚æœå­—æ®µå€¼æ˜¯ <strong>æ•°å­—</strong> ç±»å‹ï¼ˆæ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼‰ï¼ŒElasticsearch ä¼šå°†å…¶æ˜ å°„ä¸ºåˆé€‚çš„æ•°å€¼ç±»å‹ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">long</code>, <code class="language-plaintext highlighter-rouge">integer</code>, <code class="language-plaintext highlighter-rouge">float</code>ï¼‰ã€‚</li>
    </ul>
  </li>
  <li><strong>æ—¥æœŸå­—æ®µï¼ˆ<code class="language-plaintext highlighter-rouge">date</code>ï¼‰</strong>ï¼š
    <ul>
      <li>å¦‚æœå­—æ®µå€¼æ˜¯ <strong>æ—¥æœŸæ—¶é—´æ ¼å¼</strong>ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">2022-01-01</code> æˆ– <code class="language-plaintext highlighter-rouge">1629834074</code>ï¼‰ï¼ŒElasticsearch ä¼šè‡ªåŠ¨æ¨æ–­ä¸º <code class="language-plaintext highlighter-rouge">date</code> ç±»å‹ã€‚</li>
    </ul>
  </li>
  <li><strong>å¸ƒå°”å­—æ®µï¼ˆ<code class="language-plaintext highlighter-rouge">boolean</code>ï¼‰</strong>ï¼š
    <ul>
      <li>å¦‚æœå­—æ®µå€¼æ˜¯ <strong>å¸ƒå°”å€¼</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">true</code> æˆ– <code class="language-plaintext highlighter-rouge">false</code>ï¼‰ï¼ŒElasticsearch ä¼šå°†å…¶æ˜ å°„ä¸º <code class="language-plaintext highlighter-rouge">boolean</code> ç±»å‹ã€‚</li>
    </ul>
  </li>
  <li><strong>æ•°ç»„å­—æ®µï¼ˆ<code class="language-plaintext highlighter-rouge">object</code>, <code class="language-plaintext highlighter-rouge">nested</code>ï¼‰</strong>ï¼š
    <ul>
      <li>å¦‚æœå­—æ®µå€¼æ˜¯ä¸€ä¸ª <strong>æ•°ç»„</strong>ï¼ŒElasticsearch ä¼šå°è¯•æ¨æ–­å®ƒæ˜¯ <code class="language-plaintext highlighter-rouge">array</code> ç±»å‹çš„å¯¹è±¡æˆ–åŸºæœ¬æ•°æ®ç±»å‹ã€‚å¦‚æœæ•°ç»„ä¸­çš„å…ƒç´ æ˜¯å¯¹è±¡ï¼Œåˆ™ä¼šæ¨æ–­ä¸º <code class="language-plaintext highlighter-rouge">nested</code> ç±»å‹ï¼›å¦‚æœæ˜¯ç®€å•ç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•°å­—ï¼‰ï¼Œåˆ™ä¼šæ ¹æ®å…ƒç´ ç±»å‹æ¨æ–­ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>åŠ¨æ€æ˜ å°„çš„è¡Œä¸º</strong></p>

<ul>
  <li><strong>åŠ¨æ€å¯ç”¨</strong>ï¼šåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticsearch å¯ç”¨åŠ¨æ€æ˜ å°„ã€‚è¿™æ„å‘³ç€å¦‚æœç´¢å¼•çš„æ˜ å°„ä¸­æ²¡æœ‰æ˜ç¡®æŒ‡å®šæŸä¸ªå­—æ®µç±»å‹ï¼ŒElasticsearch ä¼šå°è¯•æ ¹æ®æ–‡æ¡£ä¸­çš„æ•°æ®æ¨æ–­å‡ºå­—æ®µçš„ç±»å‹ã€‚</li>
  <li><strong>åŠ¨æ€ç¦ç”¨</strong>ï¼šä½ ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">dynamic: false</code> æ¥ç¦ç”¨åŠ¨æ€æ˜ å°„ï¼Œé˜²æ­¢ Elasticsearch è‡ªåŠ¨åˆ›å»ºæ–°å­—æ®µçš„æ˜ å°„ã€‚æ­¤æ—¶ï¼Œå¦‚æœæ–‡æ¡£ä¸­åŒ…å«æœªçŸ¥å­—æ®µï¼ŒElasticsearch ä¼šæ‹’ç»è¯¥æ–‡æ¡£ã€‚æ­¤é€‰é¡¹é€‚ç”¨äºå¯¹æ•°æ®æ ¼å¼è¦æ±‚ä¸¥æ ¼çš„åœºæ™¯ã€‚</li>
  <li><strong>åŠ¨æ€æ¨¡æ¿</strong>ï¼šä½ è¿˜å¯ä»¥ä½¿ç”¨ <strong>åŠ¨æ€æ¨¡æ¿</strong> æ¥å¯¹å­—æ®µçš„ç±»å‹è¿›è¡Œç²¾ç¡®æ§åˆ¶ï¼Œä¾‹å¦‚ï¼ŒæŒ‡å®šæŸäº›å­—æ®µè‡ªåŠ¨æ˜ å°„ä¸º <code class="language-plaintext highlighter-rouge">keyword</code> ç±»å‹ï¼Œæˆ–è€…æ ¹æ®å­—æ®µåç§°è‡ªåŠ¨ä½¿ç”¨ç‰¹å®šçš„æ•°æ®ç±»å‹ã€‚</li>
</ul>

<p><strong>æ²¡æœ‰æ˜¾å¼è®¾ç½®å­—æ®µç±»å‹çš„åæœ</strong>
å¦‚æœä½ æ²¡æœ‰ä¸ºæŸä¸ªå­—æ®µè®¾ç½®æ˜ç¡®çš„ç±»å‹ï¼ŒElasticsearch ä¼šæŒ‰ä»¥ä¸‹æ–¹å¼å¤„ç†ï¼š</p>

<ul>
  <li><strong>å­—ç¬¦ä¸²ç±»å‹</strong>ï¼šé€šå¸¸ä¼šè¢«è‡ªåŠ¨æ¨æ–­ä¸º <code class="language-plaintext highlighter-rouge">text</code> ç±»å‹ï¼Œä½†å¦‚æœè¯¥å­—æ®µçš„å†…å®¹è¡¨ç°å‡ºæŸäº›æ¨¡å¼ï¼ˆå¦‚ URLã€ç”µå­é‚®ä»¶åœ°å€ã€IP åœ°å€ç­‰ï¼‰ï¼Œå¯èƒ½ä¼šè¢«æ¨æ–­ä¸º <code class="language-plaintext highlighter-rouge">keyword</code> ç±»å‹ã€‚</li>
  <li><strong>æ•°å€¼ç±»å‹</strong>ï¼šä¼šè‡ªåŠ¨æ¨æ–­ä¸ºæ•´æ•°ã€é•¿æ•´å‹ã€æµ®åŠ¨æ•°å€¼æˆ–åŒç²¾åº¦æµ®åŠ¨æ•°å€¼ï¼Œå…·ä½“å–å†³äºè¾“å…¥çš„å€¼ã€‚</li>
  <li><strong>æ—¥æœŸç±»å‹</strong>ï¼šå¦‚æœå­—æ®µå€¼çœ‹èµ·æ¥æ˜¯æ—¥æœŸæ ¼å¼ï¼ŒElasticsearch ä¼šè‡ªåŠ¨å°†å…¶æ˜ å°„ä¸º <code class="language-plaintext highlighter-rouge">date</code> ç±»å‹ã€‚</li>
  <li><strong>æœªçŸ¥å­—æ®µ</strong>ï¼šå¦‚æœä¸€ä¸ªå­—æ®µçš„ç±»å‹æ— æ³•è‡ªåŠ¨æ¨æ–­ï¼ŒElasticsearch ä¼šå°è¯•å°†å®ƒæ˜ å°„ä¸º <code class="language-plaintext highlighter-rouge">text</code> æˆ–å…¶ä»–å¸¸è§ç±»å‹ï¼Œå¹¶ä¸”ä½ å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">dynamic</code> è®¾ç½®æ§åˆ¶æ˜¯å¦å…è®¸è‡ªåŠ¨åˆ›å»ºå­—æ®µã€‚</li>
</ul>

<p><strong>ä½¿ç”¨åŠ¨æ€æ¨¡æ¿è¿›è¡Œæ§åˆ¶</strong>
åŠ¨æ€æ¨¡æ¿å…è®¸ä½ é€šè¿‡é¢„å®šä¹‰è§„åˆ™æ§åˆ¶å­—æ®µçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ å¸Œæœ›æ‰€æœ‰å¸¦ <code class="language-plaintext highlighter-rouge">.id</code> åç¼€çš„å­—æ®µéƒ½æ˜ å°„ä¸º <code class="language-plaintext highlighter-rouge">keyword</code> ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„åŠ¨æ€æ¨¡æ¿ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"mappings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dynamic_templates"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"strings_as_keywords"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*_id"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"mapping"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"keyword"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>ç¦ç”¨åŠ¨æ€æ˜ å°„</strong>
å¦‚æœä½ å¸Œæœ›ç¦æ­¢è‡ªåŠ¨åˆ›å»ºæ–°å­—æ®µï¼Œå¯ä»¥è®¾ç½® <code class="language-plaintext highlighter-rouge">dynamic: false</code> æ¥ç¦ç”¨åŠ¨æ€æ˜ å°„ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"mappings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dynamic"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong>é»˜è®¤æƒ…å†µä¸‹</strong>ï¼Œå¦‚æœä¸æ˜¾å¼æŒ‡å®šå­—æ®µç±»å‹ï¼ŒElasticsearch ä¼šæ ¹æ®å­—æ®µå€¼çš„ç±»å‹è‡ªåŠ¨æ¨æ–­å­—æ®µçš„ç±»å‹ï¼Œé‡‡ç”¨åŠ¨æ€æ˜ å°„ã€‚</li>
  <li>å¯¹äºå¤§å¤šæ•°åº”ç”¨ï¼ŒElasticsearch çš„è‡ªåŠ¨ç±»å‹æ¨æ–­è¶³å¤Ÿå¥½ï¼Œä½†æ˜¯åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œç‰¹åˆ«æ˜¯å½“æ•°æ®ç»“æ„å¤æ‚æ—¶ï¼Œæ˜¾å¼åœ°æŒ‡å®šå­—æ®µç±»å‹å¯ä»¥æé«˜ç´¢å¼•çš„æ€§èƒ½å’Œå‡†ç¡®æ€§ï¼Œé¿å…ä¸å¿…è¦çš„ç±»å‹æ¨æ–­é”™è¯¯ã€‚</li>
</ul>

<h4 id="query"><code class="language-plaintext highlighter-rouge">Query</code></h4>

<p>åœ¨ Elasticsearch ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">Query</code> æ˜¯ä¸€ä¸ªé¡¶çº§æ¥å£ï¼Œé€šå¸¸ä¸ <code class="language-plaintext highlighter-rouge">bool</code> æŸ¥è¯¢ã€<code class="language-plaintext highlighter-rouge">term</code> æŸ¥è¯¢ã€<code class="language-plaintext highlighter-rouge">terms</code> æŸ¥è¯¢ç­‰ç»“åˆä½¿ç”¨ã€‚æŸ¥è¯¢é€šå¸¸æ˜¯é€šè¿‡æ„å»ºå™¨æ¨¡å¼æ¥åˆ›å»ºçš„ï¼Œå…è®¸æˆ‘ä»¬çµæ´»åœ°ç»„åˆæŸ¥è¯¢æ¡ä»¶ã€‚</p>

<p><strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šå¯¹éæ•°å­—å’Œå¸ƒå°”ç±»å‹åˆ†è¯ï¼Œå› æ­¤å¦‚æœä¸è¦åˆ†è¯ï¼Œè¯·åœ¨å­—æ®µåé¢åŠ åç¼€<code class="language-plaintext highlighter-rouge">.keyword</code>ã€‚</strong></p>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">Query</code> çš„å¸¸ç”¨æ„å»ºæ–¹å¼</strong>ï¼š</p>

<h5 id="match"><code class="language-plaintext highlighter-rouge">match</code></h5>

<p>å…¨è¯åŒ¹é…æŸ¥è¯¢ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"elasticsearch"</span><span class="o">)));</span>
</code></pre></div></div>

<hr />

<h5 id="term"><code class="language-plaintext highlighter-rouge">term</code></h5>

<p>ç”¨äºç²¾ç¡®åŒ¹é…æŸä¸ªå­—æ®µçš„å€¼ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">term</span><span class="o">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"123"</span><span class="o">)));</span>
</code></pre></div></div>

<hr />

<h5 id="terms"><code class="language-plaintext highlighter-rouge">terms</code></h5>

<p>ç”¨äºåŒ¹é…å¤šä¸ªå€¼ï¼Œé€šå¸¸ç”¨äºå­—æ®µçš„å¤šä¸ªå¯èƒ½å€¼æŸ¥è¯¢ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.query(
        q -&gt; q.terms(
                t -&gt; t.field("id").terms(tm -&gt;
                        tm.value(List.of(FieldValue.of("123"),FieldValue.of("456")))
                )
        )
)
</code></pre></div></div>

<hr />

<h5 id="bool"><code class="language-plaintext highlighter-rouge">bool</code></h5>

<p>å¸ƒå°”æŸ¥è¯¢ï¼Œç”¨äºç»„åˆå¤šä¸ªæŸ¥è¯¢æ¡ä»¶ã€‚åŒ…æ‹¬ <code class="language-plaintext highlighter-rouge">must</code>ã€<code class="language-plaintext highlighter-rouge">should</code> å’Œ <code class="language-plaintext highlighter-rouge">mustNot</code> ç­‰ã€‚ä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">must</code> è¡¨ç¤ºæŸ¥è¯¢ç»“æœå¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">should</code> è¡¨ç¤ºæŸ¥è¯¢ç»“æœæœ€å¥½åŒ¹é…çš„æ¡ä»¶ï¼ˆä½†ä¸æ˜¯å¿…é¡»çš„ï¼‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
    <span class="o">.</span><span class="na">must</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m1</span> <span class="o">-&gt;</span> <span class="n">m1</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"elasticsearch"</span><span class="o">)))</span>
    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">term</span><span class="o">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"status"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"active"</span><span class="o">)))</span>
<span class="o">));</span>
</code></pre></div></div>

<p>ç¤ºä¾‹2ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="nc">ObjectBuilder</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">&gt;&gt;</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
<span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
    <span class="o">.</span><span class="na">must</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span>
        <span class="o">.</span><span class="na">term</span><span class="o">(</span><span class="n">tagCategoryQuery</span><span class="o">)</span>   <span class="c1">// å¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼štagCategoryQuery</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="na">must</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span>
        <span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="n">tagListQuery</span><span class="o">)</span>      <span class="c1">// å¿…é¡»åŒ¹é…çš„æ¡ä»¶ï¼štagListQuery</span>
    <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<p>å¦‚æœä½¿ç”¨<code class="language-plaintext highlighter-rouge">must</code>ï¼Œé‚£ä¹ˆä¸¤ä¸ªæŸ¥è¯¢æ¡ä»¶å¿…é¡»åŒæ—¶æ»¡è¶³ï¼›å¦‚æœä½¿ç”¨ <code class="language-plaintext highlighter-rouge">should</code>ï¼Œé‚£ä¹ˆè‡³å°‘ä¸€ä¸ªæ¡ä»¶å¿…é¡»æ»¡è¶³ã€‚ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä½¿ç”¨Elasticsearchå®¢æˆ·ç«¯æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢ï¼ŒæŸ¥è¯¢å­—æ®µ "title" æ˜¯å¦åŒ¹é…æŸ¥è¯¢è¯ "elasticsearch"</span>
<span class="n">esClient</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"elasticsearch"</span><span class="o">)))</span>  <span class="c1">// åŒ¹é…æŸ¥è¯¢</span>
<span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>  <span class="c1">// è¿”å›ç»“æœç±»å‹ä¸º Map</span>

<span class="c1">// åˆ›å»ºä¸€ä¸ª Term æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å­—æ®µ "tagInfoList.tagCategory.keyword" æ˜¯å¦ä¸º 1</span>
<span class="nc">TermQuery</span> <span class="n">tagCategoryQuery</span> <span class="o">=</span> <span class="nc">TermQuery</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"tagInfoList.tagCategory.keyword"</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>

<span class="c1">// åˆ›å»ºä¸€ä¸ª Terms æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å­—æ®µ "tagInfoList.tagList.keyword" æ˜¯å¦åŒ…å« "123" æˆ– "456"</span>
<span class="nc">TermsQuery</span> <span class="n">tagListQuery</span> <span class="o">=</span> <span class="nc">TermsQuery</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"tagInfoList.tagList.keyword"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="n">tm</span> <span class="o">-&gt;</span> <span class="n">tm</span><span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">FieldValue</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"123"</span><span class="o">),</span> <span class="nc">FieldValue</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"456"</span><span class="o">)))));</span>

<span class="c1">// æ„å»ºä¸€ä¸ª OR æŸ¥è¯¢ï¼Œä½¿ç”¨ bool æŸ¥è¯¢çš„ should å­å¥ï¼Œè¡¨ç¤ºæ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶å³ä¸ºåŒ¹é…</span>
<span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="nc">ObjectBuilder</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">&gt;&gt;</span> <span class="n">orQuery</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
        <span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
                <span class="c1">// ç¬¬ä¸€ä¸ª should æŸ¥è¯¢ï¼štagCategoryQueryï¼ŒæŸ¥è¯¢æ˜¯å¦åŒ¹é… tagCategory</span>
                <span class="o">.</span><span class="na">should</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">term</span><span class="o">(</span><span class="n">tagCategoryQuery</span><span class="o">))</span>  
                <span class="c1">// ç¬¬äºŒä¸ª should æŸ¥è¯¢ï¼štagListQueryï¼ŒæŸ¥è¯¢æ˜¯å¦åŒ¹é… tagList</span>
                <span class="o">.</span><span class="na">should</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">terms</span><span class="o">(</span><span class="n">tagListQuery</span><span class="o">))</span>  
                <span class="c1">// minimumShouldMatch è®¾ç½®ä¸º "1"ï¼Œè¡¨ç¤ºè‡³å°‘æœ‰ä¸€ä¸ª should æ¡ä»¶æ»¡è¶³å³å¯</span>
                <span class="o">.</span><span class="na">minimumShouldMatch</span><span class="o">(</span><span class="s">"1"</span><span class="o">)</span>
        <span class="o">);</span>

</code></pre></div></div>

<hr />

<h5 id="range"><code class="language-plaintext highlighter-rouge">range</code></h5>

<p>èŒƒå›´æŸ¥è¯¢ï¼Œç”¨äºæŸ¥æ‰¾å­—æ®µå€¼åœ¨æŸä¸ªèŒƒå›´å†…çš„æ–‡æ¡£ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">gte</span><span class="o">(</span><span class="nc">JsonData</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">100</span><span class="o">)).</span><span class="na">lte</span><span class="o">(</span><span class="nc">JsonData</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">500</span><span class="o">))))</span>
</code></pre></div></div>

<hr />

<h5 id="prefix"><code class="language-plaintext highlighter-rouge">prefix</code></h5>

<p>å‰ç¼€æŸ¥è¯¢ï¼ˆæŸ¥è¯¢ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">PrefixQuery</span> <span class="n">prefixQuery</span> <span class="o">=</span> <span class="nc">PrefixQuery</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span>
    <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"title.keyword"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">"prefixValue"</span><span class="o">)</span>
<span class="o">);</span>

<span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="nc">ObjectBuilder</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">&gt;&gt;</span> <span class="n">prefixCondition</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
    <span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
        <span class="o">.</span><span class="na">must</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">prefix</span><span class="o">(</span><span class="n">prefixQuery</span><span class="o">))</span>
    <span class="o">);</span>
</code></pre></div></div>

<hr />

<h5 id="match-1"><code class="language-plaintext highlighter-rouge">match</code></h5>

<p>åŒ¹é…æŸ¥è¯¢</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MatchQuery</span> <span class="n">matchQuery</span> <span class="o">=</span> <span class="nc">MatchQuery</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span>
    <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"description"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"search text"</span><span class="o">)</span>
<span class="o">);</span>

<span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="nc">ObjectBuilder</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">&gt;&gt;</span> <span class="n">matchCondition</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
    <span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
        <span class="o">.</span><span class="na">must</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">matchQuery</span><span class="o">))</span>
    <span class="o">);</span>
</code></pre></div></div>

<hr />

<h5 id="wildcard"><code class="language-plaintext highlighter-rouge">wildcard</code></h5>

<p>é€šé…ç¬¦æŸ¥è¯¢ï¼ˆæŸ¥è¯¢ï¼‰</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">WildcardQuery</span> <span class="n">wildcardQuery</span> <span class="o">=</span> <span class="nc">WildcardQuery</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">w</span> <span class="o">-&gt;</span> <span class="n">w</span>
    <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"content"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">value</span><span class="o">(</span><span class="s">"val*"</span><span class="o">)</span>
<span class="o">);</span>

<span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="nc">ObjectBuilder</span><span class="o">&lt;</span><span class="nc">Query</span><span class="o">&gt;&gt;</span> <span class="n">wildcardCondition</span> <span class="o">=</span> <span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
    <span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
        <span class="o">.</span><span class="na">must</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">wildcard</span><span class="o">(</span><span class="n">wildcardQuery</span><span class="o">))</span>
    <span class="o">);</span>
</code></pre></div></div>

<h5 id="regexp"><code class="language-plaintext highlighter-rouge">regexp</code></h5>

<p>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œæä¾›æ¯” <code class="language-plaintext highlighter-rouge">wildcard</code> æŸ¥è¯¢æ›´å¼ºå¤§çš„æ¨¡å¼åŒ¹é…èƒ½åŠ›ã€‚æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥æ›´çµæ´»åœ°å®šä¹‰åŒ¹é…æ¨¡å¼ï¼Œå¦‚å­—ç¬¦ç±»ã€é‡å¤æ¬¡æ•°ã€åˆ†ç»„ç­‰ã€‚</p>

<hr />

<h5 id="matchphrase"><code class="language-plaintext highlighter-rouge">matchPhrase</code></h5>

<p><code class="language-plaintext highlighter-rouge">match_phrase</code> æ˜¯ Elasticsearch ä¸­ç”¨äºçŸ­è¯­åŒ¹é…ï¼ˆPhrase Matchingï¼‰çš„ä¸€ç§æŸ¥è¯¢ç±»å‹ã€‚ä¸æ™®é€šçš„ <code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢ä¸åŒï¼Œ<code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢ä¼šè€ƒè™‘è¯è¯­çš„é¡ºåºï¼Œå¹¶ä¸”è¦æ±‚è¯è¯­ç´§å¯†ç›¸é‚»ï¼Œå› æ­¤æ›´é€‚åˆç”¨äºæŸ¥è¯¢è¯­å¥ã€çŸ­è¯­æˆ–å¥å­ç­‰åœºæ™¯ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">match_phrase</code> çš„åŸºæœ¬ç‰¹æ€§ï¼š</p>

<ul>
  <li><strong>é¡ºåºæ•æ„Ÿ</strong>ï¼š<code class="language-plaintext highlighter-rouge">match_phrase</code> ä¼šæŒ‰ç»™å®šçš„é¡ºåºåŒ¹é…æ–‡æœ¬ï¼Œä¸èƒ½åƒæ™®é€šçš„ <code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢é‚£æ ·ä¸è€ƒè™‘é¡ºåºã€‚</li>
  <li><strong>ç›¸é‚»è¯è¯­åŒ¹é…</strong>ï¼šè¦æ±‚æ–‡æœ¬ä¸­çš„è¯è¯­ç›¸é‚»ï¼Œå¹¶ä¸”ä¹‹é—´æ²¡æœ‰å…¶ä»–è¯è¯­ï¼ˆå¦‚æœè®¾ç½®äº† <code class="language-plaintext highlighter-rouge">slop</code>ï¼Œåˆ™å…è®¸è¯è¯­ä¹‹é—´æœ‰ä¸€å®šçš„â€œè·³è·ƒâ€ï¼‰ã€‚</li>
  <li><strong>é€‚ç”¨äºçŸ­è¯­æŸ¥è¯¢</strong>ï¼šé€‚åˆæœç´¢åŒ…å«ç‰¹å®šçŸ­è¯­æˆ–å¥å­çš„æƒ…å†µã€‚</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢è¯­æ³•ç»“æ„æ¯”è¾ƒç®€å•ï¼Œé€šå¸¸ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"short phrase"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">field</code>ï¼šè¦æœç´¢çš„å­—æ®µã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">"short phrase"</code>ï¼šè¦åŒ¹é…çš„çŸ­è¯­ï¼Œå¤šä¸ªè¯ä¼šæŒ‰ç…§ç»™å®šé¡ºåºè¿›è¡ŒåŒ¹é…ã€‚</li>
</ul>

<p>ç¤ºä¾‹ï¼š</p>

<p>å‡è®¾æœ‰ä»¥ä¸‹æ–‡æ¡£ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elasticsearch provides fast and scalable search."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>åŒ¹é…çŸ­è¯­</strong>ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fast and scalable"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¯¥æŸ¥è¯¢ä¼šæœç´¢åŒ…å«çŸ­è¯­ â€œfast and scalableâ€ çš„æ–‡æ¡£ï¼Œæ³¨æ„è¿™è¦æ±‚çŸ­è¯­ä¸­çš„è¯è¯­æŒ‰é¡ºåºå‡ºç°ã€‚</p>

<p><strong>é¡ºåºæ•æ„Ÿæ€§</strong>ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"scalable fast"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™å°†ä¸ä¼šåŒ¹é…åˆ°å‰é¢çš„æ–‡æ¡£ï¼Œå› ä¸ºè¯è¯­çš„é¡ºåºæ˜¯ä¸åŒçš„ã€‚<code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢æ˜¯é¡ºåºæ•æ„Ÿçš„ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">slop</code> å‚æ•°ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">slop</code> å‚æ•°å…è®¸åœ¨åŒ¹é…çš„çŸ­è¯­ä¸­æ’å…¥ä¸€å®šæ•°é‡çš„è¯è¯­ï¼ˆå³å¯ä»¥â€œè·³è·ƒâ€ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½® <code class="language-plaintext highlighter-rouge">slop</code> ä¸º 2ï¼Œå°±è¡¨ç¤ºå¯ä»¥åœ¨çŸ­è¯­ä¸­æ’å…¥æœ€å¤š 2 ä¸ªè¯ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fast scalable search"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"slop"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">slop</code> è®¾ç½®ä¸º 2ï¼Œè¡¨ç¤ºå¯ä»¥æ¥å— <code class="language-plaintext highlighter-rouge">fast</code>, <code class="language-plaintext highlighter-rouge">scalable</code>, <code class="language-plaintext highlighter-rouge">search</code> ä¸‰ä¸ªè¯ä¹‹é—´æœ€å¤šæœ‰ 2 ä¸ªè¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŸ¥è¯¢ä¼šåŒ¹é…åŒ…å«è¿™äº›è¯çš„ä»»ä½•é¡ºåºï¼Œå…è®¸æœ‰æœ€å¤šä¸¤ä¸ªè¯çš„é—´éš”ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">match_phrase</code> ä¸ <code class="language-plaintext highlighter-rouge">match</code> çš„åŒºåˆ«ï¼š</p>

<ul>
  <li><strong>é¡ºåº</strong>ï¼š<code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢ä¸è€ƒè™‘è¯è¯­çš„é¡ºåºï¼Œè€Œ <code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢è¦æ±‚è¯è¯­æŒ‰ç…§æŒ‡å®šçš„é¡ºåºæ’åˆ—ã€‚</li>
  <li><strong>ç›¸é‚»æ€§</strong>ï¼š<code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢å¯ä»¥åœ¨ä¸€ä¸ªå­—æ®µä¸­ä»»æ„ä½ç½®æ‰¾åˆ°åŒ¹é…è¯ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢è¦æ±‚è¯è¯­ç›¸é‚»ï¼Œé™¤éä½¿ç”¨ <code class="language-plaintext highlighter-rouge">slop</code>ã€‚</li>
</ul>

<p>ç¤ºä¾‹ï¼š
ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fast scalable"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>è¯¥æŸ¥è¯¢ä¼šåŒ¹é…åŒ…å« <code class="language-plaintext highlighter-rouge">fast</code> å’Œ <code class="language-plaintext highlighter-rouge">scalable</code> ä¸¤ä¸ªè¯çš„ä»»ä½•æ–‡æ¡£ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦ç›¸é‚»ï¼Œæ˜¯å¦æŒ‰é¡ºåºæ’åˆ—ã€‚</p>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢ï¼š</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fast scalable"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>è¯¥æŸ¥è¯¢è¦æ±‚æ–‡æ¡£ä¸­ <code class="language-plaintext highlighter-rouge">fast</code> å’Œ <code class="language-plaintext highlighter-rouge">scalable</code> ä¸¤ä¸ªè¯è¦ç´§å¯†ç›¸é‚»ï¼Œä¸”æŒ‰é¡ºåºæ’åˆ—ã€‚</p>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢çš„åœºæ™¯ï¼š</p>

<p><strong>æœç´¢å¸¦æœ‰å›ºå®šé¡ºåºçš„çŸ­è¯­</strong>ï¼šå¦‚æœä½ å¸Œæœ›æŸ¥è¯¢ç²¾ç¡®çš„çŸ­è¯­ï¼Œå¹¶ä¸”è¦æ±‚è¯è¯­ä¹‹é—´ç›¸å¯¹é¡ºåºä¸å˜ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">match_phrase</code>ã€‚</p>

<p>ä¾‹å¦‚ï¼ŒæŸ¥è¯¢æŸä¸ªç‰¹å®šåœ°å€ã€åç§°æˆ–çŸ­è¯­ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"New York City"</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>é¿å…è¯è¯­å‡ºç°é¡ºåºæ··ä¹±çš„æƒ…å†µ</strong>ï¼š<code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢é€‚åˆç”¨åœ¨å†…å®¹ä¸­é¡ºåºéå¸¸é‡è¦çš„åœºæ™¯ï¼Œæ¯”å¦‚æ ‡é¢˜ã€å¥å­ã€æ–‡ç« ç­‰ã€‚</p>

<p><strong>ç²¾å‡†çŸ­è¯­æœç´¢</strong>ï¼šå¯¹äºä¸€äº›éœ€è¦é«˜åº¦ç²¾ç¡®åŒ¹é…çš„æŸ¥è¯¢ï¼Œ<code class="language-plaintext highlighter-rouge">match_phrase</code> æ˜¯éå¸¸åˆé€‚çš„é€‰æ‹©ï¼Œä¾‹å¦‚æŸ¥è¯¢äº§å“åç§°ã€åœ°ç†ä½ç½®ç­‰ã€‚</p>

<p>ç¤ºä¾‹ä»£ç ï¼ˆJavaï¼‰ï¼š</p>

<p>åœ¨ Java ä¸­ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢ç±»ä¼¼äºå…¶ä»–æŸ¥è¯¢ç±»å‹ã€‚ä½ å¯ä»¥ä½¿ç”¨ Elasticsearch å®¢æˆ·ç«¯ API æ¥æ„å»ºæŸ¥è¯¢ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">matchPhraseQuery</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">matchPhrase</span><span class="o">(</span><span class="n">mp</span> <span class="o">-&gt;</span> <span class="n">mp</span>
        <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"text"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"fast scalable"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">slop</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>  <span class="c1">// å¯é€‰ï¼Œè®¾ç½®slopæ¥å…è®¸è·³è·ƒ</span>
<span class="o">));</span>
</code></pre></div></div>

<p>æ€»ç»“ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢ç”¨äºç²¾ç¡®åŒ¹é…çŸ­è¯­ï¼Œè¦æ±‚çŸ­è¯­ä¸­çš„è¯è¯­é¡ºåºä¸€è‡´ä¸”ç›¸é‚»ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">slop</code> å‚æ•°å…è®¸åœ¨çŸ­è¯­ä¸­æ’å…¥ä¸€å®šçš„è¯è¯­é—´éš”ï¼Œä½¿å¾—æŸ¥è¯¢æ›´åŠ çµæ´»ã€‚</li>
  <li>é€‚ç”¨äºéœ€è¦é¡ºåºå’Œç›¸é‚»å…³ç³»çš„é‡è¦çŸ­è¯­åŒ¹é…åœºæ™¯ã€‚</li>
</ul>

<hr />

<h5 id="ids"><code class="language-plaintext highlighter-rouge">ids</code></h5>

<p>æŸ¥æ‰¾åˆ¶å®šå‡ºçš„æ–‡æ¡£ID</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">ids</span><span class="o">=...</span>
<span class="o">...</span>
<span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">queryBuilder</span> <span class="o">-&gt;</span> <span class="n">queryBuilder</span>
        <span class="o">.</span><span class="na">ids</span><span class="o">(</span><span class="n">idsQueryBuilder</span> <span class="o">-&gt;</span> <span class="n">idsQueryBuilder</span>
                <span class="o">.</span><span class="na">values</span><span class="o">(</span><span class="n">ids</span><span class="o">))</span>
<span class="o">)</span>
</code></pre></div></div>

<p>åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼Œå®ƒä¼šæ ¹æ®ç»™å®šçš„æ–‡æ¡£ ID æ¥è¿”å›å¯¹åº”çš„æ–‡æ¡£ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">idsQueryBuilder -&gt; idsQueryBuilder.values(ids)</code>ï¼š<code class="language-plaintext highlighter-rouge">idsQueryBuilder</code> æ˜¯ç”¨æ¥æ„å»º ID æŸ¥è¯¢çš„æ„å»ºå™¨ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">values(ids)</code> æ–¹æ³•ä¼ å…¥ä¸€ä¸ªåŒ…å«æ–‡æ¡£ ID çš„åˆ—è¡¨ï¼Œè¡¨ç¤ºå¸Œæœ›æŸ¥æ‰¾è¿™äº› ID å¯¹åº”çš„æ–‡æ¡£ã€‚<code class="language-plaintext highlighter-rouge">ids</code> æ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªæ–‡æ¡£ ID çš„é›†åˆï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ª List æˆ–æ•°ç»„ï¼‰ã€‚</p>

<hr />

<h5 id="multimatch"><code class="language-plaintext highlighter-rouge">multiMatch</code></h5>

<p>è·¨å¤šä¸ªå­—æ®µçš„å…¨æ–‡æ£€ç´¢ï¼Œä¼šåˆ†è¯ï¼Œ<strong>å¯ä»¥è®¾ç½®ä¸ºçŸ­è¯­åŒ¹é…ï¼š<code class="language-plaintext highlighter-rouge">.type(TextQueryType.Phrase)  // ä½¿ç”¨çŸ­è¯­æŸ¥è¯¢</code>ã€‚</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">multiMatch</span><span class="o">(</span><span class="n">mm</span> <span class="o">-&gt;</span> <span class="n">mm</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">search</span><span class="o">)</span>                       <span class="c1">// æŸ¥è¯¢å…³é”®è¯ï¼Œé€šå¸¸æ˜¯ç”¨æˆ·è¾“å…¥çš„æœç´¢è¯</span>
        <span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="s">"memberInfo"</span><span class="o">,</span><span class="s">"name"</span><span class="o">)</span>             
        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="nc">BestFields</span><span class="o">)</span>                    <span class="c1">// è®¾ç½®æŸ¥è¯¢ç±»å‹ä¸º BestFields</span>
    <span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢æ˜¯ Elasticsearch ä¸­ç”¨äºå¯¹å¤šä¸ªå­—æ®µè¿›è¡Œç›¸åŒæŸ¥è¯¢æ¡ä»¶çš„æŸ¥è¯¢ã€‚å®ƒç±»ä¼¼äº <code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢ï¼Œä½†å¯ä»¥ä¸€æ¬¡æ€§åŒ¹é…å¤šä¸ªå­—æ®µï¼Œé€šå¸¸ç”¨äºå¯¹å¤šä¸ªæ–‡æœ¬å­—æ®µçš„å…¨æ–‡æœç´¢ã€‚</p>

<p>å½“ç”¨æˆ·å¸Œæœ›æœç´¢å¤šä¸ªå­—æ®µæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢ã€‚æ¯”å¦‚åœ¨ç”¨æˆ·æœç´¢æ—¶ï¼Œå¯èƒ½åŒæ—¶éœ€è¦å¯¹ <code class="language-plaintext highlighter-rouge">title</code>ã€<code class="language-plaintext highlighter-rouge">description</code>ã€<code class="language-plaintext highlighter-rouge">content</code> ç­‰å¤šä¸ªå­—æ®µè¿›è¡ŒåŒ¹é…ï¼Œè€Œä¸éœ€è¦é€ä¸ªå­—æ®µè¿›è¡ŒæŸ¥è¯¢ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">.query(search)</code></strong>ï¼šè®¾ç½®äº†æœç´¢çš„å…³é”®è¯ï¼Œå³ç”¨æˆ·è¦æŸ¥æ‰¾çš„æ–‡æœ¬ã€‚åœ¨è¿™ä¸ªä»£ç ç‰‡æ®µä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">search</code> å˜é‡é€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒåŒ…å«ç”¨æˆ·è¾“å…¥çš„æœç´¢æ¡ä»¶ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">.fields("memberInfo","name")</code></strong>ï¼šæŒ‡å®šäº†å“ªäº›å­—æ®µå°†è¢«ç”¨äºåŒ¹é…æœç´¢å…³é”®è¯ï¼Œæ³¨æ„å­—æ®µä¸èƒ½ç”¨é€šé…ç¬¦ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">.type(BestFields)</code></strong>ï¼šè®¾ç½®äº† <code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢çš„ç±»å‹ä¸º <code class="language-plaintext highlighter-rouge">BestFields</code>ã€‚<code class="language-plaintext highlighter-rouge">BestFields</code> æ˜¯ Elasticsearch ä¸­çš„ä¸€ç§åŒ¹é…ç±»å‹ï¼Œç”¨äºé€‰æ‹©æœ€ç›¸å…³çš„å­—æ®µè¿›è¡Œè¯„åˆ†è®¡ç®—ã€‚</p>

<ul>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">BestFields</code></strong>ï¼šè¿™æ˜¯é»˜è®¤çš„æŸ¥è¯¢ç±»å‹ï¼Œå®ƒä¼šæ ¹æ®æ¯ä¸ªå­—æ®µçš„åŒ¹é…åº¦é€‰æ‹©æœ€ç›¸å…³çš„å­—æ®µè¿›è¡Œè¯„åˆ†ã€‚å¦‚æœæŸ¥è¯¢æ¶‰åŠå¤šä¸ªå­—æ®µï¼Œ<code class="language-plaintext highlighter-rouge">BestFields</code> ä¼šä¸ºæ¯ä¸ªå­—æ®µè®¡ç®—ç›¸å…³æ€§è¯„åˆ†ï¼Œæœ€ç»ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„å­—æ®µä½œä¸ºåŒ¹é…ç»“æœã€‚</p>
  </li>
  <li>
    <p>åœ¨ <code class="language-plaintext highlighter-rouge">BestFields</code> æ¨¡å¼ä¸‹ï¼Œå¦‚æœåœ¨å¤šä¸ªå­—æ®µä¸­æ‰¾åˆ°åŒ¹é…é¡¹ï¼ŒElasticsearch ä¼šæ ¹æ®å­—æ®µçš„ç›¸å…³æ€§ï¼ˆæ¯”å¦‚åŒ¹é…çš„è¯é¢‘ã€å­—æ®µçš„æ–‡æœ¬é•¿åº¦ç­‰å› ç´ ï¼‰æ¥é€‰æ‹©æœ€ç›¸å…³çš„ä¸€ä¸ªå­—æ®µçš„ç»“æœã€‚</p>
  </li>
</ul>

<p>å¦‚æœ <code class="language-plaintext highlighter-rouge">memberInfo</code> å¯¹è±¡ä¸‹æœ‰å¤šä¸ªå­—æ®µï¼Œ<code class="language-plaintext highlighter-rouge">BestFields</code> ä¼šè‡ªåŠ¨é€‰æ‹©æœ€ç›¸å…³çš„å­—æ®µè¿›è¡Œè¯„åˆ†ã€‚æ¯”å¦‚ï¼Œå¦‚æœ <code class="language-plaintext highlighter-rouge">memberInfo</code> ä¸‹æœ‰ <code class="language-plaintext highlighter-rouge">name</code>ã€<code class="language-plaintext highlighter-rouge">address</code> å’Œ <code class="language-plaintext highlighter-rouge">email</code> å­—æ®µï¼ŒæŸ¥è¯¢ <code class="language-plaintext highlighter-rouge">"John"</code> æ—¶ï¼Œå‡è®¾ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">name</code> åŒ¹é… <code class="language-plaintext highlighter-rouge">"John"</code>ï¼Œå¾—åˆ†ä¸º 1.0</li>
  <li><code class="language-plaintext highlighter-rouge">email</code> åŒ¹é… <code class="language-plaintext highlighter-rouge">"john.doe@example.com"</code>ï¼Œå¾—åˆ†ä¸º 0.5</li>
  <li><code class="language-plaintext highlighter-rouge">address</code> æ²¡æœ‰åŒ¹é…é¡¹ï¼Œå¾—åˆ†ä¸º 0</li>
</ul>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">BestFields</code> ä¼šé€‰æ‹© <code class="language-plaintext highlighter-rouge">name</code> å­—æ®µï¼Œå› ä¸ºå®ƒçš„åŒ¹é…åº¦æ›´é«˜ï¼Œå¾—åˆ†ä¸º 1.0ï¼Œè¿”å›è¿™ä¸ªå­—æ®µä½œä¸ºæœ€ç›¸å…³çš„åŒ¹é…å­—æ®µã€‚</p>

<hr />

<h5 id="textquerytype"><code class="language-plaintext highlighter-rouge">TextQueryType</code></h5>

<p>åœ¨ Elasticsearch ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢ç”¨äºåœ¨å¤šä¸ªå­—æ®µä¸Šæ‰§è¡ŒæŸ¥è¯¢ã€‚ä¸åŒçš„ <code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢ç±»å‹å¯ä»¥å½±å“æŸ¥è¯¢ç»“æœçš„è®¡ç®—æ–¹å¼ã€‚è¿™äº›ç±»å‹ä¸»è¦ç”¨äºåœ¨æ–‡æœ¬å­—æ®µä¸Šæ‰§è¡Œå¤šå­—æ®µåŒ¹é…ï¼Œæ¯ç§ç±»å‹æœ‰ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">TextQueryType</code> æšä¸¾æä¾›äº†å‡ ç§å¸¸è§çš„ <code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢ç±»å‹ï¼Œæ¯ç§ç±»å‹éƒ½æœ‰ä¸åŒçš„è¡Œä¸ºã€‚æ¥ä¸‹æ¥æˆ‘ä¼šè¯¦ç»†è§£é‡Šæ¯ç§ç±»å‹çš„ç”¨æ³•å’Œé€‚ç”¨åœºæ™¯ã€‚</p>

<p><strong>BestFields (<code class="language-plaintext highlighter-rouge">best_fields</code>)</strong>ï¼šè¿™æ˜¯é»˜è®¤çš„æŸ¥è¯¢ç±»å‹ã€‚å®ƒä¼šé€‰æ‹©æœ€ä½³åŒ¹é…çš„å­—æ®µæ¥è¿”å›ç»“æœã€‚å¦‚æœå¤šä¸ªå­—æ®µåŒ¹é…æŸ¥è¯¢è¯ï¼Œ<code class="language-plaintext highlighter-rouge">best_fields</code> ä¼šæ ¹æ®æ¯ä¸ªå­—æ®µçš„åŒ¹é…åº¦ï¼ˆç›¸å…³æ€§ï¼‰æ¥é€‰æ‹©æœ€ç›¸å…³çš„ä¸€ä¸ªå­—æ®µçš„ç»“æœã€‚</p>

<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚ç”¨äºå½“ä½ åœ¨å¤šä¸ªå­—æ®µä¸Šæœç´¢ç›¸åŒçš„æŸ¥è¯¢è¯æ—¶ï¼ŒæŸ¥è¯¢åº”è¯¥é›†ä¸­åœ¨æœ€ç›¸å…³çš„å­—æ®µä¸Šï¼Œè€Œä¸æ˜¯è®¡ç®—æ‰€æœ‰å­—æ®µçš„ç»¼åˆè¯„åˆ†ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"multi_match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elasticsearch tutorial"</span><span class="p">,</span><span class="w">
       </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
       </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"best_fields"</span><span class="w">
     </span><span class="p">}</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>æ­¤æŸ¥è¯¢ä¼šåœ¨ <code class="language-plaintext highlighter-rouge">title</code> å’Œ <code class="language-plaintext highlighter-rouge">description</code> å­—æ®µä¸­æŸ¥æ‰¾ <code class="language-plaintext highlighter-rouge">Elasticsearch tutorial</code>ï¼Œå¹¶æ ¹æ®åŒ¹é…åº¦é€‰æ‹©æœ€ç›¸å…³çš„å­—æ®µè¿›è¡Œè¯„åˆ†ã€‚</p>

<p><strong>MostFields (<code class="language-plaintext highlighter-rouge">most_fields</code>)</strong>ï¼šä¸ <code class="language-plaintext highlighter-rouge">best_fields</code> ç±»ä¼¼ï¼Œä½†æ˜¯ <code class="language-plaintext highlighter-rouge">most_fields</code> ä¼šå°è¯•ä¸ºæ¯ä¸ªåŒ¹é…çš„å­—æ®µå¢åŠ è¯„åˆ†ã€‚è¿™æ„å‘³ç€å®ƒä¼šè®¡ç®—æ‰€æœ‰åŒ¹é…å­—æ®µçš„æ€»ç›¸å…³æ€§è¯„åˆ†ï¼Œè€Œä¸æ˜¯åªé€‰æ‹©ä¸€ä¸ªå­—æ®µçš„ç»“æœã€‚</p>

<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå½“ä½ å¸Œæœ›æ‰€æœ‰åŒ¹é…å­—æ®µå¯¹æœ€ç»ˆè¯„åˆ†éƒ½æœ‰è´¡çŒ®æ—¶ä½¿ç”¨ã€‚é€‚åˆäºå¤šå­—æ®µåŒ¹é…æ—¶ï¼Œæ‰€æœ‰å­—æ®µçš„åŒ¹é…éƒ½é‡è¦çš„åœºæ™¯ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="nl">"multi_match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elasticsearch tutorial"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
   </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"most_fields"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>æ­¤æŸ¥è¯¢ä¼šåœ¨ <code class="language-plaintext highlighter-rouge">title</code> å’Œ <code class="language-plaintext highlighter-rouge">description</code> å­—æ®µä¸­æŸ¥æ‰¾ <code class="language-plaintext highlighter-rouge">Elasticsearch tutorial</code>ï¼Œå¹¶æ ¹æ®è¿™ä¸¤ä¸ªå­—æ®µçš„åŒ¹é…åº¦è®¡ç®—æ€»çš„ç›¸å…³æ€§è¯„åˆ†ã€‚</p>

<p><strong>CrossFields (<code class="language-plaintext highlighter-rouge">cross_fields</code>)</strong>ï¼šå°†å¤šä¸ªå­—æ®µè§†ä¸ºä¸€ä¸ªå•ä¸€çš„å­—æ®µæ¥è¿›è¡ŒæŸ¥è¯¢ã€‚<code class="language-plaintext highlighter-rouge">cross_fields</code> ä¼šæŠŠå¤šä¸ªå­—æ®µçš„å€¼åˆå¹¶åœ¨ä¸€èµ·ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">title</code> å’Œ <code class="language-plaintext highlighter-rouge">description</code> å­—æ®µçš„å†…å®¹å°†è¢«åˆå¹¶ä¸ºä¸€ä¸ªæŸ¥è¯¢ä¸Šä¸‹æ–‡ã€‚</p>

<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå½“ä½ å¸Œæœ›å­—æ®µä¹‹é—´çš„æŸ¥è¯¢è¯æ²¡æœ‰ä¸¥æ ¼çš„é¡ºåºå…³ç³»æ—¶ä½¿ç”¨ã€‚é€‚ç”¨äºå¤šä¸ªå­—æ®µéœ€è¦ä¸€èµ·æŸ¥è¯¢ï¼Œå¹¶ä¸”å­—æ®µä¹‹é—´çš„å†…å®¹å¯ä»¥äº¤æ¢æˆ–è·¨å­—æ®µåŒ¹é…çš„åœºæ™¯ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="nl">"multi_match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elasticsearch tutorial"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
   </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cross_fields"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>æ­¤æŸ¥è¯¢ä¼šå°† <code class="language-plaintext highlighter-rouge">title</code> å’Œ <code class="language-plaintext highlighter-rouge">description</code> å­—æ®µçš„å†…å®¹åˆå¹¶èµ·æ¥ï¼Œç„¶åè¿›è¡Œä¸€æ¬¡æ•´ä½“æŸ¥è¯¢ã€‚</p>

<p><strong>Phrase (<code class="language-plaintext highlighter-rouge">phrase</code>)</strong>ï¼šä¸æ™®é€šçš„ <code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢ä¸åŒï¼Œ<code class="language-plaintext highlighter-rouge">phrase</code> æŸ¥è¯¢è¦æ±‚æŸ¥è¯¢è¯å¿…é¡»å‡ºç°åœ¨ç‰¹å®šé¡ºåºä¸­ã€‚å®ƒåœ¨å¤šå­—æ®µæŸ¥è¯¢ä¸­ä¿æŒæŸ¥è¯¢è¯çš„é¡ºåºã€‚</p>

<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå½“ä½ éœ€è¦ç¡®ä¿æŸ¥è¯¢è¯åœ¨æ–‡æœ¬ä¸­æŒ‰æŒ‡å®šé¡ºåºå‡ºç°æ—¶ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼ŒæŸ¥è¯¢ â€œElasticsearch tutorialâ€ æ—¶ï¼Œåªæœ‰å½“è¿™ä¸¤ä¸ªè¯æŒ‰é¡ºåºå‡ºç°æ—¶æ‰åŒ¹é…ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="nl">"multi_match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elasticsearch tutorial"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
   </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"phrase"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>æ­¤æŸ¥è¯¢ä¼šæ£€æŸ¥ <code class="language-plaintext highlighter-rouge">title</code> å’Œ <code class="language-plaintext highlighter-rouge">description</code> å­—æ®µä¸­æ˜¯å¦æŒ‰é¡ºåºå‡ºç° <code class="language-plaintext highlighter-rouge">Elasticsearch tutorial</code>ã€‚</p>

<p><strong>PhrasePrefix (<code class="language-plaintext highlighter-rouge">phrase_prefix</code>)</strong>ï¼šç±»ä¼¼äº <code class="language-plaintext highlighter-rouge">phrase</code> æŸ¥è¯¢ï¼Œä½†å…è®¸æŸ¥è¯¢è¯çš„æœ€åä¸€ä¸ªè¯æ˜¯å‰ç¼€åŒ¹é…ã€‚è¿™æ„å‘³ç€åœ¨æŸ¥è¯¢è¯çš„æœ€åéƒ¨åˆ†å¯ä»¥æ˜¯ä¸€ä¸ªä¸å®Œå…¨çš„å•è¯ã€‚</p>

<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šå½“ä½ å¸Œæœ›æœç´¢çŸ­è¯­æ—¶ï¼Œå…è®¸éƒ¨åˆ†åŒ¹é…æˆ–å‰ç¼€åŒ¹é…æŸä¸ªè¯æ—¶ä½¿ç”¨ã€‚é€‚åˆå¤„ç†åƒ â€œElasticsearch tutâ€ è¿™æ ·æ²¡æœ‰å®Œå…¨è¾“å…¥çš„æŸ¥è¯¢ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="nl">"multi_match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elasticsearch tut"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
   </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"phrase_prefix"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>æ­¤æŸ¥è¯¢ä¼šåŒ¹é… <code class="language-plaintext highlighter-rouge">title</code> å’Œ <code class="language-plaintext highlighter-rouge">description</code> ä¸­çš„çŸ­è¯­ï¼Œå…è®¸ <code class="language-plaintext highlighter-rouge">tut</code> ä¸ºå‰ç¼€åŒ¹é…ï¼Œä¾‹å¦‚åŒ¹é… <code class="language-plaintext highlighter-rouge">tutorial</code>ã€‚</p>

<p><strong>BoolPrefix (<code class="language-plaintext highlighter-rouge">bool_prefix</code>)</strong>ï¼š<code class="language-plaintext highlighter-rouge">bool_prefix</code> æŸ¥è¯¢æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¸ƒå°”æŸ¥è¯¢ï¼Œå®ƒå…è®¸å¯¹æŸ¥è¯¢çš„æœ€åä¸€ä¸ªè¯è¿›è¡Œå‰ç¼€åŒ¹é…ã€‚ä¸ <code class="language-plaintext highlighter-rouge">phrase_prefix</code> ç±»ä¼¼ï¼Œå®ƒæ”¯æŒåœ¨æŸ¥è¯¢è¯çš„æœ€åéƒ¨åˆ†è¿›è¡Œå‰ç¼€åŒ¹é…ã€‚</p>

<p><strong>é€‚ç”¨åœºæ™¯</strong>ï¼šé€‚åˆéœ€è¦åœ¨å¤šä¸ªå­—æ®µä¸Šè¿›è¡Œå¸ƒå°”æŸ¥è¯¢ï¼Œå¹¶ä¸”æœ€åä¸€ä¸ªè¯å…è®¸å‰ç¼€åŒ¹é…çš„åœºæ™¯ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="nl">"multi_match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Elasticsearch tut"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"title"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
   </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bool_prefix"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>æ­¤æŸ¥è¯¢ä¼šåŒ¹é… <code class="language-plaintext highlighter-rouge">title</code> å’Œ <code class="language-plaintext highlighter-rouge">description</code> ä¸­çš„çŸ­è¯­ï¼Œå…è®¸æœ€åä¸€ä¸ªè¯ï¼ˆ<code class="language-plaintext highlighter-rouge">tut</code>ï¼‰è¿›è¡Œå‰ç¼€åŒ¹é…ï¼Œå¹¶ä½¿ç”¨å¸ƒå°”æŸ¥è¯¢çš„é€»è¾‘ã€‚</p>

<p><strong>æ€»ç»“ï¼š</strong></p>

<p>è¿™äº›æŸ¥è¯¢ç±»å‹æä¾›äº†ä¸åŒçš„æ–¹å¼æ¥åŒ¹é…å¤šå­—æ®µæŸ¥è¯¢ï¼Œé€‚ç”¨äºä¸åŒçš„æ–‡æœ¬åŒ¹é…éœ€æ±‚ï¼š</p>

<ul>
  <li><strong>BestFields</strong>ï¼šé€‰æ‹©æœ€ç›¸å…³çš„å­—æ®µè¿›è¡ŒåŒ¹é…ã€‚</li>
  <li><strong>MostFields</strong>ï¼šæ‰€æœ‰åŒ¹é…å­—æ®µéƒ½å¯¹æœ€ç»ˆè¯„åˆ†æœ‰è´¡çŒ®ã€‚</li>
  <li><strong>CrossFields</strong>ï¼šå¤šä¸ªå­—æ®µåˆå¹¶ä¸ºä¸€ä¸ªè¿›è¡ŒæŸ¥è¯¢ï¼Œé€‚åˆå­—æ®µé—´ä¸éœ€è¦ä¸¥æ ¼é¡ºåºçš„åœºæ™¯ã€‚</li>
  <li><strong>Phrase</strong>ï¼šè¦æ±‚æŸ¥è¯¢è¯æŒ‰é¡ºåºåŒ¹é…ã€‚</li>
  <li><strong>PhrasePrefix</strong>ï¼šå…è®¸æŸ¥è¯¢è¯çš„æœ€åéƒ¨åˆ†è¿›è¡Œå‰ç¼€åŒ¹é…ã€‚</li>
  <li><strong>BoolPrefix</strong>ï¼šå¸ƒå°”æŸ¥è¯¢å¹¶å…è®¸æœ€åéƒ¨åˆ†è¿›è¡Œå‰ç¼€åŒ¹é…ã€‚</li>
</ul>

<p>é€‰æ‹©åˆé€‚çš„æŸ¥è¯¢ç±»å‹å¯ä»¥æ˜¾è‘—æé«˜æŸ¥è¯¢çš„å‡†ç¡®æ€§å’Œæ€§èƒ½ï¼Œå–å†³äºä½ çš„å…·ä½“åœºæ™¯éœ€æ±‚ã€‚</p>

<h5 id="querystring"><code class="language-plaintext highlighter-rouge">queryString</code></h5>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æ˜¯ Elasticsearch ä¸­çš„ä¸€ç§æŸ¥è¯¢ç±»å‹ï¼Œå…è®¸ä½ åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ Lucene æŸ¥è¯¢è¯­æ³•ï¼Œæ”¯æŒå¤šç§æŸ¥è¯¢è¿ç®—ç¬¦å’Œç¬¦å·ã€‚å®ƒç±»ä¼¼äº <code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢ï¼Œä½†æä¾›äº†æ›´å¼ºå¤§çš„æŸ¥è¯¢åŠŸèƒ½ï¼Œå…è®¸åœ¨ä¸€ä¸ªå­—æ®µæˆ–å¤šä¸ªå­—æ®µä¸­è¿›è¡Œå¤æ‚çš„æœç´¢ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢çš„å¸¸è§ç”¨æ³•ï¼š</p>

<p><strong>åŸºç¡€æŸ¥è¯¢</strong>ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢æ”¯æŒå¯¹å­—æ®µè¿›è¡Œè‡ªç”±æ–‡æœ¬æœç´¢ï¼Œå¹¶ä¸”æ”¯æŒå¤šç§æŸ¥è¯¢è¯­æ³•ï¼Œå¦‚å¸ƒå°”è¿ç®—ç¬¦ã€é€šé…ç¬¦ã€çŸ­è¯­æŸ¥è¯¢ç­‰ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ"</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™å°†æœç´¢åŒ…å« â€œç”˜è‚ƒçœâ€ çš„æ‰€æœ‰æ–‡æ¡£ã€‚</p>

<p><strong>æŒ‡å®šæŸ¥è¯¢å­—æ®µ</strong>ï¼š</p>

<p>å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">fields</code> å‚æ•°æŒ‡å®šè¦æŸ¥è¯¢çš„å­—æ®µï¼Œæˆ–è€…ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">*</code> æ¥è¡¨ç¤ºæŸ¥è¯¢æ‰€æœ‰å­—æ®µã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"memberInfo.name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"memberInfo.address"</span><span class="p">]</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™å°†åœ¨ <code class="language-plaintext highlighter-rouge">memberInfo.name</code> å’Œ <code class="language-plaintext highlighter-rouge">memberInfo.address</code> å­—æ®µä¸­æŸ¥æ‰¾ â€œç”˜è‚ƒçœâ€ã€‚</p>

<p><strong>é€šé…ç¬¦æŸ¥è¯¢</strong>ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æ”¯æŒé€šé…ç¬¦æŸ¥è¯¢ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">*</code> å’Œ <code class="language-plaintext highlighter-rouge">?</code> æ¥åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ï¼Œä»¥åŠä¸€ä¸ªå­—ç¬¦ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒ*"</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™å°†åŒ¹é…ä»¥ â€œç”˜è‚ƒâ€ å¼€å¤´çš„æ‰€æœ‰æ–‡æ¡£ï¼Œä¾‹å¦‚ â€œç”˜è‚ƒçœâ€ æˆ– â€œç”˜è‚ƒå¸‚â€ã€‚</p>

<p><strong>å¸ƒå°”æŸ¥è¯¢</strong>ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æ”¯æŒå¸ƒå°”è¿ç®—ç¬¦ <code class="language-plaintext highlighter-rouge">AND</code>ã€<code class="language-plaintext highlighter-rouge">OR</code> å’Œ <code class="language-plaintext highlighter-rouge">NOT</code>ï¼Œå¯ä»¥ç”¨æ¥è¿æ¥å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ AND (åŒ—äº¬ OR ä¸Šæµ·)"</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™å°†æŸ¥æ‰¾åŒ…å« â€œç”˜è‚ƒçœâ€ ä¸”åŒæ—¶åŒ…å« â€œåŒ—äº¬â€ æˆ– â€œä¸Šæµ·â€ çš„æ–‡æ¡£ã€‚</p>

<p><strong>çŸ­è¯­æŸ¥è¯¢</strong>ï¼š</p>

<p>å¯ä»¥é€šè¿‡å°†æŸ¥è¯¢è¯ç”¨åŒå¼•å·æ‹¬èµ·æ¥æ¥è¿›è¡ŒçŸ­è¯­æŸ¥è¯¢ï¼ŒæŸ¥æ‰¾è¯è¯­æŒ‰ç…§ç»™å®šé¡ºåºå‡ºç°çš„æ–‡æ¡£ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"</span><span class="se">\"</span><span class="s2">ç”˜è‚ƒçœ å…°å·</span><span class="se">\"</span><span class="s2">"</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™å°†æŸ¥æ‰¾åŒ…å« â€œç”˜è‚ƒçœ å…°å·â€ çŸ­è¯­çš„æ–‡æ¡£ã€‚</p>

<p><strong>å­—æ®µä¼˜å…ˆçº§</strong>ï¼š</p>

<p>å¦‚æœæŸ¥è¯¢ä¸­å¤šä¸ªå­—æ®µåŒ…å«ç›¸åŒçš„è¯è¯­ï¼Œä½ å¯ä»¥ä¸ºå­—æ®µæŒ‡å®šæƒé‡ï¼Œä»¥ä¾¿ç»™ç‰¹å®šå­—æ®µæ›´å¤šçš„åŒ¹é…ä¼˜å…ˆçº§ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ^2 åŒ—äº¬"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"memberInfo.name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"memberInfo.address"</span><span class="p">]</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">memberInfo.name</code> å­—æ®µçš„åŒ¹é…ä¼šæ¯” <code class="language-plaintext highlighter-rouge">memberInfo.address</code> å­—æ®µçš„åŒ¹é…æ›´é‡è¦ï¼Œå› ä¸º <code class="language-plaintext highlighter-rouge">^2</code> ç»™äº† <code class="language-plaintext highlighter-rouge">memberInfo.name</code> å­—æ®µä¸€ä¸ªæƒé‡ã€‚</p>

<p><strong>è§£æé”™è¯¯æ§åˆ¶</strong>ï¼š</p>

<p>ä½ è¿˜å¯ä»¥è®¾ç½® <code class="language-plaintext highlighter-rouge">allow_leading_wildcard</code> å‚æ•°æ¥æ§åˆ¶æ˜¯å¦å…è®¸ä»¥é€šé…ç¬¦å¼€å¤´çš„æŸ¥è¯¢ï¼Œé»˜è®¤æƒ…å†µä¸‹ Elasticsearch ä¼šæ‹’ç»ä»¥ <code class="language-plaintext highlighter-rouge">*</code> æˆ– <code class="language-plaintext highlighter-rouge">?</code> å¼€å¤´çš„æŸ¥è¯¢ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*ç”˜è‚ƒ"</span><span class="p">,</span><span class="w">
     </span><span class="nl">"allow_leading_wildcard"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™å…è®¸æŸ¥è¯¢ä»¥ <code class="language-plaintext highlighter-rouge">*</code> å¼€å¤´çš„æŸ¥è¯¢ï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">*ç”˜è‚ƒ</code>ã€‚</p>

<p><strong>æ”¯æŒç©ºæ ¼åˆ†éš”ç¬¦</strong>ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢æ”¯æŒç©ºæ ¼åˆ†éš”ç¬¦æ¥ç»„åˆå¤šä¸ªæŸ¥è¯¢é¡¹ï¼Œå…è®¸ç”¨æˆ·åœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­ä½¿ç”¨ç©ºæ ¼æ¥åˆ†éš”ä¸åŒçš„æŸ¥è¯¢æ¡ä»¶ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ åŒ—äº¬ ä¸Šæµ·"</span><span class="w">
   </span><span class="p">}</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¿™å°†æŸ¥æ‰¾åŒ…å« â€œç”˜è‚ƒçœâ€ã€â€åŒ—äº¬â€ å’Œ â€œä¸Šæµ·â€ çš„æ–‡æ¡£ã€‚</p>

<hr />

<p><strong>æ§åˆ¶ç¬¦</strong></p>

<p>åœ¨ Elasticsearch ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢æ˜¯ä¸€ç§éå¸¸å¼ºå¤§çš„æŸ¥è¯¢æ–¹å¼ï¼Œå®ƒæ”¯æŒå¤æ‚çš„æŸ¥è¯¢è¯­æ³•å’Œçµæ´»çš„æŸ¥è¯¢è¡¨è¾¾å¼ã€‚é€šè¿‡ <code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢ï¼Œä½ å¯ä»¥æ„å»ºå…·æœ‰é«˜çº§æŸ¥è¯¢æ¡ä»¶çš„æœç´¢è¯·æ±‚ï¼Œæ”¯æŒå¸ƒå°”è¿ç®—ç¬¦ã€é€šé…ç¬¦ã€çŸ­è¯­æŸ¥è¯¢ã€å­—æ®µçº§æŸ¥è¯¢ç­‰å¤šç§åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯ <code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢çš„å¸¸ç”¨æ–¹æ³•å’ŒåŠŸèƒ½ï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">query</code></strong> - æŸ¥è¯¢å­—ç¬¦ä¸²</p>

<p><code class="language-plaintext highlighter-rouge">query</code> æ˜¯ <code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢çš„æ ¸å¿ƒï¼Œå®šä¹‰äº†æœç´¢çš„æŸ¥è¯¢è¡¨è¾¾å¼ã€‚ä½ å¯ä»¥åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨å¤šä¸ªè¿ç®—ç¬¦ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">AND</code>, <code class="language-plaintext highlighter-rouge">OR</code>, <code class="language-plaintext highlighter-rouge">NOT</code>ï¼‰æ¥æ„å»ºå¤æ‚çš„æŸ¥è¯¢ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">default_operator</code></strong> - è®¾ç½®é»˜è®¤æ“ä½œç¬¦</p>

<p><code class="language-plaintext highlighter-rouge">default_operator</code> ç”¨æ¥è®¾ç½®æŸ¥è¯¢ä¸­çš„é»˜è®¤æ“ä½œç¬¦ã€‚å¦‚æœæŸ¥è¯¢å­—ç¬¦ä¸²ä¸­æ²¡æœ‰æ˜ç¡®æŒ‡å®šæ“ä½œç¬¦ï¼Œé»˜è®¤æ“ä½œç¬¦å°†è¢«åº”ç”¨ã€‚å¸¸è§çš„æ“ä½œç¬¦æœ‰ <code class="language-plaintext highlighter-rouge">OR</code> å’Œ <code class="language-plaintext highlighter-rouge">AND</code>ã€‚</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">AND</code></strong>ï¼šå¦‚æœä¸¤ä¸ªæŸ¥è¯¢è¯éƒ½å‡ºç°ï¼Œåˆ™è¿”å›åŒ¹é…ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">OR</code></strong>ï¼šåªè¦å…¶ä¸­ä¸€ä¸ªæŸ¥è¯¢è¯å‡ºç°å³å¯ã€‚</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"default_operator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AND"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Java ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> 
    <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="o">).</span><span class="na">defaultOperator</span><span class="o">(</span><span class="nc">QueryStringQuery</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">AND</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">analyze_wildcard</code></strong> - å¯ç”¨æˆ–ç¦ç”¨é€šé…ç¬¦åˆ†æ</p>

<p>Elasticsearch é»˜è®¤ä¸å¯¹é€šé…ç¬¦ (<code class="language-plaintext highlighter-rouge">*</code>, <code class="language-plaintext highlighter-rouge">?</code>) è¿›è¡Œåˆ†æã€‚å¦‚æœä½ å¸Œæœ›åœ¨æŸ¥è¯¢ä¸­å¯ç”¨é€šé…ç¬¦çš„åˆ†æï¼Œå¯ä»¥å°† <code class="language-plaintext highlighter-rouge">analyze_wildcard</code> è®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">true</code>ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒ* AND åŒ—äº¬?"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"analyze_wildcard"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Java ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> 
    <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒ* AND åŒ—äº¬?"</span><span class="o">).</span><span class="na">analyzeWildcard</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">escape</code></strong> - å¯ç”¨æˆ–ç¦ç”¨ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰</p>

<p>å¦‚æœä½ åœ¨æŸ¥è¯¢å­—ç¬¦ä¸²ä¸­éœ€è¦ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, <code class="language-plaintext highlighter-rouge">=</code>, <code class="language-plaintext highlighter-rouge">&amp;&amp;</code>, <code class="language-plaintext highlighter-rouge">||</code>, <code class="language-plaintext highlighter-rouge">&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;</code>, <code class="language-plaintext highlighter-rouge">!</code>, <code class="language-plaintext highlighter-rouge">()</code>, <code class="language-plaintext highlighter-rouge">{}</code>, <code class="language-plaintext highlighter-rouge">[]</code>, <code class="language-plaintext highlighter-rouge">^</code>, <code class="language-plaintext highlighter-rouge">"</code>, <code class="language-plaintext highlighter-rouge">~</code>, <code class="language-plaintext highlighter-rouge">*</code>, <code class="language-plaintext highlighter-rouge">?</code>, <code class="language-plaintext highlighter-rouge">:</code>ï¼‰ï¼Œå¹¶ä¸”ä¸å¸Œæœ›å®ƒä»¬è¢«å½“ä½œè¿ç®—ç¬¦å¤„ç†ï¼Œä½ å¯ä»¥è®¾ç½® <code class="language-plaintext highlighter-rouge">escape</code> ä¸º <code class="language-plaintext highlighter-rouge">true</code> æ¥å¯¹å®ƒä»¬è¿›è¡Œè½¬ä¹‰ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"address:ç”˜è‚ƒçœ AND description:</span><span class="se">\"</span><span class="s2">åŒ—äº¬çš„æ™¯ç‚¹</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"escape"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Java ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> 
    <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"address:ç”˜è‚ƒçœ AND description:\"åŒ—äº¬çš„æ™¯ç‚¹\""</span><span class="o">).</span><span class="na">escape</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">quote_field_suffix</code></strong> - æŒ‡å®šçŸ­è¯­æŸ¥è¯¢æ—¶çš„å­—æ®µåç¼€</p>

<p>å¦‚æœå­—æ®µæ”¯æŒçŸ­è¯­æŸ¥è¯¢ï¼Œ<code class="language-plaintext highlighter-rouge">quote_field_suffix</code> ç”¨äºåœ¨çŸ­è¯­æŸ¥è¯¢æ—¶æ·»åŠ å­—æ®µåç¼€ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒçŸ­è¯­æŸ¥è¯¢ä¼šåœ¨å­—æ®µåååŠ ä¸Š <code class="language-plaintext highlighter-rouge">.keyword</code> åç¼€æ¥æŒ‡å®šç²¾ç¡®åŒ¹é…ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"</span><span class="se">\"</span><span class="s2">ç”˜è‚ƒçœ åŒ—äº¬</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"quote_field_suffix"</span><span class="p">:</span><span class="w"> </span><span class="s2">".keyword"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> 
    <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"\"ç”˜è‚ƒçœ åŒ—äº¬\""</span><span class="o">).</span><span class="na">quoteFieldSuffix</span><span class="o">(</span><span class="s">".keyword"</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">fuzzy_max_expansions</code></strong> - è®¾ç½®æ¨¡ç³ŠæŸ¥è¯¢çš„æœ€å¤§æ‰©å±•æ•°</p>

<p>å¦‚æœæŸ¥è¯¢å­—ç¬¦ä¸²ä¸­åŒ…å«æ¨¡ç³ŠæŸ¥è¯¢ï¼ˆä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">~</code> åç¼€çš„æŸ¥è¯¢ï¼‰ï¼Œåˆ™ <code class="language-plaintext highlighter-rouge">fuzzy_max_expansions</code> å¯ä»¥é™åˆ¶æ¨¡ç³ŠæŸ¥è¯¢çš„æœ€å¤§æ‰©å±•æ•°ï¼Œé¿å…ç”Ÿæˆè¿‡å¤šçš„æ‰©å±•è¯ã€‚</p>

<p>ç¤ºä¾‹ï¼š</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ~2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"fuzzy_max_expansions"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Java ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> 
    <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ~2"</span><span class="o">).</span><span class="na">fuzzyMaxExpansions</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">tie_breaker</code></strong> - å¤šå­—æ®µæŸ¥è¯¢çš„å¾—åˆ†åˆå¹¶ç­–ç•¥</p>

<p>å½“æŸ¥è¯¢å¤šä¸ªå­—æ®µæ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">tie_breaker</code> ç”¨æ¥æŒ‡å®šå¦‚æœæŸäº›å­—æ®µå¾—åˆ†ç›¸åŒï¼Œåº”è¯¥å¦‚ä½•åˆå¹¶å®ƒä»¬çš„å¾—åˆ†ã€‚<code class="language-plaintext highlighter-rouge">tie_breaker</code> çš„å€¼ä»‹äº <code class="language-plaintext highlighter-rouge">0</code> å’Œ <code class="language-plaintext highlighter-rouge">1</code> ä¹‹é—´ï¼Œé»˜è®¤å€¼ä¸º <code class="language-plaintext highlighter-rouge">0</code>ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">tie_breaker</code> å€¼æ¥è¿‘ 0ï¼šä¼šä¼˜å…ˆè€ƒè™‘é«˜å¾—åˆ†çš„å­—æ®µã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">tie_breaker</code> å€¼æ¥è¿‘ 1ï¼šä¼šè®©æ‰€æœ‰å­—æ®µå¾—åˆ†å·®è·è¾ƒå°ã€‚</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"address^2"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"tie_breaker"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> 
    <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="o">).</span><span class="na">fields</span><span class="o">(</span><span class="s">"address^2"</span><span class="o">,</span> <span class="s">"description"</span><span class="o">).</span><span class="na">tieBreaker</span><span class="o">(</span><span class="mf">0.3</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">allow_leading_wildcard</code></strong> - æ˜¯å¦å…è®¸é€šé…ç¬¦ä»¥ <code class="language-plaintext highlighter-rouge">*</code> å¼€å¤´</p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢ä¸å…è®¸é€šé…ç¬¦ä»¥ <code class="language-plaintext highlighter-rouge">*</code> å¼€å¤´ï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">allow_leading_wildcard</code> ä¸º <code class="language-plaintext highlighter-rouge">true</code>ï¼Œä½ å¯ä»¥å…è®¸ä»¥ <code class="language-plaintext highlighter-rouge">*</code> å¼€å¤´çš„é€šé…ç¬¦æŸ¥è¯¢ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒ*"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"allow_leading_wildcard"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> 
    <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒ*"</span><span class="o">).</span><span class="na">allowLeadingWildcard</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">minimum_should_match</code></strong> - è®¾ç½® <code class="language-plaintext highlighter-rouge">should</code> å­å¥çš„æœ€å°åŒ¹é…æ•°</p>

<p><code class="language-plaintext highlighter-rouge">minimum_should_match</code> ç”¨æ¥æ§åˆ¶ <code class="language-plaintext highlighter-rouge">should</code> å­å¥çš„æœ€å°åŒ¹é…æ•°ã€‚å®ƒé€šå¸¸ä¸å¸ƒå°”æŸ¥è¯¢ç»“åˆä½¿ç”¨ï¼Œæ§åˆ¶ <code class="language-plaintext highlighter-rouge">should</code> å­å¥å¿…é¡»æ»¡è¶³å¤šå°‘ä¸ªæ‰èƒ½è¢«è§†ä¸ºåŒ¹é…ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ OR åŒ—äº¬"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"minimum_should_match"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Java ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> 
    <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ OR åŒ—äº¬"</span><span class="o">).</span><span class="na">minimumShouldMatch</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢éå¸¸å¼ºå¤§ï¼Œæ”¯æŒå¤šç§æ“ä½œç¬¦ã€é€šé…ç¬¦ã€çŸ­è¯­æŸ¥è¯¢ç­‰å¤æ‚æŸ¥è¯¢éœ€æ±‚ã€‚å¸¸ç”¨çš„æ–¹æ³•åŒ…æ‹¬ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">query</code>ï¼šæŸ¥è¯¢å­—ç¬¦ä¸²æœ¬èº«ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">fields</code>ï¼šæŒ‡å®šæŸ¥è¯¢çš„å­—æ®µã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">default_operator</code>ï¼šè®¾ç½®é»˜è®¤æ“ä½œç¬¦ï¼ˆ<code class="language-plaintext highlighter-rouge">AND</code> æˆ– <code class="language-plaintext highlighter-rouge">OR</code>ï¼‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">analyze_wildcard</code>ï¼šå¯ç”¨é€šé…ç¬¦åˆ†æã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">escape</code>ï¼šå¯ç”¨ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">quote_field_suffix</code>ï¼šè®¾ç½®å­—æ®µåç¼€ï¼Œç”¨äºçŸ­è¯­æŸ¥è¯¢ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">fuzzy_max_expansions</code>ï¼šé™åˆ¶æ¨¡ç³ŠæŸ¥è¯¢çš„æ‰©å±•æ•°é‡ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">tie_breaker</code>ï¼šåˆå¹¶å¤šä¸ªå­—æ®µå¾—åˆ†æ—¶ä½¿ç”¨çš„ç­–ç•¥ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">allow_leading_wildcard</code>ï¼šå…è®¸é€šé…ç¬¦ä»¥ <code class="language-plaintext highlighter-rouge">*</code> å¼€å¤´ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">minimum_should_match</code>ï¼šè®¾ç½®æœ€å°åŒ¹é…çš„ <code class="language-plaintext highlighter-rouge">should</code> å­å¥æ•°é‡ã€‚</li>
</ul>

<p>è¿™äº›åŠŸèƒ½ä½¿å¾— <code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢éå¸¸é€‚ç”¨äºéœ€è¦å¤æ‚æŸ¥è¯¢è¡¨è¾¾å¼çš„åœºæ™¯ï¼Œå¦‚å…¨æ–‡æœç´¢å’Œå¤šå­—æ®µåŒ¹é…ç­‰ã€‚</p>

<hr />

<p><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢é€‚ç”¨äºå¤æ‚çš„æŸ¥è¯¢åœºæ™¯ï¼Œèƒ½å¤Ÿå¤„ç†é€šé…ç¬¦ã€å¸ƒå°”æ“ä½œã€çŸ­è¯­æŸ¥è¯¢ç­‰ã€‚å¦‚æœä½ å¸Œæœ›æ”¯æŒæ›´å¤šè‡ªç”±æ–‡æœ¬æŸ¥è¯¢ï¼Œå¯ä»¥é€‰æ‹©è¿™ç§æŸ¥è¯¢ç±»å‹ã€‚ä½†å®ƒä¹Ÿå®¹æ˜“å‡ºé”™ï¼Œç‰¹åˆ«æ˜¯å½“æŸ¥è¯¢å­—ç¬¦ä¸²ä¸æ­£ç¡®æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´è§£æé”™è¯¯æˆ–æ€§èƒ½é—®é¢˜ã€‚æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨æ—¶è¦å°å¿ƒï¼Œç¡®ä¿æŸ¥è¯¢è¯­æ³•ç¬¦åˆé¢„æœŸã€‚</p>

<p>åœ¨ Java ä¸­ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢ï¼Œå¯ä»¥é€šè¿‡ Elasticsearch å®¢æˆ·ç«¯æ„å»ºç±»ä¼¼çš„æŸ¥è¯¢ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">queryStringQuery</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> <span class="n">qs</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ AND (åŒ—äº¬ OR ä¸Šæµ·)"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="s">"memberInfo"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">defaultOperator</span><span class="o">(</span><span class="nc">QueryStringQuery</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">OR</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">Query.of(q -&gt; q.queryString(...))</code></strong></p>

<p>è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">Query.of()</code> æ˜¯ Elasticsearch å®¢æˆ·ç«¯çš„æ„å»ºå™¨æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å¯¹è±¡ã€‚<code class="language-plaintext highlighter-rouge">queryString</code> æ˜¯æŸ¥è¯¢çš„ç±»å‹ã€‚é€šè¿‡é“¾å¼è°ƒç”¨ï¼Œä½ å¯ä»¥ä¸ºæŸ¥è¯¢æŒ‡å®šå…·ä½“çš„æ¡ä»¶ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">query("ç”˜è‚ƒçœ AND (åŒ—äº¬ OR ä¸Šæµ·)")</code></strong></p>

<p><code class="language-plaintext highlighter-rouge">queryString</code> æŸ¥è¯¢çš„æ ¸å¿ƒæ˜¯ <code class="language-plaintext highlighter-rouge">query</code> æ–¹æ³•ï¼Œå®ƒæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œè¡¨ç¤ºæŸ¥è¯¢çš„æ–‡æœ¬ã€‚è¯¥å­—ç¬¦ä¸²ä½¿ç”¨ Lucene æŸ¥è¯¢è¯­æ³•ï¼Œæ”¯æŒå„ç§æŸ¥è¯¢åŠŸèƒ½ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">AND</code>ï¼šè¡¨ç¤ºæ¡ä»¶åŒæ—¶æ»¡è¶³ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">OR</code>ï¼šè¡¨ç¤ºæ¡ä»¶ä¸­è‡³å°‘æ»¡è¶³ä¸€ä¸ªã€‚</li>
  <li>æ‹¬å·ï¼šç”¨äºåˆ†ç»„æ¡ä»¶ï¼Œå¦‚ <code class="language-plaintext highlighter-rouge">(åŒ—äº¬ OR ä¸Šæµ·)</code>ï¼Œè¡¨ç¤ºåŒ—äº¬æˆ–ä¸Šæµ·ä¸­çš„ä»»ä½•ä¸€ä¸ªã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">fields("memberInfo.name")</code></strong></p>

<p>é€šè¿‡ <code class="language-plaintext highlighter-rouge">fields</code> æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šæŸ¥è¯¢çš„å­—æ®µã€‚è¿™é‡ŒæŸ¥è¯¢çš„å­—æ®µæ˜¯ <code class="language-plaintext highlighter-rouge">memberInfo</code>ã€‚è¿™æ„å‘³ç€è¯¥æŸ¥è¯¢å°†ä¼šåŒ¹é…æ–‡æ¡£ä¸­ <code class="language-plaintext highlighter-rouge">memberInfo</code> å­—æ®µçš„å†…å®¹ï¼Œè€Œä¸æ˜¯å…¨å±€è¿›è¡ŒåŒ¹é…ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">**defaultOperator(QueryStringQuery.Operator.OR)</code>**</p>

<p><code class="language-plaintext highlighter-rouge">defaultOperator</code> æŒ‡å®šäº†é»˜è®¤æ“ä½œç¬¦ã€‚Elasticsearch çš„ <code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢æ”¯æŒä¸¤ä¸ªæ“ä½œç¬¦ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">OR</code>ï¼ˆé»˜è®¤ï¼‰ï¼šè¡¨ç¤ºå¦‚æœæŸ¥è¯¢å­—ç¬¦ä¸²ä¸­æ²¡æœ‰æ˜ç¡®æŒ‡å®šæ“ä½œç¬¦ï¼Œåˆ™é»˜è®¤ä¸º OR æ“ä½œã€‚ä¾‹å¦‚ï¼ŒæŸ¥è¯¢ <code class="language-plaintext highlighter-rouge">ç”˜è‚ƒçœ åŒ—äº¬ ä¸Šæµ·</code> å®é™…ä¸Šç›¸å½“äº <code class="language-plaintext highlighter-rouge">ç”˜è‚ƒçœ OR åŒ—äº¬ OR ä¸Šæµ·</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">AND</code>ï¼šè¡¨ç¤ºå¦‚æœæ²¡æœ‰æŒ‡å®šæ“ä½œç¬¦ï¼Œåˆ™é»˜è®¤ä¸º AND æ“ä½œï¼Œæ‰€æœ‰æ¡ä»¶éƒ½å¿…é¡»æ»¡è¶³ã€‚</li>
</ul>

<p>é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">QueryStringQuery.Operator.OR</code>ï¼Œå¦‚æœæŸ¥è¯¢ä¸­æ²¡æœ‰æŒ‡å®šæ“ä½œç¬¦ï¼Œåˆ™ä¼šä½¿ç”¨ <code class="language-plaintext highlighter-rouge">OR</code> è¿›è¡Œé»˜è®¤è¿æ¥ã€‚</p>

<h5 id="çŸ­è¯­æŸ¥è¯¢">çŸ­è¯­æŸ¥è¯¢</h5>

<p><strong><code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢</strong></p>

<p><code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢ç”¨äºç²¾ç¡®åŒ¹é…çŸ­è¯­ï¼Œç¡®ä¿æŸ¥è¯¢çš„è¯è¯­é¡ºåºå’Œä½ç½®ä¸æ–‡æ¡£ä¸­çš„åŒ¹é…å†…å®¹ä¸€è‡´ã€‚å®ƒæ˜¯æ‰§è¡ŒçŸ­è¯­æŸ¥è¯¢æ—¶æœ€å¸¸ç”¨çš„ä¸€ç§æ–¹å¼ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"åŒ—äº¬ ä¸Šæµ·"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¯¥æŸ¥è¯¢å°†åŒ¹é…åŒ…å«ç²¾ç¡®çŸ­è¯­â€œåŒ—äº¬ ä¸Šæµ·â€çš„æ–‡æ¡£ã€‚è¯è¯­é¡ºåºå¿…é¡»ä¸€è‡´ï¼Œä¸”è¯è¯­é—´çš„ç©ºæ ¼æ•°é‡ä¸æŸ¥è¯¢ç›¸åŒã€‚</p>

<p>Java ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">matchPhrase</span><span class="o">(</span><span class="n">mp</span> <span class="o">-&gt;</span> <span class="n">mp</span>
    <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"address"</span><span class="o">)</span>  <span class="c1">// å­—æ®µå</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"åŒ—äº¬ ä¸Šæµ·"</span><span class="o">)</span>  <span class="c1">// çŸ­è¯­æŸ¥è¯¢</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢</strong></p>

<p><code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢æ”¯æŒå¤šä¸ªå­—æ®µçš„çŸ­è¯­æŸ¥è¯¢ã€‚å®ƒæ˜¯ <code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢çš„ä¸€ç§æ‰©å±•ï¼Œé€‚ç”¨äºåŒæ—¶åœ¨å¤šä¸ªå­—æ®µä¸Šè¿›è¡ŒçŸ­è¯­åŒ¹é…ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"multi_match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"åŒ—äº¬ ä¸Šæµ·"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"address"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"phrase"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¯¥æŸ¥è¯¢å°†åœ¨å­—æ®µ <code class="language-plaintext highlighter-rouge">address</code> å’Œ <code class="language-plaintext highlighter-rouge">description</code> ä¸Šæ‰§è¡ŒçŸ­è¯­æŸ¥è¯¢ï¼Œè¦æ±‚åŒæ—¶åŒ¹é…â€œåŒ—äº¬ ä¸Šæµ·â€ã€‚é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">type: "phrase"</code>ï¼Œç¡®ä¿æ‰§è¡Œçš„æ˜¯çŸ­è¯­æŸ¥è¯¢ã€‚</p>

<p>Java ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">multiMatch</span><span class="o">(</span><span class="n">mm</span> <span class="o">-&gt;</span> <span class="n">mm</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"åŒ—äº¬ ä¸Šæµ·"</span><span class="o">)</span>  <span class="c1">// æŸ¥è¯¢çŸ­è¯­</span>
    <span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="s">"address"</span><span class="o">,</span> <span class="s">"description"</span><span class="o">)</span>  <span class="c1">// å­—æ®µå</span>
    <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="nc">MultiMatchQuery</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">PHRASE</span><span class="o">)</span>  <span class="c1">// ç¡®ä¿æ˜¯çŸ­è¯­æŸ¥è¯¢</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢</strong></p>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢æ”¯æŒé€šè¿‡è¯­æ³•è¿›è¡Œå¤æ‚çš„çŸ­è¯­æŸ¥è¯¢ï¼Œå¹¶ä¸”æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ï¼Œå°¤å…¶æ˜¯åœ¨å­—æ®µé™åˆ¶ã€æ“ä½œç¬¦ã€åˆ†è¯ç­‰æ–¹é¢ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"</span><span class="se">\"</span><span class="s2">åŒ—äº¬ ä¸Šæµ·</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"address"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢æ”¯æŒåŒ…å«ç²¾ç¡®çŸ­è¯­çš„æŸ¥è¯¢ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">\"\"</code> æ¥åŒ…è£¹çŸ­è¯­ã€‚é€‚åˆè¿›è¡Œå¤šç§å¤æ‚æŸ¥è¯¢ï¼Œå¦‚ä½¿ç”¨å¸ƒå°”æ“ä½œç¬¦ã€é€šé…ç¬¦ç­‰ã€‚</p>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> <span class="n">qs</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"\"åŒ—äº¬ ä¸Šæµ·\""</span><span class="o">)</span>  <span class="c1">// çŸ­è¯­æŸ¥è¯¢</span>
    <span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="s">"address"</span><span class="o">)</span>  <span class="c1">// æŸ¥è¯¢å­—æ®µ</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">span_near</code> æŸ¥è¯¢</strong></p>

<p><code class="language-plaintext highlighter-rouge">span_near</code> æŸ¥è¯¢é€‚ç”¨äºéœ€è¦åœ¨æ–‡æ¡£ä¸­åŒ¹é…ä¸€ç»„çŸ­è¯­ï¼Œå¹¶ä¸”çŸ­è¯­ä¹‹é—´æœ‰ç‰¹å®šé¡ºåºæˆ–è·ç¦»è¦æ±‚çš„åœºæ™¯ã€‚å®ƒå¯ä»¥åœ¨æŸ¥è¯¢æ—¶æŒ‡å®šâ€œslopâ€ï¼ˆå…è®¸çš„è¯è¯­é—´è·ï¼‰ï¼Œä»¥åŠæ˜¯å¦è¦æ±‚è¯è¯­é¡ºåºä¸€è‡´ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"span_near"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"clauses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"span_term"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"åŒ—äº¬"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"span_term"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ä¸Šæµ·"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"slop"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
      </span><span class="nl">"in_order"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¯¥æŸ¥è¯¢è¦æ±‚è¯è¯­â€œåŒ—äº¬â€å’Œâ€œä¸Šæµ·â€åœ¨ <code class="language-plaintext highlighter-rouge">content</code> å­—æ®µä¸­é—´æœ‰æœ€å¤š2ä¸ªè¯ï¼Œå¹¶ä¸”è¯è¯­é¡ºåºå¿…é¡»ä¸€è‡´ã€‚</p>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">spanNear</span><span class="o">(</span><span class="n">sn</span> <span class="o">-&gt;</span> <span class="n">sn</span>
    <span class="o">.</span><span class="na">clauses</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
        <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q1</span> <span class="o">-&gt;</span> <span class="n">q1</span><span class="o">.</span><span class="na">spanTerm</span><span class="o">(</span><span class="n">st</span> <span class="o">-&gt;</span> <span class="n">st</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"content"</span><span class="o">).</span><span class="na">term</span><span class="o">(</span><span class="s">"åŒ—äº¬"</span><span class="o">))),</span>
        <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q2</span> <span class="o">-&gt;</span> <span class="n">q2</span><span class="o">.</span><span class="na">spanTerm</span><span class="o">(</span><span class="n">st</span> <span class="o">-&gt;</span> <span class="n">st</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"content"</span><span class="o">).</span><span class="na">term</span><span class="o">(</span><span class="s">"ä¸Šæµ·"</span><span class="o">)))</span>
    <span class="o">))</span>
    <span class="o">.</span><span class="na">slop</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
    <span class="o">.</span><span class="na">inOrder</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">phrase_prefix</code> æŸ¥è¯¢</strong></p>

<p><code class="language-plaintext highlighter-rouge">phrase_prefix</code> æŸ¥è¯¢åœ¨çŸ­è¯­æŸ¥è¯¢çš„åŸºç¡€ä¸Šå…è®¸éƒ¨åˆ†è¯è¯­è¿›è¡Œå‰ç¼€åŒ¹é…ã€‚è¿™ç§æŸ¥è¯¢å¸¸ç”¨äºåŒ¹é…ä»¥æŸä¸ªè¯ä¸ºå‰ç¼€çš„çŸ­è¯­ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_phrase_prefix"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"å¤©æ´¥"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¯¥æŸ¥è¯¢å°†åŒ¹é…æ‰€æœ‰åŒ…å«ä»¥â€œå¤©æ´¥â€å¼€å¤´çš„çŸ­è¯­çš„æ–‡æ¡£ã€‚</p>

<p>Java ç¤ºä¾‹ï¼š</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">matchPhrasePrefix</span><span class="o">(</span><span class="n">mp</span> <span class="o">-&gt;</span> <span class="n">mp</span>
    <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"address"</span><span class="o">)</span>  <span class="c1">// å­—æ®µå</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"å¤©æ´¥"</span><span class="o">)</span>  <span class="c1">// å‰ç¼€åŒ¹é…</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢ (ä¸ <code class="language-plaintext highlighter-rouge">operator</code> é…åˆä½¿ç”¨)</strong></p>

<p><code class="language-plaintext highlighter-rouge">match</code> æŸ¥è¯¢æ˜¯æœ€å¸¸è§çš„æŸ¥è¯¢ç±»å‹ï¼Œé€‚ç”¨äºå•ä¸ªè¯çš„æŸ¥è¯¢ï¼Œä½†åœ¨ä¸ <code class="language-plaintext highlighter-rouge">operator</code> é…åˆä½¿ç”¨æ—¶ï¼Œå®ƒä¹Ÿå¯ä»¥æ¨¡ä»¿çŸ­è¯­æŸ¥è¯¢çš„è¡Œä¸ºã€‚é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">operator: AND</code>ï¼Œä½ å¯ä»¥è¦æ±‚æŸ¥è¯¢çš„æ‰€æœ‰è¯è¯­éƒ½å‡ºç°åœ¨æ–‡æ¡£ä¸­ï¼Œä½†ä¸ä¿è¯é¡ºåºå’Œä½ç½®ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"åŒ—äº¬ ä¸Šæµ·"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"operator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"and"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>è¯¥æŸ¥è¯¢å°†åŒ¹é…åŒ…å«â€œåŒ—äº¬â€å’Œâ€œä¸Šæµ·â€çš„æ–‡æ¡£ï¼Œä½†ä¸è¦æ±‚å®ƒä»¬æŒ‰é¡ºåºå‡ºç°ã€‚</p>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span>
    <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"address"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"åŒ—äº¬ ä¸Šæµ·"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">operator</span><span class="o">(</span><span class="nc">MatchQuery</span><span class="o">.</span><span class="na">Operator</span><span class="o">.</span><span class="na">AND</span><span class="o">)</span>  <span class="c1">// å¼ºåˆ¶æ‰€æœ‰è¯è¯­éƒ½å¿…é¡»å‡ºç°</span>
<span class="o">));</span>
</code></pre></div></div>

<p>ä»¥ä¸‹æ˜¯æ”¯æŒçŸ­è¯­æŸ¥è¯¢çš„å¸¸è§æŸ¥è¯¢ç±»å‹ï¼š</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">match_phrase</code></strong>ï¼šæœ€ç›´æ¥çš„çŸ­è¯­æŸ¥è¯¢ï¼Œç¡®ä¿è¯è¯­é¡ºåºå’Œä½ç½®ç²¾ç¡®åŒ¹é…ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">multi_match</code></strong>ï¼šé€‚ç”¨äºå¤šä¸ªå­—æ®µçš„çŸ­è¯­æŸ¥è¯¢ï¼Œå¯ä»¥é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">type: "phrase"</code> å®ç°çŸ­è¯­åŒ¹é…ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">query_string</code></strong>ï¼šæä¾›å¤æ‚çš„æŸ¥è¯¢è¯­æ³•ï¼Œæ”¯æŒçŸ­è¯­æŸ¥è¯¢ï¼Œå¹¶å…è®¸å­—æ®µé™åˆ¶å’Œæ“ä½œç¬¦ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">span_near</code></strong>ï¼šé€‚ç”¨äºè¦æ±‚çŸ­è¯­ä¹‹é—´æœ‰ä¸€å®šè·ç¦»æˆ–é¡ºåºå…³ç³»çš„æŸ¥è¯¢ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">phrase_prefix</code></strong>ï¼šæ”¯æŒçŸ­è¯­æŸ¥è¯¢å’Œå‰ç¼€åŒ¹é…ï¼Œé€‚ç”¨äºè¯è¯­å‰ç¼€çš„æƒ…å†µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">match</code></strong>ï¼šå¯ä»¥é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">operator: AND</code> æ¥æ¨¡æ‹ŸçŸ­è¯­æŸ¥è¯¢ï¼Œä½†ä¸ä¿è¯è¯è¯­é¡ºåºã€‚</li>
</ol>

<p>å¯¹äºåªè¦æ±‚çŸ­è¯­åŒ¹é…ä¸”é¡ºåºä¸€è‡´çš„æƒ…å†µï¼Œ<code class="language-plaintext highlighter-rouge">match_phrase</code> å’Œ <code class="language-plaintext highlighter-rouge">multi_match</code> æ˜¯æœ€å¸¸è§çš„é€‰æ‹©ã€‚è€Œå¦‚æœä½ æœ‰æ›´å¤æ‚çš„éœ€æ±‚ï¼Œå¦‚çŸ­è¯­ä¹‹é—´æœ‰é—´è·ã€é¡ºåºè¦æ±‚ç­‰ï¼Œ<code class="language-plaintext highlighter-rouge">span_near</code> æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p>

<h5 id="å¤šå­—æ®µçŸ­è¯­æŸ¥è¯¢">å¤šå­—æ®µçŸ­è¯­æŸ¥è¯¢</h5>

<p>åœ¨ Elasticsearch ä¸­ï¼Œä»¥ä¸‹å‡ ç§æŸ¥è¯¢æ”¯æŒçŸ­è¯­æŸ¥è¯¢ï¼ˆPhrase Queryï¼‰å¹¶ä¸”å¯ä»¥åŒæ—¶æŸ¥è¯¢å¤šä¸ªå­—æ®µï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢</strong>
<code class="language-plaintext highlighter-rouge">multi_match</code> æŸ¥è¯¢æ”¯æŒçŸ­è¯­æŸ¥è¯¢ï¼Œå¹¶å…è®¸åœ¨å¤šä¸ªå­—æ®µä¸Šæ‰§è¡ŒæŸ¥è¯¢ã€‚é€šè¿‡å°†æŸ¥è¯¢ç±»å‹è®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">phrase</code>ï¼Œä½ å¯ä»¥è¿›è¡ŒçŸ­è¯­æŸ¥è¯¢ï¼Œå¹¶ä¸”æ”¯æŒå¤šä¸ªå­—æ®µã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"multi_match"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"address"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"phrase"</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">ä½¿ç”¨çŸ­è¯­æŸ¥è¯¢</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">query</code></strong>ï¼šæŸ¥è¯¢å†…å®¹ï¼Œæ”¯æŒçŸ­è¯­ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">fields</code></strong>ï¼šå¤šä¸ªå­—æ®µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">type</code></strong>ï¼šæŸ¥è¯¢ç±»å‹ä¸º <code class="language-plaintext highlighter-rouge">phrase</code>ï¼Œè¡¨ç¤ºè¿›è¡ŒçŸ­è¯­æŸ¥è¯¢ã€‚</li>
</ul>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">multiMatch</span><span class="o">(</span><span class="n">mm</span> <span class="o">-&gt;</span> <span class="n">mm</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="o">)</span>  <span class="c1">// æŸ¥è¯¢å†…å®¹</span>
    <span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="s">"address"</span><span class="o">,</span> <span class="s">"description"</span><span class="o">)</span>  <span class="c1">// æŸ¥è¯¢çš„å¤šä¸ªå­—æ®µ</span>
    <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="nc">MultiMatchQuery</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">PHRASE</span><span class="o">)</span>  <span class="c1">// ä½¿ç”¨çŸ­è¯­æŸ¥è¯¢</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢</strong></p>

<p><code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢ä¸ä»…æ”¯æŒå¤æ‚çš„æŸ¥è¯¢è¯­æ³•ï¼Œè¿˜å¯ä»¥è¿›è¡ŒçŸ­è¯­æŸ¥è¯¢ï¼Œå¹¶å…è®¸å¤šä¸ªå­—æ®µåŒæ—¶è¿›è¡ŒåŒ¹é…ã€‚åœ¨ <code class="language-plaintext highlighter-rouge">query_string</code> æŸ¥è¯¢ä¸­ï¼ŒçŸ­è¯­æŸ¥è¯¢å¯ä»¥é€šè¿‡å¼•å·æ¥æŒ‡å®šã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"query_string"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="s2">"</span><span class="se">\"</span><span class="s2">ç”˜è‚ƒçœ åŒ—äº¬</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"address"</span><span class="p">,</span><span class="w"> </span><span class="s2">"description"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">query</code></strong>ï¼šæŸ¥è¯¢å†…å®¹ï¼Œä½¿ç”¨å¼•å·åŒ…å›´ä»¥è¿›è¡ŒçŸ­è¯­åŒ¹é…ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">fields</code></strong>ï¼šå¤šä¸ªå­—æ®µè¿›è¡ŒåŒ¹é…ã€‚</li>
</ul>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span> <span class="n">qs</span>
    <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"\"ç”˜è‚ƒçœ åŒ—äº¬\""</span><span class="o">)</span>  <span class="c1">// çŸ­è¯­æŸ¥è¯¢</span>
    <span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="s">"address"</span><span class="o">,</span> <span class="s">"description"</span><span class="o">)</span>  <span class="c1">// å¤šä¸ªå­—æ®µ</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">bool</code> æŸ¥è¯¢ (with <code class="language-plaintext highlighter-rouge">should</code> and <code class="language-plaintext highlighter-rouge">match_phrase</code>)</strong></p>

<p><code class="language-plaintext highlighter-rouge">bool</code> æŸ¥è¯¢å¯ä»¥ä¸ <code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢ä¸€èµ·ä½¿ç”¨ï¼Œæ”¯æŒå¤šä¸ªå­—æ®µè¿›è¡ŒçŸ­è¯­æŸ¥è¯¢ã€‚é€šè¿‡ <code class="language-plaintext highlighter-rouge">should</code> å­å¥æ¥æŒ‡å®šå¤šä¸ªå­—æ®µã€‚</p>

<p>ç¤ºä¾‹ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"bool"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"should"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">match_phrase</code></strong>ï¼šçŸ­è¯­æŸ¥è¯¢ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">should</code></strong>ï¼šå¤šä¸ªå­—æ®µçš„çŸ­è¯­æŸ¥è¯¢ï¼Œåªè¦æœ‰ä¸€ä¸ªåŒ¹é…å³æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ã€‚</li>
</ul>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
    <span class="o">.</span><span class="na">should</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
        <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q1</span> <span class="o">-&gt;</span> <span class="n">q1</span><span class="o">.</span><span class="na">matchPhrase</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"address"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="o">))),</span>
        <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q2</span> <span class="o">-&gt;</span> <span class="n">q2</span><span class="o">.</span><span class="na">matchPhrase</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"description"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="o">)))</span>
    <span class="o">))</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">dis_max</code> æŸ¥è¯¢ (with <code class="language-plaintext highlighter-rouge">match_phrase</code>)</strong></p>

<p><code class="language-plaintext highlighter-rouge">dis_max</code> æŸ¥è¯¢å¯ä»¥ç”¨äºå¤šä¸ªçŸ­è¯­æŸ¥è¯¢ï¼Œå¹¶è¿”å›åŒ¹é…æœ€å¼ºçš„æŸ¥è¯¢å­—æ®µã€‚æ¯ä¸ªæŸ¥è¯¢éƒ½å¯ä»¥æ˜¯çŸ­è¯­æŸ¥è¯¢ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"dis_max"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"queries"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"match_phrase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"tie_breaker"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.7</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">match_phrase</code></strong>ï¼šçŸ­è¯­æŸ¥è¯¢ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">dis_max</code></strong>ï¼šé€‰æ‹©åŒ¹é…åº¦æœ€é«˜çš„å­—æ®µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">tie_breaker</code></strong>ï¼šå¤šä¸ªæŸ¥è¯¢å¾—åˆ†æ—¶çš„åŠ æƒç³»æ•°ã€‚</li>
</ul>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">disMax</span><span class="o">(</span><span class="n">dm</span> <span class="o">-&gt;</span> <span class="n">dm</span>
    <span class="o">.</span><span class="na">queries</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
        <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q1</span> <span class="o">-&gt;</span> <span class="n">q1</span><span class="o">.</span><span class="na">matchPhrase</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"address"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="o">))),</span>
        <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q2</span> <span class="o">-&gt;</span> <span class="n">q2</span><span class="o">.</span><span class="na">matchPhrase</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"description"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ åŒ—äº¬"</span><span class="o">)))</span>
    <span class="o">))</span>
    <span class="o">.</span><span class="na">tieBreaker</span><span class="o">(</span><span class="mf">0.7</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">span_near</code> æŸ¥è¯¢</strong></p>

<p><code class="language-plaintext highlighter-rouge">span_near</code> æŸ¥è¯¢å…è®¸ä½ æŸ¥æ‰¾å¤šä¸ªçŸ­è¯­æˆ–å•è¯åœ¨æ–‡æ¡£ä¸­çš„ç›¸å¯¹ä½ç½®ã€‚å¦‚æœä½ å¸Œæœ›å¤šä¸ªå­—æ®µä¹‹é—´çš„çŸ­è¯­æˆ–å•è¯æœ‰ç‰¹å®šçš„é¡ºåºæˆ–è·ç¦»ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">span_near</code> æŸ¥è¯¢ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"span_near"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"clauses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"span_term"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ç”˜è‚ƒçœ"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"span_term"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"åŒ—äº¬"</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"slop"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
      </span><span class="nl">"in_order"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">span_term</code></strong>ï¼šæ¯ä¸ªå­—æ®µçš„çŸ­è¯­æŸ¥è¯¢ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">slop</code></strong>ï¼šå…è®¸çš„è¯è¯­é—´è·ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">in_order</code></strong>ï¼šæ˜¯å¦è¦æ±‚è¯è¯­é¡ºåºä¸€è‡´ã€‚</li>
</ul>

<p>Java ç¤ºä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">spanNear</span><span class="o">(</span><span class="n">sn</span> <span class="o">-&gt;</span> <span class="n">sn</span>
    <span class="o">.</span><span class="na">clauses</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
        <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q1</span> <span class="o">-&gt;</span> <span class="n">q1</span><span class="o">.</span><span class="na">spanTerm</span><span class="o">(</span><span class="n">st</span> <span class="o">-&gt;</span> <span class="n">st</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"address"</span><span class="o">).</span><span class="na">term</span><span class="o">(</span><span class="s">"ç”˜è‚ƒçœ"</span><span class="o">))),</span>
        <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q2</span> <span class="o">-&gt;</span> <span class="n">q2</span><span class="o">.</span><span class="na">spanTerm</span><span class="o">(</span><span class="n">st</span> <span class="o">-&gt;</span> <span class="n">st</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"description"</span><span class="o">).</span><span class="na">term</span><span class="o">(</span><span class="s">"åŒ—äº¬"</span><span class="o">)))</span>
    <span class="o">))</span>
    <span class="o">.</span><span class="na">slop</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
    <span class="o">.</span><span class="na">inOrder</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
<span class="o">));</span>
</code></pre></div></div>

<p>ä»¥ä¸‹æŸ¥è¯¢æ”¯æŒçŸ­è¯­æŸ¥è¯¢å¹¶ä¸”å¯ä»¥åº”ç”¨äºå¤šä¸ªå­—æ®µï¼š</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">multi_match</code></strong> æŸ¥è¯¢ï¼šæ”¯æŒçŸ­è¯­æŸ¥è¯¢ (<code class="language-plaintext highlighter-rouge">phrase</code> ç±»å‹)ï¼Œå¯ä»¥æŸ¥è¯¢å¤šä¸ªå­—æ®µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">query_string</code></strong> æŸ¥è¯¢ï¼šé€šè¿‡å¼•å·è¿›è¡ŒçŸ­è¯­æŸ¥è¯¢ï¼Œå¯ä»¥æŸ¥è¯¢å¤šä¸ªå­—æ®µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">bool</code> æŸ¥è¯¢</strong>ï¼šé€šè¿‡ç»“åˆ <code class="language-plaintext highlighter-rouge">should</code> å­å¥å’Œ <code class="language-plaintext highlighter-rouge">match_phrase</code> å­æŸ¥è¯¢ï¼Œæ”¯æŒå¤šä¸ªå­—æ®µçš„çŸ­è¯­æŸ¥è¯¢ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">dis_max</code></strong> æŸ¥è¯¢ï¼šå¤šä¸ª <code class="language-plaintext highlighter-rouge">match_phrase</code> æŸ¥è¯¢ï¼Œé€‰æ‹©å¾—åˆ†æœ€é«˜çš„æŸ¥è¯¢ç»“æœã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">span_near</code></strong> æŸ¥è¯¢ï¼šæ”¯æŒå¤šä¸ªå­—æ®µçš„çŸ­è¯­æŸ¥è¯¢ï¼Œå¹¶æ§åˆ¶è¯è¯­çš„é¡ºåºå’Œè·ç¦»ã€‚</li>
</ol>

<p>è¿™äº›æŸ¥è¯¢æ–¹æ³•å¯ä»¥æ ¹æ®ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚æ¥é€‰æ‹©ã€‚</p>

<p>å®ä¾‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">memberInfoSearchQuery</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="nc">FieldUtil</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="k">new</span> <span class="nc">MemberInfo</span><span class="o">());</span>
            <span class="c1">// åŒ¹é… memberInfo ä¸‹çš„æ‰€æœ‰å­—æ®µ</span>
            <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">fields</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">.</span><span class="na">should</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">matchPhrase</span><span class="o">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">m</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">memberInfoSearch</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="n">f</span><span class="o">))));</span>
            <span class="n">b</span><span class="o">.</span><span class="na">minimumShouldMatch</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">})</span>
<span class="o">);</span>
<span class="nc">Query</span> <span class="n">memberInfoSearchQuery2</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">.</span><span class="na">queryString</span><span class="o">(</span><span class="n">qs</span> <span class="o">-&gt;</span>
            <span class="n">qs</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s">"\""</span><span class="o">+</span><span class="n">memberInfoSearch</span><span class="o">+</span><span class="s">"\""</span><span class="o">)</span> <span class="c1">// ä½¿ç”¨çŸ­è¯­æŸ¥è¯¢</span>
                    <span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="nc">FieldUtil</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="k">new</span> <span class="nc">MemberInfo</span><span class="o">())).</span><span class="na">toList</span><span class="o">())</span>
        <span class="o">)</span>
<span class="o">);</span>
<span class="nc">Query</span> <span class="n">memberInfoSearchQuery3</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">multiMatch</span><span class="o">(</span><span class="n">mm</span> <span class="o">-&gt;</span> <span class="n">mm</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">memberInfoSearch</span><span class="o">)</span>  <span class="c1">// æŸ¥è¯¢çŸ­è¯­</span>
        <span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="nc">FieldUtil</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="k">new</span> <span class="nc">MemberInfo</span><span class="o">())).</span><span class="na">toList</span><span class="o">())</span>  <span class="c1">// æŸ¥è¯¢å¤šä¸ªå­—æ®µ</span>
        <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="nc">TextQueryType</span><span class="o">.</span><span class="na">Phrase</span><span class="o">)</span>  <span class="c1">// ä½¿ç”¨çŸ­è¯­æŸ¥è¯¢</span>
<span class="o">));</span>
<span class="c1">// ä»¥ä¸Šå‡åªèƒ½åŒ¹é…ä¸­æ–‡ likeï¼Œè‹±æ–‡å’Œæ•°å­—æ— æ³•åŒ¹é…</span>
<span class="nc">Query</span> <span class="n">memberInfoSearchQuery4</span> <span class="o">=</span> <span class="nc">Query</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">q</span><span class="o">.</span><span class="na">bool</span><span class="o">(</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">String</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="nc">FieldUtil</span><span class="o">.</span><span class="na">getField</span><span class="o">(</span><span class="k">new</span> <span class="nc">MemberInfo</span><span class="o">());</span>
            <span class="c1">// åŒ¹é… memberInfo ä¸‹çš„æ‰€æœ‰å­—æ®µ</span>
            <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">fields</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="nl">DatabaseConstants:</span><span class="o">:</span><span class="n">addKeyword</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">b</span><span class="o">.</span><span class="na">should</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">wildcard</span><span class="o">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="s">"*"</span><span class="o">+</span><span class="n">memberInfoSearch</span><span class="o">+</span><span class="s">"*"</span><span class="o">))));</span>
            <span class="n">b</span><span class="o">.</span><span class="na">minimumShouldMatch</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">})</span>
<span class="o">);</span>
<span class="c1">// ä¸ºä¿æŒæ€§èƒ½ï¼Œå¯ä»¥é€šè¿‡æ­£åˆ™ä½¿ç”¨ä¸åŒçš„æŸ¥è¯¢æ¡ä»¶</span>
<span class="nc">Query</span> <span class="n">memberInfoSearchQuery</span><span class="o">;</span>
<span class="k">if</span> <span class="o">(</span><span class="n">memberInfoSearch</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"[A-Za-z0-9]+"</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">memberInfoSearchQuery</span> <span class="o">=</span> <span class="n">memberInfoSearchQuery4</span><span class="o">;</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">memberInfoSearchQuery</span> <span class="o">=</span> <span class="n">memberInfoSearchQuery3</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="sort"><code class="language-plaintext highlighter-rouge">Sort</code></h4>

<p>åœ¨ Elasticsearch 8.x ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">Sort</code> ç”¨äºå¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œæ’åºã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨çš„å­—æ®µå’Œæ–¹æ³•ï¼Œä½¿ç”¨ Elasticsearch 8.x çš„æŸ¥è¯¢ DSLï¼ˆDomain Specific Languageï¼‰é£æ ¼ï¼š</p>

<p><strong>Sort by Field</strong></p>

<p>å¯ä»¥é€šè¿‡å­—æ®µåå¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œæ’åºï¼Œå­—æ®µå¯ä»¥æ˜¯æ–‡æœ¬ã€æ•°å­—ã€æ—¥æœŸç­‰ç±»å‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SortField</span> <span class="n">titleSort</span> <span class="o">=</span> <span class="nc">SortField</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
    <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"title"</span><span class="o">))</span>  <span class="c1">// æŒ‰ç…§ "title" å­—æ®µæ’åº</span>
    <span class="o">.</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">ASC</span><span class="o">)</span>  <span class="c1">// æŒ‰å‡åºæ’åº</span>
<span class="o">);</span>

<span class="nc">SortField</span> <span class="n">priceSort</span> <span class="o">=</span> <span class="nc">SortField</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
    <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"price"</span><span class="o">))</span>  <span class="c1">// æŒ‰ç…§ "price" å­—æ®µæ’åº</span>
    <span class="o">.</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">DESC</span><span class="o">)</span>  <span class="c1">// æŒ‰é™åºæ’åº</span>
<span class="o">);</span>
</code></pre></div></div>

<p>ä½¿ç”¨è„šæœ¬ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ›å»ºè„šæœ¬ï¼Œç”¨äºæ ¹æ® price å­—æ®µçš„å€¼è¿›è¡Œæ’åº</span>
<span class="nc">Script</span> <span class="n">script</span> <span class="o">=</span> <span class="nc">Script</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
        <span class="o">.</span><span class="na">inline</span><span class="o">(</span><span class="n">inlineScriptBuilder</span> <span class="o">-&gt;</span> <span class="n">inlineScriptBuilder</span>
                <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="s">"doc['price'].value * 2"</span><span class="o">)</span>  <span class="c1">// inline è„šæœ¬ï¼šå­—æ®µ 'price' çš„å€¼ä¹˜ä»¥ 2</span>
        <span class="o">)</span>
<span class="o">);</span>

<span class="c1">// åˆ›å»ºæ’åºé€‰é¡¹ï¼Œä½¿ç”¨è„šæœ¬æ’åº</span>
<span class="nc">SortOptions</span> <span class="n">scriptSort</span> <span class="o">=</span> <span class="nc">SortOptions</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">script</span><span class="o">(</span><span class="n">sc</span> <span class="o">-&gt;</span> <span class="n">sc</span>
                <span class="o">.</span><span class="na">script</span><span class="o">(</span><span class="n">script</span><span class="o">)</span>  <span class="c1">// ä½¿ç”¨å®šä¹‰å¥½çš„è„šæœ¬è¿›è¡Œæ’åº</span>
        <span class="o">)</span>
<span class="o">);</span>

<span class="c1">// ä½¿ç”¨ SortOptions åˆ›å»ºæ’åºè¯·æ±‚</span>
<span class="nc">SearchRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">SearchRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
                <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"elasticsearch"</span><span class="o">))</span>  <span class="c1">// æŸ¥è¯¢æ¡ä»¶ï¼šåŒ¹é… 'title' å­—æ®µ</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">scriptSort</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<p>åœ°ç†ä½ç½®æ’åºã€åµŒå¥—å­—æ®µæ’åºâ€¦</p>

<p>å¤šæ¡ä»¶æ’åº</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ›å»ºæŒ‰ä»·æ ¼å‡åºæ’åºçš„ SortOptions</span>
<span class="nc">SortOptions</span> <span class="n">priceSort</span> <span class="o">=</span> <span class="nc">SortOptions</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span>
                <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"price"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">Asc</span><span class="o">)</span>  <span class="c1">// å‡åºæ’åº</span>
        <span class="o">)</span>
<span class="o">);</span>

<span class="c1">// åˆ›å»ºæŒ‰å‘å¸ƒæ—¥æœŸé™åºæ’åºçš„ SortOptions</span>
<span class="nc">SortOptions</span> <span class="n">publishDateSort</span> <span class="o">=</span> <span class="nc">SortOptions</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span>
                <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"publish_date"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">Asc</span><span class="o">)</span>  <span class="c1">// é™åºæ’åº</span>
        <span class="o">)</span>
<span class="o">);</span>

<span class="c1">// åˆ›å»ºæŒ‰åç§°å‡åºæ’åºçš„ SortOptions</span>
<span class="nc">SortOptions</span> <span class="n">nameSort</span> <span class="o">=</span> <span class="nc">SortOptions</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span>
                <span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">order</span><span class="o">(</span><span class="nc">SortOrder</span><span class="o">.</span><span class="na">Asc</span><span class="o">)</span>  <span class="c1">// å‡åºæ’åº</span>
        <span class="o">)</span>
<span class="o">);</span>

<span class="c1">// åˆ›å»ºæœç´¢è¯·æ±‚ï¼Œå¹¶åº”ç”¨å¤šå­—æ®µæ’åº</span>
<span class="nc">SearchRequest</span> <span class="n">searchRequest</span> <span class="o">=</span> <span class="nc">SearchRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
                <span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"title"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="s">"elasticsearch"</span><span class="o">))</span>  <span class="c1">// æŸ¥è¯¢æ¡ä»¶ï¼šåŒ¹é… 'title' å­—æ®µ</span>
        <span class="o">)</span>
        <span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">priceSort</span><span class="o">,</span><span class="n">publishDateSort</span><span class="o">,</span><span class="n">nameSort</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div>

<h4 id="search"><code class="language-plaintext highlighter-rouge">search()</code></h4>

<p><code class="language-plaintext highlighter-rouge">esClient.search</code> æ˜¯ Elasticsearch ä¸­ç”¨äºæ‰§è¡Œæœç´¢æ“ä½œçš„å¸¸ç”¨æ–¹æ³•ï¼Œæ”¯æŒå¤šç§æŸ¥è¯¢å’Œé…ç½®é€‰é¡¹ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">esClient.search</code> æä¾›äº†å¼ºå¤§çš„æŸ¥è¯¢åŠŸèƒ½ï¼Œé€šè¿‡ä¸åŒçš„æ„å»ºæ–¹å¼ï¼Œå¯ä»¥çµæ´»åœ°æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ã€åˆ†é¡µã€æ’åºã€å­—æ®µè¿‡æ»¤ç­‰ã€‚ä½ å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">SearchRequest</code> å¯¹è±¡æˆ–è€…æ„å»ºå™¨æ¨¡å¼æ¥é…ç½®æœç´¢è¯·æ±‚ï¼Œå¹¶é€šè¿‡ <code class="language-plaintext highlighter-rouge">SearchResponse</code> å¯¹è±¡è·å–æŸ¥è¯¢ç»“æœåŠç›¸å…³ä¿¡æ¯ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">esClient.search(SearchRequest request)</code></strong> æ–¹æ³•ï¼š</p>

<ul>
  <li>
    <p><strong>åŠŸèƒ½</strong>ï¼šæ‰§è¡Œæœç´¢æŸ¥è¯¢å¹¶è¿”å›æœç´¢ç»“æœã€‚</p>
  </li>
  <li>
    <p><strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">SearchRequest request</code>ï¼Œè¯¥è¯·æ±‚å¯¹è±¡åŒ…å«äº†æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ã€‚</p>

    <p><strong>å¸¸ç”¨å­—æ®µ</strong>ï¼š</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">index</code>ï¼šè¦æœç´¢çš„ç´¢å¼•åç§°ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">query</code>ï¼šæŸ¥è¯¢æ¡ä»¶ï¼Œç”¨äºå®šä¹‰æœç´¢çš„é€»è¾‘ï¼Œä¾‹å¦‚ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">match</code>, <code class="language-plaintext highlighter-rouge">term</code>, <code class="language-plaintext highlighter-rouge">bool</code> ç­‰æŸ¥è¯¢ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">source</code>ï¼šæºè¿‡æ»¤å™¨ï¼Œç”¨äºæ§åˆ¶è¿”å›å“ªäº›å­—æ®µï¼Œæ”¯æŒ <code class="language-plaintext highlighter-rouge">includes</code> æˆ– <code class="language-plaintext highlighter-rouge">excludes</code>ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">from</code>ï¼šæŒ‡å®šæŸ¥è¯¢çš„èµ·å§‹ä½ç½®ï¼Œç”¨äºåˆ†é¡µã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">size</code>ï¼šæŒ‡å®šæ¯é¡µçš„è¿”å›ç»“æœæ•°ç›®ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">sort</code>ï¼šç”¨äºæŒ‡å®šæ’åºæ¡ä»¶ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">trackTotalHits</code>ï¼šæ§åˆ¶æ˜¯å¦è®¡ç®—æ€»åŒ¹é…æ•°ç›®ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">timeout</code>ï¼šæŸ¥è¯¢è¶…æ—¶æ—¶é—´ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">esClient.search(Function&lt;SearchRequest.Builder, ObjectBuilder&lt;SearchRequest&gt;&gt; fn)</code></strong> æ–¹æ³•ï¼š</p>

<ul>
  <li><strong>åŠŸèƒ½</strong>ï¼šä½¿ç”¨ä¸€ä¸ªå‡½æ•°æ¥æ„å»º <code class="language-plaintext highlighter-rouge">SearchRequest</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡½æ•°å¼ç¼–ç¨‹é£æ ¼çš„è°ƒç”¨ã€‚</li>
  <li><strong>å‚æ•°</strong>ï¼šä¸€ä¸ªæ„å»ºå‡½æ•° <code class="language-plaintext highlighter-rouge">fn</code>ï¼Œå°†ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">SearchRequest.Builder</code> è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">SearchRequest</code> å¯¹è±¡ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SearchResponse</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">builder</span> <span class="o">-&gt;</span> <span class="n">builder</span>
                <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="n">m</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.</span><span class="na">field</span><span class="o">(</span><span class="s">"v"</span><span class="o">).</span><span class="na">query</span><span class="o">(</span><span class="mi">50</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
                <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
        <span class="nc">Map</span><span class="o">.</span><span class="na">class</span>
<span class="o">);</span>
<span class="nc">HitsMetadata</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">hits</span><span class="o">();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="na">hits</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="nl">Hit:</span><span class="o">:</span><span class="n">source</span><span class="o">).</span><span class="na">toList</span><span class="o">();</span>
<span class="n">collect</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="æ»šåŠ¨æŸ¥è¯¢">æ»šåŠ¨æŸ¥è¯¢</h3>

<p>åœ¨ Elasticsearch ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">Search</code> æŸ¥è¯¢è¿”å›çš„æ–‡æ¡£æ•°é‡æ˜¯ 10 æ¡ã€‚è¿™æ˜¯ Elasticsearch çš„åˆ†é¡µæœºåˆ¶ï¼ˆ<code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code>ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚è¦è¿”å›æ›´å¤šçš„æ•°æ®ï¼Œä½ éœ€è¦æ˜¾å¼åœ°è®¾ç½®æŸ¥è¯¢çš„ <code class="language-plaintext highlighter-rouge">size</code> å‚æ•°ï¼Œæˆ–è€…ä½¿ç”¨åˆ†é¡µï¼ˆ<code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code>ï¼‰æ¥è·å–æ›´å¤šç»“æœã€‚</p>

<p><strong>å¢åŠ è¿”å›ç»“æœçš„æ•°é‡ (<code class="language-plaintext highlighter-rouge">size</code>)</strong>ï¼š</p>

<p>ä½ å¯ä»¥é€šè¿‡è®¾ç½® <code class="language-plaintext highlighter-rouge">size</code> å‚æ•°æ¥æ”¹å˜æ¯æ¬¡æŸ¥è¯¢è¿”å›çš„æ–‡æ¡£æ•°é‡ã€‚æ¯”å¦‚ï¼Œè®¾ç½®ä¸º 100 æˆ–æ›´å¤šï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SearchResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">indexName</span><span class="o">)</span>
        <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">source</span> <span class="o">-&gt;</span> <span class="n">source</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="n">includeFields</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
        <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span> <span class="c1">// è®¾ç½®è¿”å›çš„ç»“æœæ•°é‡</span>
        <span class="n">clazz</span>
<span class="o">);</span>
</code></pre></div></div>

<p>è¿™æ ·ä¼šè¿”å› 100 æ¡æ•°æ®ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ <code class="language-plaintext highlighter-rouge">size</code> çš„å€¼ã€‚</p>

<p><strong>ä½¿ç”¨åˆ†é¡µ (from/size)</strong>ï¼š</p>

<p>å¦‚æœæ•°æ®é‡è¾ƒå¤§ï¼Œå¯ä»¥ä½¿ç”¨åˆ†é¡µæ¥åˆ†æ‰¹æ¬¡æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code> æ¥æ§åˆ¶æŸ¥è¯¢çš„èµ·å§‹ç‚¹å’Œæ¯æ¬¡è¿”å›çš„æ•°é‡ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>  <span class="c1">// é¡µç ï¼Œç¬¬ä¸€é¡µä¸º 0ï¼Œç¬¬äºŒé¡µä¸º 1ï¼Œä¾æ­¤ç±»æ¨</span>
<span class="kt">int</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>  <span class="c1">// æ¯é¡µè¿”å›çš„æ•°é‡</span>

<span class="nc">SearchResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">indexName</span><span class="o">)</span>
        <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">source</span> <span class="o">-&gt;</span> <span class="n">source</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="n">includeFields</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">page</span> <span class="o">*</span> <span class="n">pageSize</span><span class="o">)</span>  <span class="c1">// åˆ†é¡µæŸ¥è¯¢ï¼Œä»ç¬¬ `page` é¡µå¼€å§‹</span>
        <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">pageSize</span><span class="o">),</span>  <span class="c1">// æ¯é¡µè¿”å›çš„æ•°é‡</span>
        <span class="n">clazz</span>
<span class="o">);</span>
</code></pre></div></div>

<p>è¿™æ ·ï¼Œä½ å°±å¯ä»¥é€šè¿‡å¢åŠ  <code class="language-plaintext highlighter-rouge">from</code> æ¥è·å–ä¸åŒçš„åˆ†é¡µæ•°æ®ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">scroll</code> æŸ¥è¯¢</strong>ï¼š</p>

<p>å¦‚æœä½ çš„æ•°æ®é‡éå¸¸å¤§ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">scroll</code> æŸ¥è¯¢æ¥åˆ†é¡µè·å–æ•°æ®ã€‚<code class="language-plaintext highlighter-rouge">scroll</code> æ˜¯ Elasticsearch ç”¨æ¥é«˜æ•ˆæŸ¥è¯¢å¤§æ•°æ®é‡çš„ä¸€ç§æ–¹å¼ï¼Œå®ƒä¼šæŒç»­ä¿æŒä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå¯ä»¥å¤šæ¬¡è¯·æ±‚æ¥è·å–æ›´å¤šçš„æ•°æ®ï¼Œè€Œä¸éœ€è¦é‡æ–°æ‰§è¡Œå®Œæ•´çš„æŸ¥è¯¢ã€‚</p>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">scroll</code> æŸ¥è¯¢çš„ä¾‹å­ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">SearchResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">indexName</span><span class="o">)</span>
        <span class="o">.</span><span class="na">scroll</span><span class="o">(</span><span class="s">"1m"</span><span class="o">)</span>  <span class="c1">// è®¾ç½® scroll ä¸Šä¸‹æ–‡çš„æœ‰æ•ˆæ—¶é—´</span>
        <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">source</span> <span class="o">-&gt;</span> <span class="n">source</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="n">includeFields</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
        <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span>  <span class="c1">// æ¯æ¬¡è¿”å› 100 æ¡æ•°æ®</span>
        <span class="n">clazz</span>
<span class="o">);</span>

<span class="nc">String</span> <span class="n">scrollId</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">scrollId</span><span class="o">();</span>
<span class="c1">// å¤„ç†è¿”å›çš„æ–‡æ¡£æ•°æ®ï¼Œç„¶åæ ¹æ® scrollId ç»§ç»­æŸ¥è¯¢ä¸‹ä¸€é¡µçš„æ•°æ®</span>
</code></pre></div></div>

<p>é€šè¿‡è°ƒæ•´è¿™äº›å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶æŸ¥è¯¢ç»“æœçš„æ•°é‡å’Œåˆ†é¡µæ–¹å¼ï¼Œé¿å…æ¯æ¬¡åªèƒ½æŸ¥è¯¢åˆ° 10 æ¡æ•°æ®çš„é—®é¢˜ã€‚</p>

<hr />

<p>åœ¨ Elasticsearch ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹æ¯ä¸ªæŸ¥è¯¢çš„ <code class="language-plaintext highlighter-rouge">size</code> æœ€å¤§å€¼æ˜¯ <strong>10,000</strong> æ¡ã€‚å¦‚æœä½ è®¾ç½®äº† <code class="language-plaintext highlighter-rouge">size</code> å‚æ•°è¶…è¿‡ 10,000ï¼ŒElasticsearch ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œæç¤ºä¸èƒ½è¶…è¿‡è¿™ä¸ªé™åˆ¶ã€‚</p>

<p>ä¸è¿‡ï¼Œå®é™…ä¸Šï¼Œå¦‚æœä½ æƒ³è¦æ£€ç´¢è¶…è¿‡ 10,000 æ¡æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ï¼š</p>

<p><strong>é€šè¿‡ <code class="language-plaintext highlighter-rouge">scroll</code> æŸ¥è¯¢æ‰¹é‡è·å–æ•°æ®</strong></p>

<p><code class="language-plaintext highlighter-rouge">scroll</code> æŸ¥è¯¢æ˜¯ Elasticsearch æä¾›çš„ä¸€ç§æ–¹æ³•ï¼Œé€‚ç”¨äºæŸ¥è¯¢å¤§é‡æ•°æ®ï¼Œç‰¹åˆ«æ˜¯å½“ä½ éœ€è¦è¿”å›å¤§é‡è®°å½•æ—¶ã€‚ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">scroll</code> æŸ¥è¯¢æ—¶ï¼ŒElasticsearch ä¼šä¿æŒä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œä½¿å¾—ä½ å¯ä»¥åˆ†é¡µæŸ¥è¯¢å¹¶é€æ­¥è·å–æ•°æ®ï¼Œè€Œä¸éœ€è¦ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰ç»“æœã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æ»šåŠ¨æŸ¥è¯¢
 * @param indexName ç´¢å¼•åç§°
 * @param query æŸ¥è¯¢æ¡ä»¶
 * @param includeFields è¿”å›å­—æ®µ
 * @param clazz è¿”å›ç±»å‹
 * @return
 * @param &lt;T&gt; è¿”å›ç±»å‹
 * @throws IOException
 */</span>
<span class="kd">public</span>   <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">searchListByScroll</span><span class="o">(</span><span class="nc">String</span> <span class="n">indexName</span><span class="o">,</span>  <span class="nc">Query</span> <span class="n">query</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">includeFields</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="o">{</span>
        <span class="c1">// é¦–å…ˆåˆ›å»ºä¸€æ¬¡æŸ¥è¯¢ï¼Œè·å–æ»šåŠ¨ ID å’Œåˆå§‹ç»“æœ</span>
        <span class="nc">SearchResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
                        <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">indexName</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">scroll</span><span class="o">(</span><span class="n">s2</span><span class="o">-&gt;</span><span class="n">s2</span><span class="o">.</span><span class="na">offset</span><span class="o">(</span><span class="mi">60_000</span><span class="o">))</span>  <span class="c1">// 1åˆ†é’Ÿæ»šåŠ¨ä¸Šä¸‹æ–‡</span>
                        <span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">source</span> <span class="o">-&gt;</span> <span class="n">source</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">includes</span><span class="o">(</span><span class="n">includeFields</span><span class="o">)))</span>
                        <span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">query</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>  <span class="c1">// æ¯æ¬¡æŸ¥è¯¢è¿”å›10000æ¡</span>
                <span class="n">clazz</span>
        <span class="o">);</span>

        <span class="c1">// è·å–scrollId</span>
        <span class="nc">String</span> <span class="n">scrollId</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">scrollId</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">HitsMetadata</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">hits</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">hits</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">hits</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">handleResult</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">hits</span><span class="o">,</span> <span class="n">resultList</span><span class="o">);</span>

        <span class="c1">// ä½¿ç”¨ scrollId è·å–åç»­çš„æ•°æ®</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">finalScrollId</span> <span class="o">=</span> <span class="n">scrollId</span><span class="o">;</span>
            <span class="nc">ScrollResponse</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">scrollResponse</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">scroll</span><span class="o">(</span><span class="n">scroll</span> <span class="o">-&gt;</span> <span class="n">scroll</span>
                            <span class="o">.</span><span class="na">scrollId</span><span class="o">(</span><span class="n">finalScrollId</span><span class="o">)</span>  <span class="c1">// ä½¿ç”¨ä¹‹å‰çš„scrollIdç»§ç»­æŸ¥è¯¢</span>
                            <span class="o">.</span><span class="na">scroll</span><span class="o">(</span><span class="n">s2</span><span class="o">-&gt;</span><span class="n">s2</span><span class="o">.</span><span class="na">offset</span><span class="o">(</span><span class="mi">60_000</span><span class="o">))</span>  <span class="c1">// è®¾ç½®scrollä¸Šä¸‹æ–‡æœ‰æ•ˆæ—¶é—´</span>
                    <span class="o">,</span><span class="n">clazz</span>
            <span class="o">);</span>
            <span class="nc">HitsMetadata</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">hits2</span> <span class="o">=</span> <span class="n">scrollResponse</span><span class="o">.</span><span class="na">hits</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hits2</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">handleResult</span><span class="o">(</span><span class="n">clazz</span><span class="o">,</span> <span class="n">hits2</span><span class="o">,</span> <span class="n">resultList</span><span class="o">);</span>
            <span class="n">scrollId</span> <span class="o">=</span> <span class="n">scrollResponse</span><span class="o">.</span><span class="na">scrollId</span><span class="o">();</span>  <span class="c1">// æ›´æ–°scrollId</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="nf">handleResult</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">,</span> <span class="nc">HitsMetadata</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">hits</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">resultList</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Hit</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">hit</span> <span class="o">:</span> <span class="n">hits</span><span class="o">.</span><span class="na">hits</span><span class="o">())</span> <span class="o">{</span>
        <span class="no">T</span> <span class="n">source</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">id</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="na">id</span><span class="o">();</span>
            <span class="nc">Field</span> <span class="n">idField</span> <span class="o">=</span> <span class="nc">DataUtil</span><span class="o">.</span><span class="na">getIdField</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
            <span class="n">idField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">idField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"è®¾ç½®idå­—æ®µå¤±è´¥ï¼Œè¯·æ£€æŸ¥å®ä½“ç±»æ˜¯å¦åŒ…å«idå­—æ®µï¼Œæˆ–è€…idå­—æ®µç±»å‹æ˜¯å¦ä¸ºStringç±»å‹"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">resultList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">search_after</code> åˆ†é¡µæŸ¥è¯¢</strong></p>

<p><code class="language-plaintext highlighter-rouge">search_after</code> æ˜¯ Elasticsearch æä¾›çš„å¦ä¸€ç§ç”¨äºåˆ†é¡µçš„æ–¹æ³•ï¼Œå®ƒåŸºäºä¸Šä¸€é¡µæŸ¥è¯¢ç»“æœçš„æ’åºå­—æ®µæ¥è·å–ä¸‹ä¸€é¡µçš„æ•°æ®ã€‚å®ƒçš„ä¼˜ç‚¹æ˜¯å¯ä»¥ç”¨äºæ£€ç´¢æ¯” <code class="language-plaintext highlighter-rouge">from</code>/<code class="language-plaintext highlighter-rouge">size</code> æ›´å¤§çš„æ•°æ®é‡ï¼ŒåŒæ—¶é¿å…äº†æ·±åˆ†é¡µå¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">searchAfter</code> æ˜¯ Elasticsearch ä¸­ä¸€ä¸ªç”¨äºå®ç° <strong>æ·±åˆ†é¡µ</strong>ï¼ˆdeep paginationï¼‰æˆ– <strong>åŸºäºæ¸¸æ ‡çš„åˆ†é¡µ</strong>ï¼ˆcursor-based paginationï¼‰çš„åŠŸèƒ½ã€‚å®ƒé€šè¿‡æŒ‡å®šå‰ä¸€æ¬¡æŸ¥è¯¢è¿”å›çš„æœ€åä¸€ä¸ªæ–‡æ¡£çš„æ’åºå€¼æ¥è¿›è¡Œåˆ†é¡µï¼Œä»è€Œé¿å…äº†ä½¿ç”¨ä¼ ç»Ÿçš„ <code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code> å‚æ•°è¿›è¡Œåˆ†é¡µæ—¶å¯èƒ½é‡åˆ°çš„æ€§èƒ½é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨æ•°æ®é‡éå¸¸å¤§çš„æƒ…å†µä¸‹ã€‚</p>

<p>ä¼ ç»Ÿçš„åŸºäº <code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code> çš„åˆ†é¡µæ–¹æ³•å¯¹äºå¤§é‡æ•°æ®ï¼ˆå°¤å…¶æ˜¯æ·±åˆ†é¡µï¼Œå³æŸ¥è¯¢è¾ƒåé¢çš„ç»“æœæ—¶ï¼‰ä¼šå˜å¾—ä½æ•ˆã€‚æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè·³è¿‡å‰é¢çš„å¤§é‡æ–‡æ¡£ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚è€Œ <code class="language-plaintext highlighter-rouge">searchAfter</code> ä½¿ç”¨ä¸€ä¸ªæ¸¸æ ‡ï¼ˆé€šå¸¸æ˜¯ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€åä¸€ä¸ªæ–‡æ¡£çš„æ’åºå€¼ï¼‰ï¼Œä½¿å¾—æŸ¥è¯¢æ•ˆç‡æ›´é«˜ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ·±å±‚åˆ†é¡µæ—¶é¿å…æ•ˆç‡ä½ä¸‹çš„é—®é¢˜ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">searchAfter</code> çš„å·¥ä½œåŸç†</strong></p>

<p><strong>æ’åºå­—æ®µ</strong>ï¼šä¸ºäº†ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">searchAfter</code>ï¼Œå¿…é¡»å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œæ’åºï¼Œé€šå¸¸æ˜¯ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„å­—æ®µï¼ˆå¦‚æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">_id</code>ï¼‰è¿›è¡Œæ’åºã€‚æ’åºå­—æ®µçš„é¡ºåºéå¸¸é‡è¦ï¼Œå› ä¸º <code class="language-plaintext highlighter-rouge">searchAfter</code> ä¼šæ ¹æ®è¿™äº›æ’åºå­—æ®µæ¥è·³è¿‡ä¹‹å‰çš„æ–‡æ¡£å¹¶æ‰¾åˆ°æ¥ä¸‹æ¥çš„ç»“æœã€‚</p>

<p><strong>æä¾›æ’åºå€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">searchAfter</code> éœ€è¦æä¾›ä¸€ä¸ªæ’åºå€¼ï¼Œè¿™ä¸ªå€¼é€šå¸¸æ˜¯æ¥è‡ªä¸Šä¸€ä¸ªæŸ¥è¯¢è¿”å›çš„æœ€åä¸€æ¡æ–‡æ¡£çš„æ’åºå€¼ã€‚åŸºäºè¿™ä¸ªæ’åºå€¼ï¼ŒElasticsearch å¯ä»¥æ‰¾åˆ°ä»ä¸Šä¸€æ¬¡æŸ¥è¯¢ä¹‹åçš„ä¸‹ä¸€æ¡è®°å½•ï¼Œå¹¶ç»§ç»­æŸ¥è¯¢ã€‚</p>

<p><strong>ä¼ ç»Ÿåˆ†é¡µï¼ˆ<code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code>ï¼‰</strong></p>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code> è¿›è¡Œåˆ†é¡µæ—¶ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½ä¼šè®¡ç®—è·³è¿‡å¤šå°‘æ–‡æ¡£ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET</span><span class="w"> </span><span class="err">/my_index/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"from"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_all"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"sort"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asc"</span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">from</code> éœ€è¦è®¡ç®—è·³è¿‡å‰ 1000 ä¸ªæ–‡æ¡£ï¼Œç„¶åè¿”å› 10 ä¸ªæ–‡æ¡£ã€‚éšç€ <code class="language-plaintext highlighter-rouge">from</code> å€¼çš„å¢å¤§ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¼šé™ä½ã€‚</p>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">searchAfter</code></strong></p>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">searchAfter</code> æ—¶ï¼Œä½ åªéœ€è¦æä¾›ä¸Šä¸€æŸ¥è¯¢çš„æœ€åä¸€ä¸ªæ’åºå€¼ã€‚å‡è®¾ä½ æœ‰ä¸€ä¸ªæŒ‰ <code class="language-plaintext highlighter-rouge">date</code> å­—æ®µå‡åºæ’åºçš„æŸ¥è¯¢ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæ–‡æ¡£åï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">date</code> å­—æ®µä½œä¸º <code class="language-plaintext highlighter-rouge">searchAfter</code> çš„å€¼æ¥è¿›è¡Œä¸‹ä¸€æ¬¡æŸ¥è¯¢ã€‚</p>

<p>å‡è®¾ç¬¬ä¸€æ¬¡æŸ¥è¯¢è¿”å›äº†ä»¥ä¸‹æ–‡æ¡£ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-01-01T00:00:00"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>ç„¶åä½ å¯ä»¥ä½¿ç”¨è¿”å›çš„ <code class="language-plaintext highlighter-rouge">date</code> å­—æ®µä½œä¸º <code class="language-plaintext highlighter-rouge">searchAfter</code> å‚æ•°ï¼Œæ¥è·å–æ¥ä¸‹æ¥çš„æ•°æ®ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET</span><span class="w"> </span><span class="err">/my_index/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_all"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"sort"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asc"</span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"search_after"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2021-01-01T00:00:00"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>å¤šä¸ªæ’åºå­—æ®µ</strong></p>

<p>å¦‚æœä½ å¸Œæœ›ä½¿ç”¨å¤šä¸ªå­—æ®µè¿›è¡Œæ’åºï¼ˆä¾‹å¦‚æŒ‰æ—¶é—´å’Œ <code class="language-plaintext highlighter-rouge">_id</code> æ’åºï¼‰ï¼Œä½ éœ€è¦åœ¨ <code class="language-plaintext highlighter-rouge">searchAfter</code> ä¸­æä¾›è¿™äº›æ’åºå­—æ®µçš„å€¼çš„æ•°ç»„ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">GET</span><span class="w"> </span><span class="err">/my_index/_search</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
  </span><span class="nl">"query"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"match_all"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"sort"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="nl">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asc"</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"asc"</span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"search_after"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"2021-01-01T00:00:00"</span><span class="p">,</span><span class="w"> </span><span class="s2">"1"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">searchAfter</code> éœ€è¦åŒæ—¶ä¼ å…¥ <code class="language-plaintext highlighter-rouge">date</code> å’Œ <code class="language-plaintext highlighter-rouge">_id</code> çš„å€¼ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">searchAfter</code> ä¸ä¼ ç»Ÿåˆ†é¡µçš„åŒºåˆ«</strong></p>

<ul>
  <li><strong>æ€§èƒ½</strong>ï¼š<code class="language-plaintext highlighter-rouge">searchAfter</code> åœ¨è¿›è¡Œæ·±åˆ†é¡µæ—¶æ¯” <code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code> æ›´é«˜æ•ˆï¼Œå› ä¸ºå®ƒä¸éœ€è¦è®¡ç®—è·³è¿‡å¤šå°‘æ–‡æ¡£ï¼Œé¿å…äº†å¤§é‡æ–‡æ¡£çš„æ’åºå’Œè¿‡æ»¤ã€‚</li>
  <li><strong>ä¾èµ–æ’åº</strong>ï¼š<code class="language-plaintext highlighter-rouge">searchAfter</code> å¿…é¡»ä¾èµ–æ’åºå­—æ®µï¼Œè¿™æ„å‘³ç€ä½ çš„æŸ¥è¯¢å¿…é¡»æŒ‡å®šæ’åºå­—æ®µï¼Œå¹¶ä¸”è¿™äº›å­—æ®µéœ€è¦æœ‰å”¯ä¸€æ€§æˆ–è€…èƒ½ç¡®ä¿æ­£ç¡®çš„é¡ºåºã€‚</li>
  <li><strong>çŠ¶æ€ä¿æŒ</strong>ï¼šæ¯æ¬¡ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">searchAfter</code> æ—¶ï¼Œå¿…é¡»ä¿å­˜ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€åä¸€ä¸ªæ–‡æ¡£çš„æ’åºå€¼ï¼Œè¿›è¡ŒçŠ¶æ€ä¼ é€’ã€‚å¯¹äºä¼ ç»Ÿçš„åŸºäº <code class="language-plaintext highlighter-rouge">from</code> çš„åˆ†é¡µæ–¹å¼ï¼Œé¡µé¢çŠ¶æ€æ˜¯ç”±å®¢æˆ·ç«¯æ§åˆ¶çš„ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">searchAfter</code> åŸºäºæŸ¥è¯¢ç»“æœæœ¬èº«çš„æ’åºå€¼æ¥ç»§ç»­æŸ¥è¯¢ã€‚</li>
</ul>

<p><strong>æ³¨æ„äº‹é¡¹</strong></p>

<ul>
  <li><strong>æ’åºå­—æ®µçš„ä¸€è‡´æ€§</strong>ï¼š<code class="language-plaintext highlighter-rouge">searchAfter</code> ä¾èµ–äºæ’åºå­—æ®µçš„å€¼ï¼Œç¡®ä¿è¿™äº›å­—æ®µçš„é¡ºåºå’Œæ’åºè§„åˆ™ä¸€è‡´æ€§éå¸¸é‡è¦ã€‚å¦‚æœæ•°æ®å‘ç”Ÿå˜åŒ–ï¼ˆä¾‹å¦‚æ–°æ–‡æ¡£æ’å…¥æˆ–æ’åºå­—æ®µå€¼æ›´æ–°ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´åˆ†é¡µç»“æœä¸ä¸€è‡´ã€‚</li>
  <li><strong>é€‚ç”¨åœºæ™¯</strong>ï¼š<code class="language-plaintext highlighter-rouge">searchAfter</code> æœ€é€‚ç”¨äºè¿”å›å¤§é‡æ•°æ®æ—¶ï¼Œç‰¹åˆ«æ˜¯éœ€è¦ä»æŸ¥è¯¢ç»“æœçš„ä¸­é—´æˆ–åº•éƒ¨å¼€å§‹è·å–æ•°æ®æ—¶ã€‚</li>
  <li><strong>é™åˆ¶</strong>ï¼š<code class="language-plaintext highlighter-rouge">searchAfter</code> ä¸æ”¯æŒ <code class="language-plaintext highlighter-rouge">from</code> å’Œ <code class="language-plaintext highlighter-rouge">size</code>ï¼Œå³å®ƒä¸èƒ½ä¸è¿™äº›å‚æ•°ä¸€èµ·ä½¿ç”¨ã€‚</li>
</ul>

<p><strong>æ€»ç»“</strong></p>

<p><code class="language-plaintext highlighter-rouge">searchAfter</code> æ˜¯ Elasticsearch ä¸­ä¸ºäº†è§£å†³æ·±åˆ†é¡µæ—¶çš„æ€§èƒ½é—®é¢˜è€Œè®¾è®¡çš„ä¸€ç§æ›´é«˜æ•ˆçš„åˆ†é¡µæœºåˆ¶ã€‚å®ƒé€šè¿‡ä¼ é€’ä¸Šä¸€æŸ¥è¯¢è¿”å›ç»“æœçš„æ’åºå€¼æ¥ç»§ç»­æŸ¥è¯¢ï¼Œé¿å…äº†ä¼ ç»Ÿåˆ†é¡µä¸­éšç€æ•°æ®é‡å¢å¤§è€Œå¯¼è‡´çš„æ•ˆç‡ä½ä¸‹çš„é—®é¢˜ã€‚</p>

<hr />

<p><strong>é€šè¿‡ <code class="language-plaintext highlighter-rouge">index.max_result_window</code> é…ç½®æå‡è¿”å›ç»“æœçš„ä¸Šé™</strong></p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticsearch å¯¹æ¯æ¬¡æŸ¥è¯¢çš„ <code class="language-plaintext highlighter-rouge">size</code> é™åˆ¶ä¸º 10,000 æ¡ï¼Œ<code class="language-plaintext highlighter-rouge">index.max_result_window</code> é…ç½®é¡¹æ§åˆ¶äº†è¿™ä¸€é™åˆ¶ã€‚å¦‚æœä½ éœ€è¦è¿”å›è¶…è¿‡ 10,000 æ¡æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹æ­¤è®¾ç½®æ¥æå‡é™åˆ¶ã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong> æå‡ <code class="language-plaintext highlighter-rouge">max_result_window</code> å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œå°¤å…¶æ˜¯åœ¨å¤§è§„æ¨¡æ•°æ®é›†ä¸Šè¿›è¡ŒæŸ¥è¯¢æ—¶ã€‚</p>

<p>é…ç½®æ–¹æ³•ï¼š</p>

<p>ä¿®æ”¹ <code class="language-plaintext highlighter-rouge">index.max_result_window</code>ï¼š</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">/your_index/_settings</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"settings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"index.max_result_window"</span><span class="p">:</span><span class="w"> </span><span class="mi">20000</span><span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">è®¾ç½®ä¸ºæ‰€éœ€çš„æœ€å¤§å€¼</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>æ›´æ–°åï¼Œæ‚¨å¯ä»¥åœ¨æŸ¥è¯¢æ—¶ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">size</code> è®¾ç½®è¿”å›æ•°æ®çš„æ•°é‡å¤§äº 10,000 æ¡ã€‚</p>

<blockquote>
  <p><strong>è­¦å‘Š</strong>ï¼šå¢åŠ  <code class="language-plaintext highlighter-rouge">max_result_window</code> å¯èƒ½å¯¼è‡´å†…å­˜æ¶ˆè€—å¢åŠ ï¼Œå› æ­¤åœ¨ä¿®æ”¹æ—¶è¯·ç¡®ä¿ä½ çš„ Elasticsearch é›†ç¾¤æœ‰è¶³å¤Ÿçš„å†…å­˜æ¥å¤„ç†å¤§é‡æ•°æ®è¿”å›ã€‚</p>
</blockquote>

<p>æ€»ç»“</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">scroll</code> æŸ¥è¯¢</strong>ï¼šç”¨äºå¤„ç†å¤§è§„æ¨¡æ•°æ®é›†ï¼Œé¿å…ä¸€æ¬¡æ€§è¿”å›å¤§é‡æ•°æ®ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">search_after</code> åˆ†é¡µ</strong>ï¼šé€‚ç”¨äºå¤„ç†æ’åºå­—æ®µçš„åˆ†é¡µï¼Œé¿å…æ·±åˆ†é¡µæ€§èƒ½é—®é¢˜ã€‚</li>
  <li><strong>æå‡ <code class="language-plaintext highlighter-rouge">index.max_result_window</code></strong>ï¼šç›´æ¥å¢åŠ æŸ¥è¯¢ç»“æœçš„è¿”å›ä¸Šé™ï¼Œä½†éœ€è°¨æ…ä½¿ç”¨ã€‚</li>
</ol>

<p>é€šå¸¸ï¼Œå»ºè®®ä½¿ç”¨ <strong><code class="language-plaintext highlighter-rouge">scroll</code> æŸ¥è¯¢</strong> æˆ– <strong><code class="language-plaintext highlighter-rouge">search_after</code> åˆ†é¡µ</strong> æ¥å¤„ç†å¤§æ•°æ®é‡æŸ¥è¯¢ï¼Œå°¤å…¶æ˜¯å½“è¿”å›è¶…è¿‡ 10,000 æ¡æ•°æ®æ—¶ã€‚</p>

<h3 id="ç®¡é“">ç®¡é“</h3>

<p>ç®¡é“é€šå¸¸åœ¨ Elasticsearch ä¸­æ˜¯é¢„å…ˆå®šä¹‰å¥½çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”±å¤šä¸ªå¤„ç†æ­¥éª¤ç»„æˆçš„è¿‡ç¨‹ã€‚ä½ å¯ä»¥é€šè¿‡ Elasticsearch çš„ <strong>Ingest Node API</strong> åˆ›å»ºå’Œç®¡ç†ç®¡é“ã€‚ä¸€ä¸ªç®¡é“åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå¤„ç†å™¨ï¼ˆprocessorsï¼‰ï¼Œä¾‹å¦‚ï¼š</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">set processor</code></strong>ï¼šç”¨äºè®¾ç½®æˆ–ä¿®æ”¹å­—æ®µçš„å€¼ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">rename processor</code></strong>ï¼šç”¨äºé‡å‘½åå­—æ®µã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">date processor</code></strong>ï¼šå°†æ—¥æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¥æœŸç±»å‹ã€‚</li>
</ul>

<h4 id="ä½¿ç”¨-http">ä½¿ç”¨ HTTP</h4>

<p>å‡è®¾ä½ æƒ³åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œè¯¥ç®¡é“ç”¨äºå°†æ‰€æœ‰ä¼ å…¥æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">timestamp</code> å­—æ®µè½¬æ¢ä¸ºæ—¥æœŸç±»å‹ã€‚å¯ä»¥ä½¿ç”¨ Elasticsearch çš„ç®¡é“ API æ¥å®šä¹‰ç®¡é“ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">PUT</span><span class="w"> </span><span class="err">_ingest/pipeline/my-pipeline</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Pipeline to convert timestamp to date"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"processors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"date"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"timestamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"@timestamp"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"formats"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"</span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">my-pipeline</code> ç®¡é“ä¼šå°†æ‰€æœ‰æ–‡æ¡£çš„ <code class="language-plaintext highlighter-rouge">timestamp</code> å­—æ®µè½¬æ¢æˆ <code class="language-plaintext highlighter-rouge">@timestamp</code> å­—æ®µï¼Œæ ¼å¼ä¸º <code class="language-plaintext highlighter-rouge">yyyy-MM-dd'T'HH:mm:ss.SSS'Z'</code>ã€‚</p>

<p>è¿™ä¸ªè¯·æ±‚ç”¨äºåœ¨ Elasticsearch ä¸­åˆ›å»ºä¸€ä¸ªåä¸º <code class="language-plaintext highlighter-rouge">my-pipeline</code> çš„ <strong>ingest pipeline</strong>ã€‚Ingest pipeline æ˜¯ Elasticsearch çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºåœ¨æ–‡æ¡£è¢«ç´¢å¼•ä¹‹å‰å¯¹æ–‡æ¡£è¿›è¡Œå¤„ç†ã€‚å…·ä½“åˆ°è¿™ä¸ªä¾‹å­ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ªç®¡é“ï¼Œè¯¥ç®¡é“ä½¿ç”¨äº†ä¸€ä¸ª <strong>æ—¥æœŸå¤„ç†å™¨ï¼ˆdate processorï¼‰</strong> æ¥å°† <code class="language-plaintext highlighter-rouge">timestamp</code> å­—æ®µçš„å€¼è½¬æ¢ä¸ºä¸€ä¸ªæ ‡å‡†çš„æ—¥æœŸæ ¼å¼ï¼Œå¹¶å­˜å‚¨åˆ°æ–°çš„å­—æ®µ <code class="language-plaintext highlighter-rouge">@timestamp</code> ä¸­ã€‚</p>

<p><strong>å‚æ•°è§£é‡Šï¼š</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">PUT _ingest/pipeline/my-pipeline</code></strong></p>

<ul>
  <li>è¿™æ˜¯åˆ›å»ºç®¡é“çš„è¯·æ±‚ã€‚å®ƒä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">PUT</code> æ–¹æ³•ï¼Œå¹¶é€šè¿‡ URL <code class="language-plaintext highlighter-rouge">_ingest/pipeline/my-pipeline</code> æŒ‡å®šç®¡é“åç§°ä¸º <code class="language-plaintext highlighter-rouge">my-pipeline</code>ã€‚</li>
  <li>è¿™ä¸ªè¯·æ±‚ä¼šåœ¨ Elasticsearch ä¸­åˆ›å»ºæˆ–æ›´æ–°åä¸º <code class="language-plaintext highlighter-rouge">my-pipeline</code> çš„ç®¡é“ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">description</code></strong>: <code class="language-plaintext highlighter-rouge">"Pipeline to convert timestamp to date"</code>:è¿™æ˜¯å¯¹ç®¡é“çš„æè¿°ã€‚è¿™ä¸ªå­—æ®µæ˜¯å¯é€‰çš„ï¼Œä¸»è¦ç”¨äºä¸ºç®¡é“æä¾›ä¸€ä¸ªç®€çŸ­çš„æè¿°ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£è¯¥ç®¡é“çš„åŠŸèƒ½ã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">processors</code></strong>: <code class="language-plaintext highlighter-rouge">[...]</code></p>

<ul>
  <li><strong>processors</strong> æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«å¤šä¸ªå¤„ç†å™¨ï¼ˆprocessorsï¼‰ï¼Œç”¨äºå®šä¹‰å¯¹æ–‡æ¡£çš„å¤„ç†æ­¥éª¤ã€‚</li>
  <li>æ¯ä¸ªå¤„ç†å™¨ä¼šä»¥ç‰¹å®šçš„æ–¹å¼å¤„ç†æ–‡æ¡£ä¸­çš„æ•°æ®å­—æ®µã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ•°ç»„ä¸­åªæœ‰ä¸€ä¸ªå¤„ç†å™¨â€”â€”<code class="language-plaintext highlighter-rouge">date</code> å¤„ç†å™¨ã€‚</li>
</ul>

<hr />

<p><strong>å°ç»“ï¼š</strong></p>

<p><strong>åˆ›å»º <code class="language-plaintext highlighter-rouge">my-pipeline</code> ç®¡é“</strong>ï¼š<code class="language-plaintext highlighter-rouge">PUT _ingest/pipeline/my-pipeline</code>ã€‚å¦‚æœç®¡é“ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡é“ã€‚</p>

<p><strong>åˆ é™¤ <code class="language-plaintext highlighter-rouge">my-pipeline</code> ç®¡é“</strong>ï¼š<code class="language-plaintext highlighter-rouge">DELETE _ingest/pipeline/my-pipeline</code></p>

<p><strong>æ›´æ–° <code class="language-plaintext highlighter-rouge">my-pipeline</code> ç®¡é“</strong>ï¼šåŒåˆ›å»ºï¼Œå¦‚æœç®¡é“å­˜åœ¨åˆ™è¦†ç›–ã€‚</p>

<p><strong>è·å–æŒ‡å®šç®¡é“çš„è¯¦ç»†ä¿¡æ¯</strong>ï¼š<code class="language-plaintext highlighter-rouge">GET /_ingest/pipeline/{pipeline_id}</code>ï¼Œå…¶ä¸­ <code class="language-plaintext highlighter-rouge">{pipeline_id}</code> æ˜¯æŸ¥è¯¢çš„ç®¡é“çš„åç§°ã€‚</p>

<p><strong>åˆ—å‡ºæ‰€æœ‰ç®¡é“</strong>ï¼š<code class="language-plaintext highlighter-rouge">GET /_ingest/pipeline</code>ã€‚</p>

<h4 id="ä½¿ç”¨java">ä½¿ç”¨Java</h4>

<p><strong>åˆ›å»º Ingest ç®¡é“</strong></p>

<p>åœ¨ Elasticsearch ä¸­åˆ›å»ºç®¡é“ï¼Œéœ€è¦ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PutPipelineRequest</code> ç±»æ¥è®¾ç½®ç®¡é“çš„é…ç½®ã€‚</p>

<p><strong>æ­¥éª¤</strong>ï¼š</p>
<ol>
  <li>è®¾ç½®ç®¡é“çš„åç§°å’Œæè¿°ã€‚</li>
  <li>é…ç½®ç®¡é“ä¸­çš„å¤„ç†å™¨ï¼ˆä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">date</code> å¤„ç†å™¨ï¼‰ã€‚</li>
  <li>æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">putPipeline</code> è¯·æ±‚æ¥åˆ›å»ºç®¡é“ã€‚</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é…ç½®ç®¡é“è¯·æ±‚</span>
<span class="nc">PutPipelineRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">PutPipelineRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">p</span> <span class="o">-&gt;</span> <span class="n">p</span>
    <span class="o">.</span><span class="na">pipeline</span><span class="o">(</span><span class="s">"my-pipeline"</span><span class="o">)</span>  <span class="c1">// è®¾ç½®ç®¡é“åç§°</span>
    <span class="o">.</span><span class="na">description</span><span class="o">(</span><span class="s">"Pipeline to convert timestamp to date"</span><span class="o">)</span>  <span class="c1">// è®¾ç½®ç®¡é“æè¿°</span>
    <span class="o">.</span><span class="na">processors</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>  <span class="c1">// è®¾ç½®å¤„ç†å™¨</span>
        <span class="k">new</span> <span class="nf">DateProcessor</span><span class="o">(</span><span class="s">"timestamp"</span><span class="o">,</span> <span class="s">"@timestamp"</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"</span><span class="o">))</span>
    <span class="o">))</span>
<span class="o">);</span>

<span class="c1">// æ‰§è¡Œåˆ›å»ºç®¡é“è¯·æ±‚</span>
<span class="nc">PutPipelineResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">ingest</span><span class="o">().</span><span class="na">putPipeline</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

<span class="c1">// è¾“å‡ºåˆ›å»ºç»“æœ</span>
<span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">acknowledged</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Pipeline created successfully."</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Failed to create pipeline."</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>å…³é”®éƒ¨åˆ†</strong>ï¼š</p>
<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">PutPipelineRequest.of(p -&gt; p...)</code></strong>ï¼šè¿™æ®µä»£ç æ„å»ºäº†ç®¡é“è¯·æ±‚ï¼ŒæŒ‡å®šäº†ç®¡é“åç§°ã€æè¿°ä»¥åŠå¤„ç†å™¨ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">DateProcessor</code></strong>ï¼šè¿™æ˜¯å¤„ç†æ—¥æœŸæ ¼å¼çš„å¤„ç†å™¨ï¼Œå®ƒå°†å­—æ®µ <code class="language-plaintext highlighter-rouge">timestamp</code> çš„å€¼è½¬æ¢ä¸ºæ—¥æœŸï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ° <code class="language-plaintext highlighter-rouge">@timestamp</code> å­—æ®µä¸­ã€‚</li>
</ul>

<hr />

<p><strong>ä¿®æ”¹ Ingest ç®¡é“</strong></p>

<p>åœ¨ Elasticsearch ä¸­ï¼Œ<strong>æ²¡æœ‰ç›´æ¥ä¿®æ”¹ç®¡é“çš„ API</strong>ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨åˆ›å»º Ingest ç®¡é“çš„æ–¹å¼è¦†ç›–ã€‚</p>

<hr />

<p><strong>åˆ é™¤Ingest ç®¡é“</strong></p>

<p>åˆ é™¤ç®¡é“çš„æ“ä½œå¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">DeletePipelineRequest</code> æ¥å®ç°ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ›å»ºåˆ é™¤ç®¡é“è¯·æ±‚</span>
<span class="nc">DeletePipelineRequest</span> <span class="n">deleteRequest</span> <span class="o">=</span> <span class="nc">DeletePipelineRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">pipeline</span><span class="o">(</span><span class="s">"my-pipeline"</span><span class="o">));</span>

<span class="c1">// æ‰§è¡Œåˆ é™¤è¯·æ±‚</span>
<span class="nc">DeletePipelineResponse</span> <span class="n">deleteResponse</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">ingest</span><span class="o">().</span><span class="na">deletePipeline</span><span class="o">(</span><span class="n">deleteRequest</span><span class="o">);</span>

<span class="c1">// è¾“å‡ºåˆ é™¤ç»“æœ</span>
<span class="k">if</span> <span class="o">(</span><span class="n">deleteResponse</span><span class="o">.</span><span class="na">acknowledged</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Pipeline deleted successfully."</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Failed to delete pipeline."</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<hr />

<p><strong>æŸ¥è¯¢æŒ‡å®šç®¡é“</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æŸ¥è¯¢æŒ‡å®šç®¡é“</span>
<span class="nc">GetPipelineRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">GetPipelineRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">pipeline</span><span class="o">(</span><span class="s">"my-pipeline"</span><span class="o">));</span>
<span class="c1">// æ‰§è¡ŒæŸ¥è¯¢</span>
<span class="nc">GetPipelineResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">ingest</span><span class="o">().</span><span class="na">getPipeline</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
<span class="c1">// è¾“å‡ºç®¡é“çš„è¯¦ç»†ä¿¡æ¯</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Pipeline details: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">pipelines</span><span class="o">());</span>
</code></pre></div></div>

<hr />

<p><strong>æŸ¥è¯¢æ‰€æœ‰ç®¡é“</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æŸ¥è¯¢æ‰€æœ‰ç®¡é“</span>
<span class="nc">GetPipelineRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">GetPipelineRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">);</span>  <span class="c1">// ä¸ºç©ºè¡¨ç¤ºè·å–æ‰€æœ‰ç®¡é“</span>

<span class="c1">// æ‰§è¡ŒæŸ¥è¯¢</span>
<span class="nc">GetPipelineResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">ingest</span><span class="o">().</span><span class="na">getPipeline</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

<span class="c1">// è¾“å‡ºæ‰€æœ‰ç®¡é“çš„è¯¦ç»†ä¿¡æ¯</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All pipelines: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">pipelines</span><span class="o">());</span>
</code></pre></div></div>

<hr />

<p><strong>å°ç»“</strong></p>

<ul>
  <li><strong>åˆ›å»ºç®¡é“</strong>ï¼šä½¿ç”¨ <code class="language-plaintext highlighter-rouge">PutPipelineRequest</code> å’Œ <code class="language-plaintext highlighter-rouge">client.ingest().putPipeline()</code> æ–¹æ³•ã€‚</li>
  <li><strong>åˆ é™¤ç®¡é“</strong>ï¼šä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DeletePipelineRequest</code> å’Œ <code class="language-plaintext highlighter-rouge">client.ingest().deletePipeline()</code> æ–¹æ³•ã€‚</li>
  <li><strong>ä¿®æ”¹ç®¡é“</strong>ï¼šä¸åˆ›å»ºç›¸åŒï¼Œå¦‚æœç®¡é“å­˜åœ¨åˆ™è¦†ç›–ã€‚</li>
  <li><strong>æŸ¥è¯¢ç®¡é“</strong>ï¼šä½¿ç”¨ <code class="language-plaintext highlighter-rouge">GetPipelineRequest</code> å’Œ <code class="language-plaintext highlighter-rouge">client.ingest().getPipeline()</code>ã€‚</li>
</ul>

<p>è¿™äº›æ“ä½œå¯ä»¥å¸®åŠ©æ‚¨çµæ´»ç®¡ç† Elasticsearch ä¸­çš„ Ingest ç®¡é“ï¼Œç¡®ä¿æ•°æ®åœ¨è¢«ç´¢å¼•ä¹‹å‰èƒ½æŒ‰ç…§éœ€æ±‚è¿›è¡Œå¤„ç†ã€‚</p>

<hr />

<h4 id="å¤„ç†å™¨"><strong>å¤„ç†å™¨</strong></h4>

<p>Elasticsearch çš„ <strong>Ingest Pipeline</strong> æä¾›äº†å¤šç§å¤„ç†å™¨ï¼ˆprocessorsï¼‰ï¼Œç”¨äºåœ¨æ–‡æ¡£è¢«ç´¢å¼•å‰å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚é™¤äº† <code class="language-plaintext highlighter-rouge">set processor</code>ã€<code class="language-plaintext highlighter-rouge">rename processor</code> å’Œ <code class="language-plaintext highlighter-rouge">date processor</code> ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–å¤„ç†å™¨ï¼Œæ¯ç§å¤„ç†å™¨ç”¨äºä¸åŒçš„ä»»åŠ¡ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„å¤„ç†å™¨åŠå…¶åŠŸèƒ½ï¼š</p>

<p><strong>date</strong>: ç”¨äºå°†ä¸€ä¸ªå­—æ®µçš„å­—ç¬¦ä¸²å€¼è½¬æ¢ä¸ºæ—¥æœŸç±»å‹ã€‚å®ƒæ¥æ”¶ä¸€ä¸ªæˆ–å¤šä¸ªè¾“å…¥æ ¼å¼ï¼ˆ<code class="language-plaintext highlighter-rouge">formats</code>ï¼‰ï¼Œå¹¶å°è¯•æŒ‰ç…§è¿™äº›æ ¼å¼å°†è¯¥å­—æ®µè§£æä¸ºæ—¥æœŸã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: è½¬æ¢æ—¥æœŸå­—ç¬¦ä¸²ä¸ºæ—¥æœŸç±»å‹ï¼Œä¾¿äºåç»­çš„æ—¥æœŸæ“ä½œã€‚ä¸‹é¢æ˜¯è¯¥ <code class="language-plaintext highlighter-rouge">date</code> å¤„ç†å™¨çš„å„ä¸ªå‚æ•°çš„è¯¦ç»†è§£é‡Šï¼š</p>

<p><strong><code class="language-plaintext highlighter-rouge">field</code></strong>: <code class="language-plaintext highlighter-rouge">"timestamp"</code>ï¼Œè¿™æ˜¯è¦è½¬æ¢ä¸ºæ—¥æœŸæ ¼å¼çš„å­—æ®µã€‚ä¹Ÿå°±æ˜¯æ–‡æ¡£ä¸­çš„ <code class="language-plaintext highlighter-rouge">timestamp</code> å­—æ®µçš„å€¼å°†è¢«å¤„ç†å¹¶è½¬æ¢ä¸ºæ—¥æœŸã€‚å¦‚æœæ–‡æ¡£ä¸­å­˜åœ¨ <code class="language-plaintext highlighter-rouge">timestamp</code> å­—æ®µï¼Œå¤„ç†å™¨ä¼šå°è¯•å°†å®ƒçš„å€¼è§£æä¸ºæ—¥æœŸã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">target_field</code></strong>: <code class="language-plaintext highlighter-rouge">"@timestamp"</code>ï¼Œè¿™æ˜¯è½¬æ¢åç»“æœçš„ç›®æ ‡å­—æ®µã€‚è½¬æ¢åçš„æ—¥æœŸå€¼å°†è¢«å­˜å‚¨åœ¨ <code class="language-plaintext highlighter-rouge">@timestamp</code> å­—æ®µä¸­ã€‚å¦‚æœæ–‡æ¡£ä¸­æ²¡æœ‰ <code class="language-plaintext highlighter-rouge">@timestamp</code> å­—æ®µï¼ŒElasticsearch ä¼šè‡ªåŠ¨åˆ›å»ºå®ƒã€‚å¦‚æœè¯¥å­—æ®µå·²ç»å­˜åœ¨ï¼Œ<code class="language-plaintext highlighter-rouge">date</code> å¤„ç†å™¨ä¼šè¦†ç›–å®ƒã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">formats</code></strong>: <code class="language-plaintext highlighter-rouge">["yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"]</code></p>

<p>è¿™æ˜¯ä¸€ä¸ªæ ¼å¼æ•°ç»„ï¼Œç”¨äºå®šä¹‰å¦‚ä½•è§£æ <code class="language-plaintext highlighter-rouge">timestamp</code> å­—æ®µçš„å€¼ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰ä¸€ä¸ªæ ¼å¼ï¼š<code class="language-plaintext highlighter-rouge">yyyy-MM-dd'T'HH:mm:ss.SSS'Z'</code>ã€‚</p>

<p>è¿™ä¸ªæ ¼å¼éµå¾ª ISO 8601 æ—¥æœŸæ ¼å¼ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">yyyy</code>ï¼šå¹´ä»½ï¼ˆå››ä½æ•°ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">MM</code>ï¼šæœˆä»½ï¼ˆä¸¤ä½æ•°ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">dd</code>ï¼šæ—¥æœŸï¼ˆä¸¤ä½æ•°ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">T</code>ï¼šæ—¶é—´åˆ†éš”ç¬¦</li>
  <li><code class="language-plaintext highlighter-rouge">HH</code>ï¼šå°æ—¶ï¼ˆ24å°æ—¶åˆ¶ï¼Œä¸¤ä½æ•°ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">mm</code>ï¼šåˆ†é’Ÿï¼ˆä¸¤ä½æ•°ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">ss</code>ï¼šç§’æ•°ï¼ˆä¸¤ä½æ•°ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">SSS</code>ï¼šæ¯«ç§’æ•°ï¼ˆ3ä½æ•°ï¼‰</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Z</code>ï¼šè¡¨ç¤ºé›¶æ—¶åŒºï¼Œé€šå¸¸ç”¨äºè¡¨ç¤º UTC æ—¶é—´ã€‚</p>
  </li>
  <li>ä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">2024-12-07T10:30:00.000Z</code> è¡¨ç¤º 2024 å¹´ 12 æœˆ 7 æ—¥ 10:30:00ï¼ˆUTC æ—¶é—´ï¼‰ã€‚</li>
</ul>

<p><strong>Set</strong>: ç”¨äºè®¾ç½®æˆ–ä¿®æ”¹å­—æ®µçš„å€¼ã€‚å¦‚æœå­—æ®µå·²ç»å­˜åœ¨ï¼Œè¯¥å­—æ®µçš„å€¼å°†è¢«è¦†ç›–ï¼›å¦‚æœå­—æ®µä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºè¯¥å­—æ®µã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: ä¸ºæ–‡æ¡£ä¸­çš„æŸä¸ªå­—æ®µèµ‹äºˆå›ºå®šçš„å€¼ã€‚è¿™ä¸ªä¾‹å­å°†å­—æ®µ <code class="language-plaintext highlighter-rouge">status</code> çš„å€¼è®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">"active"</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"set"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"status"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Rename</strong>: ç”¨äºé‡å‘½åå­—æ®µï¼Œå°†ä¸€ä¸ªå­—æ®µçš„å€¼èµ‹ç»™å¦ä¸€ä¸ªå­—æ®µå¹¶åˆ é™¤åŸå§‹å­—æ®µã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: é‡å‘½åå­—æ®µï¼Œä»¥ä¾¿åç»­å¤„ç†æˆ–ç¬¦åˆç´¢å¼•çš„è®¾è®¡ã€‚è¿™ä¸ªä¾‹å­å°† <code class="language-plaintext highlighter-rouge">old_name</code> å­—æ®µé‡å‘½åä¸º <code class="language-plaintext highlighter-rouge">new_name</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"rename"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"old_name"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"new_name"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Uppercase Processor</strong>: å°†å­—æ®µçš„å€¼è½¬æ¢ä¸ºå¤§å†™å½¢å¼ã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: ç»Ÿä¸€å­—æ®µå€¼çš„å¤§å°å†™ï¼Œä¾¿äºæ£€ç´¢æˆ–é¿å…å¤§å°å†™ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"uppercase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Lowercase Processor</strong>: å°†å­—æ®µçš„å€¼è½¬æ¢ä¸ºå°å†™å½¢å¼ã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: å°†æ–‡æœ¬æ•°æ®ç»Ÿä¸€ä¸ºå°å†™ï¼Œç¡®ä¿å¤§å°å†™ä¸€è‡´æ€§ã€‚è¿™ä¸ªä¾‹å­å°† <code class="language-plaintext highlighter-rouge">email</code> å­—æ®µçš„å€¼è½¬æ¢ä¸ºå°å†™ã€‚:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"lowercase"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"email"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Trim Processor</strong>: å»æ‰å­—æ®µå€¼çš„å‰åç©ºç™½å­—ç¬¦ã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: å»é™¤ç”¨æˆ·è¾“å…¥å­—æ®µä¸­çš„å¤šä½™ç©ºæ ¼ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚è¿™ä¸ªä¾‹å­ä¼šå»æ‰ <code class="language-plaintext highlighter-rouge">username</code> å­—æ®µå‰åçš„ç©ºæ ¼ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"trim"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"username"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Grok Processor</strong>: ä½¿ç”¨ <strong>Grok</strong> æ¨¡å¼ï¼ˆç±»ä¼¼æ­£åˆ™è¡¨è¾¾å¼ï¼‰ä»æ–‡æœ¬ä¸­æå–ä¿¡æ¯ã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: ç”¨äºä»å­—æ®µä¸­æå–å’Œè§£æç‰¹å®šæ¨¡å¼çš„æ•°æ®ï¼ˆå¦‚æ—¥å¿—æ–‡ä»¶è§£æã€IP åœ°å€è§£æç­‰ï¼‰ã€‚è¿™ä¸ªä¾‹å­ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Grok</code> æ¨¡å¼ä» <code class="language-plaintext highlighter-rouge">message</code> å­—æ®µä¸­æå–å‡º IPv4 åœ°å€å¹¶å°†å…¶å­˜å‚¨åˆ° <code class="language-plaintext highlighter-rouge">client_ip</code> å­—æ®µã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"grok"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"message"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"patterns"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"%{IPV4:client_ip}"</span><span class="p">]</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Remove Processor</strong>: åˆ é™¤æŒ‡å®šçš„å­—æ®µã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: æ¸…ç†æ— ç”¨æˆ–æ•æ„Ÿçš„å­—æ®µï¼Œå‡å°‘å­˜å‚¨ç©ºé—´ã€‚è¿™ä¸ªä¾‹å­ä¼šåˆ é™¤ <code class="language-plaintext highlighter-rouge">password</code> å­—æ®µã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"remove"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"password"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Json Processor</strong>:ä»å­—ç¬¦ä¸²ä¸­æå– JSON æ•°æ®ï¼Œå¹¶å°†å…¶è§£æä¸ºå­—æ®µã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: å°†åµŒå¥—çš„ JSON å­—ç¬¦ä¸²è§£æä¸º JSON å¯¹è±¡ã€‚è¿™ä¸ªä¾‹å­ä¼šå°† <code class="language-plaintext highlighter-rouge">json_string</code> å­—æ®µçš„ JSON æ•°æ®è§£æä¸º JSON å¯¹è±¡ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ° <code class="language-plaintext highlighter-rouge">json_object</code> å­—æ®µã€‚</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"json"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"json_string"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"json_object"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Convert Processor</strong>: å°†å­—æ®µçš„å€¼è½¬æ¢ä¸ºæŒ‡å®šç±»å‹ï¼ˆå¦‚å­—ç¬¦ä¸²ã€æ•´æ•°ã€å¸ƒå°”å€¼ç­‰ï¼‰ã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: ç¡®ä¿å­—æ®µå€¼çš„æ•°æ®ç±»å‹ç¬¦åˆé¢„æœŸã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"convert"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"price"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"float"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Script Processor</strong>: ä½¿ç”¨è„šæœ¬åŠ¨æ€è®¡ç®—å­—æ®µçš„å€¼ã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: æ ¹æ®å¤æ‚çš„é€»è¾‘åŠ¨æ€ä¿®æ”¹å­—æ®µå€¼ã€‚è¿™ä¸ªä¾‹å­é€šè¿‡è„šæœ¬è®¡ç®— <code class="language-plaintext highlighter-rouge">discount</code> å­—æ®µçš„å€¼ï¼Œä¾æ® <code class="language-plaintext highlighter-rouge">price</code> å­—æ®µçš„å€¼æ¥è®¾ç½®ä¸åŒçš„æŠ˜æ‰£ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"script"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"if (ctx.price &lt; 10) { ctx.discount = 0.1 } else { ctx.discount = 0.05 }"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Split Processor</strong>: å°†ä¸€ä¸ªå­—æ®µçš„å€¼æ‹†åˆ†æˆå¤šä¸ªå€¼ï¼Œé€šå¸¸æ˜¯é€šè¿‡åˆ†éš”ç¬¦ã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: å°†ä¸€ä¸ªå­—æ®µçš„å¤šä¸ªå€¼æ‹†åˆ†åˆ°ä¸åŒçš„å­—æ®µä¸­ã€‚è¿™ä¸ªä¾‹å­å°† <code class="language-plaintext highlighter-rouge">full_name</code> å­—æ®µçš„å€¼æŒ‰ç©ºæ ¼æ‹†åˆ†ï¼Œç»“æœå­˜å‚¨åˆ° <code class="language-plaintext highlighter-rouge">name_parts</code> å­—æ®µä¸­ã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"split"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"full_name"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"separator"</span><span class="p">:</span><span class="w"> </span><span class="s2">" "</span><span class="p">,</span><span class="w">
   </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"name_parts"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>IP Processor</strong>: è§£æ IP åœ°å€å¹¶å°†å…¶è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ã€‚<strong>å¸¸ç”¨åœºæ™¯</strong>: ç”¨äºä»å­—ç¬¦ä¸²ä¸­æå–å¹¶è§£æ IP åœ°å€ã€‚è¿™ä¸ªä¾‹å­ä¼šè§£æ <code class="language-plaintext highlighter-rouge">ip_address</code> å­—æ®µä¸­çš„ IP åœ°å€å¹¶å°†å…¶å­˜å‚¨åˆ° <code class="language-plaintext highlighter-rouge">parsed_ip</code> å­—æ®µã€‚</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"ip"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ip_address"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"target_field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"parsed_ip"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>æ€»ç»“</strong></p>

<p>Elasticsearch æä¾›çš„ <strong>Ingest Pipeline</strong> å¤„ç†å™¨å…è®¸ç”¨æˆ·åœ¨ç´¢å¼•æ•°æ®ä¹‹å‰çµæ´»åœ°å¤„ç†å’Œè½¬æ¢æ•°æ®ã€‚é€šè¿‡è¿™äº›å¤„ç†å™¨ï¼Œç”¨æˆ·å¯ä»¥æ¸…æ´—æ•°æ®ã€ä¿®æ”¹å­—æ®µã€æå–ä¿¡æ¯ã€è½¬æ¢æ•°æ®ç±»å‹ç­‰ï¼Œç¡®ä¿ç´¢å¼•ä¸­çš„æ•°æ®ç¬¦åˆé¢„æœŸæ ¼å¼å¹¶æ»¡è¶³æœç´¢éœ€æ±‚ã€‚æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯ï¼Œå¼€å‘äººå‘˜å¯ä»¥é€‰æ‹©åˆé€‚çš„å¤„ç†å™¨ç»„åˆæ¥å®ç°æ•°æ®å¤„ç†æµç¨‹ã€‚</p>

<h3 id="æ‰¹é‡æ“ä½œ">æ‰¹é‡æ“ä½œ</h3>

<p>æ‰¹é‡è¯·æ±‚å…è®¸åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­å‘ Elasticsearch å‘é€å¤šä¸ªä¸æ–‡æ¡£ç›¸å…³çš„æ“ä½œã€‚è¦åˆ›å»ºæ­¤è¯·æ±‚ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å°† builder å¯¹è±¡ç”¨äºä¸»è¯·æ±‚ï¼Œå¹¶ä¸ºæ¯ä¸ªæ“ä½œä½¿ç”¨ Fluent DSLã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">record</span> <span class="nf">Product</span><span class="o">(</span><span class="nc">String</span> <span class="n">sku</span><span class="o">,</span> <span class="nc">String</span> <span class="n">cityBike</span><span class="o">,</span> <span class="kt">double</span> <span class="n">v</span><span class="o">)</span> <span class="o">{}</span>
<span class="nc">Product</span> <span class="n">product1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">" City bike "</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>
<span class="nc">Product</span> <span class="n">product2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-2"</span><span class="o">,</span> <span class="s">" City bike "</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>
<span class="nc">Product</span> <span class="n">product3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-3"</span><span class="o">,</span> <span class="s">" City bike "</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>
<span class="nc">Product</span> <span class="n">product4</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-4"</span><span class="o">,</span> <span class="s">" City bike "</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">product1</span><span class="o">,</span><span class="n">product2</span><span class="o">,</span><span class="n">product3</span><span class="o">,</span><span class="n">product4</span><span class="o">);</span>
<span class="c1">// * ä½¿ç”¨ Fluent DSL</span>
<span class="nc">BulkRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>
<span class="n">list</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">p</span><span class="o">-&gt;</span> 
    <span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">op</span>
        <span class="o">.</span><span class="na">index</span><span class="o">(</span> <span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span>
            <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">sku</span><span class="o">())</span>
            <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="n">p</span><span class="o">)</span>
<span class="o">)));</span>
<span class="nc">BulkResponse</span> <span class="n">result</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">bulk</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>

<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">errors</span><span class="o">()){</span>
    <span class="n">result</span><span class="o">.</span><span class="na">items</span><span class="o">().</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span><span class="o">-&gt;{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">error</span><span class="o">()!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">reason</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="bulkrequest"><code class="language-plaintext highlighter-rouge">BulkRequest</code></h4>

<p><code class="language-plaintext highlighter-rouge">BulkRequest</code> æ˜¯ Elasticsearch Java API æä¾›çš„ç”¨äºæ‰¹é‡æ“ä½œçš„è¯·æ±‚ç±»ã€‚å®ƒå…è®¸åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œï¼ˆå¦‚åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰ã€‚ä»¥ä¸‹æ˜¯å…¶å¸¸ç”¨æ–¹æ³•å’Œå˜é‡çš„è¯¦ç»†è¯´æ˜ï¼š</p>

<p><strong>ä¸»è¦å˜é‡</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">operations</code></strong>ï¼šå­˜å‚¨æ‰€æœ‰è¦åœ¨æ‰¹é‡æ“ä½œä¸­æ‰§è¡Œçš„æ“ä½œåˆ—è¡¨ã€‚</p>

<ul>
  <li><strong>ç±»å‹</strong>ï¼š<code class="language-plaintext highlighter-rouge">List&lt;BulkOperation&gt;</code></li>
  <li><strong>ä½œç”¨</strong>ï¼šæ¯ä¸ª <code class="language-plaintext highlighter-rouge">BulkOperation</code> å¯¹è±¡è¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„æ“ä½œï¼Œä¾‹å¦‚ç´¢å¼•æ–‡æ¡£ã€æ›´æ–°æ–‡æ¡£æˆ–åˆ é™¤æ–‡æ¡£ã€‚</li>
  <li>
    <p><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>
<span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">)));</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">timeout</code></strong>ï¼šè®¾ç½®æ‰¹é‡è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ã€‚</p>

<ul>
  <li><strong>ç±»å‹</strong>ï¼š<code class="language-plaintext highlighter-rouge">Time</code></li>
  <li><strong>ä½œç”¨</strong>ï¼šå¦‚æœæ‰¹é‡æ“ä½œæœªåœ¨æŒ‡å®šæ—¶é—´å†…å®Œæˆï¼Œå¯èƒ½ä¼šè¢«ç»ˆæ­¢ã€‚</li>
  <li><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">timeout</span><span class="o">(</span><span class="s">"2m"</span><span class="o">);</span> <span class="c1">// è®¾ç½®è¶…æ—¶ä¸º 2 åˆ†é’Ÿ</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">refresh</code></strong>ï¼šæŒ‡å®šæ˜¯å¦åˆ·æ–°ç´¢å¼•ï¼Œä½¿æ–‡æ¡£åœ¨æ‰¹é‡æ“ä½œåç«‹å³å¯è§ï¼Œæ–¹æ³•åŒ<code class="language-plaintext highlighter-rouge">IndexRequest</code>ã€‚</p>

<ul>
  <li><strong>ç±»å‹</strong>ï¼š<code class="language-plaintext highlighter-rouge">Enum</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">true</code>, <code class="language-plaintext highlighter-rouge">false</code>, <code class="language-plaintext highlighter-rouge">wait_for</code>ï¼‰</li>
  <li>
    <p><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="nc">Refresh</span><span class="o">.</span><span class="na">True</span><span class="o">);</span> <span class="c1">// æ“ä½œå®Œæˆååˆ·æ–°ç´¢å¼•</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<p><strong>å¸¸ç”¨æ–¹æ³•</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">operations()</code></strong>ï¼šè·å–å½“å‰ <code class="language-plaintext highlighter-rouge">BulkRequest</code> ä¸­çš„æ‰€æœ‰æ“ä½œã€‚</p>

<ul>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">List&lt;BulkOperation&gt;</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šå¯ä»¥æ£€æŸ¥è¯·æ±‚ä¸­åŒ…å«çš„æ‰€æœ‰æ“ä½œã€‚</li>
  <li>
    <p><strong>ç¤ºä¾‹</strong>ï¼š</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">BulkOperation</span><span class="o">&gt;</span> <span class="n">ops</span> <span class="o">=</span> <span class="n">bulkRequest</span><span class="o">.</span><span class="na">operations</span><span class="o">();</span>
<span class="n">ops</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">op</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">operations(BulkOperation operation)</code></strong>ï¼šæ·»åŠ ä¸€ä¸ªæ“ä½œåˆ°æ‰¹é‡è¯·æ±‚ä¸­ã€‚</p>

<ul>
  <li><strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">operation</code>ï¼šä¸€ä¸ª <code class="language-plaintext highlighter-rouge">BulkOperation</code> å¯¹è±¡ã€‚</li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šé€ä¸ªæ·»åŠ æ“ä½œã€‚</li>
  <li>
    <p><strong>ç¤ºä¾‹</strong>ï¼š</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">)));</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">operations(List&lt;BulkOperation&gt; operations)</code></strong>ï¼šæ‰¹é‡æ·»åŠ å¤šä¸ªæ“ä½œåˆ°è¯·æ±‚ä¸­ã€‚</p>

<ul>
  <li><strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">operations</code>ï¼šä¸€ä¸ªåŒ…å«å¤šä¸ª <code class="language-plaintext highlighter-rouge">BulkOperation</code> çš„åˆ—è¡¨ã€‚</li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šåœ¨ä¸€æ¬¡è°ƒç”¨ä¸­æ·»åŠ æ‰€æœ‰æ“ä½œã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">BulkOperation</span><span class="o">&gt;</span> <span class="n">operations</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">operations</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">)).</span><span class="na">build</span><span class="o">());</span>
<span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">operations</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">timeout(String timeout)</code></strong>ï¼šè®¾ç½®æ“ä½œçš„è¶…æ—¶æ—¶é—´ã€‚</p>

<ul>
  <li><strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">timeout</code>ï¼šä¸€ä¸ªå­—ç¬¦ä¸²è¡¨ç¤ºçš„æ—¶é—´å€¼ï¼ˆä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">"1m"</code> è¡¨ç¤º 1 åˆ†é’Ÿï¼‰ã€‚</li>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">BulkRequest.Builder</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šæ§åˆ¶æ‰¹é‡æ“ä½œçš„æœ€å¤§è€—æ—¶ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">timeout</span><span class="o">(</span><span class="s">"1m"</span><span class="o">);</span> <span class="c1">// è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 1 åˆ†é’Ÿ</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">refresh(Refresh refresh)</code></strong>ï¼šè®¾ç½®æ˜¯å¦åˆ·æ–°ç´¢å¼•ï¼Œæ–¹æ³•åŒ<code class="language-plaintext highlighter-rouge">IndexRequest</code>ã€‚</p>

<ul>
  <li><strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">refresh</code>ï¼šä¸€ä¸ªæšä¸¾å€¼ï¼Œå¯ä»¥æ˜¯ <code class="language-plaintext highlighter-rouge">Refresh.True</code>, <code class="language-plaintext highlighter-rouge">Refresh.False</code>, æˆ– <code class="language-plaintext highlighter-rouge">Refresh.WaitFor</code>ã€‚</li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šç¡®ä¿æ•°æ®åœ¨æ“ä½œå®Œæˆåç«‹å³å¯è§ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="nc">Refresh</span><span class="o">.</span><span class="na">WaitFor</span><span class="o">);</span> <span class="c1">// ç­‰å¾…åˆ·æ–°å®Œæˆ</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">build()</code></strong>ï¼šæ„å»ºä¸€ä¸ª <code class="language-plaintext highlighter-rouge">BulkRequest</code> å¯¹è±¡ã€‚</p>

<ul>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">BulkRequest</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šå®Œæˆå¯¹ <code class="language-plaintext highlighter-rouge">BulkRequest.Builder</code> çš„é…ç½®åç”Ÿæˆè¯·æ±‚å¯¹è±¡ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div>    </div>
  </li>
</ul>

<hr />

<p><strong>æ‰¹é‡æ“ä½œç±»å‹çš„æ”¯æŒ</strong></p>

<p><code class="language-plaintext highlighter-rouge">BulkRequest</code> æ”¯æŒä¸‰ç§æ“ä½œç±»å‹ï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">BulkOperation</code> è®¾ç½®å…·ä½“æ“ä½œç±»å‹ï¼š</p>

<p><strong>ç´¢å¼•æ“ä½œï¼ˆIndexï¼‰</strong>ï¼šç”¨äºæ–°å¢æ–‡æ¡£ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">)));</span>
</code></pre></div></div>

<p><strong>æ›´æ–°æ“ä½œï¼ˆUpdateï¼‰</strong>ï¼šç”¨äºæ›´æ–°å·²æœ‰æ–‡æ¡£ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">upd</span> <span class="o">-&gt;</span> <span class="n">upd</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">doc</span><span class="o">(</span><span class="n">updateDoc</span><span class="o">)));</span>
</code></pre></div></div>

<p><strong>åˆ é™¤æ“ä½œï¼ˆDeleteï¼‰</strong>ï¼šç”¨äºåˆ é™¤æ–‡æ¡£ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">del</span> <span class="o">-&gt;</span> <span class="n">del</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">)));</span>
</code></pre></div></div>

<p>ç¤ºä¾‹ï¼šæ„å»ºä¸€ä¸ªåŒ…å«å¤šä¸ªæ“ä½œçš„ <code class="language-plaintext highlighter-rouge">BulkRequest</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>

<span class="c1">// æ·»åŠ ç´¢å¼•æ“ä½œ</span>
<span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">document</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City Bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">))));</span>

<span class="c1">// æ·»åŠ æ›´æ–°æ“ä½œ</span>
<span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">upd</span> <span class="o">-&gt;</span> <span class="n">upd</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"2"</span><span class="o">).</span><span class="na">doc</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mf">150.0</span><span class="o">))));</span>

<span class="c1">// æ·»åŠ åˆ é™¤æ“ä½œ</span>
<span class="n">builder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">del</span> <span class="o">-&gt;</span> <span class="n">del</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"3"</span><span class="o">)));</span>

<span class="c1">// è®¾ç½®åˆ·æ–°é€‰é¡¹å’Œè¶…æ—¶æ—¶é—´</span>
<span class="n">builder</span><span class="o">.</span><span class="na">refresh</span><span class="o">(</span><span class="nc">Refresh</span><span class="o">.</span><span class="na">WaitFor</span><span class="o">);</span>
<span class="n">builder</span><span class="o">.</span><span class="na">timeout</span><span class="o">(</span><span class="s">"2m"</span><span class="o">);</span>

<span class="c1">// æ„å»ºå¹¶æ‰§è¡Œè¯·æ±‚</span>
<span class="nc">BulkResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">bulk</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>

<span class="c1">// æ£€æŸ¥å“åº”æ˜¯å¦æœ‰é”™è¯¯</span>
<span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">errors</span><span class="o">())</span> <span class="o">{</span>
    <span class="n">response</span><span class="o">.</span><span class="na">items</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">error</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">reason</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Bulk request executed successfully!"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>é€‚ç”¨åœºæ™¯</p>
<ol>
  <li>å¤§é‡æ–‡æ¡£çš„å¢åˆ æ”¹æ“ä½œã€‚</li>
  <li>å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œå‡å°‘ HTTP è¯·æ±‚æ•°ã€‚</li>
  <li>åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸­éœ€è¦å¿«é€Ÿå¤„ç†æ‰¹é‡ä»»åŠ¡ã€‚</li>
</ol>

<h4 id="bulkoperation"><code class="language-plaintext highlighter-rouge">BulkOperation</code></h4>

<p><code class="language-plaintext highlighter-rouge">BulkOperation</code> æ˜¯ Elasticsearch Java API ä¸­æ‰¹é‡æ“ä½œè¯·æ±‚çš„ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºæè¿°å•ä¸ªæ“ä½œï¼ˆå¦‚åˆ›å»ºã€æ›´æ–°æˆ–åˆ é™¤ï¼‰ã€‚ä»¥ä¸‹æ˜¯ <code class="language-plaintext highlighter-rouge">BulkOperation</code> çš„ä¸»è¦å˜é‡å’Œæ–¹æ³•çš„è¯¦ç»†ä»‹ç»ã€‚</p>

<p><strong>ä¸»è¦å˜é‡</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">index</code></strong>ï¼šå­˜å‚¨ç´¢å¼•æ“ä½œï¼ˆ<code class="language-plaintext highlighter-rouge">IndexOperation</code>ï¼‰çš„å®šä¹‰ã€‚</p>

<ul>
  <li><strong>ç±»å‹</strong>ï¼š<code class="language-plaintext highlighter-rouge">IndexOperation&lt;TDocument&gt;</code></li>
  <li><strong>ä½œç”¨</strong>ï¼šè¡¨ç¤ºä¸€ä¸ªæ–‡æ¡£çš„æ–°å¢æ“ä½œã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkOperation</span> <span class="n">op</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">update</code></strong>ï¼šå­˜å‚¨æ›´æ–°æ“ä½œï¼ˆ<code class="language-plaintext highlighter-rouge">UpdateOperation</code>ï¼‰çš„å®šä¹‰ã€‚</p>

<ul>
  <li><strong>ç±»å‹</strong>ï¼š<code class="language-plaintext highlighter-rouge">UpdateOperation&lt;TDocument, TPartialDocument&gt;</code></li>
  <li><strong>ä½œç”¨</strong>ï¼šè¡¨ç¤ºä¸€ä¸ªæ–‡æ¡£çš„æ›´æ–°æ“ä½œï¼Œå¯ä»¥æ›´æ–°éƒ¨åˆ†æˆ–å…¨éƒ¨å†…å®¹ã€‚</li>
  <li>
    <p><strong>ç¤ºä¾‹</strong>ï¼š</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkOperation</span> <span class="n">op</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">upd</span> <span class="o">-&gt;</span> <span class="n">upd</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">doc</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mf">150.0</span><span class="o">)))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">delete</code></strong>ï¼šå­˜å‚¨åˆ é™¤æ“ä½œï¼ˆ<code class="language-plaintext highlighter-rouge">DeleteOperation</code>ï¼‰çš„å®šä¹‰ã€‚</p>

<ul>
  <li><strong>ç±»å‹</strong>ï¼š<code class="language-plaintext highlighter-rouge">DeleteOperation</code></li>
  <li><strong>ä½œç”¨</strong>ï¼šè¡¨ç¤ºä¸€ä¸ªæ–‡æ¡£çš„åˆ é™¤æ“ä½œã€‚</li>
  <li>
    <p><strong>ç¤ºä¾‹</strong>ï¼š</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkOperation</span> <span class="n">op</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">del</span> <span class="o">-&gt;</span> <span class="n">del</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">operationType</code></strong>ï¼šæ ‡è¯†å½“å‰æ“ä½œçš„ç±»å‹ï¼ˆ<code class="language-plaintext highlighter-rouge">index</code>ã€<code class="language-plaintext highlighter-rouge">update</code>ã€<code class="language-plaintext highlighter-rouge">delete</code>ï¼‰ã€‚</p>

<ul>
  <li><strong>ç±»å‹</strong>ï¼š<code class="language-plaintext highlighter-rouge">BulkOperation.Kind</code></li>
  <li><strong>ä½œç”¨</strong>ï¼šç”¨äºåŒºåˆ†æ“ä½œç±»å‹ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Kind</span> <span class="n">type</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="na">operationType</span><span class="o">();</span> <span class="c1">// è¿”å›æ“ä½œç±»å‹</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong>å¸¸ç”¨æ–¹æ³•</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">index(Function&lt;IndexOperation.Builder&lt;TDocument&gt;, ObjectBuilder&lt;IndexOperation&lt;TDocument&gt;&gt;&gt; fn)</code></strong></p>
<ul>
  <li><strong>æè¿°</strong>ï¼šè®¾ç½®ä¸€ä¸ªç´¢å¼•æ“ä½œã€‚</li>
  <li><strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">fn</code>ï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºé…ç½® <code class="language-plaintext highlighter-rouge">IndexOperation</code>ã€‚</li>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">BulkOperation.Builder</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šæ·»åŠ ä¸€ä¸ªæ–‡æ¡£çš„ç´¢å¼•æ“ä½œã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">document</span><span class="o">(</span><span class="n">product</span><span class="o">));</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">update(Function&lt;UpdateOperation.Builder&lt;TDocument, TPartialDocument&gt;, ObjectBuilder&lt;UpdateOperation&lt;TDocument, TPartialDocument&gt;&gt;&gt; fn)</code></strong></p>

<ul>
  <li><strong>æè¿°</strong>ï¼šè®¾ç½®ä¸€ä¸ªæ›´æ–°æ“ä½œã€‚</li>
  <li><strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">fn</code>ï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºé…ç½® <code class="language-plaintext highlighter-rouge">UpdateOperation</code>ã€‚</li>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">BulkOperation.Builder</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šå¯¹æ–‡æ¡£è¿›è¡Œæ›´æ–°ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">upd</span> <span class="o">-&gt;</span> <span class="n">upd</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">doc</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mf">200.0</span><span class="o">)));</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">delete(Function&lt;DeleteOperation.Builder, ObjectBuilder&lt;DeleteOperation&gt;&gt; fn)</code></strong></p>

<ul>
  <li><strong>æè¿°</strong>ï¼šè®¾ç½®ä¸€ä¸ªåˆ é™¤æ“ä½œã€‚</li>
  <li><strong>å‚æ•°</strong>ï¼š<code class="language-plaintext highlighter-rouge">fn</code>ï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºé…ç½® <code class="language-plaintext highlighter-rouge">DeleteOperation</code>ã€‚</li>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">BulkOperation.Builder</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šåˆ é™¤æ–‡æ¡£ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">del</span> <span class="o">-&gt;</span> <span class="n">del</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">));</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">operationType()</code></strong>ï¼šè¿”å›å½“å‰æ“ä½œçš„ç±»å‹ã€‚</p>
<ul>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">BulkOperation.Kind</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šç¡®å®šæ“ä½œçš„ç±»å‹ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">index</code>, <code class="language-plaintext highlighter-rouge">update</code>, <code class="language-plaintext highlighter-rouge">delete</code>ï¼‰ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Kind</span> <span class="n">type</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="na">operationType</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Kind</span><span class="o">.</span><span class="na">Index</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"This is an index operation"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">toJsonp()</code></strong>ï¼šå°†å½“å‰æ“ä½œåºåˆ—åŒ–ä¸º JSONã€‚</p>
<ul>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">void</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šè°ƒè¯•æˆ–è®°å½•æ“ä½œæ—¶æŸ¥çœ‹å…¶ JSON è¡¨ç¤ºã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">op</span><span class="o">.</span><span class="na">toJsonp</span><span class="o">(</span><span class="n">generator</span><span class="o">);</span> <span class="c1">// å°†æ“ä½œåºåˆ—åŒ–ä¸º JSON æ ¼å¼</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">equals()</code></strong>ï¼šæ£€æŸ¥ä¸¤ä¸ª <code class="language-plaintext highlighter-rouge">BulkOperation</code> æ˜¯å¦ç›¸ç­‰ã€‚</p>
<ul>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">boolean</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šåˆ¤æ–­ä¸¤ä¸ª <code class="language-plaintext highlighter-rouge">BulkOperation</code> æ˜¯å¦å…·æœ‰ç›¸åŒçš„å†…å®¹ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">op1</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">op2</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"The operations are the same"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">hashCode()</code></strong>ï¼šè¿”å› <code class="language-plaintext highlighter-rouge">BulkOperation</code> çš„å“ˆå¸Œç ã€‚</p>
<ul>
  <li><strong>è¿”å›å€¼</strong>ï¼š<code class="language-plaintext highlighter-rouge">int</code></li>
  <li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼šåœ¨é›†åˆï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">HashMap</code> æˆ– <code class="language-plaintext highlighter-rouge">HashSet</code>ï¼‰ä¸­å­˜å‚¨ <code class="language-plaintext highlighter-rouge">BulkOperation</code>ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hash code: "</span> <span class="o">+</span> <span class="n">hash</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>ç¤ºä¾‹ï¼šæ„å»ºä¸åŒç±»å‹çš„ <code class="language-plaintext highlighter-rouge">BulkOperation</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ„å»ºç´¢å¼•æ“ä½œ</span>
<span class="nc">BulkOperation</span> <span class="n">indexOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">document</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City Bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">)))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="c1">// æ„å»ºæ›´æ–°æ“ä½œ</span>
<span class="nc">BulkOperation</span> <span class="n">updateOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">upd</span> <span class="o">-&gt;</span> <span class="n">upd</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">).</span><span class="na">doc</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mf">150.0</span><span class="o">)))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="c1">// æ„å»ºåˆ é™¤æ“ä½œ</span>
<span class="nc">BulkOperation</span> <span class="n">deleteOp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">del</span> <span class="o">-&gt;</span> <span class="n">del</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">id</span><span class="o">(</span><span class="s">"1"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="c1">// ä½¿ç”¨æ“ä½œ</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">indexOp</span><span class="o">.</span><span class="na">operationType</span><span class="o">());</span> <span class="c1">// è¾“å‡º: Index</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">updateOp</span><span class="o">.</span><span class="na">operationType</span><span class="o">());</span> <span class="c1">// è¾“å‡º: Update</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">deleteOp</span><span class="o">.</span><span class="na">operationType</span><span class="o">());</span> <span class="c1">// è¾“å‡º: Delete</span>
</code></pre></div></div>

<p><strong>é€‚ç”¨åœºæ™¯</strong></p>
<ul>
  <li>åœ¨æ‰¹é‡æ“ä½œä¸­ç»†ç²’åº¦æ§åˆ¶å•ä¸ªæ“ä½œçš„å†…å®¹ã€‚</li>
  <li>ä½¿ç”¨ä¸åŒæ“ä½œç±»å‹ç»„åˆå¤æ‚çš„æ‰¹é‡è¯·æ±‚ã€‚</li>
  <li>åŠ¨æ€æ„å»ºæ“ä½œç±»å‹ä»¥é€‚åº”ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ã€‚</li>
</ul>

<h4 id="indexrequestå’Œindexoperation"><code class="language-plaintext highlighter-rouge">IndexRequest</code>å’Œ<code class="language-plaintext highlighter-rouge">IndexOperation</code></h4>

<p><code class="language-plaintext highlighter-rouge">IndexRequest.Builder&lt;Object&gt;</code> å’Œ <code class="language-plaintext highlighter-rouge">co.elastic.clients.elasticsearch.core.bulk.IndexOperation.Builder&lt;Object&gt;</code> æ˜¯ Elasticsearch Java API ä¸­çš„ä¸¤ä¸ªä¸åŒç±»ï¼Œè™½ç„¶å®ƒä»¬çš„åŠŸèƒ½æœ‰ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†ç”¨é€”å’Œä¸Šä¸‹æ–‡ä¸åŒã€‚</p>

<p><strong><code class="language-plaintext highlighter-rouge">IndexRequest.Builder&lt;Object&gt;</code></strong></p>

<p>ç”¨äºæ„å»ºå•ä¸ªç´¢å¼•è¯·æ±‚ (<code class="language-plaintext highlighter-rouge">IndexRequest</code>)ã€‚ä¸»è¦ç”¨äºæ‰§è¡Œå•ä¸ª <code class="language-plaintext highlighter-rouge">index</code> æ“ä½œã€‚</p>

<p><strong>å¸¸ç”¨åœºæ™¯</strong></p>
<ul>
  <li>ç›´æ¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">IndexRequest</code> æ’å…¥æˆ–æ›´æ–°ä¸€ä¸ªæ–‡æ¡£ã€‚</li>
  <li>ç”¨äºéæ‰¹é‡çš„å•æ–‡æ¡£æ“ä½œã€‚</li>
</ul>

<p><strong>å…³é”®æ–¹æ³•</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">.index(String index)</code>ï¼šè®¾ç½®ç´¢å¼•åç§°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">.id(String id)</code>ï¼šè®¾ç½®æ–‡æ¡£ IDã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">.document(Object document)</code>ï¼šè®¾ç½®æ–‡æ¡£å†…å®¹ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">.refresh(String refreshPolicy)</code>ï¼šè®¾ç½®åˆ·æ–°ç­–ç•¥ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">.routing(String routing)</code>ï¼šè®¾ç½®è·¯ç”±ã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;&gt;();</span>
<span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">request</span> <span class="o">=</span> <span class="n">builder</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City Bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<hr />

<p><strong><code class="language-plaintext highlighter-rouge">IndexOperation.Builder&lt;Object&gt;</code></strong></p>

<p>ç”¨äºæ„å»ºæ‰¹é‡æ“ä½œä¸­çš„å•ä¸ªç´¢å¼•æ“ä½œ (<code class="language-plaintext highlighter-rouge">IndexOperation</code>)ã€‚æ˜¯ <code class="language-plaintext highlighter-rouge">BulkRequest</code> çš„ç»„æˆéƒ¨åˆ†ï¼Œç”¨äºå¤„ç†å¤šæ–‡æ¡£çš„æ‰¹é‡æ“ä½œã€‚</p>

<p><strong>å¸¸ç”¨åœºæ™¯</strong></p>
<ul>
  <li>åœ¨æ‰¹é‡æ“ä½œä¸­æ·»åŠ ä¸€ä¸ªæ–‡æ¡£çš„ç´¢å¼•æ“ä½œã€‚</li>
  <li>ç”¨äº <code class="language-plaintext highlighter-rouge">BulkRequest</code>ï¼Œæ”¯æŒä¸å…¶ä»–æ“ä½œï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">update</code>ã€<code class="language-plaintext highlighter-rouge">delete</code>ï¼‰æ··åˆä½¿ç”¨ã€‚</li>
</ul>

<p><strong>å…³é”®æ–¹æ³•</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">.index(String index)</code>ï¼šè®¾ç½®ç´¢å¼•åç§°ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">.id(String id)</code>ï¼šè®¾ç½®æ–‡æ¡£ IDã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">.document(Object document)</code>ï¼šè®¾ç½®æ–‡æ¡£å†…å®¹ã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">IndexOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexOperation</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;&gt;();</span>
<span class="nc">IndexOperation</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">operation</span> <span class="o">=</span> <span class="n">builder</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City Bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<hr />

<p><strong>ä¸»è¦åŒºåˆ«</strong></p>

<table>
  <thead>
    <tr>
      <th><strong>ç‰¹æ€§</strong></th>
      <th>**IndexRequest.Builder<object>**</object></th>
      <th>**IndexOperation.Builder<object>**</object></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>ç”¨é€”</strong></td>
      <td>ç”¨äºæ„å»ºå•ä¸ªç´¢å¼•è¯·æ±‚ã€‚</td>
      <td>ç”¨äºæ„å»ºæ‰¹é‡æ“ä½œä¸­çš„å•ä¸ªç´¢å¼•æ“ä½œã€‚</td>
    </tr>
    <tr>
      <td><strong>é€‚ç”¨èŒƒå›´</strong></td>
      <td>ç‹¬ç«‹çš„ <code class="language-plaintext highlighter-rouge">IndexRequest</code>ã€‚</td>
      <td>åµŒå¥—åœ¨ <code class="language-plaintext highlighter-rouge">BulkRequest</code> ä¸­ä½œä¸º <code class="language-plaintext highlighter-rouge">BulkOperation</code> çš„ä¸€éƒ¨åˆ†ã€‚</td>
    </tr>
    <tr>
      <td><strong>æ‰€å±ç±»</strong></td>
      <td><code class="language-plaintext highlighter-rouge">co.elastic.clients.elasticsearch.core.IndexRequest.Builder</code></td>
      <td><code class="language-plaintext highlighter-rouge">co.elastic.clients.elasticsearch.core.bulk.IndexOperation.Builder</code></td>
    </tr>
    <tr>
      <td><strong>ä¸æ‰¹é‡æ“ä½œçš„å…³è”</strong></td>
      <td>ä¸ç›´æ¥ç”¨äºæ‰¹é‡æ“ä½œã€‚</td>
      <td>ä¸“é—¨ç”¨äºæ‰¹é‡æ“ä½œ (<code class="language-plaintext highlighter-rouge">BulkRequest</code>) çš„å­æ“ä½œã€‚</td>
    </tr>
    <tr>
      <td><strong>é¢å¤–è®¾ç½®</strong></td>
      <td>æ”¯æŒ <code class="language-plaintext highlighter-rouge">refresh</code>, <code class="language-plaintext highlighter-rouge">routing</code> ç­‰è¯·æ±‚çº§åˆ«å‚æ•°è®¾ç½®ã€‚</td>
      <td>æ›´ç®€å•ï¼Œä¸“æ³¨äºæ‰¹é‡æ“ä½œä¸­å¿…è¦çš„å­—æ®µï¼ˆç´¢å¼•åã€æ–‡æ¡£ IDã€æ–‡æ¡£å†…å®¹ï¼‰ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<p><strong>å®ƒä»¬æ˜¯å¦å¯ä»¥æ›¿ä»£ï¼Ÿ</strong></p>
<ul>
  <li><strong>ä¸å¯ä»¥å®Œå…¨æ›¿ä»£</strong>ï¼š<code class="language-plaintext highlighter-rouge">IndexRequest.Builder&lt;Object&gt;</code> ä¸“æ³¨äºå•æ–‡æ¡£çš„ç‹¬ç«‹ç´¢å¼•æ“ä½œï¼Œè€Œ <code class="language-plaintext highlighter-rouge">IndexOperation.Builder&lt;Object&gt;</code> æ˜¯æ‰¹é‡è¯·æ±‚çš„ç»„ä»¶ä¹‹ä¸€ã€‚</li>
  <li><strong>å…±åŒç‚¹</strong>ï¼šä¸¤è€…éƒ½æä¾› <code class="language-plaintext highlighter-rouge">.index</code>ã€<code class="language-plaintext highlighter-rouge">.id</code> å’Œ <code class="language-plaintext highlighter-rouge">.document</code> æ–¹æ³•ç”¨äºå®šä¹‰æ–‡æ¡£çš„ç´¢å¼•è¡Œä¸ºã€‚</li>
</ul>

<hr />

<p><strong>ç»„åˆä½¿ç”¨ç¤ºä¾‹</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å•ä¸ªç´¢å¼•è¯·æ±‚</span>
<span class="nc">IndexRequest</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">singleIndexRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IndexRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;()</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-1"</span><span class="o">,</span> <span class="s">"City Bike"</span><span class="o">,</span> <span class="mf">123.0</span><span class="o">))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="c1">// æ‰¹é‡æ“ä½œä¸­çš„ç´¢å¼•è¯·æ±‚</span>
<span class="nc">BulkRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">bulkBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BulkRequest</span><span class="o">.</span><span class="na">Builder</span><span class="o">();</span>
<span class="n">bulkBuilder</span><span class="o">.</span><span class="na">operations</span><span class="o">(</span><span class="n">op</span> <span class="o">-&gt;</span> <span class="n">op</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">idx</span> <span class="o">-&gt;</span> <span class="n">idx</span>
    <span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="s">"products"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">id</span><span class="o">(</span><span class="s">"bk-2"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">document</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"bk-2"</span><span class="o">,</span> <span class="s">"Mountain Bike"</span><span class="o">,</span> <span class="mf">456.0</span><span class="o">))</span>
<span class="o">));</span>

<span class="nc">BulkResponse</span> <span class="n">bulkResponse</span> <span class="o">=</span> <span class="n">esClient</span><span class="o">.</span><span class="na">bulk</span><span class="o">(</span><span class="n">bulkBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</code></pre></div></div>

<h4 id="bulkresponse"><code class="language-plaintext highlighter-rouge">BulkResponse</code></h4>

<p><code class="language-plaintext highlighter-rouge">BulkResponse</code> æ˜¯ Elasticsearch Java API ä¸­ç”¨äºè¡¨ç¤ºæ‰¹é‡æ“ä½œç»“æœçš„ç±»ï¼ŒåŒ…å«äº†å…³äºæ‰¹é‡æ“ä½œæˆåŠŸä¸å¦çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¯ä¸ªæ“ä½œçš„çŠ¶æ€å’Œå¯èƒ½çš„é”™è¯¯ã€‚</p>

<p><strong>æ ¸å¿ƒå˜é‡</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">items</code></strong>ï¼š<strong>ç±»å‹</strong>: <code class="language-plaintext highlighter-rouge">List&lt;BulkResponseItem&gt;</code></p>

<ul>
  <li><strong>è¯´æ˜</strong>: åŒ…å«æ¯ä¸ªæ‰¹é‡æ“ä½œçš„ç»“æœåˆ—è¡¨ã€‚æ¯ä¸ªæ“ä½œå¯¹åº”ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">BulkResponseItem</code>ï¼Œå…¶ä¸­è¯¦ç»†è®°å½•äº†æ“ä½œç±»å‹ã€çŠ¶æ€ç ã€é”™è¯¯ä¿¡æ¯ç­‰ã€‚</li>
  <li><strong>ç”¨é€”</strong>:ç”¨äºé€é¡¹æ£€æŸ¥æ‰¹é‡æ“ä½œæ˜¯å¦æˆåŠŸã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">BulkResponseItem</span><span class="o">&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">items</span><span class="o">();</span>
 <span class="k">for</span> <span class="o">(</span><span class="nc">BulkResponseItem</span> <span class="n">item</span> <span class="o">:</span> <span class="n">items</span><span class="o">)</span> <span class="o">{</span>
     <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Operation: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">operation</span><span class="o">());</span>
     <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Status: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">status</span><span class="o">());</span>
 <span class="o">}</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">errors</code></strong>ï¼š<strong>ç±»å‹</strong>: <code class="language-plaintext highlighter-rouge">boolean</code></p>

<ul>
  <li><strong>è¯´æ˜</strong>: å¦‚æœ <code class="language-plaintext highlighter-rouge">true</code>ï¼Œåˆ™è¡¨æ˜æ‰¹é‡æ“ä½œä¸­è‡³å°‘æœ‰ä¸€ä¸ªè¯·æ±‚å¤±è´¥ã€‚</li>
  <li><strong>ç”¨é€”</strong>:ç”¨æ¥å¿«é€Ÿåˆ¤æ–­æ˜¯å¦éœ€è¦å¤„ç†é”™è¯¯ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">errors</span><span class="o">())</span> <span class="o">{</span>
     <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"There were errors in the bulk operation."</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">took</code></strong>ï¼š<strong>ç±»å‹</strong>: <code class="language-plaintext highlighter-rouge">long</code></p>

<ul>
  <li><strong>è¯´æ˜</strong>: æ‰¹é‡æ“ä½œè€—æ—¶ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚</li>
  <li><strong>ç”¨é€”</strong>:å¯ç”¨äºæ€§èƒ½åˆ†æå’Œè°ƒè¯•ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Bulk operation took: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">took</span><span class="o">()</span> <span class="o">+</span> <span class="s">" ms"</span><span class="o">);</span>
</code></pre></div></div>

<hr />

<p><strong>ä¸»è¦æ–¹æ³•</strong></p>

<p><strong><code class="language-plaintext highlighter-rouge">items()</code></strong>ï¼š<strong>è¿”å›ç±»å‹</strong>: <code class="language-plaintext highlighter-rouge">List&lt;BulkResponseItem&gt;</code></p>

<ul>
  <li><strong>ä½œç”¨</strong>:è·å–æ‰¹é‡æ“ä½œä¸­æ¯ä¸ªè¯·æ±‚çš„ç»“æœã€‚</li>
  <li><strong>å¸¸ç”¨åœºæ™¯</strong>:æ£€æŸ¥æ¯ä¸ªæ“ä½œæ˜¯å¦æˆåŠŸæˆ–å¤±è´¥ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">for</span> <span class="o">(</span><span class="nc">BulkResponseItem</span> <span class="n">item</span> <span class="o">:</span> <span class="n">response</span><span class="o">.</span><span class="na">items</span><span class="o">())</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">error</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">reason</span><span class="o">());</span>
     <span class="o">}</span>
 <span class="o">}</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">errors()</code></strong>ï¼š<strong>è¿”å›ç±»å‹</strong>: <code class="language-plaintext highlighter-rouge">boolean</code></p>

<ul>
  <li><strong>ä½œç”¨</strong>:æ£€æŸ¥æ‰¹é‡æ“ä½œä¸­æ˜¯å¦æœ‰é”™è¯¯ã€‚</li>
  <li><strong>å¸¸ç”¨åœºæ™¯</strong>:åœ¨æ—¥å¿—ä¸­è®°å½•é”™è¯¯ï¼Œæˆ–æ‰§è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">errors</span><span class="o">())</span> <span class="o">{</span>
     <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Some operations failed!"</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">took()</code></strong>ï¼š<strong>è¿”å›ç±»å‹</strong>: <code class="language-plaintext highlighter-rouge">long</code></p>

<ul>
  <li><strong>ä½œç”¨</strong>:è·å–æ•´ä¸ªæ‰¹é‡æ“ä½œçš„è€—æ—¶ã€‚</li>
  <li><strong>å¸¸ç”¨åœºæ™¯</strong>:ç”¨äºæ€§èƒ½ç›‘æ§ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Operation took: "</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">took</span><span class="o">()</span> <span class="o">+</span> <span class="s">" ms"</span><span class="o">);</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">toString()</code></strong>ï¼š<strong>è¿”å›ç±»å‹</strong>: <code class="language-plaintext highlighter-rouge">String</code></p>

<ul>
  <li><strong>ä½œç”¨</strong>:è·å– <code class="language-plaintext highlighter-rouge">BulkResponse</code> çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼ŒåŒ…å«å…³é”®ä¿¡æ¯ï¼ˆå¦‚é”™è¯¯å’Œæ—¶é—´ï¼‰ã€‚</li>
  <li><strong>å¸¸ç”¨åœºæ™¯</strong>:è°ƒè¯•æ—¶æŸ¥çœ‹å“åº”è¯¦æƒ…ã€‚</li>
  <li><strong>ç¤ºä¾‹</strong>:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</code></pre></div></div>

<hr />

<h4 id="bulkresponseitem"><code class="language-plaintext highlighter-rouge">BulkResponseItem</code></h4>

<p><code class="language-plaintext highlighter-rouge">BulkResponseItem</code> æ˜¯æ‰¹é‡æ“ä½œä¸­æ¯ä¸ªæ“ä½œçš„ç»“æœå¯¹è±¡ï¼ŒåŒ…å«äº†æ“ä½œçš„çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯ã€‚</p>

<p><strong>æ ¸å¿ƒå˜é‡</strong></p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">index</code></strong>:æ“ä½œç›®æ ‡çš„ç´¢å¼•åã€‚ç”¨äºæ ‡è¯†æ­¤æ¬¡æ“ä½œæ¶‰åŠçš„ç´¢å¼•ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">id</code></strong>:æ“ä½œç›®æ ‡æ–‡æ¡£çš„ IDã€‚ç¡®å®šæ–‡æ¡£çš„å”¯ä¸€æ ‡è¯†ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">status</code></strong>: è¿”å› HTTP çŠ¶æ€ç ï¼Œè¡¨ç¤ºè¯¥æ“ä½œçš„æ‰§è¡Œç»“æœã€‚ä¾‹å¦‚ï¼ŒçŠ¶æ€ç  <code class="language-plaintext highlighter-rouge">200</code> è¡¨ç¤ºæˆåŠŸã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">version</code></strong>:æ–‡æ¡£çš„ç‰ˆæœ¬å·ã€‚è·Ÿè¸ªæ–‡æ¡£çš„æ›´æ–°çŠ¶æ€ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">operation</code></strong>ï¼šè¡¨ç¤ºæ“ä½œç±»å‹ï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">index</code>ã€<code class="language-plaintext highlighter-rouge">create</code>ã€<code class="language-plaintext highlighter-rouge">update</code> æˆ– <code class="language-plaintext highlighter-rouge">delete</code>ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">error</code></strong> : é”™è¯¯ä¿¡æ¯ï¼Œç±»å‹ä¸º <code class="language-plaintext highlighter-rouge">ErrorCause</code>ï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯åˆ™ä¸º <code class="language-plaintext highlighter-rouge">null</code>ã€‚</li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">result</code></strong>ï¼šæ“ä½œç»“æœï¼Œè¡¨ç¤ºæ–‡æ¡£çš„æ“ä½œçŠ¶æ€ï¼Œå¸¸è§çš„å€¼åŒ…æ‹¬ï¼š</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">"created"</code>: æ–‡æ¡£è¢«æˆåŠŸåˆ›å»ºã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">"updated"</code>: æ–‡æ¡£è¢«æˆåŠŸæ›´æ–°ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">"deleted"</code>: æ–‡æ¡£è¢«æˆåŠŸåˆ é™¤</li>
      <li><code class="language-plaintext highlighter-rouge">"not_found"</code>: åœ¨æ‰§è¡Œæ“ä½œæ—¶ï¼Œæ–‡æ¡£ä¸å­˜åœ¨ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">"noop"</code>: æ²¡æœ‰æ“ä½œï¼ˆä¾‹å¦‚åœ¨æŸäº›æ¡ä»¶ä¸‹æ²¡æœ‰å¯¹æ–‡æ¡£è¿›è¡Œæ›´æ”¹ï¼‰ã€‚</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">shardInfo</code></strong>ï¼šç±»å‹**: <code class="language-plaintext highlighter-rouge">ShardStatistics</code>ï¼Œæä¾›æœ‰å…³åˆ†ç‰‡æ‰§è¡Œä¿¡æ¯çš„ç»Ÿè®¡ï¼Œä¾‹å¦‚æˆåŠŸã€å¤±è´¥ã€æ€»åˆ†ç‰‡æ•°ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">seqNo</code></strong>: <code class="language-plaintext highlighter-rouge">long</code>,è¡¨ç¤ºæ“ä½œå¯¹åº”çš„åºåˆ—å·ï¼ˆsequence numberï¼‰ã€‚ç”¨äºè·Ÿè¸ªæ“ä½œé¡ºåºã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">primaryTerm</code></strong>: <code class="language-plaintext highlighter-rouge">long</code>ã€‚ è¡¨ç¤ºæ“ä½œå‘ç”Ÿæ—¶çš„ä¸»åˆ†ç‰‡æœ¯è¯­ï¼ˆprimary termï¼‰ã€‚ä¸åºåˆ—å·ä¸€èµ·ç”¨äºå®ç°ä¹è§‚å¹¶å‘æ§åˆ¶ã€‚</li>
</ol>

<p><strong>æ–¹æ³•</strong></p>

<p>è¦è·å–è¿™äº›å€¼ï¼Œå¯ä»¥é€šè¿‡åŒåæ–¹æ³•è·å–ã€‚</p>

<p><strong>ç¤ºä¾‹</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="o">(</span><span class="nc">BulkResponseItem</span> <span class="n">item</span> <span class="o">:</span> <span class="n">response</span><span class="o">.</span><span class="na">items</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Index: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">index</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ID: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">id</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Status: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">status</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">error</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error: "</span> <span class="o">+</span> <span class="n">item</span><span class="o">.</span><span class="na">error</span><span class="o">().</span><span class="na">reason</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="å¤åˆ¶ç´¢å¼•">å¤åˆ¶ç´¢å¼•</h3>

<p>åœ¨å»ºç«‹æ–°ç´¢å¼•å‰ï¼Œå¯ä»¥æŒ‡å®šæ˜ å°„ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">put /ç´¢å¼•å</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"mappings"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"memberInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"phone"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"text"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">post /_reindex</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tb_member_portrait"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"dest"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tb_member_portrait2"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>å®Œæˆå¤åˆ¶</p>]]></content><author><name>acteds</name></author><category term="Java" /><category term="elasticsearch" /><summary type="html"><![CDATA[Javaç¬”è®°]]></summary></entry><entry><title type="html">form-dataä¼ è¾“</title><link href="/2024/12/04/form-data%E4%BC%A0%E8%BE%93/" rel="alternate" type="text/html" title="form-dataä¼ è¾“" /><published>2024-12-04T00:00:00+08:00</published><updated>2024-12-04T00:00:00+08:00</updated><id>/2024/12/04/form-data%E4%BC%A0%E8%BE%93</id><content type="html" xml:base="/2024/12/04/form-data%E4%BC%A0%E8%BE%93/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p><code class="language-plaintext highlighter-rouge">http</code>-<code class="language-plaintext highlighter-rouge">form-data</code>ï¼Œä¼ è¾“æ–¹å¼çš„ä¸€äº›è¯´æ˜ã€‚</p>

<h1 id="http">http</h1>

<h2 id="form-data">form-data</h2>

<h3 id="åŸºæœ¬æ¦‚å¿µ"><strong>åŸºæœ¬æ¦‚å¿µ</strong></h3>
<p><code class="language-plaintext highlighter-rouge">form-data</code> æ˜¯ä¸€ç§ç”¨äºé€šè¿‡ HTTP POST è¯·æ±‚ä¼ è¾“æ•°æ®çš„ç¼–ç æ–¹å¼ï¼Œé€šå¸¸ç”¨äºä¸Šä¼ æ–‡ä»¶å’Œå‘é€è¡¨å•æ•°æ®ã€‚å®ƒå…è®¸å°†æ•°æ®æŒ‰å­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œæ¯ä¸ªå­—æ®µå¯ä»¥åŒ…å«æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚æ–‡ä»¶ï¼‰ã€‚è¿™ç§ç¼–ç æ–¹å¼å°†è¡¨å•æ•°æ®æŒ‰é”®å€¼å¯¹å½¢å¼è¿›è¡Œä¼ è¾“ï¼Œæ¯ä¸ªå­—æ®µä¸å…¶ä»–å­—æ®µä¹‹é—´é€šè¿‡è¾¹ç•Œåˆ†éš”ã€‚</p>

<ul>
  <li><strong>è¡¨å•æ•°æ®ï¼ˆForm Dataï¼‰</strong>ï¼šå³åœ¨ HTML è¡¨å•ä¸­é€šè¿‡ <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> æ ‡ç­¾å’Œå…¶ä»–è¡¨å•å…ƒç´ ä¼ é€’çš„æ•°æ®ã€‚</li>
  <li><strong><code class="language-plaintext highlighter-rouge">multipart/form-data</code></strong>ï¼šæŒ‡å®šæ•°æ®é‡‡ç”¨å¤šéƒ¨åˆ†è¡¨å•æ•°æ®æ ¼å¼ï¼Œæ¯éƒ¨åˆ†å¯ä»¥æ˜¯æ–‡æœ¬å­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯æ–‡ä»¶ã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">form-data</code> ä¼ è¾“çš„ç»„æˆ</strong></p>

<ul>
  <li><strong>Content-Type</strong>: <code class="language-plaintext highlighter-rouge">multipart/form-data</code> è¿™æ„å‘³ç€è¯·æ±‚çš„æ•°æ®æ˜¯å¤šéƒ¨åˆ†çš„ï¼Œé€šå¸¸ç”¨äºæ–‡ä»¶ä¸Šä¼ ã€‚</li>
  <li><strong>è¾¹ç•Œï¼ˆboundaryï¼‰</strong>: è¿™æ˜¯ä¸€ç§åˆ†éš”ç¬¦ï¼Œç”¨äºæ ‡è¯†ä¸åŒçš„å­—æ®µå’Œæ•°æ®éƒ¨åˆ†ã€‚<code class="language-plaintext highlighter-rouge">boundary</code> æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé€šå¸¸ç”±æœåŠ¡å™¨è‡ªåŠ¨ç”Ÿæˆã€‚</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">form-data</code> ç¤ºä¾‹</strong></p>

<p><strong>è¡¨å•æ•°æ®ä¼ è¾“</strong></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/upload"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"file"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"user1"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Upload"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>å½“è¡¨å•æäº¤æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å°†æ•°æ®è½¬åŒ–ä¸º <code class="language-plaintext highlighter-rouge">multipart/form-data</code> æ ¼å¼å¹¶å‘é€ã€‚</p>

<p><strong>Request Headers</strong></p>

<p>è¯·æ±‚çš„å¤´éƒ¨åŒ…å«å¦‚ä¸‹ä¿¡æ¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /upload HTTP/1.1
Host: example.com
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Length: 1234
</code></pre></div></div>

<p><strong>Request Body (Body Body)</strong></p>

<p>è¡¨å•æ•°æ®çš„ä¸»ä½“éƒ¨åˆ†ä¼šå¦‚ä¸‹æ‰€ç¤ºè¿›è¡Œç¼–ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="username"

user1
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="file"; filename="example.txt"
Content-Type: text/plain

&lt;æ–‡ä»¶å†…å®¹&gt;
------WebKitFormBoundary7MA4YWxkTrZu0gW--
</code></pre></div></div>

<p>è¿™é‡Œæ¯ä¸€éƒ¨åˆ†çš„æ•°æ®ä½¿ç”¨è¾¹ç•Œå­—ç¬¦ä¸² <code class="language-plaintext highlighter-rouge">------WebKitFormBoundary7MA4YWxkTrZu0gW</code> åˆ†éš”ï¼Œæ–‡ä»¶å’Œæ–‡æœ¬å­—æ®µéƒ½å¯ä»¥åœ¨åŒä¸€ä¸ªè¯·æ±‚ä½“å†…ä¼ è¾“ã€‚</p>

<h3 id="é™åˆ¶">é™åˆ¶</h3>
<p><code class="language-plaintext highlighter-rouge">multipart/form-data</code> æ˜¯ä¸€ç§ç”¨äºé€šè¿‡ HTTP POST è¯·æ±‚ä¸Šä¼ æ–‡ä»¶å’Œæäº¤è¡¨å•æ•°æ®çš„ç¼–ç æ–¹å¼ã€‚å°½ç®¡å®ƒå¹¿æ³›ç”¨äºæ–‡ä»¶ä¸Šä¼ å’Œè¡¨å•æ•°æ®æäº¤ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ä¼šé‡åˆ°å¤§å°å’Œæ•°æ®ç±»å‹çš„é™åˆ¶ã€‚</p>

<p><strong>å¤§å°é™åˆ¶</strong>
<code class="language-plaintext highlighter-rouge">multipart/form-data</code> è¯·æ±‚çš„æœ€å¤§ä¼ è¾“å¤§å°é€šå¸¸å—ä»¥ä¸‹å› ç´ çš„é™åˆ¶ï¼š</p>

<p><strong>æœåŠ¡å™¨é…ç½®</strong>
<strong>Spring Boot (Tomcat é»˜è®¤)</strong>: Spring Boot ä½¿ç”¨çš„åµŒå…¥å¼ Tomcat æœåŠ¡å™¨æœ‰é»˜è®¤çš„æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶ã€‚é€šå¸¸æ˜¯ 2MBã€‚</p>

<p>å¯ä»¥åœ¨ <code class="language-plaintext highlighter-rouge">application.properties</code> æˆ– <code class="language-plaintext highlighter-rouge">application.yml</code> ä¸­ä¿®æ”¹è¯¥é…ç½®ï¼š</p>
<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.servlet.multipart.max-file-size</span><span class="p">=</span><span class="s">10MB   # é™åˆ¶å•ä¸ªæ–‡ä»¶çš„å¤§å°</span>
<span class="py">spring.servlet.multipart.max-request-size</span><span class="p">=</span><span class="s">20MB # é™åˆ¶æ•´ä¸ªè¯·æ±‚çš„å¤§å°</span>
</code></pre></div></div>

<p>å¯¹äº <code class="language-plaintext highlighter-rouge">application.yml</code>ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
<span class="na">servlet</span><span class="pi">:</span>
  <span class="na">multipart</span><span class="pi">:</span>
    <span class="na">max-file-size</span><span class="pi">:</span> <span class="s">10MB</span>
    <span class="na">max-request-size</span><span class="pi">:</span> <span class="s">20MB</span>
</code></pre></div></div>

<p><strong>NGINX / åå‘ä»£ç†é…ç½®</strong>
å¦‚æœä½ çš„åº”ç”¨é€šè¿‡ NGINX ä½œä¸ºåå‘ä»£ç†è®¿é—®ï¼Œè¿˜éœ€è¦é…ç½® NGINX çš„æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒNGINX å¯èƒ½é™åˆ¶æœ€å¤§ä¸Šä¼ æ–‡ä»¶å¤§å°ä¸º 1MBã€‚</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">client_max_body_size</span> <span class="mi">20M</span><span class="p">;</span>  <span class="c1"># è®¾ç½®æœ€å¤§è¯·æ±‚ä½“å¤§å°ä¸º 20MB</span>
</code></pre></div></div>

<p><strong>WebæœåŠ¡å™¨å’Œåº”ç”¨æœåŠ¡å™¨çš„å…¶ä»–é™åˆ¶</strong></p>
<ul>
  <li><strong>Apache</strong>ã€<strong>Tomcat</strong>ã€<strong>Jetty</strong> ç­‰æœåŠ¡å™¨ä¹Ÿæœ‰ç±»ä¼¼çš„ä¸Šä¼ å¤§å°é™åˆ¶ï¼Œé€šå¸¸å¯ä»¥é€šè¿‡ç›¸åº”çš„é…ç½®æ–‡ä»¶è°ƒæ•´ï¼š
    <ul>
      <li>Tomcat ä¸­ <code class="language-plaintext highlighter-rouge">server.xml</code> ä¸­çš„ <code class="language-plaintext highlighter-rouge">maxPostSize</code> è®¾ç½®ã€‚</li>
      <li>Apache ä¸­çš„ <code class="language-plaintext highlighter-rouge">LimitRequestBody</code> è®¾ç½®ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>æ•°æ®ç±»å‹é™åˆ¶</strong>
<code class="language-plaintext highlighter-rouge">multipart/form-data</code> æœ¬èº«ä¸é™åˆ¶æ•°æ®ç±»å‹ï¼Œç†è®ºä¸Šå¯ä»¥ä¼ é€’ä»»ä½•ç±»å‹çš„æ•°æ®ï¼ˆåŒ…æ‹¬æ–‡æœ¬ã€æ•°å­—ã€äºŒè¿›åˆ¶æ•°æ®ã€æ–‡ä»¶ç­‰ï¼‰ã€‚ä¸è¿‡ï¼ŒæŸäº›æ•°æ®ç±»å‹å¯èƒ½ä¼šé‡åˆ°å¤„ç†ä¸Šçš„é™åˆ¶ã€‚</p>

<p><strong>æ–‡æœ¬æ•°æ®</strong></p>
<ul>
  <li>è¡¨å•å­—æ®µé€šå¸¸ä»¥ <code class="language-plaintext highlighter-rouge">key-value</code> å½¢å¼ä¼ è¾“ï¼ˆå¦‚ï¼š<code class="language-plaintext highlighter-rouge">key=value</code>ï¼‰ã€‚Spring å’Œå…¶ä»–æ¡†æ¶ä¼šè‡ªåŠ¨è§£æè¡¨å•ä¸­çš„æ–‡æœ¬æ•°æ®ã€‚</li>
  <li>å¯¹äºé•¿æ–‡æœ¬æ•°æ®ï¼Œ<code class="language-plaintext highlighter-rouge">multipart/form-data</code> æ²¡æœ‰ç‰¹åˆ«çš„é™åˆ¶ï¼Œåªè¦ä¸è¶…è¿‡è¯·æ±‚å¤§å°çš„é™åˆ¶å³å¯ã€‚</li>
</ul>

<p><strong>æ–‡ä»¶æ•°æ®</strong></p>
<ul>
  <li>æ–‡ä»¶å†…å®¹é€šè¿‡ <code class="language-plaintext highlighter-rouge">Content-Type</code> å’Œ <code class="language-plaintext highlighter-rouge">Content-Disposition</code> å¤´ä¼ è¾“ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä¼šæœ‰æ–‡ä»¶åã€ç±»å‹ã€å¤§å°ç­‰å…ƒæ•°æ®ã€‚</li>
  <li><strong>æ–‡ä»¶å¤§å°</strong>ï¼šå¦‚å‰æ‰€è¿°ï¼Œä¸Šä¼ çš„æ–‡ä»¶å¤§å°ä¼šå—åˆ°æœåŠ¡å™¨é…ç½®çš„é™åˆ¶ã€‚</li>
  <li><strong>æ–‡ä»¶ç±»å‹</strong>ï¼šæ–‡ä»¶çš„ <code class="language-plaintext highlighter-rouge">Content-Type</code>ï¼ˆMIME ç±»å‹ï¼‰ç”±æµè§ˆå™¨è‡ªåŠ¨ç”Ÿæˆï¼Œä¹Ÿå¯ä»¥åœ¨å‰ç«¯æŒ‡å®šã€‚ä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">image/jpeg</code>ã€<code class="language-plaintext highlighter-rouge">application/pdf</code>ã€<code class="language-plaintext highlighter-rouge">text/plain</code> ç­‰ã€‚</li>
</ul>

<p><strong>å¤§æ–‡ä»¶ä¼ è¾“</strong></p>
<ul>
  <li>ä¸Šä¼ éå¸¸å¤§çš„æ–‡ä»¶æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">multipart/form-data</code> å¯èƒ½ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“æ–‡ä»¶å’Œå…¶ä»–è¡¨å•å­—æ®µä¸€èµ·ä¸Šä¼ æ—¶ï¼Œå¤„ç†å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ã€‚</li>
  <li>å¤§æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨åˆ†å—ä¸Šä¼ ï¼ˆæ¯”å¦‚ HTML5 çš„ <code class="language-plaintext highlighter-rouge">FileReader</code> API å’ŒæœåŠ¡å™¨ç«¯çš„åˆ†å—å¤„ç†ï¼‰ã€‚</li>
</ul>

<p><strong>ç¼–ç å’Œå­—ç¬¦é›†é™åˆ¶</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">multipart/form-data</code> é»˜è®¤ä½¿ç”¨ <strong><code class="language-plaintext highlighter-rouge">ISO-8859-1</code></strong> ç¼–ç æ–¹å¼ï¼Œå¯èƒ½ä¼šåœ¨å¤„ç†éæ‹‰ä¸å­—ç¬¦é›†ï¼ˆå¦‚ä¸­æ–‡ã€é˜¿æ‹‰ä¼¯æ–‡ç­‰ï¼‰æ—¶é‡åˆ°é—®é¢˜ã€‚ä¸ºäº†æ­£ç¡®å¤„ç†å­—ç¬¦é›†ï¼Œå¯ä»¥åœ¨ <code class="language-plaintext highlighter-rouge">Content-Type</code> ä¸­æ˜¾å¼æŒ‡å®šå­—ç¬¦é›†ï¼š</li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">Content-Type: multipart/form-data; charset=UTF-8; boundary=---boundary-string
</span></code></pre></div></div>

<ul>
  <li>ç„¶è€Œï¼Œ<code class="language-plaintext highlighter-rouge">multipart/form-data</code> æœ¬èº«å¹¶æ²¡æœ‰å¼ºåˆ¶è¦æ±‚å­—ç¬¦é›†è®¾ç½®ä¸º <code class="language-plaintext highlighter-rouge">UTF-8</code>ã€‚å¯¹äºè¡¨å•æ–‡æœ¬å­—æ®µçš„å†…å®¹ï¼Œæ¨èä½¿ç”¨ UTF-8 ç¼–ç æ¥é¿å…å­—ç¬¦é›†ä¸å…¼å®¹é—®é¢˜ã€‚</li>
</ul>

<p><strong>ç‰¹æ®Šå­—ç¬¦é—®é¢˜</strong>
åœ¨ä¸Šä¼ åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">&amp;</code>, <code class="language-plaintext highlighter-rouge">=</code>, <code class="language-plaintext highlighter-rouge">%</code>, <code class="language-plaintext highlighter-rouge">#</code> ç­‰ï¼‰æˆ–æ–‡ä»¶åä¸­åŒ…å«ç©ºæ ¼ã€ä¸­æ–‡å­—ç¬¦æ—¶ï¼Œéœ€è¦è¿›è¡Œ URL ç¼–ç æˆ– Base64 ç¼–ç ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚</p>

<p><strong>æµè§ˆå™¨å’Œå®¢æˆ·ç«¯é™åˆ¶</strong>
ä¸åŒæµè§ˆå™¨æˆ–å®¢æˆ·ç«¯å¯¹ <code class="language-plaintext highlighter-rouge">multipart/form-data</code> å¯èƒ½æœ‰ä¸åŒçš„æ”¯æŒå’Œé™åˆ¶ï¼š</p>
<ul>
  <li>æ–‡ä»¶å¤§å°é™åˆ¶ï¼šæµè§ˆå™¨é€šå¸¸ä¼šé™åˆ¶æ¯ä¸ªæ–‡ä»¶çš„æœ€å¤§ä¸Šä¼ å¤§å°ã€‚æµè§ˆå™¨å¯èƒ½ä¼šé˜»æ­¢è¶…è¿‡æŸä¸ªå¤§å°çš„æ–‡ä»¶ä¸Šä¼ ã€‚</li>
  <li>å•ä¸ªè¯·æ±‚ä¸­çš„å­—æ®µæ•°ï¼šè™½ç„¶æ²¡æœ‰ç¡¬æ€§è§„å®šï¼Œä½†å¤šæ•°æµè§ˆå™¨å’ŒæœåŠ¡å™¨å¯¹å•ä¸ªè¯·æ±‚ä¸­çš„å­—æ®µæ•°é‡æœ‰é™åˆ¶ã€‚</li>
</ul>

<h3 id="æ•°ç»„ç±»å‹å¤„ç†">æ•°ç»„ç±»å‹å¤„ç†</h3>

<p><code class="language-plaintext highlighter-rouge">multipart/form-data</code> æœ¬èº«å¹¶ä¸ç›´æ¥æ”¯æŒæ•°ç»„æˆ–åˆ—è¡¨ç±»å‹ï¼Œä½†å¯ä»¥é€šè¿‡ç‰¹å®šæ–¹å¼ä¼ é€’æ•°ç»„æˆ–åˆ—è¡¨æ•°æ®ã€‚å®é™…ä¸Šï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§å¸¸è§æ–¹æ³•æ¥æ¨¡æ‹Ÿæ•°ç»„æˆ–åˆ—è¡¨çš„ä¼ é€’ï¼š</p>

<p><strong>é€šè¿‡å¤šä¸ªåŒåå­—æ®µä¼ é€’æ•°ç»„æ•°æ®</strong></p>

<p>åœ¨ <code class="language-plaintext highlighter-rouge">multipart/form-data</code> è¯·æ±‚ä¸­ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨å¤šä¸ªå…·æœ‰<strong>ç›¸åŒåå­—</strong>çš„å­—æ®µæ¥ä¼ é€’æ•°ç»„æ•°æ®ã€‚Spring ä¼šè‡ªåŠ¨å°†è¿™äº›å­—æ®µæ˜ å°„åˆ° <code class="language-plaintext highlighter-rouge">String[]</code> æˆ– <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code> ç­‰é›†åˆç±»å‹ã€‚</p>

<p>åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼ŒSpring ä¼šè‡ªåŠ¨å°†æ¯ä¸ª <code class="language-plaintext highlighter-rouge">uniqueKey</code> å­—æ®µï¼ˆå¦‚ <code class="language-plaintext highlighter-rouge">uniqueKey=key1&amp;uniqueKey=key2&amp;uniqueKey=key3</code>ï¼‰è§£æä¸º <code class="language-plaintext highlighter-rouge">String[]</code> ç±»å‹ï¼Œå³ <code class="language-plaintext highlighter-rouge">["key1", "key2", "key3"]</code>ã€‚</p>

<p><strong>é€šè¿‡é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ä¼ é€’æ•°ç»„</strong></p>

<p>å¦‚æœä½ å¸Œæœ›å°†åˆ—è¡¨ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å­—æ®µä¼ é€’ï¼Œå¯ä»¥ä½¿ç”¨é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼Œå¹¶åœ¨åç«¯å°†å…¶è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">List</code> æˆ– <code class="language-plaintext highlighter-rouge">String[]</code>ã€‚</p>

<p>åœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">uniqueKey</code> å‚æ•°ä¼šä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ä¼ é€’ï¼ŒåŒ…å«é€—å·åˆ†éš”çš„å…ƒç´ ã€‚ä½ å¯ä»¥åœ¨åç«¯ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">split(",")</code> æ–¹æ³•å°†å…¶è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code> æˆ– <code class="language-plaintext highlighter-rouge">String[]</code>ã€‚</p>

<p><strong>ä½¿ç”¨ JSON æ ¼å¼ä¼ é€’æ•°ç»„</strong></p>

<p>å¦ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡ JSON æ ¼å¼ä¼ é€’æ•°ç»„ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œä½ å¯ä»¥å°†æ•´ä¸ªæ•°ç»„æˆ–å¤æ‚çš„å¯¹è±¡å°è£…ä¸º JSON å­—ç¬¦ä¸²ï¼Œå¹¶åœ¨åç«¯å°†å…¶è§£æä¸º Java å¯¹è±¡ã€‚è¿™ç§æ–¹æ³•é€šå¸¸ç”¨äºä¼ é€’æ›´å¤æ‚çš„æ•°æ®ç»“æ„ã€‚</p>

<p>åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œå‰ç«¯éœ€è¦ä¼ é€’ä¸€ä¸ªåˆæ³•çš„ JSON å­—ç¬¦ä¸²ï¼Œåç«¯ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">ObjectMapper</code> æ¥è§£æå®ƒä¸º <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code>ã€‚</p>

<p><strong>æ€»ç»“</strong></p>

<p>è™½ç„¶ <code class="language-plaintext highlighter-rouge">multipart/form-data</code> ä¸ç›´æ¥æ”¯æŒæ•°ç»„ç±»å‹ï¼Œä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥ä¼ é€’æ•°ç»„æ•°æ®ï¼š</p>

<ol>
  <li>
    <p><strong>å¤šä¸ªåŒåå­—æ®µ</strong>ï¼šé€šè¿‡åœ¨è¯·æ±‚ä¸­ä¼ é€’å¤šä¸ªå…·æœ‰ç›¸åŒåç§°çš„å­—æ®µï¼ˆä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">uniqueKey=key1&amp;uniqueKey=key2&amp;uniqueKey=key3</code>ï¼‰æ¥æ¨¡æ‹Ÿæ•°ç»„ï¼ŒSpring ä¼šè‡ªåŠ¨å°†å…¶æ˜ å°„ä¸º <code class="language-plaintext highlighter-rouge">String[]</code> æˆ– <code class="language-plaintext highlighter-rouge">List&lt;String&gt;</code>ã€‚</p>
  </li>
  <li>
    <p><strong>é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²</strong>ï¼šé€šè¿‡ä¼ é€’ä¸€ä¸ªé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">uniqueKey=key1,key2,key3</code>ï¼‰ï¼Œåœ¨åç«¯å°†å…¶æ‹†åˆ†ä¸ºæ•°ç»„æˆ–åˆ—è¡¨ã€‚</p>
  </li>
  <li>
    <p><strong>JSON æ ¼å¼</strong>ï¼šé€šè¿‡å°†æ•°ç»„å°è£…ä¸º JSON å­—ç¬¦ä¸²ä¼ é€’ï¼Œå¹¶åœ¨åç«¯è§£æä¸ºæ•°ç»„æˆ–åˆ—è¡¨ï¼ˆä¾‹å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">uniqueKey=["key1","key2","key3"]</code>ï¼‰ã€‚</p>
  </li>
</ol>]]></content><author><name>acteds</name></author><category term="Java" /><category term="http" /><summary type="html"><![CDATA[Javaç¬”è®°]]></summary></entry><entry><title type="html">å¹¶è¡Œæµçš„ç›¸å…³é—®é¢˜</title><link href="/2024/12/03/%E5%B9%B6%E8%A1%8C%E6%B5%81%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/" rel="alternate" type="text/html" title="å¹¶è¡Œæµçš„ç›¸å…³é—®é¢˜" /><published>2024-12-03T00:00:00+08:00</published><updated>2024-12-03T00:00:00+08:00</updated><id>/2024/12/03/%E5%B9%B6%E8%A1%8C%E6%B5%81%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98</id><content type="html" xml:base="/2024/12/03/%E5%B9%B6%E8%A1%8C%E6%B5%81%E7%9A%84%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/"><![CDATA[<h1 id="å¼•è¨€">å¼•è¨€</h1>

<p>å¹¶è¡Œæµçš„ç›¸å…³é—®é¢˜ï¼Œé¡ºåºé—®é¢˜ï¼Œä»¥åŠå¤šçº¿ç¨‹é—®é¢˜ã€‚</p>

<h1 id="java">Java</h1>

<h2 id="streamæµ">Streamæµ</h2>

<h3 id="å¹¶è¡Œæµ">å¹¶è¡Œæµ</h3>

<h4 id="é¡ºåº">é¡ºåº</h4>

<p>å¹¶è¡Œæµ (<code class="language-plaintext highlighter-rouge">parallelStream</code>) å¹¶ä¸ä¿è¯å…ƒç´ çš„é¡ºåºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code class="language-plaintext highlighter-rouge">parallelStream</code> ä¼šåˆ†å‰²ä»»åŠ¡å¹¶è®©å¤šä¸ªçº¿ç¨‹å¹¶è¡Œå¤„ç†æ•°æ®ï¼Œè¿™æ ·<strong>å¤„ç†é¡ºåº</strong>æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œå› æ­¤å®ƒæ— æ³•ä¿è¯ç»“æœçš„é¡ºåºã€‚</p>

<p><strong>ä¿è¯ç»“æœé¡ºåºï¼š</strong></p>

<p><strong>ä½¿ç”¨é¡ºåºæµ</strong>ï¼šå¦‚æœä½ ä¸ç‰¹åˆ«éœ€è¦å¹¶è¡Œå¤„ç†ï¼Œå¯ä»¥æ”¹ä¸ºä½¿ç”¨é¡ºåºæµï¼ˆå³ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">stream()</code> è€Œä¸æ˜¯ <code class="language-plaintext highlighter-rouge">parallelStream()</code>ï¼‰ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿é¡ºåºä¸å˜ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span> <span class="o">=</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(),</span> <span class="kc">false</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cell:</span><span class="o">:</span><span class="n">getStringCellValue</span><span class="o">)</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</code></pre></div></div>

<p><strong>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">collect</code> æ—¶å¼ºåˆ¶ä¿åº</strong>ï¼šå¦‚æœä½ åšæŒä½¿ç”¨å¹¶è¡Œæµï¼Œå¹¶ä¸”ä»ç„¶éœ€è¦ä¿æŒé¡ºåºï¼Œå¯ä»¥åœ¨æ”¶é›†ç»“æœæ—¶ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Collectors.toList()</code>ï¼Œå› ä¸ºå®ƒä¼š<strong>æŒ‰é¡ºåºå°†æµä¸­çš„å…ƒç´ æ”¶é›†åˆ°åˆ—è¡¨</strong>ä¸­ï¼Œå³ä½¿æ˜¯å¹¶è¡Œæµï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tableHeader</span> <span class="o">=</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(),</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Cell:</span><span class="o">:</span><span class="n">getStringCellValue</span><span class="o">)</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</code></pre></div></div>

<p>è¿˜å¯ä»¥æ˜¾ç¤ºçš„åœ¨æµçš„æœ«å°¾ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">sorted()</code> æˆ– <code class="language-plaintext highlighter-rouge">forEachOrdered()</code> æ¥å¼ºåˆ¶ä¿æŒé¡ºåºã€‚</p>

<hr />

<p>ä½†æ˜¯ï¼Œ<strong>å³ä½¿ä½ ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">Collectors.toList()</code></strong>ï¼Œå¹¶è¡Œæµçš„<strong>å†…éƒ¨æ‰§è¡Œé¡ºåº</strong>ä»ç„¶ä¸å¯é¢„æµ‹ï¼Œå³ï¼š</p>

<p>å¹¶è¡Œæµåœ¨æ‰§è¡Œæ—¶ä¸ä¼šä¿è¯æ“ä½œçš„é¡ºåºã€‚æµä¸­çš„æ“ä½œå¯èƒ½ä¼šè¢«å¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œè¿™æ ·å³ä½¿æ˜¯ <code class="language-plaintext highlighter-rouge">map</code> æˆ– <code class="language-plaintext highlighter-rouge">filter</code> è¿™äº›æŒ‰é¡ºåºæ‰§è¡Œçš„æ“ä½œï¼Œåœ¨å¹¶è¡Œæµä¸­ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ç»“æœçš„é¡ºåºå‘ç”Ÿæ”¹å˜ã€‚</p>

<p>ä¸ºä»€ä¹ˆå¹¶è¡Œæµä¸ <code class="language-plaintext highlighter-rouge">Collectors.toList()</code> ä¿æŒé¡ºåºï¼Ÿ</p>

<p>æµçš„åˆå¹¶æ–¹å¼ï¼š å½“ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">parallelStream</code> æ—¶ï¼Œæ•°æ®ä¼šè¢«åˆ†å‰²æˆå¤šä¸ªç‰‡æ®µï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚æ¯ä¸ªç‰‡æ®µä¸­çš„æ“ä½œæ˜¯é¡ºåºçš„ï¼Œä½†å®ƒä»¬ä¹‹é—´çš„åˆå¹¶é¡ºåºä¸ä¸€å®šä¿æŒä¸€è‡´ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Collectors.toList()</code> çš„è¡Œä¸ºï¼š</p>

<p><code class="language-plaintext highlighter-rouge">Collectors.toList()</code> æ˜¯ä¸€ä¸ª æ— çŠ¶æ€æ”¶é›†å™¨ï¼Œå®ƒåªæ˜¯å°†æµä¸­çš„å…ƒç´ æ”¶é›†åˆ°ä¸€ä¸ªæ–°çš„åˆ—è¡¨ä¸­ã€‚ç”±äº <code class="language-plaintext highlighter-rouge">List</code> æ˜¯æœ‰é¡ºåºçš„å®¹å™¨ï¼Œæ‰€ä»¥å®ƒä¼šä¿æŒæ”¶é›†çš„é¡ºåºï¼Œå³ä½¿æ˜¯å¹¶è¡Œæµã€‚å› ä¸ºåœ¨ <code class="language-plaintext highlighter-rouge">parallelStream()</code> çš„æƒ…å†µä¸‹ï¼Œæµä¼šåˆ†å‰²æˆå¤šä¸ªå­æµï¼Œå¹¶è¡Œå¤„ç†åæœ€ç»ˆåˆå¹¶ï¼Œè€Œåˆå¹¶æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">toList</code> ä¼šä¿æŒå„ä¸ªå­æµå¤„ç†åçš„é¡ºåºã€‚</p>

<h4 id="å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</h4>

<p>å¹¶è¡Œæµï¼ˆ<code class="language-plaintext highlighter-rouge">parallelStream</code>ï¼‰æ˜¯ Java 8 å¼•å…¥çš„åŠŸèƒ½ï¼Œå®ƒé€šè¿‡åˆ†å‰²æ•°æ®æºæ¥ä½¿ç”¨å¤šä¸ªçº¿ç¨‹å¹¶è¡Œåœ°å¤„ç†æ•°æ®ï¼Œä»è€Œæé«˜å¤„ç†é€Ÿåº¦ã€‚ä½†å¹¶è¡Œæµçš„å¤šçº¿ç¨‹ä½¿ç”¨ä¹Ÿå¸¦æ¥äº†ä¸€äº›æ½œåœ¨çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µä¸‹ï¼š</p>

<p><strong>çº¿ç¨‹å®‰å…¨é—®é¢˜</strong></p>

<p>å¹¶è¡Œæµä½¿ç”¨å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€æ•°æ®ï¼Œè¿™å¯èƒ½ä¼šå¼•å‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨æµçš„æ“ä½œä¸­ä¿®æ”¹å…±äº«çš„å¯å˜å¯¹è±¡ï¼Œæˆ–è€…åœ¨ <code class="language-plaintext highlighter-rouge">collect</code> æ“ä½œä¸­ä½¿ç”¨äº†éçº¿ç¨‹å®‰å…¨çš„é›†åˆï¼Œå°±å¯èƒ½ä¼šå‡ºç°å¹¶å‘ä¿®æ”¹çš„é—®é¢˜ã€‚</p>

<p>è§£å†³æ–¹æ¡ˆï¼š</p>

<ul>
  <li>å¯¹äºå…±äº«çš„èµ„æºï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚å¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">ConcurrentHashMap</code>ã€<code class="language-plaintext highlighter-rouge">CopyOnWriteArrayList</code> ç­‰çº¿ç¨‹å®‰å…¨çš„é›†åˆã€‚</li>
  <li>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">synchronized</code> æˆ– <code class="language-plaintext highlighter-rouge">ThreadLocal</code> æ¥ä¿è¯æ¯ä¸ªçº¿ç¨‹æ“ä½œè‡ªå·±çš„å‰¯æœ¬ã€‚</li>
  <li>é¿å…åœ¨æµä¸­ç›´æ¥ä¿®æ”¹å¤–éƒ¨å…±äº«çš„çŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯åœ¨ <code class="language-plaintext highlighter-rouge">forEach</code> æ“ä½œä¸­ã€‚</li>
</ul>

<p><strong>çŠ¶æ€ä¸ä¸€è‡´</strong></p>

<p>å¹¶è¡Œæµä¸­çš„ä¸€äº›æ“ä½œå¯èƒ½ä¼šå¯¼è‡´ä¸­é—´ç»“æœçš„ä¸ä¸€è‡´ã€‚ä¾‹å¦‚ï¼Œåœ¨å¹¶è¡Œæµçš„æŸä¸ªæ“ä½œä¸­ä¿®æ”¹äº†å…±äº«çŠ¶æ€ï¼Œå¯èƒ½ä¼šé€ æˆä¸­é—´çŠ¶æ€åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ä¸ä¸€è‡´ï¼Œæœ€ç»ˆå¯¼è‡´ç»“æœä¸æ­£ç¡®ã€‚</p>

<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
  <li>é¿å…ä¿®æ”¹æµä¸­çš„å…±äº«çŠ¶æ€ï¼Œå°¤å…¶æ˜¯ä¸å¯å˜å¯¹è±¡çš„çŠ¶æ€ã€‚</li>
  <li>ä½¿ç”¨ä¸å¯å˜å¯¹è±¡å’Œçº¿ç¨‹æœ¬åœ°æ•°æ®æ¥é¿å…çŠ¶æ€ä¸ä¸€è‡´ã€‚</li>
  <li>å¯¹äºéœ€è¦ä¿®æ”¹çŠ¶æ€çš„æ“ä½œï¼Œç¡®ä¿è¯¥æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚</li>
</ul>

<p><strong>çº¿ç¨‹æ± é¥±å’Œ</strong>
å¹¶è¡Œæµä¼šä½¿ç”¨å…¬å…±çš„ <code class="language-plaintext highlighter-rouge">ForkJoinPool</code> æ¥ç®¡ç†çº¿ç¨‹æ± ã€‚å¦‚æœå¹¶è¡Œæµçš„ä»»åŠ¡è¿‡å¤šï¼Œçº¿ç¨‹æ± å¯èƒ½ä¼šè€—å°½ï¼Œå¯¼è‡´çº¿ç¨‹é¥±å’Œï¼Œç”šè‡³é˜»å¡å…¶ä»–ä»»åŠ¡ã€‚</p>

<p>è§£å†³æ–¹æ¡ˆï¼š</p>

<ul>
  <li>å¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§ <code class="language-plaintext highlighter-rouge">java.util.concurrent.ForkJoinPool.common.parallelism</code> æ¥æ§åˆ¶ <code class="language-plaintext highlighter-rouge">ForkJoinPool</code> çš„çº¿ç¨‹æ± å¤§å°ï¼ˆé»˜è®¤ä¸º <code class="language-plaintext highlighter-rouge">availableProcessors</code>ï¼‰ã€‚</li>
  <li>å¯¹äºéå¸¸é‡çš„ä»»åŠ¡ï¼Œè€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼Œè€Œä¸æ˜¯ä¾èµ–é»˜è®¤çš„å…¬å…±çº¿ç¨‹æ± ã€‚</li>
</ul>

<p><strong>ç¤ºä¾‹ä»£ç ï¼šé¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜</strong></p>

<p>å‡è®¾ä½ åœ¨ä½¿ç”¨å¹¶è¡Œæµæ—¶ä¿®æ”¹äº†å…±äº«çš„ <code class="language-plaintext highlighter-rouge">List</code>ï¼Œè¿™å°†å¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">sharedList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>

<span class="c1">// é”™è¯¯çš„å¹¶è¡Œæµï¼šä¼šä¿®æ”¹å…±äº«èµ„æºï¼Œé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜</span>
<span class="n">data</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">sharedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  <span class="c1">// ä¸å®‰å…¨</span>

<span class="c1">// æ­£ç¡®çš„åšæ³•ï¼šä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆæˆ–é¿å…å…±äº«èµ„æº</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">safeList</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span>
<span class="n">data</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">safeList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  <span class="c1">// å®‰å…¨</span>
</code></pre></div></div>

<p>æˆ–è€…ï¼Œé¿å…åœ¨æµæ“ä½œä¸­ä¿®æ”¹å¤–éƒ¨çŠ¶æ€ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é”™è¯¯çš„åšæ³•ï¼šä¿®æ”¹å¤–éƒ¨å…±äº«çŠ¶æ€</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">externalList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">data</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">externalList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  <span class="c1">// å¯èƒ½ä¸å®‰å…¨</span>

<span class="c1">// æ­£ç¡®çš„åšæ³•ï¼šä½¿ç”¨å±€éƒ¨å˜é‡æˆ–è€…çº¿ç¨‹å±€éƒ¨å˜é‡</span>
<span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">localList</span> <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(</span><span class="nl">ArrayList:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>
<span class="n">data</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">localList</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>  <span class="c1">// å®‰å…¨</span>
</code></pre></div></div>

<p>å¹¶è¡Œæµåœ¨é€‚å½“çš„åœºæ™¯ä¸‹å¯ä»¥æ˜¾è‘—æå‡æ€§èƒ½ï¼Œä½†å¦‚æœä½¿ç”¨ä¸å½“ï¼Œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜æˆ–çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ä¸ºäº†å®‰å…¨é«˜æ•ˆåœ°ä½¿ç”¨å¹¶è¡Œæµï¼š</p>
<ul>
  <li>ç¡®ä¿æµä¸­çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
  <li>é¿å…å¹¶è¡ŒåŒ–ä¸é€‚åˆå¹¶è¡Œçš„ä»»åŠ¡ã€‚</li>
  <li>å¤„ç†æ•°æ®æ—¶ï¼Œç¡®ä¿æ“ä½œçš„é¡ºåºæ€§ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚</li>
  <li>ç•™æ„çº¿ç¨‹æ± èµ„æºé™åˆ¶å’Œå¹¶è¡Œåº¦çš„é…ç½®ã€‚</li>
</ul>

<p>ä½¿ç”¨å¹¶è¡Œæµæ—¶è¦æƒè¡¡å…¶å¸¦æ¥çš„å¥½å¤„ä¸æ½œåœ¨çš„å¤æ‚æ€§å’Œå¼€é”€ã€‚</p>

<h4 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</h4>

<p>å¦‚æœæ•°æ®é‡å°ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">parallelStream()</code> ä»ç„¶ä¼šå¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼€å¤šçº¿ç¨‹çš„å¼€é”€å¯èƒ½å¤§äºå¹¶è¡Œå¤„ç†å¸¦æ¥çš„æ€§èƒ½æå‡ã€‚<code class="language-plaintext highlighter-rouge">parallelStream()</code> å¹¶ä¸ä¼šè‡ªåŠ¨åˆ¤æ–­æ•°æ®é‡å¤§å°å¹¶å†³å®šæ˜¯å¦å¯ç”¨å¹¶è¡Œã€‚</p>

<p>è¯¦ç»†è§£é‡Šï¼š</p>

<ol>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">parallelStream()</code> çš„å·¥ä½œåŸç†</strong>ï¼š 
<code class="language-plaintext highlighter-rouge">parallelStream()</code> ä¼šå°†æ•°æ®åˆ†æˆå¤šä¸ªç‰‡æ®µï¼Œå¹¶åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­å¹¶è¡Œå¤„ç†è¿™äº›ç‰‡æ®µã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä½¿ç”¨äº† <strong><code class="language-plaintext highlighter-rouge">ForkJoinPool</code></strong> æ¥ç®¡ç†çº¿ç¨‹æ± ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šæ ¹æ® CPU æ ¸å¿ƒæ•°æ¥å†³å®šçº¿ç¨‹æ± çš„å¤§å°ã€‚</p>
  </li>
  <li>
    <p><strong>çº¿ç¨‹å¼€é”€</strong>ï¼š 
å¯¹äºè¾ƒå°çš„æ•°æ®é‡ï¼Œçº¿ç¨‹çš„åˆ›å»ºã€ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç®¡ç†ç­‰å¼€é”€å¯èƒ½è¶…è¿‡å¹¶è¡ŒåŒ–å¤„ç†æ‰€å¸¦æ¥çš„æ€§èƒ½æå‡ã€‚è¿™æ˜¯å› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€å®šçš„å¯åŠ¨æˆæœ¬ï¼Œè€Œå¦‚æœæ•°æ®é‡ä¸å¤Ÿå¤§ï¼Œå•çº¿ç¨‹çš„å¤„ç†å¯èƒ½å·²ç»è¶³å¤Ÿé«˜æ•ˆã€‚</p>
  </li>
  <li>
    <p><strong><code class="language-plaintext highlighter-rouge">parallelStream()</code> ä¼šå¼€çº¿ç¨‹</strong>ï¼š 
å³ä½¿æ•°æ®é‡å¾ˆå°ï¼Œè°ƒç”¨ <code class="language-plaintext highlighter-rouge">parallelStream()</code> ä¾ç„¶ä¼šå¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œå…·ä½“çº¿ç¨‹æ•°å–å†³äº <strong><code class="language-plaintext highlighter-rouge">ForkJoinPool.commonPool()</code></strong> çš„è®¾ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šæ ¹æ®æœºå™¨çš„ <strong>CPU æ ¸å¿ƒæ•°</strong> æ¥åˆ†é…çº¿ç¨‹æ•°ã€‚å¦‚æœä½ çš„ CPU æ ¸å¿ƒæ•°è¾ƒå¤šï¼Œ<code class="language-plaintext highlighter-rouge">parallelStream()</code> ä¼šä½¿ç”¨å¤šä¸ªçº¿ç¨‹æ¥å¤„ç†å³ä½¿æ˜¯å°çš„æ•°æ®é›†ã€‚</p>
  </li>
  <li>
    <p><strong>æ€§èƒ½è¯„ä¼°</strong>ï¼š</p>
    <ul>
      <li>å¯¹äºå°æ•°æ®é›†ï¼Œ<strong>é¡ºåºæµï¼ˆ<code class="language-plaintext highlighter-rouge">stream()</code>ï¼‰</strong> å¾€å¾€æ¯”å¹¶è¡Œæµæ›´é«˜æ•ˆï¼Œå› ä¸ºçº¿ç¨‹å¼€é”€ã€ä»»åŠ¡åˆ’åˆ†å’Œåˆå¹¶ç­‰éƒ½å¢åŠ äº†é¢å¤–çš„æˆæœ¬ã€‚</li>
      <li>å¦‚æœä½ æœ‰å¤§é‡çš„æ•°æ®å¹¶è¡Œå¤„ç†ï¼Œå¹¶ä¸”<strong>æ•°æ®é‡å¤§äºå¤„ç†å¼€é”€</strong>ï¼Œ<code class="language-plaintext highlighter-rouge">parallelStream()</code> çš„å¹¶è¡ŒåŒ–å¤„ç†å¯èƒ½ä¼šå¸¦æ¥æ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚</li>
    </ul>
  </li>
</ol>

<p>ç»“è®ºï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">parallelStream()</code> ä¸ä¼šè‡ªåŠ¨åˆ¤æ–­æ•°æ®é‡çš„å¤§å°ã€‚</li>
  <li>å³ä½¿æ•°æ®é‡å°ï¼Œ<code class="language-plaintext highlighter-rouge">parallelStream()</code> ä»ä¼šå¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œä½†è¿™å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li>
  <li>å¦‚æœæ•°æ®é‡è¾ƒå°ï¼Œæ¨èä½¿ç”¨é¡ºåºæµï¼ˆ<code class="language-plaintext highlighter-rouge">stream()</code>ï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…ä¸å¿…è¦çš„çº¿ç¨‹å¼€é”€ã€‚</li>
</ul>

<p>å¦‚æœä½ çš„æ•°æ®é‡è¾ƒå°ï¼Œå¯ä»¥é€šè¿‡å¯¹æ¯”æµ‹è¯•é¡ºåºæµå’Œå¹¶è¡Œæµçš„æ€§èƒ½ï¼Œæ¥å†³å®šæ˜¯å¦ä½¿ç”¨å¹¶è¡Œæµã€‚</p>

<hr />

<p>â€œ<strong>å¤§</strong>â€å’Œâ€œ<strong>å°</strong>â€æ•°æ®é‡æ˜¯ç›¸å¯¹çš„ï¼Œå…·ä½“å–å†³äºå¤šç§å› ç´ ï¼ŒåŒ…æ‹¬æ•°æ®çš„å¤æ‚æ€§ã€å¤„ç†ä»»åŠ¡çš„å¤æ‚åº¦ã€ç¡¬ä»¶ç¯å¢ƒã€å¹¶è¡ŒåŒ–çš„å¼€é”€ç­‰ã€‚æ²¡æœ‰ä¸€ä¸ªå›ºå®šçš„é˜ˆå€¼æ¥åˆ¤æ–­æ•°æ®é‡æ˜¯â€œå¤§â€è¿˜æ˜¯â€œå°â€ï¼Œä½†å¯ä»¥æ ¹æ®ä»¥ä¸‹å‡ ä¸ªç»´åº¦æ¥ç†è§£å’Œè¯„ä¼°ï¼š</p>

<p><strong>æ•°æ®é‡çš„ç»´åº¦</strong></p>
<ul>
  <li><strong>æ¡ç›®æ•°</strong>ï¼šæŒ‡çš„æ˜¯é›†åˆä¸­å…ƒç´ çš„æ•°é‡ã€‚æ¯”å¦‚ï¼Œ<code class="language-plaintext highlighter-rouge">List</code> ä¸­æœ‰ 1000 æ¡æ•°æ®ï¼Œæˆ–è€… 10,000 æ¡æ•°æ®ã€‚</li>
  <li><strong>å…ƒç´ å¤§å°</strong>ï¼šæ¯ä¸ªæ•°æ®é¡¹çš„å¤§å°ã€‚ä¾‹å¦‚ï¼Œæ¯ä¸ªæ•°æ®é¡¹å¯èƒ½æ˜¯ä¸€ä¸ªç®€å•çš„æ•´æ•°ï¼Œæˆ–è€…åŒ…å«å¤šä¸ªå­—æ®µå’Œå¤æ‚çš„æ•°æ®ç»“æ„ã€‚</li>
</ul>

<p><strong>ä¸€èˆ¬ç»éªŒ</strong>ï¼š</p>
<ul>
  <li>å°æ•°æ®é‡ï¼šé€šå¸¸ä¸º 1000 æ¡ä»¥ä¸‹çš„æ•°æ®ã€‚</li>
  <li>ä¸­ç­‰æ•°æ®é‡ï¼šå¤§çº¦ 1000 åˆ° 100,000 æ¡ã€‚</li>
  <li>å¤§æ•°æ®é‡ï¼šè¶…è¿‡ 100,000 æ¡æ•°æ®ï¼Œå°¤å…¶æ˜¯éœ€è¦åšå¤æ‚è®¡ç®—æ—¶ã€‚</li>
</ul>

<p><strong>æ“ä½œçš„å¤æ‚åº¦</strong></p>
<ul>
  <li><strong>ç®€å•æ“ä½œ</strong>ï¼šä¾‹å¦‚å¯¹ç®€å•æ•°æ®ç±»å‹ï¼ˆå¦‚æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰çš„æ±‚å’Œã€æŸ¥æ‰¾ç­‰æ“ä½œã€‚</li>
  <li>
    <p><strong>å¤æ‚æ“ä½œ</strong>ï¼šä¾‹å¦‚å¯¹æ¯ä¸ªæ•°æ®é¡¹è¿›è¡Œå¤æ‚çš„è®¡ç®—ã€æ¡ä»¶ç­›é€‰ã€åˆå¹¶ã€æ’åºã€åˆ†ç»„ç­‰æ“ä½œã€‚</p>
  </li>
  <li><strong>å°æ•°æ®é‡</strong> å’Œ <strong>ç®€å•æ“ä½œ</strong>ï¼šå¹¶è¡Œæµçš„å¼€é”€ä¸æ˜æ˜¾ï¼Œå¯èƒ½æ²¡æœ‰å¿…è¦ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">parallelStream()</code>ï¼Œä½¿ç”¨é¡ºåºæµæ›´ä¸ºé«˜æ•ˆã€‚</li>
  <li><strong>å°æ•°æ®é‡</strong> å’Œ <strong>å¤æ‚æ“ä½œ</strong>ï¼šå³ä½¿æ•°æ®é‡å°ï¼Œå¤æ‚çš„æ“ä½œå¯èƒ½ä½¿å¾—å¹¶è¡ŒåŒ–å¤„ç†å¸¦æ¥æ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚</li>
</ul>

<p><strong>ç¡¬ä»¶å’Œç¯å¢ƒçš„å½±å“</strong></p>
<ul>
  <li><strong>CPU æ ¸å¿ƒæ•°</strong>ï¼šè®¡ç®—æœºçš„æ ¸å¿ƒæ•°ç›´æ¥å½±å“å¹¶è¡Œæµçš„æ€§èƒ½ã€‚å¦‚æœåªæœ‰ 2 ä¸ªæ ¸å¿ƒï¼Œä½¿ç”¨ 4 ä¸ªçº¿ç¨‹çš„å¹¶è¡Œæµå¯èƒ½ä¸ä¼šå¸¦æ¥å¤ªå¤šçš„æ€§èƒ½æå‡ï¼Œç”šè‡³å¯èƒ½å› çº¿ç¨‹è°ƒåº¦å¼€é”€è€Œå½±å“æ€§èƒ½ã€‚å¦‚æœæœ‰ 16 æ ¸æˆ–æ›´å¤šçš„ CPUï¼Œæ•°æ®é‡æ›´å¤§æ—¶å¹¶è¡Œæµçš„æ•ˆæœä¼šæ›´åŠ æ˜æ˜¾ã€‚</li>
  <li><strong>å†…å­˜å’Œ I/O æ“ä½œ</strong>ï¼šå¦‚æœæ¶‰åŠåˆ° I/O æ“ä½œï¼ˆä¾‹å¦‚ä»æ•°æ®åº“è¯»å–å¤§é‡æ•°æ®æˆ–è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼‰ï¼Œé‚£ä¹ˆå¹¶è¡Œæµçš„å¥½å¤„å¯èƒ½ä¼šå—åˆ°ç³»ç»Ÿ I/O æ€§èƒ½çš„é™åˆ¶ã€‚å¦‚æœ CPU å¤„ç†æ—¶é—´æ˜¯ç“¶é¢ˆï¼Œé‚£ä¹ˆå¹¶è¡ŒåŒ–ä¼šå¸¦æ¥æ˜æ˜¾æå‡ã€‚</li>
</ul>

<p><strong>æ€§èƒ½è¯„ä¼°ï¼š</strong></p>
<ul>
  <li>å¯¹äº <strong>å°æ•°æ®é‡</strong> å’Œ <strong>ç®€å•æ“ä½œ</strong>ï¼Œä¾‹å¦‚å‡ ç™¾æ¡æ•°æ®çš„ç®€å•æ˜ å°„æˆ–è¿‡æ»¤ï¼Œé¡ºåºæµé€šå¸¸æ›´é«˜æ•ˆï¼Œå› ä¸ºåˆ›å»ºå’Œè°ƒåº¦çº¿ç¨‹çš„å¼€é”€å¯èƒ½è¶…è¿‡å¹¶è¡Œå¤„ç†çš„ä¼˜åŠ¿ã€‚</li>
  <li>å¯¹äº <strong>å¤§æ•°æ®é‡</strong> æˆ– <strong>å¤æ‚æ“ä½œ</strong>ï¼Œå¦‚éœ€è¦æ’åºã€å¤§é‡è®¡ç®—æˆ–é«˜å¤æ‚åº¦çš„æ˜ å°„ç­‰ï¼Œå¹¶è¡Œæµèƒ½å¤Ÿæœ‰æ•ˆåˆ©ç”¨å¤šæ ¸ CPU çš„å¹¶è¡Œå¤„ç†èƒ½åŠ›ï¼Œå‡å°‘å¤„ç†æ—¶é—´ã€‚</li>
</ul>

<p><strong>ç»éªŒæ³•åˆ™</strong></p>
<ul>
  <li><strong>å°æ•°æ®é‡</strong>ï¼šå‡ ç™¾åˆ°å‡ åƒæ¡æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨ <strong>é¡ºåºæµ</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">stream()</code>ï¼‰ã€‚</li>
  <li><strong>ä¸­ç­‰æ•°æ®é‡</strong>ï¼šå‡ åƒåˆ°åå‡ ä¸‡æ¡æ•°æ®ï¼Œä½¿ç”¨ <strong>é¡ºåºæµ</strong> å’Œ <strong>å¹¶è¡Œæµ</strong> æ€§èƒ½ç›¸è¿‘ï¼Œå¯ä»¥æ ¹æ®å®é™…æµ‹è¯•å†³å®šã€‚</li>
  <li><strong>å¤§æ•°æ®é‡</strong>ï¼šè¶…è¿‡åä¸‡æ¡æ•°æ®ï¼Œç‰¹åˆ«æ˜¯å½“æ•°æ®é‡è¿œå¤§äº CPU æ ¸å¿ƒæ•°æ—¶ï¼Œä½¿ç”¨ <strong>å¹¶è¡Œæµ</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">parallelStream()</code>ï¼‰é€šå¸¸èƒ½è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</li>
</ul>

<p><strong>å…·ä½“å»ºè®®ï¼š</strong></p>
<ul>
  <li><strong>å®éªŒ</strong>ï¼šå¯ä»¥è¿›è¡Œç®€å•çš„æ€§èƒ½æµ‹è¯•ï¼Œå¯¹æ¯” <strong>é¡ºåºæµ</strong> å’Œ <strong>å¹¶è¡Œæµ</strong> çš„æ‰§è¡Œæ—¶é—´ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½ çš„æ•°æ®é›†å’Œç¡¬ä»¶ç¯å¢ƒä¸‹ã€‚å¯¹äºå°æ•°æ®é‡ï¼Œé€šå¸¸å¯ä»¥é¿å…ä½¿ç”¨å¹¶è¡Œæµã€‚</li>
  <li><strong>ç›‘æ§å’Œè°ƒä¼˜</strong>ï¼šåœ¨å®é™…åº”ç”¨ä¸­ï¼Œç›‘æ§å¤„ç†è¿‡ç¨‹ä¸­çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¦‚ CPUã€å†…å­˜ç­‰ï¼Œå¹¶æ ¹æ®éœ€è¦è°ƒæ•´ã€‚</li>
</ul>

<p>æ€»ç»“ï¼š</p>
<ul>
  <li><strong>å°æ•°æ®é‡</strong>ï¼šé€šå¸¸æŒ‡å‡ ç™¾åˆ°å‡ åƒæ¡æ•°æ®ï¼Œé¡ºåºæµæ›´é«˜æ•ˆã€‚</li>
  <li><strong>å¤§æ•°æ®é‡</strong>ï¼šé€šå¸¸æŒ‡è¶…è¿‡åä¸‡æ¡æ•°æ®ï¼Œå¹¶ä¸”éœ€è¦è¿›è¡Œè®¡ç®—ã€æ’åºç­‰æ“ä½œæ—¶ï¼Œä½¿ç”¨å¹¶è¡Œæµèƒ½å¸¦æ¥æ˜¾è‘—æ€§èƒ½æå‡ã€‚</li>
  <li>æ•°æ®é‡â€œå¤šâ€è¿˜æ˜¯â€œå°‘â€æ²¡æœ‰ä¸¥æ ¼æ ‡å‡†ï¼Œä¸»è¦æ˜¯çœ‹æ“ä½œçš„å¤æ‚æ€§å’Œç³»ç»Ÿçš„ç¡¬ä»¶èµ„æºã€‚åœ¨å¤„ç†å°æ•°æ®é‡æ—¶ï¼Œé¿å…ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">parallelStream()</code> ä¼šæ›´é«˜æ•ˆã€‚</li>
</ul>]]></content><author><name>acteds</name></author><category term="Java" /><summary type="html"><![CDATA[Javaç¬”è®°]]></summary></entry></feed>