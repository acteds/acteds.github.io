<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>MongoDB &mdash; 个人博客</title><link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="/assets/css/components/collection.css"><link rel="stylesheet" href="/assets/css/components/repo-card.css"><link rel="stylesheet" href="/assets/css/sections/repo-list.css"><link rel="stylesheet" href="/assets/css/components/boxed-group.css"><link rel="stylesheet" href="/assets/css/globals/common.css"><link rel="stylesheet" href="/assets/css/globals/responsive.css"><link rel="stylesheet" href="/assets/css/posts/index.css"><link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/highlight/monokai.sublime.css"><link rel="canonical" href="/2024/09/23/MongoDB/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="/feed.xml"><link rel="shortcut icon" href="/favicon.ico"><meta property="og:title" content="MongoDB"><meta name="keywords" content="Java"><meta name="og:keywords" content="Java"><meta name="description" content="引言"><meta name="og:description" content="引言"><meta property="og:url" content="/2024/09/23/MongoDB/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2024-09-23"> <script src="/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="/assets/js/jquery-ui.js"></script> <script src="/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="MongoDB"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">MongoDB</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2024/09/23 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#Java" title="Java">Java</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 59402 字，约 170 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="引言">引言</h1><p>MongoDB是一个非关系型数据库。</p><h1 id="mongodb">MongoDB</h1><h2 id="快速启动">快速启动</h2><p>在spring boot中使用，需要引入依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-mongodb<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">application.yml</code>：</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">data</span><span class="pi">:</span>
    <span class="na">mongodb</span><span class="pi">:</span>
      <span class="na">uri</span><span class="pi">:</span> <span class="s">${MONGODB_URI:mongodb://账号:密码@10.80.21.115:29018,10.80.21.116:29018/db_schema?authSource=admin}</span>

  <span class="na">jackson</span><span class="pi">:</span>
    <span class="na">serialization</span><span class="pi">:</span>
      <span class="na">FAIL_ON_EMPTY_BEANS</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">write-dates-as-timestamps</span><span class="pi">:</span> <span class="no">false</span> <span class="c1">#使用时间戳，使用数值timestamp表示日期</span>
      <span class="na">indent_output</span><span class="pi">:</span> <span class="no">true</span> <span class="c1">#格式化输出</span>
    <span class="na">date-format</span><span class="pi">:</span> <span class="s">yyyy-MM-dd HH:mm:ss</span>
    <span class="na">time-zone</span><span class="pi">:</span> <span class="s">GMT+8</span>
</code></pre></div></div><p>Spring Boot 默认会自动配置 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 和 <code class="language-plaintext highlighter-rouge">MongoClient</code>，但如果需要自定义配置（例如不同的 <code class="language-plaintext highlighter-rouge">MongoClientOptions</code>），可以手动定义 <code class="language-plaintext highlighter-rouge">MongoClient</code> 和 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 的 Bean。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.mongodb.client.MongoClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.mongodb.client.MongoClients</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.MongoTemplate</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MongoConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MongoClient</span> <span class="nf">mongoClient</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">MongoClients</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"mongodb://admin:admin123@localhost:27017/mydatabase"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">MongoTemplate</span> <span class="nf">mongoTemplate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MongoTemplate</span><span class="o">(</span><span class="n">mongoClient</span><span class="o">(),</span> <span class="s">"mydatabase"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>创建 MongoDB 数据模型和 Repository</strong></p><p>在 Spring Data MongoDB 中，每个 MongoDB 集合都对应一个 Java 类，通常使用 <code class="language-plaintext highlighter-rouge">@Document</code> 注解来标注。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="o">;</span>

<span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">"users"</span><span class="o">)</span> <span class="c1">// 对应 MongoDB 中的 users 集合</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="c1">// Getters and Setters</span>
<span class="o">}</span>
</code></pre></div></div><p>可以注入 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 来执行自定义查询：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.MongoTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MongoTemplate</span> <span class="n">mongoTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">findUserById</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>也可以使用 <code class="language-plaintext highlighter-rouge">MongoRepository</code> 来直接进行数据库操作：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUserByName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h2 id="mongotemplate"><code class="language-plaintext highlighter-rouge">MongoTemplate</code></h2><p><code class="language-plaintext highlighter-rouge">MongoTemplate</code> 是 Spring Data MongoDB 中用于执行 MongoDB 操作的核心类，它提供了丰富的 CRUD（创建、读取、更新、删除）和其他 MongoDB 操作的 API。以下是一些常用的 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 方法分类及其用途：</p><p><strong>插入操作 (Insert)</strong></p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; T insert(T objectToSave)</code>：插入单个对象到默认集合。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; T insert(T objectToSave, String collectionName)</code>：插入单个对象到指定的集合。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; Collection&lt;T&gt; insertAll(Collection&lt;? extends Object&gt; batchToSave)</code>：插入多个对象到它们各自的集合。</p><p><strong>作用</strong>：用于将一个或多个对象插入到 MongoDB 中的集合里。</p><p><strong>返回值</strong>：返回插入的对象，带有 MongoDB 分配的 <code class="language-plaintext highlighter-rouge">_id</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建一个新的 Product 对象并插入到默认的集合</span>
<span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"Laptop"</span><span class="o">,</span> <span class="mi">1200</span><span class="o">);</span>
<span class="nc">Product</span> <span class="n">savedProduct</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>

<span class="c1">// 创建一个新的 Product 对象并插入到指定集合 "electronics"</span>
<span class="nc">Product</span> <span class="n">savedProductInElectronics</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">product</span><span class="o">,</span> <span class="s">"electronics"</span><span class="o">);</span>

<span class="c1">// 插入多个 Product 对象</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">Product</span><span class="o">(</span><span class="s">"Mouse"</span><span class="o">,</span> <span class="mi">50</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">Product</span><span class="o">(</span><span class="s">"Keyboard"</span><span class="o">,</span> <span class="mi">100</span><span class="o">)</span>
<span class="o">);</span>
<span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">savedProducts</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">insertAll</span><span class="o">(</span><span class="n">products</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">savedProduct</code></strong> 和 <strong><code class="language-plaintext highlighter-rouge">savedProducts</code></strong> 包含了插入后自动生成的 MongoDB <code class="language-plaintext highlighter-rouge">_id</code> 字段，可以用这个 <code class="language-plaintext highlighter-rouge">_id</code> 作为后续的查询条件。</p><p><code class="language-plaintext highlighter-rouge">insertAll</code>会根据插入对象的类型，自动将数据插入到相应的集合。</p><p><strong>查询操作 (Find)</strong></p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; List&lt;T&gt; find(Query query, Class&lt;T&gt; entityClass)</code>：根据查询条件查找符合条件的所有记录。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; List&lt;T&gt; find(Query query, Class&lt;T&gt; entityClass, String collectionName)</code>：根据查询条件从指定集合中查找符合条件的所有记录。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; T findOne(Query query, Class&lt;T&gt; entityClass)</code>：根据查询条件查找符合条件的单条记录。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; T findById(Object id, Class&lt;T&gt; entityClass)</code>：根据 ID 查找对象。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; T findById(Object id, Class&lt;T&gt; entityClass, String collectionName)</code>：根据 ID 从指定集合中查找对象。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; List&lt;T&gt; findAll(Class&lt;T&gt; entityClass)</code>：查询所有记录。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; List&lt;T&gt; findAll(Class&lt;T&gt; entityClass, String collectionName)</code>：从指定集合中查询所有记录。</p><p><code class="language-plaintext highlighter-rouge">&lt;T&gt; List&lt;T&gt; findDistinct(Query query, String field, Class&lt;T&gt; entityClass, Class&lt;D&gt; resultClass)</code>：获取某个字段的去重值。</p><p><strong>作用</strong>：用于从 MongoDB 中查询数据，可以根据不同的条件来查询多个或单个记录。</p><p><strong>返回值</strong>：返回符合查询条件的对象或对象列表。<code class="language-plaintext highlighter-rouge">findOne</code> 和 <code class="language-plaintext highlighter-rouge">findById</code> 返回单个对象，<code class="language-plaintext highlighter-rouge">find</code> 返回多个对象。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 查找所有 Product 对象</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 根据查询条件查找 price 大于 100 的所有记录</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">100</span><span class="o">));</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">expensiveProducts</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 根据 ID 查找某个 Product 对象</span>
<span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"12345"</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 获取 category 字段的去重值（所有不同的商品分类）</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">distinctCategories</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findDistinct</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(),</span> <span class="s">"category"</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">find</code></strong>：返回匹配的多个记录。<code class="language-plaintext highlighter-rouge">List&lt;Product&gt;</code> 是包含符合条件的所有产品。</p><p><strong><code class="language-plaintext highlighter-rouge">findOne</code></strong>：只返回第一个符合条件的记录。</p><p><strong><code class="language-plaintext highlighter-rouge">findDistinct</code></strong>：可以用于获取某个字段的唯一值，例如不同的商品分类。</p><p><strong>计数操作 (Count)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">long count(Query query, Class&lt;T&gt; entityClass)</code>：根据查询条件统计记录数。</li><li><code class="language-plaintext highlighter-rouge">long count(Query query, String collectionName)</code>：根据查询条件统计指定集合中的记录数。</li></ul><p><strong>作用</strong>：计算 MongoDB 集合中符合查询条件的记录数。</p><p><strong>返回值</strong>：返回符合条件的记录总数。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 计算价格低于 1000 的商品数量</span>
<span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="mi">1000</span><span class="o">)),</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">count</code></strong> 用于统计符合条件的记录数量，在查询数据量或进行分页时非常有用。</p><p><strong>更新操作 (Update)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">UpdateResult updateFirst(Query query, Update update, Class&lt;T&gt; entityClass)</code>：根据查询条件更新符合条件的第一条记录。</li><li><code class="language-plaintext highlighter-rouge">UpdateResult updateFirst(Query query, Update update, String collectionName)</code>：根据查询条件更新指定集合中符合条件的第一条记录。</li><li><code class="language-plaintext highlighter-rouge">UpdateResult updateMulti(Query query, Update update, Class&lt;T&gt; entityClass)</code>：根据查询条件更新符合条件的多条记录。</li><li><code class="language-plaintext highlighter-rouge">UpdateResult updateMulti(Query query, Update update, String collectionName)</code>：根据查询条件更新指定集合中符合条件的多条记录。</li><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; T findAndModify(Query query, Update update, Class&lt;T&gt; entityClass)</code>：查找并更新符合条件的单条记录，并返回更新前的记录。</li></ul><p><strong>作用</strong>：更新 MongoDB 集合中的数据，可以更新单个记录或多个记录。</p><p><strong>返回值</strong>：<code class="language-plaintext highlighter-rouge">UpdateResult</code> 包含了更新操作的结果，包括受影响的记录数。<code class="language-plaintext highlighter-rouge">findAndModify</code> 返回更新前的记录或更新后的记录，具体取决于配置。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 更新符合条件的第一条记录，将价格设置为 1100</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"Laptop"</span><span class="o">));</span>
<span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">1100</span><span class="o">);</span>
<span class="nc">UpdateResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">updateFirst</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">update</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 更新所有价格为 100 以下的商品，将价格增加 10</span>
<span class="nc">Update</span> <span class="n">multiUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">().</span><span class="na">inc</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
<span class="nc">UpdateResult</span> <span class="n">multiResult</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">updateMulti</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="mi">100</span><span class="o">)),</span> <span class="n">multiUpdate</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 查找并更新符合条件的记录，返回更新前的记录</span>
<span class="nc">Product</span> <span class="n">oldProduct</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findAndModify</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">update</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">updateFirst</code></strong>：只更新符合条件的第一条记录。</p><p><strong><code class="language-plaintext highlighter-rouge">updateMulti</code></strong>：更新所有符合条件的记录。</p><p><strong><code class="language-plaintext highlighter-rouge">findAndModify</code></strong>：可以用于实现原子性操作，比如修改某个字段并返回更新前的对象或更新后的对象。</p><p><strong>删除操作 (Delete)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">DeleteResult remove(Query query, Class&lt;T&gt; entityClass)</code>：根据查询条件删除符合条件的记录。</li><li><code class="language-plaintext highlighter-rouge">DeleteResult remove(Query query, Class&lt;T&gt; entityClass, String collectionName)</code>：根据查询条件删除指定集合中符合条件的记录。</li><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; T findAndRemove(Query query, Class&lt;T&gt; entityClass)</code>：查找并删除符合条件的单条记录。</li></ul><p><strong>作用</strong>：删除 MongoDB 集合中的记录，可以删除单条或多条记录。</p><p><strong>返回值</strong>：<code class="language-plaintext highlighter-rouge">DeleteResult</code> 表示删除操作的结果，包含删除的记录数。<code class="language-plaintext highlighter-rouge">findAndRemove</code> 返回被删除的对象。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 删除所有 name 为 "Laptop" 的记录</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"Laptop"</span><span class="o">));</span>
<span class="nc">DeleteResult</span> <span class="n">deleteResult</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 查找并删除符合条件的第一条记录</span>
<span class="nc">Product</span> <span class="n">deletedProduct</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findAndRemove</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">remove</code></strong>：删除操作后，<code class="language-plaintext highlighter-rouge">DeleteResult</code> 包含受影响的记录数。</p><p><strong><code class="language-plaintext highlighter-rouge">findAndRemove</code></strong>：查找并删除符合条件的第一条记录，并返回删除的对象。</p><p><strong>保存操作 (Save)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; T save(Object objectToSave)</code>：保存对象到默认集合，如果存在 <code class="language-plaintext highlighter-rouge">_id</code> 则更新，否则插入。</li><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; T save(Object objectToSave, String collectionName)</code>：保存对象到指定集合。</li></ul><p><strong>作用</strong>：保存对象到 MongoDB 中，如果对象已经存在（根据 <code class="language-plaintext highlighter-rouge">_id</code> 字段判断），则更新对象；否则，插入新对象。</p><p><strong>返回值</strong>：返回保存后的对象。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 保存新的 Product 对象</span>
<span class="nc">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"Monitor"</span><span class="o">,</span> <span class="mi">300</span><span class="o">);</span>
<span class="nc">Product</span> <span class="n">savedProduct</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>

<span class="c1">// 如果 _id 已存在则更新，否则插入</span>
<span class="n">mongoTemplate</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">product</span><span class="o">,</span> <span class="s">"electronics"</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">save</code></strong>：用于插入或更新记录，适用于不确定对象是否已经存在的场景。</p><p><strong>聚合操作 (Aggregation)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; AggregationResults&lt;T&gt; aggregate(Aggregation aggregation, String collectionName, Class&lt;T&gt; outputType)</code>：执行聚合操作，并将结果映射为指定的类。</li><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; AggregationResults&lt;T&gt; aggregate(Aggregation aggregation, Class&lt;T&gt; inputType, Class&lt;O&gt; outputType)</code>：对指定类型的集合进行聚合操作。</li></ul><p><strong>作用</strong>：用于执行 MongoDB 的聚合操作，比如分组、求和、计算平均值等，类似于 SQL 中的 <code class="language-plaintext highlighter-rouge">GROUP BY</code>、<code class="language-plaintext highlighter-rouge">SUM()</code>、<code class="language-plaintext highlighter-rouge">AVG()</code> 等功能。</p><p><strong>返回值</strong>：<code class="language-plaintext highlighter-rouge">AggregationResults&lt;T&gt;</code>，其中包含聚合查询的结果列表。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 计算每个类别的平均价格</span>
<span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span>
    <span class="nc">Aggregation</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="s">"category"</span><span class="o">).</span><span class="na">avg</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"avgPrice"</span><span class="o">)</span>
<span class="o">);</span>

<span class="nc">AggregationResults</span><span class="o">&lt;</span><span class="nc">CategoryAveragePrice</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">aggregation</span><span class="o">,</span> <span class="s">"products"</span><span class="o">,</span> <span class="nc">CategoryAveragePrice</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">CategoryAveragePrice</span> <span class="n">cap</span> <span class="o">:</span> <span class="n">result</span><span class="o">.</span><span class="na">getMappedResults</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cap</span><span class="o">.</span><span class="na">getCategory</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">cap</span><span class="o">.</span><span class="na">getAvgPrice</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Aggregation</code></strong>：适合用于复杂的数据处理任务，如计算统计值、分组数据等。返回值会根据映射类型转换为 <code class="language-plaintext highlighter-rouge">CategoryAveragePrice</code> 类。</p><p><strong>索引操作 (Index)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">void ensureIndex(String collectionName, IndexDefinition indexDefinition)</code>：为指定集合创建索引。</li><li><code class="language-plaintext highlighter-rouge">IndexOperations indexOps(String collectionName)</code>：返回索引操作类，用于进一步的索引操作。</li></ul><p><strong>作用</strong>：用于管理 MongoDB 集合中的索引，类似于 SQL 中的 <code class="language-plaintext highlighter-rouge">CREATE INDEX</code>。</p><p><strong>返回值</strong>：<code class="language-plaintext highlighter-rouge">IndexOperations</code> 对象用于进一步操作索引。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 为 Product 集合的 price 字段创建索引</span>
<span class="nc">IndexDefinition</span> <span class="n">priceIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Index</span><span class="o">().</span><span class="na">on</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">);</span>
<span class="n">mongoTemplate</span><span class="o">.</span><span class="na">indexOps</span><span class="o">(</span><span class="s">"products"</span><span class="o">).</span><span class="na">ensureIndex</span><span class="o">(</span><span class="n">priceIndex</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">ensureIndex</code></strong>：为指定字段创建索引，可以加快查询速度，特别是当集合中数据量很大时。</p><p><strong><code class="language-plaintext highlighter-rouge">indexOps</code></strong>：用于获取集合的索引操作，提供更多对索引的操作接口。</p><p><strong>集合操作 (Collection Operations)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">MongoCollection&lt;Document&gt; createCollection(String collectionName)</code>：创建集合。</li><li><code class="language-plaintext highlighter-rouge">MongoCollection&lt;Document&gt; createCollection(String collectionName, CollectionOptions collectionOptions)</code>：根据选项创建集合。</li><li><code class="language-plaintext highlighter-rouge">void dropCollection(String collectionName)</code>：删除指定集合。</li><li><code class="language-plaintext highlighter-rouge">boolean collectionExists(String collectionName)</code>：检查集合是否存在。</li></ul><p><strong>作用</strong>：用于创建、删除集合和检查集合是否存在。</p><p><strong>返回值</strong>：<code class="language-plaintext highlighter-rouge">createCollection</code> 和 <code class="language-plaintext highlighter-rouge">dropCollection</code> 没有返回值，<code class="language-plaintext highlighter-rouge">collectionExists</code> 返回布尔值表示集合是否存在。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建一个新的集合并设置其容量为 100 个文档</span>
<span class="nc">CollectionOptions</span> <span class="n">options</span> <span class="o">=</span> <span class="nc">CollectionOptions</span><span class="o">.</span><span class="na">empty</span><span class="o">().</span><span class="na">capped</span><span class="o">().</span><span class="na">size</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
<span class="n">mongoTemplate</span><span class="o">.</span><span class="na">createCollection</span><span class="o">(</span><span class="s">"logs"</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>

<span class="c1">// 检查集合 "products" 是否存在</span>
<span class="kt">boolean</span> <span class="n">exists</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">collectionExists</span><span class="o">(</span><span class="s">"products"</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">exists</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Collection exists!"</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 删除集合</span>
<span class="n">mongoTemplate</span><span class="o">.</span><span class="na">dropCollection</span><span class="o">(</span><span class="s">"oldData"</span><span class="o">);</span>
</code></pre></div></div><ul><li><strong><code class="language-plaintext highlighter-rouge">createCollection</code></strong>：可以根据需要创建新的集合，并设定集合的选项，如大小限制等。</li><li><strong><code class="language-plaintext highlighter-rouge">collectionExists</code></strong>：用于检查集合是否存在，避免重复创建或删除。</li></ul><p><strong>Map-Reduce 操作</strong></p><ul><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; MapReduceResults&lt;T&gt; mapReduce(Query query, String inputCollectionName, String mapFunction, String reduceFunction, Class&lt;T&gt; entityClass)</code>：</li></ul><p><strong>作用</strong>：执行 MongoDB 的 Map-Reduce 操作，适用于复杂的数据处理任务，类似于 Hadoop 中的 Map-Reduce 操作。</p><p><strong>返回值</strong>：<code class="language-plaintext highlighter-rouge">MapReduceResults&lt;T&gt;</code>，包含 Map-Reduce 计算的结果列表。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定义 map 函数和 reduce 函数，计算每个类别下商品的总数量</span>
<span class="nc">String</span> <span class="n">mapFunction</span> <span class="o">=</span> <span class="s">"function() { emit(this.category, 1); }"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">reduceFunction</span> <span class="o">=</span> <span class="s">"function(key, values) { return Array.sum(values); }"</span><span class="o">;</span>

<span class="nc">MapReduceResults</span><span class="o">&lt;</span><span class="nc">CategoryCount</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">mapReduce</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">Query</span><span class="o">(),</span> <span class="s">"products"</span><span class="o">,</span> <span class="n">mapFunction</span><span class="o">,</span> <span class="n">reduceFunction</span><span class="o">,</span> <span class="nc">CategoryCount</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="k">for</span> <span class="o">(</span><span class="nc">CategoryCount</span> <span class="n">result</span> <span class="o">:</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getCategory</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">getCount</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">mapReduce</code></strong>：适合用于大规模数据的分布式计算，如聚合、统计等。</p><p><strong>投影操作 (Projection)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; Query project(String fieldName, String alias)</code>：对指定字段进行投影并使用别名。</li></ul><p><strong>作用</strong>：用于查询时只返回指定的字段，类似于 SQL 中的 <code class="language-plaintext highlighter-rouge">SELECT column1, column2</code>。</p><p><strong>返回值</strong>：返回投影后的对象列表，只有被包含的字段会返回。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 只返回 name 和 price 字段</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">100</span><span class="o">));</span>
<span class="n">query</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">include</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">include</span><span class="o">(</span><span class="s">"price"</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">project</code></strong>：用于查询时减少返回的字段，提高查询效率。</p><p><strong>分页操作 (Pagination)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">&lt;T&gt; List&lt;T&gt; with(Pageable pageable)</code>：基于分页器执行查询。</li></ul><p><strong>作用</strong>：实现分页查询。</p><p><strong>返回值</strong>：返回当前页的数据。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 查询第 1 页，每页 10 条记录</span>
<span class="nc">PageRequest</span> <span class="n">pageable</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">().</span><span class="na">with</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Product</span><span class="o">&gt;</span> <span class="n">products</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><strong>with</strong>：在大数据集的查询中，分页操作可以提升性能并减少内存占用。</p><p><strong>Bulk 操作 (批量操作)</strong></p><ul><li><code class="language-plaintext highlighter-rouge">BulkOperations bulkOps(BulkOperations.BulkMode bulkMode, String collectionName)</code>：用于执行批量操作。</li></ul><p><strong>作用</strong>：用于批量插入、更新或删除多个文档。MongoDB 的批量操作可以极大地提高性能，特别是在处理大量数据时。</p><p><strong>返回值</strong>：返回 <code class="language-plaintext highlighter-rouge">BulkOperations</code> 对象，用于构建和执行批量操作。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 批量插入或更新商品数据</span>
<span class="nc">BulkOperations</span> <span class="n">bulkOps</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">bulkOps</span><span class="o">(</span><span class="nc">BulkOperations</span><span class="o">.</span><span class="na">BulkMode</span><span class="o">.</span><span class="na">UNORDERED</span><span class="o">,</span> <span class="s">"products"</span><span class="o">);</span>

<span class="n">bulkOps</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="k">new</span> <span class="nc">Product</span><span class="o">(</span><span class="s">"Laptop"</span><span class="o">,</span> <span class="mi">1200</span><span class="o">));</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">updateOne</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"Mouse"</span><span class="o">)),</span>
    <span class="k">new</span> <span class="nf">Update</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">25</span><span class="o">)</span>
<span class="o">);</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"Old Mouse"</span><span class="o">)));</span>

<span class="c1">// 执行批量操作</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">bulkOps</code></strong>：批量操作分为两种模式，<code class="language-plaintext highlighter-rouge">ORDERED</code>（有序执行）和 <code class="language-plaintext highlighter-rouge">UNORDERED</code>（无序执行）。<code class="language-plaintext highlighter-rouge">UNORDERED</code> 会跳过失败的操作继续执行其他操作，<code class="language-plaintext highlighter-rouge">ORDERED</code> 则会在失败时终止后续操作。</p><h2 id="query"><code class="language-plaintext highlighter-rouge">Query</code></h2><p><code class="language-plaintext highlighter-rouge">Query</code> 是 Spring Data MongoDB 提供的一个类，用于定义查询条件。它封装了 MongoDB 的查询语法，可以通过它构建复杂的查询条件，传递给 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 执行数据库查询操作。</p><p><code class="language-plaintext highlighter-rouge">Query</code> 通常与 <code class="language-plaintext highlighter-rouge">Criteria</code> 结合使用，来定义字段的筛选条件。<code class="language-plaintext highlighter-rouge">Criteria</code> 类封装了 MongoDB 查询语句中的各种条件运算符，例如等于、包含、范围等。</p><p>以下是 <code class="language-plaintext highlighter-rouge">Query</code> 类的一些常用方法：</p><p><strong>基本方法</strong></p><p><code class="language-plaintext highlighter-rouge">addCriteria(Criteria criteria)</code>：添加一个查询条件。</p><p><strong>投影（字段过滤）</strong></p><p><code class="language-plaintext highlighter-rouge">fields()</code>：指定返回结果中的字段。可以包括或排除某些字段。示例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">();</span>
<span class="n">query</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">include</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">exclude</span><span class="o">(</span><span class="s">"age"</span><span class="o">);</span> <span class="c1">// 只返回 name 字段，不包括 age，这是错误的，一般情况下include和exclude不能同时使用</span>
</code></pre></div></div><p>在 MongoDB 中，查询返回时<strong>默认会包含所有字段</strong>，除非你通过 <code class="language-plaintext highlighter-rouge">include</code> 或 <code class="language-plaintext highlighter-rouge">exclude</code> 来精确控制返回的字段集合。</p><ul><li><strong><code class="language-plaintext highlighter-rouge">include("name")</code></strong>：表示只返回 <code class="language-plaintext highlighter-rouge">name</code> 字段（默认总是返回的 <code class="language-plaintext highlighter-rouge">_id</code> 字段）。</li><li><strong><code class="language-plaintext highlighter-rouge">exclude("age")</code></strong>：表示排除 <code class="language-plaintext highlighter-rouge">age</code> 字段，使得返回的结果中不包含 <code class="language-plaintext highlighter-rouge">age</code> 字段。</li></ul><p>在一条查询中不能同时对同一个查询字段既 <code class="language-plaintext highlighter-rouge">include</code> 又 <code class="language-plaintext highlighter-rouge">exclude</code>，即你不能同时包括和排除字段。</p><p>只使用 <code class="language-plaintext highlighter-rouge">include()</code></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">include</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">include</span><span class="o">(</span><span class="s">"address"</span><span class="o">);</span>
</code></pre></div></div><p>这条语句表示只返回 <code class="language-plaintext highlighter-rouge">_id</code>（默认返回）以及 <code class="language-plaintext highlighter-rouge">name</code> 和 <code class="language-plaintext highlighter-rouge">address</code> 字段，其他字段会被排除。最终返回结果类似：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123 Street"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>只使用 <code class="language-plaintext highlighter-rouge">exclude()</code></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">exclude</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">exclude</span><span class="o">(</span><span class="s">"salary"</span><span class="o">);</span>
</code></pre></div></div><p>这条语句表示排除 <code class="language-plaintext highlighter-rouge">age</code> 和 <code class="language-plaintext highlighter-rouge">salary</code> 字段，返回除它们以外的所有字段。例如，MongoDB 文档中包含 <code class="language-plaintext highlighter-rouge">_id</code>、<code class="language-plaintext highlighter-rouge">name</code>、<code class="language-plaintext highlighter-rouge">age</code> 和 <code class="language-plaintext highlighter-rouge">salary</code> 字段，最终结果可能如下：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p><code class="language-plaintext highlighter-rouge">include</code> 和 <code class="language-plaintext highlighter-rouge">exclude</code> 同时使用</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">include</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">exclude</span><span class="o">(</span><span class="s">"age"</span><span class="o">);</span>
</code></pre></div></div><p><strong>这种写法是无效的</strong>，MongoDB 不允许在同一个查询中既有 <code class="language-plaintext highlighter-rouge">include</code> 又有 <code class="language-plaintext highlighter-rouge">exclude</code>。</p><p>MongoDB 规则</p><ul><li>可以使用多个 <code class="language-plaintext highlighter-rouge">include</code> 来明确指定要返回的字段，除了 <code class="language-plaintext highlighter-rouge">_id</code> 字段（它默认会被返回，除非你显式排除）。</li><li>可以使用多个 <code class="language-plaintext highlighter-rouge">exclude</code> 来排除不需要的字段，其他字段都会被返回。</li><li>如果想排除 <code class="language-plaintext highlighter-rouge">_id</code>，需要显式调用 <code class="language-plaintext highlighter-rouge">exclude("_id")</code>。</li></ul><p>例如：</p><p>返回指定字段，不返回 <code class="language-plaintext highlighter-rouge">_id</code></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">include</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">include</span><span class="o">(</span><span class="s">"address"</span><span class="o">).</span><span class="na">exclude</span><span class="o">(</span><span class="s">"_id"</span><span class="o">);</span>
</code></pre></div></div><p>这条语句返回 <code class="language-plaintext highlighter-rouge">name</code> 和 <code class="language-plaintext highlighter-rouge">address</code> 字段，并且不包含 <code class="language-plaintext highlighter-rouge">_id</code>。返回结果可能如下：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"123 Street"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>排除某些字段，保留 <code class="language-plaintext highlighter-rouge">_id</code></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">exclude</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">exclude</span><span class="o">(</span><span class="s">"salary"</span><span class="o">);</span>
</code></pre></div></div><p>这条语句会排除 <code class="language-plaintext highlighter-rouge">age</code> 和 <code class="language-plaintext highlighter-rouge">salary</code> 字段，返回 <code class="language-plaintext highlighter-rouge">_id</code> 和除 <code class="language-plaintext highlighter-rouge">age</code> 和 <code class="language-plaintext highlighter-rouge">salary</code> 外的所有字段。</p><p>重点总结</p><ul><li><strong><code class="language-plaintext highlighter-rouge">include()</code></strong>：只返回指定的字段，其他字段会被排除。</li><li><strong><code class="language-plaintext highlighter-rouge">exclude()</code></strong>：排除指定的字段，其他字段会被返回。</li><li><strong>不能</strong>在同一个查询中混用 <code class="language-plaintext highlighter-rouge">include</code> 和 <code class="language-plaintext highlighter-rouge">exclude</code>，除了特殊情况下 <code class="language-plaintext highlighter-rouge">_id</code> 可以单独被 <code class="language-plaintext highlighter-rouge">exclude</code>。</li></ul><p><strong>分页操作</strong></p><ul><li><code class="language-plaintext highlighter-rouge">skip(long skip)</code>：跳过查询结果中的前 N 条记录，常用于分页。</li><li><code class="language-plaintext highlighter-rouge">limit(int limit)</code>：限制查询结果的记录数量。</li></ul><p>示例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">();</span>
<span class="n">query</span><span class="o">.</span><span class="na">skip</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span> <span class="c1">// 跳过前 10 条</span>
<span class="n">query</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span> <span class="c1">// 限制只返回 5 条</span>
</code></pre></div></div><p><strong>排序操作</strong></p><ul><li><code class="language-plaintext highlighter-rouge">with(Sort sort)</code>：对查询结果进行排序。可以对一个或多个字段进行升序或降序排列。示例：</li></ul><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.domain.Sort</span><span class="o">;</span>

<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">();</span>
<span class="n">query</span><span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">,</span> <span class="s">"age"</span><span class="o">));</span> <span class="c1">// 按照 age 升序排列</span>
</code></pre></div></div><p><strong>分页与排序配合</strong></p><p>可以通过 <code class="language-plaintext highlighter-rouge">Pageable</code> 来实现分页和排序。示例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.domain.PageRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="o">;</span>

<span class="nc">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span> <span class="c1">// 第2页，每页10条</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">().</span><span class="na">with</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span>
</code></pre></div></div><p><strong>使用 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 执行查询：</strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.MongoTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.query.Criteria</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.query.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MongoTemplate</span> <span class="n">mongoTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findUsersByAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">();</span>
        <span class="n">query</span><span class="o">.</span><span class="na">addCriteria</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="n">age</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h2 id="criteria"><code class="language-plaintext highlighter-rouge">Criteria</code></h2><p><strong>基本操作：</strong></p><p><strong><code class="language-plaintext highlighter-rouge">where(String key)</code></strong>：指定要查询的字段名称。链式调用其他方法来设置查询条件。例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span> <span class="c1">// 查询 age 字段等于 30 的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">is(Object value)</code></strong>：<code class="language-plaintext highlighter-rouge">=</code>，等于某个值。</p><p><strong><code class="language-plaintext highlighter-rouge">lt(Object value)</code></strong>：<code class="language-plaintext highlighter-rouge">&lt;</code>，小于某个值。</p><p><strong><code class="language-plaintext highlighter-rouge">lte(Object value)</code></strong>：<code class="language-plaintext highlighter-rouge">&lt;=</code>，小于等于某个值。</p><p><strong><code class="language-plaintext highlighter-rouge">gt(Object value)</code></strong>：<code class="language-plaintext highlighter-rouge">&gt;</code>，大于某个值。</p><p><strong><code class="language-plaintext highlighter-rouge">gte(Object value)</code></strong>：<code class="language-plaintext highlighter-rouge">&gt;=</code>，大于等于某个值。</p><p><strong><code class="language-plaintext highlighter-rouge">ne(Object value)</code></strong>：<code class="language-plaintext highlighter-rouge">!=</code>，不等于某个值。</p><p><strong><code class="language-plaintext highlighter-rouge">in(Collection&lt;?&gt; values)</code></strong>：<code class="language-plaintext highlighter-rouge">in</code>，字段值在给定的集合中，例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">25</span><span class="o">,</span> <span class="mi">30</span><span class="o">,</span> <span class="mi">35</span><span class="o">));</span> <span class="c1">// 查询 age 为 25, 30 或 35 的记录。</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">nin(Collection&lt;?&gt; values)</code></strong>：<code class="language-plaintext highlighter-rouge">not in</code>，字段值不在给定的集合中。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">nin</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">25</span><span class="o">,</span> <span class="mi">30</span><span class="o">,</span> <span class="mi">35</span><span class="o">));</span> <span class="c1">// 查询 age 不为 25, 30 或 35 的记录、</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">regex(String regex)</code></strong>：正则表达式匹配。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">regex</span><span class="o">(</span><span class="s">"^A.*"</span><span class="o">);</span> <span class="c1">// 查询 name 字段以 "A" 开头的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">exists(boolean exists)</code></strong>：检查字段是否存在。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"address"</span><span class="o">).</span><span class="na">exists</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// 查询 address 字段存在的记录</span>
</code></pre></div></div><p><strong>嵌套操作</strong>：</p><p><strong><code class="language-plaintext highlighter-rouge">elemMatch(Criteria criteria)</code></strong>：用于数组或嵌套对象中的匹配。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"items"</span><span class="o">).</span><span class="na">elemMatch</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">100</span><span class="o">));</span> <span class="c1">// 查询数组中包含 price 大于 100 的元素</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">orOperator(Criteria... criteria)</code></strong>：用于 OR 条件组合查询，相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">OR</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">orOperator</span><span class="o">(</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="mi">20</span><span class="o">),</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"John"</span><span class="o">)</span>
<span class="o">);</span> <span class="c1">// 查询 age 小于 20 或 name 为 "John" 的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">andOperator(Criteria... criteria)</code></strong>：用于 AND 条件组合查询，相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">AND</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">andOperator</span><span class="o">(</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">20</span><span class="o">),</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="mi">30</span><span class="o">)</span>
<span class="o">);</span> <span class="c1">// 查询 age 大于 20 且小于 30 的记录</span>
</code></pre></div></div><p><strong>其他：</strong></p><p><strong><code class="language-plaintext highlighter-rouge">size(int size)</code></strong>：用于查询数组长度为指定值的记录。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"tags"</span><span class="o">).</span><span class="na">size</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span> <span class="c1">// 查询 tags 数组长度为 3 的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">not()</code></strong>：用于取反条件，相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">NOT</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">not</span><span class="o">().</span><span class="na">is</span><span class="o">(</span><span class="s">"Alice"</span><span class="o">);</span> <span class="c1">// 查询 name 不为 "Alice" 的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">mod(Number divisor, Number remainder)</code></strong>：用于取模操作，查询字段的值是否满足模运算的结果。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">mod</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span> <span class="c1">// 查询 age 能被 5 整除的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">type(int type)</code></strong>：用于查询字段的 BSON 类型。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">type</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span> <span class="c1">// 查询 age 为 BSON 类型 "double" 的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">all(Collection&lt;?&gt; values)</code></strong>：用于数组字段的查询，匹配数组字段中包含指定值的记录。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"tags"</span><span class="o">).</span><span class="na">all</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"tag1"</span><span class="o">,</span> <span class="s">"tag2"</span><span class="o">));</span> <span class="c1">// 查询 tags 字段同时包含 "tag1" 和 "tag2" 的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">isNull()</code></strong>：用于查询字段是否为 <code class="language-plaintext highlighter-rouge">null</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"address"</span><span class="o">).</span><span class="na">isNull</span><span class="o">();</span> <span class="c1">// 查询 address 字段为 null 的记录</span>
</code></pre></div></div><p><strong>结合 <code class="language-plaintext highlighter-rouge">Criteria</code> 和 <code class="language-plaintext highlighter-rouge">Query</code> 使用</strong></p><p>通常情况下，<code class="language-plaintext highlighter-rouge">Criteria</code> 会与 <code class="language-plaintext highlighter-rouge">Query</code> 结合使用，通过 <code class="language-plaintext highlighter-rouge">Query</code> 类将 <code class="language-plaintext highlighter-rouge">Criteria</code> 传递给 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 执行查询。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">();</span>
<span class="n">query</span><span class="o">.</span><span class="na">addCriteria</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">25</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="mi">40</span><span class="o">));</span> <span class="c1">// 查询 age 在 25 到 40 之间的记录</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><strong>嵌套查询实例：</strong></p><p>关于 <code class="language-plaintext highlighter-rouge">elemMatch</code>、<code class="language-plaintext highlighter-rouge">orOperator</code> 和 <code class="language-plaintext highlighter-rouge">andOperator</code> 等嵌套操作的具体使用场景，通常是在查询 MongoDB 中复杂的嵌套文档或数组结构时用到的。为了更清晰地解释这些操作，下面会结合实际的 MongoDB 文档结构，逐个举例说明。</p><p>示例 1：<code class="language-plaintext highlighter-rouge">elemMatch</code>（用于数组或嵌套对象匹配）</p><p>假设有一个 MongoDB 集合 <code class="language-plaintext highlighter-rouge">products</code>，其文档结构如下：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"123"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Laptop"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"silver"</span><span class="p">,</span><span class="w"> </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mi">1300</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p><strong>需求</strong>：查询 <code class="language-plaintext highlighter-rouge">items</code> 数组中包含 <code class="language-plaintext highlighter-rouge">price</code> 大于 1200 的文档。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 使用 elemMatch 来匹配数组中的元素</span>
<span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"items"</span><span class="o">).</span><span class="na">elemMatch</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">1200</span><span class="o">));</span>

<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"products"</span><span class="o">);</span>
</code></pre></div></div><p><strong>解释</strong>：<code class="language-plaintext highlighter-rouge">elemMatch</code> 用于查询数组字段 <code class="language-plaintext highlighter-rouge">items</code>，并查找其包含 <code class="language-plaintext highlighter-rouge">price</code> 大于 1200 的元素。</p><p>示例 2：<code class="language-plaintext highlighter-rouge">orOperator</code>（用于 <code class="language-plaintext highlighter-rouge">OR</code> 条件查询）</p><p>假设有一个 MongoDB 集合 <code class="language-plaintext highlighter-rouge">users</code>，其文档结构如下：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"123"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Alice"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w">
  </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"New York"</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"124"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bob"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
  </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"125"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Charlie"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w">
  </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Los Angeles"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p><strong>需求</strong>：查询年龄小于 20 岁或名字为 <code class="language-plaintext highlighter-rouge">Alice</code> 的用户。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 使用 orOperator 来进行 OR 组合条件查询</span>
<span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">orOperator</span><span class="o">(</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="mi">20</span><span class="o">),</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"Alice"</span><span class="o">)</span>
<span class="o">);</span>

<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"users"</span><span class="o">);</span>
</code></pre></div></div><p><strong>解释</strong>：这里使用了 <code class="language-plaintext highlighter-rouge">orOperator</code> 来表示 <code class="language-plaintext highlighter-rouge">age</code> 小于 20 岁或者 <code class="language-plaintext highlighter-rouge">name</code> 是 <code class="language-plaintext highlighter-rouge">Alice</code> 的用户。这个操作相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">OR</code>。</p><p>示例 3：<code class="language-plaintext highlighter-rouge">andOperator</code>（用于 <code class="language-plaintext highlighter-rouge">AND</code> 条件查询）</p><p>假设还是使用 <code class="language-plaintext highlighter-rouge">users</code> 集合：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"123"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Alice"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w">
  </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"New York"</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"124"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bob"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
  </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"125"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Charlie"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w">
  </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Los Angeles"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p><strong>需求</strong>：查询年龄大于 20 且小于 30 岁的用户。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 使用 andOperator 来进行 AND 组合条件查询</span>
<span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">andOperator</span><span class="o">(</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">20</span><span class="o">),</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="mi">30</span><span class="o">)</span>
<span class="o">);</span>

<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"users"</span><span class="o">);</span>
</code></pre></div></div><p><strong>解释</strong>：这里使用了 <code class="language-plaintext highlighter-rouge">andOperator</code>，表示 <code class="language-plaintext highlighter-rouge">age</code> 大于 20 且小于 30 的用户。这相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">AND</code> 逻辑。</p><p>示例 4：<code class="language-plaintext highlighter-rouge">elemMatch</code> + <code class="language-plaintext highlighter-rouge">andOperator</code>（嵌套查询）</p><p>假设有一个集合 <code class="language-plaintext highlighter-rouge">orders</code>，其文档结构如下：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"101"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"customer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Doe"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"product"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Laptop"</span><span class="p">,</span><span class="w"> </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mi">1200</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"product"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mouse"</span><span class="p">,</span><span class="w"> </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="err">,</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="err">ObjectId(</span><span class="s2">"102"</span><span class="err">)</span><span class="p">,</span><span class="w">
  </span><span class="nl">"customer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jane Smith"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"product"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Laptop"</span><span class="p">,</span><span class="w"> </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mi">1500</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"product"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Keyboard"</span><span class="p">,</span><span class="w"> </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"price"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p><strong>需求</strong>：查询订单中包含 <code class="language-plaintext highlighter-rouge">Laptop</code> 且价格大于 1300 的订单。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 使用 elemMatch 和 andOperator 进行复杂嵌套条件查询</span>
<span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"items"</span><span class="o">).</span><span class="na">elemMatch</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">Criteria</span><span class="o">().</span><span class="na">andOperator</span><span class="o">(</span>
        <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"product"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"Laptop"</span><span class="o">),</span>
        <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">1300</span><span class="o">)</span>
    <span class="o">)</span>
<span class="o">);</span>

<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"orders"</span><span class="o">);</span>
</code></pre></div></div><p><strong>解释</strong>：这里的 <code class="language-plaintext highlighter-rouge">elemMatch</code> 用于匹配 <code class="language-plaintext highlighter-rouge">items</code> 数组中的某个元素，它必须同时满足 <code class="language-plaintext highlighter-rouge">product</code> 为 <code class="language-plaintext highlighter-rouge">Laptop</code> 且 <code class="language-plaintext highlighter-rouge">price</code> 大于 1300 的条件。</p><p>示例 5：<code class="language-plaintext highlighter-rouge">orOperator</code> + <code class="language-plaintext highlighter-rouge">elemMatch</code>（组合查询）</p><p>假设使用相同的 <code class="language-plaintext highlighter-rouge">orders</code> 集合：</p><p><strong>需求</strong>：查询订单中包含 <code class="language-plaintext highlighter-rouge">Laptop</code> 且价格大于 1300 或 <code class="language-plaintext highlighter-rouge">Mouse</code> 的订单。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 使用 orOperator 和 elemMatch 进行组合查询</span>
<span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">orOperator</span><span class="o">(</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"items"</span><span class="o">).</span><span class="na">elemMatch</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">Criteria</span><span class="o">().</span><span class="na">andOperator</span><span class="o">(</span>
            <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"product"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"Laptop"</span><span class="o">),</span>
            <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"price"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">1300</span><span class="o">)</span>
        <span class="o">)</span>
    <span class="o">),</span>
    <span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"items"</span><span class="o">).</span><span class="na">elemMatch</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"product"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"Mouse"</span><span class="o">))</span>
<span class="o">);</span>

<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"orders"</span><span class="o">);</span>
</code></pre></div></div><p><strong>解释</strong>：在这里，使用了 <code class="language-plaintext highlighter-rouge">orOperator</code> 来表示两种情况之一：要么 <code class="language-plaintext highlighter-rouge">items</code> 中包含 <code class="language-plaintext highlighter-rouge">Laptop</code> 且价格大于 1300，要么 <code class="language-plaintext highlighter-rouge">items</code> 中包含 <code class="language-plaintext highlighter-rouge">Mouse</code>。这相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">OR</code> 逻辑。</p><p><strong>特别注意</strong></p><p>下面的 MongoDB 查询：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$or"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nl">"deleteStatus"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"deleteStatus"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$exists"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}],</span><span class="w">
  </span><span class="nl">"tenant_id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"$or"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nl">"speciality"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"生物学"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"number"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$gt"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>等效于以下 SQL 语句：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span> <span class="n">co_common_test1</span> 
<span class="k">WHERE</span> 
  <span class="p">(</span><span class="n">deleteStatus</span> <span class="o">=</span> <span class="k">false</span> <span class="k">OR</span> <span class="n">deleteStatus</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">)</span>
  <span class="k">AND</span> <span class="n">tenant_id</span> <span class="o">=</span> <span class="s1">'16889087066967307206'</span>
  <span class="k">AND</span> <span class="p">(</span><span class="n">speciality</span> <span class="o">=</span> <span class="s1">'生物学'</span> <span class="k">OR</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">54</span><span class="p">);</span>
</code></pre></div></div><p>但是，在 MongoDB 中，一个文档内不能同时包含两个顶层的 <code class="language-plaintext highlighter-rouge">"$or"</code>，因为<strong>每个键必须是唯一的</strong>。如果你尝试这样做，后面的 <code class="language-plaintext highlighter-rouge">"$or"</code> 会覆盖前面的 <code class="language-plaintext highlighter-rouge">"$or"</code>，导致无法正确执行查询。</p><p>要解决这个问题并保持你想要的逻辑，可以使用一个顶层的 <code class="language-plaintext highlighter-rouge">"$and"</code> 来组合这两个 <code class="language-plaintext highlighter-rouge">"$or"</code> 逻辑。这是 MongoDB 语法的限制，必须使用 <code class="language-plaintext highlighter-rouge">$and</code> 来组合多个 <code class="language-plaintext highlighter-rouge">"$or"</code>。</p><p>可以将查询重构为：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"$or"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nl">"deleteStatus"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"deleteStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$exists"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"$or"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nl">"speciality"</span><span class="p">:</span><span class="w"> </span><span class="s2">"生物学"</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"number"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$gt"</span><span class="p">:</span><span class="w"> </span><span class="mi">54</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}]</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>这对应的 SQL 查询仍然是你期望的：</p><div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> 
<span class="k">FROM</span> <span class="n">co_common_test1</span> 
<span class="k">WHERE</span> 
  <span class="p">(</span><span class="n">deleteStatus</span> <span class="o">=</span> <span class="k">false</span> <span class="k">OR</span> <span class="n">deleteStatus</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">)</span>
  <span class="k">AND</span> <span class="n">tenant_id</span> <span class="o">=</span> <span class="s1">'16889087066967307206'</span>
  <span class="k">AND</span> <span class="p">(</span><span class="n">speciality</span> <span class="o">=</span> <span class="s1">'生物学'</span> <span class="k">OR</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="mi">54</span><span class="p">);</span>
</code></pre></div></div><p><strong>总结：</strong> 尽管 SQL 中不需要显式使用 <code class="language-plaintext highlighter-rouge">AND</code> 来组合多个条件，但在 MongoDB 中，必须使用 <code class="language-plaintext highlighter-rouge">"$and"</code> 来组合多个 <code class="language-plaintext highlighter-rouge">"$or"</code>，否则会遇到查询覆盖的问题。</p><h2 id="更新操作">更新操作</h2><p><strong><code class="language-plaintext highlighter-rouge">Update</code></strong>：</p><p><code class="language-plaintext highlighter-rouge">org.springframework.data.mongodb.core.query.Update</code> 是 Spring Data MongoDB 中用于执行数据库更新操作的核心类。它可以用于对 MongoDB 文档进行字段更新、增量修改、数组操作等。以下是一些 <code class="language-plaintext highlighter-rouge">Update</code> 类的常用方法，以及每个方法的用途和实例。</p><p><strong><code class="language-plaintext highlighter-rouge">set(String key, Object value)</code></strong> - 设置字段值</p><p>用于将指定字段的值更新为新值。如果字段不存在，会创建该字段。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>  <span class="c1">// 设置字段 "age" 的值为 30</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">unset(String key)</code></strong> - 移除字段</p><p>用于移除指定的字段。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">unset</span><span class="o">(</span><span class="s">"address"</span><span class="o">);</span>  <span class="c1">// 删除字段 "address"</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">inc(String key, Number value)</code></strong> - 增加或减少字段值</p><p>对数值字段进行增量操作（加法）。如果字段不存在，它将创建该字段。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>  <span class="c1">// 将 "age" 字段的值增加 2</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">push(String key, Object value)</code></strong> - 向数组字段追加元素</p><p>将一个元素添加到数组字段中。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">push</span><span class="o">(</span><span class="s">"skills"</span><span class="o">,</span> <span class="s">"Java"</span><span class="o">);</span>  <span class="c1">// 在 "skills" 数组中添加 "Java"</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">addToSet(String key, Object value)</code></strong> - 向数组添加唯一元素</p><p>如果数组字段中不存在该值，则添加该值（避免重复）。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">addToSet</span><span class="o">(</span><span class="s">"skills"</span><span class="o">,</span> <span class="s">"Java"</span><span class="o">);</span>  <span class="c1">// 如果 "skills" 数组中不存在 "Java"，则添加</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">pull(String key, Object value)</code></strong> - 从数组中移除指定值</p><p>移除数组字段中等于指定值的元素。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">pull</span><span class="o">(</span><span class="s">"skills"</span><span class="o">,</span> <span class="s">"Java"</span><span class="o">);</span>  <span class="c1">// 从 "skills" 数组中移除 "Java"</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">pullAll(String key, Object... values)</code></strong> - 从数组中移除多个值</p><p>从数组字段中移除多个指定值。</p><p><strong>实例</strong>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">pullAll</span><span class="o">(</span><span class="s">"skills"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"Java"</span><span class="o">,</span> <span class="s">"Python"</span><span class="o">});</span>  <span class="c1">// 从 "skills" 数组中移除 "Java" 和 "Python"</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">pop(String key, Update.Position position)</code></strong> - 从数组的开头或结尾移除元素</p><p>用于从数组的开头或结尾移除一个元素。</p><ul><li><code class="language-plaintext highlighter-rouge">Update.Position.FIRST</code>：移除第一个元素</li><li><code class="language-plaintext highlighter-rouge">Update.Position.LAST</code>：移除最后一个元素</li></ul><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">pop</span><span class="o">(</span><span class="s">"skills"</span><span class="o">,</span> <span class="nc">Update</span><span class="o">.</span><span class="na">Position</span><span class="o">.</span><span class="na">LAST</span><span class="o">);</span>  <span class="c1">// 移除 "skills" 数组中的最后一个元素</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">rename(String oldName, String newName)</code></strong> - 重命名字段</p><p>将指定字段重命名为新名称。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">rename</span><span class="o">(</span><span class="s">"oldFieldName"</span><span class="o">,</span> <span class="s">"newFieldName"</span><span class="o">);</span>  <span class="c1">// 将字段 "oldFieldName" 重命名为 "newFieldName"</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">mul(String key, Number factor)</code></strong> - 数值乘法更新</p><p>将指定字段的值乘以某个因子。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">mul</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mf">1.1</span><span class="o">);</span>  <span class="c1">// 将 "price" 字段的值乘以 1.1</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">min(String key, Object value)</code></strong> - 仅当新值小于当前值时进行更新</p><p>如果传入的新值比现有字段的值小，则更新该字段为新值。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>  <span class="c1">// 仅当 "price" 小于 100 时，更新它为 100</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">max(String key, Object value)</code></strong> - 仅当新值大于当前值时进行更新</p><p>如果传入的新值比现有字段的值大，则更新该字段为新值。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>  <span class="c1">// 仅当 "price" 大于 1000 时，更新它为 1000</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">currentDate(String key)</code></strong> - 设置字段为当前日期</p><p>将指定字段的值设置为当前日期时间。</p><p><strong>实例</strong>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">();</span>
<span class="n">update</span><span class="o">.</span><span class="na">currentDate</span><span class="o">(</span><span class="s">"lastModified"</span><span class="o">);</span>  <span class="c1">// 设置 "lastModified" 字段为当前时间</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">combine(Update... updates)</code></strong> - 组合多个 <code class="language-plaintext highlighter-rouge">Update</code> 对象</p><p>将多个 <code class="language-plaintext highlighter-rouge">Update</code> 对象组合成一个 <code class="language-plaintext highlighter-rouge">Update</code> 对象。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Update</span> <span class="n">update1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"John"</span><span class="o">);</span>
<span class="nc">Update</span> <span class="n">update2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">().</span><span class="na">inc</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="nc">Update</span> <span class="n">combinedUpdate</span> <span class="o">=</span> <span class="nc">Update</span><span class="o">.</span><span class="na">combine</span><span class="o">(</span><span class="n">update1</span><span class="o">,</span> <span class="n">update2</span><span class="o">);</span>  <span class="c1">// 将多个更新组合在一起</span>
</code></pre></div></div><hr /><p><strong><code class="language-plaintext highlighter-rouge">UpdateResult</code></strong>：</p><p><code class="language-plaintext highlighter-rouge">updateFirst</code> 等更新方法的返回值类型为 <code class="language-plaintext highlighter-rouge">com.mongodb.client.result.UpdateResult</code>。<code class="language-plaintext highlighter-rouge">UpdateResult</code> 类用于表示更新操作的结果，并提供了一些方法来获取有关更新操作的详细信息。它包括以下一些常用方法：</p><p><code class="language-plaintext highlighter-rouge">UpdateResult</code> 常用方法</p><p><strong><code class="language-plaintext highlighter-rouge">getMatchedCount()</code></strong>: 返回匹配到的文档数。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nc">UpdateResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">updateFirst</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">update</span><span class="o">,</span> <span class="nc">MyClass</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="kt">long</span> <span class="n">matchedCount</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getMatchedCount</span><span class="o">();</span>  <span class="c1">// 返回匹配到的文档数量</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getModifiedCount()</code></strong>: 返回实际被修改的文档数。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="kt">long</span> <span class="n">modifiedCount</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getModifiedCount</span><span class="o">();</span>  <span class="c1">// 返回修改的文档数量</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">wasAcknowledged()</code></strong>: 检查更新操作是否被 MongoDB 确认。返回 <code class="language-plaintext highlighter-rouge">true</code> 表示操作已确认。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="kt">boolean</span> <span class="n">isAcknowledged</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">wasAcknowledged</span><span class="o">();</span>  <span class="c1">// 检查操作是否被确认</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getUpsertedId()</code></strong>: 返回因为 <code class="language-plaintext highlighter-rouge">upsert</code> 操作插入的文档的 <code class="language-plaintext highlighter-rouge">_id</code>，如果操作不是 <code class="language-plaintext highlighter-rouge">upsert</code>，则返回 <code class="language-plaintext highlighter-rouge">null</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="nc">BsonValue</span> <span class="n">upsertedId</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getUpsertedId</span><span class="o">();</span>  <span class="c1">// 获取通过 upsert 插入的文档 ID</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">upsertedId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
       <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Upserted ID: "</span> <span class="o">+</span> <span class="n">upsertedId</span><span class="o">);</span>
   <span class="o">}</span>
</code></pre></div></div><p>结合 <code class="language-plaintext highlighter-rouge">updateFirst</code> 使用的完整示例</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"John"</span><span class="o">));</span>
<span class="nc">Update</span> <span class="n">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>

<span class="c1">// 执行更新操作</span>
<span class="nc">UpdateResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">updateFirst</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">update</span><span class="o">,</span> <span class="nc">MyClass</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 获取更新结果信息</span>
<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">wasAcknowledged</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Matched count: "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">getMatchedCount</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Modified count: "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">getModifiedCount</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">getUpsertedId</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Upserted ID: "</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">getUpsertedId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Update was not acknowledged by MongoDB"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">getMatchedCount()</code>：匹配的文档数量。</li><li><code class="language-plaintext highlighter-rouge">getModifiedCount()</code>：修改的文档数量。</li><li><code class="language-plaintext highlighter-rouge">wasAcknowledged()</code>：检查操作是否被 MongoDB 确认。</li><li><code class="language-plaintext highlighter-rouge">getUpsertedId()</code>：如果进行了 <code class="language-plaintext highlighter-rouge">upsert</code> 操作并插入新文档，则返回该文档的 <code class="language-plaintext highlighter-rouge">_id</code>。</li></ul><h2 id="删除操作">删除操作</h2><p><code class="language-plaintext highlighter-rouge">com.mongodb.client.result.DeleteResult</code> 是 MongoDB 中删除操作的结果对象，它提供了方法来检查删除操作的执行情况和结果。它和 <code class="language-plaintext highlighter-rouge">UpdateResult</code> 类似，主要用于查看删除操作的结果和影响。</p><p><code class="language-plaintext highlighter-rouge">DeleteResult</code> 常用方法</p><p><strong><code class="language-plaintext highlighter-rouge">getDeletedCount()</code></strong>: 返回被删除的文档数。该方法用于了解删除操作影响了多少个文档。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">long</span> <span class="n">deletedCount</span> <span class="o">=</span> <span class="n">deleteResult</span><span class="o">.</span><span class="na">getDeletedCount</span><span class="o">();</span>  <span class="c1">// 获取被删除的文档数量</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">wasAcknowledged()</code></strong>: 检查删除操作是否被 MongoDB 确认。返回 <code class="language-plaintext highlighter-rouge">true</code> 表示删除操作已确认，<code class="language-plaintext highlighter-rouge">false</code> 表示操作未被确认。这对于确认操作是否成功完成是非常有用的。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">boolean</span> <span class="n">isAcknowledged</span> <span class="o">=</span> <span class="n">deleteResult</span><span class="o">.</span><span class="na">wasAcknowledged</span><span class="o">();</span>  <span class="c1">// 检查操作是否被确认</span>
</code></pre></div></div><p>使用 <code class="language-plaintext highlighter-rouge">DeleteResult</code> 的完整示例</p><p>假设你想从 MongoDB 中删除某个集合中的记录，可以通过 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 执行删除操作，并使用 <code class="language-plaintext highlighter-rouge">DeleteResult</code> 来获取结果。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定义查询条件</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"John"</span><span class="o">));</span>

<span class="c1">// 执行删除操作</span>
<span class="nc">DeleteResult</span> <span class="n">deleteResult</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">MyClass</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 检查删除操作是否被 MongoDB 确认</span>
<span class="k">if</span> <span class="o">(</span><span class="n">deleteResult</span><span class="o">.</span><span class="na">wasAcknowledged</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// 获取被删除的文档数量</span>
    <span class="kt">long</span> <span class="n">deletedCount</span> <span class="o">=</span> <span class="n">deleteResult</span><span class="o">.</span><span class="na">getDeletedCount</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Deleted count: "</span> <span class="o">+</span> <span class="n">deletedCount</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Delete operation was not acknowledged by MongoDB"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><h2 id="批量操作">批量操作</h2><p><code class="language-plaintext highlighter-rouge">BulkOperations</code> 是 Spring Data MongoDB 提供的用于批量执行 MongoDB 操作的接口。它允许你在一次操作中对多个文档执行插入、更新、删除等操作。使用批量操作不仅可以提高效率，还可以减少网络开销和数据库负载。</p><p>常用的 <code class="language-plaintext highlighter-rouge">BulkOperations</code> 方法及其作用</p><p><strong><code class="language-plaintext highlighter-rouge">insert(List&lt;?&gt; documents)</code></strong>：插入多个文档到集合中。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">MyDocument</span><span class="o">&gt;</span> <span class="n">documents</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyDocument</span><span class="o">(</span><span class="s">"doc1"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">MyDocument</span><span class="o">(</span><span class="s">"doc2"</span><span class="o">));</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">documents</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">updateOne(Query query, Update update)</code></strong>：根据查询条件更新单个文档。相当于 MongoDB 中的 <code class="language-plaintext highlighter-rouge">updateOne</code> 操作。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bulkOps</span><span class="o">.</span><span class="na">updateOne</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"John"</span><span class="o">)),</span> <span class="nc">Update</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">30</span><span class="o">));</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">updateMulti(Query query, Update update)</code></strong>: 根据查询条件更新多个文档。相当于 MongoDB 中的 <code class="language-plaintext highlighter-rouge">updateMany</code> 操作。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bulkOps</span><span class="o">.</span><span class="na">updateMulti</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"status"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"active"</span><span class="o">)),</span> <span class="nc">Update</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"status"</span><span class="o">,</span> <span class="s">"inactive"</span><span class="o">));</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">remove(Query query)</code></strong>：根据查询条件删除文档。相当于 MongoDB 中的 <code class="language-plaintext highlighter-rouge">deleteMany</code> 操作。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bulkOps</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">lt</span><span class="o">(</span><span class="mi">18</span><span class="o">)));</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">replaceOne(Query query, Object replacement)</code></strong>: 查找并替换符合条件的单个文档。类似于 MongoDB 中的 <code class="language-plaintext highlighter-rouge">replaceOne</code> 操作。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">MyDocument</span> <span class="n">replacement</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyDocument</span><span class="o">(</span><span class="s">"newDocument"</span><span class="o">);</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">replaceOne</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"OldDocument"</span><span class="o">)),</span> <span class="n">replacement</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">upsert(Query query, Update update)</code></strong>：如果符合条件的文档存在，则更新；如果不存在，则插入新文档。相当于 MongoDB 中的 <code class="language-plaintext highlighter-rouge">upsert</code> 操作。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bulkOps</span><span class="o">.</span><span class="na">upsert</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"John"</span><span class="o">)),</span> <span class="nc">Update</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">25</span><span class="o">));</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">execute()</code></strong>：执行批量操作。执行所有在批量操作中添加的插入、更新、删除等操作。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BulkWriteResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">bulkOps</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">find(Query query)</code></strong>：根据查询条件查找文档，通常用于后续的 <code class="language-plaintext highlighter-rouge">update</code> 或 <code class="language-plaintext highlighter-rouge">remove</code> 操作。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bulkOps</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">30</span><span class="o">)));</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">BulkOperations</code> 示例</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建 BulkOperations 实例</span>
<span class="nc">BulkOperations</span> <span class="n">bulkOps</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">bulkOps</span><span class="o">(</span><span class="nc">BulkOperations</span><span class="o">.</span><span class="na">BulkMode</span><span class="o">.</span><span class="na">ORDERED</span><span class="o">,</span> <span class="nc">MyDocument</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 插入多个文档</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">MyDocument</span><span class="o">&gt;</span> <span class="n">documents</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyDocument</span><span class="o">(</span><span class="s">"doc1"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">MyDocument</span><span class="o">(</span><span class="s">"doc2"</span><span class="o">));</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">documents</span><span class="o">);</span>

<span class="c1">// 更新单个文档</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">updateOne</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"John"</span><span class="o">)),</span> <span class="nc">Update</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">30</span><span class="o">));</span>

<span class="c1">// 删除符合条件的文档</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"status"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"inactive"</span><span class="o">)));</span>

<span class="c1">// 执行所有操作</span>
<span class="nc">BulkWriteResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">bulkOps</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>
</code></pre></div></div><p>执行模式</p><ul><li><strong>ORDERED</strong>: 批量操作按顺序执行。如果某个操作失败，后续操作将不执行。</li><li><strong>UNORDERED</strong>: 批量操作可以并行执行，即使某个操作失败，其他操作仍会继续执行。</li></ul><p>常用场景</p><ul><li><strong>批量插入</strong>: 大量文档插入时，使用 <code class="language-plaintext highlighter-rouge">bulkOps.insert()</code> 提高性能。</li><li><strong>批量更新</strong>: 需要对多个文档进行同一条件更新时，使用 <code class="language-plaintext highlighter-rouge">bulkOps.updateMulti()</code>。</li><li><strong>批量删除</strong>: 批量删除符合条件的文档时，使用 <code class="language-plaintext highlighter-rouge">bulkOps.remove()</code>。</li><li><strong>高效处理</strong>: 当需要执行多个操作时（如更新和删除），可以通过批量操作一次性提交。</li></ul><p>通过 <code class="language-plaintext highlighter-rouge">BulkOperations</code>，可以将多种操作打包成一次请求，大幅减少与数据库的交互次数，提升操作效率。</p><hr /><p><code class="language-plaintext highlighter-rouge">BulkWriteResult</code> 是 MongoDB 批量操作（<code class="language-plaintext highlighter-rouge">BulkOperations</code>）执行后的结果对象。它用于获取批量写操作的执行结果，提供了插入、更新、删除等操作的统计信息。</p><p><code class="language-plaintext highlighter-rouge">BulkWriteResult</code> 常用方法及其作用</p><p><strong><code class="language-plaintext highlighter-rouge">getInsertedCount()</code></strong>：返回批量操作中成功插入文档的数量。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">insertedCount</span> <span class="o">=</span> <span class="n">bulkWriteResult</span><span class="o">.</span><span class="na">getInsertedCount</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"插入的文档数量: "</span> <span class="o">+</span> <span class="n">insertedCount</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getMatchedCount()</code></strong>：返回批量更新操作中匹配的文档数量，即符合查询条件的文档数量，不论是否有实际更新发生。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">matchedCount</span> <span class="o">=</span> <span class="n">bulkWriteResult</span><span class="o">.</span><span class="na">getMatchedCount</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"匹配的文档数量: "</span> <span class="o">+</span> <span class="n">matchedCount</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getModifiedCount()</code></strong>：返回批量更新操作中实际被更新的文档数量。注意，只有当文档内容发生改变时，这个值才会增加。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">modifiedCount</span> <span class="o">=</span> <span class="n">bulkWriteResult</span><span class="o">.</span><span class="na">getModifiedCount</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"实际更新的文档数量: "</span> <span class="o">+</span> <span class="n">modifiedCount</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getDeletedCount()</code></strong>：返回批量操作中成功删除的文档数量。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">deletedCount</span> <span class="o">=</span> <span class="n">bulkWriteResult</span><span class="o">.</span><span class="na">getDeletedCount</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"删除的文档数量: "</span> <span class="o">+</span> <span class="n">deletedCount</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getUpserts()</code></strong>：返回批量操作中发生 <code class="language-plaintext highlighter-rouge">upsert</code>（更新插入）的文档信息列表。<code class="language-plaintext highlighter-rouge">upsert</code> 是指如果查询没有匹配到文档，则插入新文档。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">BulkWriteUpsert</span><span class="o">&gt;</span> <span class="n">upserts</span> <span class="o">=</span> <span class="n">bulkWriteResult</span><span class="o">.</span><span class="na">getUpserts</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">BulkWriteUpsert</span> <span class="n">upsert</span> <span class="o">:</span> <span class="n">upserts</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Upserted Document _id: "</span> <span class="o">+</span> <span class="n">upsert</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getInsertedIds()</code></strong>：返回批量操作中成功插入的文档 <code class="language-plaintext highlighter-rouge">_id</code> 列表。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">BsonValue</span><span class="o">&gt;</span> <span class="n">insertedIds</span> <span class="o">=</span> <span class="n">bulkWriteResult</span><span class="o">.</span><span class="na">getInsertedIds</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="nc">BsonValue</span> <span class="n">id</span> <span class="o">:</span> <span class="n">insertedIds</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"插入的文档 _id: "</span> <span class="o">+</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">wasAcknowledged()</code></strong>：返回该批量操作是否被 MongoDB 成功确认。通常在 <code class="language-plaintext highlighter-rouge">UNACKNOWLEDGED</code> 模式下，它会返回 <code class="language-plaintext highlighter-rouge">false</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">acknowledged</span> <span class="o">=</span> <span class="n">bulkWriteResult</span><span class="o">.</span><span class="na">wasAcknowledged</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">acknowledged</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"批量操作已被确认"</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"批量操作未被确认"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>示例</strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建 BulkOperations 实例</span>
<span class="nc">BulkOperations</span> <span class="n">bulkOps</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">bulkOps</span><span class="o">(</span><span class="nc">BulkOperations</span><span class="o">.</span><span class="na">BulkMode</span><span class="o">.</span><span class="na">ORDERED</span><span class="o">,</span> <span class="nc">MyDocument</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 添加批量操作</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyDocument</span><span class="o">(</span><span class="s">"doc1"</span><span class="o">));</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">updateOne</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"John"</span><span class="o">)),</span> <span class="nc">Update</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">30</span><span class="o">));</span>
<span class="n">bulkOps</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"status"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"inactive"</span><span class="o">)));</span>

<span class="c1">// 执行批量操作并获取结果</span>
<span class="nc">BulkWriteResult</span> <span class="n">result</span> <span class="o">=</span> <span class="n">bulkOps</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>

<span class="c1">// 获取插入的文档数量</span>
<span class="kt">int</span> <span class="n">insertedCount</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getInsertedCount</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"插入的文档数量: "</span> <span class="o">+</span> <span class="n">insertedCount</span><span class="o">);</span>

<span class="c1">// 获取更新匹配的文档数量</span>
<span class="kt">int</span> <span class="n">matchedCount</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getMatchedCount</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"匹配的文档数量: "</span> <span class="o">+</span> <span class="n">matchedCount</span><span class="o">);</span>

<span class="c1">// 获取实际更新的文档数量</span>
<span class="kt">int</span> <span class="n">modifiedCount</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getModifiedCount</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"实际更新的文档数量: "</span> <span class="o">+</span> <span class="n">modifiedCount</span><span class="o">);</span>

<span class="c1">// 获取删除的文档数量</span>
<span class="kt">int</span> <span class="n">deletedCount</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getDeletedCount</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"删除的文档数量: "</span> <span class="o">+</span> <span class="n">deletedCount</span><span class="o">);</span>

<span class="c1">// 检查批量操作是否被确认</span>
<span class="k">if</span> <span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">wasAcknowledged</span><span class="o">())</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"批量操作已成功确认"</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"批量操作未被确认"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>常用场景</strong></p><ul><li><strong>批量插入后统计</strong>: 在执行大批量数据插入后，使用 <code class="language-plaintext highlighter-rouge">getInsertedCount()</code> 获取插入的总数。</li><li><strong>批量更新后检查</strong>: 在进行批量更新时，通过 <code class="language-plaintext highlighter-rouge">getMatchedCount()</code> 和 <code class="language-plaintext highlighter-rouge">getModifiedCount()</code> 确认有多少文档被匹配和实际修改。</li><li><strong>批量删除后确认</strong>: 使用 <code class="language-plaintext highlighter-rouge">getDeletedCount()</code> 确认成功删除的文档数量。</li><li><strong>检查 <code class="language-plaintext highlighter-rouge">upsert</code> 操作</strong>: 使用 <code class="language-plaintext highlighter-rouge">getUpserts()</code> 获取执行了 <code class="language-plaintext highlighter-rouge">upsert</code> 的文档信息。</li></ul><h2 id="排序">排序</h2><p><code class="language-plaintext highlighter-rouge">org.springframework.data.domain.Sort</code> 是 Spring Data 中用于排序查询结果的类，它封装了排序逻辑并用于指定查询时的排序规则。可以使用 <code class="language-plaintext highlighter-rouge">Sort</code> 来按照指定字段升序或降序排列数据，通常与分页（<code class="language-plaintext highlighter-rouge">Pageable</code>）和查询（<code class="language-plaintext highlighter-rouge">Query</code>）配合使用。</p><p><code class="language-plaintext highlighter-rouge">Sort</code> 的作用是定义数据库查询的排序方式，指定某个字段按升序或降序排列。你可以基于多个字段进行排序，甚至在不同字段上指定不同的排序方向（升序或降序）。</p><p>常用方法</p><p><strong><code class="language-plaintext highlighter-rouge">Sort.by(String... properties)</code></strong>：根据属性名生成排序对象，默认是升序排序。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"age"</span><span class="o">);</span>  <span class="c1">// 按 name 和 age 字段升序排序</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Sort.by(Sort.Order... orders)</code></strong>：根据多个 <code class="language-plaintext highlighter-rouge">Sort.Order</code> 对象创建排序对象，每个字段可以自定义升序或降序。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span>
   <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span>      <span class="c1">// 按 name 升序</span>
   <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span>       <span class="c1">// 按 age 降序</span>
<span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Sort.by(List&lt;Sort.Order&gt; orders)</code></strong>：使用 <code class="language-plaintext highlighter-rouge">List&lt;Sort.Order&gt;</code> 对象创建排序规则。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
   <span class="k">new</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">),</span>
   <span class="k">new</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"age"</span><span class="o">)</span>
<span class="o">);</span>
<span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Sort.Order.asc(String property)</code></strong>：创建按指定字段升序排序的 <code class="language-plaintext highlighter-rouge">Order</code> 对象。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>  <span class="c1">// 按 name 升序排序</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Sort.Order.desc(String property)</code></strong>：创建按指定字段降序排序的 <code class="language-plaintext highlighter-rouge">Order</code> 对象。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="s">"age"</span><span class="o">);</span>  <span class="c1">// 按 age 降序排序</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Sort.with(Sort.Direction direction, String... properties)</code></strong>：指定排序方向和多个字段。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">,</span> <span class="s">"age"</span><span class="o">);</span>  <span class="c1">// 按 name 和 age 升序排序</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">and(Sort sort)</code></strong>：将两个 <code class="language-plaintext highlighter-rouge">Sort</code> 对象组合，等同于 SQL 中多个字段排序。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort1</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
<span class="nc">Sort</span> <span class="n">sort2</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="s">"age"</span><span class="o">);</span>
<span class="nc">Sort</span> <span class="n">combinedSort</span> <span class="o">=</span> <span class="n">sort1</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">sort2</span><span class="o">);</span>  <span class="c1">// 先按 name 升序，然后按 age 升序排序</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getOrderFor(String property)</code></strong>：获取指定属性的排序规则。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
<span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">sort</span><span class="o">.</span><span class="na">getOrderFor</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="na">getDirection</span><span class="o">());</span>  <span class="c1">// 输出: ASC</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">descending()</code></strong>：转换当前排序对象为降序排序。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">descending</span><span class="o">();</span>  <span class="c1">// 按 name 降序排序</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">ascending()</code></strong>：转换当前排序对象为升序排序。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">ascending</span><span class="o">();</span>  <span class="c1">// 按 name 升序排序</span>
</code></pre></div></div><p><strong>常用字段</strong></p><p><strong><code class="language-plaintext highlighter-rouge">Sort.Direction</code></strong>: 枚举类，表示排序方向，有两个可能的值：</p><ul><li><code class="language-plaintext highlighter-rouge">ASC</code>（升序）</li><li><code class="language-plaintext highlighter-rouge">DESC</code>（降序）</li></ul><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">);</span>  <span class="c1">// 按 name 字段升序排序</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Sort.Order</code></strong>: 封装了排序规则的对象，可以指定排序方向、字段和忽略大小写等参数。常用字段:</p><ul><li><code class="language-plaintext highlighter-rouge">property</code>：要排序的字段名。</li><li><code class="language-plaintext highlighter-rouge">direction</code>：排序方向，<code class="language-plaintext highlighter-rouge">ASC</code> 或 <code class="language-plaintext highlighter-rouge">DESC</code>。</li><li><code class="language-plaintext highlighter-rouge">ignoreCase</code>：是否忽略大小写。</li></ul><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">);</span>
</code></pre></div></div><p><strong>示例</strong></p><p>单字段排序：按 <code class="language-plaintext highlighter-rouge">name</code> 升序排序:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">,</span> <span class="s">"name"</span><span class="o">);</span>
</code></pre></div></div><p>多字段排序：按 <code class="language-plaintext highlighter-rouge">name</code> 升序、<code class="language-plaintext highlighter-rouge">age</code> 降序排序:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span>
    <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">asc</span><span class="o">(</span><span class="s">"name"</span><span class="o">),</span>
    <span class="nc">Sort</span><span class="o">.</span><span class="na">Order</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="s">"age"</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div><p>与分页结合</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
<span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span>
</code></pre></div></div><h2 id="分页">分页</h2><p>在 Spring Data 中，分页查询是非常常见的功能。<code class="language-plaintext highlighter-rouge">PageRequest</code> 和 <code class="language-plaintext highlighter-rouge">Pageable</code> 是用于定义分页和排序的核心类，通常与 <code class="language-plaintext highlighter-rouge">Page</code> 和 <code class="language-plaintext highlighter-rouge">Slice</code> 类一起使用来获取分页后的数据结果。</p><p><strong><code class="language-plaintext highlighter-rouge">PageRequest</code></strong> <code class="language-plaintext highlighter-rouge">PageRequest</code> 是 <code class="language-plaintext highlighter-rouge">Pageable</code> 的实现类，用于创建分页请求对象，包含分页和排序的信息。</p><p>常用方法</p><p><strong><code class="language-plaintext highlighter-rouge">PageRequest.of(int page, int size)</code></strong>：创建一个分页请求对象，指定页码和每页大小。<strong>参数</strong>:</p><ul><li><code class="language-plaintext highlighter-rouge">page</code>: 页码（从 0 开始）。</li><li><code class="language-plaintext highlighter-rouge">size</code>: 每页的记录数。</li></ul><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span> <span class="c1">// 第 1 页，每页 10 条记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">PageRequest.of(int page, int size, Sort sort)</code></strong>：创建带排序功能的分页请求。<strong>参数</strong>:</p><ul><li><code class="language-plaintext highlighter-rouge">page</code>: 页码。</li><li><code class="language-plaintext highlighter-rouge">size</code>: 每页大小。</li><li><code class="language-plaintext highlighter-rouge">sort</code>: 排序规则。</li></ul><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">ascending</span><span class="o">());</span> <span class="c1">// 第 1 页，按 name 升序，每页 10 条记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">PageRequest.previous()</code></strong>：返回上一页的 <code class="language-plaintext highlighter-rouge">PageRequest</code> 对象，如果是第一页则返回第一页。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Pageable</span> <span class="n">previousPage</span> <span class="o">=</span> <span class="n">pageable</span><span class="o">.</span><span class="na">previous</span><span class="o">();</span> <span class="c1">// 获取上一页的分页信息</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">PageRequest.next()</code></strong>：返回下一页的 <code class="language-plaintext highlighter-rouge">PageRequest</code> 对象。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Pageable</span> <span class="n">nextPage</span> <span class="o">=</span> <span class="n">pageable</span><span class="o">.</span><span class="na">next</span><span class="o">();</span> <span class="c1">// 获取下一页的分页信息</span>
</code></pre></div></div><p>常用字段 <code class="language-plaintext highlighter-rouge">PageRequest</code> 主要实现自 <code class="language-plaintext highlighter-rouge">Pageable</code>，常用的字段来自 <code class="language-plaintext highlighter-rouge">Pageable</code> 接口：</p><ul><li><code class="language-plaintext highlighter-rouge">page</code>: 页码（从 0 开始）。</li><li><code class="language-plaintext highlighter-rouge">size</code>: 每页的大小。</li><li><code class="language-plaintext highlighter-rouge">sort</code>: 排序规则（<code class="language-plaintext highlighter-rouge">Sort</code> 对象）。</li></ul><hr /><p><strong><code class="language-plaintext highlighter-rouge">Pageable</code></strong> <code class="language-plaintext highlighter-rouge">Pageable</code> 是分页信息的接口，用于定义分页和排序规则。</p><p>常用方法</p><p><strong><code class="language-plaintext highlighter-rouge">getPageNumber()</code></strong>：返回当前页码（从 0 开始）。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pageNumber</span> <span class="o">=</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getPageNumber</span><span class="o">();</span> <span class="c1">// 获取当前页码</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getPageSize()</code></strong>：返回每页的大小。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getPageSize</span><span class="o">();</span> <span class="c1">// 获取每页记录数</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getOffset()</code></strong>：返回从哪条记录开始查询（偏移量）。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getOffset</span><span class="o">();</span> <span class="c1">// 获取查询的起始记录索引</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getSort()</code></strong>：返回当前的排序规则。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Sort</span> <span class="n">sort</span> <span class="o">=</span> <span class="n">pageable</span><span class="o">.</span><span class="na">getSort</span><span class="o">();</span> <span class="c1">// 获取排序规则</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">isPaged()</code></strong>：检查是否分页。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">paged</span> <span class="o">=</span> <span class="n">pageable</span><span class="o">.</span><span class="na">isPaged</span><span class="o">();</span> <span class="c1">// 判断是否分页</span>
</code></pre></div></div><hr /><p><strong><code class="language-plaintext highlighter-rouge">Page</code></strong> <code class="language-plaintext highlighter-rouge">Page</code> 是一个接口，用于封装分页结果集，通常包含分页的元信息（如总页数、总记录数、当前页）以及数据列表。</p><p>常用方法</p><p><strong><code class="language-plaintext highlighter-rouge">getContent()</code></strong>：返回当前页的数据内容。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span> <span class="c1">// 获取当前页的用户列表</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getTotalElements()</code></strong>：返回总记录数。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">();</span> <span class="c1">// 获取总记录数</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getTotalPages()</code></strong>：返回总页数。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">totalPages</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">();</span> <span class="c1">// 获取总页数</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getNumber()</code></strong>：返回当前页码（从 0 开始）。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pageNumber</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getNumber</span><span class="o">();</span> <span class="c1">// 获取当前页码</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getSize()</code></strong>：返回每页大小。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getSize</span><span class="o">();</span> <span class="c1">// 获取每页记录数</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">hasNext()</code></strong>：判断是否有下一页。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">hasNext</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="c1">// 判断是否有下一页</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">hasPrevious()</code></strong>：判断是否有上一页。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">hasPrevious</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">hasPrevious</span><span class="o">();</span> <span class="c1">// 判断是否有上一页</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">isFirst()</code></strong>：判断是否为第一页。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">isFirst</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">isFirst</span><span class="o">();</span> <span class="c1">// 判断是否是第一页</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">isLast()</code></strong>：判断是否为最后一页。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">isLast</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">isLast</span><span class="o">();</span> <span class="c1">// 判断是否是最后一页</span>
</code></pre></div></div><hr /><p><strong><code class="language-plaintext highlighter-rouge">Slice</code></strong> <code class="language-plaintext highlighter-rouge">Slice</code> 是分页的一种轻量级版本，它不包含总页数和总记录数的信息，只提供当前页的数据和是否存在下一页的标志。</p><p>常用方法</p><p><strong><code class="language-plaintext highlighter-rouge">getContent()</code></strong>：返回当前页的数据内容。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">slice</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span> <span class="c1">// 获取当前页的用户列表</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">hasNext()</code></strong>：判断是否有下一页。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">boolean</span> <span class="n">hasNext</span> <span class="o">=</span> <span class="n">slice</span><span class="o">.</span><span class="na">hasNext</span><span class="o">();</span> <span class="c1">// 判断是否有下一页</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getNumber()</code></strong>：返回当前页码。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pageNumber</span> <span class="o">=</span> <span class="n">slice</span><span class="o">.</span><span class="na">getNumber</span><span class="o">();</span> <span class="c1">// 获取当前页码</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">getSize()</code></strong>：返回每页大小。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">slice</span><span class="o">.</span><span class="na">getSize</span><span class="o">();</span> <span class="c1">// 获取每页记录数</span>
</code></pre></div></div><hr /><p>实例代码</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.domain.Page</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.PageRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Pageable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.domain.Sort</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UserService</span><span class="o">(</span><span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">userRepository</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 分页查询</span>
    <span class="kd">public</span> <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">getUsersByPage</span><span class="o">(</span><span class="kt">int</span> <span class="n">page</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">Pageable</span> <span class="n">pageable</span> <span class="o">=</span> <span class="nc">PageRequest</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">page</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">ascending</span><span class="o">());</span>
   <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">(</span><span class="n">pageable</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 获取分页结果</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">printPagedUsers</span><span class="o">()</span> <span class="o">{</span>
   <span class="nc">Page</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">getUsersByPage</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>

   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total Elements: "</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="na">getTotalElements</span><span class="o">());</span> <span class="c1">// 总记录数</span>
   <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Total Pages: "</span> <span class="o">+</span> <span class="n">page</span><span class="o">.</span><span class="na">getTotalPages</span><span class="o">());</span>  <span class="c1">// 总页数</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">page</span><span class="o">.</span><span class="na">getContent</span><span class="o">())</span> <span class="o">{</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
   <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>总结</p><ul><li><code class="language-plaintext highlighter-rouge">Pageable</code> 用于定义分页和排序的逻辑。</li><li><code class="language-plaintext highlighter-rouge">PageRequest</code> 是 <code class="language-plaintext highlighter-rouge">Pageable</code> 的具体实现类，帮助我们创建分页和排序请求。</li><li><code class="language-plaintext highlighter-rouge">Page</code> 接口封装了分页后的数据和分页信息（总记录数、总页数等）。</li><li><code class="language-plaintext highlighter-rouge">Slice</code> 类提供类似分页的功能，但不包含总页数等信息，适用于更轻量级的分页场景。</li></ul><p>这些类一起使用，可以很方便地在 Spring Data 中实现分页查询功能。</p><h2 id="聚合">聚合</h2><p><code class="language-plaintext highlighter-rouge">Aggregation</code> 是 Spring Data MongoDB 中用于执行复杂数据处理操作的一个工具，类似于 MongoDB 的 <code class="language-plaintext highlighter-rouge">aggregate</code> 操作。它允许对文档执行聚合查询，例如分组、过滤、排序、投影、联表查询等。下面是聚合操作中常用的类、方法、字段的详细解释与实例。</p><hr /><p><strong><code class="language-plaintext highlighter-rouge">Aggregation</code> 类常用方法：</strong></p><p><strong><code class="language-plaintext highlighter-rouge">Aggregation.newAggregation(AggregationOperation... operations)</code></strong>：用于创建聚合管道，接受一系列的 <code class="language-plaintext highlighter-rouge">AggregationOperation</code> 作为参数。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span>
    <span class="nc">Aggregation</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">25</span><span class="o">)),</span>  <span class="c1">// 匹配 age 大于 25 的文档</span>
    <span class="nc">Aggregation</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="s">"department"</span><span class="o">).</span><span class="na">count</span><span class="o">().</span><span class="na">as</span><span class="o">(</span><span class="s">"totalEmployees"</span><span class="o">),</span>  <span class="c1">// 按 department 分组并统计每组员工数</span>
    <span class="nc">Aggregation</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"totalEmployees"</span><span class="o">))</span>  <span class="c1">// 按 totalEmployees 降序排序</span>
<span class="o">);</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Aggregation.match(Criteria criteria)</code></strong>：用于定义筛选条件，相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">WHERE</code> 语句。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AggregationOperation</span> <span class="n">matchOperation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gte</span><span class="o">(</span><span class="mi">30</span><span class="o">));</span>  <span class="c1">// 筛选 age 大于等于 30 的记录</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Aggregation.group(String... fields)</code></strong>：按字段分组，类似 SQL 的 <code class="language-plaintext highlighter-rouge">GROUP BY</code>，并且可以在分组后进行数据计算。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AggregationOperation</span> <span class="n">groupOperation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="s">"department"</span><span class="o">)</span>  <span class="c1">// 按 department 字段分组</span>
    <span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="s">"salary"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"totalSalary"</span><span class="o">)</span>  <span class="c1">// 计算每个部门的薪资总和</span>
    <span class="o">.</span><span class="na">avg</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"averageAge"</span><span class="o">);</span>  <span class="c1">// 计算每个部门的平均年龄</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">fields</code>可以为空，也可以是多个字段。常见的聚合方法有：<code class="language-plaintext highlighter-rouge">count</code>、<code class="language-plaintext highlighter-rouge">sum</code>、<code class="language-plaintext highlighter-rouge">avg</code>、<code class="language-plaintext highlighter-rouge">min</code>、<code class="language-plaintext highlighter-rouge">max</code>。</p><p>对于多字段分组，返回的结果通常是一个包含分组键和聚合结果的文档列表。每个文档代表一个分组，包含所分组的字段及其对应的聚合结果。以下是一个示例来说明这种结构：</p><p><strong>示例场景</strong> 假设有一个集合存储用户信息，其中有 <code class="language-plaintext highlighter-rouge">gender</code>（性别）、<code class="language-plaintext highlighter-rouge">department</code>（部门）和 <code class="language-plaintext highlighter-rouge">age</code>（年龄）等字段。你希望按 <code class="language-plaintext highlighter-rouge">gender</code> 和 <code class="language-plaintext highlighter-rouge">department</code> 分组，并计算每组的平均年龄。</p><p><strong>MongoDB 聚合查询</strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span>
    <span class="nc">Aggregation</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="s">"gender"</span><span class="o">,</span> <span class="s">"department"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">avg</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"averageAge"</span><span class="o">)</span>
<span class="o">);</span>
</code></pre></div></div><p>假设你的集合中有以下数据：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"male"</span><span class="p">,</span><span class="w"> </span><span class="nl">"department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IT"</span><span class="p">,</span><span class="w"> </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"male"</span><span class="p">,</span><span class="w"> </span><span class="nl">"department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IT"</span><span class="p">,</span><span class="w"> </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">35</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"female"</span><span class="p">,</span><span class="w"> </span><span class="nl">"department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HR"</span><span class="p">,</span><span class="w"> </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"female"</span><span class="p">,</span><span class="w"> </span><span class="nl">"department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HR"</span><span class="p">,</span><span class="w"> </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div><p>经过聚合后，返回的结果可能如下所示：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"male"</span><span class="p">,</span><span class="w"> </span><span class="nl">"department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"IT"</span><span class="p">,</span><span class="w"> </span><span class="nl">"averageAge"</span><span class="p">:</span><span class="w"> </span><span class="mf">32.5</span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"gender"</span><span class="p">:</span><span class="w"> </span><span class="s2">"female"</span><span class="p">,</span><span class="w"> </span><span class="nl">"department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HR"</span><span class="p">,</span><span class="w"> </span><span class="nl">"averageAge"</span><span class="p">:</span><span class="w"> </span><span class="mf">30.0</span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div><ul><li>每个文档中的 <code class="language-plaintext highlighter-rouge">_id</code> 字段包含了分组字段（如 <code class="language-plaintext highlighter-rouge">gender</code> 和 <code class="language-plaintext highlighter-rouge">department</code>）。</li><li><code class="language-plaintext highlighter-rouge">averageAge</code> 字段是对该分组的 <code class="language-plaintext highlighter-rouge">age</code> 字段进行计算的聚合结果。</li></ul><p>对于分组字段，有以下规则：</p><p><strong>没有设置分组依据</strong>：</p><ul><li>MongoDB 会将所有文档视为一个整体进行全局聚合。</li><li>返回的数据会包含一个 <code class="language-plaintext highlighter-rouge">_id</code> 字段，其值为 <code class="language-plaintext highlighter-rouge">null</code>。</li></ul><p><strong>有一个字段分组</strong>（如 <code class="language-plaintext highlighter-rouge">Aggregation.group("gender")</code>）：</p><ul><li>返回的数据会多一个 <code class="language-plaintext highlighter-rouge">_id</code> 字段，其值为 <code class="language-plaintext highlighter-rouge">gender</code> 列的分组结果。</li><li>这确实有点扭曲，因为它似乎是将分组的字段变成了一个额外的标识符。</li></ul><p><strong>有多个字段分组</strong>：</p><ul><li>如果设置了多个分组依据，返回的数据将根据每个分组依据的值组织，而不再有额外的 <code class="language-plaintext highlighter-rouge">_id</code> 字段。</li><li>每个分组依据将作为返回结果中的一列。</li></ul><p>如果只分组不聚合，MongoDB 会返回每个组的文档，效果同上。</p><p><strong><code class="language-plaintext highlighter-rouge">Aggregation.project(String... fields)</code></strong>：用于选择输出的字段，相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">SELECT</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AggregationOperation</span> <span class="n">projectOperation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"department"</span><span class="o">,</span> <span class="s">"totalSalary"</span><span class="o">)</span>  <span class="c1">// 选择输出字段</span>
    <span class="o">.</span><span class="na">andExpression</span><span class="o">(</span><span class="s">"totalSalary / 1000"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"salaryInThousands"</span><span class="o">);</span>  <span class="c1">// 添加计算字段</span>
</code></pre></div></div><p>如果用类似：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">().</span><span class="na">and</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"amount"</span><span class="o">);</span> <span class="c1">//别名</span>
</code></pre></div></div><p>的方式设置别名，那么原来的列<code class="language-plaintext highlighter-rouge">data.email</code>将不存在，原来的列会被替换为别名<code class="language-plaintext highlighter-rouge">amount</code>。</p><p>你可能会觉得：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">and</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"amount"</span><span class="o">);</span> <span class="c1">//别名</span>
</code></pre></div></div><p>会保留原列，但实际上不会，它会将 <code class="language-plaintext highlighter-rouge">data.email</code> 替换为 <code class="language-plaintext highlighter-rouge">amount</code>。</p><p><strong>要保留原字段，则需要这样写：</strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">()</span>
    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"amount"</span><span class="o">);</span> <span class="c1">//别名</span>
	<span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">)</span> <span class="c1">// 原字段</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Aggregation.sort(Sort sort)</code></strong>：对聚合结果进行排序，类似于 SQL 中的 <code class="language-plaintext highlighter-rouge">ORDER BY</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AggregationOperation</span> <span class="n">sortOperation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"totalSalary"</span><span class="o">));</span>  <span class="c1">// 按 totalSalary 降序排序</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Aggregation.limit(long maxSize)</code></strong>：限制聚合结果的条数，相当于 SQL 中的 <code class="language-plaintext highlighter-rouge">LIMIT</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AggregationOperation</span> <span class="n">limitOperation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>  <span class="c1">// 限制结果返回前 5 条</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Aggregation.skip(long elementsToSkip)</code></strong>：跳过指定数量的文档，类似于 SQL 中的 <code class="language-plaintext highlighter-rouge">OFFSET</code>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AggregationOperation</span> <span class="n">skipOperation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">skip</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>  <span class="c1">// 跳过前 10 条记录</span>
</code></pre></div></div><hr /><p><strong>常用类与方法：</strong></p><p><strong><code class="language-plaintext highlighter-rouge">AggregationOperation</code></strong>：表示聚合操作的接口，每一个具体的聚合步骤都是它的实现类。</p><ul><li><code class="language-plaintext highlighter-rouge">Aggregation.match(Criteria criteria)</code>：用于筛选数据，等同于 MongoDB 的 <code class="language-plaintext highlighter-rouge">$match</code> 操作。</li><li><code class="language-plaintext highlighter-rouge">Aggregation.group(String... fields)</code>：用于分组数据，等同于 MongoDB 的 <code class="language-plaintext highlighter-rouge">$group</code> 操作。</li><li><code class="language-plaintext highlighter-rouge">Aggregation.project(String... fields)</code>：用于选择和转换数据，等同于 MongoDB 的 <code class="language-plaintext highlighter-rouge">$project</code> 操作。</li><li><code class="language-plaintext highlighter-rouge">Aggregation.sort(Sort sort)</code>：用于排序数据，等同于 MongoDB 的 <code class="language-plaintext highlighter-rouge">$sort</code> 操作。</li><li><code class="language-plaintext highlighter-rouge">Aggregation.limit(long maxSize)</code>：用于限制结果集的大小，等同于 MongoDB 的 <code class="language-plaintext highlighter-rouge">$limit</code> 操作。</li><li><code class="language-plaintext highlighter-rouge">Aggregation.skip(long elementsToSkip)</code>：用于跳过指定数量的文档，等同于 MongoDB 的 <code class="language-plaintext highlighter-rouge">$skip</code> 操作。</li></ul><hr /><p><strong><code class="language-plaintext highlighter-rouge">AggregationResults&lt;T&gt;</code></strong>：表示聚合操作的结果集，封装了返回的数据。</p><p><strong>常用方法：</strong></p><p><strong><code class="language-plaintext highlighter-rouge">getMappedResults()</code></strong>：返回经过映射后的聚合结果列表。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AggregationResults</span><span class="o">&lt;</span><span class="nc">EmployeeStats</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">aggregation</span><span class="o">,</span> <span class="s">"employees"</span><span class="o">,</span> <span class="nc">EmployeeStats</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">EmployeeStats</span><span class="o">&gt;</span> <span class="n">statsList</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">getMappedResults</span><span class="o">();</span>  <span class="c1">// 获取聚合结果</span>
</code></pre></div></div><hr /><p><strong>实例代码：</strong></p><p>假设有一个员工集合 <code class="language-plaintext highlighter-rouge">employees</code>，结构如下：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Alice"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
  </span><span class="nl">"department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HR"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"salary"</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>下面是一个完整的聚合操作实例，查询年龄大于 25 岁的员工，按部门分组统计每个部门的总薪资，并按总薪资降序排序，只返回前 3 个部门。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建匹配操作，筛选出 age &gt; 25 的文档</span>
<span class="nc">AggregationOperation</span> <span class="n">match</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">25</span><span class="o">));</span>

<span class="c1">// 创建分组操作，按 department 字段分组并计算总薪资</span>
<span class="nc">AggregationOperation</span> <span class="n">group</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="s">"department"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="s">"salary"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"totalSalary"</span><span class="o">);</span>

<span class="c1">// 创建排序操作，按 totalSalary 降序排序</span>
<span class="nc">AggregationOperation</span> <span class="n">sort</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">by</span><span class="o">(</span><span class="nc">Sort</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">DESC</span><span class="o">,</span> <span class="s">"totalSalary"</span><span class="o">));</span>

<span class="c1">// 创建限制操作，只返回前 3 条结果</span>
<span class="nc">AggregationOperation</span> <span class="n">limit</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

<span class="c1">// 创建聚合对象，将所有操作串联</span>
<span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span><span class="n">match</span><span class="o">,</span> <span class="n">group</span><span class="o">,</span> <span class="n">sort</span><span class="o">,</span> <span class="n">limit</span><span class="o">);</span>

<span class="c1">// 执行聚合查询</span>
<span class="nc">AggregationResults</span><span class="o">&lt;</span><span class="nc">DepartmentStats</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">aggregation</span><span class="o">,</span> <span class="s">"employees"</span><span class="o">,</span> <span class="nc">DepartmentStats</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 获取并输出聚合结果</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">DepartmentStats</span><span class="o">&gt;</span> <span class="n">departmentStats</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="na">getMappedResults</span><span class="o">();</span>
<span class="n">departmentStats</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">stat</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">stat</span><span class="o">.</span><span class="na">getDepartment</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">stat</span><span class="o">.</span><span class="na">getTotalSalary</span><span class="o">()));</span>
</code></pre></div></div><p>在这个例子中，<code class="language-plaintext highlighter-rouge">DepartmentStats</code> 是一个映射聚合结果的类，它包含 <code class="language-plaintext highlighter-rouge">department</code> 和 <code class="language-plaintext highlighter-rouge">totalSalary</code> 两个字段，用来接收分组后的结果。</p><h2 id="投影">投影</h2><p>投影是在 MongoDB 中用于控制查询结果中返回哪些字段的操作，类似于 SQL 中的 <code class="language-plaintext highlighter-rouge">SELECT</code> 子句。通过投影，您可以只选择您关心的字段，从而减少传输的数据量，提高查询效率。</p><p>在 Spring Data MongoDB 中，投影操作主要通过 <code class="language-plaintext highlighter-rouge">Aggregation.project()</code> 方法来实现，此外，在简单查询中也可以通过 <code class="language-plaintext highlighter-rouge">Query.fields()</code> 方法实现。</p><hr /><p><strong>投影操作相关类与方法：</strong></p><p><strong><code class="language-plaintext highlighter-rouge">Aggregation.project(String... fields)</code></strong>：用于选择并格式化输出的字段。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AggregationOperation</span> <span class="n">projectOperation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"salary"</span><span class="o">)</span>  <span class="c1">// 选择输出 name 和 salary 字段</span>
    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="s">"department"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"dept"</span><span class="o">);</span>  <span class="c1">// 重命名 department 字段为 dept</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Query.fields()</code></strong>：在简单查询中指定需要返回的字段，不能重命名字段。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"age"</span><span class="o">).</span><span class="na">gt</span><span class="o">(</span><span class="mi">25</span><span class="o">));</span>  <span class="c1">// 筛选条件</span>
<span class="n">query</span><span class="o">.</span><span class="na">fields</span><span class="o">().</span><span class="na">include</span><span class="o">(</span><span class="s">"name"</span><span class="o">).</span><span class="na">include</span><span class="o">(</span><span class="s">"salary"</span><span class="o">);</span>  <span class="c1">// 仅返回 name 和 salary 字段</span>
</code></pre></div></div><hr /><p><strong>投影的作用与优势：</strong></p><ul><li><strong>减少数据量</strong>：只选择需要的字段，减少了网络传输和存储的开销。</li><li><strong>提高性能</strong>：减少了 MongoDB 返回的数据量，从而提高了查询性能。</li><li><strong>自定义输出</strong>：可以通过 <code class="language-plaintext highlighter-rouge">Aggregation.project()</code> 进行字段重命名或计算新字段，提供更灵活的输出。</li></ul><hr /><p><strong>实例代码：</strong></p><p>假设我们有一个员工集合 <code class="language-plaintext highlighter-rouge">employees</code>，结构如下：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Alice"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
  </span><span class="nl">"department"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HR"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"salary"</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>下面是一个使用聚合投影的示例，查询所有员工的姓名和薪资，同时重命名 <code class="language-plaintext highlighter-rouge">department</code> 字段为 <code class="language-plaintext highlighter-rouge">dept</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建聚合投影操作</span>
<span class="nc">AggregationOperation</span> <span class="n">project</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"salary"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="s">"department"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"dept"</span><span class="o">);</span>  <span class="c1">// 重命名 department 字段为 dept</span>

<span class="c1">// 创建聚合对象</span>
<span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span><span class="n">project</span><span class="o">);</span>

<span class="c1">// 执行聚合查询</span>
<span class="nc">AggregationResults</span><span class="o">&lt;</span><span class="nc">EmployeeProjection</span><span class="o">&gt;</span> <span class="n">results</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">aggregation</span><span class="o">,</span> <span class="s">"employees"</span><span class="o">,</span> <span class="nc">EmployeeProjection</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 获取并输出投影结果</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">EmployeeProjection</span><span class="o">&gt;</span> <span class="n">projections</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="na">getMappedResults</span><span class="o">();</span>
<span class="n">projections</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">proj</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Name: "</span> <span class="o">+</span> <span class="n">proj</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">", Salary: "</span> <span class="o">+</span> <span class="n">proj</span><span class="o">.</span><span class="na">getSalary</span><span class="o">()</span> <span class="o">+</span> <span class="s">", Department: "</span> <span class="o">+</span> <span class="n">proj</span><span class="o">.</span><span class="na">getDept</span><span class="o">()));</span>
</code></pre></div></div><p>在这个例子中，<code class="language-plaintext highlighter-rouge">EmployeeProjection</code> 是一个用于映射投影结果的类，包含 <code class="language-plaintext highlighter-rouge">name</code>、<code class="language-plaintext highlighter-rouge">salary</code> 和 <code class="language-plaintext highlighter-rouge">dept</code> 三个字段，用来接收查询结果。</p><h2 id="日志">日志</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">logging</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span>
    <span class="na">root</span><span class="pi">:</span> <span class="s">${LOG_LEVE:info}</span>
    <span class="na">org.springframework.data.mongodb.core</span><span class="pi">:</span> <span class="s">DEBUG</span>
    <span class="na">org.mongodb.driver.protocol</span><span class="pi">:</span> <span class="s">WARN</span>
</code></pre></div></div><h2 id="数据转换">数据转换</h2><p><code class="language-plaintext highlighter-rouge">ConvertOperators</code> 是 Spring Data MongoDB 中用于字段类型转换的类。它提供了多个方法来将字段转换为不同的数据类型，常见的用法包括：</p><ol><li><strong><code class="language-plaintext highlighter-rouge">ConvertOperators.Convert.convertValueOf(String field)</code></strong>：用于指定需要转换的字段。</li><li><strong><code class="language-plaintext highlighter-rouge">.to(String type)</code></strong>：指定目标数据类型，<code class="language-plaintext highlighter-rouge">double</code>、<code class="language-plaintext highlighter-rouge">string</code>、<code class="language-plaintext highlighter-rouge">objectId</code>、<code class="language-plaintext highlighter-rouge">bool</code>、<code class="language-plaintext highlighter-rouge">date</code>、<code class="language-plaintext highlighter-rouge">int</code>、<code class="language-plaintext highlighter-rouge">long</code>、<code class="language-plaintext highlighter-rouge">decimal</code>。</li></ol><p>使用示例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ConvertOperators</span><span class="o">.</span><span class="na">Convert</span><span class="o">.</span><span class="na">convertValueOf</span><span class="o">(</span><span class="s">"fieldName"</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="s">"decimal"</span><span class="o">);</span>
</code></pre></div></div><p>这种转换在聚合操作中非常有用，可以在数据处理时确保字段的类型符合预期，从而避免类型错误。</p><p>示例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建投影操作进行字段转换</span>
<span class="nc">ProjectionOperation</span> <span class="n">projectStage</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="nc">ConvertOperators</span><span class="o">.</span><span class="na">Convert</span><span class="o">.</span><span class="na">convertValueOf</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="s">"decimal"</span><span class="o">).</span><span class="na">onErrorReturn</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">onNullReturn</span><span class="o">(</span><span class="mi">0</span><span class="o">)).</span><span class="na">as</span><span class="o">(</span><span class="s">"amount"</span><span class="o">);</span> <span class="c1">//别名</span>

<span class="c1">// 创建聚合操作</span>
<span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span>
        <span class="nc">Aggregation</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">exists</span><span class="o">(</span><span class="kc">true</span><span class="o">)),</span>
        <span class="n">projectStage</span><span class="o">,</span>
        <span class="nc">Aggregation</span><span class="o">.</span><span class="na">group</span><span class="o">()</span>
                <span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="s">"amount"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"totalAmount"</span><span class="o">)</span>
<span class="o">);</span>
<span class="nc">Map</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">aggregation</span><span class="o">,</span> <span class="s">"co_common_test1"</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getMappedResults</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="nc">Decimal128</span> <span class="n">totalAmount</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Decimal128</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"totalAmount"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">totalAmount</span><span class="o">);</span>
</code></pre></div></div><p>这段代码的目的是在 MongoDB 中进行聚合操作，将 <code class="language-plaintext highlighter-rouge">data.email</code> 字段转换为十进制格式，并计算总和。具体步骤如下：</p><ol><li><strong>投影操作 (<code class="language-plaintext highlighter-rouge">ProjectionOperation</code>)</strong>：<ul><li>使用 <code class="language-plaintext highlighter-rouge">Aggregation.project("data.email")</code> 创建一个投影阶段，保留 <code class="language-plaintext highlighter-rouge">data.email</code> 字段。</li><li>通过 <code class="language-plaintext highlighter-rouge">ConvertOperators.Convert.convertValueOf("data.email").to("decimal").as("amount")</code> 将 <code class="language-plaintext highlighter-rouge">data.email</code> 转换为十进制格式，并给它起一个别名 <code class="language-plaintext highlighter-rouge">amount</code>。</li></ul></li><li><strong>聚合操作 (<code class="language-plaintext highlighter-rouge">Aggregation</code>)</strong>：<ul><li>创建一个新的聚合管道，首先通过 <code class="language-plaintext highlighter-rouge">Aggregation.match(Criteria.where("data.email").exists(true))</code> 过滤出存在 <code class="language-plaintext highlighter-rouge">data.email</code> 字段的文档。</li><li>然后应用之前定义的投影阶段。</li><li>最后，使用 <code class="language-plaintext highlighter-rouge">Aggregation.group().sum("amount").as("totalAmount")</code> 聚合阶段，对转换后的 <code class="language-plaintext highlighter-rouge">amount</code> 字段进行求和，并将结果命名为 <code class="language-plaintext highlighter-rouge">totalAmount</code>。</li></ul></li><li><strong>执行聚合</strong>：<ul><li>使用 <code class="language-plaintext highlighter-rouge">mongoTemplate.aggregate()</code> 方法执行聚合操作，查询 <code class="language-plaintext highlighter-rouge">co_common_test1</code> 集合，并将结果映射为 <code class="language-plaintext highlighter-rouge">Map</code> 对象。</li><li>从结果中获取 <code class="language-plaintext highlighter-rouge">totalAmount</code>，并打印出来。</li></ul></li></ol><p>这段代码主要实现了对 <code class="language-plaintext highlighter-rouge">data.email</code> 字段的类型转换和求和操作，目的是在处理数据时确保数值类型的正确性。</p><p>要对多个字段进行转换，可以在投影操作中连续添加多个转换。例如，假设你有 <code class="language-plaintext highlighter-rouge">data.email</code> 和 <code class="language-plaintext highlighter-rouge">data.amount</code> 两个字段要转换为十进制，可以如下操作：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建投影操作进行多个字段转换</span>
<span class="nc">ProjectionOperation</span> <span class="n">projectStage</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">project</span><span class="o">()</span>
        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="nc">ConvertOperators</span><span class="o">.</span><span class="na">Convert</span><span class="o">.</span><span class="na">convertValueOf</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="s">"decimal"</span><span class="o">)).</span><span class="na">as</span><span class="o">(</span><span class="s">"emailAmount"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="nc">ConvertOperators</span><span class="o">.</span><span class="na">Convert</span><span class="o">.</span><span class="na">convertValueOf</span><span class="o">(</span><span class="s">"data.amount"</span><span class="o">).</span><span class="na">to</span><span class="o">(</span><span class="s">"decimal"</span><span class="o">)).</span><span class="na">as</span><span class="o">(</span><span class="s">"amountAmount"</span><span class="o">);</span> <span class="c1">// 别名</span>

<span class="c1">// 创建聚合操作</span>
<span class="nc">Aggregation</span> <span class="n">aggregation</span> <span class="o">=</span> <span class="nc">Aggregation</span><span class="o">.</span><span class="na">newAggregation</span><span class="o">(</span>
        <span class="nc">Aggregation</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"data.email"</span><span class="o">).</span><span class="na">exists</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">and</span><span class="o">(</span><span class="s">"data.amount"</span><span class="o">).</span><span class="na">exists</span><span class="o">(</span><span class="kc">true</span><span class="o">)),</span>
        <span class="n">projectStage</span><span class="o">,</span>
        <span class="nc">Aggregation</span><span class="o">.</span><span class="na">group</span><span class="o">()</span>
                <span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="s">"emailAmount"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"totalEmailAmount"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="s">"amountAmount"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"totalAmountAmount"</span><span class="o">)</span>
<span class="o">);</span>
<span class="nc">Map</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">aggregate</span><span class="o">(</span><span class="n">aggregation</span><span class="o">,</span> <span class="s">"co_common_test1"</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getMappedResults</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="nc">Decimal128</span> <span class="n">totalEmailAmount</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Decimal128</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"totalEmailAmount"</span><span class="o">);</span>
<span class="nc">Decimal128</span> <span class="n">totalAmountAmount</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Decimal128</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"totalAmountAmount"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">totalEmailAmount</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">totalAmountAmount</span><span class="o">);</span>
</code></pre></div></div><p>在这个示例中：</p><ol><li><strong>投影操作 (<code class="language-plaintext highlighter-rouge">ProjectionOperation</code>)</strong>：<ul><li>使用 <code class="language-plaintext highlighter-rouge">Aggregation.project()</code>，通过 <code class="language-plaintext highlighter-rouge">and()</code> 方法添加多个字段的转换。</li><li>每个字段的转换都使用 <code class="language-plaintext highlighter-rouge">ConvertOperators.Convert.convertValueOf()</code> 方法，并给它们起不同的别名。</li></ul></li><li><strong>聚合操作</strong>：<ul><li>通过 <code class="language-plaintext highlighter-rouge">Aggregation.match()</code> 过滤出存在这两个字段的文档。</li><li>在聚合阶段，分别对转换后的 <code class="language-plaintext highlighter-rouge">emailAmount</code> 和 <code class="language-plaintext highlighter-rouge">amountAmount</code> 字段进行求和。</li></ul></li></ol><p>这样可以轻松处理多个字段的转换和聚合。</p><p>这样打印的值是科学计数法，如果需要打印普通值，则需要使用：<code class="language-plaintext highlighter-rouge">totalAmount.bigDecimalValue().toPlainString()</code>。</p><h2 id="专有document与map的区别">专有Document与Map的区别</h2><p><code class="language-plaintext highlighter-rouge">Document</code> 和 <code class="language-plaintext highlighter-rouge">Map</code> 在 MongoDB 中有一些相似性，但它们在使用和语义上有显著的区别。以下是它们的主要区别：</p><ol><li><strong>类型和设计目的</strong></li></ol><p><strong><code class="language-plaintext highlighter-rouge">Document</code></strong>：在 MongoDB 中，<code class="language-plaintext highlighter-rouge">Document</code> 是一个封装了 BSON 数据的对象，通常用来表示一个文档（即 MongoDB 中的一条记录）。<code class="language-plaintext highlighter-rouge">Document</code> 允许你以键值对的形式存储和查询数据，同时支持嵌套结构，数据的序列化和反序列化是 MongoDB 的核心功能之一。<code class="language-plaintext highlighter-rouge">Document</code> 是 MongoDB Java 驱动中的一个重要类，继承自 <code class="language-plaintext highlighter-rouge">BsonDocument</code>，它是为与 MongoDB 交互而设计的。</p><p><strong><code class="language-plaintext highlighter-rouge">Map</code></strong>：<code class="language-plaintext highlighter-rouge">Map</code> 是 Java 中的一个接口，表示一个映射关系，即将键映射到值的集合。<code class="language-plaintext highlighter-rouge">Map</code> 支持多种实现，如 <code class="language-plaintext highlighter-rouge">HashMap</code>、<code class="language-plaintext highlighter-rouge">TreeMap</code> 等，通常用于存储任意的键值对数据。</p><ol><li><strong>嵌套结构支持</strong></li></ol><p><strong><code class="language-plaintext highlighter-rouge">Document</code></strong>：<code class="language-plaintext highlighter-rouge">Document</code> 本身是一个高度结构化的对象，能够嵌套其他 <code class="language-plaintext highlighter-rouge">Document</code> 或 <code class="language-plaintext highlighter-rouge">List</code> 等类型。这意味着你可以轻松地表示复杂的层次化数据结构。例如，可以存储一个嵌套的对象，表示 MongoDB 中的嵌套文档。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Document</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Document</span><span class="o">();</span>
<span class="n">person</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"John Doe"</span><span class="o">);</span>
<span class="n">person</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"address"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Document</span><span class="o">(</span><span class="s">"street"</span><span class="o">,</span> <span class="s">"123 Main St"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"Anytown"</span><span class="o">));</span>
</code></pre></div></div><p>这个 <code class="language-plaintext highlighter-rouge">Document</code> 会被存储为一个 MongoDB 文档，<code class="language-plaintext highlighter-rouge">address</code> 是一个子文档。</p><p><strong><code class="language-plaintext highlighter-rouge">Map</code></strong>：<code class="language-plaintext highlighter-rouge">Map</code> 只是一个简单的键值对集合，默认没有内建的方式来表示嵌套结构。如果你想在 <code class="language-plaintext highlighter-rouge">Map</code> 中表示嵌套结构，需要手动创建嵌套的 <code class="language-plaintext highlighter-rouge">Map</code> 或使用其他数据结构。例如：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">personMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">addressMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">addressMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"street"</span><span class="o">,</span> <span class="s">"123 Main St"</span><span class="o">);</span>
<span class="n">addressMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"Anytown"</span><span class="o">);</span>
<span class="n">personMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"John Doe"</span><span class="o">);</span>
<span class="n">personMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"address"</span><span class="o">,</span> <span class="n">addressMap</span><span class="o">);</span>
</code></pre></div></div><p>虽然你可以在 <code class="language-plaintext highlighter-rouge">Map</code> 中嵌套 <code class="language-plaintext highlighter-rouge">Map</code>，但是 <code class="language-plaintext highlighter-rouge">Map</code> 本身并不专门设计来处理 MongoDB 的 BSON 类型数据，它只是通用的 Java 数据结构。</p><ol><li><strong>数据类型支持</strong> <strong><code class="language-plaintext highlighter-rouge">Document</code></strong>：<code class="language-plaintext highlighter-rouge">Document</code> 是专为 MongoDB 的 BSON 数据设计的，因此它支持 MongoDB 支持的所有数据类型，包括 <code class="language-plaintext highlighter-rouge">ObjectId</code>、<code class="language-plaintext highlighter-rouge">Decimal128</code>、<code class="language-plaintext highlighter-rouge">Binary</code>、<code class="language-plaintext highlighter-rouge">Date</code>、<code class="language-plaintext highlighter-rouge">Timestamp</code> 等。你可以在 <code class="language-plaintext highlighter-rouge">Document</code> 中使用这些类型，而无需显式地进行转换。</li></ol><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Document</span><span class="o">();</span>
<span class="n">document</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"createdAt"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
<span class="n">document</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"userId"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ObjectId</span><span class="o">());</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">Map</code></strong>：<code class="language-plaintext highlighter-rouge">Map</code> 是一个通用的数据结构，可以存储任何类型的数据，但不会自动处理 MongoDB 特有的数据类型。你需要手动处理类型转换，尤其是对于 MongoDB 特有的数据类型（如 <code class="language-plaintext highlighter-rouge">ObjectId</code>、<code class="language-plaintext highlighter-rouge">Date</code> 等），在 <code class="language-plaintext highlighter-rouge">Map</code> 中只能存储普通的 Java 对象。</p><ol><li><p><strong>序列化与反序列化</strong> <strong><code class="language-plaintext highlighter-rouge">Document</code></strong>：<code class="language-plaintext highlighter-rouge">Document</code> 在 MongoDB Java 驱动中与 BSON 数据紧密结合，提供了方便的序列化和反序列化功能。你可以直接将 <code class="language-plaintext highlighter-rouge">Document</code> 存储到 MongoDB 中，MongoDB 驱动会自动将 <code class="language-plaintext highlighter-rouge">Document</code> 转换为 BSON 格式，反之亦然。 <strong><code class="language-plaintext highlighter-rouge">Map</code></strong>：<code class="language-plaintext highlighter-rouge">Map</code> 是 Java 的标准集合类，没有内建的 MongoDB 序列化支持。你需要手动将 <code class="language-plaintext highlighter-rouge">Map</code> 转换为 <code class="language-plaintext highlighter-rouge">Document</code>，并在需要时进行反序列化。</p></li><li><p><strong>性能与使用场景</strong> <strong><code class="language-plaintext highlighter-rouge">Document</code></strong>：<code class="language-plaintext highlighter-rouge">Document</code> 是 MongoDB 数据库中数据的本地表示，适用于需要嵌套结构并且需要与 MongoDB 直接交互的场景。它具有 MongoDB 驱动提供的优化和功能支持，可以有效处理复杂的数据结构和 MongoDB 特定类型的数据。 <strong><code class="language-plaintext highlighter-rouge">Map</code></strong>：<code class="language-plaintext highlighter-rouge">Map</code> 更通用，适用于 Java 应用中存储任何类型的键值对，尤其是对于不特定于 MongoDB 的场景。在 MongoDB 中插入数据时，<code class="language-plaintext highlighter-rouge">Map</code> 需要转换为 <code class="language-plaintext highlighter-rouge">Document</code>。</p></li></ol><p>示例对比</p><p>使用 <code class="language-plaintext highlighter-rouge">Document</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Document</span><span class="o">();</span>
<span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"John Doe"</span><span class="o">);</span>
<span class="n">doc</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"address"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Document</span><span class="o">(</span><span class="s">"street"</span><span class="o">,</span> <span class="s">"123 Main St"</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"Anytown"</span><span class="o">));</span>
</code></pre></div></div><p>使用 <code class="language-plaintext highlighter-rouge">Map</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"John Doe"</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">addressMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">addressMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"street"</span><span class="o">,</span> <span class="s">"123 Main St"</span><span class="o">);</span>
<span class="n">addressMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"Anytown"</span><span class="o">);</span>

<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"address"</span><span class="o">,</span> <span class="n">addressMap</span><span class="o">);</span>
</code></pre></div></div><h2 id="反序列化">反序列化</h2><p>在 MongoDB 中，反序列化是指将存储在数据库中的 BSON 数据转换为 Java 对象的过程。对于 <code class="language-plaintext highlighter-rouge">Document</code> 和 <code class="language-plaintext highlighter-rouge">Map</code>，反序列化的方式和适用场景有所不同。</p><p><strong>使用 <code class="language-plaintext highlighter-rouge">Document</code> 反序列化</strong></p><p><code class="language-plaintext highlighter-rouge">Document</code> 是 MongoDB Java 驱动专门为 BSON 数据设计的类，因此，MongoDB 驱动会自动将 BSON 数据转换为 <code class="language-plaintext highlighter-rouge">Document</code> 对象，并且 <code class="language-plaintext highlighter-rouge">Document</code> 对象本身提供了灵活的 API 来处理 BSON 数据。</p><p><strong>反序列化到 <code class="language-plaintext highlighter-rouge">Document</code></strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 假设 MongoDB 集合中存储的文档是 { "name": "John Doe", "address": { "street": "123 Main St", "city": "Anytown" } }</span>
<span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"someId"</span><span class="o">,</span> <span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">doc</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>  <span class="c1">// 输出 "John Doe"</span>
<span class="nc">Document</span> <span class="n">address</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Document</span><span class="o">)</span> <span class="n">doc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"address"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"street"</span><span class="o">));</span>  <span class="c1">// 输出 "123 Main St"</span>
</code></pre></div></div><p><strong>反序列化到自定义 Java 类</strong></p><p>如果你希望将 MongoDB 中的文档反序列化为自定义的 Java 类，可以使用 MongoTemplate 提供的 <code class="language-plaintext highlighter-rouge">findById</code> 或 <code class="language-plaintext highlighter-rouge">find</code> 方法，并将返回类型指定为 Java 类：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Address</span> <span class="n">address</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">street</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">city</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>

<span class="c1">// 查询文档并反序列化为 Person 对象</span>
<span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"someId"</span><span class="o">,</span> <span class="nc">Person</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>  <span class="c1">// 输出 "John Doe"</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getAddress</span><span class="o">().</span><span class="na">getStreet</span><span class="o">());</span>  <span class="c1">// 输出 "123 Main St"</span>
</code></pre></div></div><p>MongoDB 驱动会自动将 BSON 文档中的 <code class="language-plaintext highlighter-rouge">address</code> 字段反序列化为 <code class="language-plaintext highlighter-rouge">Address</code> 对象。为了实现反序列化，MongoDB Java 驱动会使用 JavaBean 反射机制，将 BSON 文档的字段映射到 Java 类的字段。</p><p><strong>使用 <code class="language-plaintext highlighter-rouge">Map</code> 反序列化</strong></p><p>对于 <code class="language-plaintext highlighter-rouge">Map</code>，MongoDB Java 驱动不会自动将 BSON 数据转换为 Java 对象。如果你使用 <code class="language-plaintext highlighter-rouge">Map</code>，需要自己手动处理反序列化过程。</p><p>反序列化到 <code class="language-plaintext highlighter-rouge">Map</code></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 假设 MongoDB 集合中存储的文档是 { "name": "John Doe", "address": { "street": "123 Main St", "city": "Anytown" } }</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"someId"</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>  <span class="c1">// 输出 "John Doe"</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">address</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"address"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"street"</span><span class="o">));</span>  <span class="c1">// 输出 "123 Main St"</span>
</code></pre></div></div><p>在这个例子中，MongoDB 驱动会将 BSON 文档反序列化为 <code class="language-plaintext highlighter-rouge">Map</code> 类型，字段名会映射到 <code class="language-plaintext highlighter-rouge">Map</code> 中的键。</p><h3 id="反序列化与嵌套结构">反序列化与嵌套结构</h3><p>无论是使用 <code class="language-plaintext highlighter-rouge">Document</code> 还是 <code class="language-plaintext highlighter-rouge">Map</code>，MongoDB 支持嵌套数据结构，所以反序列化时，如果字段包含嵌套的文档或数组，驱动会根据相应的结构转换为 Java 中对应的对象。</p><p>使用 <code class="language-plaintext highlighter-rouge">Document</code> 处理嵌套结构</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">street</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">city</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Address</span> <span class="n">address</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>

<span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"someId"</span><span class="o">,</span> <span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">();</span>
<span class="n">person</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">doc</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>

<span class="nc">Document</span> <span class="n">addressDoc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Document</span><span class="o">)</span> <span class="n">doc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"address"</span><span class="o">);</span>
<span class="nc">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Address</span><span class="o">();</span>
<span class="n">address</span><span class="o">.</span><span class="na">setStreet</span><span class="o">(</span><span class="n">addressDoc</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"street"</span><span class="o">));</span>
<span class="n">address</span><span class="o">.</span><span class="na">setCity</span><span class="o">(</span><span class="n">addressDoc</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"city"</span><span class="o">));</span>
<span class="n">person</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
</code></pre></div></div><p><strong>使用 <code class="language-plaintext highlighter-rouge">Map</code> 处理嵌套结构</strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"someId"</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">addressMap</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"address"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">street</span> <span class="o">=</span> <span class="n">addressMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"street"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">city</span> <span class="o">=</span> <span class="n">addressMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"city"</span><span class="o">);</span>
</code></pre></div></div><h3 id="反序列化时处理复杂数据类型">反序列化时处理复杂数据类型</h3><p>对于 MongoDB 中的特定数据类型（如 <code class="language-plaintext highlighter-rouge">ObjectId</code>、<code class="language-plaintext highlighter-rouge">Date</code>、<code class="language-plaintext highlighter-rouge">Decimal128</code> 等），<code class="language-plaintext highlighter-rouge">Document</code> 会自动处理这些类型的转换。而 <code class="language-plaintext highlighter-rouge">Map</code> 需要手动转换这些特殊类型。</p><p>反序列化 <code class="language-plaintext highlighter-rouge">ObjectId</code> 类型</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"someId"</span><span class="o">,</span> <span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">ObjectId</span> <span class="n">objectId</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">getObjectId</span><span class="o">(</span><span class="s">"_id"</span><span class="o">);</span>
</code></pre></div></div><p>反序列化 <code class="language-plaintext highlighter-rouge">Date</code> 类型</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"someId"</span><span class="o">,</span> <span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Date</span> <span class="n">createdAt</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">getDate</span><span class="o">(</span><span class="s">"createdAt"</span><span class="o">);</span>
</code></pre></div></div><p>反序列化 <code class="language-plaintext highlighter-rouge">Decimal128</code> 类型</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">"someId"</span><span class="o">,</span> <span class="nc">Document</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">Decimal128</span> <span class="n">price</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="nc">Decimal128</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><ol><li><strong>总结</strong></li></ol><ul><li><p><strong>使用 <code class="language-plaintext highlighter-rouge">Document</code></strong>：<code class="language-plaintext highlighter-rouge">Document</code> 是 MongoDB Java 驱动中为 BSON 数据设计的类，MongoDB 会自动将 BSON 数据反序列化为 <code class="language-plaintext highlighter-rouge">Document</code> 对象，支持复杂的嵌套结构和 MongoDB 特有的数据类型（如 <code class="language-plaintext highlighter-rouge">ObjectId</code>、<code class="language-plaintext highlighter-rouge">Date</code>、<code class="language-plaintext highlighter-rouge">Decimal128</code> 等）。在需要直接与 MongoDB 数据交互时，使用 <code class="language-plaintext highlighter-rouge">Document</code> 是更方便的选择。</p></li><li><p><strong>使用 <code class="language-plaintext highlighter-rouge">Map</code></strong>：<code class="language-plaintext highlighter-rouge">Map</code> 是 Java 中的通用数据结构，用来存储键值对，但没有内建的 MongoDB 数据类型支持。如果你使用 <code class="language-plaintext highlighter-rouge">Map</code> 来存储 MongoDB 中的文档数据，MongoDB 驱动会自动将 BSON 数据反序列化为 <code class="language-plaintext highlighter-rouge">Map</code>，但是你需要手动处理数据类型转换，尤其是对于 MongoDB 特有的数据类型。<code class="language-plaintext highlighter-rouge">Map</code> 不适合用于直接处理 MongoDB 中的数据类型。</p></li><li><p><strong>嵌套结构</strong>：<code class="language-plaintext highlighter-rouge">Document</code> 可以轻松处理嵌套文档，并支持自动映射到嵌套的 Java 对象。而对于 <code class="language-plaintext highlighter-rouge">Map</code>，嵌套数据需要手动处理，将嵌套的 <code class="language-plaintext highlighter-rouge">Map</code> 转换为相应的 Java 对象。</p></li></ul><p>在实际开发中，使用 <code class="language-plaintext highlighter-rouge">Document</code> 反序列化 MongoDB 文档通常是更方便且高效的做法，特别是在处理复杂数据结构和 MongoDB 特有的数据类型时。</p><h2 id="dto注解">DTO注解</h2><p>在 Java 中，MongoDB 提供了一些注解，尤其是当你使用 <strong>Spring Data MongoDB</strong> 时，这些注解用于帮助你将 Java 对象（DTO）映射到 MongoDB 中的文档（BSON）格式。下面是一些常见的 MongoDB 注解：</p><ol><li><strong><code class="language-plaintext highlighter-rouge">@Document</code></strong></li></ol><p><code class="language-plaintext highlighter-rouge">@Document</code> 注解用于标识一个 Java 类是 MongoDB 的文档类。它告诉 Spring Data MongoDB 这个类应该被映射到 MongoDB 的某个集合。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="o">;</span>

<span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">"people"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>
</code></pre></div></div><ul><li><strong><code class="language-plaintext highlighter-rouge">collection</code></strong> 属性指定了 MongoDB 集合的名称。如果不指定，默认使用类名的小写形式作为集合名。</li></ul><ol><li><strong><code class="language-plaintext highlighter-rouge">@Id</code></strong></li></ol><p><code class="language-plaintext highlighter-rouge">@Id</code> 注解用于标识文档的主键字段，通常对应 MongoDB 文档中的 <code class="language-plaintext highlighter-rouge">_id</code> 字段。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Id</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">@Id</code> 用于指定哪个字段在 MongoDB 中是文档的唯一标识符，通常对应 <code class="language-plaintext highlighter-rouge">_id</code> 字段。可以使用 <code class="language-plaintext highlighter-rouge">String</code>、<code class="language-plaintext highlighter-rouge">ObjectId</code> 或其他数据类型来表示主键。</li></ul><ol><li><strong><code class="language-plaintext highlighter-rouge">@Field</code></strong></li></ol><p><code class="language-plaintext highlighter-rouge">@Field</code> 注解用于指定文档中的字段与 Java 类的属性之间的映射关系。它常用于字段名与 Java 属性名不同的情况。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Field</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Field</span><span class="o">(</span><span class="s">"full_name"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>
</code></pre></div></div><ul><li>这个注解指定了 MongoDB 文档中的字段名（<code class="language-plaintext highlighter-rouge">full_name</code>）与 Java 类中的属性名（<code class="language-plaintext highlighter-rouge">name</code>）之间的映射关系。</li></ul><ol><li><strong><code class="language-plaintext highlighter-rouge">@Transient</code></strong></li></ol><p><code class="language-plaintext highlighter-rouge">@Transient</code> 注解用于标识一个字段不应当被持久化到 MongoDB 中。也就是说，这个字段不会被存储到数据库中，但仍然可以在应用程序中使用。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Transient</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@Transient</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">temporaryField</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">@Transient</code> 注解的字段不会被持久化到数据库中，适用于临时数据或计算字段。</li></ul><ol><li><strong><code class="language-plaintext highlighter-rouge">@DBRef</code></strong></li></ol><p><code class="language-plaintext highlighter-rouge">@DBRef</code> 注解用于处理 MongoDB 中的引用关系，它用于将一个文档与另一个文档关联。例如，如果你有两个集合，其中一个集合中的文档引用另一个集合中的文档，可以使用 <code class="language-plaintext highlighter-rouge">@DBRef</code> 来建立引用关系。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.DBRef</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Post</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="nd">@DBRef</span>
    <span class="kd">private</span> <span class="nc">Author</span> <span class="n">author</span><span class="o">;</span>  <span class="c1">// 引用其他文档</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">@DBRef</code> 会在 MongoDB 中保存一个文档的引用，而不是将整个文档嵌入到当前文档中。这对于处理一对多或多对多关系时非常有用。</li></ul><ol><li><strong><code class="language-plaintext highlighter-rouge">@CreatedDate</code> 和 <code class="language-plaintext highlighter-rouge">@LastModifiedDate</code></strong></li></ol><p><code class="language-plaintext highlighter-rouge">@CreatedDate</code> 和 <code class="language-plaintext highlighter-rouge">@LastModifiedDate</code> 注解用于自动填充文档的创建时间和最后修改时间。它们通常与 <code class="language-plaintext highlighter-rouge">@EnableMongoAuditing</code> 一起使用来启用审计功能。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.annotation.CreatedDate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.LastModifiedDate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@CreatedDate</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">createdDate</span><span class="o">;</span>

    <span class="nd">@LastModifiedDate</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">lastModifiedDate</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">@CreatedDate</code> 注解会自动填充文档的创建时间，而 <code class="language-plaintext highlighter-rouge">@LastModifiedDate</code> 注解会在文档被修改时自动更新最后修改时间。</li></ul><ol><li><strong><code class="language-plaintext highlighter-rouge">@Version</code></strong></li></ol><p><code class="language-plaintext highlighter-rouge">@Version</code> 注解用于乐观锁控制（Optimistic Locking）。在并发场景下，如果多个线程同时尝试更新同一个文档，可以通过版本号来检测冲突。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Version</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@Version</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">version</span><span class="o">;</span>

    <span class="c1">// getters and setters</span>
<span class="o">}</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">@Version</code> 会自动为文档添加一个版本号字段，在每次更新时，版本号会递增。如果版本号不匹配（即文档已被修改），则会抛出 <code class="language-plaintext highlighter-rouge">OptimisticLockingFailureException</code>。</li></ul><ol><li><strong><code class="language-plaintext highlighter-rouge">@Aggregation</code> 和 <code class="language-plaintext highlighter-rouge">@Query</code></strong></li></ol><p>虽然 <code class="language-plaintext highlighter-rouge">@Aggregation</code> 和 <code class="language-plaintext highlighter-rouge">@Query</code> 注解不直接用于 DTO 类，但它们对于在 MongoRepository 接口中进行自定义查询非常有用。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.repository.Aggregation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.repository.Query</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PersonRepository</span> <span class="kd">extends</span> <span class="nc">MongoRepository</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"{'name': ?0}"</span><span class="o">)</span>
    <span class="nc">Person</span> <span class="nf">findByName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

    <span class="nd">@Aggregation</span><span class="o">(</span><span class="n">pipeline</span> <span class="o">=</span> <span class="o">{</span>
        <span class="s">"{ '$match': { 'age': { '$gt': ?0 } } }"</span><span class="o">,</span>
        <span class="s">"{ '$group': { '_id': '$name', 'total': { '$sum': 1 } } }"</span>
    <span class="o">})</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PersonSummary</span><span class="o">&gt;</span> <span class="nf">findPersonSummariesByAgeGreaterThan</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">@Query</code> 注解用于定义 MongoDB 查询。</li><li><code class="language-plaintext highlighter-rouge">@Aggregation</code> 注解用于定义聚合查询管道。</li></ul><hr /><p>总结</p><p>常用的 MongoDB 注解主要集中在数据映射和持久化操作上。对于 DTO 类（Data Transfer Object）来说，通常使用的注解包括：</p><ul><li><strong><code class="language-plaintext highlighter-rouge">@Document</code></strong>：指定文档类和集合的映射。</li><li><strong><code class="language-plaintext highlighter-rouge">@Id</code></strong>：标识主键字段。</li><li><strong><code class="language-plaintext highlighter-rouge">@Field</code></strong>：指定字段与 MongoDB 文档中的字段映射关系。</li><li><strong><code class="language-plaintext highlighter-rouge">@Transient</code></strong>：标记不持久化的字段。</li><li><strong><code class="language-plaintext highlighter-rouge">@DBRef</code></strong>：处理文档之间的引用关系。</li><li><strong><code class="language-plaintext highlighter-rouge">@CreatedDate</code> 和 <code class="language-plaintext highlighter-rouge">@LastModifiedDate</code></strong>：自动填充时间字段。</li><li><strong><code class="language-plaintext highlighter-rouge">@Version</code></strong>：启用乐观锁。</li><li><strong><code class="language-plaintext highlighter-rouge">@Query</code> 和 <code class="language-plaintext highlighter-rouge">@Aggregation</code></strong>：在 <code class="language-plaintext highlighter-rouge">MongoRepository</code> 中定义查询。</li></ul><p><strong>实例：</strong></p><p>假设我有如下的数据结构：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6708f5f8c7413f0001015635"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"creator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"张三"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
      </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"纽约"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"job"</span><span class="p">:</span><span class="w"> </span><span class="s2">"工程师"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"salary"</span><span class="p">:</span><span class="w"> </span><span class="mi">60000</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"工程师"</span><span class="p">,</span><span class="w"> </span><span class="s2">"开发人员"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"projects"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目A"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"主开发"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目B"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"测试"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"有经验的开发人员和工程师"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isActive"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T09:55:04.671Z"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"last_modified_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T10:01:26.232Z"</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>设计如下 DTO 类：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">"your_collection_name"</span><span class="o">)</span> <span class="c1">// 指定 MongoDB 集合名称</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">YourDto</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span> <span class="c1">// MongoDB _id 字段</span>

    <span class="nd">@Field</span><span class="o">(</span><span class="s">"tenant_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">tenantId</span><span class="o">;</span> <span class="c1">// tenant_id 字段</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">creator</span><span class="o">;</span> <span class="c1">// 操作员字段</span>

    <span class="kd">private</span> <span class="nc">Data</span> <span class="n">data</span><span class="o">;</span> <span class="c1">// 嵌套的 data 对象</span>

    <span class="nd">@Field</span><span class="o">(</span><span class="s">"create_time"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">createTime</span><span class="o">;</span> <span class="c1">// 创建时间字段</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lastModifiedBy</span><span class="o">;</span> <span class="c1">// 最后修改人字段</span>

    <span class="nd">@Field</span><span class="o">(</span><span class="s">"update_time"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">updateTime</span><span class="o">;</span> <span class="c1">// 更新时间字段</span>

    <span class="c1">// Getter 和 Setter 方法</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTenantId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">tenantId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTenantId</span><span class="o">(</span><span class="nc">String</span> <span class="n">tenantId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tenantId</span> <span class="o">=</span> <span class="n">tenantId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCreator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">creator</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreator</span><span class="o">(</span><span class="nc">String</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">creator</span> <span class="o">=</span> <span class="n">creator</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Data</span> <span class="nf">getData</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setData</span><span class="o">(</span><span class="nc">Data</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCreateTime</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreateTime</span><span class="o">(</span><span class="nc">String</span> <span class="n">createTime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">createTime</span> <span class="o">=</span> <span class="n">createTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getLastModifiedBy</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lastModifiedBy</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLastModifiedBy</span><span class="o">(</span><span class="nc">String</span> <span class="n">lastModifiedBy</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lastModifiedBy</span> <span class="o">=</span> <span class="n">lastModifiedBy</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUpdateTime</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">updateTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUpdateTime</span><span class="o">(</span><span class="nc">String</span> <span class="n">updateTime</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">updateTime</span> <span class="o">=</span> <span class="n">updateTime</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 内部类 Data 用来表示嵌套的 data 对象</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Data</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">status</span><span class="o">;</span> <span class="c1">// 状态字段</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span> <span class="c1">// 姓名字段</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span> <span class="c1">// 年龄字段</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">city</span><span class="o">;</span> <span class="c1">// 城市字段</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">job</span><span class="o">;</span> <span class="c1">// 职业字段</span>
        <span class="kd">private</span> <span class="kt">double</span> <span class="n">salary</span><span class="o">;</span> <span class="c1">// 薪水字段</span>
        <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span> <span class="c1">// 标签列表字段</span>
        <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">projects</span><span class="o">;</span> <span class="c1">// 项目列表字段</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">description</span><span class="o">;</span> <span class="c1">// 描述字段</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isActive</span><span class="o">;</span> <span class="c1">// 活跃状态字段</span>

        <span class="c1">// Getter 和 Setter 方法</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isStatus</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">status</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStatus</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCity</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">city</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCity</span><span class="o">(</span><span class="nc">String</span> <span class="n">city</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">city</span> <span class="o">=</span> <span class="n">city</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getJob</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">job</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setJob</span><span class="o">(</span><span class="nc">String</span> <span class="n">job</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">job</span> <span class="o">=</span> <span class="n">job</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getSalary</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">salary</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSalary</span><span class="o">(</span><span class="kt">double</span> <span class="n">salary</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">salary</span> <span class="o">=</span> <span class="n">salary</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getTags</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">tags</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTags</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="nf">getProjects</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">projects</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setProjects</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Project</span><span class="o">&gt;</span> <span class="n">projects</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">projects</span> <span class="o">=</span> <span class="n">projects</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">description</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDescription</span><span class="o">(</span><span class="nc">String</span> <span class="n">description</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isActive</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">isActive</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setActive</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">active</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">isActive</span> <span class="o">=</span> <span class="n">active</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// 内部类 Project 用来表示嵌套的项目对象</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Project</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span> <span class="c1">// 项目名称</span>
            <span class="kd">private</span> <span class="nc">String</span> <span class="n">role</span><span class="o">;</span> <span class="c1">// 角色</span>

            <span class="c1">// Getter 和 Setter 方法</span>

            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getRole</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">role</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRole</span><span class="o">(</span><span class="nc">String</span> <span class="n">role</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">role</span> <span class="o">=</span> <span class="n">role</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>解释</strong></p><ol><li><strong>字段映射：</strong> 使用 <code class="language-plaintext highlighter-rouge">@Field</code> 注解来显式地映射 MongoDB 中的字段。例如，<code class="language-plaintext highlighter-rouge">tenant_id</code> 字段通过 <code class="language-plaintext highlighter-rouge">@Field("tenant_id")</code> 映射到 <code class="language-plaintext highlighter-rouge">tenantId</code> 字段。</li><li><strong>嵌套对象：</strong> <code class="language-plaintext highlighter-rouge">data</code> 是一个嵌套对象，表示为内部的静态类 <code class="language-plaintext highlighter-rouge">Data</code>。这允许你在 DTO 中表示嵌套的复杂数据结构。</li><li><strong>数组和列表：</strong> <code class="language-plaintext highlighter-rouge">tags</code> 和 <code class="language-plaintext highlighter-rouge">projects</code> 分别是数组和嵌套对象列表，使用 <code class="language-plaintext highlighter-rouge">List</code> 来表示。</li><li><strong>时间字段：</strong> <code class="language-plaintext highlighter-rouge">create_time</code> 和 <code class="language-plaintext highlighter-rouge">update_time</code> 使用 <code class="language-plaintext highlighter-rouge">@Field</code> 注解映射 MongoDB 中的时间字段，字段名与类中字段名称不一致时使用此注解指定。</li><li><strong>操作符字段：</strong> 在实际的数据库交互中（例如查询），MongoDB 中的操作符（如 <code class="language-plaintext highlighter-rouge">$gt</code>）通常不会在 DTO 中表示，但如果需要进行查询时可以通过 <code class="language-plaintext highlighter-rouge">Criteria</code> 来构造条件。</li></ol><p><strong>使用 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 或 <code class="language-plaintext highlighter-rouge">MongoRepository</code></strong></p><ol><li><strong>MongoTemplate：</strong></li></ol><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">MongoTemplate</span> <span class="n">mongoTemplate</span><span class="o">;</span>

<span class="c1">// 保存数据</span>
<span class="n">mongoTemplate</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">yourDto</span><span class="o">);</span>

<span class="c1">// 查询数据</span>
<span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">(</span><span class="nc">Criteria</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="s">"tenant_id"</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="s">"***************"</span><span class="o">));</span>
<span class="nc">YourDto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">findOne</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">YourDto</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><ol><li><strong>MongoRepository：</strong></li></ol><p>如果你使用 <code class="language-plaintext highlighter-rouge">MongoRepository</code>，可以直接定义一个接口：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">java复制代码import</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">mongodb</span><span class="o">.</span><span class="na">repository</span><span class="o">.</span><span class="na">MongoRepository</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">YourDtoRepository</span> <span class="kd">extends</span> <span class="nc">MongoRepository</span><span class="o">&lt;</span><span class="nc">YourDto</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">YourDto</span><span class="o">&gt;</span> <span class="nf">findByTenantId</span><span class="o">(</span><span class="nc">String</span> <span class="n">tenantId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>总结</strong></p><ul><li>DTO 类应该与 MongoDB 的数据结构匹配，使用 <code class="language-plaintext highlighter-rouge">@Field</code> 来映射字段名。</li><li>对于嵌套对象和数组，使用嵌套类和 <code class="language-plaintext highlighter-rouge">List</code> 来表示。</li><li>使用 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 或 <code class="language-plaintext highlighter-rouge">MongoRepository</code> 来进行数据库操作。</li></ul><h2 id="索引">索引</h2><p><code class="language-plaintext highlighter-rouge">@Indexed</code> 注解是 Spring Data MongoDB 中的一个用于指定 MongoDB 索引的注解，它可以应用于字段、类等，用来加速查询性能。通过使用 <code class="language-plaintext highlighter-rouge">@Indexed</code> 注解，Spring Data MongoDB 会自动在对应的字段上创建索引，以提高查询效率。</p><p><strong>使用 <code class="language-plaintext highlighter-rouge">@Indexed</code> 注解</strong></p><p><code class="language-plaintext highlighter-rouge">@Indexed</code> 可以应用于类的字段上，并允许你指定索引的类型、排序等。</p><p><strong>在字段上使用 <code class="language-plaintext highlighter-rouge">@Indexed</code></strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.index.Indexed</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">"your_collection_name"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">YourDto</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Indexed</span> <span class="c1">// 默认会创建升序索引</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">tenantId</span><span class="o">;</span> <span class="c1">// tenant_id 字段将被索引</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">creator</span><span class="o">;</span>

    <span class="nd">@Indexed</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 唯一索引，确保这个字段的值是唯一的</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">creatorId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Data</span> <span class="n">data</span><span class="o">;</span>

    <span class="c1">// 其他字段省略...</span>

    <span class="c1">// Getter 和 Setter 方法</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTenantId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">tenantId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTenantId</span><span class="o">(</span><span class="nc">String</span> <span class="n">tenantId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tenantId</span> <span class="o">=</span> <span class="n">tenantId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCreator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">creator</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreator</span><span class="o">(</span><span class="nc">String</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">creator</span> <span class="o">=</span> <span class="n">creator</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Data</span> <span class="nf">getData</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setData</span><span class="o">(</span><span class="nc">Data</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 内部类 Data 省略...</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>在类上使用 <code class="language-plaintext highlighter-rouge">@Indexed</code>（适用于复合索引）</strong></p><p>如果你需要创建复合索引（即基于多个字段的索引），你可以使用 <code class="language-plaintext highlighter-rouge">@CompoundIndexes</code> 注解来定义。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.index.CompoundIndex</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.index.CompoundIndexes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Id</span><span class="o">;</span>

<span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">"your_collection_name"</span><span class="o">)</span>
<span class="nd">@CompoundIndexes</span><span class="o">({</span>
    <span class="nd">@CompoundIndex</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"tenant_creator_index"</span><span class="o">,</span> <span class="n">def</span> <span class="o">=</span> <span class="s">"{'tenantId': 1, 'creator': 1}"</span><span class="o">)</span> <span class="c1">// 创建一个基于 tenantId 和 creator 的复合索引</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">YourDto</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">tenantId</span><span class="o">;</span> <span class="c1">// 将会参与复合索引</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">creator</span><span class="o">;</span> <span class="c1">// 将会参与复合索引</span>

    <span class="c1">// 其他字段和方法省略...</span>
<span class="o">}</span>
</code></pre></div></div><p>其他 <code class="language-plaintext highlighter-rouge">@Indexed</code> 配置选项</p><ul><li><code class="language-plaintext highlighter-rouge">unique = true</code>：用于创建唯一索引。对于这个字段，MongoDB 会确保每个值都是唯一的，常用于 <code class="language-plaintext highlighter-rouge">email</code>、<code class="language-plaintext highlighter-rouge">username</code> 等字段。</li><li><code class="language-plaintext highlighter-rouge">direction</code>：控制索引的顺序，<code class="language-plaintext highlighter-rouge">ASC</code>（升序）或 <code class="language-plaintext highlighter-rouge">DESC</code>（降序）。默认为 <code class="language-plaintext highlighter-rouge">ASC</code>。</li><li><code class="language-plaintext highlighter-rouge">dropDups = true</code>：删除重复的文档。只有在创建唯一索引时才有意义，用于清除已经存在的重复数据。</li><li><code class="language-plaintext highlighter-rouge">sparse = true</code>：当你有很多字段为空时，可以选择创建稀疏索引。这个选项会确保只有有值的文档会被索引，而为空的文档不会占用索引空间。</li></ul><p>示例：使用 <code class="language-plaintext highlighter-rouge">@Indexed</code> 注解</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.index.Indexed</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.annotation.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.mapping.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@Document</span><span class="o">(</span><span class="n">collection</span> <span class="o">=</span> <span class="s">"your_collection_name"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">YourDto</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Indexed</span><span class="o">(</span><span class="n">unique</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 唯一索引，确保该字段的值是唯一的</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="nd">@Indexed</span><span class="o">(</span><span class="n">direction</span> <span class="o">=</span> <span class="nc">IndexDirection</span><span class="o">.</span><span class="na">ASC</span><span class="o">)</span> <span class="c1">// 升序索引</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">tenantId</span><span class="o">;</span>

    <span class="nd">@Indexed</span><span class="o">(</span><span class="n">sparse</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 创建稀疏索引</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">phoneNumber</span><span class="o">;</span> <span class="c1">// 仅对有值的文档建立索引</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">creator</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Data</span> <span class="n">data</span><span class="o">;</span>

    <span class="c1">// Getter 和 Setter 方法</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getTenantId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">tenantId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTenantId</span><span class="o">(</span><span class="nc">String</span> <span class="n">tenantId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tenantId</span> <span class="o">=</span> <span class="n">tenantId</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPhoneNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">phoneNumber</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPhoneNumber</span><span class="o">(</span><span class="nc">String</span> <span class="n">phoneNumber</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">phoneNumber</span> <span class="o">=</span> <span class="n">phoneNumber</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCreator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">creator</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreator</span><span class="o">(</span><span class="nc">String</span> <span class="n">creator</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">creator</span> <span class="o">=</span> <span class="n">creator</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Data</span> <span class="nf">getData</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setData</span><span class="o">(</span><span class="nc">Data</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 内部类 Data 省略...</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>动态创建索引</strong></p><p>除了在 DTO 类中使用 <code class="language-plaintext highlighter-rouge">@Indexed</code> 注解来创建索引外，还可以使用 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 来动态创建索引。使用 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 可以更加灵活地管理索引：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.MongoTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.index.Index</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.mongodb.core.query.Query</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">MongoTemplate</span> <span class="n">mongoTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createIndexes</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">indexOps</span><span class="o">(</span><span class="nc">YourDto</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">ensureIndex</span><span class="o">(</span><span class="k">new</span> <span class="nc">Index</span><span class="o">().</span><span class="na">on</span><span class="o">(</span><span class="s">"tenantId"</span><span class="o">,</span> <span class="nc">Index</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">));</span>
        <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">indexOps</span><span class="o">(</span><span class="nc">YourDto</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">ensureIndex</span><span class="o">(</span><span class="k">new</span> <span class="nc">Index</span><span class="o">().</span><span class="na">on</span><span class="o">(</span><span class="s">"email"</span><span class="o">,</span> <span class="nc">Index</span><span class="o">.</span><span class="na">Direction</span><span class="o">.</span><span class="na">ASC</span><span class="o">).</span><span class="na">unique</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>总结</p><ul><li><code class="language-plaintext highlighter-rouge">@Indexed</code> 用于创建单字段索引，增强查询性能。</li><li>可以在字段上指定 <code class="language-plaintext highlighter-rouge">unique</code>、<code class="language-plaintext highlighter-rouge">sparse</code>、<code class="language-plaintext highlighter-rouge">direction</code> 等选项来定制索引。</li><li><code class="language-plaintext highlighter-rouge">@CompoundIndexes</code> 用于定义复合索引，可以基于多个字段创建复合索引。</li><li>使用 <code class="language-plaintext highlighter-rouge">MongoTemplate</code> 可以动态创建和管理索引。</li></ul><p>通过合理使用 <code class="language-plaintext highlighter-rouge">@Indexed</code> 和其他索引相关配置，可以显著提高数据库查询的性能，特别是在大量数据和频繁查询的场景中。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="" target="_blank">acteds</a></li><li>本文链接：<a href="/2024/09/23/MongoDB/" target="_blank">https://acteds.github.io/2024/09/23/MongoDB/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://beaudar.lipk.org/client.js" repo="mzlogin/blog-comments" issue-term="title" label="gitment" theme="github-light" comment-order="desc" input-position="top" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: '/assets/search_data.json?v=1734246804', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="acteds">acteds</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/acteds/acteds.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="/" title="首页" target="">首页</a></li><li> <a href="/categories/" title="分类" target="">分类</a></li><li> <a href="/wiki/" title="维基" target="">维基</a></li><li> <a href="/about/" title="关于" target="">关于</a></li><li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
