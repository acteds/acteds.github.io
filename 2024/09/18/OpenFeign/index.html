<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>OpenFeign的使用 &mdash; 个人博客</title><link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="/assets/css/components/collection.css"><link rel="stylesheet" href="/assets/css/components/repo-card.css"><link rel="stylesheet" href="/assets/css/sections/repo-list.css"><link rel="stylesheet" href="/assets/css/components/boxed-group.css"><link rel="stylesheet" href="/assets/css/globals/common.css"><link rel="stylesheet" href="/assets/css/globals/responsive.css"><link rel="stylesheet" href="/assets/css/posts/index.css"><link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/highlight/monokai.sublime.css"><link rel="canonical" href="/2024/09/18/OpenFeign/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="/feed.xml"><link rel="shortcut icon" href="/favicon.ico"><meta property="og:title" content="OpenFeign的使用"><meta name="keywords" content="Java"><meta name="og:keywords" content="Java"><meta name="description" content="引言"><meta name="og:description" content="引言"><meta property="og:url" content="/2024/09/18/OpenFeign/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2024-09-18"> <script src="/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="/assets/js/jquery-ui.js"></script> <script src="/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="OpenFeign的使用"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">OpenFeign的使用</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2024/09/18 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#Java" title="Java">Java</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 6914 字，约 20 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="引言">引言</h1><p><strong>OpenFeign</strong> 是一个声明式的 HTTP 客户端，主要用于简化微服务之间的通信。它通过注解和接口的形式定义远程服务的调用，帮助开发者省去了编写大量 HTTP 请求的样板代码。在 Spring Cloud 中，OpenFeign 与 Spring Boot 和 Spring Cloud 集成良好，能够与负载均衡、断路器等组件搭配使用。</p><h1 id="openfeign">OpenFeign</h1><p>在微服务架构中，不同的服务通过 HTTP 进行通信。常规做法是手动使用 <code class="language-plaintext highlighter-rouge">RestTemplate</code> 或 <code class="language-plaintext highlighter-rouge">HttpClient</code> 发起 HTTP 请求，这样的代码通常冗长且容易出错。<strong>OpenFeign</strong> 的优势在于它通过接口与注解的形式，使得调用远程服务就像调用本地方法一样简单。</p><p><strong>使用场景：</strong></p><ul><li><strong>简化服务调用</strong>：你不需要手动构造 HTTP 请求，而是通过调用本地接口来完成服务的远程调用。</li><li><strong>更好的集成性</strong>：OpenFeign 可以与其他 Spring Cloud 组件（如 Ribbon、Hystrix 等）无缝集成，提供负载均衡、超时、断路器等功能。</li></ul><p><strong>OpenFeign 的优点</strong>：</p><ol><li><strong>声明式的编程风格</strong>：使用注解（例如 <code class="language-plaintext highlighter-rouge">@FeignClient</code>、<code class="language-plaintext highlighter-rouge">@RequestMapping</code> 等）定义远程服务调用，使代码简洁、易读。调用远程服务就像调用本地方法一样，无需关心底层的 HTTP 请求细节。</li><li><strong>自动集成负载均衡</strong>：通过与 Spring Cloud Ribbon 集成，OpenFeign 可以自动实现对多个实例的负载均衡。你只需定义服务名，它会根据服务注册中心的实例列表选择目标。</li><li><strong>与 Hystrix 结合</strong>：OpenFeign 可以与 Hystrix 集成，实现熔断和降级策略。在微服务架构中，当某个服务不可用时，Hystrix 可以帮助服务调用快速失败，避免级联故障。</li><li><strong>与 Spring Boot 深度集成</strong>：OpenFeign 在 Spring Cloud 中具有很好的集成支持，能够通过注解、配置文件等方式轻松配置超时、重试等策略。</li><li><strong>自定义配置</strong>：OpenFeign 允许你自定义拦截器、编码器、解码器、日志等，来满足个性化需求。</li></ol><p><strong>OpenFeign 的缺点</strong>：</p><ol><li><strong>依赖反射，性能稍差</strong>：OpenFeign 是基于反射的声明式框架，性能上比手写的 HTTP 客户端（如 <code class="language-plaintext highlighter-rouge">RestTemplate</code>、<code class="language-plaintext highlighter-rouge">HttpClient</code>）稍差，适用于业务较轻或中等的服务调用场景。</li><li><strong>缺少部分高级 HTTP 控制</strong>：OpenFeign 的简洁性是它的优势，但它也使得一些高级的 HTTP 请求控制（例如复杂的请求头操作、流式数据处理等）不如手动编写 HTTP 客户端灵活。</li><li><strong>调试相对复杂</strong>：在使用 OpenFeign 时，问题调试（例如网络问题、超时等）比手写 HTTP 请求更加抽象，出错时可能需要深入了解 Feign 的工作机制。</li><li><strong>依赖服务注册中心</strong>：在分布式系统中，OpenFeign 通常依赖服务注册中心（如 Eureka、Consul 等）来发现服务实例，因此在服务注册中心出现故障时可能会影响服务调用。</li></ol><hr /><p>导入依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>程序入口添加注解：<code class="language-plaintext highlighter-rouge">@EnableFeignClients</code>。</p><p>可以配置超时时间：</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">feign</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">config</span><span class="pi">:</span>
      <span class="na">default</span><span class="pi">:</span>
        <span class="na">connectTimeout</span><span class="pi">:</span> <span class="m">20000</span> <span class="c1"># feign 的超时设置</span>
        <span class="na">readTimeout</span><span class="pi">:</span> <span class="m">60000</span>
</code></pre></div></div><p>使用：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"domainresourcesservice"</span><span class="o">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="nc">ResourcesServiceFallBack</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">configuration</span> <span class="o">=</span> <span class="o">{</span><span class="nc">FeginConfig</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ResourcesService</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span><span class="s">"/resources/rolePersionInfo/savePersionRoleAndGroupV2"</span><span class="o">)</span>
    <span class="nc">Wrapper</span> <span class="nf">savePersionRoleAndGroup</span><span class="o">(</span>
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"persionId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">persionId</span><span class="o">,</span> 
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"groupIds"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">groupIds</span><span class="o">,</span> 
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"roleIds"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">roleIds</span><span class="o">,</span> 
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"jiean_projectName"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">jiean_projectName</span>
    <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>注意：<strong><code class="language-plaintext highlighter-rouge">@RequestMapping</code> 注解不能直接用于 <code class="language-plaintext highlighter-rouge">@FeignClient</code> 接口</strong>。<code class="language-plaintext highlighter-rouge">FeignClient</code> 接口不允许在类级别使用 <code class="language-plaintext highlighter-rouge">@RequestMapping</code>，应该仅在方法级别使用 <code class="language-plaintext highlighter-rouge">@GetMapping</code>、<code class="language-plaintext highlighter-rouge">@PostMapping</code>、<code class="language-plaintext highlighter-rouge">@RequestParam</code> 等注解来定义 HTTP 请求。</p><p>配置类：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">feign.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeginConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nc">Logger</span><span class="o">.</span><span class="na">Level</span> <span class="nf">feignLoggerLevel</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Logger</span><span class="o">.</span><span class="na">Level</span><span class="o">.</span><span class="na">FULL</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>回滚类：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResourcesServiceFallBack</span> <span class="kd">implements</span> <span class="nc">ResourcesService</span> <span class="o">{</span>
    <span class="cm">/**
     * 新增人员和角色关系表
     * @param jiean_projectName
     * @param persionId
     * @param groupIds
     * @return
     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Wrapper</span> <span class="nf">savePersionRoleAndGroup</span><span class="o">(</span>
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"persionId"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">persionId</span><span class="o">,</span>
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"groupIds"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">groupIds</span><span class="o">,</span>
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"roleIds"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">roleIds</span><span class="o">,</span>
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"jiean_projectName"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">jiean_projectName</span>
    <span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">WrapMapper</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="mi">5001</span><span class="o">,</span><span class="s">"Feign 新增人员和角色关系失败"</span><span class="o">);</span>
    <span class="o">}</span>   
<span class="o">}</span>
</code></pre></div></div><p><strong><code class="language-plaintext highlighter-rouge">@FeignClient</code></strong>：用于声明一个 Feign 客户端，并指定该客户端要调用的服务。</p><ul><li><strong><code class="language-plaintext highlighter-rouge">name = "domainresourcesservice"</code></strong>：指定服务的名称。Feign 会根据这个名称从服务注册中心（如 Consul 或 Eureka）获取服务实例的地址，并发起请求。这个名字应该与注册中心中的服务名一致。</li><li><strong><code class="language-plaintext highlighter-rouge">fallback = ResourcesServiceFallBack.class</code></strong>：指定一个回退类，当远程调用失败时会执行 <code class="language-plaintext highlighter-rouge">ResourcesServiceFallBack</code> 中定义的回退逻辑。回退类通常用于实现熔断或降级功能，以提高服务的稳定性。</li><li><strong><code class="language-plaintext highlighter-rouge">configuration = {FeginConfig.class}</code></strong>：指定 Feign 客户端的配置类 <code class="language-plaintext highlighter-rouge">FeginConfig</code>，该类可以包含自定义的 Feign 配置，如超时时间、编码器、解码器、拦截器等。</li></ul><p><strong><code class="language-plaintext highlighter-rouge">@RequestMapping</code></strong>：表示这个接口方法对应的 HTTP 请求。<code class="language-plaintext highlighter-rouge">value = "/resources/rolePersionInfo/savePersionRoleAndGroupV2"</code> 表示该方法将发送到路径 <code class="language-plaintext highlighter-rouge">/resources/rolePersionInfo/savePersionRoleAndGroupV2</code> 的请求。</p><ul><li>默认情况下，这是一个 <code class="language-plaintext highlighter-rouge">POST</code> 或 <code class="language-plaintext highlighter-rouge">GET</code> 请求（具体取决于 Feign 的配置），可以根据需求指定请求方法。</li></ul><p>这段代码是一个 Feign 客户端的接口，它用于调用名为 <code class="language-plaintext highlighter-rouge">domainresourcesservice</code> 的微服务下的 <code class="language-plaintext highlighter-rouge">/resources/rolePersionInfo/savePersionRoleAndGroupV2</code> 接口，执行保存某个用户的角色和组信息操作。</p><hr /><p>在使用 Feign 客户端时，有以下几点需要特别注意：</p><p><strong>服务名要一致</strong>：<code class="language-plaintext highlighter-rouge">@FeignClient(name = "domainresourcesservice")</code> 中指定的服务名称 <strong><code class="language-plaintext highlighter-rouge">domainresourcesservice</code></strong> 必须与服务注册中心（如 Consul、Eureka）中的服务名称一致。否则，Feign 客户端将无法找到目标服务的实例，导致请求失败。</p><p><strong>回退类 <code class="language-plaintext highlighter-rouge">fallback</code></strong>：<code class="language-plaintext highlighter-rouge">fallback = ResourcesServiceFallBack.class</code> 指定了降级处理类，当远程服务不可用或者超时时，Feign 会自动调用回退方法。这有助于增强系统的容错性，防止服务故障蔓延到整个系统。</p><ul><li>确保 <code class="language-plaintext highlighter-rouge">ResourcesServiceFallBack</code> 类已经实现了 <code class="language-plaintext highlighter-rouge">ResourcesService</code> 接口，并提供了具体的回退逻辑。</li><li>如果没有正确配置 Hystrix 或 Resilience4j 等熔断器，回退逻辑可能无法生效。</li></ul><p><strong>请求参数</strong></p><ul><li><strong>参数类型</strong>：确保所有参数在远程服务的 API 中是匹配的。这里使用 <code class="language-plaintext highlighter-rouge">@RequestParam</code> 注解，表示参数会被作为查询参数或表单数据传递。对应的远程服务也应该相应处理这些参数。</li><li><strong>参数格式和验证</strong>：确保传递的参数格式正确。例如，<code class="language-plaintext highlighter-rouge">groupIds</code> 和 <code class="language-plaintext highlighter-rouge">roleIds</code> 可能是逗号分隔的字符串。如果后端要求某种特殊格式，确保在调用时传递的值是正确的。</li></ul><p><strong>自定义配置</strong></p><p><strong>Feign 配置 <code class="language-plaintext highlighter-rouge">FeginConfig.class</code></strong>：如果你有自定义的 Feign 配置（如超时设置、重试机制、编码解码器等），确保 <code class="language-plaintext highlighter-rouge">FeginConfig</code> 配置正确，并且 Feign 客户端能够应用这些配置。</p><p>比如，可以在 <code class="language-plaintext highlighter-rouge">FeginConfig</code> 中指定连接超时、读取超时等，以防止因网络延迟导致的请求失败。</p><p><strong>错误处理</strong></p><ul><li><strong>错误响应处理</strong>：<code class="language-plaintext highlighter-rouge">Wrapper</code> 是接口的返回类型，确保你能够处理远程服务可能返回的错误响应。需要检查 <code class="language-plaintext highlighter-rouge">Wrapper</code> 类是否能处理错误码、错误消息等，并且调用方能够正确处理错误。</li><li><strong>异常处理</strong>：Feign 在请求失败时可能抛出各种异常（如 <code class="language-plaintext highlighter-rouge">FeignException</code>、<code class="language-plaintext highlighter-rouge">ConnectException</code> 等），在接口的实现类中应做好异常捕获和处理，避免应用崩溃。</li></ul><p><strong>日志与调试</strong></p><ul><li><p><strong>启用 Feign 日志</strong>：如果需要调试 Feign 请求，可以在配置中启用 Feign 的详细日志功能，查看请求和响应的完整信息。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">feign:</span>
  <span class="nl">client:</span>
    <span class="nl">config:</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="nl">loggerLevel:</span> <span class="no">FULL</span>
</code></pre></div></div></li><li><p>这样可以帮助你调试 Feign 请求的问题，尤其是遇到请求失败或响应不符合预期时。</p></li></ul><p><strong>超时和重试</strong></p><ul><li><strong>超时设置</strong>：如果目标服务响应较慢，可能会导致 Feign 请求超时，导致熔断触发。确保 Feign 配置中设置了适当的超时时间，以平衡性能和可用性。<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">Request</span><span class="o">.</span><span class="na">Options</span> <span class="nf">feignOptions</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">.</span><span class="na">Options</span><span class="o">(</span><span class="mi">5000</span><span class="o">,</span> <span class="mi">10000</span><span class="o">);</span> <span class="c1">// 连接超时 5 秒，读取超时 10 秒</span>
<span class="o">}</span>
</code></pre></div></div></li></ul><p><strong>服务健康检查与负载均衡</strong></p><ul><li><strong>服务健康检查</strong>：确保目标服务在注册中心是健康的，否则 Feign 会找不到可用的实例。可以定期检查目标服务的健康状态。</li><li><strong>负载均衡</strong>：Feign 通常与 Ribbon 一起使用，支持负载均衡调用多实例服务。确保注册中心中的服务实例都能够被正确负载均衡。</li></ul><p><strong>版本兼容性</strong></p><ul><li><strong>服务接口版本兼容</strong>：远程服务的接口可能会发生变更，因此需要定期检查服务接口是否有变化，确保调用方和提供方之间的接口保持兼容性，尤其是请求参数或返回值格式的变化。</li></ul><p>确保这些关键点能够帮助你在使用 Feign 客户端时避免常见的错误，并确保系统的健壮性和可扩展性。</p><hr /><p>一个简单的完整实例：</p><p>假设服务<code class="language-plaintext highlighter-rouge">A</code>，有如下接口：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/pi"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductInventoryController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ProductInventoryMapper</span> <span class="n">productInventoryMapper</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/getAll"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProductInventory</span><span class="o">&gt;</span> <span class="nf">getAllUsers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">productInventoryMapper</span><span class="o">.</span><span class="na">selectAll</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/add"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">ProductInventory</span> <span class="n">productInventory</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">productInventoryMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">productInventory</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>则服务<code class="language-plaintext highlighter-rouge">B</code>，如果需要调用服务<code class="language-plaintext highlighter-rouge">A</code>的接口，可以这样定义Feign：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="nc">DemoServiceFeignFallBack</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">configuration</span> <span class="o">=</span> <span class="o">{</span><span class="nc">FeginConfig</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DemoServiceFeign</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/pi/getAll"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProductInventory</span><span class="o">&gt;</span> <span class="nf">getAllUsers</span><span class="o">();</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/pi/add"</span><span class="o">)</span>
    <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">ProductInventory</span> <span class="n">productInventory</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>注意<code class="language-plaintext highlighter-rouge">ProductInventory</code>类结构要保持一致。</p><p>然后可以这样调用Feign：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/feign"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeignTestController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">DemoServiceFeign</span> <span class="n">demoServiceFeign</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/getAll"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ProductInventory</span><span class="o">&gt;</span> <span class="nf">getAllUsers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">demoServiceFeign</span><span class="o">.</span><span class="na">getAllUsers</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/add"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">ProductInventory</span> <span class="n">productInventory</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">demoServiceFeign</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="n">productInventory</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>如果不希望在服务 <code class="language-plaintext highlighter-rouge">B</code> 中创建 <code class="language-plaintext highlighter-rouge">ProductInventory</code> 类，可以使用 <code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code> 或 <code class="language-plaintext highlighter-rouge">JSONObject</code> 来代替对象传递数据。这样，<code class="language-plaintext highlighter-rouge">Feign</code> 接口可以通过动态对象来进行调用。</p><p>修改后的 Feign 接口：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="nc">DemoServiceFeignFallBack</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">configuration</span> <span class="o">=</span> <span class="o">{</span><span class="nc">FeginConfig</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DemoServiceFeign</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/pi/getAll"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="nf">getAllUsers</span><span class="o">();</span>  <span class="c1">// 使用 Map 代替 ProductInventory</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/pi/add"</span><span class="o">)</span>
    <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">productInventory</span><span class="o">);</span>  <span class="c1">// 使用 Map 传递数据</span>
<span class="o">}</span>
</code></pre></div></div><p>修改后的调用方法：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/feign"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeignTestController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">DemoServiceFeign</span> <span class="n">demoServiceFeign</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/getAll"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="nf">getAllUsers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">demoServiceFeign</span><span class="o">.</span><span class="na">getAllUsers</span><span class="o">();</span>  <span class="c1">// 获取 Map 类型的结果</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/add"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">addUser</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">productInventory</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">demoServiceFeign</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="n">productInventory</span><span class="o">);</span>  <span class="c1">// 传递 Map 类型的数据</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>优点</strong>：避免了在服务 <code class="language-plaintext highlighter-rouge">B</code> 中定义 <code class="language-plaintext highlighter-rouge">ProductInventory</code> 类。</p><p><strong>缺点</strong>：使用 <code class="language-plaintext highlighter-rouge">Map</code> 或 <code class="language-plaintext highlighter-rouge">JSONObject</code> 使代码的类型检查变得不那么严格，容易出错，并且不如直接使用实体类那么清晰和安全。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="" target="_blank">acteds</a></li><li>本文链接：<a href="/2024/09/18/OpenFeign/" target="_blank">https://acteds.github.io/2024/09/18/OpenFeign/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://beaudar.lipk.org/client.js" repo="mzlogin/blog-comments" issue-term="title" label="gitment" theme="github-light" comment-order="desc" input-position="top" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: '/assets/search_data.json?v=1728036161', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="acteds">acteds</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/acteds/acteds.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="/" title="首页" target="">首页</a></li><li> <a href="/categories/" title="分类" target="">分类</a></li><li> <a href="/wiki/" title="维基" target="">维基</a></li><li> <a href="/about/" title="关于" target="">关于</a></li><li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
