<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Spring Boot &mdash; 个人博客</title><link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="/assets/css/components/collection.css"><link rel="stylesheet" href="/assets/css/components/repo-card.css"><link rel="stylesheet" href="/assets/css/sections/repo-list.css"><link rel="stylesheet" href="/assets/css/components/boxed-group.css"><link rel="stylesheet" href="/assets/css/globals/common.css"><link rel="stylesheet" href="/assets/css/globals/responsive.css"><link rel="stylesheet" href="/assets/css/posts/index.css"><link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/highlight/monokai.sublime.css"><link rel="canonical" href="/2024/07/09/Spring-Boot/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="/feed.xml"><link rel="shortcut icon" href="/favicon.ico"><meta property="og:title" content="Spring Boot"><meta name="keywords" content="Java"><meta name="og:keywords" content="Java"><meta name="description" content="引言Spring Boot笔记"><meta name="og:description" content="引言Spring Boot笔记"><meta property="og:url" content="/2024/07/09/Spring-Boot/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2024-07-09"> <script src="/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="/assets/js/jquery-ui.js"></script> <script src="/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Spring Boot"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Spring Boot</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2024/07/09 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#Java" title="Java">Java</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 27688 字，约 80 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="引言">引言</h1><p>Spring Boot笔记</p><h1 id="spring-boot">Spring Boot</h1><p>Spring框架，它的主要功能包括IoC容器、AOP支持、事务支持、MVC开发以及强大的第三方集成功能等。而Spring Boot是一个基于Spring的套件，它帮我们预组装了Spring的一系列组件，以便以尽可能少的代码和配置来开发基于Spring的Java应用程序。</p><p>Spring Boot的目标就是提供一个开箱即用的应用程序架构，基于Spring Boot的预置结构继续开发，省时省力。</p><p>Spring Boot3.x版与Spring Boot 2.x版本，两者有以下不同：</p><table><thead><tr><th style="text-align: left"> </th><th style="text-align: left">Spring Boot 2.x</th><th style="text-align: left">Spring Boot 3.x</th></tr></thead><tbody><tr><td style="text-align: left">Spring版本</td><td style="text-align: left">Spring 5.x</td><td style="text-align: left">Spring 6.x</td></tr><tr><td style="text-align: left">JDK版本</td><td style="text-align: left">&gt;= 1.8</td><td style="text-align: left">&gt;= 17</td></tr><tr><td style="text-align: left">Tomcat版本</td><td style="text-align: left">9.x</td><td style="text-align: left">10.x</td></tr><tr><td style="text-align: left">Annotation包</td><td style="text-align: left">javax.annotation</td><td style="text-align: left">jakarta.annotation</td></tr><tr><td style="text-align: left">Servlet包</td><td style="text-align: left">javax.servlet</td><td style="text-align: left">jakarta.servlet</td></tr><tr><td style="text-align: left">JMS包</td><td style="text-align: left">javax.jms</td><td style="text-align: left">jakarta.jms</td></tr><tr><td style="text-align: left">JavaMail包</td><td style="text-align: left">javax.mail</td><td style="text-align: left">jakarta.mail</td></tr></tbody></table><p>如果使用Spring Boot的其他版本，则需要根据需要调整代码。</p><p><a href="https://spring.io/projects/spring-boot">Spring Boot的官网</a>。</p><h2 id="标准spring-boot应用">标准Spring Boot应用</h2><p>新建一个<code class="language-plaintext highlighter-rouge">springboot-hello</code>的工程，创建标准的Maven目录结构如下：</p><pre><code class="language-ascii">springboot-hello
├── pom.xml
├── src
│   └── main
│       ├── java
│       └── resources
│           ├── application.yml
│           ├── logback-spring.xml
│           ├── static
│           └── templates
└── target
</code></pre><p>其中，在<code class="language-plaintext highlighter-rouge">src/main/resources</code>目录下：</p><p><strong>application.yml</strong></p><p>是Spring Boot默认的配置文件，它采用<a href="https://yaml.org/">YAML</a>格式而不是<code class="language-plaintext highlighter-rouge">.properties</code>格式，<strong>文件名必须是<code class="language-plaintext highlighter-rouge">application.yml</code>而不是其他名称。</strong></p><p>YAML格式比<code class="language-plaintext highlighter-rouge">key=value</code>格式的<code class="language-plaintext highlighter-rouge">.properties</code>文件更易读。比较一下两者的写法：</p><p>使用<code class="language-plaintext highlighter-rouge">.properties</code>格式：</p><div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># application.properties
</span>
<span class="py">spring.application.name</span><span class="p">=</span><span class="s">${APP_NAME:unnamed}</span>

<span class="py">spring.datasource.url</span><span class="p">=</span><span class="s">jdbc:hsqldb:file:testdb</span>
<span class="py">spring.datasource.username</span><span class="p">=</span><span class="s">sa</span>
<span class="py">spring.datasource.password</span><span class="p">=</span>
<span class="py">spring.datasource.driver-class-name</span><span class="p">=</span><span class="s">org.hsqldb.jdbc.JDBCDriver</span>

<span class="py">spring.datasource.hikari.auto-commit</span><span class="p">=</span><span class="s">false</span>
<span class="py">spring.datasource.hikari.connection-timeout</span><span class="p">=</span><span class="s">3000</span>
<span class="py">spring.datasource.hikari.validation-timeout</span><span class="p">=</span><span class="s">3000</span>
<span class="py">spring.datasource.hikari.max-lifetime</span><span class="p">=</span><span class="s">60000</span>
<span class="py">spring.datasource.hikari.maximum-pool-size</span><span class="p">=</span><span class="s">20</span>
<span class="py">spring.datasource.hikari.minimum-idle</span><span class="p">=</span><span class="s">1</span>
</code></pre></div></div><p>使用YAML格式：</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># application.yml</span>

<span class="na">spring</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">${APP_NAME:unnamed}</span>
  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:hsqldb:mem:testdb</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">sa</span>
    <span class="na">password</span><span class="pi">:</span>
    <span class="na">driver-class-name</span><span class="pi">:</span> <span class="s">org.hsqldb.jdbc.JDBCDriver</span>
    <span class="na">hikari</span><span class="pi">:</span>
      <span class="na">auto-commit</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">connection-timeout</span><span class="pi">:</span> <span class="m">3000</span>
      <span class="na">validation-timeout</span><span class="pi">:</span> <span class="m">3000</span>
      <span class="na">max-lifetime</span><span class="pi">:</span> <span class="m">60000</span>
      <span class="na">maximum-pool-size</span><span class="pi">:</span> <span class="m">20</span>
      <span class="na">minimum-idle</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div></div><p>可见，YAML是一种层级格式，它和<code class="language-plaintext highlighter-rouge">.properties</code>很容易互相转换，它的优点是去掉了大量重复的前缀，并且更加易读。</p><p><strong>也可以使用<code class="language-plaintext highlighter-rouge">application.properties</code>作为配置文件</strong>，但不如YAML格式简单。</p><p><strong>使用环境变量</strong></p><p>在配置文件中，经常使用如下的格式对某个key进行配置：</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">app</span><span class="pi">:</span>
  <span class="na">db</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="s">${DB_HOST:localhost}</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">${DB_USER:root}</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">${DB_PASSWORD:password}</span>
</code></pre></div></div><p>这种<code class="language-plaintext highlighter-rouge">${DB_HOST:localhost}</code>意思是，首先从环境变量查找<code class="language-plaintext highlighter-rouge">DB_HOST</code>，如果环境变量定义了，那么使用环境变量的值，否则，使用默认值<code class="language-plaintext highlighter-rouge">localhost</code>。</p><p>这使得我们在开发和部署时更加方便，因为开发时无需设定任何环境变量，直接使用默认值即本地数据库，而实际线上运行的时候，只需要传入环境变量即可：</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ DB_HOST</span><span class="o">=</span>10.0.1.123 <span class="nv">DB_USER</span><span class="o">=</span>prod <span class="nv">DB_PASSWORD</span><span class="o">=</span>xxxx java <span class="nt">-jar</span> xxx.jar
</code></pre></div></div><hr /><p><strong>logback-spring.xml</strong>是Spring Boot的logback配置文件名称（也可以使用<code class="language-plaintext highlighter-rouge">logback.xml</code>），一个标准的写法如下：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;include</span> <span class="na">resource=</span><span class="s">"org/springframework/boot/logging/logback/defaults.xml"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"CONSOLE"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.ConsoleAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>${CONSOLE_LOG_PATTERN}<span class="nt">&lt;/pattern&gt;</span>
            <span class="nt">&lt;charset&gt;</span>utf8<span class="nt">&lt;/charset&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>

    <span class="nt">&lt;appender</span> <span class="na">name=</span><span class="s">"APP_LOG"</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.RollingFileAppender"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;encoder&gt;</span>
            <span class="nt">&lt;pattern&gt;</span>${FILE_LOG_PATTERN}<span class="nt">&lt;/pattern&gt;</span>
            <span class="nt">&lt;charset&gt;</span>utf8<span class="nt">&lt;/charset&gt;</span>
        <span class="nt">&lt;/encoder&gt;</span>
          <span class="nt">&lt;file&gt;</span>app.log<span class="nt">&lt;/file&gt;</span>
        <span class="nt">&lt;rollingPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.FixedWindowRollingPolicy"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;maxIndex&gt;</span>1<span class="nt">&lt;/maxIndex&gt;</span>
            <span class="nt">&lt;fileNamePattern&gt;</span>app.log.%i<span class="nt">&lt;/fileNamePattern&gt;</span>
        <span class="nt">&lt;/rollingPolicy&gt;</span>
        <span class="nt">&lt;triggeringPolicy</span> <span class="na">class=</span><span class="s">"ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;MaxFileSize&gt;</span>1MB<span class="nt">&lt;/MaxFileSize&gt;</span>
        <span class="nt">&lt;/triggeringPolicy&gt;</span>
    <span class="nt">&lt;/appender&gt;</span>

    <span class="nt">&lt;root</span> <span class="na">level=</span><span class="s">"INFO"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"CONSOLE"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;appender-ref</span> <span class="na">ref=</span><span class="s">"APP_LOG"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/root&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div><p>它主要通过<code class="language-plaintext highlighter-rouge">&lt;include resource="..." /&gt;</code>引入了Spring Boot的一个缺省配置，这样我们就可以引用类似<code class="language-plaintext highlighter-rouge">${CONSOLE_LOG_PATTERN}</code>这样的变量。上述配置定义了一个控制台输出和文件输出，可根据需要修改。</p><p><code class="language-plaintext highlighter-rouge">static</code>是静态文件目录，<code class="language-plaintext highlighter-rouge">templates</code>是模板文件目录，它们不再存放在<code class="language-plaintext highlighter-rouge">src/main/webapp</code>下，而是直接放到<code class="language-plaintext highlighter-rouge">src/main/resources</code>这个classpath目录，因为在Spring Boot中已经不需要专门的webapp目录了。</p><p>以上就是Spring Boot的标准目录结构，它完全是一个基于Java应用的普通Maven项目。</p><p>源码的目录结构：</p><pre><code class="language-ascii">src/main/java
└── com.aotmd
    ├── Application.java
    ├── entity
    │   └── User.java
    ├── service
    │   └── UserService.java
    └── web
        └── UserController.java
</code></pre><p>在存放源码的<code class="language-plaintext highlighter-rouge">src/main/java</code>目录中，Spring Boot对Java包的层级结构有一个要求。根package是<code class="language-plaintext highlighter-rouge">com.aotmd</code>，下面还有<code class="language-plaintext highlighter-rouge">entity</code>、<code class="language-plaintext highlighter-rouge">service</code>、<code class="language-plaintext highlighter-rouge">web</code>等子package。Spring Boot要求<code class="language-plaintext highlighter-rouge">main()</code>方法所在的启动类必须放到根package下，命名不做要求，这里以<code class="language-plaintext highlighter-rouge">Application.java</code>命名，它的内容如下：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>启动Spring Boot应用程序只需要一行代码加上一个注解<code class="language-plaintext highlighter-rouge">@SpringBootApplication</code>，该注解实际上又包含了：</p><ul><li>@SpringBootConfiguration<ul><li>@Configuration</li></ul></li><li>@EnableAutoConfiguration<ul><li>@AutoConfigurationPackage</li></ul></li><li>@ComponentScan</li></ul><p>这样一个注解就相当于启动了自动配置和自动扫描。</p><p><code class="language-plaintext highlighter-rouge">pom.xml</code>内容如下：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>org.example<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-hello<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;maven.compiler.source&gt;</span>11<span class="nt">&lt;/maven.compiler.source&gt;</span>
        <span class="nt">&lt;maven.compiler.target&gt;</span>11<span class="nt">&lt;/maven.compiler.target&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.2.4.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;relativePath/&gt;</span> <span class="c">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- 集成Pebble View --&gt;</span>
        <span class="c">&lt;!-- https://mvnrepository.com/artifact/io.pebbletemplates/pebble-spring-boot-starter --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>io.pebbletemplates<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>pebble-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.1.3<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="c">&lt;!-- JDBC驱动 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.hsqldb<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hsqldb<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div><p>使用Spring Boot时，强烈推荐从<code class="language-plaintext highlighter-rouge">spring-boot-starter-parent</code>继承，因为这样就可以引入Spring Boot的预置配置。</p><p>紧接着，引入了依赖<code class="language-plaintext highlighter-rouge">spring-boot-starter-web</code>和<code class="language-plaintext highlighter-rouge">spring-boot-starter-jdbc</code>，它们分别引入了Spring MVC相关依赖和Spring JDBC相关依赖，无需指定版本号，因为引入的<code class="language-plaintext highlighter-rouge">&lt;parent&gt;</code>内已经指定了，只有我们自己引入的某些第三方jar包需要指定版本号。这里引入<code class="language-plaintext highlighter-rouge">pebble-spring-boot-starter</code>作为View，以及<code class="language-plaintext highlighter-rouge">hsqldb</code>作为嵌入式数据库。<code class="language-plaintext highlighter-rouge">hsqldb</code>已在<code class="language-plaintext highlighter-rouge">spring-boot-starter-jdbc</code>中预置了版本号，因此此处无需指定版本号。</p><p><strong>第三方jar的版本兼容性可以查看<a href="https://mvnrepository.com/artifact/io.pebbletemplates/pebble-spring-boot-starter/3.1.3">mvnrepository</a>下的Compile Dependencies查看兼容性。</strong></p><p>根据<code class="language-plaintext highlighter-rouge">pebble-spring-boot-starter</code>的<a href="https://pebbletemplates.io/wiki/guide/spring-boot-integration/">文档</a>，加入如下配置到<code class="language-plaintext highlighter-rouge">application.yml</code>：</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pebble</span><span class="pi">:</span>
  <span class="c1"># 默认为".peb"，改为"":</span>
  <span class="na">suffix</span><span class="pi">:</span>
  <span class="c1"># 开发阶段禁用模板缓存:</span>
  <span class="na">cache</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">prefix</span><span class="pi">:</span> <span class="s">/templates/</span>
</code></pre></div></div><p>对<code class="language-plaintext highlighter-rouge">Application</code>稍作改动，添加<code class="language-plaintext highlighter-rouge">WebMvcConfigurer</code>这个Bean：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Bean</span>
    <span class="nc">WebMvcConfigurer</span> <span class="nf">createWebMvcConfigurer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">WebMvcConfigurer</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addResourceHandlers</span><span class="o">(</span><span class="nc">ResourceHandlerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 映射路径`/static/`到classpath路径:</span>
                <span class="n">registry</span><span class="o">.</span><span class="na">addResourceHandler</span><span class="o">(</span><span class="s">"/static/**"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">addResourceLocations</span><span class="o">(</span><span class="s">"classpath:/static/"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>现在就可以直接运行<code class="language-plaintext highlighter-rouge">Application</code>，Spring Boot自动启动了嵌入式Tomcat，当看到<code class="language-plaintext highlighter-rouge">Started Application in xxx seconds</code>时，Spring Boot应用启动成功。</p><p>添加测试：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Controller</span>
<span class="kd">class</span> <span class="nc">TestController</span><span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/test1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">test</span><span class="o">(){</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"body"</span><span class="o">,</span><span class="s">"你好"</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span><span class="s">"测试"</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ModelAndView</span><span class="o">(</span><span class="s">"test.html"</span><span class="o">,</span><span class="n">map</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>test.html:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>访问：<code class="language-plaintext highlighter-rouge">http://localhost:8080/test1</code>：</p><p>显示：<code class="language-plaintext highlighter-rouge">你好</code></p><hr /><p>之前我们定义的数据源、声明式事务、JdbcTemplate在哪创建的？怎么就可以直接注入到自己编写的<code class="language-plaintext highlighter-rouge">UserService</code>中呢？</p><p>这些自动创建的Bean就是Spring Boot的特色：AutoConfiguration。</p><p>当引入<code class="language-plaintext highlighter-rouge">spring-boot-starter-jdbc</code>时，启动时会自动扫描所有的<code class="language-plaintext highlighter-rouge">XxxAutoConfiguration</code>：</p><ul><li><code class="language-plaintext highlighter-rouge">DataSourceAutoConfiguration</code>：自动创建一个<code class="language-plaintext highlighter-rouge">DataSource</code>，其中配置项从<code class="language-plaintext highlighter-rouge">application.yml</code>的<code class="language-plaintext highlighter-rouge">spring.datasource</code>读取；</li><li><code class="language-plaintext highlighter-rouge">DataSourceTransactionManagerAutoConfiguration</code>：自动创建了一个基于JDBC的事务管理器；</li><li><code class="language-plaintext highlighter-rouge">JdbcTemplateAutoConfiguration</code>：自动创建了一个<code class="language-plaintext highlighter-rouge">JdbcTemplate</code>。</li></ul><p>因此，自动得到了一个<code class="language-plaintext highlighter-rouge">DataSource</code>、一个<code class="language-plaintext highlighter-rouge">DataSourceTransactionManager</code>和一个<code class="language-plaintext highlighter-rouge">JdbcTemplate</code>。</p><p>类似的，当引入<code class="language-plaintext highlighter-rouge">spring-boot-starter-web</code>时，自动创建了：</p><ul><li><code class="language-plaintext highlighter-rouge">ServletWebServerFactoryAutoConfiguration</code>：自动创建一个嵌入式Web服务器，默认是Tomcat；</li><li><code class="language-plaintext highlighter-rouge">DispatcherServletAutoConfiguration</code>：自动创建一个<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>；</li><li><code class="language-plaintext highlighter-rouge">HttpEncodingAutoConfiguration</code>：自动创建一个<code class="language-plaintext highlighter-rouge">CharacterEncodingFilter</code>；</li><li><code class="language-plaintext highlighter-rouge">WebMvcAutoConfiguration</code>：自动创建若干与MVC相关的Bean。</li><li>…</li></ul><p>引入第三方<code class="language-plaintext highlighter-rouge">pebble-spring-boot-starter</code>时，自动创建了：</p><ul><li><code class="language-plaintext highlighter-rouge">PebbleAutoConfiguration</code>：自动创建了一个<code class="language-plaintext highlighter-rouge">PebbleViewResolver</code>。</li></ul><p>Spring Boot大量使用<code class="language-plaintext highlighter-rouge">XxxAutoConfiguration</code>来使得许多组件被自动化配置并创建，而这些创建过程又大量使用了Spring的Conditional功能。例如<code class="language-plaintext highlighter-rouge">JdbcTemplateAutoConfiguration</code>，它的代码如下：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">JdbcTemplate</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="nd">@ConditionalOnSingleCandidate</span><span class="o">(</span><span class="nc">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@AutoConfigureAfter</span><span class="o">(</span><span class="nc">DataSourceAutoConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="nc">JdbcProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Import</span><span class="o">({</span> <span class="nc">JdbcTemplateConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">NamedParameterJdbcTemplateConfiguration</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JdbcTemplateAutoConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div><p>当满足条件：</p><ul><li><code class="language-plaintext highlighter-rouge">@ConditionalOnClass</code>：在classpath中能找到<code class="language-plaintext highlighter-rouge">DataSource</code>和<code class="language-plaintext highlighter-rouge">JdbcTemplate</code>；</li><li><code class="language-plaintext highlighter-rouge">@ConditionalOnSingleCandidate(DataSource.class)</code>：在当前Bean的定义中能找到唯一的<code class="language-plaintext highlighter-rouge">DataSource</code>；</li></ul><p>该<code class="language-plaintext highlighter-rouge">JdbcTemplateAutoConfiguration</code>就会起作用。实际创建由导入的<code class="language-plaintext highlighter-rouge">JdbcTemplateConfiguration</code>完成：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="nc">JdbcOperations</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">JdbcTemplateConfiguration</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Primary</span>
    <span class="nc">JdbcTemplate</span> <span class="nf">jdbcTemplate</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">,</span> <span class="nc">JdbcProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
        <span class="nc">JdbcProperties</span><span class="o">.</span><span class="na">Template</span> <span class="n">template</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">();</span>
        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">setFetchSize</span><span class="o">(</span><span class="n">template</span><span class="o">.</span><span class="na">getFetchSize</span><span class="o">());</span>
        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">setMaxRows</span><span class="o">(</span><span class="n">template</span><span class="o">.</span><span class="na">getMaxRows</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">template</span><span class="o">.</span><span class="na">getQueryTimeout</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">setQueryTimeout</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">template</span><span class="o">.</span><span class="na">getQueryTimeout</span><span class="o">().</span><span class="na">getSeconds</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>创建<code class="language-plaintext highlighter-rouge">JdbcTemplate</code>之前，要满足<code class="language-plaintext highlighter-rouge">@ConditionalOnMissingBean(JdbcOperations.class)</code>，即不存在<code class="language-plaintext highlighter-rouge">JdbcOperations</code>的Bean。</p><p>如果自己创建了一个<code class="language-plaintext highlighter-rouge">JdbcTemplate</code>，例如，在<code class="language-plaintext highlighter-rouge">Application</code>中自己写个方法：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Bean</span>
    <span class="nc">JdbcTemplate</span> <span class="nf">createJdbcTemplate</span><span class="o">(</span><span class="nd">@Autowired</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>那么根据条件<code class="language-plaintext highlighter-rouge">@ConditionalOnMissingBean(JdbcOperations.class)</code>，Spring Boot就不会再创建一个重复的<code class="language-plaintext highlighter-rouge">JdbcTemplate</code>（因为<code class="language-plaintext highlighter-rouge">JdbcOperations</code>是<code class="language-plaintext highlighter-rouge">JdbcTemplate</code>的父类）。</p><p>可见，Spring Boot自动装配功能是通过自动扫描+条件装配实现的，这一套机制在默认情况下工作得很好，但是，如果要手动控制某个Bean的创建，就需要详细地了解Spring Boot自动创建的原理，很多时候还要跟踪<code class="language-plaintext highlighter-rouge">XxxAutoConfiguration</code>，以便设定条件使得某个Bean不会被自动创建。</p><hr /><h2 id="集成mybatis">集成mybatis</h2><p>引入对应版本的依赖即可：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/org.mybatis.spring.boot/mybatis-spring-boot-starter --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.2.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>yml文件添加映射文件位置：</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">mybatis</span><span class="pi">:</span>
  <span class="na">mapper-locations</span><span class="pi">:</span> <span class="s">classpath:mapper/*.xml</span>

<span class="na">logging</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span>
    <span class="na">root</span><span class="pi">:</span> <span class="s">INFO</span>
    <span class="na">com.aotmd</span><span class="pi">:</span> <span class="s">DEBUG</span>
    <span class="na">org.mybatis</span><span class="pi">:</span> <span class="s">DEBUG</span>
</code></pre></div></div><p>然后添加之前Spring的非配置部分：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">User</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">User</span><span class="o">()</span> <span class="o">{}</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getPassword</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getCreatedAt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCreatedAt</span><span class="o">(</span><span class="nc">Long</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span> <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span><span class="k">return</span> <span class="s">"User{id="</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">", email='"</span> <span class="o">+</span> <span class="n">email</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span> <span class="s">", password='"</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span> <span class="s">", name='"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span> <span class="s">", createdAt="</span> <span class="o">+</span> <span class="n">createdAt</span> <span class="o">+</span> <span class="sc">'}'</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">interface</span> <span class="nc">UserMapper</span> <span class="o">{</span>
    <span class="nc">User</span> <span class="nf">getById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">);</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"offset"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"maxResults"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">maxResults</span><span class="o">);</span>
    <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span> <span class="nc">User</span> <span class="n">user</span><span class="o">);</span>
    <span class="kt">int</span> <span class="nf">insert2</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span> <span class="nc">User</span> <span class="n">user</span><span class="o">);</span>
    <span class="kt">int</span> <span class="nf">updateName</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span> <span class="nc">User</span> <span class="n">user</span><span class="o">);</span>
    <span class="kt">int</span> <span class="nf">deleteById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">);</span>
    <span class="nc">User</span> <span class="nf">getByEmailAndByPassword</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span> <span class="nc">User</span> <span class="n">user</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">init</span><span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//在Spring容器启动时自动创建一个users表</span>
        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"DROP TABLE IF EXISTS users"</span><span class="o">);</span>
        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">"CREATE TABLE IF NOT EXISTS users ("</span>
                <span class="o">+</span> <span class="s">"id BIGINT IDENTITY NOT NULL PRIMARY KEY, "</span>
                <span class="o">+</span> <span class="s">"email VARCHAR(100) NOT NULL, "</span>
                <span class="o">+</span> <span class="s">"password VARCHAR(100) NOT NULL, "</span>
                <span class="o">+</span> <span class="s">"name VARCHAR(100) NOT NULL, "</span>
                <span class="o">+</span> <span class="s">"createdAt BIGINT NOT NULL, "</span>
                <span class="o">+</span> <span class="s">"UNIQUE (email))"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="c1">// 注入UserMapper:</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserMapper</span> <span class="n">userMapper</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getById</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 调用Mapper方法:</span>
        <span class="k">return</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">offset</span><span class="o">,</span><span class="kt">int</span> <span class="n">maxResults</span><span class="o">){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">all</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">getAll</span><span class="o">(</span><span class="n">offset</span><span class="o">,</span> <span class="n">maxResults</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">all</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">register</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">){</span>
        <span class="c1">// 创建一个User对象:</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
        <span class="c1">// 设置好各个属性:</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
        <span class="c1">// 不要设置id，因为使用了自增主键</span>
        <span class="c1">// 保存到数据库:</span>
        <span class="n">userMapper</span><span class="o">.</span><span class="na">insert2</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="c1">// 现在已经自动获得了id:</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">updateEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">){</span>
        <span class="c1">// 创建一个User对象:</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
        <span class="c1">// 设置好各个属性:</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">updateName</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">delete</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">){</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">userMapper</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">i</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">login</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">){</span>
        <span class="c1">// 创建一个User对象:</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
        <span class="c1">// 设置好各个属性:</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="n">email</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>
        <span class="n">user</span><span class="o">=</span><span class="n">userMapper</span><span class="o">.</span><span class="na">getByEmailAndByPassword</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">ApiController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/users"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">users</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getAll</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">5</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/users/{id}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">user</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/signin"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">signin</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="nc">SignInRequest</span> <span class="n">signinRequest</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">signinRequest</span><span class="o">.</span><span class="na">email</span><span class="o">,</span> <span class="n">signinRequest</span><span class="o">.</span><span class="na">password</span><span class="o">,</span><span class="n">signinRequest</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="s">"SIGNIN_FAILED"</span><span class="o">,</span> <span class="s">"message"</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SignInRequest</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="n">email</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>映射文件也与之前相同：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"com.aotmd.UserMapper"</span><span class="nt">&gt;</span><span class="c">&lt;!--命名空间为接口名称--&gt;</span>
    <span class="c">&lt;!--id需与接口方法完全一致,parameterType形参,resultType返回值类型--&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"getById"</span> <span class="na">parameterType=</span><span class="s">"Long"</span> <span class="na">resultType=</span><span class="s">"com.aotmd.User"</span><span class="nt">&gt;</span>
        SELECT *
        FROM users
        WHERE id = #{id}
    <span class="nt">&lt;/select&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"getAll"</span>  <span class="na">resultType=</span><span class="s">"com.aotmd.User"</span><span class="nt">&gt;</span>
        SELECT *
        FROM users LIMIT #{offset}, #{maxResults}
    <span class="nt">&lt;/select&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"getByEmailAndByPassword"</span> <span class="na">resultType=</span><span class="s">"com.aotmd.User"</span><span class="nt">&gt;</span>
        SELECT *
        FROM users
        WHERE email = #{user.email} and
        password=#{user.password}
    <span class="nt">&lt;/select&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">"insert"</span> <span class="na">parameterType=</span><span class="s">"com.aotmd.User"</span><span class="nt">&gt;</span>
        INSERT INTO users (email, password, name, createdAt)
        VALUES (#{user.email}, #{user.password}, #{user.name}, #{user.createdAt})
    <span class="nt">&lt;/insert&gt;</span>
    <span class="nt">&lt;insert</span> <span class="na">id=</span><span class="s">"insert2"</span> <span class="na">parameterType=</span><span class="s">"com.aotmd.User"</span> <span class="na">useGeneratedKeys=</span><span class="s">"true"</span> <span class="na">keyProperty=</span><span class="s">"id"</span> <span class="na">keyColumn=</span><span class="s">"id"</span><span class="nt">&gt;</span>
        INSERT INTO users (email, password, name, createdAt)
        VALUES (#{user.email}, #{user.password}, #{user.name}, #{user.createdAt})
    <span class="nt">&lt;/insert&gt;</span>

    <span class="nt">&lt;update</span> <span class="na">id=</span><span class="s">"updateName"</span> <span class="na">parameterType=</span><span class="s">"com.aotmd.User"</span><span class="nt">&gt;</span>
        UPDATE users
        SET name = #{user.name}
        WHERE id = #{user.id}
    <span class="nt">&lt;/update&gt;</span>

    <span class="nt">&lt;delete</span> <span class="na">id=</span><span class="s">"deleteById"</span> <span class="na">parameterType=</span><span class="s">"long"</span><span class="nt">&gt;</span>
        DELETE
        FROM users
        WHERE id = #{id}
    <span class="nt">&lt;/delete&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div></div><p>启动，然后post访问<code class="language-plaintext highlighter-rouge">http://localhost:8080/api/signin</code>，附带json：<code class="language-plaintext highlighter-rouge">{"email":"tom@example.com","password":"tomcat","name":"test"}</code>，返回body：<code class="language-plaintext highlighter-rouge">{"user":{"id":0,"email":"tom@example.com","password":"tomcat","name":"test","createdAt":***}}</code></p><p>再get访问<code class="language-plaintext highlighter-rouge">http://localhost:8080/api/users</code>，得到：<code class="language-plaintext highlighter-rouge">[{"id":0,"email":"tom@example.com","password":"tomcat","name":"test","createdAt":***}]</code></p><p>功能正常。</p><h2 id="spring-boot-devtools">spring-boot-devtools</h2><p>在开发阶段，我们经常要修改代码，然后重启Spring Boot应用。经常手动停止再启动，比较麻烦。</p><p>Spring Boot提供了一个开发者工具，可以监控classpath路径上的文件。只要源码或配置文件发生修改，Spring Boot应用可以自动重启。在开发阶段，这个功能比较有用。</p><p>要使用这一开发者功能，只需添加如下依赖到<code class="language-plaintext highlighter-rouge">pom.xml</code>：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-devtools<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>然后，没有然后了。直接启动应用程序，然后试着修改源码，保存，观察日志输出，Spring Boot会自动重新加载。</p><p>默认配置下，针对<code class="language-plaintext highlighter-rouge">/static</code>、<code class="language-plaintext highlighter-rouge">/public</code>和<code class="language-plaintext highlighter-rouge">/templates</code>目录中的文件修改，不会自动重启，因为禁用缓存后，这些文件的修改可以实时更新。</p><hr /><p>如果没有效果，那需要修改以下设置：</p><ol><li><p>设置IDEA的编译器：</p><ul><li>File-&gt;Settings…-&gt;Build,Execution,Deployment-&gt;Compiler，勾选”Build project automatically”</li><li>文件-&gt;设置…-&gt;构建、执行、部署-&gt;编译器，勾选”自动构建项目”</li></ul></li><li><p>应用程序运行时允许编译器自动生成：</p><ul><li>在IntellijIDEA中：按Ctrl+Shift+a，然后键入“注册表”并点击它。然后启用选项“compiler.Automake.Allow.When.app.Running”。</li><li>在新版本这个选项已经被移到了高级设置中，文件-&gt;设置…-&gt;高级设置-&gt;编译器栏-&gt;“即使开发的应用程序当前正在运行，也允许自动make启动”。</li></ul></li></ol><p>还有可能是项目名称的问题：</p><p>在决定类路径上的条目更改时是否应触发重启时，DevTools会自动忽略名为Spring-Boot、Spring-Boot-DevTools、Spring-Boot-Autoconfiguration、Spring-Boot-Actuator和Spring-Boot-starter的项目。</p><p>使用Ctrl+F9构建项目<strong>会自动触发重新启动</strong>。如果您希望在保存类文件后立即自动触发，可以按照问题中提供的热插拔链接进行操作。</p><p>Spring Boot还具有在特定文件发生更改时触发重新启动的选项，可以使用以下属性在应用程序中配置该选项</p><blockquote><p>spring.devtools.restart.trigger-file=</p><p>Spring.devtools.restart.rigger-file=</p></blockquote><p>参见： <a href="https://stackoverflow.com/questions/53569745/spring-boot-developer-tools-auto-restart-doesnt-work-in-intellij">Spring Boot Developer Tools Auto restart doesn’t work in IntelliJ</a></p><h2 id="打包spring-boot应用">打包Spring Boot应用</h2><p>在Spring Boot应用中，Spring Boot自带一个更简单的<code class="language-plaintext highlighter-rouge">spring-boot-maven-plugin</code>插件用来打包，只需要在<code class="language-plaintext highlighter-rouge">pom.xml</code>中加入以下配置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;project</span> <span class="err">...</span><span class="nt">&gt;</span>
    ...
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div><p>无需任何配置，Spring Boot的这款插件会自动定位应用程序的入口Class，执行以下Maven命令即可打包：</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn clean package
</code></pre></div></div><p>以<code class="language-plaintext highlighter-rouge">spring-boot-hello</code>项目为例，打包后在<code class="language-plaintext highlighter-rouge">target</code>目录下可以看到两个jar文件：</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spring-boot-hello-1.0-SNAPSHOT.jar
spring-boot-hello-1.0-SNAPSHOT.jar.original
</code></pre></div></div><p>其中，<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar.original</code>是Maven标准打包插件打的jar包，它只包含我们自己的Class，不包含依赖，而<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar</code>是Spring Boot打包插件创建的包含依赖的jar，可以直接运行：</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-jar</span> springboot-exec-jar-1.0-SNAPSHOT.jar
</code></pre></div></div><p>这样，部署一个Spring Boot应用就非常简单，无需预装任何服务器，只需要上传jar包即可。</p><p>在打包的时候，因为打包后的Spring Boot应用不会被修改，因此，默认情况下，<code class="language-plaintext highlighter-rouge">spring-boot-devtools</code>这个依赖不会被打包进去。但是要注意，使用早期的Spring Boot版本时，需要配置一下才能排除<code class="language-plaintext highlighter-rouge">spring-boot-devtools</code>这个依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;excludeDevtools&gt;</span>true<span class="nt">&lt;/excludeDevtools&gt;</span>
    <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div><p>如果不喜欢默认的项目名+版本号作为文件名，可以加一个配置指定文件名：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;project</span> <span class="err">...</span><span class="nt">&gt;</span>
    ...
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;finalName&gt;</span>awesome-app<span class="nt">&lt;/finalName&gt;</span>
        ...
    <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div><p>这样打包后的文件名就是<code class="language-plaintext highlighter-rouge">awesome-app.jar</code>。</p><hr /><p>在 IntelliJ IDEA 中运行打包好的 Spring Boot JAR 文件，可以按照以下步骤操作：</p><p><strong>方法 1：使用终端运行 JAR 文件</strong></p><ol><li>打开 IntelliJ IDEA 并导航到终端（View -&gt; Tool Windows -&gt; Terminal）。</li><li>切换到包含 JAR 文件的目录，例如：<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">cd </span>target
</code></pre></div></div></li><li>使用以下命令运行 JAR 文件：<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> java <span class="nt">-jar</span> your-application.jar
</code></pre></div></div><p>替换 <code class="language-plaintext highlighter-rouge">your-application.jar</code> 为实际的 JAR 文件名。</p></li></ol><p><strong>方法 2：创建运行配置</strong></p><ol><li>打开 IntelliJ IDEA 并导航到 “Run/Debug Configurations”（Run -&gt; Edit Configurations）。</li><li>点击左上角的 <code class="language-plaintext highlighter-rouge">+</code> 号，选择 <code class="language-plaintext highlighter-rouge">Application</code>。</li><li>配置运行配置：<ul><li><strong>Name</strong>: 运行配置的名称，例如 <code class="language-plaintext highlighter-rouge">Run Jar</code>.</li><li><strong>Main class</strong>: 选择 <code class="language-plaintext highlighter-rouge">org.springframework.boot.loader.JarLauncher</code>。</li><li><strong>Program arguments</strong>: 填写 JAR 文件的路径，例如 <code class="language-plaintext highlighter-rouge">path/to/your-application.jar</code>。</li></ul></li><li>点击 “OK” 保存运行配置。</li><li>在 IntelliJ IDEA 的工具栏上选择新创建的运行配置，然后点击 “Run” 按钮。</li></ol><p><strong>方法 3：使用 JAR 文件配置</strong></p><ol><li>打开 IntelliJ IDEA 并导航到 “Run/Debug Configurations”（Run -&gt; Edit Configurations）。</li><li>点击左上角的 <code class="language-plaintext highlighter-rouge">+</code> 号，选择 <code class="language-plaintext highlighter-rouge">JAR Application</code>。</li><li>配置运行配置：<ul><li><strong>Name</strong>: 运行配置的名称，例如 <code class="language-plaintext highlighter-rouge">Run Jar</code>.</li><li><strong>Path to JAR</strong>: 选择 JAR 文件的路径，例如 <code class="language-plaintext highlighter-rouge">target/your-application.jar</code>。</li><li><strong>Working Directory</strong>: 设置为项目的根目录。</li><li><strong>VM options</strong>: 根据需要填写，例如 <code class="language-plaintext highlighter-rouge">-Xmx1024m</code>。</li></ul></li><li>点击 “OK” 保存运行配置。</li><li>在 IntelliJ IDEA 的工具栏上选择新创建的运行配置，然后点击 “Run” 按钮。</li></ol><h2 id="瘦身spring-boot应用">瘦身Spring Boot应用</h2><p>使用Spring Boot提供的<code class="language-plaintext highlighter-rouge">spring-boot-maven-plugin</code>打包Spring Boot应用，可以直接获得一个完整的可运行的jar包，把它上传到服务器上再运行就极其方便。</p><p>但是这种方式也不是没有缺点。最大的缺点就是包太大了，动不动几十MB，在网速不给力的情况下，上传服务器非常耗时。引用到的Tomcat、Spring和其他第三方组件，只要版本号不变，这些jar就相当于每次都重复打进去，再重复上传了一遍。</p><p>真正经常改动的代码其实是自己编写的代码。如果只打包自己编写的代码，通常jar包也就几百KB。但是，运行的时候，classpath中没有依赖的jar包，肯定会报错。</p><p>如何只打自己编写的代码，同时又自动把依赖包下载到某处，并自动引入到classpath中。解决方案就是使用<code class="language-plaintext highlighter-rouge">spring-boot-thin-launcher</code>。</p><p>修改<code class="language-plaintext highlighter-rouge">&lt;build&gt;</code>-<code class="language-plaintext highlighter-rouge">&lt;plugins&gt;</code>-<code class="language-plaintext highlighter-rouge">&lt;plugin&gt;</code>，给原来的<code class="language-plaintext highlighter-rouge">spring-boot-maven-plugin</code>增加一个<code class="language-plaintext highlighter-rouge">&lt;dependency&gt;</code>如下：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;project</span> <span class="err">...</span><span class="nt">&gt;</span>
    ...
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;dependencies&gt;</span>
                    <span class="nt">&lt;dependency&gt;</span>
                        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot.experimental<span class="nt">&lt;/groupId&gt;</span>
                        <span class="nt">&lt;artifactId&gt;</span>spring-boot-thin-layout<span class="nt">&lt;/artifactId&gt;</span>
                        <span class="nt">&lt;version&gt;</span>1.0.31.RELEASE<span class="nt">&lt;/version&gt;</span>
                    <span class="nt">&lt;/dependency&gt;</span>
                <span class="nt">&lt;/dependencies&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot.experimental<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-thin-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>1.0.31.RELEASE<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;executions&gt;</span>
                    <span class="c">&lt;!--在构建时下载依赖项--&gt;</span>
                    <span class="nt">&lt;execution&gt;</span>
                        <span class="nt">&lt;id&gt;</span>resolve<span class="nt">&lt;/id&gt;</span>
                        <span class="nt">&lt;goals&gt;</span>
                            <span class="nt">&lt;goal&gt;</span>resolve<span class="nt">&lt;/goal&gt;</span>
                        <span class="nt">&lt;/goals&gt;</span>
                        <span class="nt">&lt;inherited&gt;</span>false<span class="nt">&lt;/inherited&gt;</span>
                    <span class="nt">&lt;/execution&gt;</span>
                <span class="nt">&lt;/executions&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
    <span class="c">&lt;!-- 阿里云maven仓库 --&gt;</span>
    <span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
            <span class="nt">&lt;id&gt;</span>public<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>aliyun nexus<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://maven.aliyun.com/repository/public<span class="nt">&lt;/url&gt;</span>
            <span class="nt">&lt;releases&gt;</span>
                <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
            <span class="nt">&lt;/releases&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
    <span class="nt">&lt;/repositories&gt;</span>
    <span class="nt">&lt;pluginRepositories&gt;</span>
        <span class="nt">&lt;pluginRepository&gt;</span>
            <span class="nt">&lt;id&gt;</span>public<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;name&gt;</span>aliyun nexus<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://maven.aliyun.com/repository/public<span class="nt">&lt;/url&gt;</span>
            <span class="nt">&lt;releases&gt;</span>
                <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
            <span class="nt">&lt;/releases&gt;</span>
            <span class="nt">&lt;snapshots&gt;</span>
                <span class="nt">&lt;enabled&gt;</span>false<span class="nt">&lt;/enabled&gt;</span>
            <span class="nt">&lt;/snapshots&gt;</span>
        <span class="nt">&lt;/pluginRepository&gt;</span>
    <span class="nt">&lt;/pluginRepositories&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div><p>如果无法自动下载：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot.experimental<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-thin-layout<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.31.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>可以把它加入到</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;project</span> <span class="err">...</span><span class="nt">&gt;</span>
	<span class="nt">&lt;dependencies&gt;</span>
		<span class="nt">&lt;dependency&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.springframework.boot.experimental<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>spring-boot-thin-layout<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;version&gt;</span>1.0.31.RELEASE<span class="nt">&lt;/version&gt;</span>
		<span class="nt">&lt;/dependency&gt;</span>
	<span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div><p>加载完毕后删除。</p><p>然后不需要任何其他改动了，直接按正常的流程打包，执行<code class="language-plaintext highlighter-rouge">mvn clean package</code>，<code class="language-plaintext highlighter-rouge">target</code>目录最终生成的可执行<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar</code>只有79KB左右。</p><p>直接运行<code class="language-plaintext highlighter-rouge">java -jar spring-boot-hello-1.0-SNAPSHOT.jar</code>，效果和上一节完全一样。显然，79KB的jar肯定无法放下Tomcat和Spring。那么，运行时这个<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar</code>又是怎么找到它自己依赖的jar包呢？</p><p>实际上<code class="language-plaintext highlighter-rouge">spring-boot-thin-launcher</code>这个插件改变了<code class="language-plaintext highlighter-rouge">spring-boot-maven-plugin</code>的默认行为。它输出的jar包只包含自己代码编译后的class，一个很小的<code class="language-plaintext highlighter-rouge">ThinJarWrapper</code>，以及解析<code class="language-plaintext highlighter-rouge">pom.xml</code>后得到的所有依赖jar的列表。</p><p>运行的时候，入口实际上是<code class="language-plaintext highlighter-rouge">ThinJarWrapper</code>，它会先在指定目录搜索看看依赖的jar包是否都存在，如果不存在，先从Maven中央仓库下载到本地，然后，再执行我们自己编写的<code class="language-plaintext highlighter-rouge">main()</code>入口方法。这种方式有点类似很多在线安装程序：用户下载后得到的是一个很小的exe安装程序，执行安装程序时，会首先在线下载所需的若干巨大的文件，再进行真正的安装。</p><p>这个<code class="language-plaintext highlighter-rouge">spring-boot-thin-launcher</code>在启动时搜索的默认目录是用户主目录的<code class="language-plaintext highlighter-rouge">.m2</code>，也可以指定下载目录，例如，将下载目录指定为当前目录：</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>java <span class="nt">-Dthin</span>.root<span class="o">=</span><span class="nb">.</span> <span class="nt">-jar</span> spring-boot-hello-1.0-SNAPSHOT.jar
</code></pre></div></div><p>上述命令通过环境变量<code class="language-plaintext highlighter-rouge">thin.root</code>传入当前目录，执行后发现当前目录下自动生成了一个<code class="language-plaintext highlighter-rouge">repository</code>目录，这和Maven的默认下载目录<code class="language-plaintext highlighter-rouge">~/.m2/repository</code>的结构是完全一样的，只是它仅包含<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar</code>所需的运行期依赖项。</p><p>注意：只有首次运行时会自动下载依赖项，再次运行时由于无需下载，所以启动速度会大大加快。如果删除了repository目录，再次运行时就会再次触发下载。</p><p><strong>预热</strong></p><p>把79KB大小的<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar</code>直接扔到服务器执行，上传过程就非常快。但是，第一次在服务器上运行<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar</code>时，仍需要从Maven中央仓库下载大量的jar包，所以，<code class="language-plaintext highlighter-rouge">spring-boot-thin-launcher</code>还提供了一个<code class="language-plaintext highlighter-rouge">dryrun</code>选项，专门用来下载依赖项而不执行实际代码：</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-Dthin</span>.dryrun<span class="o">=</span><span class="nb">true</span> <span class="nt">-Dthin</span>.root<span class="o">=</span><span class="nb">.</span> <span class="nt">-jar</span> spring-boot-hello-1.0-SNAPSHOT.jar
</code></pre></div></div><p>执行上述代码会在当前目录创建<code class="language-plaintext highlighter-rouge">repository</code>目录，并下载所有依赖项，但并不会运行我们编写的<code class="language-plaintext highlighter-rouge">main()</code>方法。此过程称之为“预热”（warm up）。</p><p>如果服务器由于安全限制不允许从外网下载文件，那么可以在本地预热，然后把<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar</code>和<code class="language-plaintext highlighter-rouge">repository</code>目录上传到服务器。只要依赖项没有变化，后续改动只需要上传<code class="language-plaintext highlighter-rouge">spring-boot-hello-1.0-SNAPSHOT.jar</code>即可。</p><p>如果在maven中使用相对路径引入了自己的jar,使用 <code class="language-plaintext highlighter-rouge">java -jar .\xxx.jar --thin.root=.</code> 会报错。如：<code class="language-plaintext highlighter-rouge">&lt;systemPath&gt;${project.basedir}/src/main/resources/lib/spring-file-storage-0.4.0.jar&lt;/systemPath&gt;</code></p><p><code class="language-plaintext highlighter-rouge">thin.root</code>根目录默认用的是本地的m2目录：<code class="language-plaintext highlighter-rouge">${user.home}/.m2</code></p><p>把自己的jar直接复制到开发环境和部署环境的m2目录下</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;systemPath&gt;</span>
  ${user.home}/.m2/repository/com/***/abc.jar
<span class="nt">&lt;/systemPath&gt;</span>
</code></pre></div></div><p>这样就不会提示找不到依赖了。</p><p><a href="https://github.com/spring-projects-experimental/spring-boot-thin-launcher">Spring Boot Thin Launcher官网</a></p><h2 id="actuator">Actuator</h2><p>如果需要对应用程序的状态进行监控，</p><p>使用JMX需要把一些监控信息以MBean的形式暴露给JMX Server，而Spring Boot已经内置了一个监控功能叫Actuator。</p><p>使用Actuator非常简单，只需添加如下依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>然后正常启动应用程序，Actuator会把它能收集到的所有信息都暴露给JMX。此外，Actuator还可以通过URL<code class="language-plaintext highlighter-rouge">/actuator/</code>挂载一些监控点，例如，输入<code class="language-plaintext highlighter-rouge">http://localhost:8080/actuator/health</code>，可以查看应用程序当前状态：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UP"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>Actuator默认把<strong>所有访问点暴露给JMX</strong>，但处于安全原因，只有<code class="language-plaintext highlighter-rouge">health</code>和<code class="language-plaintext highlighter-rouge">info</code>会暴露给Web。Actuator提供的所有访问点均在官方文档列出，要暴露更多的访问点给Web，需要在<code class="language-plaintext highlighter-rouge">application.yml</code>中加上配置：</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">management</span><span class="pi">:</span>
  <span class="na">endpoints</span><span class="pi">:</span>
    <span class="na">web</span><span class="pi">:</span>
      <span class="na">exposure</span><span class="pi">:</span>
        <span class="na">include</span><span class="pi">:</span> <span class="s">info, health, beans, env, metrics</span>
</code></pre></div></div><p>要特别注意暴露的URL的安全性，例如，<code class="language-plaintext highlighter-rouge">/actuator/env</code>可以获取当前机器的所有环境变量，不可暴露给公网。</p><h2 id="使用profiles">使用Profiles</h2><p>Profile本身是Spring提供的功能，Profile表示一个环境的概念，如开发、测试和生产这3个环境：</p><ul><li>native</li><li>test</li><li>production</li></ul><p>或者按git分支定义master、dev这些环境：</p><ul><li>master</li><li>dev</li></ul><p>在启动一个Spring应用程序的时候，可以传入一个或多个环境，例如：</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Dspring</span>.profiles.active<span class="o">=</span><span class="nb">test</span>,master
</code></pre></div></div><p>大多数情况下，使用一个环境就足够了。</p><p>Spring Boot对Profiles的支持在于，可以在<code class="language-plaintext highlighter-rouge">application.yml</code>中为每个环境进行配置。下面是一个示例配置：</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">${APP_NAME:unnamed}</span>
  <span class="na">datasource</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s">jdbc:hsqldb:file:testdb</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">sa</span>
    <span class="na">password</span><span class="pi">:</span>
    <span class="na">dirver-class-name</span><span class="pi">:</span> <span class="s">org.hsqldb.jdbc.JDBCDriver</span>
    <span class="na">hikari</span><span class="pi">:</span>
      <span class="na">auto-commit</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">connection-timeout</span><span class="pi">:</span> <span class="m">3000</span>
      <span class="na">validation-timeout</span><span class="pi">:</span> <span class="m">3000</span>
      <span class="na">max-lifetime</span><span class="pi">:</span> <span class="m">60000</span>
      <span class="na">maximum-pool-size</span><span class="pi">:</span> <span class="m">20</span>
      <span class="na">minimum-idle</span><span class="pi">:</span> <span class="m">1</span>

<span class="na">pebble</span><span class="pi">:</span>
  <span class="na">suffix</span><span class="pi">:</span>
  <span class="na">cache</span><span class="pi">:</span> <span class="no">false</span>

<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="s">${APP_PORT:8080}</span>

<span class="nn">---</span>

<span class="na">spring</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">activate</span><span class="pi">:</span>
      <span class="na">on-profile</span><span class="pi">:</span> <span class="s">test</span>

<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8000</span>

<span class="nn">---</span>

<span class="na">spring</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">activate</span><span class="pi">:</span>
      <span class="na">on-profile</span><span class="pi">:</span> <span class="s">production</span>

<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>

<span class="na">pebble</span><span class="pi">:</span>
  <span class="na">cache</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div><p>分隔符<code class="language-plaintext highlighter-rouge">---</code>，最前面的配置是默认配置，不需要指定Profile，后面的每段配置都必须以<code class="language-plaintext highlighter-rouge">spring.config.activate.on-profile: xxx</code>开头，表示一个Profile。上述配置默认使用8080端口，但是在<code class="language-plaintext highlighter-rouge">test</code>环境下，使用<code class="language-plaintext highlighter-rouge">8000</code>端口，在<code class="language-plaintext highlighter-rouge">production</code>环境下，使用<code class="language-plaintext highlighter-rouge">80</code>端口，并且启用Pebble的缓存。</p><p>如果不指定任何Profile，直接启动应用程序，那么Profile实际上就是<code class="language-plaintext highlighter-rouge">default</code>，可以从Spring Boot启动日志看出：</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>... INFO 54252 --- [  restartedMain] com.aotmd.Application                    : No active profile set, falling back to default profiles: default
</code></pre></div></div><p>上述日志显示未设置Profile，使用默认的Profile为<code class="language-plaintext highlighter-rouge">default</code>。</p><p>要以<code class="language-plaintext highlighter-rouge">test</code>环境启动，可输入如下命令：</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java -Dspring.profiles.active=test -jar springboot-profiles-1.0-SNAPSHOT.jar
...
INFO 58848 --- [  restartedMain] com.aotmd.Application                    : The following profiles are active: test
...
INFO 13510 --- [  restartedMain] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8000 (http) with context path ''
...
</code></pre></div></div><p>从日志看到活动的Profile是<code class="language-plaintext highlighter-rouge">test</code>，Tomcat的监听端口是<code class="language-plaintext highlighter-rouge">8000</code>。</p><p>通过Profile可以实现一套代码在不同环境启用不同的配置和功能。</p><p>在启动一个Spring应用程序的时候，可以传入一个或多个环境。如<code class="language-plaintext highlighter-rouge">-Dspring.profiles.active=test,master</code>，那最终会以哪个为准呢？答案是：先合并配置，如果有冲突，后面的覆盖前面的。</p><p>也可以多文件配置，将单文件中用—分割的文档块，分离到单个文件，主配置文件<code class="language-plaintext highlighter-rouge">application.yml</code>，环境配置文件<code class="language-plaintext highlighter-rouge">application-{profile}.yml</code>，因为已经通过文件名称设置了<code class="language-plaintext highlighter-rouge">spring.config.activate.on-profile: xxx</code>，因此不再需要重复写了，则<code class="language-plaintext highlighter-rouge">application-test.yml</code>的文件内容为：</p><div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8000</span>
</code></pre></div></div><p>通过主配置文件中<code class="language-plaintext highlighter-rouge">spring.profiles.active: test</code>进行激活环境</p><p>或者使用环境参数激活：</p><ul><li>VM options参数：<code class="language-plaintext highlighter-rouge">-Dspring.profiles.active=test</code></li><li>Program argument参数：<code class="language-plaintext highlighter-rouge">--spring.profiles.active=test</code></li></ul><p>在新版本中<code class="language-plaintext highlighter-rouge">spring.profiles: test</code>更换成了<code class="language-plaintext highlighter-rouge">spring.config.activate.on-profile: test</code></p><p>假设需要一个存储服务，在本地开发时，直接使用文件存储即可，但是，在测试和生产环境，需要存储到云端，如何通过Profile实现该功能？首先，要定义存储接口<code class="language-plaintext highlighter-rouge">StorageService</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StorageService</span> <span class="o">{</span>

    <span class="c1">// 根据URI打开InputStream:</span>
    <span class="nc">InputStream</span> <span class="nf">openInputStream</span><span class="o">(</span><span class="nc">String</span> <span class="n">uri</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>

    <span class="c1">// 根据扩展名+InputStream保存并返回URI:</span>
    <span class="nc">String</span> <span class="nf">store</span><span class="o">(</span><span class="nc">String</span> <span class="n">extName</span><span class="o">,</span> <span class="nc">InputStream</span> <span class="n">input</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>本地存储可通过<code class="language-plaintext highlighter-rouge">LocalStorageService</code>实现：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@Profile</span><span class="o">(</span><span class="s">"default"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LocalStorageService</span> <span class="kd">implements</span> <span class="nc">StorageService</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${storage.local:/var/static}"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">localStorageRootDir</span><span class="o">;</span>

    <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">getClass</span><span class="o">());</span>

    <span class="kd">private</span> <span class="nc">File</span> <span class="n">localStorageRoot</span><span class="o">;</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Intializing local storage with root dir: {}"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">localStorageRootDir</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">localStorageRoot</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">localStorageRootDir</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">openInputStream</span><span class="o">(</span><span class="nc">String</span> <span class="n">uri</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">targetFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">localStorageRoot</span><span class="o">,</span> <span class="n">uri</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">targetFile</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">store</span><span class="o">(</span><span class="nc">String</span> <span class="n">extName</span><span class="o">,</span> <span class="nc">InputStream</span> <span class="n">input</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">extName</span><span class="o">;</span>
        <span class="nc">File</span> <span class="n">targetFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">localStorageRoot</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">OutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">targetFile</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">input</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>而云端存储可通过<code class="language-plaintext highlighter-rouge">CloudStorageService</code>实现：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@Profile</span><span class="o">(</span><span class="s">"!default"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CloudStorageService</span> <span class="kd">implements</span> <span class="nc">StorageService</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${storage.cloud.bucket:}"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">bucket</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${storage.cloud.access-key:}"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">accessKey</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${storage.cloud.access-secret:}"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">accessSecret</span><span class="o">;</span>

    <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">getClass</span><span class="o">());</span>

    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// TODO:</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Initializing cloud storage..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">openInputStream</span><span class="o">(</span><span class="nc">String</span> <span class="n">uri</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// TODO:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"File not found: "</span> <span class="o">+</span> <span class="n">uri</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">store</span><span class="o">(</span><span class="nc">String</span> <span class="n">extName</span><span class="o">,</span> <span class="nc">InputStream</span> <span class="n">input</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// TODO:</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Unable to access cloud storage."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">LocalStorageService</code>使用了条件装配<code class="language-plaintext highlighter-rouge">@Profile("default")</code>，即默认启用<code class="language-plaintext highlighter-rouge">LocalStorageService</code>，而<code class="language-plaintext highlighter-rouge">CloudStorageService</code>使用了条件装配<code class="language-plaintext highlighter-rouge">@Profile("!default")</code>，即非<code class="language-plaintext highlighter-rouge">default</code>环境时，自动启用<code class="language-plaintext highlighter-rouge">CloudStorageService</code>。这样，一套代码，就实现了不同环境启用不同的配置。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="" target="_blank">acteds</a></li><li>本文链接：<a href="/2024/07/09/Spring-Boot/" target="_blank">https://acteds.github.io/2024/07/09/Spring-Boot/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://beaudar.lipk.org/client.js" repo="mzlogin/blog-comments" issue-term="title" label="gitment" theme="github-light" comment-order="desc" input-position="top" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: '/assets/search_data.json?v=1721306515', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="acteds">acteds</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/acteds/acteds.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="/" title="首页" target="">首页</a></li><li> <a href="/categories/" title="分类" target="">分类</a></li><li> <a href="/wiki/" title="维基" target="">维基</a></li><li> <a href="/about/" title="关于" target="">关于</a></li><li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
