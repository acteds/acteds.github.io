<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>MongoDB条件解析器 &mdash; 个人博客</title><link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="/assets/css/components/collection.css"><link rel="stylesheet" href="/assets/css/components/repo-card.css"><link rel="stylesheet" href="/assets/css/sections/repo-list.css"><link rel="stylesheet" href="/assets/css/components/boxed-group.css"><link rel="stylesheet" href="/assets/css/globals/common.css"><link rel="stylesheet" href="/assets/css/globals/responsive.css"><link rel="stylesheet" href="/assets/css/posts/index.css"><link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/highlight/monokai.sublime.css"><link rel="canonical" href="/2024/10/15/MongoDB%E6%9D%A1%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%99%A8/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="/feed.xml"><link rel="shortcut icon" href="/favicon.ico"><meta property="og:title" content="MongoDB条件解析器"><meta name="keywords" content="Java,MongoDB"><meta name="og:keywords" content="Java,MongoDB"><meta name="description" content="引言一个将Map转换为mongoTemplate条件的类。"><meta name="og:description" content="引言一个将Map转换为mongoTemplate条件的类。"><meta property="og:url" content="/2024/10/15/MongoDB%E6%9D%A1%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%99%A8/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2024-10-15"> <script src="/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="/assets/js/jquery-ui.js"></script> <script src="/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="MongoDB条件解析器"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">MongoDB条件解析器</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2024/10/15 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#Java" title="Java">Java</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#MongoDB" title="MongoDB">MongoDB</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 23057 字，约 66 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="引言">引言</h1><p>一个将Map转换为<code class="language-plaintext highlighter-rouge">mongoTemplate</code>条件的类。</p><h1 id="mongodb">MongoDB</h1><h2 id="mongodb条件解析器">MongoDB条件解析器</h2><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**实际主键名称*/</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PRIMARY_KEY</span> <span class="o">=</span> <span class="s">"_id"</span><span class="o">;</span>
<span class="cm">/**
 * 数据返回后映射的主键名称
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MAP_PRIMARY_KEY</span> <span class="o">=</span> <span class="s">"_id"</span><span class="o">;</span>
<span class="cm">/**租户ID字段名称*/</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TENANT_ID</span> <span class="o">=</span> <span class="s">"tenant_id"</span><span class="o">;</span>

<span class="cm">/**乐观锁字段名称*/</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">OPTIMISTIC_LOCK_FIELD</span><span class="o">=</span><span class="s">"version"</span><span class="o">;</span>
<span class="cm">/**假删除标记*/</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DELETE_STATUS</span> <span class="o">=</span> <span class="s">"deleteStatus"</span><span class="o">;</span>
<span class="cm">/**实际非系统数据所在对象字段名称*/</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DATA_NAME</span> <span class="o">=</span> <span class="s">"data"</span><span class="o">;</span>
<span class="cm">/** 条件构建解析类线程存储 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">ConditionBuild</span><span class="o">&gt;</span> <span class="no">CONDITION_BUILD_THREAD_LOCAL</span> <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(</span><span class="nl">ConditionBuild:</span><span class="o">:</span><span class="k">new</span><span class="o">);</span>

<span class="cm">/**
 * 开始条件构建解析，保证线程安全
 * @return 条件构建解析类
 */</span>
<span class="kd">private</span> <span class="nc">ConditionBuild</span> <span class="nf">startConditionBuild</span><span class="o">(){</span>
    <span class="nc">ConditionBuild</span> <span class="n">conditionBuild</span> <span class="o">=</span> <span class="no">CONDITION_BUILD_THREAD_LOCAL</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="n">conditionBuild</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">conditionBuild</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * 条件构建解析器
 * @author aotmd
 * @version 3.0
 * @date 2024/10/15 17:34
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConditionBuild</span> <span class="o">{</span>
    <span class="cm">/**主键字段名*/</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PRIMARY_KEY</span> <span class="o">=</span> <span class="s">"_id"</span><span class="o">;</span>
    <span class="cm">/**高级操作符，对象数组符合条件*/</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ELEM_MATCH</span> <span class="o">=</span> <span class="s">"$elemMatch"</span><span class="o">;</span>
    <span class="cm">/**
     * 条件数组堆栈
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Criteria</span><span class="o">&gt;&gt;</span> <span class="n">criteriaStack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="cm">/**
     * 堆栈深度
     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">stackDepth</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="cm">/**
     * 初始化构建器
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"init检测到堆栈深度不为0，请检查上次调用是否正常"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 清空条件</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">criteriaStack</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Criteria</span><span class="o">&gt;</span> <span class="n">criteriaList</span> <span class="o">:</span> <span class="n">criteriaStack</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">criteriaList</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">criteriaList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 如果列表为空，初始化一个新的 ArrayList</span>
            <span class="n">criteriaStack</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span>
        <span class="o">}</span>
        <span class="cm">/*重置堆栈深度*/</span>
        <span class="n">stackDepth</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/*------------------------------开放方法------------------------------*/</span>
    <span class="cm">/**
     * 添加Criteria条件
     * @param criteria Criteria条件
     * @return 自身
     */</span>
    <span class="kd">public</span> <span class="nc">ConditionBuild</span> <span class="nf">add</span><span class="o">(</span><span class="nc">Criteria</span> <span class="n">criteria</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 假删除条件
     * @return 自身
     */</span>
    <span class="kd">public</span> <span class="nc">ConditionBuild</span> <span class="nf">fakeDeletionCondition</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"假删除条件只能在堆栈深度为 0 时调用"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">orOperator</span><span class="o">(</span>
                <span class="n">where</span><span class="o">(</span><span class="no">DELETE_STATUS</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="kc">false</span><span class="o">),</span>
                <span class="n">where</span><span class="o">(</span><span class="no">DELETE_STATUS</span><span class="o">).</span><span class="na">exists</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
        <span class="o">);</span>
        <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 多租户条件
     * @param tenantID 租户ID
     * @return 自身
     */</span>
    <span class="kd">public</span> <span class="nc">ConditionBuild</span> <span class="nf">tenantCondition</span><span class="o">(</span><span class="nc">String</span> <span class="n">tenantID</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"多租户条件只能在堆栈深度为 0 时调用"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">where</span><span class="o">(</span><span class="no">TENANT_ID</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="n">tenantID</span><span class="o">);</span>
        <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 乐观锁条件
     * @param version 乐观锁当前版本号
     * @return 自身
     */</span>
    <span class="kd">public</span> <span class="nc">ConditionBuild</span> <span class="nf">optimisticLocks</span><span class="o">(</span><span class="kt">int</span> <span class="n">version</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"乐观锁条件只能在堆栈深度为 0 时调用"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">where</span><span class="o">(</span><span class="no">OPTIMISTIC_LOCK_FIELD</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="n">version</span><span class="o">);</span>
        <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 条件解析器
     * condition 是一个包含条件的 JSON 字符串,该方法会为条件字段添加前缀，例如：
     * {
     * "status": true,
     * "name": "John Doe",
     * "age": { "$gt": 25 }
     * }
     * @param condition  条件字符串
     * @return 自身
     */</span>
    <span class="kd">public</span> <span class="nc">ConditionBuild</span> <span class="nf">conditionParsing</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">condition</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">conditionParsing</span><span class="o">(</span><span class="n">condition</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 条件解析器
     * condition 是一个包含条件的 JSON 字符串，例如：
     * {
     * "status": true,
     * "name": "John Doe",
     * "age": { "$gt": 25 }
     * }
     * @param condition  条件字符串
     * @param addPrefix 是否添加前缀
     * @return 自身
     */</span>
    <span class="kd">public</span> <span class="nc">ConditionBuild</span> <span class="nf">conditionParsing</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">condition</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">addPrefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 根据 condition 构建查询条件</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">condition</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="c1">// 高级嵌套查询构建</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">advancedNestedQueries</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span><span class="n">addPrefix</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">keyNameMapping</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="c1">// 将条件映射到 data 里面，外面的都是系统字段，不应暴露</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">addPrefix</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="no">PRIMARY_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">addKeyPrefix</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// 简单逻辑查询构建</span>
            <span class="n">simpleLogicalQueries</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/*------------------------------重要业务逻辑------------------------------*/</span>

    <span class="cm">/**
     * 高级嵌套逻辑（$or,$and,$elemMatch）
     * $or、$and 只能出现在具体属性外，即控制符前
     * $elemMatch 只能出现在具体属性下。
     *
     * @param key       键
     * @param value     值
     * @param addPrefix 是否添加前缀
     * @return 是否跳过当前循环
     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">advancedNestedQueries</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">addPrefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">"$or"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">List</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"$or控制符的值应为数组类型。"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// $or 条件</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">orConditionList</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;)</span> <span class="n">value</span><span class="o">;</span>
            <span class="c1">// 结果集</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Criteria</span><span class="o">&gt;</span> <span class="n">orCriteriaList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="c1">// 递归</span>
            <span class="n">buildQueriesRecursively</span><span class="o">(</span><span class="n">orCriteriaList</span> <span class="o">,()-&gt;{</span>
                <span class="c1">// 分别构建</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">andCondition</span> <span class="o">:</span> <span class="n">orConditionList</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">conditionParsing</span><span class="o">(</span><span class="n">andCondition</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="c1">// 处理完毕后通过or{}将结果包围</span>
            <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">orOperator</span><span class="o">(</span><span class="n">orCriteriaList</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Criteria</span><span class="o">[</span><span class="mi">0</span><span class="o">])));</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="s">"$and"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">List</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"$and控制符的值应为数组类型。"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// $and 条件</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="n">andConditionList</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;)</span> <span class="n">value</span><span class="o">;</span>
            <span class="c1">// 结果集</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Criteria</span><span class="o">&gt;</span> <span class="n">andCriteriaList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="c1">// 递归</span>
            <span class="n">buildQueriesRecursively</span><span class="o">(</span><span class="n">andCriteriaList</span><span class="o">,()-&gt;{</span>
                <span class="c1">// 分别构建</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">andCondition</span> <span class="o">:</span> <span class="n">andConditionList</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">conditionParsing</span><span class="o">(</span><span class="n">andCondition</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="c1">// 处理完毕后通过and{}将结果包围</span>
            <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">andOperator</span><span class="o">(</span><span class="n">andCriteriaList</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Criteria</span><span class="o">[</span><span class="mi">0</span><span class="o">])));</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="cm">/*该操作流程需要涉及字段，因此需要判断是否添加字段前缀。*/</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">Map</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="nc">Map</span><span class="o">)</span> <span class="n">value</span><span class="o">).</span><span class="na">containsKey</span><span class="o">(</span><span class="no">ELEM_MATCH</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 变为强类型</span>
            <span class="nc">Map</span> <span class="n">value1</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">)</span> <span class="n">value</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(!(</span><span class="n">value1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">ELEM_MATCH</span><span class="o">)</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"$elemMatch控制符的值应为键值对类型。"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// $elemMatch 条件</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">elemMatchCondition</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">value1</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="no">ELEM_MATCH</span><span class="o">);</span>
            <span class="c1">// 结果集</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Criteria</span><span class="o">&gt;</span> <span class="n">elemMatchCriteriaList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
            <span class="c1">// 递归</span>
            <span class="n">buildQueriesRecursively</span><span class="o">(</span><span class="n">elemMatchCriteriaList</span><span class="o">,()-&gt;</span> <span class="o">{</span>
                <span class="c1">// 对象数组内部条件，不不要加前缀。</span>
                <span class="n">conditionParsing</span><span class="o">(</span><span class="n">elemMatchCondition</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
            <span class="o">});</span>
            <span class="c1">// $elemMatch这边也涉及字段，需要根据条件添加前缀。</span>

            <span class="c1">// ID 映射为 _id 字段，并跳过添加前缀逻辑。</span>
            <span class="nc">String</span> <span class="n">newKey</span><span class="o">=</span><span class="n">key</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">MAP_PRIMARY_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">newKey</span> <span class="o">=</span> <span class="no">PRIMARY_KEY</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// 将条件映射到 data 里面，外面的都是系统字段，不应暴露</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">addPrefix</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="no">PRIMARY_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">newKey</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">newKey</span> <span class="o">=</span> <span class="n">addKeyPrefix</span><span class="o">(</span><span class="n">newKey</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// 处理完毕后通过elemMatch{and{}}将结果包围</span>
            <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">).</span><span class="na">add</span><span class="o">(</span>
                    <span class="n">where</span><span class="o">(</span><span class="n">newKey</span><span class="o">).</span><span class="na">elemMatch</span><span class="o">(</span>
                            <span class="k">new</span> <span class="nf">Criteria</span><span class="o">().</span><span class="na">andOperator</span><span class="o">(</span>
                                    <span class="n">elemMatchCriteriaList</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Criteria</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span>
                            <span class="o">)</span>
                    <span class="o">)</span>
            <span class="o">);</span>
            <span class="c1">// 执行完毕后删除$elemMatch,注意会改变原condition,因此弃用，改为在简单条件逻辑构建器置空对应操作。</span>
            <span class="c1">//value1.remove("$elemMatch");</span>
            <span class="cm">/*对于存在$elemMatch的Map的平行key，可以继续处理*/</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//若都没有执行则放行，执行后续逻辑</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 简单条件逻辑构建器（$gt、$lt、$gte、$lte、$ne、$eq、$in、$nin、$regex、$exists、
     * $size、$mod、$typ、e$all、$isNull）
     * 复杂类型：$not、$notRegex
     * 只允许出现在具体属性下。
     * @param key 键，一般为字段名称
     * @param value   值，一般为控制符Map
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">simpleLogicalQueries</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 处理控制操作符 (如 $gt, $lt)</span>
            <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">operationMap</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">value</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">operationMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">operator</span><span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
                <span class="nc">Object</span> <span class="n">operatorValue</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
                <span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">where</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                <span class="k">switch</span> <span class="o">(</span><span class="n">operator</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">case</span> <span class="s">"$gt"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">gt</span><span class="o">(</span><span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 大于</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$lt"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">lt</span><span class="o">(</span><span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 小于</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$gte"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">gte</span><span class="o">(</span><span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 大于等于</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$lte"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">lte</span><span class="o">(</span><span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 小于等于</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$ne"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">ne</span><span class="o">(</span><span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 不等于操作符</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$eq"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">is</span><span class="o">(</span><span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 等于操作符</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$in"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">in</span><span class="o">((</span><span class="nc">Collection</span><span class="o">&lt;?&gt;)</span> <span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// in 操作符</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$nin"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">nin</span><span class="o">((</span><span class="nc">Collection</span><span class="o">&lt;?&gt;)</span> <span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// not in 操作符</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$regex"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">regex</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 正则表达式</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$exists"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">exists</span><span class="o">((</span><span class="kt">boolean</span><span class="o">)</span> <span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 字段存在性检查</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$size"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">size</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span> <span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 数组大小匹配</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$mod"</span><span class="o">:</span>
                        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;)</span> <span class="n">operatorValue</span><span class="o">;</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">mod</span><span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span> <span class="c1">// 取模操作</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$type"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">type</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span> <span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 类型匹配,参阅https://www.mongodb.com/zh-cn/docs/manual/reference/operator/query/type/</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$all"</span><span class="o">:</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">all</span><span class="o">((</span><span class="nc">Collection</span><span class="o">&lt;?&gt;)</span> <span class="n">operatorValue</span><span class="o">);</span> <span class="c1">// 数组匹配</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$isNull"</span><span class="o">:</span><span class="c1">// 是否为空</span>
                        <span class="k">if</span> <span class="o">((</span><span class="kt">boolean</span><span class="o">)</span> <span class="n">operatorValue</span><span class="o">){</span>
                            <span class="n">criteria</span><span class="o">.</span><span class="na">is</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span> <span class="c1">// 空值匹配</span>

                        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                            <span class="n">criteria</span><span class="o">.</span><span class="na">ne</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span><span class="c1">// 翻转</span>
                        <span class="o">}</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$not"</span><span class="o">:</span> <span class="c1">// 反向操作符，应用于简单类型</span>
                        <span class="n">criteria</span> <span class="o">=</span> <span class="n">notCondition</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">operatorValue</span><span class="o">);</span><span class="c1">// 传递字段名称，和操作符键值对</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="s">"$notRegex"</span><span class="o">:</span> <span class="c1">// 自造控制符，用以取反逻辑,用户可以使用，系统也可以使用</span>
                        <span class="n">criteria</span><span class="o">.</span><span class="na">not</span><span class="o">().</span><span class="na">regex</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">operatorValue</span><span class="o">);</span><span class="c1">// 反向正则表达式</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="k">case</span> <span class="nl">ELEM_MATCH:</span>
                        <span class="c1">// 已在高级嵌套逻辑进行处理，这里置空,直接结束本轮添加</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="k">default</span><span class="o">:</span>
                        <span class="c1">// 去除前缀，并提示操作符不存在</span>
                        <span class="nc">String</span> <span class="n">operator0</span> <span class="o">=</span> <span class="n">removeKeyPrefix</span><span class="o">(</span><span class="n">operator</span><span class="o">);</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"存在无效控制条件："</span><span class="o">+</span><span class="n">operator0</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">List</span><span class="o">){</span>
            <span class="c1">// 简单条件无数组类型，因此提示错误</span>
            <span class="nc">String</span> <span class="n">key0</span> <span class="o">=</span> <span class="n">removeKeyPrefix</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"存在无效控制条件："</span><span class="o">+</span> <span class="n">key0</span> <span class="o">+</span><span class="s">"，若该值为字段，下级应为键值对"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 普通等值查询</span>
            <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">where</span><span class="o">(</span><span class="n">key</span><span class="o">).</span><span class="na">is</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 反向操作，只允许出现在具体属性字段下。
     *
     * @param key   键，字段名称
     * @param value $not下的控制符集合
     * @return 生成好的Criteria
     */</span>
    <span class="kd">private</span> <span class="nc">Criteria</span> <span class="nf">notCondition</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">value</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"$not控制符的值应为键值对类型。"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="cm">/*强类型解析*/</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;)</span> <span class="n">value</span><span class="o">;</span>
        <span class="c1">// 支持的简单操作符列表</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">supportedOperatorsList</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"$eq"</span><span class="o">,</span> <span class="s">"$gt"</span><span class="o">,</span> <span class="s">"$gte"</span><span class="o">,</span> <span class="s">"$lt"</span><span class="o">,</span> <span class="s">"$lte"</span><span class="o">,</span> <span class="s">"$ne"</span><span class="o">,</span> <span class="s">"$regex"</span><span class="o">);</span>
        <span class="c1">// 检测操作符是否支持</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">supportedOperatorsList</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">operator</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"$not 仅支持简单的比较操作符："</span> <span class="o">+</span> <span class="n">supportedOperatorsList</span> <span class="o">+</span> <span class="s">"，不支持："</span> <span class="o">+</span> <span class="n">operator</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 操作符反向替代</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">inverseMap</span> <span class="o">=</span> <span class="n">operatorInverseOverride</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="c1">// 去掉中间层$not,重新封装</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">notConditions</span><span class="o">=</span><span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">notConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">inverseMap</span><span class="o">);</span>
        <span class="c1">// 正常调用</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Criteria</span><span class="o">&gt;</span> <span class="n">notCriteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="c1">// 递归</span>
        <span class="n">buildQueriesRecursively</span><span class="o">(</span><span class="n">notCriteria</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">// 已添加过前缀，不再重复添加</span>
            <span class="n">conditionParsing</span><span class="o">(</span><span class="n">notConditions</span><span class="o">,</span><span class="kc">false</span><span class="o">);</span>
        <span class="o">});</span>
        <span class="c1">// 处理完毕后通过and{}将结果包围</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Criteria</span><span class="o">().</span><span class="na">andOperator</span><span class="o">(</span><span class="n">notCriteria</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Criteria</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 操作符反向替代集合
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="no">SUB_MAP</span><span class="o">;</span>
    <span class="cm">/**通过静态代码块，只初始化一次*/</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">tempMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">tempMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$eq"</span><span class="o">,</span> <span class="s">"$ne"</span><span class="o">);</span>       <span class="c1">// 等于 -&gt; 不等于</span>
        <span class="n">tempMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$ne"</span><span class="o">,</span> <span class="s">"$eq"</span><span class="o">);</span>       <span class="c1">// 不等于 -&gt; 等于</span>
        <span class="n">tempMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$gt"</span><span class="o">,</span> <span class="s">"$lte"</span><span class="o">);</span>      <span class="c1">// 大于 -&gt; 小于等于</span>
        <span class="n">tempMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$gte"</span><span class="o">,</span> <span class="s">"$lt"</span><span class="o">);</span>      <span class="c1">// 大于等于 -&gt; 小于</span>
        <span class="n">tempMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$lt"</span><span class="o">,</span> <span class="s">"$gte"</span><span class="o">);</span>      <span class="c1">// 小于 -&gt; 大于等于</span>
        <span class="n">tempMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$lte"</span><span class="o">,</span> <span class="s">"$gt"</span><span class="o">);</span>      <span class="c1">// 小于等于 -&gt; 大于</span>
        <span class="n">tempMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$regex"</span><span class="o">,</span> <span class="s">"$notRegex"</span><span class="o">);</span> <span class="c1">// 正则匹配 -&gt; 取反正则匹配（自定义的取反逻辑）</span>
        <span class="no">SUB_MAP</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableMap</span><span class="o">(</span><span class="n">tempMap</span><span class="o">);</span> <span class="c1">// 将临时 Map 转换为不可变 Map</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 操作符反向替代
     * @param map 原操作符
     * @return 反向替代后的操作符集合
     */</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">operatorInverseOverride</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 用来保存需要替换的键值对</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">inverseMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

        <span class="c1">// 迭代原始Map，找到需要替换的key</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="c1">// 检查当前key是否需要替换</span>
            <span class="k">if</span> <span class="o">(</span><span class="no">SUB_MAP</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">operator</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">newOperator</span> <span class="o">=</span> <span class="no">SUB_MAP</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">operator</span><span class="o">);</span>
                <span class="c1">// 替换key不替换操作符</span>
                <span class="n">inverseMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">newOperator</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>  <span class="c1">// 将替换后的键和值存入临时Map</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">inverseMap</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/*------------------------------终结方法------------------------------*/</span>
    <span class="cm">/**
     * 与条件组合，终结操作
     * @return 条件Criteria
     */</span>
    <span class="kd">public</span> <span class="nc">Criteria</span> <span class="nf">andCriteriaBuild</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"andCriteriaBuild终结操作，只能在堆栈深度为 0 时调用"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="cm">/*Query机制问题，在第一层只能有一个and和or，因此套一层and就可以回避这个问题了*/</span>
        <span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Criteria</span><span class="o">().</span><span class="na">andOperator</span><span class="o">(</span><span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">).</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">Criteria</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
        <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">criteria</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 与条件组合,并添加到新条件查询器，终结操作
     *
     * @return Query
     */</span>
    <span class="kd">public</span> <span class="nc">Query</span> <span class="nf">andCriteriaQueryBuild</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"andCriteriaQueryBuild终结操作，只能在堆栈深度为 0 时调用"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Query</span><span class="o">();</span>
        <span class="nc">Criteria</span> <span class="n">criteria</span> <span class="o">=</span> <span class="n">andCriteriaBuild</span><span class="o">();</span>
        <span class="n">query</span><span class="o">.</span><span class="na">addCriteria</span><span class="o">(</span><span class="n">criteria</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">query</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/*------------------------------支撑方法------------------------------*/</span>

    <span class="cm">/**
     * 主键映射
     * @param keyName 键列名
     * @return
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">keyNameMapping</span><span class="o">(</span><span class="nc">String</span> <span class="n">keyName</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">keyName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">MAP_PRIMARY_KEY</span><span class="o">)){</span>
            <span class="k">return</span> <span class="no">PRIMARY_KEY</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">keyName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 为键添加前缀，映射到指定对象
     * @param key 键
     * @return 映射后的key
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">addKeyPrefix</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">key</span><span class="o">)){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"出现空字符串"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 为主键则不添加前缀，如果加了前缀也不添加前缀</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">PRIMARY_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">||</span> <span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">DATA_NAME</span> <span class="o">+</span> <span class="s">"."</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="no">DATA_NAME</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">key</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 删除键被添加的前缀
     * @param key 键
     * @return 还原后的key
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">removeKeyPrefix</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">StringUtil</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">key</span><span class="o">)){</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"出现空字符串"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 为主键则不操作，如果没有加前缀也不删除前缀</span>
        <span class="k">if</span> <span class="o">(</span><span class="no">PRIMARY_KEY</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">key</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="no">DATA_NAME</span> <span class="o">+</span> <span class="s">"."</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 去掉前缀并返回</span>
        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="na">substring</span><span class="o">((</span><span class="no">DATA_NAME</span> <span class="o">+</span> <span class="s">"."</span><span class="o">).</span><span class="na">length</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 递归构建条件
     * @param resultCriteria 解析后的Criteria
     * @param runnable 自定义操作
     */</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">buildQueriesRecursively</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Criteria</span><span class="o">&gt;</span> <span class="n">resultCriteria</span><span class="o">,</span> <span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 加堆栈深度</span>
        <span class="n">incrementDepth</span><span class="o">();</span>
        <span class="n">runnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="n">resultCriteria</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">));</span>
        <span class="c1">// 减堆栈深度并清空</span>
        <span class="n">decrementDepth</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 堆栈深度增加，不应该被调用，只会被buildQueriesRecursively调用
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">incrementDepth</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">stackDepth</span><span class="o">++;</span>
        <span class="c1">// 判断当前深度是否已经存在对应的 List，如果没有则创建新的</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">criteriaStack</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">stackDepth</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">criteriaStack</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span> <span class="c1">// 新增一个新的 list 用来存储该深度的条件</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 堆栈深度减少，并清空当前深度的列表，不应该被调用，只会被buildQueriesRecursively调用
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">decrementDepth</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stackDepth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">criteriaStack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackDepth</span><span class="o">).</span><span class="na">clear</span><span class="o">();</span> <span class="c1">// 清空当前深度的列表</span>
            <span class="n">stackDepth</span><span class="o">--;</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"未成对出现的堆栈深度！"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h2 id="使用">使用</h2><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 根据条件（condition），读取指定表单（collectionName）中的一条或多条数据详情，不通过缓存，直接从MongoDB中读取。
 *
 * @param tenantID 租户ID
 * @param collectionName 表名、集合名
 * @param condition      条件
 * @return 查询结果
 */</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&gt;</span> <span class="nf">getFormData</span><span class="o">(</span><span class="nc">String</span> <span class="n">tenantID</span><span class="o">,</span> <span class="nc">String</span> <span class="n">collectionName</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">condition</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> <span class="n">startConditionBuild</span><span class="o">()</span>
            <span class="o">.</span><span class="na">conditionParsing</span><span class="o">(</span><span class="n">condition</span><span class="o">)</span>
            <span class="o">.</span><span class="na">tenantCondition</span><span class="o">(</span><span class="n">tenantID</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fakeDeletionCondition</span><span class="o">()</span>
            <span class="o">.</span><span class="na">andCriteriaQueryBuild</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">mongoTemplate</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">collectionName</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><h2 id="测试用例">测试用例</h2><p>MongoDB数据：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6708f5f8c7413f0001015635"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"creator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"张三"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
      </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"纽约"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"job"</span><span class="p">:</span><span class="w"> </span><span class="s2">"工程师"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"salary"</span><span class="p">:</span><span class="w"> </span><span class="mi">60000</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"工程师"</span><span class="p">,</span><span class="w"> </span><span class="s2">"开发人员"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"projects"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目A"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"主开发"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目B"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"测试"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"有经验的开发人员和工程师"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isActive"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T09:55:04.671Z"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"last_modified_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T10:01:26.232Z"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6708f5f8c7413f0001015636"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"creator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"李四"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w">
      </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"洛杉矶"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"job"</span><span class="p">:</span><span class="w"> </span><span class="s2">"开发人员"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"salary"</span><span class="p">:</span><span class="w"> </span><span class="mi">70000</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"开发人员"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"projects"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目X"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"主开发"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目Z"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"辅助"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"科技公司首席开发人员"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isActive"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T09:55:04.671Z"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"last_modified_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T10:01:26.232Z"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6708f5f8c7413f0001015637"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"creator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员3"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"王五"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">55</span><span class="p">,</span><span class="w">
      </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"芝加哥"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"job"</span><span class="p">:</span><span class="w"> </span><span class="s2">"失业"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"salary"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"经理"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"projects"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目X"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"主开发"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"曾任经理，具有技术经验"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isActive"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T09:55:04.671Z"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"last_modified_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员3"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T10:01:26.232Z"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6708f5f8c7413f0001015638"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"creator"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员4"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"赵六"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="mi">28</span><span class="p">,</span><span class="w">
      </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"旧金山"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"job"</span><span class="p">:</span><span class="w"> </span><span class="s2">"工程师"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"salary"</span><span class="p">:</span><span class="w"> </span><span class="mi">80000</span><span class="p">,</span><span class="w">
      </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"工程师"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"projects"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目A"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"主开发"</span><span class="w"> </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"项目B"</span><span class="p">,</span><span class="w"> </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"辅助"</span><span class="w"> </span><span class="p">}</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"具有AI经验的软件工程师"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isActive"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"create_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T09:55:04.671Z"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="nl">"last_modified_by"</span><span class="p">:</span><span class="w"> </span><span class="s2">"操作员4"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"update_time"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2024-10-12T10:01:26.232Z"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div><p><code class="language-plaintext highlighter-rouge">POST</code>-<code class="language-plaintext highlighter-rouge">Body</code>，主要看查询条件（<code class="language-plaintext highlighter-rouge">condition</code>）：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"tenantID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"collectionID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6705ea2b006a991a7ad4d848"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"dataID"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6708f5f8c7413f0001015635"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">查询指定_id</span><span class="w">
		</span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">查询状态为</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">的记录</span><span class="w">
		</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$eq"</span><span class="p">:</span><span class="w"> </span><span class="s2">"张三"</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">查询名称为</span><span class="w"> </span><span class="s2">"张三"</span><span class="w"> </span><span class="err">的记录</span><span class="w">
			</span><span class="nl">"$not"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">排除李开头</span><span class="p">,</span><span class="err">或者直接使用$notRegex控制符</span><span class="w">
				</span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^李.*"</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">//是字符串，数字代表的类型，参阅：https://www.mongodb.com/zh-cn/docs/manual/reference/operator/query/type/</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="err">//若字段是一个对象，假设person是对象，现在想判断该对象的sex，那么可以写成：</span><span class="w">
		</span><span class="err">//</span><span class="nl">"person.sex"</span><span class="p">:</span><span class="s2">"男"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">年龄范围条件</span><span class="w">
			</span><span class="nl">"$gte"</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">年龄大于或等于</span><span class="w"> </span><span class="mi">25</span><span class="w">
			</span><span class="nl">"$lt"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">年龄小于</span><span class="w"> </span><span class="mi">50</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="nl">"$or"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">或条件</span><span class="p">,</span><span class="err">必须先套一层</span><span class="p">[]</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">并且条件，两个条件同时满足</span><span class="w">
					</span><span class="p">{</span><span class="w">
						</span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"纽约"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">城市为</span><span class="w"> </span><span class="s2">"纽约"</span><span class="w">
					</span><span class="p">},</span><span class="w">
					</span><span class="p">{</span><span class="w">
						</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"张三"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">名称为</span><span class="w"> </span><span class="s2">"张三"</span><span class="w">
					</span><span class="p">}</span><span class="w">
				</span><span class="p">]</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"洛杉矶"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">或者城市为</span><span class="w"> </span><span class="s2">"洛杉矶"</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">],</span><span class="w">
		</span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">并且条件，两个条件同时满足</span><span class="p">,</span><span class="err">必须先套一层</span><span class="p">[]</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="nl">"job"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nl">"$ne"</span><span class="p">:</span><span class="w"> </span><span class="s2">"失业"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">职位不等于</span><span class="w"> </span><span class="s2">"失业"</span><span class="w">
				</span><span class="p">}</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="p">{</span><span class="w">
				</span><span class="nl">"salary"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nl">"$gte"</span><span class="p">:</span><span class="w"> </span><span class="mi">50000</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">薪水大于或等于</span><span class="w"> </span><span class="mi">50000</span><span class="w">
					</span><span class="nl">"$mod"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
						</span><span class="mi">4</span><span class="p">,</span><span class="w">
						</span><span class="mi">0</span><span class="w">
					</span><span class="p">]</span><span class="w"> </span><span class="err">//可以被</span><span class="mi">4</span><span class="err">整除</span><span class="w">
				</span><span class="p">}</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">],</span><span class="w">
		</span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">标签条件</span><span class="w">
			</span><span class="nl">"$in"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">标签必须在这个数组中</span><span class="w">
				</span><span class="s2">"工程师"</span><span class="p">,</span><span class="w">
				</span><span class="s2">"开发人员"</span><span class="w">
			</span><span class="p">],</span><span class="w">
			</span><span class="nl">"$size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">数组长度为</span><span class="mi">2</span><span class="w">
			</span><span class="nl">"$all"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="err">//标签数组必须包含该数组的所有内容</span><span class="w">
				</span><span class="s2">"工程师"</span><span class="p">,</span><span class="w">
				</span><span class="s2">"开发人员"</span><span class="w">
			</span><span class="p">],</span><span class="w">
			</span><span class="nl">"$isNull"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">同</span><span class="w"> </span><span class="nl">"$ne"</span><span class="p">:</span><span class="kc">null</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="nl">"projects"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">项目条件</span><span class="w">
			</span><span class="nl">"$elemMatch"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">//若要使用</span><span class="w"> </span><span class="err">$elemMatch</span><span class="p">,</span><span class="err">必须在$elemMatch前先套一层</span><span class="p">{}</span><span class="w">
				</span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"主开发"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">查询项目中角色为</span><span class="w"> </span><span class="s2">"主开发"</span><span class="w">
			</span><span class="p">},</span><span class="w">
			</span><span class="nl">"$size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">数组长度为</span><span class="mi">2</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">描述条件</span><span class="w">
			</span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">".*开发人员.*"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">描述中包含</span><span class="w"> </span><span class="s2">"开发人员"</span><span class="w"> </span><span class="err">字样</span><span class="w">
		</span><span class="p">},</span><span class="w">
		</span><span class="nl">"isActive"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">活动状态</span><span class="w">
			</span><span class="nl">"$exists"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">存在</span><span class="w"> </span><span class="err">isActive</span><span class="w"> </span><span class="err">字段</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>发送请求后，<code class="language-plaintext highlighter-rouge">MongoTemplate</code>日志：</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">o.s.data.mongodb.core.MongoTemplate:</span><span class="w"> </span><span class="err">find</span><span class="w"> </span><span class="err">using</span><span class="w"> </span><span class="err">query:</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$oid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"6708f5f8c7413f0001015635"</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.status"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"张三"</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"data.name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nl">"$not"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^李.*"</span><span class="p">,</span><span class="w">
					</span><span class="nl">"$options"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
				</span><span class="p">}</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.age"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$gte"</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.age"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$lt"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"$or"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nl">"data.city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"纽约"</span><span class="w">
			</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nl">"data.name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"张三"</span><span class="w">
			</span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
		</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"data.city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"洛杉矶"</span><span class="w">
		</span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"data.job"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nl">"$ne"</span><span class="p">:</span><span class="w"> </span><span class="s2">"失业"</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"data.salary"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nl">"$gte"</span><span class="p">:</span><span class="w"> </span><span class="mi">50000</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"data.salary"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nl">"$mod"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">]</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$in"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"工程师"</span><span class="p">,</span><span class="w"> </span><span class="s2">"开发人员"</span><span class="w"> </span><span class="p">]</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$all"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"工程师"</span><span class="p">,</span><span class="w"> </span><span class="s2">"开发人员"</span><span class="w"> </span><span class="p">]</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.tags"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$ne"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.projects"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$elemMatch"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
					</span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"主开发"</span><span class="w">
				</span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.projects"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.description"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$regex"</span><span class="p">:</span><span class="w"> </span><span class="s2">".*开发人员.*"</span><span class="p">,</span><span class="w">
			</span><span class="nl">"$options"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"data.isActive"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"$exists"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
		</span><span class="p">}</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"tenant_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"16889087066967307206"</span><span class="w">
	</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"$or"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"deleteStatus"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
		</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
			</span><span class="nl">"deleteStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
				</span><span class="nl">"$exists"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
			</span><span class="p">}</span><span class="w">
		</span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
	</span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">fields:</span><span class="w"> </span><span class="err">Document</span><span class="w"> </span><span class="p">{</span><span class="w">
	</span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">for</span><span class="w"> </span><span class="err">class:</span><span class="w"> </span><span class="err">interface</span><span class="w"> </span><span class="err">java.util.Map</span><span class="w"> </span><span class="err">in</span><span class="w"> </span><span class="err">collection:</span><span class="w"> </span><span class="err">co_common_test</span><span class="mi">1</span><span class="w">
</span></code></pre></div></div><hr /><p>若通过java代码构建，则样例代码为：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"dataID"</span><span class="o">,</span> <span class="s">"6708f5f8c7413f0001015635"</span><span class="o">);</span> <span class="c1">// 查询指定_id</span>
<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"status"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span> <span class="c1">// 查询状态为 true 的记录</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">nameConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">nameConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$eq"</span><span class="o">,</span> <span class="s">"张三"</span><span class="o">);</span> <span class="c1">// 查询名称为 "张三" 的记录</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">notCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">notCondition</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$regex"</span><span class="o">,</span> <span class="s">"^李.*"</span><span class="o">);</span>
<span class="n">nameConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$not"</span><span class="o">,</span> <span class="n">notCondition</span><span class="o">);</span> <span class="c1">// 排除李开头</span>
<span class="n">nameConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$type"</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span> <span class="c1">// 是字符串</span>

<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="n">nameConditions</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">ageConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">ageConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$gte"</span><span class="o">,</span> <span class="mi">25</span><span class="o">);</span> <span class="c1">// 年龄大于或等于 25</span>
<span class="n">ageConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$lt"</span><span class="o">,</span> <span class="mi">50</span><span class="o">);</span> <span class="c1">// 年龄小于 50</span>
<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="n">ageConditions</span><span class="o">);</span> <span class="c1">// 年龄范围条件</span>

<span class="c1">// 处理 $or 条件</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">orConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">firstAndCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">firstAndConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="n">firstAndConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"纽约"</span><span class="o">));</span> <span class="c1">// 城市为 "纽约"</span>
<span class="n">firstAndConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"张三"</span><span class="o">));</span> <span class="c1">// 名称为 "张三"</span>
<span class="n">firstAndCondition</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$and"</span><span class="o">,</span> <span class="n">firstAndConditions</span><span class="o">);</span>
<span class="n">orConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">firstAndCondition</span><span class="o">);</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">secondOrCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">secondOrCondition</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"city"</span><span class="o">,</span> <span class="s">"洛杉矶"</span><span class="o">);</span> <span class="c1">// 或者城市为 "洛杉矶"</span>
<span class="n">orConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">secondOrCondition</span><span class="o">);</span>

<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$or"</span><span class="o">,</span> <span class="n">orConditions</span><span class="o">);</span> <span class="c1">// 将 $or 条件添加到查询</span>

<span class="c1">// 处理 $and 条件</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">andConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">firstAndJobCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">firstAndJobCondition</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$ne"</span><span class="o">,</span> <span class="s">"失业"</span><span class="o">);</span> <span class="c1">// 职位不等于 "失业"</span>
<span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"job"</span><span class="o">,</span> <span class="n">firstAndJobCondition</span><span class="o">));</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">secondAndSalaryCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">secondAndSalaryCondition</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$gte"</span><span class="o">,</span> <span class="mi">50000</span><span class="o">);</span> <span class="c1">// 薪水大于或等于 50000</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">modValues</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="n">secondAndSalaryCondition</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$mod"</span><span class="o">,</span> <span class="n">modValues</span><span class="o">);</span> <span class="c1">// 可以被4整除</span>
<span class="n">andConditions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"salary"</span><span class="o">,</span> <span class="n">secondAndSalaryCondition</span><span class="o">));</span>

<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$and"</span><span class="o">,</span> <span class="n">andConditions</span><span class="o">);</span> <span class="c1">// 将 $and 条件添加到查询</span>

<span class="c1">// 处理 tags 条件</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">tagsConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">tagsConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$in"</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"工程师"</span><span class="o">,</span> <span class="s">"开发人员"</span><span class="o">));</span> <span class="c1">// 标签必须在这个数组中</span>
<span class="n">tagsConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$size"</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span> <span class="c1">// 数组长度为2</span>
<span class="n">tagsConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$all"</span><span class="o">,</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"工程师"</span><span class="o">,</span> <span class="s">"开发人员"</span><span class="o">));</span> <span class="c1">// 标签数组必须包含该数组的所有内容</span>
<span class="n">tagsConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$isNull"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span> <span class="c1">// 同 "$ne":null</span>
<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"tags"</span><span class="o">,</span> <span class="n">tagsConditions</span><span class="o">);</span> <span class="c1">// 将 tags 条件添加到查询</span>

<span class="c1">// 处理 projects 条件</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">projectsConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">elemMatchCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">elemMatchCondition</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"role"</span><span class="o">,</span> <span class="s">"主开发"</span><span class="o">);</span> <span class="c1">// 查询项目中角色为 "主开发"</span>
<span class="n">projectsConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$elemMatch"</span><span class="o">,</span> <span class="n">elemMatchCondition</span><span class="o">);</span> <span class="c1">// 添加 $elemMatch 条件</span>
<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"projects"</span><span class="o">,</span> <span class="n">projectsConditions</span><span class="o">);</span> <span class="c1">// 将 projects 条件添加到查询</span>

<span class="c1">// 处理 description 条件</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">descriptionConditions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">descriptionConditions</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$regex"</span><span class="o">,</span> <span class="s">".*开发人员.*"</span><span class="o">);</span> <span class="c1">// 描述中包含 "开发人员" 字样</span>
<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"description"</span><span class="o">,</span> <span class="n">descriptionConditions</span><span class="o">);</span> <span class="c1">// 将 description 条件添加到查询</span>

<span class="c1">// 处理 isActive 条件</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">isActiveCondition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="n">isActiveCondition</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"$exists"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span> <span class="c1">// 存在 isActive 字段</span>
<span class="n">query</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"isActive"</span><span class="o">,</span> <span class="n">isActiveCondition</span><span class="o">);</span> <span class="c1">// 将 isActive 条件添加到查询</span>

<span class="c1">// 输出构建的 Map</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">query</span><span class="o">);</span>
</code></pre></div></div><p>Map结构：</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
	$and = [ {
		job = {
			$ne = 失业
		}
	}, {
		salary = {
			$gte = 50000,
			$mod = [ 4, 0 ]
		}
	} ], projects = {
		$elemMatch = {
			role = 主开发
		}
	}, dataID = 6708f5f8c7413f0001015635, $or = [ {
		$and = [ {
			city = 纽约
		}, {
			name = 张三
		} ]
	}, {
		city = 洛杉矶
	} ], name = {
		$eq = 张三,
		$not = {
			$regex = ^ 李.*
		},
		$type = 2
	}, description = {
		$regex = .*开发人员.*
	}, isActive = {
		$exists = true
	}, age = {
		$gte = 25,
		$lt = 50
	}, status = true, tags = {
		$isNull = false,
		$size = 2,
		$in = [ 工程师, 开发人员 ],
		$all = [ 工程师, 开发人员 ]
	}
}
</code></pre></div></div><h2 id="控制符文档">控制符文档</h2><p><code class="language-plaintext highlighter-rouge">condition</code> 中使用的控制符及其对应的作用和 <code class="language-plaintext highlighter-rouge">value</code> 要求的文档说明。每个控制符包括其含义、<code class="language-plaintext highlighter-rouge">value</code> 类型要求以及示例。</p><h3 id="适用于具体字段下的控制符">适用于具体字段下的控制符</h3><p><strong><code class="language-plaintext highlighter-rouge">$gt</code>（大于）</strong></p><ul><li>作用: 匹配字段值大于指定值的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 数字、日期等可比较类型。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "price": { "$gt": 100 } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$lt</code>（小于）</strong></p><ul><li>作用: 匹配字段值小于指定值的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 数字、日期等可比较类型。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "age": { "$lt": 30 } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$gte</code>（大于等于）</strong></p><ul><li>作用: 匹配字段值大于或等于指定值的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 数字、日期等可比较类型。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "score": { "$gte": 60 } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$lte</code>（小于等于）</strong></p><ul><li>作用: 匹配字段值小于或等于指定值的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 数字、日期等可比较类型。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "height": { "$lte": 180 } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$ne</code>（不等于）</strong></p><ul><li>作用: 匹配字段值不等于指定值的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 任意类型。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "status": { "$ne": "inactive" } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$eq</code>（等于）</strong></p><ul><li>作用: 匹配字段值等于指定值的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 任意类型。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "username": { "$eq": "john_doe" } }</code></li></ul><p>可直接省略为<code class="language-plaintext highlighter-rouge">{ "username": "john_doe" }</code></p><p><strong><code class="language-plaintext highlighter-rouge">$in</code>（包含于）</strong></p><ul><li>作用: 匹配字段值包含于给定的列表中的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 一个数组或集合。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "category": { "$in": ["electronics", "furniture"] } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$nin</code>（不包含于）</strong></p><ul><li>作用: 匹配字段值不在给定列表中的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 一个数组或集合。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "department": { "$nin": ["HR", "Finance"] } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$regex</code>（正则表达式匹配）</strong></p><ul><li>作用: 使用正则表达式匹配字段值。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 字符串，表示一个正则表达式。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "email": { "$regex": "^.+@example\\.com$" } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$exists</code>（字段存在性检查）</strong></p><ul><li>作用: 检查某字段是否存在。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 布尔值，<code class="language-plaintext highlighter-rouge">true</code> 表示字段必须存在，<code class="language-plaintext highlighter-rouge">false</code> 表示字段不能存在。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "middle_name": { "$exists": false } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$size</code>（数组大小匹配）</strong></p><ul><li>作用: 匹配数组字段的大小。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 整数，表示数组的长度。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "tags": { "$size": 3 } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$mod</code>（取模运算）</strong></p><ul><li>作用: 对字段值进行取模运算，并匹配结果。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 一个包含两个整数的数组，第一个是除数，第二个是余数。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "quantity": { "$mod": [4, 0] } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$type</code>（类型匹配）</strong></p><ul><li>作用: 匹配字段值的 BSON 数据类型。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 一个整数，表示 BSON 类型代码。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "created_at": { "$type": 9 } }</code></li></ul><p>可用类型：</p><table><thead><tr><th style="text-align: left">类型</th><th style="text-align: left">数值</th><th style="text-align: left">别名</th><th style="text-align: left">注意</th></tr></thead><tbody><tr><td style="text-align: left">double</td><td style="text-align: left">1</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">double</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">字符串</td><td style="text-align: left">2</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">string</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">对象</td><td style="text-align: left">3</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">object</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">阵列</td><td style="text-align: left">4</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">array</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">二进制数据</td><td style="text-align: left">5</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">binData</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">未定义</td><td style="text-align: left">6</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">undefined</code></td><td style="text-align: left">已弃用。</td></tr><tr><td style="text-align: left">ObjectId</td><td style="text-align: left">7</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">objectId</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">布尔</td><td style="text-align: left">8</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">bool</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">Date</td><td style="text-align: left">9</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">date</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">null</td><td style="text-align: left">10</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">null</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">正则表达式</td><td style="text-align: left">11</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">regex</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">数据库指针</td><td style="text-align: left">12</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">dbPointer</code></td><td style="text-align: left">已弃用。</td></tr><tr><td style="text-align: left">JavaScript</td><td style="text-align: left">13</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">javascript</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">符号</td><td style="text-align: left">14</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">symbol</code></td><td style="text-align: left">已弃用。</td></tr><tr><td style="text-align: left">32 位整数</td><td style="text-align: left">16</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">int</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">时间戳</td><td style="text-align: left">17</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">timestamp</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">64 位整型</td><td style="text-align: left">18</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">long</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">Decimal128</td><td style="text-align: left">19</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">decimal</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">Min key</td><td style="text-align: left">-1</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">minKey</code></td><td style="text-align: left"> </td></tr><tr><td style="text-align: left">Max key</td><td style="text-align: left">127</td><td style="text-align: left"><code class="language-plaintext highlighter-rouge">maxKey</code></td><td style="text-align: left"> </td></tr></tbody></table><p><strong><code class="language-plaintext highlighter-rouge">$all</code>（数组包含所有元素）</strong></p><ul><li>作用: 匹配数组字段包含给定所有值的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 一个数组，表示必须匹配的所有值。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "skills": { "$all": ["java", "spring"] } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$isNull</code>（是否为空值）</strong></p><ul><li>作用: 匹配字段值为空（<code class="language-plaintext highlighter-rouge">null</code>）或不为空的记录。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 布尔值，<code class="language-plaintext highlighter-rouge">true</code> 表示匹配空值，<code class="language-plaintext highlighter-rouge">false</code> 表示匹配非空值。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "middle_name": { "$isNull": true } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$not</code>（取反）</strong></p><ul><li>作用: 对其他操作符的结果取反。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 必须是键值对的形式，支持的操作符有<code class="language-plaintext highlighter-rouge">$eq</code>、 <code class="language-plaintext highlighter-rouge">$gt</code>、 <code class="language-plaintext highlighter-rouge">$gte</code>、 <code class="language-plaintext highlighter-rouge">$lt</code>、 <code class="language-plaintext highlighter-rouge">$lte</code>、 <code class="language-plaintext highlighter-rouge">$ne</code>、 <code class="language-plaintext highlighter-rouge">$regex</code>。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "age": { "$not": { "$gt": 18 } } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$notRegex</code>（正则表达式取反）</strong></p><ul><li>作用: 对正则表达式匹配结果取反。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 字符串，表示一个正则表达式。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "username": { "$notRegex": "^admin.*" } }</code></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$elemMatch</code>（数组元素匹配）</strong></p><ul><li>作用: 用于匹配对象数组中的元素是否满足多个条件，只有当数组中的<strong>某个元素满足所有给定条件时</strong>，该文档才会被匹配。</li><li><code class="language-plaintext highlighter-rouge">value</code> 要求: 一个对象，包含多个条件，每个条件都会被应用于对象数组的每个元素。</li><li>示例: <code class="language-plaintext highlighter-rouge">{ "comments": { "$elemMatch": { "user": "john", "score": { "$gt": 5 } } } }</code></li><li>注意：若<code class="language-plaintext highlighter-rouge">comments</code>的值在已经包含<code class="language-plaintext highlighter-rouge">$elemMatch</code>键的情况下，还有其他的平行键，则这些平行键都不会被执行解析。</li></ul><p>这条语句会匹配一个评论对象数组，其中 <code class="language-plaintext highlighter-rouge">user</code> 为 <code class="language-plaintext highlighter-rouge">john</code> 并且 <code class="language-plaintext highlighter-rouge">score</code> 大于 5 的文档。</p><p><strong>错误处理</strong></p><ul><li>如果条件中出现了无效的控制符，系统会抛出异常，并显示相关的无效控制符信息。</li></ul><p><strong>对象属性引用</strong></p><p>假设<code class="language-plaintext highlighter-rouge">person</code>是对象，现在想判断该对象的<code class="language-plaintext highlighter-rouge">sex</code>，那么可以写成：<code class="language-plaintext highlighter-rouge">"person.sex":"男"</code>。</p><h3 id="需直接使用的控制符">需直接使用的控制符</h3><p>以下是 <code class="language-plaintext highlighter-rouge">$or</code> 和 <code class="language-plaintext highlighter-rouge">$and</code> 控制符的文档，包含其作用和 <code class="language-plaintext highlighter-rouge">value</code> 要求：</p><p><strong><code class="language-plaintext highlighter-rouge">$or</code></strong></p><ul><li><strong>作用</strong>: 用于指定多个条件中的任何一个条件满足时匹配文档。只有当数组中的某个条件满足时，文档才会被匹配。</li><li><strong><code class="language-plaintext highlighter-rouge">value</code> 要求</strong>: <strong>一个数组</strong>，包含多个条件对象，每个对象可以是一个简单条件或复杂条件。</li><li><p><strong>示例</strong>:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$or"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$gte"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>这条语句会匹配状态为 <code class="language-plaintext highlighter-rouge">active</code> 或年龄大于等于 30 的文档。</p></li></ul><p><strong><code class="language-plaintext highlighter-rouge">$and</code></strong></p><ul><li><strong>作用</strong>: 用于指定多个条件必须全部满足时匹配文档。只有当所有条件都满足时，文档才会被匹配。</li><li><strong><code class="language-plaintext highlighter-rouge">value</code> 要求</strong>: <strong>一个数组</strong>，包含多个条件对象，每个对象可以是一个简单条件或复杂条件。</li><li><strong>示例</strong>:<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"$and"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"age"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"$lt"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>这条语句会匹配状态为 <code class="language-plaintext highlighter-rouge">active</code> 且年龄小于 50 的文档。</p></li></ul><p><code class="language-plaintext highlighter-rouge">$and</code>与<code class="language-plaintext highlighter-rouge">$or</code>可互相嵌套。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="" target="_blank">acteds</a></li><li>本文链接：<a href="/2024/10/15/MongoDB%E6%9D%A1%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%99%A8/" target="_blank">https://acteds.github.io/2024/10/15/MongoDB%E6%9D%A1%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%99%A8/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://beaudar.lipk.org/client.js" repo="mzlogin/blog-comments" issue-term="title" label="gitment" theme="github-light" comment-order="desc" input-position="top" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: '/assets/search_data.json?v=1738243735', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="acteds">acteds</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/acteds/acteds.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="/" title="首页" target="">首页</a></li><li> <a href="/categories/" title="分类" target="">分类</a></li><li> <a href="/wiki/" title="维基" target="">维基</a></li><li> <a href="/about/" title="关于" target="">关于</a></li><li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
