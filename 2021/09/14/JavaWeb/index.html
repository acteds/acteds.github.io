<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>JavaWeb &mdash; 个人博客</title><link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="/assets/css/components/collection.css"><link rel="stylesheet" href="/assets/css/components/repo-card.css"><link rel="stylesheet" href="/assets/css/sections/repo-list.css"><link rel="stylesheet" href="/assets/css/components/boxed-group.css"><link rel="stylesheet" href="/assets/css/globals/common.css"><link rel="stylesheet" href="/assets/css/globals/responsive.css"><link rel="stylesheet" href="/assets/css/posts/index.css"><link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/highlight/monokai.sublime.css"><link rel="canonical" href="/2021/09/14/JavaWeb/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="/feed.xml"><link rel="shortcut icon" href="/favicon.ico"><meta property="og:title" content="JavaWeb"><meta name="keywords" content="Java"><meta name="og:keywords" content="Java"><meta name="description" content="引言"><meta name="og:description" content="引言"><meta property="og:url" content="/2021/09/14/JavaWeb/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-09-14"> <script src="/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="/assets/js/jquery-ui.js"></script> <script src="/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="JavaWeb"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">JavaWeb</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/09/14 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#Java" title="Java">Java</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 65320 字，约 187 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="引言">引言</h1><p>JavaWeb的笔记，包括Servlet、JSP、Filter、Listener，以及实现MVC分层。</p><h1 id="java-web">Java Web</h1><p>对于Browser来说，请求页面的流程如下：</p><ol><li>与服务器建立TCP连接；</li><li>发送HTTP请求；</li><li>收取HTTP响应，然后把网页在浏览器中显示出来。</li></ol><p>浏览器发送的HTTP请求如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET / HTTP/1.1
Host: www.sina.com.cn
User-Agent: Mozilla/5.0 xxx
Accept: */*
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8
</code></pre></div></div><p>其中，第一行表示使用<code class="language-plaintext highlighter-rouge">GET</code>请求获取路径为<code class="language-plaintext highlighter-rouge">/</code>的资源，并使用<code class="language-plaintext highlighter-rouge">HTTP/1.1</code>协议，从第二行开始，每行都是以<code class="language-plaintext highlighter-rouge">Header: Value</code>形式表示的HTTP头，比较常用的HTTP Header包括：</p><ul><li>Host: 表示请求的主机名，因为一个服务器上可能运行着多个网站，因此，Host表示浏览器正在请求的域名；</li><li>User-Agent: 标识客户端本身，例如Chrome浏览器的标识类似<code class="language-plaintext highlighter-rouge">Mozilla/5.0 ... Chrome/79</code>，IE浏览器的标识类似<code class="language-plaintext highlighter-rouge">Mozilla/5.0 (Windows NT ...) like Gecko</code>；</li><li>Accept：表示浏览器能接收的资源类型，如<code class="language-plaintext highlighter-rouge">text/*</code>，<code class="language-plaintext highlighter-rouge">image/*</code>或者<code class="language-plaintext highlighter-rouge">*/*</code>表示所有；</li><li>Accept-Language：表示浏览器偏好的语言，服务器可以据此返回不同语言的网页；</li><li>Accept-Encoding：表示浏览器可以支持的压缩类型，例如<code class="language-plaintext highlighter-rouge">gzip, deflate, br</code>。</li></ul><p>服务器的响应如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Content-Type: text/html
Content-Length: 21932
Content-Encoding: gzip
Cache-Control: max-age=300

&lt;html&gt;...网页数据...
</code></pre></div></div><p>服务器响应的第一行总是版本号+空格+数字+空格+文本，数字表示响应代码，其中<code class="language-plaintext highlighter-rouge">2xx</code>表示成功，<code class="language-plaintext highlighter-rouge">3xx</code>表示重定向，<code class="language-plaintext highlighter-rouge">4xx</code>表示客户端引发的错误，<code class="language-plaintext highlighter-rouge">5xx</code>表示服务器端引发的错误。数字是给程序识别，文本则是给开发者调试使用的。常见的响应代码有：</p><ul><li>200 OK：表示成功；</li><li>301 Moved Permanently：表示该URL已经永久重定向；</li><li>302 Found：表示该URL需要临时重定向；</li><li>304 Not Modified：表示该资源没有修改，客户端可以使用本地缓存的版本；</li><li>400 Bad Request：表示客户端发送了一个错误的请求，例如参数无效；</li><li>401 Unauthorized：表示客户端因为身份未验证而不允许访问该URL；</li><li>403 Forbidden：表示服务器因为权限问题拒绝了客户端的请求；</li><li>404 Not Found：表示客户端请求了一个不存在的资源；</li><li>500 Internal Server Error：表示服务器处理时内部出错，例如因为无法连接数据库；</li><li>503 Service Unavailable：表示服务器此刻暂时无法处理请求。</li></ul><p>从第二行开始，服务器每一行均返回一个HTTP头。服务器经常返回的HTTP Header包括：</p><ul><li>Content-Type：表示该响应内容的类型，例如<code class="language-plaintext highlighter-rouge">text/html</code>，<code class="language-plaintext highlighter-rouge">image/jpeg</code>；</li><li>Content-Length：表示该响应内容的长度（字节数）；</li><li>Content-Encoding：表示该响应压缩算法，例如<code class="language-plaintext highlighter-rouge">gzip</code>；</li><li>Cache-Control：指示客户端应如何缓存，例如<code class="language-plaintext highlighter-rouge">max-age=300</code>表示可以最多缓存300秒。</li></ul><p>HTTP请求和响应都由HTTP Header和HTTP Body构成，其中HTTP Header每行都以<code class="language-plaintext highlighter-rouge">\r\n</code>结束。如果遇到两个连续的<code class="language-plaintext highlighter-rouge">\r\n</code>，那么后面就是HTTP Body。浏览器读取HTTP Body，并根据Header信息中指示的<code class="language-plaintext highlighter-rouge">Content-Type</code>、<code class="language-plaintext highlighter-rouge">Content-Encoding</code>等解压后显示网页、图像或其他内容。</p><p>通常浏览器获取的<strong>第一个资源是HTML网页</strong>，在网页中，如果嵌入了JavaScript、CSS、图片、视频等其他资源，浏览器会根据资源的URL<strong>再次</strong>向服务器请求对应的资源。</p><p>Browser/Server模式，简称BS架构，基本过程是：</p><p>浏览器请求一个URL，服务器就把生成的HTML网页发送给浏览器，而浏览器和服务器之间的传输协议是HTTP。浏览器根据网页的url继续请求获取网页需要的资源，比如图片等</p><p>HTTP协议是一个基于TCP协议之上的请求-响应协议，也就是说，本质是一个TCP连接，然后根据HTTP协议的规定，规范化处理交互的内容，就是分析HTTP body 和 header，实现就是使用<code class="language-plaintext highlighter-rouge">ServeSocket</code>，而对于HTML浏览器会自己解析，因此只要保证通信、负责传输HTML内容到客户端本地就行。</p><h2 id="编写http-server">编写HTTP Server</h2><p>一个HTTP Server本质上是一个TCP服务器，用TCP编程的多线程实现的服务器端框架：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="o">(</span><span class="nc">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">))</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器正在运行。"</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"连接来自："</span> <span class="o">+</span> <span class="n">sock</span><span class="o">.</span><span class="na">getRemoteSocketAddress</span><span class="o">());</span>
        <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WebPage</span><span class="o">(</span><span class="n">sock</span><span class="o">);</span>
        <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div><p>处理：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">WebPage</span> <span class="kd">extends</span> <span class="nc">Thread</span><span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">WebPage</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">(</span><span class="nc">OutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">handle</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端已断开连接。"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">in</span><span class="o">,</span><span class="nc">OutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">in</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">OutputStreamWriter</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="c1">// 读取HTTP请求:</span>
        <span class="kt">boolean</span> <span class="n">requestOk</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">first</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">first</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"GET / HTTP/1."</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">requestOk</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">header</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">header</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 读取到空行时, HTTP Header读取完毕</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">header</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">requestOk</span> <span class="o">?</span> <span class="s">"响应正常"</span> <span class="o">:</span> <span class="s">"响应错误"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">requestOk</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 发送错误响应:</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"HTTP/1.0 404 Not Found\r\n"</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"Content-Length: 0\r\n"</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\r\n"</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 发送成功响应:</span>
            <span class="nc">String</span> <span class="n">data</span> <span class="o">=</span> <span class="s">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, world!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">).</span><span class="na">length</span><span class="o">;</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"HTTP/1.0 200 OK\r\n"</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"Connection: close\r\n"</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"Content-Type: text/html\r\n"</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"Content-Length: "</span> <span class="o">+</span> <span class="n">length</span> <span class="o">+</span> <span class="s">"\r\n"</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\r\n"</span><span class="o">);</span> <span class="c1">// 空行标识Header和Body的分隔</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>只处理了<code class="language-plaintext highlighter-rouge">GET /</code>的请求。当读取到空行时，表示已读到连续两个<code class="language-plaintext highlighter-rouge">\r\n</code>，说明请求结束，可以发送响应。发送响应时，先发送响应代码<code class="language-plaintext highlighter-rouge">HTTP/1.0 200 OK</code>表示一个成功的200响应，使用<code class="language-plaintext highlighter-rouge">HTTP/1.0</code>协议。然后，依次发送Header，发送完Header后，再发送一个空行标识Header结束，紧接着发送HTTP Body。</p><p>HTTP目前有多个版本，<code class="language-plaintext highlighter-rouge">1.0</code>是早期版本，浏览器每次建立TCP连接后，只发送一个HTTP请求并接收一个HTTP响应，然后就关闭TCP连接。由于创建TCP连接本身就需要消耗一定的时间，因此，HTTP 1.1允许浏览器和服务器在同一个TCP连接上反复发送、接收多个HTTP请求和响应，这样就大大提高了传输效率。</p><p>HTTP协议是一个请求-响应协议，它总是发送一个请求，然后接收一个响应。能不能一次性发送多个请求，然后再接收多个响应呢？HTTP 2.0可以支持浏览器同时发出多个请求，但每个请求需要唯一标识，服务器可以不按请求的顺序返回多个响应，由浏览器自己把收到的响应和请求对应起来。可见，HTTP 2.0进一步提高了传输效率，因为浏览器发出一个请求后，不必等待响应，就可以继续发下一个请求。</p><p>HTTP 3.0为了进一步提高速度，将抛弃TCP协议，改为使用无需创建连接的UDP协议，目前HTTP 3.0仍然处于实验阶段。</p><h2 id="servlet">Servlet</h2><p>编写HTTP服务器其实是非常简单的，只需要先编写基于多线程的TCP服务，然后在一个TCP连接中读取HTTP请求，发送HTTP响应即可。</p><p>但是，要编写一个完善的HTTP服务器，以HTTP/1.1为例，需要考虑的包括：</p><ul><li>识别正确和错误的HTTP请求；</li><li>识别正确和错误的HTTP头；</li><li>复用TCP连接；</li><li>复用线程；</li><li>IO异常处理；</li><li>…</li></ul><p>这些基础工作需要耗费大量的时间，并且经过长期测试才能稳定运行。如果只需要输出一个简单的HTML页面，就不得不编写上千行底层代码，那就根本无法做到高效而可靠地开发。</p><p>因此，在JavaEE平台上，处理TCP连接，解析HTTP协议这些底层工作统统扔给现成的Web服务器去做，然后只需要把自己的应用程序跑在Web服务器上。为了实现这一目的，JavaEE提供了Servlet API，使用Servlet API编写自己的Servlet来处理HTTP请求，Web服务器实现Servlet API接口，实现底层功能。</p><p>实现一个最简单的Servlet：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span><span class="c1">// WebServlet注解表示这是一个Servlet，并映射到地址/:</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html"</span><span class="o">);</span><span class="c1">// 设置响应类型</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;h1&gt;Hello, world!&lt;/h1&gt;"</span><span class="o">);</span><span class="c1">// 获取输出流，并写入。</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span><span class="c1">//强制输出</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">@WebServlet("/")</code>也可以在<code class="language-plaintext highlighter-rouge">Web.xml</code>里配置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;servlet&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>hello<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;servlet-class&gt;</span>test.MyServlet<span class="nt">&lt;/servlet-class&gt;</span>
<span class="nt">&lt;/servlet&gt;</span>
<span class="nt">&lt;servlet-mapping&gt;</span>
    <span class="nt">&lt;servlet-name&gt;</span>hello<span class="nt">&lt;/servlet-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/servlet-mapping&gt;</span>
</code></pre></div></div><p>一个Servlet总是继承自<code class="language-plaintext highlighter-rouge">HttpServlet</code>，然后覆写<code class="language-plaintext highlighter-rouge">doGet()</code>或<code class="language-plaintext highlighter-rouge">doPost()</code>方法。注意到<code class="language-plaintext highlighter-rouge">doGet()</code>方法传入了<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>和<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>两个对象，分别代表HTTP请求和响应。使用Servlet API时，并不直接与底层TCP交互，也不需要解析HTTP协议，因为<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>和<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>就已经封装好了请求和响应。以发送响应为例，只需要设置正确的响应类型，然后获取<code class="language-plaintext highlighter-rouge">PrintWriter</code>，写入响应即可。</p><p>Servlet API是一个jar包，需要通过Maven来引入它，才能正常编译。<code class="language-plaintext highlighter-rouge">pom.xml</code>文件的打包类型需要设置为<code class="language-plaintext highlighter-rouge">war</code>。并引入依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">&lt;scope&gt;</code>指定为<code class="language-plaintext highlighter-rouge">provided</code>，表示编译时使用，但不会打包到<code class="language-plaintext highlighter-rouge">.war</code>文件中，因为运行期Web服务器本身已经提供了Servlet API相关的jar包。</p><p>4.0及之前版本的<code class="language-plaintext highlighter-rouge">servlet-api</code>由Oracle官方维护，而5.0及以后的<code class="language-plaintext highlighter-rouge">servlet-api</code>由Eclipse开源社区维护，引入的依赖项是<code class="language-plaintext highlighter-rouge">jakarta.servlet</code>，对于很多仅支持Servlet 4.0版本的框架来说，例如Spring 5，就只能使用<code class="language-plaintext highlighter-rouge">javax.servlet:4.0.0</code>版本。</p><p>目录结构为：</p><pre><code class="language-ascii">Maven
│  pom.xml
│
├─src
│  ├─main
│  │  ├─java
│  │  │  └─test
│  │  │          MyServlet.java
│  │  │
│  │  ├─resources
│  │  │
│  │  └─webapp
│  │      │  index.jsp
│  │      │
│  │      └─WEB-INF
│  │              web.xml
│  │
│  └─test
│      ├─java
│      └─resources
│
└─target
</code></pre><p>运行Maven命令<code class="language-plaintext highlighter-rouge">mvn clean package</code>，在<code class="language-plaintext highlighter-rouge">target</code>目录下得到一个<code class="language-plaintext highlighter-rouge">war</code>文件，这个文件就是编译打包后的Web应用程序。</p><p>如果使用mvn clean package报错信息中有类似</p><p><code class="language-plaintext highlighter-rouge">org.apache.maven.plugins 的Due to ..... Cannot access defaults field of Properties</code>错误（war打包问题）</p><p>在pom.xml中指定package插件的版本即可:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.3.2<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></div></div><p>maven-war-plugin插件会自动使用main-webapp-WEB-INF-web.xml文件作为配置文件。也可以自己在pom.xml中进行配置:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;finalName&gt;</span>打包的名字<span class="nt">&lt;/finalName&gt;</span>
<span class="c">&lt;!-- 如果使用maven-war-plugin默认配置则不需要配--&gt;</span>
        <span class="nt">&lt;pluginManagement&gt;</span>
            <span class="nt">&lt;plugins&gt;</span>
                <span class="nt">&lt;plugin&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
                    <span class="nt">&lt;configuration&gt;</span>
                        <span class="nt">&lt;webXml&gt;</span>webapp\WEB-INF.xml<span class="nt">&lt;/webXml&gt;</span>
                        <span class="c">&lt;!-- 指定jsp、js、css的路劲 --&gt;</span>
<span class="c">&lt;!--                        &lt;warSourceDirectory&gt;WebRoot&lt;/warSourceDirectory&gt;--&gt;</span>
                    <span class="nt">&lt;/configuration&gt;</span>
                <span class="nt">&lt;/plugin&gt;</span>
            <span class="nt">&lt;/plugins&gt;</span>
        <span class="nt">&lt;/pluginManagement&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
</code></pre></div></div><hr /><h3 id="运行">运行</h3><p>普通的Java程序是通过启动JVM，然后执行<code class="language-plaintext highlighter-rouge">main()</code>方法开始运行。但是Web应用程序有所不同，我们无法直接运行<code class="language-plaintext highlighter-rouge">war</code>文件，必须先启动Web服务器，再由Web服务器加载我们编写的<code class="language-plaintext highlighter-rouge">HelloServlet</code>，这样就可以让<code class="language-plaintext highlighter-rouge">HelloServlet</code>处理浏览器发送的请求。</p><p>因此，首先要找一个支持Servlet API的Web服务器。常用的服务器有：</p><ul><li><a href="https://tomcat.apache.org/">Tomcat</a>：由Apache开发的开源免费服务器；</li><li><a href="https://www.eclipse.org/jetty/">Jetty</a>：由Eclipse开发的开源免费服务器；</li><li><a href="https://javaee.github.io/glassfish/">GlassFish</a>：一个开源的全功能JavaEE服务器。</li></ul><p>还有一些收费的商用服务器，如Oracle的<a href="https://www.oracle.com/middleware/weblogic/">WebLogic</a>，IBM的<a href="https://www.ibm.com/cloud/websphere-application-platform/">WebSphere</a>。</p><p>无论使用哪个服务器，只要它支持对应版本的Servlet API ，war包都可以在上面运行。</p><p>要运行<code class="language-plaintext highlighter-rouge">war</code>文件，首先要<a href="https://tomcat.apache.org/download-90.cgi">下载Tomcat服务器</a>，解压后，把<code class="language-plaintext highlighter-rouge">war</code>复制到Tomcat的<code class="language-plaintext highlighter-rouge">webapps</code>目录下，然后切换到<code class="language-plaintext highlighter-rouge">bin</code>目录，执行<code class="language-plaintext highlighter-rouge">startup.sh</code>或<code class="language-plaintext highlighter-rouge">startup.bat</code>启动Tomcat服务器。然后通过浏览器访问<code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/war文件名称/</code>即可。</p><p>一个Web服务器允许同时运行多个Web App，因此，第一级目录<code class="language-plaintext highlighter-rouge">/war文件名称</code>表示Web App的名字，后面的<code class="language-plaintext highlighter-rouge">/</code>才是在项目中映射的servlet路径。</p><p>那能不能直接使用<code class="language-plaintext highlighter-rouge">/</code>？答案是肯定的。先关闭Tomcat（执行<code class="language-plaintext highlighter-rouge">shutdown.sh</code>或<code class="language-plaintext highlighter-rouge">shutdown.bat</code>），然后删除Tomcat的webapps目录下的所有文件夹和文件，最后把自己的<code class="language-plaintext highlighter-rouge">war</code>文件复制过来，改名为<code class="language-plaintext highlighter-rouge">ROOT.war</code>，文件名为<code class="language-plaintext highlighter-rouge">ROOT</code>的应用程序将作为默认应用，启动后直接访问<code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/</code>即可。</p><p>如果Tomcat控制台乱码，则需要更改Tomcat的conf文件夹下的server.xml配置，增加URIEncoding=”UTF-8”，具体如下：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"8080"</span> <span class="na">protocol=</span><span class="s">"HTTP/1.1"</span> <span class="na">connectionTimeout=</span><span class="s">"20000"</span> <span class="na">redirectPort=</span><span class="s">"8443"</span> <span class="na">URIEncoding=</span><span class="s">"UTF-8"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>Tomcat这样的服务器也是Java编写的，启动Tomcat服务器实际上是启动Java虚拟机，执行Tomcat的<code class="language-plaintext highlighter-rouge">main()</code>方法，然后由Tomcat负责加载<code class="language-plaintext highlighter-rouge">.war</code>文件，实例化Servlet。如果Tomcat服务器收到的请求路径是<code class="language-plaintext highlighter-rouge">/</code>（假定部署文件为ROOT.war），就转发到<code class="language-plaintext highlighter-rouge">HelloServlet</code>并传入<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>和<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>两个对象。编写的Servlet并不是直接运行，而是由Web服务器加载后创建实例运行，所以，类似Tomcat这样的Web服务器也称为Servlet容器。</p><p>由于Servlet版本分为&lt;=4.0和&gt;=5.0两种，所以，要根据使用的Servlet版本选择正确的Tomcat版本。从<a href="https://tomcat.apache.org/whichversion.html">Tomcat版本页</a>可知：</p><ul><li>使用Servlet&lt;=4.0时，选择Tomcat 9.x或更低版本；</li><li>使用Servlet&gt;=5.0时，选择Tomcat 10.x或更高版本。</li></ul><p>在Servlet容器中运行的Servlet具有如下特点：</p><ul><li>无法在代码中直接通过new创建Servlet实例，必须由Servlet容器自动创建Servlet实例；</li><li>Servlet容器只会给每个Servlet类创建唯一实例；</li><li>Servlet容器会使用多线程执行<code class="language-plaintext highlighter-rouge">doGet()</code>或<code class="language-plaintext highlighter-rouge">doPost()</code>方法。</li></ul><p>线程安全问题：</p><ul><li>在Servlet中定义的实例变量会被多个线程同时访问，要注意线程安全；</li><li><code class="language-plaintext highlighter-rouge">HttpServletRequest</code>和<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>实例是由Servlet容器传入的局部变量，它们只能被当前线程访问，不存在多个线程访问的问题；</li><li>在<code class="language-plaintext highlighter-rouge">doGet()</code>或<code class="language-plaintext highlighter-rouge">doPost()</code>方法中，如果使用了<code class="language-plaintext highlighter-rouge">ThreadLocal</code>，但没有清理，那么它的状态很可能会影响到下次的某个请求，因为Servlet容器很可能用线程池实现线程复用。</li></ul><hr /><p><strong>在IDEA中配置Tomcat运行调试：</strong></p><p>运行调试窗口-添加Tomcat服务器-本地，配置-选择本地Tomcat路径。</p><p>项目结构窗口-工件-添加-Web应用程序（展开或者归档都行）-基于模块。</p><p>运行调试窗口-Tomcat服务器-部署选项卡-添加工件-设置映射的网址。</p><p><strong>使用Tomcat的jar包运行调试：</strong></p><p>Tomcat的启动流程：</p><ol><li>启动JVM并执行Tomcat的<code class="language-plaintext highlighter-rouge">main()</code>方法；</li><li>加载war并初始化Servlet；</li><li>正常服务。</li></ol><p>启动Tomcat无非就是设置好classpath并执行Tomcat某个jar包的<code class="language-plaintext highlighter-rouge">main()</code>方法，完全可以把Tomcat的jar包全部引入进来，然后自己编写一个<code class="language-plaintext highlighter-rouge">main()</code>方法，先启动Tomcat，然后让它加载我们的webapp就行。</p><p>添加依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>tomcat-embed-core<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>9.0.26<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>tomcat-embed-jasper<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>9.0.26<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p><strong>务必不要显示引用</strong>Servlet API，因为引入Tomcat依赖后自动引入了Servlet API。</p><p>可以编写一个<code class="language-plaintext highlighter-rouge">main()</code>方法，启动Tomcat服务器：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">LifecycleException</span> <span class="o">{</span>
        <span class="nc">Tomcat</span> <span class="n">tomcat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Tomcat</span><span class="o">();</span>
        <span class="c1">// 设置Tomcat的端口号，默认为8080</span>
        <span class="n">tomcat</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span><span class="s">"port"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">));</span>
        <span class="c1">// 获取Tomcat的连接器</span>
        <span class="n">tomcat</span><span class="o">.</span><span class="na">getConnector</span><span class="o">();</span>

        <span class="c1">// 将webapp添加到Tomcat，路径为src/main/webapp</span>
        <span class="nc">Context</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">tomcat</span><span class="o">.</span><span class="na">addWebapp</span><span class="o">(</span>
                <span class="s">""</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">"src/main/webapp"</span><span class="o">).</span><span class="na">getAbsolutePath</span><span class="o">()</span>
        <span class="o">);</span>
        <span class="c1">//设置热部署</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">setReloadable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="c1">// 创建Web资源根目录</span>
        <span class="nc">WebResourceRoot</span> <span class="n">resources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StandardRoot</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
        <span class="c1">// 添加预设资源，包括类路径和WEB-INF目录</span>
        <span class="n">resources</span><span class="o">.</span><span class="na">addPreResources</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">DirResourceSet</span><span class="o">(</span>
                        <span class="n">resources</span><span class="o">,</span>
                        <span class="s">"/WEB-INF/classes"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">"target/classes"</span><span class="o">).</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                        <span class="s">"/"</span>
                <span class="o">)</span>
        <span class="o">);</span>
        <span class="c1">// 设置Web应用的资源</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">setResources</span><span class="o">(</span><span class="n">resources</span><span class="o">);</span>
        <span class="c1">// 启动Tomcat</span>
        <span class="n">tomcat</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// 等待Tomcat服务器结束</span>
        <span class="n">tomcat</span><span class="o">.</span><span class="na">getServer</span><span class="o">().</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div><p>使用IDEA时需要注意设置：在<code class="language-plaintext highlighter-rouge">运行调试</code>窗口的<code class="language-plaintext highlighter-rouge">构建并运行</code>栏，右边的<code class="language-plaintext highlighter-rouge">修改选项</code>勾选<code class="language-plaintext highlighter-rouge">将带有"provided"作用域的依赖项添加到类路径</code>，或者直接将tomcat依赖设置为<code class="language-plaintext highlighter-rouge">compile</code>。</p><p>这样，直接运行<code class="language-plaintext highlighter-rouge">main()</code>方法，即可启动嵌入式Tomcat服务器，然后，通过预设的<code class="language-plaintext highlighter-rouge">tomcat.addWebapp("", new File("src/main/webapp")</code>，Tomcat会自动加载当前工程作为根webapp，可直接在浏览器访问<code class="language-plaintext highlighter-rouge">http://localhost:8080/</code>。</p><p>通过<code class="language-plaintext highlighter-rouge">main()</code>方法启动Tomcat服务器并加载自己的webapp有如下好处：</p><ol><li>启动简单，无需下载Tomcat或安装任何IDE插件；</li><li>调试方便，可在IDE中使用断点调试；</li><li>使用Maven创建war包后，也可以正常部署到独立的Tomcat服务器中。</li></ol><hr /><h3 id="生成可执行war包">生成可执行war包</h3><p>如果要生成可执行的war包，用<code class="language-plaintext highlighter-rouge">java -jar xxx.war</code>启动，则需要把Tomcat的依赖项的<code class="language-plaintext highlighter-rouge">&lt;scope&gt;</code>设置为compile，然后配置<code class="language-plaintext highlighter-rouge">maven-war-plugin</code>如下：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;finalName&gt;</span>hello<span class="nt">&lt;/finalName&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
        <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.3.2<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
                <span class="c">&lt;!-- 复制classes到war包根目录 --&gt;</span>
                <span class="nt">&lt;webResources&gt;</span>
                    <span class="nt">&lt;resource&gt;</span>
                        <span class="nt">&lt;directory&gt;</span>${project.build.directory}/classes<span class="nt">&lt;/directory&gt;</span>
                    <span class="nt">&lt;/resource&gt;</span>
                <span class="nt">&lt;/webResources&gt;</span>
                <span class="nt">&lt;archiveClasses&gt;</span>true<span class="nt">&lt;/archiveClasses&gt;</span>
                <span class="nt">&lt;archive&gt;</span>
                    <span class="nt">&lt;manifest&gt;</span>
                        <span class="c">&lt;!-- 添加Class-Path --&gt;</span>
                        <span class="nt">&lt;addClasspath&gt;</span>true<span class="nt">&lt;/addClasspath&gt;</span>
                        <span class="c">&lt;!-- Classpath前缀 --&gt;</span>
                        <span class="nt">&lt;classpathPrefix&gt;</span>tmp-webapp/WEB-INF/lib/<span class="nt">&lt;/classpathPrefix&gt;</span>
                        <span class="c">&lt;!-- main所在的启动类 --&gt;</span>
                        <span class="nt">&lt;mainClass&gt;</span>test.Main<span class="nt">&lt;/mainClass&gt;</span>
                    <span class="nt">&lt;/manifest&gt;</span>
                <span class="nt">&lt;/archive&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></div></div><p>生成的war包结构如下：</p><pre><code class="language-ascii">hello.war
├── META-INF
│   ├── MANIFEST.MF
│   └── maven
│       └── ...
├── WEB-INF
│   ├── classes
│   ├── lib
│   │   ├── ecj-3.18.0.jar
│   │   ├── tomcat-annotations-api-9.0.26.jar
│   │   ├── tomcat-embed-core-9.0.26.jar
│   │   ├── tomcat-embed-el-9.0.26.jar
│   │   ├── tomcat-embed-jasper-9.0.26.jar
│   │   └── Maven-1.0-SNAPSHOT.jar
│   └── web.xml
└──test
    ├── MyServlet.class
    └── Main.class
</code></pre><p>之所以要把编译后的classes复制到war包根目录，是因为用<code class="language-plaintext highlighter-rouge">java -jar hello.war</code>启动时，JVM的Class Loader不会查找<code class="language-plaintext highlighter-rouge">WEB-INF/lib</code>的jar包，而是直接从<code class="language-plaintext highlighter-rouge">hello.war</code>的根目录查找。<code class="language-plaintext highlighter-rouge">MANIFEST.MF</code>生成的内容如下：</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Manifest-Version: 1.0
Created-By: Maven WAR Plugin 3.3.2
Build-Jdk-Spec: 10
Class-Path: tmp-webapp/WEB-INF/lib/commons-lang3-3.9.jar tmp-webapp/WE
 B-INF/lib/mysql-connector-java-5.1.47.jar tmp-webapp/WEB-INF/lib/tomc
 at-embed-core-9.0.26.jar tmp-webapp/WEB-INF/lib/tomcat-annotations-ap
 i-9.0.26.jar tmp-webapp/WEB-INF/lib/tomcat-embed-jasper-9.0.26.jar tm
 p-webapp/WEB-INF/lib/tomcat-embed-el-9.0.26.jar tmp-webapp/WEB-INF/li
 b/ecj-3.18.0.jar
Main-Class: test.Main
</code></pre></div></div><p>注意到<code class="language-plaintext highlighter-rouge">Class-Path</code>的路径，这里定义的<code class="language-plaintext highlighter-rouge">Class-Path</code>相当于<code class="language-plaintext highlighter-rouge">java -cp</code>指定的Classpath，JVM不会在一个jar包中查找jar包内的jar包，它只会在文件系统中搜索，因此，还要修改<code class="language-plaintext highlighter-rouge">main()</code>方法，在执行<code class="language-plaintext highlighter-rouge">main()</code>方法时，先自解压<code class="language-plaintext highlighter-rouge">war</code>包，再启动Tomcat。还要注意依赖问题，如果在不存在Tomcat依赖时important，就会提示找不到类，因此Tomcat启动要另外写在一个类中：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.catalina.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.catalina.LifecycleException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.catalina.WebResourceRoot</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.catalina.startup.Tomcat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.catalina.webresources.DirResourceSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.catalina.webresources.StandardRoot</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TomcatRun</span><span class="o">{</span>
    <span class="kd">protected</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runTomcat</span><span class="o">(</span><span class="nc">String</span> <span class="n">webDir</span><span class="o">,</span> <span class="nc">String</span> <span class="n">baseDir</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Tomcat</span> <span class="n">tomcat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Tomcat</span><span class="o">();</span>
        <span class="c1">// 设置Tomcat的端口号，默认为8080</span>
        <span class="n">tomcat</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span><span class="s">"port"</span><span class="o">,</span> <span class="mi">8080</span><span class="o">));</span>
        <span class="c1">// 获取Tomcat的连接器</span>
        <span class="n">tomcat</span><span class="o">.</span><span class="na">getConnector</span><span class="o">();</span>

        <span class="c1">// 将webapp添加到Tomcat，路径为webDir</span>
        <span class="nc">Context</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">tomcat</span><span class="o">.</span><span class="na">addWebapp</span><span class="o">(</span>
                <span class="s">""</span><span class="o">,</span>
                <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">webDir</span><span class="o">).</span><span class="na">getAbsolutePath</span><span class="o">()</span>
        <span class="o">);</span>
        <span class="c1">// 创建Web资源根目录</span>
        <span class="nc">WebResourceRoot</span> <span class="n">resources</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StandardRoot</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
        <span class="c1">// 添加预设资源，包括类路径和WEB-INF目录</span>
        <span class="n">resources</span><span class="o">.</span><span class="na">addPreResources</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">DirResourceSet</span><span class="o">(</span>
                        <span class="n">resources</span><span class="o">,</span>
                        <span class="s">"/WEB-INF/classes"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">baseDir</span><span class="o">).</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                        <span class="s">"/"</span>
                <span class="o">)</span>
        <span class="o">);</span>
        <span class="c1">// 设置Web应用的资源</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">setResources</span><span class="o">(</span><span class="n">resources</span><span class="o">);</span>
        <span class="c1">// 启动Tomcat</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">tomcat</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">LifecycleException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 等待Tomcat服务器结束</span>
        <span class="n">tomcat</span><span class="o">.</span><span class="na">getServer</span><span class="o">().</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>启动类：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">test</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Comparator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.jar.JarEntry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.jar.JarFile</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Stream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 判定是否从jar/war启动:</span>
        <span class="nc">String</span> <span class="n">jarFile</span> <span class="o">=</span> <span class="nc">Main</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getProtectionDomain</span><span class="o">().</span><span class="na">getCodeSource</span><span class="o">().</span><span class="na">getLocation</span><span class="o">().</span><span class="na">getFile</span><span class="o">();</span>
        <span class="kt">boolean</span> <span class="n">isJarFile</span> <span class="o">=</span> <span class="n">jarFile</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".war"</span><span class="o">)</span> <span class="o">||</span> <span class="n">jarFile</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".jar"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isJarFile</span><span class="o">){</span>
            <span class="nc">TomcatRun</span><span class="o">.</span><span class="na">runTomcat</span><span class="o">(</span><span class="s">"src/main/webapp"</span><span class="o">,</span><span class="s">"target/classes"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// webapp根目录:</span>
        <span class="nc">String</span> <span class="n">webDir</span> <span class="o">=</span>  <span class="s">"tmp-webapp"</span><span class="o">;</span>
        <span class="c1">// 解压到tmp-webapp:</span>
        <span class="n">unpack</span><span class="o">(</span><span class="n">webDir</span><span class="o">,</span> <span class="n">jarFile</span><span class="o">);</span>
        <span class="c1">// 启动Tomcat:</span>
        <span class="nc">TomcatRun</span><span class="o">.</span><span class="na">runTomcat</span><span class="o">(</span><span class="n">webDir</span><span class="o">,</span> <span class="s">"tmp-webapp"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">unpack</span><span class="o">(</span><span class="nc">String</span> <span class="n">webDir</span><span class="o">,</span> <span class="nc">String</span> <span class="n">jarFile</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Path</span> <span class="n">baseDir</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">webDir</span><span class="o">).</span><span class="na">normalize</span><span class="o">().</span><span class="na">toAbsolutePath</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Files</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">(</span><span class="n">baseDir</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Files</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">baseDir</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">baseDir</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"extract to: "</span> <span class="o">+</span> <span class="n">baseDir</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">(</span><span class="nc">JarFile</span> <span class="n">jar</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JarFile</span><span class="o">(</span><span class="n">jarFile</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">List</span><span class="o">&lt;</span><span class="nc">JarEntry</span><span class="o">&gt;</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">jar</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">sorted</span><span class="o">(</span><span class="nc">Comparator</span><span class="o">.</span><span class="na">comparing</span><span class="o">(</span><span class="nl">JarEntry:</span><span class="o">:</span><span class="n">getName</span><span class="o">))</span>
                    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">JarEntry</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">entries</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Path</span> <span class="n">res</span> <span class="o">=</span> <span class="n">baseDir</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">entry</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">res</span><span class="o">);</span>
                    <span class="nc">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">getParent</span><span class="o">());</span>
                    <span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">jar</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(</span><span class="n">entry</span><span class="o">),</span> <span class="n">res</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// JVM退出时自动删除tmp-webapp:</span>
        <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span><span class="o">(</span><span class="nc">Stream</span><span class="o">&lt;</span><span class="nc">Path</span><span class="o">&gt;</span> <span class="n">sorted</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">walk</span><span class="o">(</span><span class="n">baseDir</span><span class="o">).</span><span class="na">sorted</span><span class="o">(</span><span class="nc">Comparator</span><span class="o">.</span><span class="na">reverseOrder</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">sorted</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Path:</span><span class="o">:</span><span class="n">toFile</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="nl">File:</span><span class="o">:</span><span class="n">delete</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>现在，执行<code class="language-plaintext highlighter-rouge">java -jar hello.war</code>时，JVM先定位<code class="language-plaintext highlighter-rouge">hello.war</code>的<code class="language-plaintext highlighter-rouge">Main</code>类，运行<code class="language-plaintext highlighter-rouge">main()</code>，自动解压后，文件系统目录如下：</p><pre><code class="language-ascii">&lt;work&gt;
├── hello.war
└── tmp-webapp
    └── WEB-INF
        ├── lib
        │   ├── ecj-3.18.0.jar
        │   ├── tomcat-annotations-api-9.0.26.jar
        │   ├── tomcat-embed-core-9.0.26.jar
        │   ├── tomcat-embed-el-9.0.26.jar
        │   ├── tomcat-embed-jasper-9.0.26.jar
        │   └── Maven-1.0-SNAPSHOT.jar
        └── web.xml
</code></pre><p>解压后的目录结构和我们在<code class="language-plaintext highlighter-rouge">MANIFEST.MF</code>中设定的<code class="language-plaintext highlighter-rouge">Class-Path</code>一致，因此，JVM能顺利加载Tomcat的jar包，然后运行Tomcat，启动Web App。</p><p>编写可执行的jar或者war需要注意的几点：</p><ul><li>必须在<code class="language-plaintext highlighter-rouge">MANIFEST.MF</code>中指定<code class="language-plaintext highlighter-rouge">Main-Class</code>和<code class="language-plaintext highlighter-rouge">Class-Path</code>；</li><li><code class="language-plaintext highlighter-rouge">Main</code>必须能在jar/war包的根目录下被JVM的Class Loader加载；</li><li><code class="language-plaintext highlighter-rouge">Main</code>负责解压jar/war，解压后的目录结构与<code class="language-plaintext highlighter-rouge">MANIFEST.MF</code>中设定的<code class="language-plaintext highlighter-rouge">Class-Path</code>一致；</li><li><code class="language-plaintext highlighter-rouge">Main</code><strong>不能引用任何解压后才能被加载的类</strong>，例如<code class="language-plaintext highlighter-rouge">org.apache.catalina.startup.Tomcat</code>。</li></ul><p>实际上直接用springboot打包最简单。</p><hr /><h3 id="方法参数">方法参数</h3><p>一个Web App就是由一个或多个Servlet组成的，每个Servlet通过注解说明自己能处理的路径。</p><p>早期的Servlet需要在web.xml中配置映射路径，但最新Servlet版本只需要通过注解就可以完成映射。</p><p>浏览器发送请求的时候，还会请求方法（HTTP Method）：即GET、POST、PUT等不同类型的请求。因此，要处理GET请求，要覆写<code class="language-plaintext highlighter-rouge">doGet()</code>方法，要处理POST请求，就需要覆写<code class="language-plaintext highlighter-rouge">doPost()</code>方法。如果没有覆写<code class="language-plaintext highlighter-rouge">doPost()</code>方法，post请求后，程序会直接返回405或400错误。一个Webapp完全可以有多个Servlet，分别映射不同的路径。</p><p>浏览器发出的HTTP请求总是由Web Server先接收，然后，根据Servlet配置的映射，不同的路径转发到不同的Servlet：</p><pre><code class="language-ascii">               ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐

               │            /hello    ┌───────────────┐│
                          ┌──────────&gt;│ HelloServlet  │
               │          │           └───────────────┘│
┌───────┐    ┌──────────┐ │ /signin   ┌───────────────┐
│Browser│───&gt;│Dispatcher│─┼──────────&gt;│ SignInServlet ││
└───────┘    └──────────┘ │           └───────────────┘
               │          │ /         ┌───────────────┐│
                          └──────────&gt;│ IndexServlet  │
               │                      └───────────────┘│
                              Web Server
               └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘
</code></pre><p>这种根据路径转发的功能一般称为Dispatch。映射到<code class="language-plaintext highlighter-rouge">/</code>的<code class="language-plaintext highlighter-rouge">IndexServlet</code>比较特殊，它实际上会接收<strong>所有未匹配的路径</strong>，相当于<code class="language-plaintext highlighter-rouge">/*</code>，Dispatcher的逻辑可以用伪代码实现如下：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">dispatchTo</span><span class="o">(</span><span class="n">helloServlet</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/signin"</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">dispatchTo</span><span class="o">(</span><span class="n">signinServlet</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">// 所有未匹配的路径均转发到"/"</span>
    <span class="n">dispatchTo</span><span class="o">(</span><span class="n">indexServlet</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><hr /><p><strong>HttpServletRequest</strong></p><p><code class="language-plaintext highlighter-rouge">HttpServletRequest</code>封装了一个HTTP请求，它实际上是从<code class="language-plaintext highlighter-rouge">ServletRequest</code>继承而来。最早设计Servlet时，设计者希望Servlet不仅能处理HTTP，也能处理类似SMTP等其他协议，因此，单独抽出了<code class="language-plaintext highlighter-rouge">ServletRequest</code>接口，但实际上除了HTTP外，并没有其他协议会用Servlet处理，所以这是一个过度设计。</p><p>通过<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>提供的接口方法可以拿到HTTP请求的几乎全部信息，常用的方法有：</p><ul><li><code class="language-plaintext highlighter-rouge">getMethod()</code>：返回请求方法，例如，<code class="language-plaintext highlighter-rouge">"GET"</code>，<code class="language-plaintext highlighter-rouge">"POST"</code>；</li><li><code class="language-plaintext highlighter-rouge">getRequestURI()</code>：返回请求路径，但不包括请求参数，例如，<code class="language-plaintext highlighter-rouge">"/hello"</code>；</li><li><code class="language-plaintext highlighter-rouge">getQueryString()</code>：返回请求参数，例如，<code class="language-plaintext highlighter-rouge">"name=Bob&amp;a=1&amp;b=2"</code>；</li><li><strong><code class="language-plaintext highlighter-rouge">getParameter(name)</code>：返回请求参数，GET请求从URL读取参数，POST请求从Body中读取参数；</strong></li><li><code class="language-plaintext highlighter-rouge">getContentType()</code>：获取请求Body的类型，例如，<code class="language-plaintext highlighter-rouge">"application/x-www-form-urlencoded"</code>；</li><li><code class="language-plaintext highlighter-rouge">getContextPath()</code>：获取当前Webapp挂载的路径，对于ROOT.war来说，总是返回空字符串<code class="language-plaintext highlighter-rouge">""</code>；</li><li><code class="language-plaintext highlighter-rouge">getCookies()</code>：返回请求携带的所有Cookie；</li><li><code class="language-plaintext highlighter-rouge">getHeader(name)</code>：获取指定的Header，对Header名称不区分大小写；</li><li><code class="language-plaintext highlighter-rouge">getHeaderNames()</code>：返回所有Header名称；</li><li><code class="language-plaintext highlighter-rouge">getInputStream()</code>：如果该请求带有HTTP Body，该方法将打开一个输入流用于读取Body；</li><li><code class="language-plaintext highlighter-rouge">getReader()</code>：和<code class="language-plaintext highlighter-rouge">getInputStream()</code>类似，但打开的是Reader；</li><li><code class="language-plaintext highlighter-rouge">getRemoteAddr()</code>：返回客户端的IP地址；</li><li><code class="language-plaintext highlighter-rouge">getScheme()</code>：返回协议类型，例如，<code class="language-plaintext highlighter-rouge">"http"</code>，<code class="language-plaintext highlighter-rouge">"https"</code>；</li></ul><p>此外，<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>还有两个方法：<code class="language-plaintext highlighter-rouge">setAttribute()</code>和<code class="language-plaintext highlighter-rouge">getAttribute()</code>，可以给当前<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>对象附加多个Key-Value，相当于把<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>当作一个<code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>使用。</p><hr /><p><strong>HttpServletResponse</strong></p><p><code class="language-plaintext highlighter-rouge">HttpServletResponse</code>封装了一个HTTP响应。由于HTTP响应必须先发送Header，再发送Body，所以，操作<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>对象时，必须先调用设置Header的方法，最后调用发送Body的方法。</p><p>常用的设置Header的方法有：</p><ul><li><code class="language-plaintext highlighter-rouge">setStatus(sc)</code>：设置响应代码，默认是<code class="language-plaintext highlighter-rouge">200</code>；</li><li><code class="language-plaintext highlighter-rouge">setContentType(type)</code>：设置Body的类型，例如，<code class="language-plaintext highlighter-rouge">"text/html"</code>；</li><li><code class="language-plaintext highlighter-rouge">setCharacterEncoding(charset)</code>：设置字符编码，例如，<code class="language-plaintext highlighter-rouge">"UTF-8"</code>；</li><li><code class="language-plaintext highlighter-rouge">setHeader(name, value)</code>：设置一个Header的值；</li><li><code class="language-plaintext highlighter-rouge">addCookie(cookie)</code>：给响应添加一个Cookie；</li><li><code class="language-plaintext highlighter-rouge">addHeader(name, value)</code>：给响应添加一个Header，因为HTTP协议允许有多个相同的Header；</li></ul><p>写入响应时，需要通过<code class="language-plaintext highlighter-rouge">getOutputStream()</code>获取写入流，或者通过<code class="language-plaintext highlighter-rouge">getWriter()</code>获取字符流，二者只能获取其中一个。</p><p>写入响应前，无需设置<code class="language-plaintext highlighter-rouge">setContentLength()</code>，因为底层服务器会根据写入的字节数<strong>自动设置</strong>，如果写入的数据量很小，实际上会先写入缓冲区，如果写入的数据量很大，服务器会自动采用Chunked编码让浏览器能识别数据结束符而不需要设置Content-Length头。</p><p>但是，写入完毕后调用<code class="language-plaintext highlighter-rouge">flush()</code>却是必须的，因为大部分Web服务器都基于HTTP/1.1协议，会复用TCP连接。如果没有调用<code class="language-plaintext highlighter-rouge">flush()</code>，将导致缓冲区的内容无法及时发送到客户端。此外，写入完毕后<strong>千万不要</strong>调用<code class="language-plaintext highlighter-rouge">close()</code>，原因同样是因为会复用TCP连接，如果关闭写入流，将关闭TCP连接，使得Web服务器无法复用此TCP连接。</p><p>有了<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>和<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>这两个高级接口，就不需要直接处理HTTP协议。具体的实现类是由各服务器提供的，编写的Web应用程序只关心接口方法，并不需要关心具体实现的子类。</p><p><code class="language-plaintext highlighter-rouge">response</code>的其他用法：</p><p>禁用缓存:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Cache-Control"</span><span class="o">,</span> <span class="s">"no-store"</span><span class="o">);</span>
<span class="n">response</span><span class="o">.</span><span class="na">setDateHeader</span><span class="o">(</span><span class="s">"Expires"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</code></pre></div></div><p>自动刷新，以及指定转到的URL:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"refresh"</span><span class="o">,</span> <span class="s">"0"</span><span class="o">);</span>
<span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"refresh"</span><span class="o">,</span> <span class="s">"5;URL=index"</span><span class="o">);</span>
</code></pre></div></div><hr /><p>### Servlet多线程问题</p><p>一个Servlet类在服务器中只有一个实例，但对于每个HTTP请求，Web服务器会使用多线程执行请求。因此，一个Servlet的<code class="language-plaintext highlighter-rouge">doGet()</code>、<code class="language-plaintext highlighter-rouge">doPost()</code>等处理请求的方法是多线程并发执行的。如果Servlet中定义了字段，要注意多线程并发访问的问题：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 注意读写map字段是多线程并发的:</span>
        <span class="k">this</span><span class="o">.</span><span class="na">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>对于每个请求，Web服务器会创建唯一的<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>和<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>实例，因此，<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>和<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>实例只有在当前处理线程中有效，它们总是局部变量，不存在多线程共享的问题。</p><hr /><h3 id="redirect">Redirect</h3><p>重定向是指当浏览器请求一个URL时，服务器返回一个重定向指令，告诉浏览器地址已经变了，麻烦使用<strong>新的URL再重新发送新请求</strong>。</p><p>例如，已经编写了一个能处理<code class="language-plaintext highlighter-rouge">/hello</code>的<code class="language-plaintext highlighter-rouge">HelloServlet</code>，如果收到的路径为<code class="language-plaintext highlighter-rouge">/hi</code>，希望能重定向到<code class="language-plaintext highlighter-rouge">/hello</code>，可以再编写一个<code class="language-plaintext highlighter-rouge">RedirectServlet</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/hi"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedirectServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 构造重定向的路径:</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">redirectToUrl</span> <span class="o">=</span> <span class="s">"/hello"</span> <span class="o">+</span> <span class="o">(</span><span class="n">name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">""</span> <span class="o">:</span> <span class="s">"?name="</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
        <span class="c1">// 发送重定向响应:</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">redirectToUrl</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>如果浏览器发送<code class="language-plaintext highlighter-rouge">GET /hi</code>请求，<code class="language-plaintext highlighter-rouge">RedirectServlet</code>将处理此请求。由于<code class="language-plaintext highlighter-rouge">RedirectServlet</code>在内部又发送了重定向响应，因此，浏览器会收到如下响应：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 302 Found
Location: /hello
</code></pre></div></div><p>当浏览器收到302响应后，它会立刻根据<code class="language-plaintext highlighter-rouge">Location</code>的指示发送一个新的<code class="language-plaintext highlighter-rouge">GET /hello</code>请求，这个过程就是重定。</p><p>重定向有两种：一种是302响应，称为临时重定向，一种是301响应，称为永久重定向。两者的区别是，如果服务器发送301永久重定向响应，浏览器会<strong>缓存</strong><code class="language-plaintext highlighter-rouge">/hi</code>到<code class="language-plaintext highlighter-rouge">/hello</code>这个重定向的关联，下次请求<code class="language-plaintext highlighter-rouge">/hi</code>的时候，浏览器就直接发送<code class="language-plaintext highlighter-rouge">/hello</code>请求了。</p><p>重定向的目的是当Web应用升级后，如果请求路径发生了变化，可以将原来的路径重定向到新路径，从而避免浏览器请求原路径找不到资源。</p><p><code class="language-plaintext highlighter-rouge">HttpServletResponse</code>提供了快捷的<code class="language-plaintext highlighter-rouge">redirect()</code>方法实现302重定向。如果要实现301永久重定向，可以这么写：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_MOVED_PERMANENTLY</span><span class="o">);</span> <span class="c1">// 301</span>
<span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Location"</span><span class="o">,</span> <span class="s">"/hello"</span><span class="o">);</span>
</code></pre></div></div><hr /><h3 id="forward">Forward</h3><p>Forward是指内部转发。当一个Servlet处理请求的时候，它可以决定自己不继续处理，而是转发给另一个Servlet处理。</p><p>例如，已经编写了一个能处理<code class="language-plaintext highlighter-rouge">/hello</code>的<code class="language-plaintext highlighter-rouge">HelloServlet</code>，继续编写一个能处理<code class="language-plaintext highlighter-rouge">/morning</code>的<code class="language-plaintext highlighter-rouge">ForwardServlet</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/morning"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForwardServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">ForwardServlet</code>在收到请求后，它并不自己发送响应，而是把请求和响应都转发给路径为<code class="language-plaintext highlighter-rouge">/hello</code>的Servlet，即下面的代码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">req</span><span class="o">.</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
</code></pre></div></div><p>后续请求的处理实际上是由<code class="language-plaintext highlighter-rouge">HelloServlet</code>完成的。这种处理方式称为转发（Forward）。转发和重定向的区别在于，转发是在Web服务器内部完成的，对浏览器来说，它只发出了一个HTTP请求。使用转发的时候，浏览器的地址栏路径仍然是<code class="language-plaintext highlighter-rouge">/morning</code>，浏览器并不知道该请求在Web服务器内部实际上做了一次转发。</p><p>还可以利用其它方法跳转：</p><p>自动刷新，指定转到的URL:</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"refresh"</span><span class="o">,</span> <span class="s">"5;URL=index"</span><span class="o">);</span>
</code></pre></div></div><p>弹窗后跳转，不建议用<code class="language-plaintext highlighter-rouge">alert</code></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">"&lt;script&gt;alert('删除失败');window.location='List.jsp'&lt;/script&gt;"</span><span class="o">);</span>
</code></pre></div></div><hr /><h3 id="session">Session</h3><p>在Web应用程序中，经常要跟踪用户身份。当一个用户登录成功后，如果他继续访问其他页面，Web程序如何才能识别出该用户身份？</p><p>因为HTTP协议是一个无状态协议，即Web应用程序无法区分收到的两个HTTP请求是否是同一个浏览器发出的。为了跟踪用户状态，服务器可以向浏览器分配一个唯一ID，并以Cookie的形式发送到浏览器，浏览器在后续访问时总是附带此Cookie，这样，服务器就可以识别用户身份。</p><p>这种基于唯一ID识别用户身份的机制称为Session。每个用户第一次访问服务器后，会自动获得一个Session ID。如果用户在一段时间内没有访问服务器，那么Session会自动失效，下次即使带着上次分配的Session ID访问，服务器也认为这是一个新用户，会分配新的Session ID。</p><p>JavaEE的Servlet机制内建了对Session的支持。以登录为例，当一个用户登录成功后，就可以把这个用户的名字放入一个<code class="language-plaintext highlighter-rouge">HttpSession</code>对象，以便后续访问其他页面的时候，能直接从<code class="language-plaintext highlighter-rouge">HttpSession</code>取出用户名：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="c1">// 模拟一个数据库:</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"bob"</span><span class="o">,</span> <span class="s">"bob123"</span><span class="o">,</span> <span class="s">"alice"</span><span class="o">,</span> <span class="s">"alice123"</span><span class="o">,</span> <span class="s">"tom"</span><span class="o">,</span> <span class="s">"tomcat"</span><span class="o">);</span>

    <span class="c1">// GET请求时显示登录页:</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html;charset=UTF-8"</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
        <span class="nc">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;h1&gt;登录&lt;/h1&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;form action=\"/login\" method=\"post\"&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;p&gt;用户名: &lt;input name=\"username\"&gt;&lt;/p&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;p&gt;密码: &lt;input name=\"password\" type=\"password\"&gt;&lt;/p&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;p&gt;&lt;button type=\"submit\"&gt;登录&lt;/button&gt; &lt;a href=\"/\"&gt;返回&lt;/a&gt;&lt;/p&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/form&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// POST请求时处理用户登录:</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html;charset=UTF-8"</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">expectedPassword</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">expectedPassword</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">expectedPassword</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">password</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 登录成功:</span>
            <span class="n">req</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span><span class="c1">//将用户名放入当前`HttpSession`中</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"登录成功"</span><span class="o">);</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"refresh"</span><span class="o">,</span> <span class="s">"5;URL=/index"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="s">"登录失败"</span><span class="o">);</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"refresh"</span><span class="o">,</span> <span class="s">"5;URL=/login"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>在<code class="language-plaintext highlighter-rouge">IndexServlet</code>中，可以从<code class="language-plaintext highlighter-rouge">HttpSession</code>取出用户名：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/index"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html;charset=UTF-8"</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">user</span><span class="o">=(</span><span class="nc">String</span><span class="o">)</span> <span class="n">req</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
        <span class="nc">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;h1&gt;欢迎你, "</span> <span class="o">+</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">user</span> <span class="o">:</span> <span class="s">"访客"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"&lt;/h1&gt;"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;p&gt;&lt;a href='/login'&gt;请登录&lt;/a&gt;&lt;/p&gt;"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;p&gt;&lt;a href='/logout'&gt;退出登录&lt;/a&gt;&lt;/p&gt;"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>如果用户已登录，可以通过访问<code class="language-plaintext highlighter-rouge">/logout</code>退出登录。登出逻辑就是从<code class="language-plaintext highlighter-rouge">HttpSession</code>中移除用户相关信息：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogoutServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">req</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">removeAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="s">"/index"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>可以通过访问<code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/login</code>登录。</p><p>对于Web应用程序来说，总是通过<code class="language-plaintext highlighter-rouge">HttpSession</code>这个高级接口访问当前Session。如果要深入理解Session原理，可以认为Web服务器在内存中自动维护了一个ID到<code class="language-plaintext highlighter-rouge">HttpSession</code>的映射表。</p><p>服务器识别Session的关键就是依靠一个名为<code class="language-plaintext highlighter-rouge">JSESSIONID</code>的Cookie。在Servlet中<strong>第一次调用</strong><code class="language-plaintext highlighter-rouge">req.getSession()</code>时，Servlet容器自动创建一个Session ID，然后通过一个名为<code class="language-plaintext highlighter-rouge">JSESSIONID</code>的Cookie发送给浏览器。<code class="language-plaintext highlighter-rouge">JSESSIONID</code>是由Servlet容器自动创建的，目的是维护一个浏览器会话，它和登录逻辑没有关系；即使没有登录功能，仍然可以使用<code class="language-plaintext highlighter-rouge">HttpSession</code>追踪用户，例如，放入一些用户配置信息等。</p><p>除了使用Cookie机制可以实现Session外，还可以通过隐藏表单、URL末尾附加ID来追踪Session。这些机制很少使用，最常用的Session机制仍然是Cookie。</p><p>使用Session时，由于服务器把所有用户的Session都存储在内存中，如果遇到内存不足的情况，就需要把部分不活动的Session序列化到磁盘上，这会大大降低服务器的运行效率，因此，放入Session的对象要小。</p><p>可以通过使用<code class="language-plaintext highlighter-rouge">req.getSession().invalidate();</code>使此会话失效，然后取消绑定到它的任何对象。</p><p>还可以设置seesion的时长，例如 30 分钟没有活动，会将已经存放的用户信息从seesion中移除。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">session</span><span class="o">.</span><span class="na">setMaxInactiveInterval</span><span class="o">(</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span><span class="o">);</span><span class="c1">//30分钟没活动，自动移除</span>
</code></pre></div></div><hr /><h3 id="cookie">CooKie</h3><p>Servlet提供的<code class="language-plaintext highlighter-rouge">HttpSession</code>本质上就是通过一个名为<code class="language-plaintext highlighter-rouge">JSESSIONID</code>的Cookie来跟踪用户会话的。除了这个名称外，其他名称的Cookie可以任意使用。</p><p>如果想要设置一个Cookie，例如，记录用户选择的语言，可以编写一个<code class="language-plaintext highlighter-rouge">LanguageServlet</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/language"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LanguageServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">language</span><span class="o">={</span><span class="s">"en"</span><span class="o">,</span><span class="s">"zh"</span><span class="o">};</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">lang</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"lang"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">language</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="n">lang</span><span class="o">)){</span>
            <span class="c1">// 创建一个新的Cookie:</span>
            <span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Cookie</span><span class="o">(</span><span class="s">"lang"</span><span class="o">,</span> <span class="n">lang</span><span class="o">);</span>
            <span class="c1">// 该Cookie生效的路径范围:</span>
            <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
            <span class="c1">// 该Cookie有效期:</span>
            <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">8640000</span><span class="o">);</span> <span class="c1">// 8640000秒=100天</span>
            <span class="c1">// 将该Cookie添加到响应:</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="s">"/index"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>创建一个新Cookie时，除了指定名称和值以外，通常需要设置<code class="language-plaintext highlighter-rouge">setPath("/")</code>，浏览器根据此前缀决定是否发送Cookie。如果一个Cookie调用了<code class="language-plaintext highlighter-rouge">setPath("/user/")</code>，那么浏览器只有在请求以<code class="language-plaintext highlighter-rouge">/user/</code>开头的路径时才会附加此Cookie。通过<code class="language-plaintext highlighter-rouge">setMaxAge()</code>设置Cookie的有效期，单位为秒，最后通过<code class="language-plaintext highlighter-rouge">resp.addCookie()</code>把它添加到响应。如果访问的是https网页，还需要调用<code class="language-plaintext highlighter-rouge">setSecure(true)</code>，否则浏览器不会发送该Cookie。</p><p>通过访问：<code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/language?lang=zh</code>，可以设置Cookie。问号后面为表单的值，多个值用<code class="language-plaintext highlighter-rouge">&amp;</code>隔开，特殊符号要转义，比如空格要转义为<code class="language-plaintext highlighter-rouge">%20</code>。</p><p>如果要读取Cookie，例如，在<code class="language-plaintext highlighter-rouge">IndexServlet</code>中，读取名为<code class="language-plaintext highlighter-rouge">lang</code>的Cookie以获取用户设置的语言：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/index"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html;charset=UTF-8"</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">user</span><span class="o">=(</span><span class="nc">String</span><span class="o">)</span> <span class="n">req</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
        <span class="nc">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;h1&gt;欢迎你, "</span> <span class="o">+</span> <span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">user</span> <span class="o">:</span> <span class="s">"访客"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"&lt;/h1&gt;"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">parseLanguageFromCookie</span><span class="o">(</span><span class="n">req</span><span class="o">));</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;p&gt;&lt;a href='/login'&gt;请登录&lt;/a&gt;&lt;/p&gt;"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;p&gt;&lt;a href='/logout'&gt;退出登录&lt;/a&gt;&lt;/p&gt;"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">parseLanguageFromCookie</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 获取请求附带的所有Cookie:</span>
        <span class="nc">Cookie</span><span class="o">[]</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
        <span class="c1">// 循环每个Cookie:</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 如果Cookie名称为lang:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"lang"</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// 返回Cookie的值:</span>
                <span class="k">return</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 返回默认值:</span>
        <span class="k">return</span> <span class="s">"en"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>读取Cookie主要依靠遍历<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>附带的所有Cookie。</p><h2 id="jsp">JSP</h2><p>Servlet就是一个能处理HTTP请求，发送HTTP响应的小程序，而发送响应无非就是获取<code class="language-plaintext highlighter-rouge">PrintWriter</code>，然后输出HTML。只不过，用PrintWriter输出HTML比较痛苦，因为不但要正确编写HTML，还需要插入各种变量。</p><p>JSP是Java Server Pages的缩写，它的文件必须放到<code class="language-plaintext highlighter-rouge">/src/main/webapp</code>下，文件名必须以<code class="language-plaintext highlighter-rouge">.jsp</code>结尾，整个文件与HTML并无太大区别，但需要插入变量，或者动态输出的地方，使用特殊指令<code class="language-plaintext highlighter-rouge">&lt;% ... %&gt;</code>。</p><p>编写一个<code class="language-plaintext highlighter-rouge">index.jsp</code>：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">contentType=</span><span class="s">"text/html;charset=UTF-8"</span><span class="na"> language=</span><span class="s">"java"</span><span class="na"> pageEncoding=</span><span class="s">"UTF-8"</span> <span class="nt">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Title<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="c">&lt;%-- JSP Comment --%&gt;</span>
<span class="nt">&lt;h1&gt;</span>你好!<span class="nt">&lt;%=</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span><span class="nt">%&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>整个JSP的内容实际上是一个HTML，但是稍有不同：</p><ul><li>包含在<code class="language-plaintext highlighter-rouge">&lt;%--</code>和<code class="language-plaintext highlighter-rouge">--%&gt;</code>之间的是JSP的注释，它们会被完全忽略；</li><li>包含在<code class="language-plaintext highlighter-rouge">&lt;%</code>和<code class="language-plaintext highlighter-rouge">%&gt;</code>之间的是Java代码，可以编写任意Java代码；</li><li>如果使用<code class="language-plaintext highlighter-rouge">&lt;%= xxx %&gt;</code>则可以快捷输出一个变量的值。</li><li>包含在<code class="language-plaintext highlighter-rouge">&lt;%!</code>和<code class="language-plaintext highlighter-rouge">%&gt;</code>之间的是Java代码，可以设置全局变量或方法。</li></ul><p>JSP页面内置了几个变量，可以直接使用：</p><ul><li><code class="language-plaintext highlighter-rouge">page</code>：表示当前JSP页面本身，可以调用<strong>页面</strong>的方法。</li><li><code class="language-plaintext highlighter-rouge">request</code>：表示<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>对象。可以通过该对象在<strong>同一请求期间的不同页面</strong>之间共享数据。</li><li><code class="language-plaintext highlighter-rouge">session</code>：表示当前<code class="language-plaintext highlighter-rouge">HttpSession</code>对象；可以通过该对象在<strong>同一会话期间的不同页面之间</strong>共享数据。</li><li><code class="language-plaintext highlighter-rouge">application</code>：表示<code class="language-plaintext highlighter-rouge">ServletContext</code>对象。可以通过该对象在<strong>不同的页面之间</strong>共享数据。</li><li><code class="language-plaintext highlighter-rouge">out</code>：表示<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>的<code class="language-plaintext highlighter-rouge">PrintWriter</code>；</li><li><code class="language-plaintext highlighter-rouge">response</code>：表示<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>对象，用于处理HTTP响应。</li><li><code class="language-plaintext highlighter-rouge">config</code>：表示<code class="language-plaintext highlighter-rouge">ServletContext</code>对象的<code class="language-plaintext highlighter-rouge">ServletConfig</code>，用于获取JSP页面的初始化参数。</li><li><code class="language-plaintext highlighter-rouge">exception</code>：表示在页面处理过程中发生的异常对象，如果页面没有发生异常，则该变量为null。</li></ul><hr /><p>访问JSP页面时，直接指定完整路径。例如，<code class="language-plaintext highlighter-rouge">http://localhost:8080/index.jsp</code>。</p><p>JSP和Servlet其实没有任何区别，因为JSP在执行前首先被编译成一个Servlet。在Tomcat的临时目录下，可以找到一个<code class="language-plaintext highlighter-rouge">index_jsp.java</code>的源文件，这个文件就是Tomcat把JSP自动转换成的Servlet源码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span> <span class="o">=</span> <span class="n">pageContext</span><span class="o">.</span><span class="na">getOut</span><span class="o">();</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;!DOCTYPE html PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\"&gt;\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;html&gt;\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;head&gt;\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"    &lt;title&gt;Title&lt;/title&gt;\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/head&gt;\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;body&gt;\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;h1&gt;你好!"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">));</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/h1&gt;\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/body&gt;\r\n"</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/html&gt;\r\n"</span><span class="o">);</span>
</code></pre></div></div><p>JSP本质上就是一个Servlet，只不过无需配置映射路径，Web Server会根据路径查找对应的<code class="language-plaintext highlighter-rouge">.jsp</code>文件，如果找到了，就自动编译成Servlet再执行。在服务器运行过程中，如果修改了JSP的内容，那么服务器会自动重新编译。</p><p><strong>如何获取复选框选中的值</strong></p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">""</span> <span class="na">method=</span><span class="s">"get"</span><span class="nt">&gt;</span> 
您喜欢的水果？<span class="nt">&lt;br</span> <span class="nt">/&gt;&lt;br</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;label&gt;&lt;input</span> <span class="na">name=</span><span class="s">"Fruit"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>苹果 <span class="nt">&lt;/label&gt;</span> 
<span class="nt">&lt;label&gt;&lt;input</span> <span class="na">name=</span><span class="s">"Fruit"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">value=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>桃子 <span class="nt">&lt;/label&gt;</span> 
<span class="nt">&lt;label&gt;&lt;input</span> <span class="na">name=</span><span class="s">"Fruit"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">value=</span><span class="s">"3"</span> <span class="nt">/&gt;</span>香蕉 <span class="nt">&lt;/label&gt;</span> 
<span class="nt">&lt;label&gt;&lt;input</span> <span class="na">name=</span><span class="s">"Fruit"</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">value=</span><span class="s">"3"</span> <span class="nt">/&gt;</span>梨 <span class="nt">&lt;/label&gt;</span> 
<span class="nt">&lt;/form&gt;</span> 
</code></pre></div></div><p>后台代码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="c1">//获取选中的选项</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="nc">Fruit</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="na">getParameterValues</span><span class="o">(</span><span class="s">"Fruit"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">Fruit</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div><p>假设四个全选中，则输出：<code class="language-plaintext highlighter-rouge">[1,2,3,4]</code></p><hr /><h3 id="动作指令">动作指令</h3><p>JSP的指令非常复杂，JSP页面本身可以通过<code class="language-plaintext highlighter-rouge">page</code>指令引入Java类：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">import=</span><span class="s">"java.io.*"</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;%@ page </span><span class="na">import=</span><span class="s">"java.util.*"</span> <span class="nt">%&gt;</span>
</code></pre></div></div><p>这样后续的Java代码才能引用简单类名而不是完整类名。</p><p>还可以设置其他参数，<code class="language-plaintext highlighter-rouge">language</code>设置jsp页面语言属性, <code class="language-plaintext highlighter-rouge">contentTyp</code>设置MIME类型和字符编码, <code class="language-plaintext highlighter-rouge">pageEncoding</code>设置页面编码格式：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">language=</span><span class="s">"java"</span><span class="na"> contentType=</span><span class="s">"text/html; charset=UTF-8"</span><span class="na"> pageEncoding=</span><span class="s">"UTF-8"</span><span class="nt">%&gt;</span>
</code></pre></div></div><hr /><p>使用<code class="language-plaintext highlighter-rouge">include</code>指令可以引入另一个JSP文件：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;%@ include </span><span class="na">file=</span><span class="s">"header.jsp"</span><span class="nt">%&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Index Page<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;%@ include </span><span class="na">file=</span><span class="s">"footer.jsp"</span><span class="nt">%&gt;</span>
<span class="nt">&lt;/body&gt;</span>
</code></pre></div></div><p>还可以导入普通文件：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;%</span><span class="err">@</span> <span class="n">include</span> <span class="n">file</span><span class="o">=</span><span class="s">"hello.txt"</span> <span class="o">%&gt;</span>
</code></pre></div></div><hr /><p>设置全局变量或方法：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%!</span> 
    <span class="kt">int</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span>
    <span class="kt">int</span> <span class="nf">count</span><span class="o">(){</span>
        <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="nt">%&gt;</span>
</code></pre></div></div><hr /><h3 id="动作指令标签">动作指令标签</h3><p>引入：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:include </span><span class="na">page=</span><span class="s">""</span><span class="nt">&gt;&lt;/jsp:include&gt;</span>
</code></pre></div></div><p>跳转入date.jsp：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:forward </span><span class="na">page=</span><span class="s">"date.jsp"</span><span class="nt">&gt;&lt;/jsp:forward&gt;</span>
</code></pre></div></div><p>会显示跳转前的url</p><p>传递参数的动作可做为其他标识的子标识</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:param </span><span class="na">value=</span><span class="s">"张三"</span><span class="na">  name=</span><span class="s">"name"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>即:</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:forward </span><span class="na">page=</span><span class="s">"date.jsp"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;jsp:param </span><span class="na">value=</span><span class="s">"张三"</span><span class="na">  name=</span><span class="s">"name"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/jsp:forward&gt;</span>
</code></pre></div></div><p>例子:</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%</span> 
<span class="nc">String</span> <span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">password</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">sex</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"sex"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">age</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"age"</span><span class="o">);</span>
<span class="k">if</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">""</span><span class="o">)){</span>
<span class="nt">%&gt;</span>
	<span class="nt">&lt;jsp:forward </span><span class="na">page=</span><span class="s">"err.jsp"</span><span class="nt">&gt;&lt;/jsp:forward&gt;</span>
<span class="nt">&lt;%</span>
<span class="o">}</span>
<span class="k">else</span><span class="o">{</span>
<span class="nt">%&gt;</span>
	<span class="nt">&lt;jsp:forward </span><span class="na">page=</span><span class="s">"cg.jsp"</span><span class="nt">&gt;&lt;/jsp:forward&gt;</span>
<span class="nt">&lt;%</span>
<span class="o">}</span>
<span class="nt">%&gt;</span>
</code></pre></div></div><p><strong>JavaBean相关标签</strong></p><p>id为实例名称,class为要实例化的对象,<code class="language-plaintext highlighter-rouge">scope="page"</code>表示只在当前页有效</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:useBean</span> <span class="na">id=</span><span class="s">"produce"</span> <span class="na">class=</span><span class="s">"com.lyq.bean.Produce"</span> <span class="na">scope=</span><span class="s">"page"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>scope属性值:</p><ul><li>page:在一个页面范围内</li><li>request:在一次服务器请求范围内</li><li>session:在一次会话范围内</li><li>application:在一个应用服务器范围内</li></ul><p>给<code class="language-plaintext highlighter-rouge">produce</code>对象实例的所有对的上名字的属性的值赋值,非对应不赋值。会自动将请求参数（来自表单或 URL 查询字符串）的值赋给指定 JavaBean 的属性。</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:setProperty</span> <span class="na">name=</span><span class="s">"produce"</span> <span class="na">property=</span><span class="s">"*"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>对指定的属性赋值，<code class="language-plaintext highlighter-rouge">property</code>属性名称, <code class="language-plaintext highlighter-rouge">name</code>实例对象, <code class="language-plaintext highlighter-rouge">value</code>值：</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:setProperty</span> <span class="na">property=</span><span class="s">"name"</span> <span class="na">name=</span><span class="s">"person"</span> <span class="na">value=</span><span class="s">"ada"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>通过动作标签获取值：</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:getProperty</span> <span class="na">property=</span><span class="s">"name"</span> <span class="na">name=</span><span class="s">"person"</span><span class="nt">/&gt;</span>
</code></pre></div></div><h3 id="jstl">JSTL</h3><p>JSP还允许自定义输出的tag，例如：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:out </span><span class="na">value = </span><span class="s">"</span><span class="si">${</span><span class="n">sessionScope</span><span class="o">.</span><span class="na">user</span><span class="o">.</span><span class="na">name</span><span class="si">}</span><span class="s">"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>JSP Tag需要正确引入taglib的jar包，并且还需要正确声明，使用起来非常复杂：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.taglibs/taglibs-standard-impl --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.taglibs<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>taglibs-standard-impl<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.2.5<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>用法：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">contentType=</span><span class="s">"text/html;charset=UTF-8"</span><span class="na"> language=</span><span class="s">"java"</span><span class="na"> pageEncoding=</span><span class="s">"UTF-8"</span> <span class="nt">%&gt;</span>
<span class="cp">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Title<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="c">&lt;%-- JSP Comment --%&gt;</span>
<span class="c">&lt;%--@elvariable id="user" type="java.lang.String"--%&gt;</span>
<span class="nt">&lt;h1&gt;</span>你好!<span class="nt">&lt;c:out </span><span class="na">value=</span><span class="s">"</span><span class="si">${</span><span class="n">user</span><span class="si">}</span><span class="s">"</span><span class="nt">/&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">${user}</code> 意思是取出某一范围中名称为user的变量，它的取值范围是<code class="language-plaintext highlighter-rouge">Page</code>,<code class="language-plaintext highlighter-rouge">Request</code>,<code class="language-plaintext highlighter-rouge">Session</code>,<code class="language-plaintext highlighter-rouge">Application</code>。</p><p>而<code class="language-plaintext highlighter-rouge">${param.user}</code>就不是从这四个范围取值的方式了，而是相当于 <code class="language-plaintext highlighter-rouge">request.getParameter("user")</code>。</p><p><strong>在JSP页面获取当前项目名称的方法</strong>：</p><p>一般对于静态资源会用到。</p><p>方法1：</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;%=</span> <span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getContextPath</span><span class="o">()</span> <span class="nt">%&gt;</span>
</code></pre></div></div><p>方法2： 使用EL表达式</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${pageContext.request.contextPath}
</code></pre></div></div><p>JSTL（JavaServer Pages Standard Tag Library）的 <code class="language-plaintext highlighter-rouge">c</code> 标签库用于处理 JSP 页面中的常见任务，比如条件处理、迭代和字符串操作。<code class="language-plaintext highlighter-rouge">c</code> 标签库的全名空间是 <code class="language-plaintext highlighter-rouge">http://java.sun.com/jsp/jstl/core</code>，通常使用前缀 <code class="language-plaintext highlighter-rouge">c</code>。</p><p>以下是 <code class="language-plaintext highlighter-rouge">c</code> 标签库中的常用标签：</p><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:out&gt;</code></li></ol><p>用于输出表达式的结果，类似于 <code class="language-plaintext highlighter-rouge">&lt;%= ... %&gt;</code>。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:out </span><span class="na">value=</span><span class="s">"</span><span class="si">${</span><span class="n">expression</span><span class="si">}</span><span class="s">"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:set&gt;</code></li></ol><p>用于设置变量的值，可以在页面范围、请求范围、会话范围或应用范围内设置变量。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:set </span><span class="na">var=</span><span class="s">"name"</span><span class="na"> value=</span><span class="s">"value"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><table><thead><tr><th><strong>属性</strong></th><th><strong>描述</strong></th><th><strong>是否必要</strong></th><th><strong>默认值</strong></th></tr></thead><tbody><tr><td>value</td><td>要存储的值</td><td>否</td><td>主体的内容</td></tr><tr><td>target</td><td>要修改的属性所属的对象</td><td>否</td><td>无</td></tr><tr><td>property</td><td>要修改的属性</td><td>否</td><td>无</td></tr><tr><td>var</td><td>存储信息的变量</td><td>否</td><td>无</td></tr><tr><td>scope</td><td>var属性的作用域</td><td>否</td><td>Page</td></tr></tbody></table><p>如果指定了target属性，那么property属性也需要被指定：</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;jsp:useBean</span> <span class="na">id=</span><span class="s">"user"</span> <span class="na">class=</span><span class="s">"com.example.User"</span> <span class="na">scope=</span><span class="s">"request"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;c:set</span> <span class="na">target=</span><span class="s">"${user}"</span> <span class="na">property=</span><span class="s">"name"</span> <span class="na">value=</span><span class="s">"Alice"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:remove&gt;</code></li></ol><p>用于移除变量。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:remove </span><span class="na">var=</span><span class="s">"name"</span><span class="na"> scope=</span><span class="s">"session"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:if&gt;</code></li></ol><p>用于条件处理。如果条件为真，则执行标签体内的内容。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:if </span><span class="na">test=</span><span class="s">"</span><span class="si">${</span><span class="n">condition</span><span class="si">}</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- content to display if condition is true --&gt;</span>
<span class="nt">&lt;/c:if&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:choose&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;c:when&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;c:otherwise&gt;</code></li></ol><p>用于实现类似于 <code class="language-plaintext highlighter-rouge">switch</code> 的多条件处理。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:choose&gt;</span>
    <span class="nt">&lt;c:when </span><span class="na">test=</span><span class="s">"</span><span class="si">${</span><span class="n">condition1</span><span class="si">}</span><span class="s">"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- content if condition1 is true --&gt;</span>
    <span class="nt">&lt;/c:when&gt;</span>
    <span class="nt">&lt;c:when </span><span class="na">test=</span><span class="s">"</span><span class="si">${</span><span class="n">condition2</span><span class="si">}</span><span class="s">"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- content if condition2 is true --&gt;</span>
    <span class="nt">&lt;/c:when&gt;</span>
    <span class="nt">&lt;c:otherwise&gt;</span>
        <span class="c">&lt;!-- content if none of the above conditions are true --&gt;</span>
    <span class="nt">&lt;/c:otherwise&gt;</span>
<span class="nt">&lt;/c:choose&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:forEach&gt;</code></li></ol><p>用于迭代集合或数组。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:forEach </span><span class="na">var=</span><span class="s">"item"</span><span class="na"> items=</span><span class="s">"</span><span class="si">${</span><span class="n">collection</span><span class="si">}</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- content to display for each item in the collection --&gt;</span>
    ${item}
<span class="nt">&lt;/c:forEach&gt;</span>
</code></pre></div></div><table><thead><tr><th>属性</th><th>描述</th><th>是否必要</th><th>默认值</th></tr></thead><tbody><tr><td>items</td><td>要被循环的信息</td><td>否</td><td>无</td></tr><tr><td>begin</td><td>开始的元素位置（0=第一个元素，1=第二个元素）</td><td>否</td><td>0</td></tr><tr><td>end</td><td>结束的元素位置（0=第一个元素，1=第二个元素）</td><td>否</td><td>Last element</td></tr><tr><td>step</td><td>每一次迭代的步长</td><td>否</td><td>1</td></tr><tr><td>var</td><td>代表当前条目的变量名称</td><td>否</td><td>无</td></tr><tr><td>varStatus</td><td>代表循环状态的变量名称</td><td>否</td><td>无</td></tr></tbody></table><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:forEach</span> <span class="na">items=</span><span class="s">"${myList}"</span> <span class="na">var=</span><span class="s">"item"</span> <span class="na">varStatus=</span><span class="s">"status"</span><span class="nt">&gt;</span>
    Index: ${status.index}, Count: ${status.count}, First: ${status.first}, Last: ${status.last}, Item: ${item}
<span class="nt">&lt;/c:forEach&gt;</span>
</code></pre></div></div><p>在这个例子中，<code class="language-plaintext highlighter-rouge">${myList}</code> 是一个列表对象，循环遍历列表中的元素。在循环体内部，可以使用 <code class="language-plaintext highlighter-rouge">${item}</code> 引用当前元素，<code class="language-plaintext highlighter-rouge">${status.index}</code> 引用当前迭代的索引，<code class="language-plaintext highlighter-rouge">${status.count}</code> 引用当前迭代的计数（从1开始），<code class="language-plaintext highlighter-rouge">${status.first}</code> 表示是否为第一个元素（true/false），<code class="language-plaintext highlighter-rouge">${status.last}</code> 表示是否为最后一个元素（true/false）。</p><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:forTokens&gt;</code></li></ol><p>用于迭代一个字符串中的分隔符。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:forTokens </span><span class="na">items=</span><span class="s">"item1,item2,item3"</span><span class="na"> delims=</span><span class="s">","</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- content to display for each token --&gt;</span>
    ${token}
<span class="nt">&lt;/c:forTokens&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:catch&gt;</code></li></ol><p>用于捕获异常。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:catch </span><span class="na">var=</span><span class="s">"exception"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- content to display if an exception occurs --&gt;</span>
<span class="nt">&lt;/c:catch&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:url&gt;</code></li></ol><p>用于生成 URL，并进行编码，以确保在重写规则下 URL 的正确性。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:url </span><span class="na">value=</span><span class="s">"path"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;c:param </span><span class="na">name=</span><span class="s">"paramName"</span><span class="na"> value=</span><span class="s">"paramValue"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/c:url&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:redirect&gt;</code></li></ol><p>用于重定向请求。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:redirect </span><span class="na">url=</span><span class="s">"newUrl"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><ol><li><code class="language-plaintext highlighter-rouge">&lt;c:import&gt;</code></li></ol><p>用于导入内容到当前页面，可以是 URL 的内容或者文件的内容。</p><div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;c:import </span><span class="na">url=</span><span class="s">"urlOrPath"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><h2 id="mvc">MVC</h2><p>Servlet适合编写Java代码，实现各种复杂的业务逻辑，但不适合输出复杂的HTML；JSP适合编写HTML，并在其中插入动态内容，但不适合编写复杂的Java代码。</p><p>在<code class="language-plaintext highlighter-rouge">UserServlet</code>中，可以从数据库读取<code class="language-plaintext highlighter-rouge">User</code>、<code class="language-plaintext highlighter-rouge">School</code>等信息，然后，把读取封装到的<code class="language-plaintext highlighter-rouge">JavaBean</code>先放到<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>中，再通过<code class="language-plaintext highlighter-rouge">forward()</code>传给<code class="language-plaintext highlighter-rouge">user.jsp</code>处理。而在<code class="language-plaintext highlighter-rouge">user.jsp</code>中，只负责展示相关<code class="language-plaintext highlighter-rouge">JavaBean</code>的信息，就不需要编写访问数据库等复杂逻辑。</p><p>需要展示的<code class="language-plaintext highlighter-rouge">User</code>被放入<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>中以便传递给JSP，因为一个请求对应一个<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>，也无需清理它，处理完该请求后<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>实例将被丢弃；</p><p>把<code class="language-plaintext highlighter-rouge">user.jsp</code>放到<code class="language-plaintext highlighter-rouge">/WEB-INF/</code>目录下，是因为<code class="language-plaintext highlighter-rouge">WEB-INF</code>是一个特殊目录，Web Server会阻止浏览器对<code class="language-plaintext highlighter-rouge">WEB-INF</code>目录下任何资源的访问，这样就防止用户通过<code class="language-plaintext highlighter-rouge">/user.jsp</code>路径直接访问到JSP页面；</p><p>JSP页面首先从<code class="language-plaintext highlighter-rouge">request</code>变量获取<code class="language-plaintext highlighter-rouge">User</code>实例，然后在页面中直接输出。这里把<code class="language-plaintext highlighter-rouge">UserServlet</code>看作业务逻辑处理，把<code class="language-plaintext highlighter-rouge">User</code>看作模型，把<code class="language-plaintext highlighter-rouge">user.jsp</code>看作渲染，这种设计模式通常被称为MVC：Model-View-Controller，即<code class="language-plaintext highlighter-rouge">UserServlet</code>作为控制器（Controller），<code class="language-plaintext highlighter-rouge">User</code>作为模型（Model），<code class="language-plaintext highlighter-rouge">user.jsp</code>作为视图（View）。</p><p>使用MVC模式的好处是，Controller专注于业务处理，它的处理结果就是Model。Model可以是一个JavaBean，也可以是一个包含多个对象的Map，Controller只负责把Model传递给View，View只负责把Model给“渲染”出来，这样，三者职责明确，且开发更简单，因为开发Controller时无需关注页面，开发View时无需关心如何创建Model。MVC模式是一种分离业务逻辑和显示逻辑的设计模式，广泛地应用在Web页面和传统的桌面程序中。</p><hr /><p>通过结合Servlet和JSP的MVC模式，可以发挥二者各自的优点：</p><ul><li>Servlet实现业务逻辑；</li><li>JSP实现展示逻辑。</li></ul><p>但是，直接把MVC搭在Servlet和JSP之上还是不太好，原因如下：</p><ul><li>Servlet提供的接口仍然偏底层，需要实现Servlet调用相关接口；</li><li>JSP对页面开发不友好，更好的替代品是模板引擎；</li><li>业务逻辑最好由纯粹的Java类实现，而不是强迫继承自Servlet。</li></ul><p>能不能通过普通的Java类实现MVC的Controller？类似下面的代码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/signin"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">signin</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/signin"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">doSignin</span><span class="o">(</span><span class="nc">SignInBean</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/signout"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">signout</span><span class="o">(</span><span class="nc">HttpSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>上面的这个Java类每个方法都对应一个GET或POST请求，方法返回值是<code class="language-plaintext highlighter-rouge">ModelAndView</code>，它包含一个View的路径以及一个Model，这样，再由MVC框架处理后返回给浏览器。</p><p>如果是GET请求，希望MVC框架能直接把URL参数按方法参数对应起来然后传入：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">hello</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div><p>如果是POST请求，希望MVC框架能直接把Post参数变成一个JavaBean后通过方法参数传入：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/signin"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">doSignin</span><span class="o">(</span><span class="nc">SignInBean</span> <span class="n">bean</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div><p>为了增加灵活性，如果Controller的方法在处理请求时需要访问<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>、<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>、<code class="language-plaintext highlighter-rouge">HttpSession</code>这些实例时，只要方法参数有定义，就可以自动传入：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/signout"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">signout</span><span class="o">(</span><span class="nc">HttpSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div><hr /><p><strong>设计MVC框架</strong></p><p><code class="language-plaintext highlighter-rouge">ModelAndView</code>对象包含一个<code class="language-plaintext highlighter-rouge">View</code>和一个<code class="language-plaintext highlighter-rouge">Model</code>。实际上<code class="language-plaintext highlighter-rouge">View</code>就是模板的路径，而<code class="language-plaintext highlighter-rouge">Model</code>可以用一个<code class="language-plaintext highlighter-rouge">Map&lt;String, Object&gt;</code>表示，因此，<code class="language-plaintext highlighter-rouge">ModelAndView</code>定义非常简单：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ModelAndView</span> <span class="o">{</span>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">model</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">view</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>比较复杂的是需要在MVC框架中创建一个接收所有请求的<code class="language-plaintext highlighter-rouge">Servlet</code>通常命名为<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>，它总是映射到<code class="language-plaintext highlighter-rouge">/</code>，然后，根据不同的Controller的方法定义的<code class="language-plaintext highlighter-rouge">@Get</code>或<code class="language-plaintext highlighter-rouge">@Post</code>的<code class="language-plaintext highlighter-rouge">Path</code>决定调用哪个方法，最后，获得方法返回的<code class="language-plaintext highlighter-rouge">ModelAndView</code>后，渲染模板，写入<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>，即完成了整个MVC的处理。</p><p>这个MVC的架构如下：</p><pre><code class="language-ascii">   HTTP Request    ┌─────────────────┐
──────────────────&gt;│DispatcherServlet│
                   └─────────────────┘
                            │
               ┌────────────┼────────────┐
               ▼            ▼            ▼
         ┌───────────┐┌───────────┐┌───────────┐
         │Controller1││Controller2││Controller3│
         └───────────┘└───────────┘└───────────┘
               │            │            │
               └────────────┼────────────┘
                            ▼
   HTTP Response ┌────────────────────┐
&lt;────────────────│render(ModelAndView)│
                 └────────────────────┘
</code></pre><p>其中，<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>以及如何渲染均由MVC框架实现，在MVC框架之上只需要编写每一个Controller。</p><p>编写<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>，需要存储请求路径到某个具体方法的映射：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DispatcherServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">GetDispatcher</span><span class="o">&gt;</span> <span class="n">getMappings</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">PostDispatcher</span><span class="o">&gt;</span> <span class="n">postMappings</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="o">}</span>
</code></pre></div></div><p>处理一个GET请求是通过<code class="language-plaintext highlighter-rouge">GetDispatcher</code>对象完成的，它需要如下信息：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">GetDispatcher</span> <span class="o">{</span>
    <span class="nc">Object</span> <span class="n">instance</span><span class="o">;</span> <span class="c1">// Controller实例</span>
    <span class="nc">Method</span> <span class="n">method</span><span class="o">;</span> <span class="c1">// Controller方法</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">parameterNames</span><span class="o">;</span> <span class="c1">// 方法参数名称</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterClasses</span><span class="o">;</span> <span class="c1">// 方法参数类型</span>
<span class="o">}</span>
</code></pre></div></div><p>有了以上信息，就可以定义<code class="language-plaintext highlighter-rouge">invoke()</code>来处理真正的请求：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">GetDispatcher</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">arguments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">parameterClasses</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterClasses</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">parameterName</span> <span class="o">=</span> <span class="n">parameterNames</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">parameterClass</span> <span class="o">=</span> <span class="n">parameterClasses</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="nc">HttpServletRequest</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="nc">HttpSession</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">getOrDefault</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">parameterName</span><span class="o">,</span> <span class="s">"0"</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">getOrDefault</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">parameterName</span><span class="o">,</span> <span class="s">"0"</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="kt">boolean</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">getOrDefault</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">parameterName</span><span class="o">,</span> <span class="s">"false"</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">getOrDefault</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">parameterName</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Missing handler for type: "</span> <span class="o">+</span> <span class="n">parameterClass</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">ModelAndView</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">instance</span><span class="o">,</span> <span class="n">arguments</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getOrDefault</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">defaultValue</span> <span class="o">:</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>上述代码比较繁琐，但逻辑非常简单，即通过构造某个方法需要的所有参数列表，使用反射调用该方法后返回结果。类似的，<code class="language-plaintext highlighter-rouge">PostDispatcher</code>需要如下信息：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">PostDispatcher</span> <span class="o">{</span>
    <span class="nc">Object</span> <span class="n">instance</span><span class="o">;</span> <span class="c1">// Controller实例</span>
    <span class="nc">Method</span> <span class="n">method</span><span class="o">;</span> <span class="c1">// Controller方法</span>
    <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterClasses</span><span class="o">;</span> <span class="c1">// 方法参数类型</span>
    <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span> <span class="c1">// JSON映射</span>
<span class="o">}</span>
</code></pre></div></div><p>和GET请求不同，POST请求严格地来说不能有URL参数，所有数据都应当从Post Body中读取。为了简化处理，只支持JSON格式的POST请求，这样，把Post数据转化为JavaBean就非常容易。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">PostDispatcher</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">arguments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">parameterClasses</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameterClasses</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">parameterClass</span> <span class="o">=</span> <span class="n">parameterClasses</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="nc">HttpServletRequest</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parameterClass</span> <span class="o">==</span> <span class="nc">HttpSession</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="c1">// 读取JSON并解析为JavaBean:</span>
                <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getReader</span><span class="o">();</span>
                <span class="n">arguments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">objectMapper</span><span class="o">.</span><span class="na">readValue</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">parameterClass</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">(</span><span class="nc">ModelAndView</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">instance</span><span class="o">,</span> <span class="n">arguments</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>json转换依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.17.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>为了方便性，可以把方法提出接口：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">Dispatcher</span> <span class="o">{</span>
    <span class="nc">ModelAndView</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InvocationTargetException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">IOException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>最后实现整个<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>的处理流程：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DispatcherServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">GetDispatcher</span><span class="o">&gt;</span> <span class="n">getMappings</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">PostDispatcher</span><span class="o">&gt;</span> <span class="n">postMappings</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">private</span> <span class="nc">ViewEngine</span> <span class="n">viewEngine</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// todo 扫描注解</span>
        <span class="k">this</span><span class="o">.</span><span class="na">getMappings</span> <span class="o">=</span> <span class="n">scanGetInControllers</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">postMappings</span> <span class="o">=</span> <span class="n">scanPostInControllers</span><span class="o">();</span>
        <span class="c1">// 模板引擎初始化</span>
        <span class="n">viewEngine</span><span class="o">=</span><span class="k">new</span> <span class="nc">ViewEngine</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">PostDispatcher</span><span class="o">&gt;</span> <span class="nf">scanPostInControllers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">GetDispatcher</span><span class="o">&gt;</span> <span class="nf">scanGetInControllers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="c1">// 根据路径查找GetDispatcher:</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">().</span><span class="na">length</span><span class="o">());</span>
        <span class="nc">Dispatcher</span> <span class="n">dispatcher</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getMappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dispatcher</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 未找到返回404:</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="mi">404</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">run</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">,</span><span class="n">dispatcher</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="c1">// 根据路径查找GetDispatcher:</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">().</span><span class="na">length</span><span class="o">());</span>
        <span class="nc">Dispatcher</span> <span class="n">dispatcher</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">postMappings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dispatcher</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 未找到返回404:</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="mi">404</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">run</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">,</span><span class="n">dispatcher</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">,</span> <span class="nc">Dispatcher</span> <span class="n">dispatcher</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 调用Controller方法获得返回值:</span>
        <span class="nc">ModelAndView</span> <span class="n">mv</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">mv</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 允许返回null，表示内部已自行处理完毕；</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mv</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 允许返回`redirect:`开头的view表示重定向:</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mv</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"redirect:"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">mv</span><span class="o">.</span><span class="na">view</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">9</span><span class="o">));</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// 将模板引擎渲染的内容写入响应:</span>
        <span class="nc">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">viewEngine</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">mv</span><span class="o">,</span> <span class="n">pw</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>用反射得到注解方法暂时不提。对于模板引擎<code class="language-plaintext highlighter-rouge">ViewEngine</code>，Java有很多开源的模板引擎，常用的有：<a href="https://www.thymeleaf.org/">Thymeleaf</a>、<a href="https://freemarker.apache.org/">FreeMarker</a>、<a href="https://velocity.apache.org/">Velocity</a>，用法都大同小异。推荐一个使用<a href="https://palletsprojects.com/p/jinja/">Jinja</a>语法的模板引擎<a href="https://pebbletemplates.io/">Pebble</a>，它的特点是语法简单，支持模板继承，编写出来的模板类似：</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
  
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>即变量用{{user}}表示，控制语句用{\% for user in users \%}表示。</p><p>使用Pebble渲染只需要如下几行代码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ViewEngine</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">PebbleEngine</span> <span class="n">engine</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ViewEngine</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 定义一个ServletLoader用于加载模板:</span>
        <span class="nc">ServletLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServletLoader</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
        <span class="c1">// 模板编码:</span>
        <span class="n">loader</span><span class="o">.</span><span class="na">setCharset</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="c1">// 模板前缀，这里默认模板必须放在`/WEB-INF/templates`目录:</span>
        <span class="n">loader</span><span class="o">.</span><span class="na">setPrefix</span><span class="o">(</span><span class="s">"/WEB-INF/templates"</span><span class="o">);</span>
        <span class="c1">// 模板后缀:</span>
        <span class="n">loader</span><span class="o">.</span><span class="na">setSuffix</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
        <span class="c1">// 创建Pebble实例:</span>
        <span class="k">this</span><span class="o">.</span><span class="na">engine</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PebbleEngine</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">autoEscaping</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="c1">// 默认打开HTML字符转义，防止XSS攻击</span>
                <span class="o">.</span><span class="na">cacheActive</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span> <span class="c1">// 禁用缓存使得每次修改模板可以立刻看到效果</span>
                <span class="o">.</span><span class="na">loader</span><span class="o">(</span><span class="n">loader</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">render</span><span class="o">(</span><span class="nc">ModelAndView</span> <span class="n">mv</span><span class="o">,</span> <span class="nc">Writer</span> <span class="n">writer</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 查找模板:</span>
        <span class="nc">PebbleTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">engine</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="n">mv</span><span class="o">.</span><span class="na">view</span><span class="o">);</span>
        <span class="c1">// 渲染:</span>
        <span class="n">template</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">writer</span><span class="o">,</span> <span class="n">mv</span><span class="o">.</span><span class="na">model</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/io.pebbletemplates/pebble --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.pebbletemplates<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>pebble<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.2.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>这里规定了模板必须放在<code class="language-plaintext highlighter-rouge">webapp/WEB-INF/templates</code>目录下。</p><p>再实现一个<code class="language-plaintext highlighter-rouge">FileServlet</code>来处理静态文件：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"/favicon.ico"</span><span class="o">,</span> <span class="s">"/static/*"</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 读取当前请求路径:</span>
        <span class="nc">ServletContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
        <span class="c1">// RequestURI包含ContextPath,需要去掉:</span>
        <span class="nc">String</span> <span class="n">urlPath</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">getContextPath</span><span class="o">().</span><span class="na">length</span><span class="o">());</span>
        <span class="c1">// 获取真实文件路径:</span>
        <span class="nc">String</span> <span class="n">filepath</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getRealPath</span><span class="o">(</span><span class="n">urlPath</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">filepath</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 无法获取到路径:</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">path</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">isFile</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// 文件不存在:</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_NOT_FOUND</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 根据文件名猜测Content-Type:</span>
        <span class="nc">String</span> <span class="n">mime</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">probeContentType</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mime</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="s">"application/octet-stream"</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="n">mime</span><span class="o">);</span>
        <span class="c1">// 读取文件并写入Response:</span>
        <span class="nc">OutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">filepath</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">input</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">output</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>静态文件应该放在<code class="language-plaintext highlighter-rouge">webapp/static</code>目录下。</p><p>为了把<strong>方法参数的名称</strong>编译到class文件中，以便处理<code class="language-plaintext highlighter-rouge">@GetMapping</code>时使用，需要打开编译器的一个参数：</p><p>在Eclipse中勾选<code class="language-plaintext highlighter-rouge">Preferences</code>-<code class="language-plaintext highlighter-rouge">Java</code>-<code class="language-plaintext highlighter-rouge">Compiler</code>-<code class="language-plaintext highlighter-rouge">Store information about method parameters (usable via reflection)</code>；</p><p>在Idea中选择<code class="language-plaintext highlighter-rouge">Preferences</code>-<code class="language-plaintext highlighter-rouge">Build, Execution, Deployment</code>-<code class="language-plaintext highlighter-rouge">Compiler</code>-<code class="language-plaintext highlighter-rouge">Java Compiler</code>-<code class="language-plaintext highlighter-rouge">Additional command line parameters</code>，填入<code class="language-plaintext highlighter-rouge">-parameters</code>；</p><p>在Maven的<code class="language-plaintext highlighter-rouge">pom.xml</code>添加一段配置如下：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;project</span> <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
    ...
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;compilerArgs&gt;</span>
                        <span class="nt">&lt;arg&gt;</span>-parameters<span class="nt">&lt;/arg&gt;</span>
                    <span class="nt">&lt;/compilerArgs&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">-parameters</code>的作用是在编译后的类文件中<strong>保留方法参数的名称</strong>。默认情况下，Java编译器在编译过程中会丢弃方法参数的名称，而只保留参数的顺序。</p><p>一个MVC框架是基于Servlet基础抽象出更高级的接口，使得上层基于MVC框架的开发可以不涉及Servlet相关的<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>等接口，处理多个请求更加灵活，并且可以使用任意模板引擎，不必使用JSP。</p><p>注解扫描：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Scan</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">GetDispatcher</span><span class="o">&gt;</span> <span class="n">getMappings</span><span class="o">=</span><span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">PostDispatcher</span><span class="o">&gt;</span> <span class="n">postMappings</span><span class="o">=</span><span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="kd">public</span> <span class="nf">Scan</span><span class="o">(</span><span class="nc">String</span> <span class="n">packageName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">scanClassFile</span><span class="o">(</span><span class="n">packageName</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">workAnnotations</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InstantiationException</span> <span class="o">|</span> <span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getClasspath</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
        <span class="no">URL</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
     * 找全部class
     * @param packageName
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">scanClassFile</span><span class="o">(</span><span class="nc">String</span> <span class="n">packageName</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">basePath</span><span class="o">=</span> <span class="n">packageName</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">'.'</span><span class="o">,</span><span class="sc">'/'</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">classpath</span> <span class="o">=</span> <span class="n">getClasspath</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">File</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">File</span> <span class="n">baseDir</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">classpath</span><span class="o">,</span> <span class="n">basePath</span><span class="o">);</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">baseDir</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="k">continue</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">list</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">listFiles</span><span class="o">()));</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".class"</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">packageName</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">".class"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
                    <span class="n">classes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 处理异常</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">workAnnotations</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InstantiationException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span> <span class="o">{</span>
        <span class="cm">/*过滤掉接口*/</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">collect</span> <span class="o">=</span> <span class="n">classes</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">x</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span> <span class="o">:</span> <span class="n">collect</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Object</span> <span class="n">o</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
            <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Annotation</span><span class="o">[]</span> <span class="n">annotations</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotations</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">Annotation</span> <span class="n">annotation</span> <span class="o">:</span> <span class="n">annotations</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="nc">GetMapping</span><span class="o">){</span>
                        <span class="cm">/*共享实例，不然实例变量无效了（因为每个方法都实例化了一个实例对象）*/</span>
                        <span class="n">o</span><span class="o">=</span><span class="n">getMappingWork</span><span class="o">(</span><span class="n">aClass</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="o">(</span><span class="nc">GetMapping</span><span class="o">)</span> <span class="n">annotation</span><span class="o">,</span><span class="n">o</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">annotation</span> <span class="k">instanceof</span> <span class="nc">PostMapping</span><span class="o">){</span>
                        <span class="cm">/*共享实例*/</span>
                        <span class="n">o</span><span class="o">=</span><span class="n">postMappingWork</span><span class="o">(</span><span class="n">aClass</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="o">(</span><span class="nc">PostMapping</span><span class="o">)</span> <span class="n">annotation</span><span class="o">,</span><span class="n">o</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Object</span> <span class="nf">postMappingWork</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">PostMapping</span> <span class="n">annotation</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InstantiationException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span> <span class="o">{</span>
        <span class="nc">Parameter</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">parameterNames</span><span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">parameters</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterClasses</span><span class="o">=</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[</span><span class="n">parameters</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Parameter</span> <span class="n">parameter</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="n">parameterNames</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="n">parameter</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
            <span class="n">parameterClasses</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="n">parameter</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="n">o</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="nc">PostDispatcher</span> <span class="n">postDispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PostDispatcher</span><span class="o">();</span>
        <span class="n">postDispatcher</span><span class="o">.</span><span class="na">setInstance</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">postDispatcher</span><span class="o">.</span><span class="na">setMethod</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
        <span class="n">postDispatcher</span><span class="o">.</span><span class="na">setParameterClasses</span><span class="o">(</span><span class="n">parameterClasses</span><span class="o">);</span>
        <span class="n">postMappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">value</span><span class="o">(),</span><span class="n">postDispatcher</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Object</span> <span class="nf">getMappingWork</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">GetMapping</span> <span class="n">annotation</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InstantiationException</span><span class="o">,</span> <span class="nc">IllegalAccessException</span> <span class="o">{</span>
        <span class="nc">Parameter</span><span class="o">[]</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameters</span><span class="o">();</span>
        <span class="nc">String</span><span class="o">[]</span> <span class="n">parameterNames</span><span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">parameters</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterClasses</span><span class="o">=</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[</span><span class="n">parameters</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Parameter</span> <span class="n">parameter</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="n">parameterNames</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="n">parameter</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
            <span class="n">parameterClasses</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span><span class="n">parameter</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="n">o</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="nc">GetDispatcher</span> <span class="n">getDispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetDispatcher</span><span class="o">();</span>
        <span class="n">getDispatcher</span><span class="o">.</span><span class="na">setInstance</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">getDispatcher</span><span class="o">.</span><span class="na">setMethod</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
        <span class="n">getDispatcher</span><span class="o">.</span><span class="na">setParameterClasses</span><span class="o">(</span><span class="n">parameterClasses</span><span class="o">);</span>
        <span class="n">getDispatcher</span><span class="o">.</span><span class="na">setParameterNames</span><span class="o">(</span><span class="n">parameterNames</span><span class="o">);</span>
        <span class="n">getMappings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">annotation</span><span class="o">.</span><span class="na">value</span><span class="o">(),</span><span class="n">getDispatcher</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">GetDispatcher</span><span class="o">&gt;</span> <span class="nf">getGetMappings</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getMappings</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">PostDispatcher</span><span class="o">&gt;</span> <span class="nf">getPostMappings</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">postMappings</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">DispatcherServlet</code>修改：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 扫描servlet包下的注解</span>
    <span class="nc">Scan</span> <span class="n">scan</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scan</span><span class="o">(</span><span class="s">"servlet"</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">getMappings</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="na">getGetMappings</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">postMappings</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="na">getPostMappings</span><span class="o">();</span>
    <span class="c1">// 模板引擎初始化</span>
    <span class="n">viewEngine</span><span class="o">=</span><span class="k">new</span> <span class="nc">ViewEngine</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div><p>测试：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">test</span><span class="o">(){</span>
        <span class="n">s</span><span class="o">=</span><span class="s">"test"</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"test"</span><span class="o">);</span>
        <span class="nc">ModelAndView</span> <span class="n">modelAndView</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ModelAndView</span><span class="o">();</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span><span class="s">"小米"</span><span class="o">);</span>
        <span class="n">modelAndView</span><span class="o">.</span><span class="na">setModel</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="n">modelAndView</span><span class="o">.</span><span class="na">setView</span><span class="o">(</span><span class="s">"test.html"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">modelAndView</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/test2"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">ModelAndView</span> <span class="nf">test2</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">/WEB-INF/templates/test.html</code>内用双大括号引用变量<code class="language-plaintext highlighter-rouge">name</code>即：:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;&lt;/h1&gt;</span>
</code></pre></div></div><p>get访问<code class="language-plaintext highlighter-rouge">http://localhost:8080/test2?key=1</code>显示正常。</p><p>post-body-raw-JSON：<code class="language-plaintext highlighter-rouge">{"key": "John"}</code>，访问<code class="language-plaintext highlighter-rouge">http://localhost:8080/test2</code>，显示正常。</p><h2 id="filter">Filter</h2><p>为了把一些公用逻辑从各个Servlet中抽离出来，JavaEE的Servlet规范还提供了一种Filter组件，即过滤器，它的作用是，在HTTP请求到达Servlet之前，可以被一个或多个Filter预处理，类似打印日志、登录检查等逻辑，完全可以放到Filter中。</p><p>例如，编写一个最简单的<code class="language-plaintext highlighter-rouge">EncodingFilter</code>，把输入和输出的编码设置为UTF-8：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebFilter</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/*"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncodingFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"EncodingFilter:doFilter"</span><span class="o">);</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">@WebFilter(urlPatterns = "/*")</code>换成在<code class="language-plaintext highlighter-rouge">web.xml</code>的写法为：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>filter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>filter.EncodingFilter<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>filter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</code></pre></div></div><p>编写Filter时，必须实现<code class="language-plaintext highlighter-rouge">Filter</code>接口，在<code class="language-plaintext highlighter-rouge">doFilter()</code>方法内部，要继续处理请求，<strong>必须</strong>调用<code class="language-plaintext highlighter-rouge">chain.doFilter()</code>。最后，用<code class="language-plaintext highlighter-rouge">@WebFilter</code>注解标注该Filter需要过滤的URL。<code class="language-plaintext highlighter-rouge">/*</code>表示所有路径。</p><p>还可以继续添加其他Filter，例如LogFilter：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebFilter</span><span class="o">(</span><span class="s">"/*"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"LogFilter: process "</span> <span class="o">+</span> <span class="o">((</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">).</span><span class="na">getRequestURI</span><span class="o">());</span>
        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>多个Filter会组成一个链，每个请求都被链上的Filter依次处理，如果要给每个Filter指定顺序，就必须在<code class="language-plaintext highlighter-rouge">web.xml</code>文件中对Filter进行配置，执行顺序为在<code class="language-plaintext highlighter-rouge">web.xml</code>文件中<code class="language-plaintext highlighter-rouge">filter-mapping</code>定义的顺序，按定义顺序执行。</p><p>也可以编写只对特定路径进行过滤的Filter，例如<code class="language-plaintext highlighter-rouge">AuthFilter</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebFilter</span><span class="o">(</span><span class="s">"/user/*"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"AuthFilter: check authentication"</span><span class="o">);</span>
        <span class="nc">HttpServletRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
        <span class="nc">HttpServletResponse</span> <span class="n">resp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 未登录，自动跳转到登录页:</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"AuthFilter: not signin!"</span><span class="o">);</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="s">"/signin"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 已登录，继续处理:</span>
            <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">AuthFilter</code>只过滤以<code class="language-plaintext highlighter-rouge">/user/</code>开头的路径，因此：</p><ul><li>如果一个请求路径类似<code class="language-plaintext highlighter-rouge">/user/profile</code>，那么它会被上述3个Filter依次处理；</li><li>如果一个请求路径类似<code class="language-plaintext highlighter-rouge">/test</code>，那么它会被上述2个Filter依次处理（不会被AuthFilter处理）。</li></ul><p>当用户没有登录时，在<code class="language-plaintext highlighter-rouge">AuthFilter</code>内部，直接调用<code class="language-plaintext highlighter-rouge">resp.sendRedirect()</code>发送重定向，且<strong>没有调用</strong><code class="language-plaintext highlighter-rouge">chain.doFilter()</code>，因此，当用户没有登录时，请求到达<code class="language-plaintext highlighter-rouge">AuthFilter</code>后，不再继续处理，即后续的Filter和任何Servlet都没有机会处理该请求了。</p><p>如果一个Filter在当前请求中生效，但什么都没有做，那么，用户将看到一个空白页，因为请求没有继续处理，默认响应是200+空白输出。如果Filter要使请求继续被处理，就<strong>一定要调用</strong><code class="language-plaintext highlighter-rouge">chain.doFilter()</code>。</p><hr /><h3 id="修改请求">修改请求</h3><p>在Web应用中经常需要处理用户上传文件，例如，一个UploadServlet可以简单地编写如下：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/upload/file"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UploadServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// 读取Request Body:</span>
        <span class="nc">InputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="nc">ByteArrayOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">output</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// TODO: 写入文件:</span>
        <span class="c1">// 显示上传结果:</span>
        <span class="nc">String</span> <span class="n">uploadedText</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
        <span class="nc">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;h1&gt;上传的内容:&lt;/h1&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;pre&gt;&lt;code&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">uploadedText</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/code&gt;&lt;/pre&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>在postman中选择POST请求，body-binary-选择文件，并访问<code class="language-plaintext highlighter-rouge">http://localhost:8080/upload/file</code>，正常输出了文件内容。</p><p>如果要保证文件上传的完整性，可以在上传文件的同时，把文件的哈希也传过来，服务器端做一个验证，就可以确保用户上传的文件一定是完整的。</p><p>这个验证逻辑非常适合写在<code class="language-plaintext highlighter-rouge">ValidateUploadFilter</code>中，因为它可以复用：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebFilter</span><span class="o">(</span><span class="s">"/upload/*"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ValidateUploadFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">HttpServletRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
        <span class="nc">HttpServletResponse</span> <span class="n">resp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
        <span class="c1">// 获取客户端传入的签名方法和签名:</span>
        <span class="nc">String</span> <span class="n">digest</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Signature-Method"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">signature</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"Signature"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">digest</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">digest</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">||</span> <span class="n">signature</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">signature</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">sendErrorPage</span><span class="o">(</span><span class="n">resp</span><span class="o">,</span> <span class="s">"缺少签名"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="cm">/*读取文件*/</span>
        <span class="nc">ServletInputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="nc">ByteArrayOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">output</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 验证签名:</span>
        <span class="nc">MessageDigest</span> <span class="n">md</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">md</span><span class="o">=</span><span class="nc">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">digest</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">md</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">output</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="kt">byte</span> <span class="o">[]</span> <span class="n">result</span><span class="o">=</span><span class="n">md</span><span class="o">.</span><span class="na">digest</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">actual</span> <span class="o">=</span> <span class="n">toHexString</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">signature</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">actual</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">sendErrorPage</span><span class="o">(</span><span class="n">resp</span><span class="o">,</span> <span class="s">"签名无效."</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 验证成功后继续处理:</span>
        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 将byte[]转换为hex string:</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">toHexString</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">digest</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span> <span class="n">b</span> <span class="o">:</span> <span class="n">digest</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%02x"</span><span class="o">,</span> <span class="n">b</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 发送一个错误响应:</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendErrorPage</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">,</span> <span class="nc">String</span> <span class="n">errorMessage</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_BAD_REQUEST</span><span class="o">);</span>
        <span class="nc">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">errorMessage</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>在postman中选择POST请求，body-binary-选择好文件。</p><p>设置Header参数：<code class="language-plaintext highlighter-rouge">Signature-Method</code>:<code class="language-plaintext highlighter-rouge">SHA-1</code>，<code class="language-plaintext highlighter-rouge">Signature</code>:<code class="language-plaintext highlighter-rouge">D59364E08363338D4D4542B4DD679204B7876B7E</code>。</p><p>并访问<code class="language-plaintext highlighter-rouge">http://localhost:8080/upload/file</code>，通过了过滤器，但流也被消耗了，因此返回的上传内容为空。要让servlet正常得到数据，可以使用代理模式，重构一个流：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">ReReadableHttpServletRequest</span> <span class="kd">extends</span> <span class="nc">HttpServletRequestWrapper</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">open</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ReReadableHttpServletRequest</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 返回InputStream:</span>
    <span class="kd">public</span> <span class="nc">ServletInputStream</span> <span class="nf">getInputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">open</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Cannot re-open input stream!"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">open</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ServletInputStream</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFinished</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">body</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isReady</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setReadListener</span><span class="o">(</span><span class="nc">ReadListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">body</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">body</span><span class="o">[</span><span class="n">offset</span><span class="o">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="o">;</span><span class="c1">//转为无符号int</span>
                <span class="n">offset</span><span class="o">++;</span>
                <span class="k">return</span> <span class="n">n</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="c1">// 返回Reader:</span>
    <span class="kd">public</span> <span class="nc">BufferedReader</span> <span class="nf">getReader</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">open</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Cannot re-open reader!"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">open</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">body</span><span class="o">),</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>使用：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 验证成功后继续处理:</span>
<span class="nc">ReReadableHttpServletRequest</span> <span class="n">proxy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReReadableHttpServletRequest</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">output</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
<span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</code></pre></div></div><p>修改后，重新调用接口，就正常返回文件内容了。</p><p>编写<code class="language-plaintext highlighter-rouge">ReReadableHttpServletRequest</code>时，是从<code class="language-plaintext highlighter-rouge">HttpServletRequestWrapper</code>继承，而不是直接实现<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>接口。因为Servlet的每个新版本都会对接口增加一些新方法，从<code class="language-plaintext highlighter-rouge">HttpServletRequestWrapper</code>继承可以确保新方法被正确地覆写了，<code class="language-plaintext highlighter-rouge">HttpServletRequestWrapper</code>是由Servlet的jar包提供的，目的就是为了让我们方便地实现对<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>接口的代理。</p><p>对<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>接口进行代理的步骤：</p><ol><li>从<code class="language-plaintext highlighter-rouge">HttpServletRequestWrapper</code>继承一个<code class="language-plaintext highlighter-rouge">XxxHttpServletRequest</code>，需要传入原始的<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>实例；</li><li>覆写某些方法，使得新的<code class="language-plaintext highlighter-rouge">XxxHttpServletRequest</code>实例看上去“改变”了原始的<code class="language-plaintext highlighter-rouge">HttpServletRequest</code>实例；</li><li>在<code class="language-plaintext highlighter-rouge">doFilter()</code>中传入新的<code class="language-plaintext highlighter-rouge">XxxHttpServletRequest</code>实例。</li></ol><p>虽然整个Filter的代码比较复杂，但它的好处在于：这个Filter在整个处理链中实现了灵活的“可插拔”特性，即是否启用对Web应用程序的其他组件（Filter、Servlet）完全没有影响。</p><h3 id="跨域">跨域</h3><p>在html调用是这样的：</p><p>首先处理跨域，假设前端是<code class="language-plaintext highlighter-rouge">http://127.0.0.1:5500</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 设置CORS头信息</span>
<span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Origin"</span><span class="o">,</span> <span class="s">"http://127.0.0.1:5500"</span><span class="o">);</span>
<span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Methods"</span><span class="o">,</span> <span class="s">"GET, POST, PUT, DELETE, OPTIONS"</span><span class="o">);</span>
<span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Headers"</span><span class="o">,</span> <span class="s">"Content-Type, Signature-Method, Signature"</span><span class="o">);</span>

<span class="c1">// 处理预检请求</span>
<span class="k">if</span> <span class="o">(</span><span class="s">"OPTIONS"</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getMethod</span><span class="o">()))</span> <span class="o">{</span>
    <span class="n">resp</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_OK</span><span class="o">);</span>
    <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div><p>编写html：</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"zh"</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>上传文件<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/js-sha1/0.6.0/sha1.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>上传文件<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">"uploadForm"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">id=</span><span class="s">"fileInput"</span> <span class="na">name=</span><span class="s">"file"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">onclick=</span><span class="s">"uploadFile()"</span><span class="nt">&gt;</span>上传<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>

    <span class="nt">&lt;script&gt;</span>
        <span class="k">async</span> <span class="kd">function</span> <span class="nx">uploadFile</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">fileInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">fileInput</span><span class="dl">'</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">fileInput</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">请选择一个文件。</span><span class="dl">'</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kd">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>

            <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">fileContent</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
                <span class="kd">const</span> <span class="nx">sha1Hash</span> <span class="o">=</span> <span class="nx">sha1</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">);</span>

                <span class="kd">const</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
                <span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">'</span><span class="s1">file</span><span class="dl">'</span><span class="p">,</span> <span class="nx">file</span><span class="p">);</span>

                <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://localhost:8080/upload/file</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
                    <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
                    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/octet-stream</span><span class="dl">'</span><span class="p">,</span>
                        <span class="dl">'</span><span class="s1">Signature-Method</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">SHA-1</span><span class="dl">'</span><span class="p">,</span>
                        <span class="dl">'</span><span class="s1">Signature</span><span class="dl">'</span><span class="p">:</span> <span class="nx">sha1Hash</span>
                    <span class="p">},</span>
                    <span class="na">body</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">fileContent</span><span class="p">])</span>
                <span class="p">});</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">文件上传成功。</span><span class="dl">'</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">文件上传失败。</span><span class="dl">'</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">};</span>

            <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>实际上处理跨域用Filter比较好：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">javax.servlet.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.HttpServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CORSFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span> 
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">HttpServletRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
        <span class="nc">HttpServletResponse</span> <span class="n">resp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>

        <span class="c1">// 设置CORS头信息</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Origin"</span><span class="o">,</span> <span class="s">"http://127.0.0.1:5500"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Methods"</span><span class="o">,</span> <span class="s">"GET, POST, PUT, DELETE, OPTIONS"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Headers"</span><span class="o">,</span> <span class="s">"Content-Type, Signature-Method, Signature"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Credentials"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Max-Age"</span><span class="o">,</span> <span class="s">"3600"</span><span class="o">);</span>

        <span class="c1">// 处理预检请求</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">"OPTIONS"</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getMethod</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">resp</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">.</span><span class="na">SC_OK</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// 继续执行其他过滤器或目标资源</span>
        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 清理代码，如果有需要</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>如果有多个网址，可以通过逗号分隔：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Origin"</span><span class="o">,</span> <span class="s">"http://127.0.0.1:5500, http://example.com"</span><span class="o">);</span>
</code></pre></div></div><p>如果允许所有IP，可以直接设置一个<code class="language-plaintext highlighter-rouge">*</code>号，如果允许指定ip的所有端口，可以这样写：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"Access-Control-Allow-Origin"</span><span class="o">,</span> <span class="s">"http://127.0.0.1:*"</span><span class="o">);</span>
</code></pre></div></div><p>如果想允许来自 <code class="language-plaintext highlighter-rouge">http://127.0.0.*</code> 这样的多个 IP 的请求，需要单独设置每个 IP，不能使用通配符来表示。</p><p>注意过滤器顺序：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>CORSFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>com.example.CORSFilter<span class="nt">&lt;/filter-class&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
<span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>CORSFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>
<span class="nt">&lt;/filter-mapping&gt;</span>
</code></pre></div></div><p>而对于SpringBoot，可以使用<code class="language-plaintext highlighter-rouge">@CrossOrigin(origins = "http://127.0.0.1:5500")</code>注解到方法上。或使用全局CORS配置：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.config.annotation.CorsRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.servlet.config.annotation.WebMvcConfigurer</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">WebMvcConfigurer</span> <span class="nf">corsConfigurer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">WebMvcConfigurer</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCorsMappings</span><span class="o">(</span><span class="nc">CorsRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">registry</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="s">"/**"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">allowedOrigins</span><span class="o">(</span><span class="s">"http://127.0.0.1:5500"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">allowedMethods</span><span class="o">(</span><span class="s">"GET"</span><span class="o">,</span> <span class="s">"POST"</span><span class="o">,</span> <span class="s">"PUT"</span><span class="o">,</span> <span class="s">"DELETE"</span><span class="o">,</span> <span class="s">"OPTIONS"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">allowedHeaders</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div><p>当然如果HTML 文件是通过本地文件系统打开的（例如使用 <code class="language-plaintext highlighter-rouge">file://</code> 协议），而不是通过 Web 服务器（例如 <code class="language-plaintext highlighter-rouge">http://</code> 或 <code class="language-plaintext highlighter-rouge">https://</code>）访问的，那么跨域请求的限制则不适用。本地文件可以自由加载其他本地文件，不受跨域请求的限制。</p><p>因此，如果HTML 文件是通过本地文件系统打开的，而不是通过 Web 服务器访问的，无需设置任何 CORS 相关的头，可以直接进行跨域请求。</p><h3 id="修改响应">修改响应</h3><p>假设编写了一个Servlet，但由于业务逻辑比较复杂，处理该请求需要耗费很长的时间：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="n">urlPatterns</span> <span class="o">=</span> <span class="s">"/slow/hello"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/html"</span><span class="o">);</span>
        <span class="c1">// 模拟耗时1秒:</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">PrintWriter</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"&lt;h1&gt;Hello, world!&lt;/h1&gt;"</span><span class="o">);</span>
        <span class="n">pw</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>而且每次返回的响应内容是固定的，因此，如果能使用缓存将结果缓存起来，就可以大大提高Web应用程序的运行效率。</p><p>缓存逻辑最好不要在Servlet内部实现，为了能复用缓存逻辑，编写一个<code class="language-plaintext highlighter-rouge">CacheFilter</code>最合适：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>
    <span class="c1">// Path到byte[]的缓存:</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">HttpServletRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
        <span class="nc">HttpServletResponse</span> <span class="n">resp</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpServletResponse</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
        <span class="c1">// 获取Path:</span>
        <span class="nc">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>
        <span class="c1">// 获取缓存内容:</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">);</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">"X-Cache-Hit"</span><span class="o">,</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">"No"</span> <span class="o">:</span> <span class="s">"Yes"</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 缓存未找到,构造一个伪造的Response:</span>
            <span class="nc">CachedHttpServletResponse</span> <span class="n">wrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CachedHttpServletResponse</span><span class="o">(</span><span class="n">resp</span><span class="o">);</span>
            <span class="c1">// 让下游组件写入数据到伪造的Response:</span>
            <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">wrapper</span><span class="o">);</span><span class="cm">/*注意这里调用完链后会返回继续执行后面的代码*/</span>
            <span class="c1">// 从伪造的Response中读取写入的内容并放入缓存:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 写入到原始的Response:</span>
        <span class="nc">ServletOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="n">output</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="n">output</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>如果缓存存在，直接写入response，并没有调用<code class="language-plaintext highlighter-rouge">chain.doFilter()</code>，所以后续所有filter和servlet都不会被调用。</p><p>如果缓存不存在，先调用<code class="language-plaintext highlighter-rouge">chain.doFilter()</code>，后续所有filter和servlet在此调用内，返回后拿到结果，再写入真正的response。</p><p>filter顺序很重要，<code class="language-plaintext highlighter-rouge">cache-filter</code>应该放在chain的最后一个，即 filter1 -&gt; filter2 -&gt; … -&gt; cacheFilter -&gt; servlet。</p><p>实现缓存的关键在于，调用<code class="language-plaintext highlighter-rouge">doFilter()</code>时，不能传入原始的<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>，因为这样就会写入Socket，也就无法获取下游组件写入的内容。如果传入的是“伪造”的<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>，让下游组件写入到预设的<code class="language-plaintext highlighter-rouge">ByteArrayOutputStream</code>，就“截获”了下游组件写入的内容，于是，就可以把内容缓存起来，再通过原始的<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>实例写入到网络。</p><p>这个<code class="language-plaintext highlighter-rouge">CachedHttpServletResponse</code>实现如下：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">CachedHttpServletResponse</span> <span class="kd">extends</span> <span class="nc">HttpServletResponseWrapper</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">open</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ByteArrayOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>

    <span class="kd">public</span> <span class="nf">CachedHttpServletResponse</span><span class="o">(</span><span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 获取Writer:</span>
    <span class="kd">public</span> <span class="nc">PrintWriter</span> <span class="nf">getWriter</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">open</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"无法重新打开写入器!"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">open</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">PrintWriter</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 获取OutputStream:</span>
    <span class="kd">public</span> <span class="nc">ServletOutputStream</span> <span class="nf">getOutputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">open</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"无法重新打开输出流！"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">open</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ServletOutputStream</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isReady</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setWriteListener</span><span class="o">(</span><span class="nc">WriteListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>

            <span class="c1">// 实际写入ByteArrayOutputStream:</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
                <span class="n">output</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="c1">// 返回写入的byte[]:</span>
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>如果想要修改响应，就可以通过<code class="language-plaintext highlighter-rouge">HttpServletResponseWrapper</code>构造一个“伪造”的<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>，这样就能拦截到写入的数据。修改响应时，不要忘记把数据写入原始的<code class="language-plaintext highlighter-rouge">HttpServletResponse</code>实例。这个<code class="language-plaintext highlighter-rouge">CacheFilter</code>同样是一个“可插拔”组件，它是否启用不影响Web应用程序的其他组件（Filter、Servlet）。</p><p>如果下游组件要写入的内容变更了，但缓存中保留的仍是旧数据，这通常是一个缓存一致性的问题。比如设置一个缓存有效期，超过有效期则更新缓存，或定时定期刷新缓存中的数据。</p><h2 id="listener">Listener</h2><p>除了Servlet和Filter外，JavaEE的Servlet规范还提供了第三种组件：Listener。</p><p>Listener顾名思义就是监听器，有好几种Listener，其中最常用的是<code class="language-plaintext highlighter-rouge">ServletContextListener</code>，编写一个实现了<code class="language-plaintext highlighter-rouge">ServletContextListener</code>接口的类如下：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebListener</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppListener</span> <span class="kd">implements</span> <span class="nc">ServletContextListener</span> <span class="o">{</span>
    <span class="c1">// 在此初始化WebApp,例如打开数据库连接池等:</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="nc">ServletContextEvent</span> <span class="n">sce</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"WebApp initialized."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 在此清理WebApp,例如关闭数据库连接池等:</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextDestroyed</span><span class="o">(</span><span class="nc">ServletContextEvent</span> <span class="n">sce</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"WebApp destroyed."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>任何标注为<code class="language-plaintext highlighter-rouge">@WebListener</code>，且实现了特定接口的类会被Web服务器自动初始化。上述<code class="language-plaintext highlighter-rouge">AppListener</code>实现了<code class="language-plaintext highlighter-rouge">ServletContextListener</code>接口，它会在整个Web应用程序初始化完成后，以及Web应用程序关闭后获得回调通知。我们可以把初始化数据库连接池等工作放到<code class="language-plaintext highlighter-rouge">contextInitialized()</code>回调方法中，把清理资源的工作放到<code class="language-plaintext highlighter-rouge">contextDestroyed()</code>回调方法中，因为Web服务器保证在<code class="language-plaintext highlighter-rouge">contextInitialized()</code>执行后，才会接受用户的HTTP请求。</p><p>很多第三方Web框架都会通过一个<code class="language-plaintext highlighter-rouge">ServletContextListener</code>接口初始化自己。</p><p>除了<code class="language-plaintext highlighter-rouge">ServletContextListener</code>外，还有几种Listener：</p><ul><li><code class="language-plaintext highlighter-rouge">HttpSessionListener</code>：监听HttpSession的创建和销毁事件；</li><li><code class="language-plaintext highlighter-rouge">ServletRequestListener</code>：监听ServletRequest请求的创建和销毁事件；</li><li><code class="language-plaintext highlighter-rouge">ServletRequestAttributeListener</code>：监听ServletRequest请求的属性变化事件（即调用<code class="language-plaintext highlighter-rouge">ServletRequest.setAttribute()</code>方法）；</li><li><code class="language-plaintext highlighter-rouge">ServletContextAttributeListener</code>：监听ServletContext的属性变化事件（即调用<code class="language-plaintext highlighter-rouge">ServletContext.setAttribute()</code>方法）；</li></ul><p>一个Web服务器可以运行一个或多个WebApp，对于每个WebApp，Web服务器都会为其创建一个全局唯一的<code class="language-plaintext highlighter-rouge">ServletContext</code>实例，在<code class="language-plaintext highlighter-rouge">AppListener</code>里面编写的两个回调方法实际上对应的就是<code class="language-plaintext highlighter-rouge">ServletContext</code>实例的创建和销毁。</p><p><code class="language-plaintext highlighter-rouge">ServletRequest</code>、<code class="language-plaintext highlighter-rouge">HttpSession</code>等很多对象也提供<code class="language-plaintext highlighter-rouge">getServletContext()</code>方法获取到同一个<code class="language-plaintext highlighter-rouge">ServletContext</code>实例。<code class="language-plaintext highlighter-rouge">ServletContext</code>实例最大的作用就是<strong>设置和共享全局信息</strong>。</p><p>此外，<code class="language-plaintext highlighter-rouge">ServletContext</code>还提供了动态添加Servlet、Filter、Listener等功能，它允许应用程序在运行期间动态添加一个组件，虽然这个功能不是很常用。</p><hr /><p>类似Tomcat这样的Web服务器，运行的Web应用程序通常都是业务系统，因此，这类服务器也被称为应用服务器。应用服务器并不擅长处理静态文件，也不适合直接暴露给用户。通常，我们在生产环境部署时，总是使用类似Nginx这样的服务器充当反向代理和静态服务器，只有动态请求才会放行给应用服务器，所以，部署架构如下：</p><pre><code class="language-ascii">             ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐

             │  /static/*            │
┌───────┐      ┌──────────&gt; file
│Browser├────┼─┤                     │    ┌ ─ ─ ─ ─ ─ ─ ┐
└───────┘      │/          proxy_pass
             │ └─────────────────────┼───&gt;│  Web Server │
                       Nginx
             └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘    └ ─ ─ ─ ─ ─ ─ ┘
</code></pre><p>实现上述功能的Nginx配置文件如下：</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    server {
    listen 80;

    server_name localhost;

    # 静态文件根目录:
    root D:/ideaIU-2023.3.2/IdeaProjects/Maven/src/main/webapp;

    access_log D:/ideaIU-2023.3.2/IdeaProjects/Maven/logs/webapp_access_log;
    error_log  D:/ideaIU-2023.3.2/IdeaProjects/Maven/logs/webapp_error_log;

    # 处理静态文件请求:
    location /static {
    }

    # 处理静态文件请求:
    location /favicon.ico {
    }

    # 不允许请求/WEB-INF:
    location /WEB-INF {
        return 404;
    }

    # 其他请求转发给Tomcat:
    location / {
        proxy_pass       http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre></div></div><p>使用Nginx配合Tomcat服务器，可以充分发挥Nginx作为网关的优势，既可以高效处理静态文件，也可以把https、防火墙、限速、反爬虫等功能放到Nginx中，使得自己的WebApp能专注于业务逻辑。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="" target="_blank">acteds</a></li><li>本文链接：<a href="/2021/09/14/JavaWeb/" target="_blank">https://acteds.github.io/2021/09/14/JavaWeb/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://beaudar.lipk.org/client.js" repo="mzlogin/blog-comments" issue-term="title" label="gitment" theme="github-light" comment-order="desc" input-position="top" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: '/assets/search_data.json?v=1722590727', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="acteds">acteds</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/acteds/acteds.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="/" title="首页" target="">首页</a></li><li> <a href="/categories/" title="分类" target="">分类</a></li><li> <a href="/wiki/" title="维基" target="">维基</a></li><li> <a href="/about/" title="关于" target="">关于</a></li><li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
