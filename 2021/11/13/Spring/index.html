<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Spring &mdash; 个人博客</title><link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="/assets/css/components/collection.css"><link rel="stylesheet" href="/assets/css/components/repo-card.css"><link rel="stylesheet" href="/assets/css/sections/repo-list.css"><link rel="stylesheet" href="/assets/css/components/boxed-group.css"><link rel="stylesheet" href="/assets/css/globals/common.css"><link rel="stylesheet" href="/assets/css/globals/responsive.css"><link rel="stylesheet" href="/assets/css/posts/index.css"><link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/highlight/monokai.sublime.css"><link rel="canonical" href="/2021/11/13/Spring/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="/feed.xml"><link rel="shortcut icon" href="/favicon.ico"><meta property="og:title" content="Spring"><meta name="keywords" content="Java"><meta name="og:keywords" content="Java"><meta name="description" content="引言"><meta name="og:description" content="引言"><meta property="og:url" content="/2021/11/13/Spring/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-11-13"> <script src="/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="/assets/js/jquery-ui.js"></script> <script src="/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Spring"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Spring</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/11/13 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#Java" title="Java">Java</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 29239 字，约 84 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="引言">引言</h1><p>Spring框架笔记。</p><h1 id="spring">Spring</h1><p>Spring是一个支持快速开发Java EE应用程序的框架。它提供了一系列底层容器和基础设施，并可以和大量常用的开源框架无缝集成，可以说是开发Java EE应用程序的必备。</p><p>Spring Framework主要包括几个模块：</p><ul><li>支持IoC和AOP的容器；</li><li>支持JDBC和ORM的数据访问模块；</li><li>支持声明式事务的模块；</li><li>支持基于Servlet的MVC开发；</li><li>支持基于Reactive的Web开发；</li><li>以及集成JMS、JavaMail、JMX、缓存等其他模块。</li></ul><h2 id="ioc">IoC</h2><p>容器是一种为某种特定组件的运行提供必要支持的一个软件环境。例如，Tomcat就是一个Servlet容器，它可以为Servlet的运行提供运行环境。类似Docker这样的软件也是一个容器，它提供了必要的Linux环境以便运行一个特定的Linux进程。</p><p>通常来说，使用容器运行组件，除了提供一个组件运行环境之外，容器还提供了许多底层服务。例如，Servlet容器底层实现了TCP连接，解析HTTP协议等非常复杂的服务，如果没有容器来提供这些服务，我们就无法编写像Servlet这样代码简单，功能强大的组件。早期的JavaEE服务器提供的EJB容器最重要的功能就是通过声明式事务服务，使得EJB组件的开发人员不必自己编写冗长的事务处理代码，所以极大地简化了事务处理。</p><p>Spring的核心就是提供了一个IoC容器，它可以管理所有轻量级的JavaBean组件，提供的底层服务包括组件的生命周期管理、配置和组装服务、AOP支持，以及建立在AOP基础上的声明式事务服务等。</p><p>IoC全称Inversion of Control，直译为控制反转。</p><p>假定一个在线书店，通过<code class="language-plaintext highlighter-rouge">BookService</code>获取书籍：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">HikariConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariConfig</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nc">Book</span> <span class="nf">getBook</span><span class="o">(</span><span class="kt">long</span> <span class="n">bookId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="k">return</span> <span class="n">book</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>为了从数据库查询书籍，<code class="language-plaintext highlighter-rouge">BookService</code>持有一个<code class="language-plaintext highlighter-rouge">DataSource</code>。为了实例化一个<code class="language-plaintext highlighter-rouge">HikariDataSource</code>，又不得不实例化一个<code class="language-plaintext highlighter-rouge">HikariConfig</code>。</p><p>现在，继续编写<code class="language-plaintext highlighter-rouge">UserService</code>获取用户：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">HikariConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariConfig</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>因为<code class="language-plaintext highlighter-rouge">UserService</code>也需要访问数据库，因此，不得不也实例化一个<code class="language-plaintext highlighter-rouge">HikariDataSource</code>。</p><p>上述每个组件都采用了一种简单的通过<code class="language-plaintext highlighter-rouge">new</code>创建实例并持有的方式。会有以下缺点：</p><ol><li>实例化一个组件其实很难，例如，<code class="language-plaintext highlighter-rouge">BookService</code>和<code class="language-plaintext highlighter-rouge">UserService</code>要创建<code class="language-plaintext highlighter-rouge">HikariDataSource</code>，实际上需要读取配置，才能先实例化<code class="language-plaintext highlighter-rouge">HikariConfig</code>，再实例化<code class="language-plaintext highlighter-rouge">HikariDataSource</code>。</li><li>没有必要让<code class="language-plaintext highlighter-rouge">BookService</code>和<code class="language-plaintext highlighter-rouge">UserService</code>分别创建<code class="language-plaintext highlighter-rouge">DataSource</code>实例，完全可以共享同一个<code class="language-plaintext highlighter-rouge">DataSource</code>，但谁负责创建<code class="language-plaintext highlighter-rouge">DataSource</code>，谁负责获取其他组件已经创建的<code class="language-plaintext highlighter-rouge">DataSource</code>，不好处理。</li><li>很多组件需要销毁以便释放资源，例如<code class="language-plaintext highlighter-rouge">DataSource</code>，但如果该组件被多个组件共享，如何确保它的使用方都已经全部被销毁？</li><li>测试某个组件，例如<code class="language-plaintext highlighter-rouge">BookService</code>，是复杂的，因为必须要在真实的数据库环境下执行。</li></ol><p>如果一个系统有大量的组件，其生命周期和相互之间的依赖关系如果由组件自身来维护，不但大大增加了系统的复杂度，而且会导致组件之间极为紧密的耦合，继而给测试和维护带来了极大的困难。</p><p>因此，核心问题是：谁负责创建组件？谁负责根据依赖关系组装组件？销毁时，如何按依赖顺序正确销毁？解决这一问题的核心方案就是IoC。</p><p>传统的应用程序中，控制权在程序本身，程序的控制流程完全由开发者控制，例如：</p><p><code class="language-plaintext highlighter-rouge">CartServlet</code>创建了<code class="language-plaintext highlighter-rouge">BookService</code>，在创建<code class="language-plaintext highlighter-rouge">BookService</code>的过程中，又创建了<code class="language-plaintext highlighter-rouge">DataSource</code>组件。这种模式的缺点是，一个组件如果要使用另一个组件，必须先知道如何正确地创建它。</p><p>在IoC模式下，控制权发生了反转，即从应用程序转移到了IoC容器，所有组件不再由应用程序自己创建和配置，而是由IoC容器负责，这样，应用程序只需要直接使用已经创建好并且配置好的组件。为了能让组件在IoC容器中被“装配”出来，需要某种“注入”机制，例如，<code class="language-plaintext highlighter-rouge">BookService</code>自己并不会创建<code class="language-plaintext highlighter-rouge">DataSource</code>，而是等待外部通过<code class="language-plaintext highlighter-rouge">setDataSource()</code>方法来注入一个<code class="language-plaintext highlighter-rouge">DataSource</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDataSource</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>不直接<code class="language-plaintext highlighter-rouge">new</code>一个<code class="language-plaintext highlighter-rouge">DataSource</code>，而是注入一个<code class="language-plaintext highlighter-rouge">DataSource</code>，这个小小的改动虽然简单，却带来了一系列好处：</p><ol><li><code class="language-plaintext highlighter-rouge">BookService</code>不再关心如何创建<code class="language-plaintext highlighter-rouge">DataSource</code>，因此，不必编写读取数据库配置之类的代码；</li><li><code class="language-plaintext highlighter-rouge">DataSource</code>实例被注入到<code class="language-plaintext highlighter-rouge">BookService</code>，同样也可以注入到<code class="language-plaintext highlighter-rouge">UserService</code>，因此，共享一个组件非常简单；</li><li>测试<code class="language-plaintext highlighter-rouge">BookService</code>更容易，因为注入的是<code class="language-plaintext highlighter-rouge">DataSource</code>，可以使用内存数据库，而不是真实的MySQL配置。</li></ol><p>IoC又称为依赖注入（DI：Dependency Injection），它解决了一个最主要的问题：将组件的创建+配置与组件的使用相分离，并且，由IoC容器负责管理组件的生命周期。</p><p>因为IoC容器要负责实例化所有的组件，因此，有必要告诉容器如何创建组件，以及各组件的依赖关系。一种最简单的配置是通过XML文件来实现，例如：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;beans&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"HikariDataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"bookService"</span> <span class="na">class=</span><span class="s">"BookService"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"userService"</span> <span class="na">class=</span><span class="s">"UserService"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>上述XML配置文件指示IoC容器创建3个JavaBean组件，并把id为<code class="language-plaintext highlighter-rouge">dataSource</code>的组件通过属性<code class="language-plaintext highlighter-rouge">dataSource</code>（即调用<code class="language-plaintext highlighter-rouge">setDataSource()</code>方法）注入到另外两个组件中。</p><p>依赖注入可以通过<code class="language-plaintext highlighter-rouge">set()</code>方法实现，也可以通过构造方法实现。</p><p>把<code class="language-plaintext highlighter-rouge">BookService</code>改造为通过构造方法注入，那么实现代码如下：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BookService</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Spring的IoC容器同时支持属性注入和构造方法注入，并允许混合使用。</p><p>在设计上，Spring的IoC容器是一个高度可扩展的无侵入容器。所谓无侵入，是指应用程序的组件无需实现Spring的特定接口，或者说，组件根本不知道自己在Spring的容器中运行。这种无侵入的设计有以下好处：</p><ol><li>应用程序组件既可以在Spring的IoC容器中运行，也可以自己编写代码自行组装配置；</li><li>测试的时候并不依赖Spring容器，可单独进行测试，大大提高了开发效率。</li></ol><h3 id="ioc装配">IoC装配</h3><p>首先引入依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>测试代码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>

    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">A</span><span class="o">(</span><span class="no">B</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>编写一个特定的<code class="language-plaintext highlighter-rouge">application.xml</code>配置文件，告诉Spring的IoC容器应该如何创建并组装Bean：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><hr /><h3 id="bean的配置">Bean的配置</h3><p>在 Spring中，XML配置文件的根元素是<code class="language-plaintext highlighter-rouge">&lt; beans&gt;</code>，其下包含了<code class="language-plaintext highlighter-rouge">&lt;bean&gt;</code>子元素，每个<code class="language-plaintext highlighter-rouge">&lt;bean&gt;</code>子元素定义了一个Bean，并描述了该Bean如何被装配到Spring容器中。</p><p><code class="language-plaintext highlighter-rouge">&lt;bean&gt;</code>元素中包含了多个<em>属性</em>。其常用属性如下：</p><table><thead><tr><th><strong>属性</strong></th><th><strong>解释</strong></th></tr></thead><tbody><tr><td>id</td><td>实例化对象名称</td></tr><tr><td>name</td><td>可以为bean指定多个名称，用逗号分隔</td></tr><tr><td>class</td><td>类文件的全局名称</td></tr><tr><td>scope</td><td>实例的生存空间或有效范围</td></tr></tbody></table><p><code class="language-plaintext highlighter-rouge">&lt;bean&gt;</code>元素中同样包含了多个<em>子</em>元素，其子元素如下</p><p><code class="language-plaintext highlighter-rouge">constructor-arg</code>、<code class="language-plaintext highlighter-rouge">property</code>、<code class="language-plaintext highlighter-rouge">ref</code>、<code class="language-plaintext highlighter-rouge">value</code>、<code class="language-plaintext highlighter-rouge">list</code>、<code class="language-plaintext highlighter-rouge">set</code>、<code class="language-plaintext highlighter-rouge">map</code>、<code class="language-plaintext highlighter-rouge">entry</code></p><h3 id="注入方式">注入方式</h3><p>对于构造方法注入，通过设置<code class="language-plaintext highlighter-rouge">constructor-arg</code>标签完成：</p><p><code class="language-plaintext highlighter-rouge">constructor-arg</code>参数:<code class="language-plaintext highlighter-rouge">type</code> 形参类型，<code class="language-plaintext highlighter-rouge">name</code> 形参变量名，<code class="language-plaintext highlighter-rouge">value</code> 属性值，<code class="language-plaintext highlighter-rouge">ref</code> 引用实例对象，<code class="language-plaintext highlighter-rouge">index</code> 索引值。</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><ul><li>每个<code class="language-plaintext highlighter-rouge">&lt;bean ...&gt;</code>都有一个<code class="language-plaintext highlighter-rouge">id</code>标识，相当于Bean的唯一ID；</li><li>在<code class="language-plaintext highlighter-rouge">a</code>Bean中，通过<code class="language-plaintext highlighter-rouge">&lt;constructor-arg index="0" ref="b"/&gt;</code>以<strong>构造方法注入</strong>了另一个<code class="language-plaintext highlighter-rouge">b</code>Bean；</li><li>Bean的顺序不重要，Spring根据依赖关系会自动正确初始化。</li></ul><p>把上述XML配置文件用Java代码写出来，就像这样：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">B</span> <span class="n">b</span><span class="o">=</span><span class="k">new</span> <span class="no">B</span><span class="o">();</span>
<span class="no">A</span> <span class="n">a</span><span class="o">=</span><span class="k">new</span> <span class="no">A</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</code></pre></div></div><p>只不过Spring容器是通过读取XML文件后使用反射完成的。</p><p>其实这里不写<code class="language-plaintext highlighter-rouge">constructor-arg</code>，也可以，在 Spring XML 配置文件中，如果类 <code class="language-plaintext highlighter-rouge">A</code> 只有<strong>一个构造函数</strong>，并且这个构造函数需要一个 <code class="language-plaintext highlighter-rouge">B</code> 类型的参数，Spring 会自动匹配并注入所需的依赖。因此，如果只有一个构造函数并且只有一个参数类型可以匹配，则<strong>可以省略</strong> <code class="language-plaintext highlighter-rouge">&lt;constructor-arg&gt;</code> 标签。</p><p>还可以使用c命名空间简化注入,对应<code class="language-plaintext highlighter-rouge">constructor-arg</code>。</p><p><code class="language-plaintext highlighter-rouge">beans</code>标签添加属性: <code class="language-plaintext highlighter-rouge">xmlns:c="http://www.springframework.org/schema/c"</code>。</p><p>使用c命名空间，直接在bean添加参数：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">"a1"</span> <span class="kd">class</span><span class="err">="</span><span class="nc">com</span><span class="o">.</span><span class="na">aotmd</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">A</span><span class="s">" c:_0-ref="</span><span class="n">b</span><span class="s">"/&gt;
&lt;bean id="</span><span class="n">a2</span><span class="s">" class="</span><span class="n">com</span><span class="o">.</span><span class="na">aotmd</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">A</span><span class="s">" c:b-ref="</span><span class="n">b</span><span class="err">"</span><span class="o">/&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">c:_索引值</code> 对应 <code class="language-plaintext highlighter-rouge">index="索引值"</code>， 加<code class="language-plaintext highlighter-rouge">-ref</code>表示引用实例对象</p><p><code class="language-plaintext highlighter-rouge">c:形参变量名</code> 对应 <code class="language-plaintext highlighter-rouge">name="形参变量名"</code>,加<code class="language-plaintext highlighter-rouge">-ref</code>表示引用实例对象，不加则是设置普通数据类型，上面的式子如果不加，则<code class="language-plaintext highlighter-rouge">"b"</code>视为字符串。</p><p>需要注意的是<code class="language-plaintext highlighter-rouge">c:b-ref</code>这种方式只对以debug方式编译的class有效，因为对于非debug方式编译的class文件Spring将无法获取到对应构造方法的<code class="language-plaintext highlighter-rouge">参数名</code>，因为被优化掉了。之前在JavaWeb有说，可以设置编译器参数：<code class="language-plaintext highlighter-rouge">-parameters</code>，保留形参变量名。</p><hr /><p>对于set方法注入，通过设置<code class="language-plaintext highlighter-rouge">property</code>标签完成：</p><p>如果要改成<strong>通过<code class="language-plaintext highlighter-rouge">set</code>方法注入</strong>，则xml修改为：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"b"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">property</code>参数： <code class="language-plaintext highlighter-rouge">name</code> 变量名，<code class="language-plaintext highlighter-rouge">value</code> 属性值，<code class="language-plaintext highlighter-rouge">ref</code> 引用实例对象。</p><p>同样的，可以使用p命名空间简化注入,对应<code class="language-plaintext highlighter-rouge">property</code>。</p><p><code class="language-plaintext highlighter-rouge">beans</code>标签添加属性: <code class="language-plaintext highlighter-rouge">xmlns:p="http://www.springframework.org/schema/p"</code>。</p><p>使用p命名空间，直接在bean添加参数：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="na">p:b-ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">p:变量名</code> 对应 <code class="language-plaintext highlighter-rouge">name="变量名"</code>，加<code class="language-plaintext highlighter-rouge">-ref</code>表示引用实例对象。</p><p>注意：<code class="language-plaintext highlighter-rouge">property</code>对应的是set方法，而<strong>不是</strong>对应的属性。如<code class="language-plaintext highlighter-rouge">name="world"</code>实际对应<code class="language-plaintext highlighter-rouge">setWorld()</code>方法，这个时候<strong>不管</strong>是否真的存在名为<code class="language-plaintext highlighter-rouge">world</code>的属性.</p><hr /><h3 id="注入的类型">注入的类型</h3><p>如果注入的不是Bean，而是<code class="language-plaintext highlighter-rouge">boolean</code>、<code class="language-plaintext highlighter-rouge">int</code>、<code class="language-plaintext highlighter-rouge">String</code>这样的数据类型，则通过设置<code class="language-plaintext highlighter-rouge">value</code>注入（构造方法注入同理），例如，创建一个<code class="language-plaintext highlighter-rouge">HikariDataSource</code>：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.zaxxer.hikari.HikariDataSource"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jdbcUrl"</span> <span class="na">value=</span><span class="s">"jdbc:mysql://localhost:3306/test"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"root"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maximumPoolSize"</span> <span class="na">value=</span><span class="s">"10"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"autoCommit"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>如果是Map类型，则通过嵌套<code class="language-plaintext highlighter-rouge">map</code>标签进行设置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"map"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"1"</span> <span class="na">value=</span><span class="s">"唱"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"2"</span> <span class="na">value=</span><span class="s">"跳"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"3"</span> <span class="na">value=</span><span class="s">"RAP"</span> <span class="na">value-type=</span><span class="s">"java.lang.String"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>如果是List类型，则通过嵌套<code class="language-plaintext highlighter-rouge">list</code>标签进行设置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">"b"</span> <span class="na">index=</span><span class="s">"0"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"list"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;&lt;value&gt;</span>唱<span class="nt">&lt;/value&gt;&lt;value&gt;</span>跳<span class="nt">&lt;/value&gt;&lt;value&gt;</span>RAR<span class="nt">&lt;/value&gt;&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>如果是Set类型，则通过嵌套<code class="language-plaintext highlighter-rouge">set</code>标签进行设置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"set"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;set&gt;&lt;value</span> <span class="nt">&gt;</span>唱<span class="nt">&lt;/value&gt;&lt;value&gt;</span>跳<span class="nt">&lt;/value&gt;&lt;value&gt;</span>RAR<span class="nt">&lt;/value&gt;&lt;/set&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>前面有说name属性对应的是set方法，这里是<code class="language-plaintext highlighter-rouge">"set"</code>,所以对应<code class="language-plaintext highlighter-rouge">setList</code>方法，也可以改成其他的名字。</p><p>如果是数组，则通过嵌套<code class="language-plaintext highlighter-rouge">array</code>标签进行设置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"list"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;&lt;value&gt;</span>唱<span class="nt">&lt;/value&gt;&lt;value&gt;</span>跳<span class="nt">&lt;/value&gt;&lt;value&gt;</span>RAR<span class="nt">&lt;/value&gt;&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>实例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">call</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">A</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">call</span> <span class="o">=</span> <span class="o">(</span><span class="no">B</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"key1"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setArray</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">map</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">call</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>application.xml：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"1"</span> <span class="na">value=</span><span class="s">"唱"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"2"</span> <span class="na">value=</span><span class="s">"跳"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"3"</span> <span class="na">value=</span><span class="s">"RAP"</span> <span class="na">value-type=</span><span class="s">"java.lang.String"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"4"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">value-type=</span><span class="s">"java.lang.Integer"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"key1"</span> <span class="na">value-ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"array"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;array&gt;&lt;value&gt;</span>唱<span class="nt">&lt;/value&gt;&lt;value&gt;</span>跳<span class="nt">&lt;/value&gt;&lt;value&gt;</span>RAR<span class="nt">&lt;/value&gt;&lt;/array&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>控制台：</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{1=唱, 2=跳, 3=RAP, 4=1, key1=com.aotmd.test.B@53de625d}
[唱, 跳, RAR]
hello
</code></pre></div></div><h3 id="applicationcontext">ApplicationContext</h3><p>Spring容器就是<code class="language-plaintext highlighter-rouge">ApplicationContext</code>，它是一个接口，有很多实现类，这里选择<code class="language-plaintext highlighter-rouge">ClassPathXmlApplicationContext</code>，表示它会自动从classpath中查找指定的XML配置文件。</p><p>获得了<code class="language-plaintext highlighter-rouge">ApplicationContext</code>的实例，就获得了IoC容器的引用。从<code class="language-plaintext highlighter-rouge">ApplicationContext</code>中可以根据Bean的ID获取Bean，也可以根据Bean的类型获取Bean的引用：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
<span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
</code></pre></div></div><p>Spring还提供另一种IoC容器叫<code class="language-plaintext highlighter-rouge">BeanFactory</code>，使用方式和<code class="language-plaintext highlighter-rouge">ApplicationContext</code>类似：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">));</span>
<span class="no">A</span> <span class="n">a</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">BeanFactory</code>和<code class="language-plaintext highlighter-rouge">ApplicationContext</code>的区别在于，<code class="language-plaintext highlighter-rouge">BeanFactory</code>的实现是<strong>按需创建</strong>，即第一次获取Bean时才创建这个Bean，而<code class="language-plaintext highlighter-rouge">ApplicationContext</code>会一次性创建所有的Bean。实际上，<code class="language-plaintext highlighter-rouge">ApplicationContext</code>接口是从<code class="language-plaintext highlighter-rouge">BeanFactory</code>接口继承而来的，并且，<code class="language-plaintext highlighter-rouge">ApplicationContext</code>提供了一些额外的功能，包括国际化支持、事件和通知机制等。通常情况下，总是使用<code class="language-plaintext highlighter-rouge">ApplicationContext</code>，很少会考虑使用<code class="language-plaintext highlighter-rouge">BeanFactory</code>。</p><hr /><p>创建 <code class="language-plaintext highlighter-rouge">ApplicationContext</code>接口实例通常有三种方法：</p><p><strong>通过<code class="language-plaintext highlighter-rouge">ClassPathXmlApplicationContext</code>创建</strong> <code class="language-plaintext highlighter-rouge">ClassPathXmlApplicationContext</code>将从类路径classPath目录寻找指定的XML配置文件：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
</code></pre></div></div><p><strong>通过<code class="language-plaintext highlighter-rouge">FileSystemXmlApplicationContext</code>创建</strong></p><p><code class="language-plaintext highlighter-rouge">FileSystemXmlApplicationContext</code>将从指定文件的<strong>绝对路径</strong>中寻找XML配置文件，找到并装载完成<code class="language-plaintext highlighter-rouge">ApplicationContext</code>的实例化工作。采用绝对路径的加载方式将导致程序的灵活性变差， 一般<strong>不推荐使用</strong>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileSystemXmlApplicationContext</span><span class="o">(</span><span class="s">"C:\\XXX\\application.xml"</span><span class="o">);</span>
</code></pre></div></div><p><strong>通过Web服务器实例化<code class="language-plaintext highlighter-rouge">ApplicationContext</code>容器</strong></p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>classpath:application.xml<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</code></pre></div></div><p>如果有多个Spring配置文件，则在<code class="language-plaintext highlighter-rouge">param-value</code>里，以逗号分隔，如果没有定义则默认加载<code class="language-plaintext highlighter-rouge">/WEB-INF/applicationContext.xml</code>文件，<code class="language-plaintext highlighter-rouge">contextConfigLocation</code>是参数值，固定不变。</p><p>Web服务器实例化<code class="language-plaintext highlighter-rouge">ApplicationContext</code>容器时，一般使用基于<code class="language-plaintext highlighter-rouge">org.springframework.web.context.ContextLoaderListener</code>的实现方法只需要在<code class="language-plaintext highlighter-rouge">web.xml</code>中添加代码:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>classpath:application.xml<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
<span class="nt">&lt;listener&gt;</span>
    <span class="nt">&lt;listener-class&gt;</span>
        org.springframework.web.context.ContextLoaderListener
    <span class="nt">&lt;/listener-class&gt;</span>
<span class="nt">&lt;/listener&gt;</span>
</code></pre></div></div><p>需要web依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-web<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>使用，首先<strong>获取<code class="language-plaintext highlighter-rouge">ServletContext</code></strong>，这里列出几种方法：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServletContext</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
<span class="n">sc</span><span class="o">=((</span><span class="nc">HttpServletRequest</span><span class="o">)</span><span class="n">request</span><span class="o">).</span><span class="na">getSession</span><span class="o">().</span><span class="na">getServletContext</span><span class="o">();</span>
<span class="n">sc</span><span class="o">=</span><span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
</code></pre></div></div><p>普通类获取方法（普通类若不经过服务器调用(如servlet调用)则会报<code class="language-plaintext highlighter-rouge">NullPointerException</code>）</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServletContext</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">ContextLoader</span><span class="o">.</span><span class="na">getCurrentWebApplicationContext</span><span class="o">().</span><span class="na">getServletContext</span><span class="o">();</span>
</code></pre></div></div><p>然后<strong>通过<code class="language-plaintext highlighter-rouge">ServletContext</code>获取<code class="language-plaintext highlighter-rouge">ApplicationContext</code>：</strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getWebApplicationContext</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span><span class="c1">// 这种方法 获取失败时返回null</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unused"</span><span class="o">)</span>
<span class="nc">WebApplicationContext</span> <span class="n">ctx</span><span class="o">=</span><span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getRequiredWebApplicationContext</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span><span class="c1">// 这种方法 获取失败时抛出异常</span>
<span class="n">ac</span> <span class="o">=</span> <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getRequiredWebApplicationContext</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
</code></pre></div></div><hr /><p><strong>销毁</strong></p><p>对于手动加载的Spring，<code class="language-plaintext highlighter-rouge">ApplicationContext</code>怎么销毁:</p><p>在非Web应用中，手工加载Spring IoC容器，不能用<code class="language-plaintext highlighter-rouge">ApplicationContext</code>，要用<code class="language-plaintext highlighter-rouge">AbstractApplicationContext</code>。用完以后要记得调用<code class="language-plaintext highlighter-rouge">ctx.close()</code>关闭容器。如果不记得关闭容器，最典型的问题就是数据库连接不能释放。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">((</span><span class="nc">AbstractApplicationContext</span><span class="o">)</span><span class="n">appcon</span><span class="o">).</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div><h3 id="完整实例">完整实例</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/test"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
        <span class="c1">// 这种方法 获取失败时返回null</span>
        <span class="nc">ApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getWebApplicationContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">call</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCall</span><span class="o">(</span><span class="no">B</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">call</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>application.xml:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"call"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>web.xml:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span>
         <span class="na">version=</span><span class="s">"4.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>classpath:application.xml<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>
            org.springframework.web.context.ContextLoaderListener
        <span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div></div><h2 id="使用注解">使用注解</h2><p>使用Spring的IoC容器，实际上就是通过类似XML这样的配置文件，把Bean的依赖关系描述出来，然后让容器来创建并装配Bean。一旦容器初始化完毕，就可以直接从容器中获取Bean使用它们。</p><p>使用XML配置的优点是所有的Bean都能一目了然地列出来，并通过配置注入能直观地看到每个Bean的依赖。它的缺点是写起来非常繁琐，每增加一个组件，就必须把新的Bean配置到XML中。</p><p>还可以使用Annotation配置，让Spring自动扫描Bean并组装它们。</p><p>原代码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>

    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">A</span><span class="o">(</span><span class="no">B</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>xml：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><p>使用注解后：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*默认bean名称为首字母小写*/</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">A</span><span class="o">(</span><span class="no">B</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">@Component</code>注解就相当于定义了一个Bean，默认名称为小写开头的类名，可以指定<code class="language-plaintext highlighter-rouge">value</code>显示设置Bean名称。这里是使用构造方法装配，也可以使用<code class="language-plaintext highlighter-rouge">@Autowired</code>把指定类型的Bean注入到指定的字段中，它可以写在set方法上，也可以写在字段上，还可以写在构造方法形参上。如：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">A</span><span class="o">(</span><span class="nd">@Autowired</span> <span class="no">B</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>一般把<code class="language-plaintext highlighter-rouge">@Autowired</code>写在字段上：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>对于xml配置部分，通过标注<code class="language-plaintext highlighter-rouge">@Configuration</code>，表示<code class="language-plaintext highlighter-rouge">Test</code>是一个配置类，并且标注<code class="language-plaintext highlighter-rouge">@ComponentScan</code>告诉容器，自动搜索<strong>当前配置类所在的包以及子包</strong>的注解并装配。因此要特别注意包的层次结构。通常来说，启动配置类要位于自定义的顶层包。当然也可以指定要扫描的包<code class="language-plaintext highlighter-rouge">@ComponentScan("com.aotmd.test")</code>，这样就不用特定配置类的位置了。</p><p>如果不想使用配置类，也可以使用xml扫描注解：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.aotmd.test"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p>常用的装配注解：</p><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@Component</td><td>描述Spring中的Bean，但是它时一个泛化的概念，仅仅表示一个组件（Bean）并且可以作用在任何层次；</td></tr><tr><td>@Repository</td><td>用于将数据访问层（DAO）层的类标识为Spring中的Bean</td></tr><tr><td>@Service</td><td>作用在业务层（service层），用于将业务层的类标识为Spring中的Bean</td></tr><tr><td>@Controller</td><td>作用在控制层（如Spring MVC 的 controller层），用于将控制层的类标识为Spring中的Bean</td></tr><tr><td>@Autowired</td><td>该注解可以对类成员变量、方法及构造方法进行标注，完成自动装配的工作。 通过@Autowired的使用来消除setter 和getter方法。默认按照Bean的<strong>类型进行装配</strong>。</td></tr><tr><td>@Resource</td><td>该注解与@Autowired功能一样。区别在于，该注解默认是按照<strong>名称</strong>来装配注入的，只有当找不到与名称匹配的Bean才会按照类型来装配注入； @Resource注解有两个属性；name和type。name属性指定Bean实例名称，即按照名称来装配注入；type属性指定Bean类型，即按照Bean的类型进行装配</td></tr><tr><td>@Qualifier</td><td>该注解与@Autowired注解配合使用。当@Autowired注解需要按照<strong>名称</strong>来装配注入，则需要结合该注解一起使用，Bean的实例名称由@Qualifier注解的参数指定。</td></tr></tbody></table><p>注意: @Component @Repository @Service @Controller 注解默认无参数生成的Bean是<strong>首字母小写</strong>的类名,但若<strong>类名第一第二都是大写</strong>则将<strong>类名</strong>做为生成的Bean,若类名首字母是小写则一样以类名作为标识符。</p><p>上面几个注解中，虽然@Repository、@Service和@Controller等注解的功能与@Component相同，但为了使标注类的用途更加清晰（层次化），在实际开发中推荐使用@Repository标注数据访问层（DA0层）、使用@Service标注业务逻辑层（Service层）以及使用@Controller标注控制器层（控制层）。</p><h3 id="configuration">Configuration</h3><p><code class="language-plaintext highlighter-rouge">@Configuration</code>注解用于标识一个类是Spring的配置类，它通常与<code class="language-plaintext highlighter-rouge">@Bean</code>注解一起使用，用于定义Bean的创建和配置。主要作用包括：</p><ol><li><strong>定义Bean</strong>：在配置类中使用<code class="language-plaintext highlighter-rouge">@Bean</code>注解定义Bean的创建方法，Spring容器会根据这些方法创建相应的Bean实例。</li><li><strong>替代XML配置</strong>：<code class="language-plaintext highlighter-rouge">@Configuration</code>注解可以替代传统的XML配置文件，通过Java类的方式来配置应用程序的Bean。</li><li><strong>组件扫描</strong>：<code class="language-plaintext highlighter-rouge">@Configuration</code>注解通常与<code class="language-plaintext highlighter-rouge">@ComponentScan</code>注解一起使用，用于启用组件扫描，自动发现和注册Spring的Bean。</li><li><strong>条件化配置</strong>：可以结合条件注解如<code class="language-plaintext highlighter-rouge">@ConditionalOnProperty</code>等，根据条件来决定是否应用某个配置。</li><li><strong>AOP支持</strong>：<code class="language-plaintext highlighter-rouge">@Configuration</code>类中的方法可以使用<code class="language-plaintext highlighter-rouge">@Bean</code>注解来声明切面等AOP相关的Bean。</li><li><strong>配置属性绑定</strong>：可以使用<code class="language-plaintext highlighter-rouge">@Value</code>注解将配置文件中的属性值注入到<code class="language-plaintext highlighter-rouge">@Configuration</code>类中的Bean中。</li></ol><p>如果没有该注解，也可以正常使用，但它的缺陷是被调用的@Bean方法产生的实例在容器中不是唯一的：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a1"</span><span class="o">);</span>
        
    <span class="o">}</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"a1"</span><span class="o">)</span>
    <span class="no">A</span> <span class="nf">getA</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getB</span><span class="o">()</span> <span class="o">==</span> <span class="n">getB</span><span class="o">());</span> <span class="c1">//结果是false，说明每调用一次getB()都会产生新的实例。加上@Configuration之后结果就是true了。</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">A</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="no">B</span> <span class="nf">getB</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">B</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">A</span><span class="o">{}</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">B</span><span class="o">{}</span>
<span class="o">}</span>
</code></pre></div></div><h3 id="prototype">Prototype</h3><p>对于Spring容器来说，把一个Bean标记为<code class="language-plaintext highlighter-rouge">@Component</code>后，它就会自动创建一个单例（Singleton），即容器初始化时创建Bean，容器关闭前销毁Bean。在容器运行期间，调用<code class="language-plaintext highlighter-rouge">getBean(Class)</code>获取到的Bean总是同一个实例。</p><p>还有一种Bean，每次调用<code class="language-plaintext highlighter-rouge">getBean(Class)</code>，容器都返回一个<strong>新的实例</strong>，这种Bean称为Prototype（原型），它的生命周期和Singleton不同。声明一个Prototype的Bean时，需要添加一个额外的<code class="language-plaintext highlighter-rouge">@Scope</code>注解：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scope</span><span class="o">(</span><span class="nc">ConfigurableBeanFactory</span><span class="o">.</span><span class="na">SCOPE_PROTOTYPE</span><span class="o">)</span><span class="c1">//"prototype"</span>
</code></pre></div></div><p>即：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a1</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="no">A</span> <span class="n">a2</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a1</span><span class="o">==</span><span class="n">a2</span><span class="o">);</span><span class="c1">//false</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*默认bean名称为首字母小写*/</span>
<span class="nd">@Component</span>
<span class="nd">@Scope</span><span class="o">(</span><span class="nc">ConfigurableBeanFactory</span><span class="o">.</span><span class="na">SCOPE_PROTOTYPE</span><span class="o">)</span><span class="c1">//"prototype"</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">A</span><span class="o">(</span><span class="no">B</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>具体来说有如下几个作用域：</p><table><thead><tr><th><strong>作用域名称</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>singleton</strong></td><td>默认的作用域，使用singleton定义的Bean在Spring容器中只有一个Bean实例。</td></tr><tr><td><strong>prototype</strong></td><td>Spring容器每次获取prototype定义的Bean，容器都将创建一个新的Bean实例。</td></tr><tr><td><strong>request</strong></td><td>在一次HTTP请求中容器将返回一个Bean实例，不同的HTTP请求返回不同的Bean实例。仅在Web Spring应用程序上下文中使用。</td></tr><tr><td><strong>session</strong></td><td>在一个HTTP Session中，容器将返回同一个Bean实例。仅在Web Spring应用程序上下文中使用。</td></tr><tr><td><strong>application</strong></td><td>为每个ServletContext对象创建一个实例，即同一个应用共享一个Bean实例。仅在Web Spring应用程序上下文中使用。</td></tr><tr><td><strong>websocket</strong></td><td>为每个WebSocket对象创建一个Bean实例。仅在Web Spring应用程序上下文中使用。</td></tr></tbody></table><h3 id="注入list">注入List</h3><p>有些时候，会有一系列接口相同，不同实现类的Bean。例如，注册用户时，要对<code class="language-plaintext highlighter-rouge">email</code>、<code class="language-plaintext highlighter-rouge">password</code>和<code class="language-plaintext highlighter-rouge">name</code>这3个变量进行验证。为了便于扩展，先定义验证接口：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">Validator</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>然后，分别使用3个<code class="language-plaintext highlighter-rouge">Validator</code>对用户参数进行验证：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">EmailValidator</span> <span class="kd">implements</span> <span class="nc">Validator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">user</span><span class="o">.</span><span class="na">email</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"^[a-z0-9]+@[a-z0-9]+\\.[a-z]{2,10}$"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"invalid email: "</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">email</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">PasswordValidator</span> <span class="kd">implements</span> <span class="nc">Validator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">user</span><span class="o">.</span><span class="na">password</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">"^.{6,20}$"</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"invalid password"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">NameValidator</span> <span class="kd">implements</span> <span class="nc">Validator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">name</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">||</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"invalid name: "</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>最后，通过一个<code class="language-plaintext highlighter-rouge">Validators</code>作为入口进行验证：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">Validators</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Validator</span><span class="o">&gt;</span> <span class="n">validators</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">var</span> <span class="n">validator</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">validators</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>启动：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">Validators</span> <span class="n">validators</span><span class="o">=</span> <span class="o">(</span><span class="nc">Validators</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"validators"</span><span class="o">);</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"123@qq.com"</span><span class="o">,</span> <span class="s">"123123"</span><span class="o">,</span> <span class="s">"45ddf"</span><span class="o">);</span>
        <span class="n">validators</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">Validators</code>被注入了一个<code class="language-plaintext highlighter-rouge">List&lt;Validator&gt;</code>，Spring会自动把所有类型为<code class="language-plaintext highlighter-rouge">Validator</code>的Bean装配为一个<code class="language-plaintext highlighter-rouge">List</code>注入进来，这样一来，每新增一个<code class="language-plaintext highlighter-rouge">Validator</code>类型，就自动被Spring装配到<code class="language-plaintext highlighter-rouge">Validators</code>中了，非常方便。</p><p>因为Spring是通过扫描classpath获取到所有的Bean，而<code class="language-plaintext highlighter-rouge">List</code>是有序的，要指定<code class="language-plaintext highlighter-rouge">List</code>中Bean的顺序，可以加上<code class="language-plaintext highlighter-rouge">@Order</code>注解：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Order</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">EmailValidator</span> <span class="kd">implements</span> <span class="nc">Validator</span> <span class="o">{}</span>
<span class="nd">@Order</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">PasswordValidator</span> <span class="kd">implements</span> <span class="nc">Validator</span> <span class="o">{}</span>
<span class="nd">@Order</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">NameValidator</span> <span class="kd">implements</span> <span class="nc">Validator</span> <span class="o">{}</span>
</code></pre></div></div><h3 id="可选注入">可选注入</h3><p>默认情况下，当标记了一个<code class="language-plaintext highlighter-rouge">@Autowired</code>后，Spring如果没有找到对应类型的Bean，它会<strong>抛出<code class="language-plaintext highlighter-rouge">NoSuchBeanDefinitionException</code>异常</strong>。可以给<code class="language-plaintext highlighter-rouge">@Autowired</code>增加一个<code class="language-plaintext highlighter-rouge">required = false</code>的参数，表示如果找不到就忽略，不抛出异常。这种方式非常适合有定义就使用定义，没有就使用默认值的情况。实例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Autowired</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><h3 id="创建第三方bean">创建第三方Bean</h3><p>如果想给<code class="language-plaintext highlighter-rouge">A</code>注入<code class="language-plaintext highlighter-rouge">HikariDataSource</code>，但是这个类位于<code class="language-plaintext highlighter-rouge">com.zaxxer.hikari</code>包中，并且<code class="language-plaintext highlighter-rouge">HikariDataSource</code>也不可能有<code class="language-plaintext highlighter-rouge">@Component</code>注解，如何告诉IoC容器创建并配置<code class="language-plaintext highlighter-rouge">HikariDataSource</code>？</p><p>当然是在<code class="language-plaintext highlighter-rouge">@Configuration</code>类中编写一个Java方法创建并返回它，并注意给方法标记一个<code class="language-plaintext highlighter-rouge">@Bean</code>注解，这个方法返回一个<code class="language-plaintext highlighter-rouge">HikariDataSource</code>实例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">jdbc</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"dataSource"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">HikariDataSource</span> <span class="nf">getDataSource</span><span class="o">(){</span>
        <span class="nc">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
        <span class="n">props</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"jdbcUrl"</span><span class="o">,</span><span class="s">"jdbc:mysql://localhost:3306/studentdb?characterEncoding=utf-8&amp;serverTimezone=GMT%2B8&amp;useSSL=false"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span><span class="s">"root"</span><span class="o">);</span>
        <span class="n">props</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span><span class="s">"123456"</span><span class="o">);</span>
        <span class="nc">HikariConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariConfig</span><span class="o">(</span><span class="n">props</span><span class="o">);</span>
        <span class="n">config</span><span class="o">.</span><span class="na">addDataSourceProperty</span><span class="o">(</span><span class="s">"cachePrepStmts"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">HikariDataSource</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*默认bean名称为首字母小写*/</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">HikariDataSource</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">jdbc</span><span class="o">(){</span>
        <span class="k">try</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">ResultSet</span> <span class="n">resultSet</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="s">"select name from student"</span><span class="o">).</span><span class="na">executeQuery</span><span class="o">();</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">next</span><span class="o">()){</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">resultSet</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Spring对标记为<code class="language-plaintext highlighter-rouge">@Bean</code>的方法只调用一次，因此返回的Bean仍然是单例。</p><h3 id="初始化和销毁">初始化和销毁</h3><p>有些时候，一个Bean在注入必要的依赖后，需要进行初始化（监听消息等）。在容器关闭时，有时候还需要清理资源（关闭连接池等）。通常会定义一个<code class="language-plaintext highlighter-rouge">init()</code>方法进行初始化，定义一个<code class="language-plaintext highlighter-rouge">shutdown()</code>方法进行清理，需要引入JSR-250定义的Annotation。</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>javax.annotation<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>javax.annotation-api<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>然后在Bean的初始化和清理方法上标记<code class="language-plaintext highlighter-rouge">@PostConstruct</code>和<code class="language-plaintext highlighter-rouge">@PreDestroy</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@PostConstruct</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Init"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@PreDestroy</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shutdown</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Shutdown"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>Spring容器会对上述Bean做如下初始化流程：</p><ul><li>调用构造方法创建<code class="language-plaintext highlighter-rouge">A</code>实例；</li><li>根据<code class="language-plaintext highlighter-rouge">@Autowired</code>进行注入；</li><li>调用标记有<code class="language-plaintext highlighter-rouge">@PostConstruct</code>的<code class="language-plaintext highlighter-rouge">init()</code>方法进行初始化。</li></ul><p>而销毁时，容器会首先调用标记有<code class="language-plaintext highlighter-rouge">@PreDestroy</code>的<code class="language-plaintext highlighter-rouge">shutdown()</code>方法。</p><p>Spring只根据Annotation查找<strong>无参数</strong>方法，对方法名不作要求。</p><p>如果shutdown() 没有调用，则需要手动调用<code class="language-plaintext highlighter-rouge">applicationContext.close()</code>，而不是等待进程结束。</p><h3 id="使用别名">使用别名</h3><p>默认情况下，对一种类型的Bean，容器只创建一个实例。但有些时候，需要对一种类型的Bean创建多个实例。例如，同时连接多个数据库，就必须创建多个<code class="language-plaintext highlighter-rouge">DataSource</code>实例。</p><p>如果在<code class="language-plaintext highlighter-rouge">@Configuration</code>类中创建了多个同类型的Bean，在Spring 5.0之前的版本中，Spring会报<code class="language-plaintext highlighter-rouge">NoUniqueBeanDefinitionException</code>异常，意思是出现了重复的Bean定义。从Spring 5.0开始，默认情况下，Spring允许存在多个同类型的Bean定义，并且不会抛出异常。相反，它会将这些Bean注册为一个集合类型的Bean。</p><p>要避免这个异常，可以指定不同的名称：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"b1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="no">B</span> <span class="nf">b</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">B</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"b2"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="no">B</span> <span class="nf">b2</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">B</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*默认bean名称为首字母小写*/</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"b1"</span><span class="o">)</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>可以用<code class="language-plaintext highlighter-rouge">@Bean("name")</code>指定别名，也可以用<code class="language-plaintext highlighter-rouge">@Bean</code>+<code class="language-plaintext highlighter-rouge">@Qualifier("name")</code>指定别名。</p><p>其实Bean的<code class="language-plaintext highlighter-rouge">name</code>默认就是方法名称。</p><h3 id="注入选择问题">注入选择问题</h3><p>存在多个同类型的Bean时，注入时又会报错，即不知道注入哪个，因此要通过<code class="language-plaintext highlighter-rouge">@Qualifier("b1")</code>指定注入的Bean名称。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"b1"</span><span class="o">)</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>这里也可以把两个注解换成 <code class="language-plaintext highlighter-rouge">@Resource(name = "b1")</code>。</p><p>还可以把待注入的<strong>变量名称</strong>改为Bean名称，这样也可以指定注入的Bean名称：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b1</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b1</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>也可以通过使用<code class="language-plaintext highlighter-rouge">@Primary</code>指定某个Bean，在注入时，如果没有指出Bean的名字，Spring会注入标记有<code class="language-plaintext highlighter-rouge">@Primary</code>的Bean。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Primary</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"b1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="no">B</span> <span class="nf">b</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">B</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="s">"b2"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="no">B</span> <span class="nf">b2</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">B</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*默认bean名称为首字母小写*/</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span><span class="c1">//默认注入b1</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>若使用Spring boot，还能根据配置属性的值来决定是否应用这个配置。即注解：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ConditionalOnProperty</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">"class"</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"select"</span><span class="o">,</span> <span class="n">havingValue</span> <span class="o">=</span> <span class="s">"B"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">B</span><span class="err">｛｝</span>
</code></pre></div></div><ul><li><code class="language-plaintext highlighter-rouge">@Configuration</code>：注解表示这是一个配置类，它会被Spring容器扫描并加载。</li><li><code class="language-plaintext highlighter-rouge">@ConditionalOnProperty</code>：注解用于根据配置属性的值来决定是否应用这个配置。它有几个参数：<ul><li><code class="language-plaintext highlighter-rouge">prefix</code>：配置属性的前缀。在这个例子中，配置属性的前缀是<code class="language-plaintext highlighter-rouge">class</code>。</li><li><code class="language-plaintext highlighter-rouge">name</code>：配置属性的名称。在这个例子中，配置属性的名称是<code class="language-plaintext highlighter-rouge">select</code>。</li><li><code class="language-plaintext highlighter-rouge">havingValue</code>：期望的配置属性值。在这个例子中，期望的配置属性值是<code class="language-plaintext highlighter-rouge">B</code>。</li></ul></li></ul><p>如果满足了以上条件，即配置属性<code class="language-plaintext highlighter-rouge">class.select</code>的值为<code class="language-plaintext highlighter-rouge">B</code>，那么这个配置类中的配置将会生效。否则，这个配置类中的配置将会被忽略。</p><h3 id="使用factorybean">使用FactoryBean</h3><p>用工厂模式创建Bean需要实现<code class="language-plaintext highlighter-rouge">FactoryBean</code>接口：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">BFactoryBean</span> <span class="kd">implements</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="no">B</span><span class="o">&gt;{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">B</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">B</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">B</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>当一个Bean实现了<code class="language-plaintext highlighter-rouge">FactoryBean</code>接口后，Spring会先实例化这个工厂，然后调用<code class="language-plaintext highlighter-rouge">getObject()</code>创建真正的Bean。<code class="language-plaintext highlighter-rouge">getObjectType()</code>可以指定创建的Bean的类型，因为指定类型不一定与实际类型一致，可以是接口或抽象类。</p><p>因此，如果定义了一个<code class="language-plaintext highlighter-rouge">FactoryBean</code>，要注意Spring创建的Bean实际上是这个<code class="language-plaintext highlighter-rouge">FactoryBean</code>的<code class="language-plaintext highlighter-rouge">getObject()</code>方法返回的Bean。为了和普通Bean区分，通常都以<code class="language-plaintext highlighter-rouge">XxxFactoryBean</code>命名。</p><p>由于可以用<code class="language-plaintext highlighter-rouge">@Bean</code>方法创建第三方Bean，本质上<code class="language-plaintext highlighter-rouge">@Bean</code>方法就是工厂方法，所以，<code class="language-plaintext highlighter-rouge">FactoryBean</code>已经用得越来越少了。</p><h3 id="使用resource">使用Resource</h3><p>在Java程序中，经常会读取配置文件、资源文件等。使用Spring容器时，也可以把“文件”注入进来，方便程序读取。</p><p>例如，AppService需要读取<code class="language-plaintext highlighter-rouge">logo.txt</code>这个文件，通常情况下，需要写很多繁琐的代码，主要是为了定位文件，打开InputStream。</p><p>Spring提供了一个<code class="language-plaintext highlighter-rouge">org.springframework.core.io.Resource</code>（注意不是<code class="language-plaintext highlighter-rouge">jarkata.annotation.Resource</code>或<code class="language-plaintext highlighter-rouge">javax.annotation.Resource</code>），它可以像<code class="language-plaintext highlighter-rouge">String</code>、<code class="language-plaintext highlighter-rouge">int</code>一样使用<code class="language-plaintext highlighter-rouge">@Value</code>注入：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"classpath:/application.xml"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Resource</span> <span class="n">resource</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">printResource</span><span class="o">(){</span>
        <span class="k">try</span> <span class="o">(</span><span class="kt">var</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)))</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">lines</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">"\n"</span><span class="o">)));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>注入<code class="language-plaintext highlighter-rouge">Resource</code>最常用的方式是通过classpath，即类似<code class="language-plaintext highlighter-rouge">classpath:/application.xml</code>表示在classpath中搜索<code class="language-plaintext highlighter-rouge">application.xml</code>文件，然后，直接调用<code class="language-plaintext highlighter-rouge">Resource.getInputStream()</code>就可以获取到输入流，避免了自己搜索文件的代码。</p><p>也可以直接指定文件的路径，例如：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Value</span><span class="o">(</span><span class="s">"file:D:/application.xml"</span><span class="o">)</span>
</code></pre></div></div><h3 id="注入配置">注入配置</h3><p>在开发应用程序时，经常需要读取配置文件。最常用的配置方法是以<code class="language-plaintext highlighter-rouge">key=value</code>的形式写在<code class="language-plaintext highlighter-rouge">.properties</code>文件中。</p><p>例如，<code class="language-plaintext highlighter-rouge">MailService</code>根据配置的<code class="language-plaintext highlighter-rouge">app.zone=Asia/Shanghai</code>来决定使用哪个时区。要读取配置文件，可以使用上一节的<code class="language-plaintext highlighter-rouge">Resource</code>来读取位于classpath下的一个<code class="language-plaintext highlighter-rouge">app.properties</code>文件。但是，这样仍然比较繁琐。</p><p>Spring容器还提供了一个更简单的<code class="language-plaintext highlighter-rouge">@PropertySource</code>来自动读取配置文件。只需要在<code class="language-plaintext highlighter-rouge">@Configuration</code>配置类上再添加一个注解：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span>
<span class="nd">@PropertySource</span><span class="o">(</span><span class="s">"classpath:app.properties"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${app.zone:Z}"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">zoneId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">Test</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">ZoneId</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">print</span><span class="o">();</span>

    <span class="o">}</span>
    <span class="nd">@Bean</span>
    <span class="nc">ZoneId</span> <span class="nf">createZoneId</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">zoneId</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">zoneId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*默认bean名称为首字母小写*/</span>
<span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${app.zone:Z}"</span><span class="o">)</span>
    <span class="nc">String</span> <span class="n">zoneId</span><span class="o">;</span>
    <span class="kt">void</span> <span class="nf">print</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">zoneId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>app.properties：</p><div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">app.zone</span><span class="p">=</span><span class="s">Asia/Shanghai</span>
</code></pre></div></div><p>Spring容器看到<code class="language-plaintext highlighter-rouge">@PropertySource("app.properties")</code>注解后，自动读取这个配置文件，然后，使用<code class="language-plaintext highlighter-rouge">@Value</code>正常注入。</p><p>注入的字符串语法，它的格式如下：</p><ul><li><code class="language-plaintext highlighter-rouge">"${app.zone}"</code>表示读取key为<code class="language-plaintext highlighter-rouge">app.zone</code>的value，如果key不存在，启动将报错；</li><li><code class="language-plaintext highlighter-rouge">"${app.zone:Z}"</code>表示读取key为<code class="language-plaintext highlighter-rouge">app.zone</code>的value，但如果key不存在，就使用默认值<code class="language-plaintext highlighter-rouge">Z</code>。</li></ul><p>这样一来，就可以根据<code class="language-plaintext highlighter-rouge">app.zone</code>的配置来创建<code class="language-plaintext highlighter-rouge">ZoneId</code>。</p><p>还可以把注入的注解写到方法参数中：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="nc">ZoneId</span> <span class="nf">createZoneId</span><span class="o">(</span><span class="nd">@Value</span><span class="o">(</span><span class="s">"${app.zone:Z}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">zoneId</span><span class="o">){</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">zoneId</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">zoneId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p>使用<code class="language-plaintext highlighter-rouge">@PropertySource</code>读取配置文件，然后通过<code class="language-plaintext highlighter-rouge">@Value</code>以<code class="language-plaintext highlighter-rouge">${key:defaultValue}</code>的形式注入，可以极大地简化读取配置的麻烦。</p><p>另一种注入配置的方式是先通过一个简单的JavaBean持有所有的配置，例如，一个<code class="language-plaintext highlighter-rouge">SmtpConfig</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">class</span> <span class="nc">AppConfig</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${app.zone:Z}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">zoneId</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getZoneId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">zoneId</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>然后，在需要读取的地方，使用<code class="language-plaintext highlighter-rouge">#{appConfig.zoneId}</code>注入：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="nc">ZoneId</span> <span class="nf">createZoneId</span><span class="o">(</span><span class="nd">@Value</span><span class="o">(</span><span class="s">"#{appConfig.zoneId}"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">zoneId</span><span class="o">){</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">zoneId</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">zoneId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">#{}</code>这种注入语法，和<code class="language-plaintext highlighter-rouge">${key}</code>不同的是，<code class="language-plaintext highlighter-rouge">#{}</code>表示从JavaBean读取属性。<code class="language-plaintext highlighter-rouge">"#{appConfig.zoneId}"</code>的意思是，从名称为<code class="language-plaintext highlighter-rouge">appConfig</code>的Bean读取<code class="language-plaintext highlighter-rouge">zoneId</code>属性，即调用<code class="language-plaintext highlighter-rouge">getZoneId()</code>方法。</p><p>使用一个独立的JavaBean持有所有属性，然后在其他Bean中以<code class="language-plaintext highlighter-rouge">#{bean.property}</code>注入的好处是，多个Bean都可以引用同一个Bean的某个属性。如果<code class="language-plaintext highlighter-rouge">appConfig</code>决定从数据库中读取相关配置项，那么<code class="language-plaintext highlighter-rouge">createZoneId</code>注入的<code class="language-plaintext highlighter-rouge">@Value("#{appConfig.zoneId}")</code>仍然可以不修改正常运行。</p><h3 id="使用条件装配">使用条件装配</h3><p>开发应用程序时，会使用开发环境，例如，使用内存数据库以便快速启动。而运行在生产环境时，会使用生产环境，例如，使用MySQL数据库。如果应用程序可以根据自身的环境做一些适配，无疑会更加灵活。</p><p>Spring为应用程序准备了Profile这一概念，用来表示不同的环境。分别定义开发、测试和生产这3个环境：</p><ul><li>native</li><li>test</li><li>production</li></ul><p>创建某个Bean时，Spring容器可以根据注解<code class="language-plaintext highlighter-rouge">@Profile</code>来决定是否创建。例如，以下配置：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="nd">@Profile</span><span class="o">(</span><span class="s">"!test"</span><span class="o">)</span>
    <span class="nc">ZoneId</span> <span class="nf">createZoneId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">ZoneId</span><span class="o">.</span><span class="na">systemDefault</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="nd">@Profile</span><span class="o">(</span><span class="s">"test"</span><span class="o">)</span>
    <span class="nc">ZoneId</span> <span class="nf">createZoneIdForTest</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">ZoneId</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"America/New_York"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>如果当前的Profile设置为<code class="language-plaintext highlighter-rouge">test</code>，则Spring容器会调用<code class="language-plaintext highlighter-rouge">createZoneIdForTest()</code>创建<code class="language-plaintext highlighter-rouge">ZoneId</code>，否则，调用<code class="language-plaintext highlighter-rouge">createZoneId()</code>创建<code class="language-plaintext highlighter-rouge">ZoneId</code>。注意到<code class="language-plaintext highlighter-rouge">@Profile("!test")</code>表示非test环境。</p><p>在运行程序时，加上JVM参数<code class="language-plaintext highlighter-rouge">-Dspring.profiles.active=test</code>就可以指定以<code class="language-plaintext highlighter-rouge">test</code>环境启动。</p><p>实际上，Spring允许指定多个Profile，例如：</p><pre><code class="language-cmd">-Dspring.profiles.active=test,master
</code></pre><p>可以表示<code class="language-plaintext highlighter-rouge">test</code>环境，并使用<code class="language-plaintext highlighter-rouge">master</code>分支代码。要满足多个Profile条件，可以这样写：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="nd">@Profile</span><span class="o">({</span> <span class="s">"test"</span><span class="o">,</span> <span class="s">"master"</span> <span class="o">})</span> <span class="c1">// 满足test或master</span>
<span class="nc">ZoneId</span> <span class="nf">createZoneId</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div><p><strong>使用Conditional</strong></p><p>除了根据<code class="language-plaintext highlighter-rouge">@Profile</code>条件来决定是否创建某个Bean外，Spring还可以根据<code class="language-plaintext highlighter-rouge">@Conditional</code>决定是否创建某个Bean。添加如下注解：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span><span class="o">(</span><span class="s">"a1"</span><span class="o">)</span>
<span class="nd">@Conditional</span><span class="o">(</span><span class="nc">MainCondition</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="no">A</span> <span class="nf">getA</span><span class="o">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">A</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div><p>它的意思是，如果满足<code class="language-plaintext highlighter-rouge">MainCondition</code>的条件，才会创建<code class="language-plaintext highlighter-rouge">a1</code>这个Bean。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MainCondition</span> <span class="kd">implements</span> <span class="nc">Condition</span><span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="nc">ConditionContext</span> <span class="n">context</span><span class="o">,</span> <span class="nc">AnnotatedTypeMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
    	<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>这里直接返回<code class="language-plaintext highlighter-rouge">false</code>，因此Bean<code class="language-plaintext highlighter-rouge">a1</code>始终不会创建。</p><p>Spring只提供了<code class="language-plaintext highlighter-rouge">@Conditional</code>注解，具体判断逻辑还需要我们自己实现。</p><p>Spring Boot提供了更多使用起来更简单的条件注解，例如，如果配置文件中存在<code class="language-plaintext highlighter-rouge">app.smtp=true</code>，则创建<code class="language-plaintext highlighter-rouge">a1</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span><span class="o">(</span><span class="s">"a1"</span><span class="o">)</span>
<span class="nd">@ConditionalOnProperty</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"app.smtp"</span><span class="o">,</span> <span class="n">havingValue</span><span class="o">=</span><span class="s">"true"</span><span class="o">)</span>
<span class="no">A</span> <span class="nf">getA</span><span class="o">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">A</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">@ConditionalOnProperty</code>是Spring Boot框架中的一个条件注解，用于根据属性的存在与否以及属性值来决定是否应该创建一个Bean。该注解有以下参数：</p><ol><li><p><code class="language-plaintext highlighter-rouge">name</code>：要检查的属性名。指定要检查的应用程序属性的名称。如果未指定<code class="language-plaintext highlighter-rouge">prefix</code>，则将直接检查指定名称的属性。如果指定了<code class="language-plaintext highlighter-rouge">prefix</code>，则会在<code class="language-plaintext highlighter-rouge">prefix</code>后面加上<code class="language-plaintext highlighter-rouge">.</code>再加上<code class="language-plaintext highlighter-rouge">name</code>来构成完整的属性名。</p></li><li><p><code class="language-plaintext highlighter-rouge">havingValue</code>：属性必须具有的值。指定属性必须具有的值才能满足条件。默认值为空字符串。</p></li><li><p><code class="language-plaintext highlighter-rouge">matchIfMissing</code>：如果属性不存在时是否应该匹配。指定当属性不存在时是否应该认为条件匹配。默认值为<code class="language-plaintext highlighter-rouge">false</code>，即属性不存在时条件不匹配。</p></li><li><p><code class="language-plaintext highlighter-rouge">prefix</code>：属性名的前缀。指定属性名的前缀，用于构成完整的属性名。</p></li><li><p><code class="language-plaintext highlighter-rouge">value</code>：属性的值。与<code class="language-plaintext highlighter-rouge">havingValue</code>参数相同，用于指定属性必须具有的值。</p></li></ol><p>通过使用这些参数，可以根据应用程序的配置属性来动态地确定是否创建某个Bean。根据属性名、属性值、属性是否存在以及是否匹配等条件，可以灵活地控制Bean的创建过程。</p><p>如果当前classpath中存在类<code class="language-plaintext highlighter-rouge">javax.mail.Transport</code>，则创建<code class="language-plaintext highlighter-rouge">a1</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span><span class="o">(</span><span class="s">"a1"</span><span class="o">)</span>
<span class="nd">@ConditionalOnClass</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"javax.mail.Transport"</span><span class="o">)</span>
<span class="no">A</span> <span class="nf">getA</span><span class="o">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">A</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div><p>使用条件注解，能更灵活地装配Bean。</p><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="" target="_blank">acteds</a></li><li>本文链接：<a href="/2021/11/13/Spring/" target="_blank">https://acteds.github.io/2021/11/13/Spring/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://beaudar.lipk.org/client.js" repo="mzlogin/blog-comments" issue-term="title" label="gitment" theme="github-light" comment-order="desc" input-position="top" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: '/assets/search_data.json?v=1716554066', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="acteds">acteds</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/acteds/acteds.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="/" title="首页" target="">首页</a></li><li> <a href="/categories/" title="分类" target="">分类</a></li><li> <a href="/wiki/" title="维基" target="">维基</a></li><li> <a href="/about/" title="关于" target="">关于</a></li><li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
