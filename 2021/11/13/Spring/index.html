<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>Spring &mdash; 个人博客</title><link rel="stylesheet" href="/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="/assets/css/components/collection.css"><link rel="stylesheet" href="/assets/css/components/repo-card.css"><link rel="stylesheet" href="/assets/css/sections/repo-list.css"><link rel="stylesheet" href="/assets/css/components/boxed-group.css"><link rel="stylesheet" href="/assets/css/globals/common.css"><link rel="stylesheet" href="/assets/css/globals/responsive.css"><link rel="stylesheet" href="/assets/css/posts/index.css"><link rel="stylesheet" href="/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="/assets/css/highlight/monokai.sublime.css"><link rel="canonical" href="/2021/11/13/Spring/"><link rel="alternate" type="application/atom+xml" title="个人博客" href="/feed.xml"><link rel="shortcut icon" href="/favicon.ico"><meta property="og:title" content="Spring"><meta name="keywords" content="Java"><meta name="og:keywords" content="Java"><meta name="description" content="引言"><meta name="og:description" content="引言"><meta property="og:url" content="/2021/11/13/Spring/"><meta property="og:site_name" content="个人博客"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-11-13"> <script src="/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="/assets/js/jquery-ui.js"></script> <script src="/assets/js/main.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80669434-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-80669434-1'); </script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="/" title="个人博客"><span class="octicon octicon-mark-github"></span> 个人博客</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="/" class=" site-header-nav-item" target="" title="首页">首页</a> <a href="/categories/" class=" site-header-nav-item" target="" title="分类">分类</a> <a href="/wiki/" class=" site-header-nav-item" target="" title="维基">维基</a> <a href="/about/" class=" site-header-nav-item" target="" title="关于">关于</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="Spring"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">Spring</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/11/13 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="/categories/#Java" title="Java">Java</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 13376 字，约 39 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><h1 id="引言">引言</h1><p>Spring框架笔记。</p><h1 id="spring">Spring</h1><p>Spring是一个支持快速开发Java EE应用程序的框架。它提供了一系列底层容器和基础设施，并可以和大量常用的开源框架无缝集成，可以说是开发Java EE应用程序的必备。</p><p>Spring Framework主要包括几个模块：</p><ul><li>支持IoC和AOP的容器；</li><li>支持JDBC和ORM的数据访问模块；</li><li>支持声明式事务的模块；</li><li>支持基于Servlet的MVC开发；</li><li>支持基于Reactive的Web开发；</li><li>以及集成JMS、JavaMail、JMX、缓存等其他模块。</li></ul><h2 id="ioc">IoC</h2><p>容器是一种为某种特定组件的运行提供必要支持的一个软件环境。例如，Tomcat就是一个Servlet容器，它可以为Servlet的运行提供运行环境。类似Docker这样的软件也是一个容器，它提供了必要的Linux环境以便运行一个特定的Linux进程。</p><p>通常来说，使用容器运行组件，除了提供一个组件运行环境之外，容器还提供了许多底层服务。例如，Servlet容器底层实现了TCP连接，解析HTTP协议等非常复杂的服务，如果没有容器来提供这些服务，我们就无法编写像Servlet这样代码简单，功能强大的组件。早期的JavaEE服务器提供的EJB容器最重要的功能就是通过声明式事务服务，使得EJB组件的开发人员不必自己编写冗长的事务处理代码，所以极大地简化了事务处理。</p><p>Spring的核心就是提供了一个IoC容器，它可以管理所有轻量级的JavaBean组件，提供的底层服务包括组件的生命周期管理、配置和组装服务、AOP支持，以及建立在AOP基础上的声明式事务服务等。</p><p>IoC全称Inversion of Control，直译为控制反转。</p><p>假定一个在线书店，通过<code class="language-plaintext highlighter-rouge">BookService</code>获取书籍：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">HikariConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariConfig</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nc">Book</span> <span class="nf">getBook</span><span class="o">(</span><span class="kt">long</span> <span class="n">bookId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="k">return</span> <span class="n">book</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>为了从数据库查询书籍，<code class="language-plaintext highlighter-rouge">BookService</code>持有一个<code class="language-plaintext highlighter-rouge">DataSource</code>。为了实例化一个<code class="language-plaintext highlighter-rouge">HikariDataSource</code>，又不得不实例化一个<code class="language-plaintext highlighter-rouge">HikariConfig</code>。</p><p>现在，继续编写<code class="language-plaintext highlighter-rouge">UserService</code>获取用户：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">HikariConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariConfig</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HikariDataSource</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>因为<code class="language-plaintext highlighter-rouge">UserService</code>也需要访问数据库，因此，不得不也实例化一个<code class="language-plaintext highlighter-rouge">HikariDataSource</code>。</p><p>上述每个组件都采用了一种简单的通过<code class="language-plaintext highlighter-rouge">new</code>创建实例并持有的方式。会有以下缺点：</p><ol><li>实例化一个组件其实很难，例如，<code class="language-plaintext highlighter-rouge">BookService</code>和<code class="language-plaintext highlighter-rouge">UserService</code>要创建<code class="language-plaintext highlighter-rouge">HikariDataSource</code>，实际上需要读取配置，才能先实例化<code class="language-plaintext highlighter-rouge">HikariConfig</code>，再实例化<code class="language-plaintext highlighter-rouge">HikariDataSource</code>。</li><li>没有必要让<code class="language-plaintext highlighter-rouge">BookService</code>和<code class="language-plaintext highlighter-rouge">UserService</code>分别创建<code class="language-plaintext highlighter-rouge">DataSource</code>实例，完全可以共享同一个<code class="language-plaintext highlighter-rouge">DataSource</code>，但谁负责创建<code class="language-plaintext highlighter-rouge">DataSource</code>，谁负责获取其他组件已经创建的<code class="language-plaintext highlighter-rouge">DataSource</code>，不好处理。</li><li>很多组件需要销毁以便释放资源，例如<code class="language-plaintext highlighter-rouge">DataSource</code>，但如果该组件被多个组件共享，如何确保它的使用方都已经全部被销毁？</li><li>测试某个组件，例如<code class="language-plaintext highlighter-rouge">BookService</code>，是复杂的，因为必须要在真实的数据库环境下执行。</li></ol><p>如果一个系统有大量的组件，其生命周期和相互之间的依赖关系如果由组件自身来维护，不但大大增加了系统的复杂度，而且会导致组件之间极为紧密的耦合，继而给测试和维护带来了极大的困难。</p><p>因此，核心问题是：谁负责创建组件？谁负责根据依赖关系组装组件？销毁时，如何按依赖顺序正确销毁？解决这一问题的核心方案就是IoC。</p><p>传统的应用程序中，控制权在程序本身，程序的控制流程完全由开发者控制，例如：</p><p><code class="language-plaintext highlighter-rouge">CartServlet</code>创建了<code class="language-plaintext highlighter-rouge">BookService</code>，在创建<code class="language-plaintext highlighter-rouge">BookService</code>的过程中，又创建了<code class="language-plaintext highlighter-rouge">DataSource</code>组件。这种模式的缺点是，一个组件如果要使用另一个组件，必须先知道如何正确地创建它。</p><p>在IoC模式下，控制权发生了反转，即从应用程序转移到了IoC容器，所有组件不再由应用程序自己创建和配置，而是由IoC容器负责，这样，应用程序只需要直接使用已经创建好并且配置好的组件。为了能让组件在IoC容器中被“装配”出来，需要某种“注入”机制，例如，<code class="language-plaintext highlighter-rouge">BookService</code>自己并不会创建<code class="language-plaintext highlighter-rouge">DataSource</code>，而是等待外部通过<code class="language-plaintext highlighter-rouge">setDataSource()</code>方法来注入一个<code class="language-plaintext highlighter-rouge">DataSource</code>：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDataSource</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>不直接<code class="language-plaintext highlighter-rouge">new</code>一个<code class="language-plaintext highlighter-rouge">DataSource</code>，而是注入一个<code class="language-plaintext highlighter-rouge">DataSource</code>，这个小小的改动虽然简单，却带来了一系列好处：</p><ol><li><code class="language-plaintext highlighter-rouge">BookService</code>不再关心如何创建<code class="language-plaintext highlighter-rouge">DataSource</code>，因此，不必编写读取数据库配置之类的代码；</li><li><code class="language-plaintext highlighter-rouge">DataSource</code>实例被注入到<code class="language-plaintext highlighter-rouge">BookService</code>，同样也可以注入到<code class="language-plaintext highlighter-rouge">UserService</code>，因此，共享一个组件非常简单；</li><li>测试<code class="language-plaintext highlighter-rouge">BookService</code>更容易，因为注入的是<code class="language-plaintext highlighter-rouge">DataSource</code>，可以使用内存数据库，而不是真实的MySQL配置。</li></ol><p>IoC又称为依赖注入（DI：Dependency Injection），它解决了一个最主要的问题：将组件的创建+配置与组件的使用相分离，并且，由IoC容器负责管理组件的生命周期。</p><p>因为IoC容器要负责实例化所有的组件，因此，有必要告诉容器如何创建组件，以及各组件的依赖关系。一种最简单的配置是通过XML文件来实现，例如：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;beans&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"HikariDataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"bookService"</span> <span class="na">class=</span><span class="s">"BookService"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"userService"</span> <span class="na">class=</span><span class="s">"UserService"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>上述XML配置文件指示IoC容器创建3个JavaBean组件，并把id为<code class="language-plaintext highlighter-rouge">dataSource</code>的组件通过属性<code class="language-plaintext highlighter-rouge">dataSource</code>（即调用<code class="language-plaintext highlighter-rouge">setDataSource()</code>方法）注入到另外两个组件中。</p><p>依赖注入可以通过<code class="language-plaintext highlighter-rouge">set()</code>方法实现，也可以通过构造方法实现。</p><p>把<code class="language-plaintext highlighter-rouge">BookService</code>改造为通过构造方法注入，那么实现代码如下：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class BookService {
    private DataSource dataSource;

    public BookService(DataSource dataSource) {
        this.dataSource = dataSource;
    }
}
</code></pre></div></div><p>Spring的IoC容器同时支持属性注入和构造方法注入，并允许混合使用。</p><p>在设计上，Spring的IoC容器是一个高度可扩展的无侵入容器。所谓无侵入，是指应用程序的组件无需实现Spring的特定接口，或者说，组件根本不知道自己在Spring的容器中运行。这种无侵入的设计有以下好处：</p><ol><li>应用程序组件既可以在Spring的IoC容器中运行，也可以自己编写代码自行组装配置；</li><li>测试的时候并不依赖Spring容器，可单独进行测试，大大提高了开发效率。</li></ol><h3 id="ioc装配">IoC装配</h3><p>首先引入依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>测试代码：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>

    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">A</span><span class="o">(</span><span class="no">B</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">b</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>编写一个特定的<code class="language-plaintext highlighter-rouge">application.xml</code>配置文件，告诉Spring的IoC容器应该如何创建并组装Bean：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><hr /><h3 id="注入方式">注入方式</h3><p>对于构造方法注入，通过设置<code class="language-plaintext highlighter-rouge">constructor-arg</code>标签完成：</p><p><code class="language-plaintext highlighter-rouge">constructor-arg</code>参数:<code class="language-plaintext highlighter-rouge">type</code> 形参类型，<code class="language-plaintext highlighter-rouge">name</code> 形参变量名，<code class="language-plaintext highlighter-rouge">value</code> 属性值，<code class="language-plaintext highlighter-rouge">ref</code> 引用实例对象，<code class="language-plaintext highlighter-rouge">index</code> 索引值。</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><ul><li>每个<code class="language-plaintext highlighter-rouge">&lt;bean ...&gt;</code>都有一个<code class="language-plaintext highlighter-rouge">id</code>标识，相当于Bean的唯一ID；</li><li>在<code class="language-plaintext highlighter-rouge">a</code>Bean中，通过<code class="language-plaintext highlighter-rouge">&lt;constructor-arg index="0" ref="b"/&gt;</code>以<strong>构造方法注入</strong>了另一个<code class="language-plaintext highlighter-rouge">b</code>Bean；</li><li>Bean的顺序不重要，Spring根据依赖关系会自动正确初始化。</li></ul><p>把上述XML配置文件用Java代码写出来，就像这样：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">B</span> <span class="n">b</span><span class="o">=</span><span class="k">new</span> <span class="no">B</span><span class="o">();</span>
<span class="no">A</span> <span class="n">a</span><span class="o">=</span><span class="k">new</span> <span class="no">A</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</code></pre></div></div><p>只不过Spring容器是通过读取XML文件后使用反射完成的。</p><p>其实这里不写<code class="language-plaintext highlighter-rouge">constructor-arg</code>，也可以，在 Spring XML 配置文件中，如果类 <code class="language-plaintext highlighter-rouge">A</code> 只有<strong>一个构造函数</strong>，并且这个构造函数需要一个 <code class="language-plaintext highlighter-rouge">B</code> 类型的参数，Spring 会自动匹配并注入所需的依赖。因此，如果只有一个构造函数并且只有一个参数类型可以匹配，则<strong>可以省略</strong> <code class="language-plaintext highlighter-rouge">&lt;constructor-arg&gt;</code> 标签。</p><p>还可以使用c命名空间简化注入,对应<code class="language-plaintext highlighter-rouge">constructor-arg</code>。</p><p><code class="language-plaintext highlighter-rouge">beans</code>标签添加属性: <code class="language-plaintext highlighter-rouge">xmlns:c="http://www.springframework.org/schema/c"</code>。</p><p>使用c命名空间，直接在bean添加参数：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="n">bean</span> <span class="n">id</span><span class="o">=</span><span class="s">"a1"</span> <span class="kd">class</span><span class="err">="</span><span class="nc">com</span><span class="o">.</span><span class="na">aotmd</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">A</span><span class="s">" c:_0-ref="</span><span class="n">b</span><span class="s">"/&gt;
&lt;bean id="</span><span class="n">a2</span><span class="s">" class="</span><span class="n">com</span><span class="o">.</span><span class="na">aotmd</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">A</span><span class="s">" c:b-ref="</span><span class="n">b</span><span class="err">"</span><span class="o">/&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">c:_索引值</code> 对应 <code class="language-plaintext highlighter-rouge">index="索引值"</code>， 加<code class="language-plaintext highlighter-rouge">-ref</code>表示引用实例对象</p><p><code class="language-plaintext highlighter-rouge">c:形参变量名</code> 对应 <code class="language-plaintext highlighter-rouge">name="形参变量名"</code>,加<code class="language-plaintext highlighter-rouge">-ref</code>表示引用实例对象，不加则是设置普通数据类型，上面的式子如果不加，则<code class="language-plaintext highlighter-rouge">"b"</code>视为字符串。</p><p>需要注意的是<code class="language-plaintext highlighter-rouge">c:b-ref</code>这种方式只对以debug方式编译的class有效，因为对于非debug方式编译的class文件Spring将无法获取到对应构造方法的<code class="language-plaintext highlighter-rouge">参数名</code>，因为被优化掉了。之前在JavaWeb有说，可以设置编译器参数：<code class="language-plaintext highlighter-rouge">-parameters</code>，保留形参变量名。</p><hr /><p>对于set方法注入，通过设置<code class="language-plaintext highlighter-rouge">property</code>标签完成：</p><p>如果要改成<strong>通过<code class="language-plaintext highlighter-rouge">set</code>方法注入</strong>，则xml修改为：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"b"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">property</code>参数： <code class="language-plaintext highlighter-rouge">name</code> 变量名，<code class="language-plaintext highlighter-rouge">value</code> 属性值，<code class="language-plaintext highlighter-rouge">ref</code> 引用实例对象。</p><p>同样的，可以使用p命名空间简化注入,对应<code class="language-plaintext highlighter-rouge">property</code>。</p><p><code class="language-plaintext highlighter-rouge">beans</code>标签添加属性: <code class="language-plaintext highlighter-rouge">xmlns:p="http://www.springframework.org/schema/p"</code>。</p><p>使用p命名空间，直接在bean添加参数：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="na">p:b-ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">p:变量名</code> 对应 <code class="language-plaintext highlighter-rouge">name="变量名"</code>，加<code class="language-plaintext highlighter-rouge">-ref</code>表示引用实例对象。</p><p>注意：<code class="language-plaintext highlighter-rouge">property</code>对应的是set方法，而<strong>不是</strong>对应的属性。如<code class="language-plaintext highlighter-rouge">name="world"</code>实际对应<code class="language-plaintext highlighter-rouge">setWorld()</code>方法，这个时候<strong>不管</strong>是否真的存在名为<code class="language-plaintext highlighter-rouge">world</code>的属性.</p><hr /><h3 id="注入的类型">注入的类型</h3><p>如果注入的不是Bean，而是<code class="language-plaintext highlighter-rouge">boolean</code>、<code class="language-plaintext highlighter-rouge">int</code>、<code class="language-plaintext highlighter-rouge">String</code>这样的数据类型，则通过设置<code class="language-plaintext highlighter-rouge">value</code>注入（构造方法注入同理），例如，创建一个<code class="language-plaintext highlighter-rouge">HikariDataSource</code>：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span> <span class="na">class=</span><span class="s">"com.zaxxer.hikari.HikariDataSource"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"jdbcUrl"</span> <span class="na">value=</span><span class="s">"jdbc:mysql://localhost:3306/test"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"root"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"password"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maximumPoolSize"</span> <span class="na">value=</span><span class="s">"10"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"autoCommit"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>如果是Map类型，则通过嵌套<code class="language-plaintext highlighter-rouge">map</code>标签进行设置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"map"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;map&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"1"</span> <span class="na">value=</span><span class="s">"唱"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"2"</span> <span class="na">value=</span><span class="s">"跳"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"3"</span> <span class="na">value=</span><span class="s">"RAP"</span> <span class="na">value-type=</span><span class="s">"java.lang.String"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/map&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>如果是List类型，则通过嵌套<code class="language-plaintext highlighter-rouge">list</code>标签进行设置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;constructor-arg</span> <span class="na">ref=</span><span class="s">"b"</span> <span class="na">index=</span><span class="s">"0"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"list"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;list&gt;&lt;value&gt;</span>唱<span class="nt">&lt;/value&gt;&lt;value&gt;</span>跳<span class="nt">&lt;/value&gt;&lt;value&gt;</span>RAR<span class="nt">&lt;/value&gt;&lt;/list&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>如果是Set类型，则通过嵌套<code class="language-plaintext highlighter-rouge">set</code>标签进行设置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"set"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;set&gt;&lt;value</span> <span class="nt">&gt;</span>唱<span class="nt">&lt;/value&gt;&lt;value&gt;</span>跳<span class="nt">&lt;/value&gt;&lt;value&gt;</span>RAR<span class="nt">&lt;/value&gt;&lt;/set&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>前面有说name属性对应的是set方法，这里是<code class="language-plaintext highlighter-rouge">"set"</code>,所以对应<code class="language-plaintext highlighter-rouge">setList</code>方法，也可以改成其他的名字。</p><p>如果是数组，则通过嵌套<code class="language-plaintext highlighter-rouge">array</code>标签进行设置：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"list"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;array&gt;&lt;value&gt;</span>唱<span class="nt">&lt;/value&gt;&lt;value&gt;</span>跳<span class="nt">&lt;/value&gt;&lt;value&gt;</span>RAR<span class="nt">&lt;/value&gt;&lt;/array&gt;</span>
    <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div><p>实例：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="o">(</span><span class="no">A</span><span class="o">)</span><span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span><span class="c1">//test为配置文件中的id</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">call</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">A</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">call</span> <span class="o">=</span> <span class="o">(</span><span class="no">B</span><span class="o">)</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"key1"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setArray</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">map</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">map</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">call</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>application.xml：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;map&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"1"</span> <span class="na">value=</span><span class="s">"唱"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"2"</span> <span class="na">value=</span><span class="s">"跳"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"3"</span> <span class="na">value=</span><span class="s">"RAP"</span> <span class="na">value-type=</span><span class="s">"java.lang.String"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"4"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">value-type=</span><span class="s">"java.lang.Integer"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">"key1"</span> <span class="na">value-ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/map&gt;</span>
        <span class="nt">&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"array"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;array&gt;&lt;value&gt;</span>唱<span class="nt">&lt;/value&gt;&lt;value&gt;</span>跳<span class="nt">&lt;/value&gt;&lt;value&gt;</span>RAR<span class="nt">&lt;/value&gt;&lt;/array&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>控制台：</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{1=唱, 2=跳, 3=RAP, 4=1, key1=com.aotmd.test.B@53de625d}
[唱, 跳, RAR]
hello
</code></pre></div></div><h3 id="applicationcontext">ApplicationContext</h3><p>Spring容器就是<code class="language-plaintext highlighter-rouge">ApplicationContext</code>，它是一个接口，有很多实现类，这里选择<code class="language-plaintext highlighter-rouge">ClassPathXmlApplicationContext</code>，表示它会自动从classpath中查找指定的XML配置文件。</p><p>获得了<code class="language-plaintext highlighter-rouge">ApplicationContext</code>的实例，就获得了IoC容器的引用。从<code class="language-plaintext highlighter-rouge">ApplicationContext</code>中可以根据Bean的ID获取Bean，也可以根据Bean的类型获取Bean的引用：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
<span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="n">appcon</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
</code></pre></div></div><p>Spring还提供另一种IoC容器叫<code class="language-plaintext highlighter-rouge">BeanFactory</code>，使用方式和<code class="language-plaintext highlighter-rouge">ApplicationContext</code>类似：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">BeanFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XmlBeanFactory</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClassPathResource</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">));</span>
<span class="no">A</span> <span class="n">a</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">BeanFactory</code>和<code class="language-plaintext highlighter-rouge">ApplicationContext</code>的区别在于，<code class="language-plaintext highlighter-rouge">BeanFactory</code>的实现是<strong>按需创建</strong>，即第一次获取Bean时才创建这个Bean，而<code class="language-plaintext highlighter-rouge">ApplicationContext</code>会一次性创建所有的Bean。实际上，<code class="language-plaintext highlighter-rouge">ApplicationContext</code>接口是从<code class="language-plaintext highlighter-rouge">BeanFactory</code>接口继承而来的，并且，<code class="language-plaintext highlighter-rouge">ApplicationContext</code>提供了一些额外的功能，包括国际化支持、事件和通知机制等。通常情况下，总是使用<code class="language-plaintext highlighter-rouge">ApplicationContext</code>，很少会考虑使用<code class="language-plaintext highlighter-rouge">BeanFactory</code>。</p><hr /><p>创建 <code class="language-plaintext highlighter-rouge">ApplicationContext</code>接口实例通常有三种方法：</p><p><strong>通过<code class="language-plaintext highlighter-rouge">ClassPathXmlApplicationContext</code>创建</strong> <code class="language-plaintext highlighter-rouge">ClassPathXmlApplicationContext</code>将从类路径classPath目录寻找指定的XML配置文件：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"application.xml"</span><span class="o">);</span>
</code></pre></div></div><p><strong>通过<code class="language-plaintext highlighter-rouge">FileSystemXmlApplicationContext</code>创建</strong></p><p><code class="language-plaintext highlighter-rouge">FileSystemXmlApplicationContext</code>将从指定文件的<strong>绝对路径</strong>中寻找XML配置文件，找到并装载完成<code class="language-plaintext highlighter-rouge">ApplicationContext</code>的实例化工作。采用绝对路径的加载方式将导致程序的灵活性变差， 一般<strong>不推荐使用</strong>。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">appcon</span><span class="o">=</span><span class="k">new</span> <span class="nc">FileSystemXmlApplicationContext</span><span class="o">(</span><span class="s">"C:\\XXX\\application.xml"</span><span class="o">);</span>
</code></pre></div></div><p><strong>通过Web服务器实例化<code class="language-plaintext highlighter-rouge">ApplicationContext</code>容器</strong></p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>classpath:application.xml<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
</code></pre></div></div><p>如果有多个Spring配置文件，则在<code class="language-plaintext highlighter-rouge">param-value</code>里，以逗号分隔，如果没有定义则默认加载<code class="language-plaintext highlighter-rouge">/WEB-INF/applicationContext.xml</code>文件，<code class="language-plaintext highlighter-rouge">contextConfigLocation</code>是参数值，固定不变。</p><p>Web服务器实例化<code class="language-plaintext highlighter-rouge">ApplicationContext</code>容器时，一般使用基于<code class="language-plaintext highlighter-rouge">org.springframework.web.context.ContextLoaderListener</code>的实现方法只需要在<code class="language-plaintext highlighter-rouge">web.xml</code>中添加代码:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;context-param&gt;</span>
    <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
    <span class="nt">&lt;param-value&gt;</span>classpath:application.xml<span class="nt">&lt;/param-value&gt;</span>
<span class="nt">&lt;/context-param&gt;</span>
<span class="nt">&lt;listener&gt;</span>
    <span class="nt">&lt;listener-class&gt;</span>
        org.springframework.web.context.ContextLoaderListener
    <span class="nt">&lt;/listener-class&gt;</span>
<span class="nt">&lt;/listener&gt;</span>
</code></pre></div></div><p>需要web依赖：</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-web<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.0.2.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div><p>使用，首先<strong>获取<code class="language-plaintext highlighter-rouge">ServletContext</code></strong>，这里列出几种方法：</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServletContext</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
<span class="n">sc</span><span class="o">=((</span><span class="nc">HttpServletRequest</span><span class="o">)</span><span class="n">request</span><span class="o">).</span><span class="na">getSession</span><span class="o">().</span><span class="na">getServletContext</span><span class="o">();</span>
<span class="n">sc</span><span class="o">=</span><span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
</code></pre></div></div><p>普通类获取方法（普通类若不经过服务器调用(如servlet调用)则会报<code class="language-plaintext highlighter-rouge">NullPointerException</code>）</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ServletContext</span> <span class="n">sc</span> <span class="o">=</span> <span class="nc">ContextLoader</span><span class="o">.</span><span class="na">getCurrentWebApplicationContext</span><span class="o">().</span><span class="na">getServletContext</span><span class="o">();</span>
</code></pre></div></div><p>然后<strong>通过<code class="language-plaintext highlighter-rouge">ServletContext</code>获取<code class="language-plaintext highlighter-rouge">ApplicationContext</code>：</strong></p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getWebApplicationContext</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span><span class="c1">// 这种方法 获取失败时返回null</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unused"</span><span class="o">)</span>
<span class="nc">WebApplicationContext</span> <span class="n">ctx</span><span class="o">=</span><span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getRequiredWebApplicationContext</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span><span class="c1">// 这种方法 获取失败时抛出异常</span>
<span class="n">ac</span> <span class="o">=</span> <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getRequiredWebApplicationContext</span><span class="o">(</span><span class="n">sc</span><span class="o">);</span>
</code></pre></div></div><hr /><p>对于手动加载的Spring，<code class="language-plaintext highlighter-rouge">ApplicationContext</code>怎么销毁:</p><p>在非Web应用中，手工加载Spring IoC容器，不能用<code class="language-plaintext highlighter-rouge">ApplicationContext</code>，要用<code class="language-plaintext highlighter-rouge">AbstractApplicationContext</code>。用完以后要记得调用<code class="language-plaintext highlighter-rouge">ctx.close()</code>关闭容器。如果不记得关闭容器，最典型的问题就是数据库连接不能释放。</p><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">((</span><span class="nc">AbstractApplicationContext</span><span class="o">)</span><span class="n">appcon</span><span class="o">).</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div><h3 id="完整实例">完整实例</h3><div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/test"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServletContext</span> <span class="n">servletContext</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">();</span>
        <span class="c1">// 这种方法 获取失败时返回null</span>
        <span class="nc">ApplicationContext</span> <span class="n">ac</span> <span class="o">=</span> <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getWebApplicationContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
        <span class="no">A</span> <span class="n">a</span><span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="no">A</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">a</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">A</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="no">B</span> <span class="n">call</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCall</span><span class="o">(</span><span class="no">B</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">call</span> <span class="o">=</span> <span class="n">call</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="n">call</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">class</span> <span class="nc">B</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div><p>application.xml:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"a"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.A"</span> <span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"call"</span> <span class="na">ref=</span><span class="s">"b"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"b"</span> <span class="na">class=</span><span class="s">"com.aotmd.test.B"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div><p>web.xml:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span>
         <span class="na">version=</span><span class="s">"4.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;context-param&gt;</span>
        <span class="nt">&lt;param-name&gt;</span>contextConfigLocation<span class="nt">&lt;/param-name&gt;</span>
        <span class="nt">&lt;param-value&gt;</span>classpath:application.xml<span class="nt">&lt;/param-value&gt;</span>
    <span class="nt">&lt;/context-param&gt;</span>
    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>
            org.springframework.web.context.ContextLoaderListener
        <span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</code></pre></div></div><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="" target="_blank">acteds</a></li><li>本文链接：<a href="/2021/11/13/Spring/" target="_blank">https://acteds.github.io/2021/11/13/Spring/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"> <script src="https://beaudar.lipk.org/client.js" repo="mzlogin/blog-comments" issue-term="title" label="gitment" theme="github-light" comment-order="desc" input-position="top" crossorigin="anonymous" async> </script></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: '/assets/search_data.json?v=1716199627', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2024 <span title="acteds">acteds</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/acteds/acteds.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="/" title="首页" target="">首页</a></li><li> <a href="/categories/" title="分类" target="">分类</a></li><li> <a href="/wiki/" title="维基" target="">维基</a></li><li> <a href="/about/" title="关于" target="">关于</a></li><li><a href="/feed.xml"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script></body></html>
