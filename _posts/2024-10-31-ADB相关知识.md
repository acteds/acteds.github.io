---
layout: post
title: ADB相关知识
categories: Android
description: 安卓笔记
keywords: Android
---

# 引言

ADB（Android Debug Bridge）是一个命令行工具，用于与 Android 设备进行交互和管理。它是 Android SDK 的一部分，主要用于开发和调试 Android 应用程序。



# ADB

ADB 提供了一个通用的命令接口，可以通过 USB 或 Wi-Fi 连接 Android 设备，允许开发者执行多种操作，包括：

1. **安装和卸载应用**：可以通过命令行在设备上安装或卸载 APK 文件。
2. **设备管理**：能够列出已连接的设备，检查设备状态，重启设备等。
3. **调试应用**：开发者可以通过 ADB 向 Android 设备发送调试命令，查看日志（使用 `logcat`），捕获屏幕截图等。
4. **文件传输**：可以通过 ADB 在电脑和 Android 设备之间传输文件。
5. **运行 shell 命令**：可以直接在设备上执行 shell 命令，以进行更深入的管理。



ADB 的基本使用示例：

**列出连接的设备**：

```bash
adb devices
```

**安装应用**：

```bash
adb install path/to/app.apk
```

**卸载应用**：

```bash
adb uninstall package.name
```

**查看设备日志**：

```bash
adb logcat
```

**进入设备的 shell**：

```bash
adb shell
```



**工作原理：**

ADB 通过 TCP/IP 协议与 Android 设备通信。它通常在本地机器和 Android 设备之间建立一个客户端-服务器架构，其中 ADB 服务器在主机上运行，而 ADB 客户端在命令行中运行，Android 设备则充当服务器端。



## ADB服务器

ADB 服务器（ADB Server）是 Android Debug Bridge（ADB）中的一个关键组件，用于管理与 Android 设备之间的通信。它作为一个后台进程在主机上运行，负责协调 ADB 客户端和连接的 Android 设备。以下是 ADB 服务器的主要功能和特点：

1. **设备管理**：ADB 服务器维护已连接设备的状态信息，包括设备 ID、状态（如在线或离线）等。当通过 ADB 客户端发出命令时，ADB 服务器会判断当前连接的设备并执行相应操作。

2. **命令转发**：当开发者在命令行中使用 ADB 命令时，这些命令首先被发送到 ADB 服务器。ADB 服务器会将这些命令转发到相应的 Android 设备，并将结果返回给客户端。

3. **多设备支持**：**ADB 服务器允许同时与多个 Android 设备进行通信**。开发者可以通过不同的设备 ID 来区分不同的设备。

4. **简化连接**：ADB 服务器管理与设备之间的 TCP/IP 连接，简化了开发者的连接流程。当开发者首次连接设备时，ADB 服务器会自动启动并进行设备发现。

**工作原理**

- **启动过程**：当运行任何 ADB 命令时，ADB 客户端会首先检查 ADB 服务器是否在运行。如果未运行，ADB 客户端会启动 ADB 服务器。
- **端口**：默认情况下，ADB 服务器在 5037 端口上监听请求。可以通过 `adb -P <port>` 命令指定其他端口。
- **连接方式**：ADB 可以通过 USB 连接设备，也可以通过 Wi-Fi 连接。当设备通过 USB 连接时，ADB 服务器会在设备上启用调试模式，以便进行操作。

**常见命令**

**启动 ADB 服务器**：

```bash
adb start-server
```

**停止 ADB 服务器**：

```bash
adb kill-server
```

**查看已连接设备**：

```bash
adb devices
```

ADB 服务器是开发和调试 Android 应用不可或缺的组件，它通过提供统一的接口简化了与设备的交互，帮助开发者高效地进行应用测试和管理。



**重要事项**

1. **单一端口**：同一时间内，ADB 服务器只能绑定到一个端口。如果尝试在**同一端口**上启动多个 ADB 实例，将导致冲突并出现错误。
2. **更改端口**：如果你需要在多个实例之间切换，可以使用不同的端口。例如，你可以使用 `adb -L tcp:12345 fork-server server --reply-fd 688` 启动另一个 ADB 实例在端口 12345 上运行。
3. **服务器状态**：如果需要重新启动 ADB 服务器，建议先停止现有的 ADB 实例，以避免端口占用冲突。可以使用 `adb kill-server` 命令来停止当前的 ADB 服务器。



**一个安卓设备只能与一个 ADB 服务器建立连接。**即使在不同的端口上启动多个 ADB 服务器，它们仍然无法同时连接到同一个设备。以下是一些相关细节：

**原因**

1. **端口和通信**：ADB 服务器通过 TCP/IP 协议与安卓设备通信，通常使用端口 5037。每个设备在同一时间只能被一个 ADB 服务器控制。
2. **设备状态**：当一个 ADB 服务器连接到设备时，该设备的状态会被标记为 "device"。其他尝试连接的 ADB 服务器将收到设备 "offline" 或 "unauthorized" 的状态，因为设备已经与现有的 ADB 服务器建立了连接。

**解决方案**

- **ADB 代理**：如果需要在多个环境中使用 ADB，可以考虑使用 ADB 代理来转发命令，但这会增加复杂性。
- **连接管理**：确保在启动新的 ADB 服务器之前，先通过 `adb kill-server` 停止当前的 ADB 服务器连接，确保只有一个 ADB 实例在与设备通信。

每次只允许一个 ADB 服务器与安卓设备建立连接，尝试同时连接多个 ADB 服务器将会导致连接冲突，无法正常工作。





